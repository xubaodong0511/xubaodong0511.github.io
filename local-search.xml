<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>docker 创建halo博客实验</title>
    <link href="/2025/11/06/docker-%E5%88%9B%E5%BB%BAhalo%E5%8D%9A%E5%AE%A2/"/>
    <url>/2025/11/06/docker-%E5%88%9B%E5%BB%BAhalo%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<p><strong>docker博客创建</strong></p><p><strong>编辑配置文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /halo/docker-compose.yaml<br>version: &quot;3&quot;<br><br>services:<br>  halo<br>    image: halohub/halo:2.11<br>    container_name: halo<br>    restart: on-failure:3<br>    depends_on:<br>      halodb:<br>        condition: service_healthy<br>    networks:<br>      halo_network:<br>    volumes:<br><br>   - ./halo2:/root/.halo2<br>     rts:<br>        - &quot;8090:8090&quot;<br>          althcheck:<br>                test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:8090/actuator/health/readiness&quot;]<br>                interval: 30s<br>                timeout: 5s<br>                retries: 5<br>                start_period: 30s          <br>              command:<br>             - --spring.r2dbc.url=r2dbc:pool:postgresql://halodb/halo<br>               --spring.r2dbc.username=halo<br><br>      # PostgreSQL 的密码，请保证与下方 POSTGRES_PASSWORD 的变量值一致。<br><br>   - --spring.r2dbc.password=openpostgresql<br>     --spring.sql.init.platform=postgresql<br><br>      # 外部访问地址，请根据实际需要修改<br><br>   - --halo.external-url=http://localhost:8090/<br>     halodb:<br>         image: postgres:15.4<br>         container_name: halodb<br>         restart: on-failure:3<br>         networks:<br>           halo_network:<br>         volumes:<br>        - ./db:/var/lib/postgresql/data<br>          rts:<br>             - &quot;5432:5432&quot;<br>               althcheck:<br>                     test: [ &quot;CMD&quot;, &quot;pg_isready&quot; ]<br>                     interval: 10s<br>                     timeout: 5s<br>                     retries: 5<br>                   environment:<br>                  - POSTGRES_PASSWORD=openpostgresql<br>                    POSTGRES_USER=halo<br>                       - POSTGRES_DB=halo<br>                         PGUSER=halo<br><br>networks:<br>  halo_network:<br></code></pre></td></tr></table></figure><p><strong>创建目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -pv /halo<br></code></pre></td></tr></table></figure><p><strong>重新指定文件目录</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span> docker-compose.yaml /halo<br><span class="hljs-built_in">cd</span> /halo<br></code></pre></td></tr></table></figure><p><strong>运行以下命令卸载所有冲突的包</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">for</span> pkg <span class="hljs-keyword">in</span> docker.io docker-doc docker-compose podman-docker containerd runc; <span class="hljs-keyword">do</span> sudo apt-<span class="hljs-built_in">get</span> <span class="hljs-built_in">remove</span> <span class="hljs-variable">$pkg</span>; done<br></code></pre></td></tr></table></figure><p><strong>设置 Docker 的apt存储库</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Add Docker&#x27;s official GPG key:</span><br><span class="hljs-built_in">sudo</span> apt-get update<br><span class="hljs-built_in">sudo</span> apt-get install ca-certificates curl gnupg<br><span class="hljs-built_in">sudo</span> install -m 0755 -d /etc/apt/keyrings<br>curl -fsSL https://download.docker.com/linux/debian/gpg | <span class="hljs-built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg<br><br><span class="hljs-comment"># Add the repository to Apt sources:</span><br><span class="hljs-built_in">echo</span> \<br>  <span class="hljs-string">&quot;deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \</span><br><span class="hljs-string">  <span class="hljs-subst">$(. /etc/os-release &amp;&amp; echo <span class="hljs-string">&quot;<span class="hljs-variable">$VERSION_CODENAME</span>&quot;</span>)</span> stable&quot;</span> | \<br>  <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null<br><span class="hljs-built_in">sudo</span> apt-get update<br></code></pre></td></tr></table></figure><p><strong>运行安装脚本</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">bash &lt;(curl -sSL https://linuxmirrors.cn/docker.sh)    //脚本运行<br>sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin    //新版docker版本脚本<br></code></pre></td></tr></table></figure><p><strong>安装</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt-get install -y docker-compose<br></code></pre></td></tr></table></figure><p><strong>验证版本号</strong></p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ada">docker-compose <span class="hljs-comment">--version</span><br>docker <span class="hljs-comment">--version</span><br></code></pre></td></tr></table></figure><p><strong>安装运行</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shel">docker-compose up -d<br>systemctl status docker<br></code></pre></td></tr></table></figure><p><strong>测试</strong><br><code>输入IP地址+端口8090</code>进入注册页面</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Centos网卡配置实验</title>
    <link href="/2025/11/06/Centos%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE/"/>
    <url>/2025/11/06/Centos%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<p><strong>永久设置网卡</strong></p><blockquote><p><code>另外也可以在终端上输入nmtui，进入网卡设置界面</code></p></blockquote><p><strong>1、Centos 7 配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">Centos 7<br><span class="hljs-meta prompt_"># </span><span class="language-bash">vim/etc/sysconfig/network-scripts/ifcfg-ens33 //网卡配置文件的路径</span><br>TYPE=Ethernet//网卡类型<br>BOOTPROTO=dhcp //网卡模式<br>     --&gt;  dhcp //自动获取<br>     --&gt;  static //手动获取<br>     --&gt;  none //手动获取<br>NAME=ens33 //网卡名称（可以修改的）<br>DEVICE=ens33 //设备名称<br>ONBOOT=yes //网卡开关<br>IPADDR=192.168.10.104//IP地址<br>PREFIX=24//子网掩码<br>NETMASK=255.255.255.0 //子网掩码<br>GATEWAY=192.168.10.2 //网关<br>DNS1=192.168.10.2 //DNS<br></code></pre></td></tr></table></figure><p><strong>重启</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl restart network //重启网卡生效配置<br></code></pre></td></tr></table></figure><p><strong>2、Centos 9 配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">Centos9<br><span class="hljs-meta prompt_"># </span><span class="language-bash">vim /etc/NetworkManager/system-connections/ens33.nmconnection  //修改如下选项即可</span><br>address=192.168.10.120/24,192.168.26.2  //ip地址，子网掩码，网关<br>dns=192.168.10.2       //DNS<br>method=manual <br><span class="hljs-meta prompt_">   --&gt; </span><span class="language-bash">manual          //手动</span><br><span class="hljs-meta prompt_">   --&gt; </span><span class="language-bash">auto            //自动</span><br></code></pre></td></tr></table></figure><p><strong>重启</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">nmcli c reload      //重启网络服务 <br>nmcli c down ens33  //开启网络 <br>nmcli c up ens33    //关闭网络<br></code></pre></td></tr></table></figure><h2 id="3、当network和networkmanager-网卡冲突"><a href="#3、当network和networkmanager-网卡冲突" class="headerlink" title="3、当network和networkmanager 网卡冲突"></a><strong>3、当network和networkmanager 网卡冲突</strong><br><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gauss">systemctl <span class="hljs-keyword">stop</span> NetworkManager <br><br>systemctl disabled NetworkManager   <span class="hljs-comment">//将NetworkManger停止</span><br><br>ifup ens33          <span class="hljs-comment">//输入此命令即可查看ens33网卡</span><br><br>systemctl restart network          <span class="hljs-comment">//重启网卡服务</span><br><br><span class="hljs-meta"># 此时应该就可以看到ens33的IP地址了</span><br></code></pre></td></tr></table></figure></h2>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>shell添加用户，计算，vsftp实验</title>
    <link href="/2025/11/06/shell%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%EF%BC%8C%E8%AE%A1%E7%AE%97%EF%BC%8Cvsftp/"/>
    <url>/2025/11/06/shell%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%EF%BC%8C%E8%AE%A1%E7%AE%97%EF%BC%8Cvsftp/</url>
    
    <content type="html"><![CDATA[<p><strong>vim user.sh（添加用户）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">该脚本为添加用户zhangsan，并给他设置密码</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">date</span>：2023-11-14</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">author：xubaodong</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建用户</span><br>useradd zhangsan<br><span class="hljs-meta prompt_">#</span><span class="language-bash">变量</span><br>name=zhangsan<br>echo &quot;qianfeng@123&quot; | passwd --stdin $name &amp;&amp; echo &quot;密码设置完成&quot;<br></code></pre></td></tr></table></figure><p><strong>vim compute.sh（计算）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">该脚本用于计算</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">date</span>：2023-11-14</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">author：xubaodong</span><br>read -p &quot;请输入第一个数字&quot; num1<br>read -p &quot;请输入第二个数字&quot; num2<br>echo $[num1 + num2] &amp;&amp; echo $[num1 - num2] &amp;&amp; echo $[num1 * num2] &amp;&amp; echo $[num1 / num2]<br></code></pre></td></tr></table></figure><p><strong>vsftp_client.sh（客户端）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">该脚本用于ftp客户端</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">date</span>：2023-11-14</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">author：xubaodong</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭防火墙，文件防火墙</span><br>systemctl stop firewalld<br>systemctl disable firewalld<br>setenforce 0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载vsftp，lftp</span><br>yum -y install vsftpd<br>yum -y install lftp<br><span class="hljs-meta prompt_">#</span><span class="language-bash">给pub满权限</span><br>chmod 777 /var/ftp/pub<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动服务</span><br>systemctl start vsftpd<br>systemctl restart vsftpd<br><span class="hljs-meta prompt_">#</span><span class="language-bash">连接服务端</span><br>lftp 10.21.162.172<br>cd /var/ftp/pub<br>put aaa<br></code></pre></td></tr></table></figure><p><strong>vsftp_server.sh（服务端）</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">该脚本用于ftp服务端</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">date</span>：2023-11-14</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">author：xubaodong</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭防火墙，文件防火墙</span><br>systemctl stop firewalld<br>systemctl disable firewalld<br>setenforce 0<br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载vsftp,lftp</span><br>yum -y install vsftpd<br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载vsftp，lftp</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">读写权限追加到配置文件</span><br>cat &gt;&gt; /etc/vsftpd/vsftpd.conf &lt;&lt; EOF<br>anon_upload_enable=YES<br>anon_mkdir_write_enable=YES<br>EOF<br><span class="hljs-meta prompt_">#</span><span class="language-bash">给pub满权限</span><br>chmod 777 /var/ftp/pub<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动服务</span><br>systemctl start vsftpd<br>systemctl restart vsftpd`<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>系统工具箱--脚本实验</title>
    <link href="/2025/11/06/%E7%B3%BB%E7%BB%9F%E5%B7%A5%E5%85%B7%E7%AE%B1-%E8%84%9A%E6%9C%AC/"/>
    <url>/2025/11/06/%E7%B3%BB%E7%BB%9F%E5%B7%A5%E5%85%B7%E7%AE%B1-%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="bin-bash"><a href="#bin-bash" class="headerlink" title="!&#x2F;bin&#x2F;bash"></a>!&#x2F;bin&#x2F;bash</h1><h1 id="本脚本用于系统工具"><a href="#本脚本用于系统工具" class="headerlink" title="本脚本用于系统工具"></a>本脚本用于系统工具</h1><h1 id="打印当前系统登录用户"><a href="#打印当前系统登录用户" class="headerlink" title="打印当前系统登录用户"></a>打印当前系统登录用户</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">print_logged_in_users</span></span>() &#123;<br>    <span class="hljs-built_in">who</span> | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> | <span class="hljs-built_in">sort</span> | <span class="hljs-built_in">uniq</span><br>&#125;<br><br><span class="hljs-comment"># 根据用户输入判断软件是否已安装并打印软件信息</span><br><span class="hljs-function"><span class="hljs-title">check_and_print_software_info</span></span>() &#123;<br>    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入要检查的软件名称： &quot;</span> software_name<br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v <span class="hljs-string">&quot;<span class="hljs-variable">$software_name</span>&quot;</span> &amp;&gt; /dev/null; <span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$software_name</span> 已安装&quot;</span><br>        <span class="hljs-comment"># TODO: 打印软件信息命令</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$software_name</span> 未安装&quot;</span><br>    <span class="hljs-keyword">fi</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="输入时间段和日志路径统计-nginx-访问日志次数最多的-IP"><a href="#输入时间段和日志路径统计-nginx-访问日志次数最多的-IP" class="headerlink" title="输入时间段和日志路径统计 nginx 访问日志次数最多的 IP"></a>输入时间段和日志路径统计 nginx 访问日志次数最多的 IP</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">analyze_nginx_log</span></span>() &#123;<br>    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入日志路径： &quot;</span> log_path<br>    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入开始时间（格式：15/Jul/2023:00:00:00）： &quot;</span> start_time<br>    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入结束时间（格式：15/Jul/2023:00:00:00）： &quot;</span> end_time<br>    <br>    sed -n <span class="hljs-string">&quot;/<span class="hljs-variable">$start_time</span>/,/<span class="hljs-variable">$end_time</span>/p&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$log_path</span>&quot;</span> |awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> |<span class="hljs-built_in">sort</span>|<span class="hljs-built_in">uniq</span> -c |<span class="hljs-built_in">sort</span>|<span class="hljs-built_in">tail</span> -n 1|awk <span class="hljs-string">&#x27;&#123;print $2&#125;&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="安装指定软件"><a href="#安装指定软件" class="headerlink" title="安装指定软件"></a>安装指定软件</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">install_software() </span>&#123;<br>    read -p <span class="hljs-string">&quot;请选择要安装的软件：1.Nginx 2.MySQL 3.Apache 4.Vsftpd：&quot;</span> choice<br><br>    case $choice in<br>        <span class="hljs-number">1</span>)<br>            <span class="hljs-comment"># 安装 Nginx</span><br>            <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> 添加 Nginx 安装命令</span><br>            <span class="hljs-comment">;;</span><br>        <span class="hljs-number">2</span>)<br>            <span class="hljs-comment"># 安装 MySQL</span><br>            <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> 添加 MySQL 安装命令</span><br>            <span class="hljs-comment">;;</span><br>        <span class="hljs-number">3</span>)<br>            <span class="hljs-comment"># 安装 Apache</span><br>            <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> 添加 Apache 安装命令</span><br>            <span class="hljs-comment">;;</span><br>        <span class="hljs-number">4</span>)<br>            <span class="hljs-comment"># 安装 Vsftpd</span><br>            <span class="hljs-comment"># <span class="hljs-doctag">TODO:</span> 添加 Vsftpd 安装命令</span><br>            <span class="hljs-comment">;;</span><br>        *)<br>            echo <span class="hljs-string">&quot;无效的选择&quot;</span><br>            <span class="hljs-comment">;;</span><br>    esac<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="获取系统-CPU-排名前-10-的进程"><a href="#获取系统-CPU-排名前-10-的进程" class="headerlink" title="获取系统 CPU 排名前 10 的进程"></a>获取系统 CPU 排名前 10 的进程</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">get_top_cpu_processes</span></span>() &#123;<br>    ps aux --<span class="hljs-built_in">sort</span>=-%cpu | <span class="hljs-built_in">head</span> -n 11<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="获取系统内存排名前-10-的进程"><a href="#获取系统内存排名前-10-的进程" class="headerlink" title="获取系统内存排名前 10 的进程"></a>获取系统内存排名前 10 的进程</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">get_top_memory_processes</span></span>() &#123;<br>    ps aux --<span class="hljs-built_in">sort</span>=-%mem | <span class="hljs-built_in">head</span> -n 11<br>&#125;<br><br><span class="hljs-function"><span class="hljs-title">change_IP_address</span></span>()&#123;<br>    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;是否已经配置网卡服务[y/n]：&quot;</span> yn<br>    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = n ];<span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;</span><br><span class="hljs-string">    IPADDR=192.168.116.111</span><br><span class="hljs-string">    NETMASK=255.255.255.0</span><br><span class="hljs-string">    GATEWAY=192.168.116.2</span><br><span class="hljs-string">    DNS1=192.168.116.2</span><br><span class="hljs-string">    以上为默认格式，仅供参考！&quot;</span>        <br>        sed -ie <span class="hljs-string">&#x27;s/BOOTPROTO=dhcp/BOOTPROTO=static/;s/ONBOOT=no/ONBOOT=yes/&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-ens33<br>        <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入你设置的IP地址：&quot;</span> ip<br>        sed -i <span class="hljs-string">&quot;$ a IPADDR=<span class="hljs-variable">$ip</span>&quot;</span>  /etc/sysconfig/network-scripts/ifcfg-ens33<br>            <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入掩码：&quot;</span> net<br>            sed -i <span class="hljs-string">&quot;$ a NETMASK=<span class="hljs-variable">$net</span>&quot;</span> /etc/sysconfig/network-scripts/ifcfg-ens33<br>                <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入网关：&quot;</span> way<br>                sed -i <span class="hljs-string">&quot;$ a GATEWAY=<span class="hljs-variable">$way</span>&quot;</span> /etc/sysconfig/network-scripts/ifcfg-ens33<br>                    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入DNS：&quot;</span> dns<br>                    sed -i <span class="hljs-string">&quot;$ a DNS1=<span class="hljs-variable">$dns</span>&quot;</span> /etc/sysconfig/network-scripts/ifcfg-ens33<br>                        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;网卡配置成功！&quot;</span><br>    <span class="hljs-keyword">else</span><br>        sed -i <span class="hljs-string">&#x27;16,19 s/\(.*\)/#\1/&#x27;</span>  /etc/sysconfig/network-scripts/ifcfg-ens33<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;注意，16-19段已被注释！！！&quot;</span><br>        <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;是否需要配置网卡服务【y/n】：&quot;</span> YN<br>        <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$YN</span> = y ];<span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;</span><br><span class="hljs-string">            IPADDR=192.168.116.111</span><br><span class="hljs-string">            NETMASK=255.255.255.0</span><br><span class="hljs-string">            GATEWAY=192.168.116.2</span><br><span class="hljs-string">            DNS1=192.168.116.2</span><br><span class="hljs-string">            以上为默认格式，仅供参考！&quot;</span>        <br>        sed -ie <span class="hljs-string">&#x27;s/BOOTPROTO=dhcp/BOOTPROTO=static/;s/ONBOOT=no/ONBOOT=yes/&#x27;</span> /etc/sysconfig/network-scripts/ifcfg-ens33<br>        <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入你设置的IP地址：&quot;</span> ipp<br>        sed -i <span class="hljs-string">&quot;$ a IPADDR=<span class="hljs-variable">$ipp</span>&quot;</span>  /etc/sysconfig/network-scripts/ifcfg-ens33<br>            <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入掩码：&quot;</span> nett<br>            sed -i <span class="hljs-string">&quot;$ a NETMASK=<span class="hljs-variable">$nett</span>&quot;</span> /etc/sysconfig/network-scripts/ifcfg-ens33<br>                <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入网关：&quot;</span> wayy<br>                sed -i <span class="hljs-string">&quot;$ a GATEWAY=<span class="hljs-variable">$wayy</span>&quot;</span> /etc/sysconfig/network-scripts/ifcfg-ens33<br>                    <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入DNS：&quot;</span> dnss<br>                    sed -i <span class="hljs-string">&quot;$ a DNS1=<span class="hljs-variable">$dnss</span>&quot;</span>  /etc/sysconfig/network-scripts/ifcfg-ens33  <br>                        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;网卡配置成功！&quot;</span><br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">fi</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">disable_firewall</span></span>()&#123;<br>    systemctl stop firewalld;systemctl <span class="hljs-built_in">disable</span> firewalld;<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;防火墙已关闭,关闭开机自启服务！&quot;</span><br>    sed -i <span class="hljs-string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27;</span> /etc/selinux/config<br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;selinux已关闭，已关闭开机自启服务！&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="关闭DNS"><a href="#关闭DNS" class="headerlink" title="关闭DNS"></a>关闭DNS</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">on_DNS</span></span>()&#123;<br>    sed -i <span class="hljs-string">&#x27;115s/#UseDNS yes/UseDNS no/&#x27;</span>    /etc/ssh/sshd_config;systemctl restart sshd<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;DNS已关闭！！！&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">backup_copy</span></span>()&#123;<br>    <span class="hljs-comment">#每周日进行全量备份，周一到周六进行增量备份</span><br>    <span class="hljs-comment">#关闭防火墙</span><br>    systemctl stop firewalld<br>    setenforce 0<br>    <span class="hljs-comment">#备份路径</span><br>    back_dir=<span class="hljs-string">&quot;/backup&quot;</span><br>    log_dir=<span class="hljs-string">&quot;/backup_log&quot;</span><br>    full_backup_dir=<span class="hljs-string">&quot;backup/full&quot;</span><br>    inc_backup_dir=<span class="hljs-string">&quot;backup/inc&quot;</span><br>    <span class="hljs-comment">#变量时间</span><br>    log_date=$(<span class="hljs-built_in">date</span> <span class="hljs-string">&quot;+%F-%T&quot;</span>)<br>    <span class="hljs-comment">#定义用户，密码</span><br>    MY_USER=<span class="hljs-string">&quot;root&quot;</span><br>    MY_PASS=<span class="hljs-string">&quot;1&quot;</span><br>    <span class="hljs-comment">#验证日志目录路径是否存在</span><br>    [ -d <span class="hljs-variable">$back_dir</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$back_dir</span><br>    [ -d <span class="hljs-variable">$log_dir</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$log_dir</span><br>    [ -d <span class="hljs-variable">$full_backup_dir</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$full_backup_dir</span><br>    [ -d <span class="hljs-variable">$inc_backup_dir</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$inc_backup_dir</span><br>    <span class="hljs-comment">#全量备份函数</span><br>    <span class="hljs-function"><span class="hljs-title">full_back</span></span>()&#123;<br>    <span class="hljs-comment">#全量备份命令</span><br>    innobackupex --user=<span class="hljs-variable">$MY_USER</span> --password=<span class="hljs-variable">$MY_PASS</span> <span class="hljs-variable">$full_backup_dir</span><br>    <span class="hljs-keyword">if</span> [$? -eq 0];<span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> full OK!!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/OK_log<br>    <span class="hljs-keyword">else</span>    <br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> NO found full!!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/err_log<br>    <span class="hljs-keyword">fi</span><br>    &#125;   <br>    <span class="hljs-comment">#获取上周日时间</span><br>    sunday=$(<span class="hljs-built_in">date</span> -d <span class="hljs-string">&quot;last sunday&quot;</span> +%F)<br>    <span class="hljs-comment">#获取前一天的时间</span><br>    yesterday=$(<span class="hljs-built_in">date</span> -d <span class="hljs-string">&quot;yesterday&quot;</span> +%F)<br>    <span class="hljs-comment">#增量备份函数</span><br>    <span class="hljs-function"><span class="hljs-title">inc_back</span></span>()&#123;<br>    <span class="hljs-comment">#判断当前时间是否是周一</span><br>    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$week_date</span> -eq 1 ];<span class="hljs-keyword">then</span><br>        <span class="hljs-comment">#查找文件</span><br>        <span class="hljs-built_in">local</span> full_backup_dir=$(find <span class="hljs-variable">$backup_dir</span> -name <span class="hljs-variable">$&#123;sunday&#125;</span>*)<br>        innobackupex --user=<span class="hljs-variable">$MY_USER</span> --password=<span class="hljs-variable">$MY_PASS</span> --incremental <span class="hljs-variable">$&#123;inc_backup_dir&#125;</span> --incremental-basedir=<span class="hljs-variable">$&#123;full_backup_dir&#125;</span><br>        <span class="hljs-comment">#判断是否执行成功，写入定义日志文件</span><br>        <span class="hljs-keyword">if</span> [$? -eq 0];<span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> full OK!!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/OK_log<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> NO found full!!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/err_log<br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-comment">#查找前一天的文件路径</span><br>        <span class="hljs-built_in">local</span> yesterday_backup_dir=$(find <span class="hljs-variable">$backup_dir</span> -name <span class="hljs-variable">$&#123;yesterday&#125;</span>*)<br>        innobackupex --user=<span class="hljs-variable">$MY_USER</span> --password=<span class="hljs-variable">$MY_PASS</span> --incremental <span class="hljs-variable">$&#123;inc_backup_dir&#125;</span> --incremental-basedir=<span class="hljs-variable">$&#123;yesterday_backup_dir&#125;</span><br>        <span class="hljs-comment"># 判断命令是否执行成功,写入日志文件</span><br>        <span class="hljs-keyword">if</span> [$? -eq 0];<span class="hljs-keyword">then</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> full OK!!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/OK_log<br>        <span class="hljs-keyword">else</span><br>            <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> NO found full!!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/err_log<br>        <span class="hljs-keyword">fi</span><br>    <span class="hljs-keyword">fi</span><br>    &#125;<br><br>    <span class="hljs-comment">#查看当前时间是周几</span><br>    week_date=$(<span class="hljs-built_in">date</span> +%u)<br>    <span class="hljs-comment">#判断当前时间是不是周日，如果是进去全量备份，如果不是就进行增量备份</span><br>    <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$week_date</span> -eq 7 ];<span class="hljs-keyword">then</span><br>        full_backup<br>    <span class="hljs-keyword">else</span><br>        inc_backup<br>    <span class="hljs-keyword">fi</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="对时"><a href="#对时" class="headerlink" title="对时"></a>对时</h1><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">check_the_time</span>()&#123;<br>    <span class="hljs-comment"># 关闭防火墙</span><br>    <span class="hljs-string">systemctl</span> <span class="hljs-string">stop</span> <span class="hljs-string">firewalld</span><br>    <span class="hljs-string">setenforce</span> <span class="hljs-string">0</span><br>    <span class="hljs-comment"># 下载软件</span><br>    <span class="hljs-string">yum</span> -<span class="hljs-string">y</span> <span class="hljs-string">instal</span> <span class="hljs-string">ntpdate</span><br>    <span class="hljs-comment"># 查看当前时区</span><br>    <span class="hljs-string">timedatectl</span><br>    <span class="hljs-comment"># 列出可用时区</span><br>    <span class="hljs-comment">#timedatectl list-timezones</span><br>    <span class="hljs-comment"># 修改上海时区</span><br>    <span class="hljs-string">timedatectl</span> <span class="hljs-built_in">set-timezone</span> <span class="hljs-string">Asia</span>/<span class="hljs-string">Shanghai</span><br>    <span class="hljs-comment"># 验证修改是否生效</span><br>    <span class="hljs-string">timedatectl</span><br>    <span class="hljs-comment"># 对时</span><br>    <span class="hljs-string">ntpdate</span> <span class="hljs-string">ntp</span>.<span class="hljs-string">aliyun</span>.<span class="hljs-string">com</span><br>    <span class="hljs-string">echo</span> <span class="hljs-string">&quot;对时成功，当前时间为：&quot;</span> <br>    <span class="hljs-string">date</span> +<span class="hljs-string">&#x27;%F %H:%M:%S&#x27;</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="配置IP"><a href="#配置IP" class="headerlink" title="配置IP"></a>配置IP</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs routeros">COPY_INSTALL()&#123;<br><span class="hljs-attribute">master</span>=ip1<br><span class="hljs-attribute">slave</span>=ip2<br>read -p <span class="hljs-string">&quot;请输入master的IP地址：&quot;</span> IP1<br>read -p <span class="hljs-string">&quot;请输入slave的IP地址：&quot;</span> IP2<br><span class="hljs-comment"># 关闭防火墙</span><br>systemctl stop firewalld;setenforce 0<br><span class="hljs-comment"># 域名解析</span><br>cat &gt;&gt; /etc/hosts &lt;&lt; EOF<br><span class="hljs-variable">$IP1</span> master<br><span class="hljs-variable">$IP2</span> slave<br>EOF<br><span class="hljs-comment"># ping下网络</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">ping </span>slave &amp;&gt; /dev/<span class="hljs-literal">null</span><br><span class="hljs-keyword">if</span> [ $? -eq 0 ];then<br>    echo <span class="hljs-string">&quot;网络正常，可以使用&quot;</span><br><span class="hljs-keyword">else</span><br>    echo <span class="hljs-string">&quot;sorry 网络不通&quot;</span><br>fi<br><span class="hljs-comment"># 添加主机配置</span><br>cat &gt;&gt; /etc/my.cnf &lt;&lt; EOF<br><span class="hljs-attribute">log-bin</span>=/var/lib/mysql/master<br><span class="hljs-attribute">server-id</span>=1<br><span class="hljs-attribute">gtid_mode</span>=ON<br><span class="hljs-attribute">enforce_gtid_consistency</span>=1<br>EOF<br><span class="hljs-comment"># 主机授权</span><br>grant replication slave,super,reload on *.* <span class="hljs-keyword">to</span> slave@<span class="hljs-string">&#x27;%&#x27;</span> identified by <span class="hljs-string">&#x27;Qianfeng123!&#x27;</span>;<br><span class="hljs-comment"># 刷新权限</span><br>flush privileges;<br><span class="hljs-comment"># 此项为互为主从配置</span><br>change master <span class="hljs-keyword">to</span> <span class="hljs-attribute">master_host</span>=<span class="hljs-string">&#x27;slave&#x27;</span>,master_user=&#x27;slave&#x27;,master_password=&#x27;1&#x27;,master_auto_position=1;<br><span class="hljs-comment"># 启动slave服务</span><br>start slave;<br><span class="hljs-comment"># 查看服务状态，是否有error</span><br>show slave status\G<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title function_">exit_menu</span>(<span class="hljs-params"></span>)&#123;<br>    echo <span class="hljs-string">&quot;再见！！！&quot;</span><br>    <span class="hljs-keyword">break</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="定义菜单颜色"><a href="#定义菜单颜色" class="headerlink" title="定义菜单颜色"></a>定义菜单颜色</h1><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs llvm">red()&#123;<br>    echo -e <span class="hljs-string">&quot;<span class="hljs-char escape_">\03</span>3[31m<span class="hljs-char escape_">\03</span>3[01m$1<span class="hljs-char escape_">\03</span>3[0m&quot;</span><br>&#125;<br>green()&#123;<br>    echo -e <span class="hljs-string">&quot;<span class="hljs-char escape_">\03</span>3[32m<span class="hljs-char escape_">\03</span>3[01m$1<span class="hljs-char escape_">\03</span>3[0m&quot;</span><br>&#125;<br>yellow()&#123;<br>    echo -e <span class="hljs-string">&quot;<span class="hljs-char escape_">\03</span>3[33m<span class="hljs-char escape_">\03</span>3[01m$1<span class="hljs-char escape_">\03</span>3[0m&quot;</span><br>&#125;<br>blue()&#123;<br>    echo -e <span class="hljs-string">&quot;<span class="hljs-char escape_">\03</span>3[34m<span class="hljs-char escape_">\03</span>3[01m$1<span class="hljs-char escape_">\03</span>3[0m&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="主菜单选择"><a href="#主菜单选择" class="headerlink" title="主菜单选择"></a>主菜单选择</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">main_menu() &#123;<br>    while true<span class="hljs-comment">; do</span><br>red      <span class="hljs-string">&quot;===============================================&quot;</span><br>green   <span class="hljs-string">&quot;||  ____    _____  _______  _________  _______||&quot;</span><br>yellow  <span class="hljs-string">&quot;|| / __ \  /  _/ |/ / ___/ / __/ __/ |/ / ___/||&quot;</span><br><span class="hljs-keyword">blue </span>   <span class="hljs-string">&quot;||/ /_/ / _/ //    / (_ / / _// _//    / (_ / ||&quot;</span><br>yellow  <span class="hljs-string">&quot;||\___\_\/___/_/|_/\___/ /_/ /___/_/|_/\___/  ||&quot;</span><br>green   <span class="hljs-string">&quot;||                                            ||&quot;</span><br>red     <span class="hljs-string">&quot;===============================================&quot;</span><br><span class="hljs-keyword">blue </span>   <span class="hljs-string">&quot;||            &gt;&gt;&gt;&gt;&gt; 清风徐来 &lt;&lt;&lt;&lt;&lt;            ||&quot;</span><br>red     <span class="hljs-string">&quot;===============================================&quot;</span><br>        echo <span class="hljs-string">&quot;1) 打印当前系统登录用户&quot;</span><br>        echo <span class="hljs-string">&quot;2) 检查软件是否已安装并打印软件信息&quot;</span><br>        echo <span class="hljs-string">&quot;3) 输入时间段和日志路径统计nginx访问日志次数最多的IP&quot;</span><br>        echo <span class="hljs-string">&quot;4) 安装指定软件&quot;</span><br>        echo <span class="hljs-string">&quot;5) 获取系统CPU排名前10的进程&quot;</span><br>        echo <span class="hljs-string">&quot;6) 获取系统内存排名前10的进程&quot;</span><br>        echo <span class="hljs-string">&quot;7) 更改IP&quot;</span><br>        echo <span class="hljs-string">&quot;8) 关闭防火墙&quot;</span><br>        echo <span class="hljs-string">&quot;9) 开启DNS&quot;</span><br>        echo <span class="hljs-string">&quot;10) 备份&quot;</span><br>        echo <span class="hljs-string">&quot;11) 对时&quot;</span><br>        echo <span class="hljs-string">&quot;12) 主从复制&quot;</span><br>        echo <span class="hljs-string">&quot;13) 返回上级菜单&quot;</span><br>        echo <span class="hljs-string">&quot;14) 退出&quot;</span><br>        echo <span class="hljs-string">&quot;============================================&quot;</span><br><br>        read -p <span class="hljs-string">&quot;请输入选项： &quot;</span> select<br>        case $select in<br>            <span class="hljs-number">1</span>)<br>                print_logged_in_users<br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">2</span>)<br>                check_and_print_software_info<br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">3</span>)<br>                analyze_nginx_log<br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">4</span>)<br>                <span class="hljs-keyword">install_software</span><br><span class="hljs-keyword"></span>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">5</span>)<br>                get_top_cpu_processes<br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">6</span>)<br>                get_top_memory_processes<br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">7</span>)<br>                change_IP_address<br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">8</span>)<br>                <span class="hljs-keyword">disable_firewall</span><br><span class="hljs-keyword"></span>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">9</span>)<br>                on_DNS<br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">10</span>)<br>                <span class="hljs-keyword">backup_copy</span><br><span class="hljs-keyword"></span>                <span class="hljs-comment">;;</span><br>            <br>            <span class="hljs-number">11</span>)<br>                check_the_time<br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">12</span>)<br>                COPY_INSTALL<br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">13</span>)<br>                echo <span class="hljs-string">&quot;请重新选择你需要的菜单&quot;</span><br>                continue <span class="hljs-number">2</span><br>                <span class="hljs-comment">;;</span><br>            <span class="hljs-number">14</span>)<br>                exit_menu<br>                <span class="hljs-comment">;;</span><br>            *)<br>                echo <span class="hljs-string">&quot;无效的选择，请重新输入&quot;</span><br>                <span class="hljs-comment">;;</span><br>        esac<br><br>        echo <span class="hljs-string">&quot;============================&quot;</span><br>        read -p <span class="hljs-string">&quot;按任意键返回主菜单&quot;</span> any_key<br>        clear<br>    done<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="运行主菜单"><a href="#运行主菜单" class="headerlink" title="运行主菜单"></a>运行主菜单</h1><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">main_menu</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 负载均衡&amp;反向代理实验</title>
    <link href="/2025/11/06/Nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/"/>
    <url>/2025/11/06/Nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h1 id="负载均衡-反向代理"><a href="#负载均衡-反向代理" class="headerlink" title="负载均衡&amp;反向代理"></a>负载均衡&amp;反向代理</h1><p><strong>准备三台机器：版本为yum源安装</strong></p><p><strong>这个配置是写代理的机器上</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br><span class="hljs-comment"># 1.首先在主配置文件上http模块里添加</span><br> [root@localhost ~]<span class="hljs-comment"># vim /etc/nginx/nginx.conf</span><br> http &#123;<br>     include       <span class="hljs-regexp">/etc/</span>nginx/mime.types;<br>     default_type  application/octet-stream;<br> <span class="hljs-comment"># 以下模块添加到代理的机器上</span><br> upstream testapp &#123;<br>       server <span class="hljs-number">10.0</span>.<span class="hljs-number">105.199</span>:<span class="hljs-number">8081</span>;<br>       server <span class="hljs-number">10.0</span>.<span class="hljs-number">105.202</span>:<span class="hljs-number">8081</span>;<br>    <br>    &#125;<br>     include <span class="hljs-regexp">/etc/</span>nginx<span class="hljs-regexp">/conf.d/</span>*.conf;<br>  &#125;<br>server &#123;<br>        listen       <span class="hljs-number">80</span>;<br>        server_name  www.test.com;<br>        charset utf-<span class="hljs-number">8</span>;<br>        <span class="hljs-comment">#access_log  logs/host.access.log  main;</span><br>        <br> <span class="hljs-comment"># 2.然后在子配置文件里server模块里免添加</span><br>         location / &#123;<br>                 proxy_pass http:<span class="hljs-regexp">//</span>testweb;<br>                 proxy_set_header Host <span class="hljs-variable">$host</span>:<span class="hljs-variable">$server_port</span>;<br>                 proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>                 proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>         &#125;<br> &#125;<br> <br> <span class="hljs-comment"># 此时代理机器上配置完成，刷新nginx服务</span><br> systemctl restart nginx<br></code></pre></td></tr></table></figure><p><strong>以下是在被代理的机器上写入</strong></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><br> # 在两台被代理的机器上分别写入以下<span class="hljs-keyword">location</span>模块内容<br> <span class="hljs-keyword">server</span> &#123;<br>     <span class="hljs-keyword">listen</span>       <span class="hljs-number">80</span>;<br>     server_name  localhost;<br> <br>   #  access_log  /var/<span class="hljs-keyword">log</span>/nginx/host.<span class="hljs-keyword">access</span>.<span class="hljs-keyword">log</span>  main;<br> # 写入以下模块<br>     <span class="hljs-keyword">location</span> / &#123;<br>         root   /usr/<span class="hljs-keyword">share</span>/nginx/html;<br>         <span class="hljs-keyword">index</span>  <span class="hljs-keyword">index</span>.html <span class="hljs-keyword">index</span>.htm;<br>     &#125;<br> &#125;<br> <br> # 此时被代理机器配置完成，重启服务<br> systemctl <span class="hljs-keyword">restart</span> nginx<br><br># 分别在两台宿主机上创建文件及内容<br>echo <span class="hljs-number">111</span> &gt;&gt; /usr/<span class="hljs-keyword">share</span>/nginx/html/<span class="hljs-keyword">index</span>.html<br><br># 测试<br>在网站上输入代理机的IP地址，会分别出来两台宿主机的页面<br></code></pre></td></tr></table></figure><p><strong>验证</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><br> 打开网站，输入代理机器的<span class="hljs-built_in">ip</span>或域名，刷新网站，此时会分别出现被代理机器的内容<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx优势及安装实验</title>
    <link href="/2025/11/06/Nginx%E4%BC%98%E5%8A%BF%E5%8F%8A%E5%AE%89%E8%A3%85/"/>
    <url>/2025/11/06/Nginx%E4%BC%98%E5%8A%BF%E5%8F%8A%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h1 id="Nginx优势及安装"><a href="#Nginx优势及安装" class="headerlink" title="Nginx优势及安装"></a>Nginx优势及安装</h1><h1 id="为什么选择-nginx"><a href="#为什么选择-nginx" class="headerlink" title="为什么选择 nginx"></a>为什么选择 nginx</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">1.高并发，高性能<br>2.高可靠--7*24小时不间断运行<br>3.可扩展性强--模块化设计，使得添加模块非常的平稳<br>4.热部署--可以在不停止服务器的情况下升级nginx<br>5.BSD许可证--nginx不止开源免费的我们还可以更具实际需求进行定制修改源代码<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">它是IO多路复用，通过记录跟踪每个I/O流的状态，来同时管理多个I/O流，另外通过epoll来监控处理有数据的代码</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">外加它是异步非阻塞</span><br></code></pre></td></tr></table></figure><h2 id="yum安装"><a href="#yum安装" class="headerlink" title="yum安装"></a>yum安装</h2><h1 id="1-配置yum源安装nginx"><a href="#1-配置yum源安装nginx" class="headerlink" title="1.配置yum源安装nginx"></a>1.配置yum源安装nginx</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">清理原有数据<br>yum -y install yum-utils<br></code></pre></td></tr></table></figure><h1 id="配置源码文件"><a href="#配置源码文件" class="headerlink" title="配置源码文件"></a>配置源码文件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">/etc/yum.repo.d/nginx.repo &lt;&lt; EOF<br>[nginx-stable]<br>name=nginx stable repo<br>baseurl=http://nginx.org/packages/centos/$releasever/$basearch/<br>gpgcheck=0<br>enabled=1<br>EOF<br></code></pre></td></tr></table></figure><h1 id="下载及启动服务"><a href="#下载及启动服务" class="headerlink" title="下载及启动服务"></a>下载及启动服务</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install nginx<br>systemctl start nginx<br></code></pre></td></tr></table></figure><h1 id="2-yum源选择版本安装"><a href="#2-yum源选择版本安装" class="headerlink" title="2.yum源选择版本安装"></a>2.yum源选择版本安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">配置Yum源的官网：http://nginx.org/en/linux_packages.html<br><br>配置Yum源1.22版本：https://nginx.org/download/nginx-1.22.1.tar.gz<br></code></pre></td></tr></table></figure><h1 id="3-编译安装"><a href="#3-编译安装" class="headerlink" title="3.编译安装"></a>3.编译安装</h1><h1 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl stop firewalld<br>setenforce 0<br></code></pre></td></tr></table></figure><h1 id="下载wget"><a href="#下载wget" class="headerlink" title="下载wget"></a>下载wget</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install wget<br></code></pre></td></tr></table></figure><h1 id="安装编译环境"><a href="#安装编译环境" class="headerlink" title="安装编译环境"></a>安装编译环境</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install gcc gcc-c++<br></code></pre></td></tr></table></figure><h1 id="安装依赖pcre软件包（使nginx支持http-rewrite模块）"><a href="#安装依赖pcre软件包（使nginx支持http-rewrite模块）" class="headerlink" title="安装依赖pcre软件包（使nginx支持http rewrite模块）"></a>安装依赖pcre软件包（使nginx支持http rewrite模块）</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y pcre pcre-devel gd-devel<br></code></pre></td></tr></table></figure><h1 id="安装依赖openssl-devel（使nginx支持ssl）"><a href="#安装依赖openssl-devel（使nginx支持ssl）" class="headerlink" title="安装依赖openssl-devel（使nginx支持ssl）"></a>安装依赖openssl-devel（使nginx支持ssl）</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y openssl openssl-devel<br></code></pre></td></tr></table></figure><h1 id="安装依赖zlib"><a href="#安装依赖zlib" class="headerlink" title="安装依赖zlib"></a>安装依赖zlib</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y zlib zlib-devel<br></code></pre></td></tr></table></figure><h1 id="创建nginx用户，不允许登录"><a href="#创建nginx用户，不允许登录" class="headerlink" title="创建nginx用户，不允许登录"></a>创建nginx用户，不允许登录</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">useradd nginx -s /sbin/nologin<br></code></pre></td></tr></table></figure><h1 id="下载官方nginx"><a href="#下载官方nginx" class="headerlink" title="下载官方nginx"></a>下载官方nginx</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://nginx.org/download/nginx-1.24.0.tar.gz//下载1.24版本<br>wget https://nginx.org/download/nginx-1.22.1.tar.gz//下载 1.22版本<br></code></pre></td></tr></table></figure><h1 id="解压nginx包"><a href="#解压nginx包" class="headerlink" title="解压nginx包"></a>解压nginx包</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar zxvf nginx-1.24.0.tar.gz -C /usr/local/<br></code></pre></td></tr></table></figure><h1 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/nginx-1.24.0/<br></code></pre></td></tr></table></figure><h1 id="配置安装参数"><a href="#配置安装参数" class="headerlink" title="配置安装参数"></a>配置安装参数</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">./configure --prefix=/usr/local/nginx --group=nginx --user=nginx --sbin-path=/usr/local/nginx/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/tmp/nginx/client_body --http-proxy-temp-path=/tmp/nginx/proxy --http-fastcgi-temp-path=/tmp/nginx/fastcgi --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_realip_module --with-stream<br></code></pre></td></tr></table></figure><h1 id="过程当中如果出错，删除Makefile文件后重新配置"><a href="#过程当中如果出错，删除Makefile文件后重新配置" class="headerlink" title="过程当中如果出错，删除Makefile文件后重新配置"></a>过程当中如果出错，删除Makefile文件后重新配置</h1><h1 id="编译以及编译安装"><a href="#编译以及编译安装" class="headerlink" title="编译以及编译安装"></a>编译以及编译安装</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">make &amp;&amp; make install<br><span class="hljs-meta prompt_">#</span><span class="language-bash">检测nginx配置文件是否正确</span><br>/usr/local/nginx/sbin/nginx -t<br>mkdir -p /tmp/nginx/client_body<br></code></pre></td></tr></table></figure><h1 id="启动nginx服务"><a href="#启动nginx服务" class="headerlink" title="启动nginx服务"></a>启动nginx服务</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/local/nginx/sbin/nginx<br></code></pre></td></tr></table></figure><h1 id="创建连接文件，可以直接用nginx命令"><a href="#创建连接文件，可以直接用nginx命令" class="headerlink" title="创建连接文件，可以直接用nginx命令"></a>创建连接文件，可以直接用nginx命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx<br></code></pre></td></tr></table></figure><h1 id="连接文件创建成功后，nginx常用命令"><a href="#连接文件创建成功后，nginx常用命令" class="headerlink" title="连接文件创建成功后，nginx常用命令"></a>连接文件创建成功后，nginx常用命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">nginx -s reload# 修改配置后重新加载生效<br>nginx -s stop# 快速停止nginx<br>nginx -s quit# 正常停止nginx<br>nginx -t# 测试当前配置文件是否正确**<br>nginx#正常启动<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 配置健康检查模块实验</title>
    <link href="/2025/11/06/Nginx-%E9%85%8D%E7%BD%AE%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E6%A8%A1%E5%9D%97/"/>
    <url>/2025/11/06/Nginx-%E9%85%8D%E7%BD%AE%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E6%A8%A1%E5%9D%97/</url>
    
    <content type="html"><![CDATA[<h1 id="nginx配置健康检查模块"><a href="#nginx配置健康检查模块" class="headerlink" title="nginx配置健康检查模块"></a>nginx配置健康检查模块</h1><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">1</span>.nginx自带的针对后端节点健康检查的功能比较简单，通过默认自带的ngx_http_proxy_module 模块和ngx_http_upstream_module模块中的参数来完成，当后端节点出现故障时，自动切换到健康节点来提供访问。但是nginx不能事先知道后端节点状态是否健康，后端即使有不健康节点，负载均衡器依然会先把请求转发给该不健康节点，然后再转发给别的节点，这样就会浪费一次转发，而且自带模块无法做到预警。所以我们可以使用第三方模块 nginx_upstream_check_module模块<br><br><span class="hljs-number">2</span>.nginx_upstream_check_module模块由淘宝团队开发 淘宝自己的 tengine 上是自带了该模块的。我们使用原生Nginx，采用添加模块的方式<br></code></pre></td></tr></table></figure><h1 id="健康检查模块最高支持1-22及以下的nginx版本"><a href="#健康检查模块最高支持1-22及以下的nginx版本" class="headerlink" title="健康检查模块最高支持1.22及以下的nginx版本"></a>健康检查模块最高支持1.22及以下的nginx版本</h1><p>获取nginx_upstream_check_module模块，从github上面获取</p><h1 id="下载模块"><a href="#下载模块" class="headerlink" title="下载模块"></a>下载模块</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/refs/heads/master.zip<br></code></pre></td></tr></table></figure><h1 id="下载解压软件包及解压"><a href="#下载解压软件包及解压" class="headerlink" title="下载解压软件包及解压"></a>下载解压软件包及解压</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y unzip<br><br>unzip -d /usr/local/ master.zip//解压要指定目录<br></code></pre></td></tr></table></figure><h1 id="进入nginx的解压目录中"><a href="#进入nginx的解压目录中" class="headerlink" title="进入nginx的解压目录中"></a>进入nginx的解压目录中</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/nginx-1.22.1/<br></code></pre></td></tr></table></figure><h1 id="下载指定路径安装软件"><a href="#下载指定路径安装软件" class="headerlink" title="下载指定路径安装软件"></a>下载指定路径安装软件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y patch//patch可以指定安装路径<br></code></pre></td></tr></table></figure><h1 id="打补丁"><a href="#打补丁" class="headerlink" title="打补丁"></a>打补丁</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">-p0，是“当前路径” -p1，是“上一级路径”</span><br>patch -p1 &lt; ../nginx_upstream_check_module-master/check_1.20.1+.patch<br></code></pre></td></tr></table></figure><p>编译下载安装</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">./configure --prefix=/usr/local/nginx --group=nginx --user=nginx --sbin-path=/usr/local/nginx/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/tmp/nginx/client_body --http-proxy-temp-path=/tmp/nginx/proxy --http-fastcgi-temp-path=/tmp/nginx/fastcgi --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_realip_module --with-stream --add-module=../nginx_upstream_check_module-master/<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">--add-module=../nginx_upstream_check_module-master///这个是添加的nginx_upstream_check_module模块</span><br></code></pre></td></tr></table></figure><h1 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">make //如果是添加模块只需要make 第一次安装需要make install<br></code></pre></td></tr></table></figure><h1 id="将原来的nginx二进制命令备份"><a href="#将原来的nginx二进制命令备份" class="headerlink" title="将原来的nginx二进制命令备份"></a>将原来的nginx二进制命令备份</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak<br></code></pre></td></tr></table></figure><h1 id="将新生成的命令cp到nginx的命令目录中"><a href="#将新生成的命令cp到nginx的命令目录中" class="headerlink" title="将新生成的命令cp到nginx的命令目录中"></a>将新生成的命令cp到nginx的命令目录中</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cp objs/nginx /usr/local/nginx/sbin/<br></code></pre></td></tr></table></figure><h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell">http &#123;<br>upstream app &#123;<br>        server 192.168.209.128 weight=1;<br>        server 192.168.209.130 weight=1;<br>        check interval=5000 rise=2 fall=3 timeout=4000 type=http port=80;<br>        check_http_send &quot;HEAD / HTTP/1.0\r\n\r\n&quot;;<br>        check_http_expect_alive http_2xx http_3xx;<br>        &#125;<br>        <br>server &#123;<br>        listen       80;<br>        server_name  localhost;<br><br>        location / &#123;<br>                proxy_pass http://app;<br>                proxy_redirect default;<br>                proxy_set_header Host $http_host;<br>                proxy_set_header X-Real-IP $remote_addr;<br>                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>                &#125;<br>        location /status &#123;   #开启监控状态页面<br>                check_status;<br>                access_log   off;<br>           &#125;<br>        &#125;<br>&#125;<br><br>参数解释：<br>interval:表示每隔多少毫秒向后端发送健康检查包；<br>rise:表示如果连续成功次数达到2 服务器就被认为是up；<br>fail:表示如果连续失败次数达到3 服务器就被认为是down；<br>timeout:表示后端健康请求的超时时间是多少毫秒；<br>type:表示发送的健康检查包是什么类型的请求；<br>port: 表示发送检查到后端的服务的端口;<br>check_http_send:表示http健康检查包发送的请求内容。为了减少传输数据量，推荐采用“head”方法；<br>check_http_expect_alive:指定HTTP回复的成功状态，默认认为2XX和3XX的状态是健康的；<br></code></pre></td></tr></table></figure><h1 id="查看访问状态"><a href="#查看访问状态" class="headerlink" title="查看访问状态"></a>查看访问状态</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">192.168.116.111/status//查看状态，需要在IP地址后面加上status<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 会话保持实验</title>
    <link href="/2025/11/06/Nginx-%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81/"/>
    <url>/2025/11/06/Nginx-%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81/</url>
    
    <content type="html"><![CDATA[<h1 id="nginx-会话保持"><a href="#nginx-会话保持" class="headerlink" title="nginx 会话保持"></a>nginx 会话保持</h1><p>nginx会话保持主要有以下几种实现方式：</p><p>1、ip_hash</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">ip_hash使用源地址哈希算法，将同一客户端的请求总是发往同一个后端服务器，除非该服务器不可用。<br><br>ip_hash简单易用，但有如下问题：<br>当后端服务器宕机后，session会丢失；<br>来自同一局域网的客户端会被转发到同一个后端服务器，可能导致负载失衡；<br></code></pre></td></tr></table></figure><p>示例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">upstream backend &#123;<br>    ip_hash;<br>    server backend1.example.com;<br>    server backend2.example.com;<br>    server backend3.example.com down;<br>&#125;<br></code></pre></td></tr></table></figure><p>2、sticky_cookie_insert—而是基于cookie实现</p><p>使用sticky_cookie_insert，这会让来自同一客户端的请求被传递到一组服务器的同一台服务器。与ip_hash不同之处在于，它不是基于IP来判断客户端的，而是基于cookie来判断。(需要引入第三方模块才能实现)—sticky模块。因此可以避免上述ip_hash中来自同一局域网的客户端和前段代理导致负载失衡的情况。</p><p>在yum安装的nginx的环境下，编译安装sticky添加模块</p><p>查看yum安装nginx路径，后面编译安装需要用</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nginx -V//减大V，查看安装路径<br></code></pre></td></tr></table></figure><p>删除原有nginx文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">rm -rf /etc/share/nginx/*//删除配置文件<br>rm -rf /var/log/nginx/*//删除日志文件<br></code></pre></td></tr></table></figure><p>安装编译环境</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install -y pcre* openssl* gcc gcc-c++ make<br></code></pre></td></tr></table></figure><p>下载sticky模块</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget  https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/get/08a395c66e42.zip<br></code></pre></td></tr></table></figure><p>查看nginx版本</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nginx -v//减小v，查看版本<br></code></pre></td></tr></table></figure><p>下载yum安装nginx对应版本的源码包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget  http://nginx.org/download/nginx-1.18.0.tar.gz<br></code></pre></td></tr></table></figure><p>下载解压工具及解压</p><figure class="highlight gml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gml">yum install -<span class="hljs-variable language_">y</span> unzip<span class="hljs-comment">//下载解压工具</span><br><br>unzip <span class="hljs-number">08</span>a395c66e42.zip<span class="hljs-comment">//解压</span><br></code></pre></td></tr></table></figure><p>更改软件名字</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mv nginx-goodies-nginx-sticky-module-ng-08a395c66e42/ nginx-sticky-module-ng/<br></code></pre></td></tr></table></figure><p>解压nginx的源码包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar xzvf nginx-1.18.0.tar.gz -C /usr/local///指定路径，解压nginx<br></code></pre></td></tr></table></figure><p>进入nginx目录里</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /usr/local/nginx-1.18.0/<br></code></pre></td></tr></table></figure><p>查看yum安装nginx所有模块</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">nginx -V<br></code></pre></td></tr></table></figure><p>下载</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#x27; --with-ld-opt=&#x27;-Wl,-z,relro -Wl,-z,now -pie&#x27; --add-module=/root/nginx-sticky-module-ng<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">--add-module=/root/nginx-sticky-module-ng是添加的cookie模块</span><br></code></pre></td></tr></table></figure><p>配置基于cookie会话保持</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">在代理上写入</span><br>upstream qfedu &#123;<br>        server 192.168.198.143;<br>        server 192.168.198.145;<br>        sticky;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在宿柱机上写入</span><br>server &#123;<br>    listen       80;<br>    server_name  localhost;<br><br>    #charset koi8-r;<br>    #access_log  /var/log/nginx/host.access.log  main;<br><br>    location / &#123;<br>        proxy_pass http://qfedu;<br>    &#125;<br><br>&#125;<br><br>说明：<br>expires：设置浏览器中保持cookie的时间 <br>domain：定义cookie的域 <br>path：为cookie定义路径<br></code></pre></td></tr></table></figure><p>查看nginx配置是不是正常，及启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">nginx -t//查看配置是不是正常 <br><br>nginx -s reload//重启nginx<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 实现动静分离实验</title>
    <link href="/2025/11/06/Nginx-%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/"/>
    <url>/2025/11/06/Nginx-%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/</url>
    
    <content type="html"><![CDATA[<h1 id="nginx-实现动静分离"><a href="#nginx-实现动静分离" class="headerlink" title="nginx 实现动静分离"></a>nginx 实现动静分离</h1><p><code>准备环境</code></p><p>准备3台机器，一个nginx代理 两个http 分别处理动态和静态</p><p><code>expires</code>功能说明</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">当nginx设置了expires后，例如设置为：expires 10d; 那么用户在10天内请求的时候，都只会访问浏览器中的缓存，而不会去请求nginx。<br></code></pre></td></tr></table></figure><h1 id="1、静态资源配置"><a href="#1、静态资源配置" class="headerlink" title="1、静态资源配置"></a>1、静态资源配置</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">server &#123;<br>        listen 80;<br>        server_name     localhost;<br><br>        location ~ \.(html|jpg|png|js|css) &#123;<br>        root /home/www/nginx;<br>        expires      1d; #为客户端设置静态资源缓存时间<br>        &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>测试</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -I http://192.168.116.111/test.jpg<br>HTTP/1.1 200 OK//显示200，代表成功<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">也可以在网址访问：192.168.116.111/test.jpg</span><br></code></pre></td></tr></table></figure><h1 id="2、动态资源配置"><a href="#2、动态资源配置" class="headerlink" title="2、动态资源配置"></a>2、动态资源配置</h1><p><code>yum 安装php7.1</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">下载epel源</span><br>rpm -Uvh https://mirror.webtatic.com/yum/el7/epel-release.rpm<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Webtatic存储库添加到您的系统中，并从该存储库安装或升级相关的软件包</span><br>rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm<br><br>-U 表示更新（如果软件包已经安装则进行升级）。<br>-v 表示显示详细的安装过程。<br>-h 表示在安装过程中显示进度条。<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载php依赖包及主包</span><br>`依赖包`<br>yum -y install php71w-xsl php71w php71w-ldap php71w-cli php71w-common php71w-devel php71w-gd php71w-pdo php71w-mysql php71w-mbstring php71w-bcmath php71w-mcrypt<br>`主包`<br>yum install -y php71w-fpm<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动php</span><br>systemctl start php-fpm<br></code></pre></td></tr></table></figure><h1 id="编辑nginx的配置文件"><a href="#编辑nginx的配置文件" class="headerlink" title="编辑nginx的配置文件"></a>编辑nginx的配置文件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">erver &#123;<br>        listen      80;<br>        server_name     localhost;<br>        location ~ \.php$ &#123;<br>            root           /home/nginx/html;  #指定网站目录<br>            fastcgi_pass   127.0.0.1:9000;    #开启fastcgi连接php地址<br>            fastcgi_index  index.php;#指定默认文件<br>            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name; #站点根目录，取决于root配置项<br>            include        fastcgi_params;  #包含fastcgi使用的常量<br>        &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><h1 id="3、配置nginx反向代理upstream，并实现客户端缓存时间"><a href="#3、配置nginx反向代理upstream，并实现客户端缓存时间" class="headerlink" title="3、配置nginx反向代理upstream，并实现客户端缓存时间"></a>3、配置nginx反向代理upstream，并实现客户端缓存时间</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs shell">upstream static &#123;<br>        server 10.0.105.196:80 weight=1 max_fails=1 fail_timeout=60s;<br>        &#125;<br>upstream php &#123;<br>        server 10.0.105.200:80 weight=1 max_fails=1 fail_timeout=60s;<br>        &#125;<br><br>        server &#123;<br>        listen      80;<br>        server_name     localhost<br>        #动态资源加载<br>        location ~ \.(php|jsp)$ &#123;<br>            proxy_pass http://php;<br>            proxy_set_header Host $host:$server_port;<br>            proxy_set_header X-Real-IP $remote_addr;<br>            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>                &#125;<br>        #静态资源加载<br>        location ~ .*\.(html|jpg|png|css|js)$ &#123;<br>            proxy_pass http://static;<br>            proxy_set_header Host $host:$server_port;<br>            proxy_set_header X-Real-IP $remote_addr;<br>            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>                &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><p><code>在网址上输入代理机的IP，后缀加上你要查看的（静态图片名字|动态图片名字）</code></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 的localtion指令详解实验</title>
    <link href="/2025/11/06/Nginx-%E7%9A%84localtion%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/"/>
    <url>/2025/11/06/Nginx-%E7%9A%84localtion%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="nginx的localtion指令详解"><a href="#nginx的localtion指令详解" class="headerlink" title="nginx的localtion指令详解"></a>nginx的localtion指令详解</h1><p><code>Nginx 的 HTTP 配置主要包括三个区块，结构如下：</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">http &#123; # 这个是协议级别<br>　　include mime.types;<br>　　default_type application/octet-stream;<br>　　keepalive_timeout 65;<br>　　gzip on;<br>　　　　server &#123; # 这个是服务器级别<br>　　　　　　listen 80;<br>　　　　　　server_name localhost;<br>　　　　　　　　location / &#123;  # 这个是请求级别<br>　　　　　　　　　　root html;<br>　　　　　　　　　　index index.html index.htm;<br>　　　　　　　　&#125;<br>　　　　　　&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>一个HTTP模块里可以有多个server模块</code> <code>一个server模块里可以有多个location模块</code></p><h1 id="location-前缀含义"><a href="#location-前缀含义" class="headerlink" title="location 前缀含义"></a>location 前缀含义</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">=    表示精确匹配，优先级也是最高的 <br>^~   表示uri以某个常规字符串开头,理解为匹配url路径即可 <br>~    表示区分大小写的正则匹配  <br>~*   表示不区分大小写的正则匹配<br>!~   表示区分大小写不匹配的正则<br>!~*  表示不区分大小写不匹配的正则<br>/    通用匹配，任何请求都会匹配到<br>@    内部服务跳转<br></code></pre></td></tr></table></figure><h1 id="查找顺序和优先级"><a href="#查找顺序和优先级" class="headerlink" title="查找顺序和优先级"></a>查找顺序和优先级</h1><p><code>= 大于 ^~  大于 ~|~*|!~|!~* 大于 /</code></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 地址重写 rewrite实验</title>
    <link href="/2025/11/06/Nginx-%E5%9C%B0%E5%9D%80%E9%87%8D%E5%86%99-rewrite/"/>
    <url>/2025/11/06/Nginx-%E5%9C%B0%E5%9D%80%E9%87%8D%E5%86%99-rewrite/</url>
    
    <content type="html"><![CDATA[<h1 id="nginx-地址重写-rewrite"><a href="#nginx-地址重写-rewrite" class="headerlink" title="nginx 地址重写 rewrite"></a>nginx 地址重写 rewrite</h1><p><code>什么是Rewrite</code></p><p>Rewrite对称URL Rewrite，即URL重写，就是把传入Web的请求重定向到其他URL的过程</p><p><code>Rewrite 相关指令</code></p><p>Nginx Rewrite 相关指令有 if、rewrite、set、return</p><h1 id="rewrite指令最后跟一个flag标记，支持的flag标记有"><a href="#rewrite指令最后跟一个flag标记，支持的flag标记有" class="headerlink" title="rewrite指令最后跟一个flag标记，支持的flag标记有"></a>rewrite指令最后跟一个flag标记，支持的flag标记有</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">last     表示完成rewrite。默认为last。会第二次验证<br>break 本条规则匹配完成后，终止匹配，不再匹配后面的规则<br>redirect 返回302临时重定向，浏览器地址会显示跳转后的URL地址<br>permanent     返回301永久重定向，浏览器地址会显示跳转后URL地址<br></code></pre></td></tr></table></figure><h1 id="1、Rewrite匹配参考示例"><a href="#1、Rewrite匹配参考示例" class="headerlink" title="1、Rewrite匹配参考示例"></a>1、Rewrite匹配参考示例</h1><p>示例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs shell">例1：<br>本地解析host文件--wind<br><span class="hljs-meta prompt_"># </span><span class="language-bash">http://www.testpm.com/a/1.html ==&gt; http://www.testpm.com/b/2.html</span><br>    location /a &#123;<br>        root    /html;<br>        index   1.html index.htm;<br>        rewrite .* /b/2.html permanent;<br>        &#125;<br>    location /b &#123;<br>        root    /html;<br>        index   2.html index.htm;<br>        &#125;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">IP地址后面需要跟后缀 `/a/1.html`</span><br><br>例2：<br><span class="hljs-meta prompt_"># </span><span class="language-bash">http://www.testpm.com/2019/a/1.html ==&gt; http://www.testpm.com/2018/a/1.html</span><br>     location /2019/a &#123;<br>        root    /var/www/html;<br>        index   1.html index.hml;<br>        rewrite ^/2019/(.*)$ /2018/$1 permanent;<br>        &#125;<br>     location /2018/a &#123;<br>        root    /var/www/html;<br>        index   1.html index.htl;<br>        &#125;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">IP地址后面需要跟后缀 `/2019/a/1.html`</span><br><br>例3：<br><span class="hljs-meta prompt_"># </span><span class="language-bash">http://www.qf.com/a/1.html ==&gt; http://jd.com</span><br>location /a &#123;<br>        root    /html;<br>        if ($host ~* www.qf.com ) &#123;<br>        rewrite .* http://jd.com permanent;<br>        &#125;<br>        &#125;<br><br>例4：<br><span class="hljs-meta prompt_"># </span><span class="language-bash">http://www.qf.com/a/1.html ==&gt; http://jd.com/a/1.html</span><br>location /a &#123;<br>        root /html;<br>        if ( $host ~* qf.com )&#123;<br>        rewrite .* http://jd.com$request_uri permanent;<br>        &#125;<br>        &#125;<br><br>例5：<br><span class="hljs-meta prompt_"># </span><span class="language-bash">http://www.tianyun.com/login/tianyun.html ==&gt; http://www.tianyun.com/reg/login.html?user=tianyun</span><br>location /login &#123;<br>        root   /usr/share/nginx/html;<br>        rewrite ^/login/(.*)\.html$ http://$host/reg/login.html?user=$1;<br>        &#125;<br>    location /reg &#123;<br>        root /usr/share/nginx/html;<br>        index login.html;<br>        &#125;<br><br>例6：<br><span class="hljs-meta prompt_">#</span><span class="language-bash">http://www.tianyun.com/qf/11-22-33/1.html  ==&gt;  http://www.tianyun.com/qf/11/22/33/1.html</span><br>location /qf &#123;<br>            rewrite ^/qf/([0-9]+)-([0-9]+)-([0-9]+)(.*)$ /qf/$1/$2/$3$4 permanent;<br>        &#125;<br><br>        location /qf/11/22/33 &#123;<br>                root /html;<br>                index   1.html;<br>        &#125;<br></code></pre></td></tr></table></figure><h1 id="2、set-指令"><a href="#2、set-指令" class="headerlink" title="2、set 指令"></a>2、set 指令</h1><p>set 指令是用于定义一个变量，并且赋值</p><p>示例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs shell">例8：<br><span class="hljs-meta prompt_">#</span><span class="language-bash">http://alice.testpm.com ==&gt; http://www.testpm.com/alice</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">http://jack.testpm.com ==&gt; http://www.testpm.com/jack</span><br><br>[root@nginx-server conf.d]# cd /usr/share/nginx/html/<br>[root@nginx-server html]# mkdir jack alice<br>[root@nginx-server html]# echo &quot;jack..&quot; &gt;&gt; jack/index.html<br>[root@nginx-server html]# echo &quot;alice..&quot; &gt;&gt; alice/index.html<br><br>本地解析域名host文件<br>10.0.105.202 www.testpm.com<br>10.0.105.202 alice.testpm.com<br>10.0.105.202 jack.testpm.com<br>编辑配置文件:<br>server &#123;<br>    listen       80;<br>    server_name  www.testpm.com;<br><br>    location / &#123;<br>         root   /usr/share/nginx/html;<br>         index  index.html index.htm;<br>         if ( $host ~* ^www.testpm.com$) &#123;<br>                break;<br>                &#125;<br>         if ( $host ~* &quot;^(.*)\.testpm\.com$&quot; ) &#123;<br>                set $user $1;<br>                rewrite .* http://www.testpm.com/$user permanent;<br>                &#125;<br>        &#125;<br>    location /jack &#123;<br>         root /usr/share/nginx/html;<br>         index  index.html index.hml;<br>        &#125;<br>    location /alice &#123;<br>         root /usr/share/nginx/html;<br>         index index.html index.hml;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="3、return-指令"><a href="#3、return-指令" class="headerlink" title="3、return 指令"></a>3、return 指令</h1><p>return 指令用于返回状态码给客户端</p><p>示例</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">例9：如果访问的.sh结尾的文件则返回403操作拒绝错误<br>server &#123;<br>    listen       80;<br>    server_name  www.testpm.cn;<br>    #access_log  /var/log/nginx/http_access.log  main;<br><br>    location / &#123;<br>        root   /usr/share/nginx/html;<br>        index  index.html index.htm;<br>        &#125;<br><br>    location ~* \.sh$ &#123;<br>        return 403;<br>        &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="4、last-break详解"><a href="#4、last-break详解" class="headerlink" title="4、last,break详解"></a>4、last,break详解</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost test]# cat /etc/nginx/conf.d/last_break.conf <br>server &#123;<br>    listen       80;<br>    server_name  localhost;<br>    access_log  /var/log/nginx/last.access.log  main;<br><br>    location / &#123;<br>        root   /usr/share/nginx/html;<br>        index  index.html index.htm;<br>    &#125;<br>    location /break/ &#123;<br>        root /usr/share/nginx/html;<br>        rewrite .* /test/break.html break;<br>    &#125;<br>    location /last/ &#123;<br>        root /usr/share/nginx/html;<br>        rewrite .* /test/last.html last;<br>    &#125;<br>    location /test/ &#123;<br>        root /usr/share/nginx/html;<br>        rewrite .* /test/test.html break;<br>    &#125;<br><br>&#125;<br>[root@localhost conf.d]# cd /usr/share/nginx/html/<br>[root@localhost html]# mkdir test<br>[root@localhost html]# echo &quot;last&quot; &gt; test/last.html<br>[root@localhost html]# echo &quot;break&quot; &gt; test/break.html<br>[root@localhost html]# echo &quot;test&quot; &gt; test/test.html<br><br>http://10.0.105.196/break/break.html<br>http://10.0.105.196/last/last.html<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 日志切割脚本实验</title>
    <link href="/2025/11/06/Nginx-%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2%E8%84%9A%E6%9C%AC/"/>
    <url>/2025/11/06/Nginx-%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="nginx日志切割脚本"><a href="#nginx日志切割脚本" class="headerlink" title="nginx日志切割脚本"></a>nginx日志切割脚本</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk">[root@nginx-web script]<span class="hljs-comment"># vim nginx_log.sh</span><br><span class="hljs-comment">#!/bin/bash</span><br>date=`date +%F -d -<span class="hljs-number">1</span>day`<br>log_dir=<span class="hljs-regexp">/var/</span>log<span class="hljs-regexp">/nginx/</span><br>log_name=access.log<br>[ -d <span class="hljs-variable">$log_dir</span> ] &amp;&amp; cd <span class="hljs-variable">$log_dir</span> || <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span><br>[ -f <span class="hljs-variable">$log_name</span> ] || <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span><br><span class="hljs-regexp">/bin/m</span>v <span class="hljs-variable">$log_name</span> <span class="hljs-variable">$log_name</span>.<span class="hljs-variable">$&#123;date&#125;</span><br><span class="hljs-regexp">/usr/</span>sbin/nginx -s reload<br>tar czf <span class="hljs-variable">$log_name</span>.<span class="hljs-variable">$&#123;date&#125;</span>.tar.gz <span class="hljs-variable">$log_name</span>.<span class="hljs-variable">$&#123;date&#125;</span> &amp;&amp; rm -rf <span class="hljs-variable">$log_name_</span><span class="hljs-variable">$&#123;date&#125;</span><br><br><br><span class="hljs-comment">#delete</span><br>cd <span class="hljs-variable">$log_dir</span> || <span class="hljs-keyword">exit</span> <span class="hljs-number">1</span><br>find ./ -mtime +<span class="hljs-number">7</span> -type f -name *.log | xargs rm -rf<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 流量控制实验</title>
    <link href="/2025/11/06/Nginx-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/"/>
    <url>/2025/11/06/Nginx-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="Nginx-流量控制"><a href="#Nginx-流量控制" class="headerlink" title="Nginx 流量控制"></a>Nginx 流量控制</h1><p>配置基本的限流–ngx_http_limit_req_module模块实现</p><p>流量限制”配置两个主要的指令，<code>limit_req_zone</code>和<code>limit_req</code>，<code>limit_req_zone</code>指令设置流量限制和内存区域的参数，但实际上并不限制请求速率。所以需要通过添加<code>limit_req</code>指令启用流量限制,应用在特定的<code>location</code>或者<code>server</code>块</p><p><code>limit_req_zone</code>指令通常在HTTP块中定义，它需要以下三个参数：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">-Key - 定义应用限制的请求特性。示例中的 Nginx 变量$binary_remote_addr，保存客户端IP地址的二进制形式。<br>-Zone - 定义用于存储每个IP地址状态以及被限制请求URL访问频率的内存区域。通过<span class="hljs-attr">zone</span>=keyword标识区域的名字(自定义)，以及冒号后面跟区域大小。<span class="hljs-number">16000</span>个IP地址的状态信息，大约需要<span class="hljs-number">1</span>MB。<br>-Rate - 连接请求。在示例中，速率不能超过每秒1个请求。<br></code></pre></td></tr></table></figure><p>示例一</p><p>这里需要两台机器，一台代理，一台宿主机</p><p><code>代理机配置</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/s;<br>        upstream myweb &#123;<br>                server 10.0.105.196:80 weight=1 max_fails=1 fail_timeout=1;<br>                &#125;<br>        server &#123;<br>                listen 80;<br>                server_name localhost;<br><br>                location /login &#123;<br>                        limit_req zone=mylimit;<br>                        proxy_pass http://myweb;<br>                        proxy_set_header Host $host:$server_port;<br>                        proxy_set_header X-Real-IP $remote_addr;<br>                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>                        &#125;<br>        &#125;<br></code></pre></td></tr></table></figure><p><code>宿主机配置</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini">192.168.116.111配置:<br>server &#123;<br>        listen 80<span class="hljs-comment">;</span><br>        server_name localhost<span class="hljs-comment">;</span><br>        location /login &#123;<br>                root    /usr/share/nginx/html<span class="hljs-comment">;</span><br>                index   index.html index.html<span class="hljs-comment">;</span><br>                &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>测试及查看日志</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini">客户端安装压力测试工具<br><span class="hljs-section">[root@nginx-yum ~]</span><span class="hljs-comment"># yum install httpd-tools</span><br><span class="hljs-section">[root@nginx-yum ~]</span><span class="hljs-comment"># ab -n1000 -c2 http://10.0.105.196/</span><br>-n 请求数<br>-c 并发数<br>代理机器看错误日志：<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># tail -f /var/log/nginx/error.log </span><br>2019/09/10 07:32:09 <span class="hljs-section">[error]</span> 1371<span class="hljs-comment">#0: *1095 limiting requests, excess: 0.390 by zone &quot;mylimit&quot;, client: 10.0.105.196, server: localhost, request: &quot;GET / HTTP/1.0&quot;, host: &quot;10.0.105.196&quot;</span><br></code></pre></td></tr></table></figure><p>示例二</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ini">limit_req_zone $binary_remote_addr <span class="hljs-attr">zone</span>=mylimit:<span class="hljs-number">10</span>m rate=<span class="hljs-number">1</span>r/s<span class="hljs-comment">;</span><br>        upstream myweb &#123;<br>                server 10.0.105.196:80 <span class="hljs-attr">weight</span>=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">1</span> fail_timeout=<span class="hljs-number">1</span><span class="hljs-comment">;</span><br>                &#125;<br>        server &#123;<br>                listen 80<span class="hljs-comment">;</span><br>                server_name localhost<span class="hljs-comment">;</span><br><br>                location /login &#123;<br>                        <span class="hljs-comment">#limit_req zone=mylimit;</span><br>limit_req <span class="hljs-attr">zone</span>=mylimit burst=<span class="hljs-number">5</span><span class="hljs-comment">;</span><br><span class="hljs-comment">#limit_req zone=mylimit burst=5 nodelay;</span><br>                        proxy_pass http://myweb<span class="hljs-comment">;</span><br>                        proxy_set_header Host $host:$server_port<span class="hljs-comment">;</span><br>                        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span><br>                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span><br>                        &#125;<br>        &#125;<br><span class="hljs-attr">burst</span>=<span class="hljs-number">5</span> 表示最大延迟请求数量不大于<span class="hljs-number">5</span>。超出的请求返回<span class="hljs-number">503</span>状态码。<br>客户端测试--burst<br><span class="hljs-section">[root@nginx-yum ~]</span><span class="hljs-comment"># ab -n1000 -c50 http://10.0.105.195/</span><br>代理机器上面看日志<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># tail -f /var/log/nginx/access.log</span><br>10.0.105.196 - - <span class="hljs-section">[10/Sep/2019:08:05:10 +0800]</span> &quot;GET / HTTP/1.0&quot; 503 197 &quot;-&quot; &quot;ApacheBench/2.3&quot; &quot;-&quot;<br>10.0.105.196 - - <span class="hljs-section">[10/Sep/2019:08:05:11 +0800]</span> &quot;GET / HTTP/1.0&quot; 200 2 &quot;-&quot; &quot;ApacheBench/2.3&quot; &quot;-&quot;<br><br>nodelay：不延迟转发请求。速度变快<br>客户端测试--burst<br><span class="hljs-section">[root@nginx-yum ~]</span><span class="hljs-comment"># ab -n1000 -c50 http://10.0.105.195/</span><br><br>总结：<br>如果不加nodelay只有burst的时候只会延迟转发请求超过限制的请求出现503错误<br>如果nodelay和burst参数都有不会延迟转发请求并且超出规定的请求次数会返回503<br></code></pre></td></tr></table></figure><p>日志字段介绍</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini">- limiting requests - 表明日志条目记录的是被“流量限制”请求<br>- excess - 每毫秒超过对应“流量限制”配置的请求数量<br>- zone - 定义实施“流量限制”的区域<br>- client - 发起请求的客户端IP地址<br>- server - 服务器IP地址或主机名<br>- request - 客户端发起的实际HTTP请求<br>- host - HTTP报头中host的值<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 访问控制实验</title>
    <link href="/2025/11/06/Nginx-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/"/>
    <url>/2025/11/06/Nginx-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="Nginx-访问控制"><a href="#Nginx-访问控制" class="headerlink" title="Nginx 访问控制"></a>Nginx 访问控制</h1><p>nginx 访问控制模块</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini">（1）基于IP的访问控制：http_access_module<br>（2）基于用户的信任登录：http_auth_basic_module<br></code></pre></td></tr></table></figure><p>1、基于IP的访问控制</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 语法</span><br>Syntax：allow address | all<span class="hljs-comment">;</span><br>default：默认无<br>Context：http，server，location<br><br>Syntax：deny address | all<span class="hljs-comment">;</span><br>default：默认无<br><br>Context：http，server，<span class="hljs-attr">location</span><br>===================================================<br><br>allow    允许     //ip或者网段<br>deny    拒绝     //ip或者网段<br></code></pre></td></tr></table></figure><p>示例一</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 拒绝192.168.1.8登入，允许其他所有</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># vim /etc/nginx/conf.d/access_mod.conf</span><br>server &#123;<br>        listen 80<span class="hljs-comment">;</span><br>        server_name localhost<span class="hljs-comment">;</span><br>        location  / &#123;<br>                root /usr/share/nginx/html<span class="hljs-comment">;</span><br>                index index.html index.hml<span class="hljs-comment">;</span><br>                deny 192.168.1.8<span class="hljs-comment">;</span><br>                allow all<span class="hljs-comment">;</span><br>                &#125;<br>&#125;<br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># nginx -t</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># nginx -s reload</span><br><br><span class="hljs-comment">#需要注意:</span><br>1.按顺序匹配，已经被匹配的ip或者网段，后面不再被匹配。<br>2.如果先允许所有ip访问，在定义拒绝访问。那么拒绝访问不生效。<br>3.默认为allow all<br></code></pre></td></tr></table></figure><p>示例二</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 拒绝所有请求登入</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># vim /etc/nginx/conf.d/access_mod.conf</span><br>server &#123;<br>        listen 80<span class="hljs-comment">;</span><br>        server_name localhost<span class="hljs-comment">;</span><br>        location  / &#123;<br>                root /usr/share/nginx/html<span class="hljs-comment">;</span><br>                index index.html index.hml<span class="hljs-comment">;</span><br>                deny all<span class="hljs-comment">;    #拒绝所有</span><br>                &#125;<br>&#125;<br><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># nginx -t</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># nginx -s reload</span><br></code></pre></td></tr></table></figure><p>2、基于用户的信任登录</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 语法</span><br>Syntax：auth_basic string | off<span class="hljs-comment">;</span><br>default：auth_basic off<span class="hljs-comment">;</span><br>Context：http，server，location<br><br>Syntax：auth_basic_user_file file<span class="hljs-comment">;</span><br>default：默认无<br>Context：http，server，location<br>file：存储用户名密码信息的文件。<br></code></pre></td></tr></table></figure><p>示例一</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># vim /etc/nginx/conf.d/auth_mod.conf </span><br>server &#123;<br>listen 80<span class="hljs-comment">;</span><br>server_name localhost<span class="hljs-comment">;</span><br>location ~ /admin &#123;<br>root /var/www/html<span class="hljs-comment">;</span><br>index index.html index.hml<span class="hljs-comment">;</span><br>auth_basic &quot;Auth access test!&quot;<span class="hljs-comment">;</span><br>auth_basic_user_file /etc/nginx/auth_conf<span class="hljs-comment">;</span><br>&#125;<br>&#125;<br><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># nginx -t</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># nginx -s reload</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># mkdir /var/www/html    #创建目录</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># vim /var/www/html/index.html    #创建文件</span><br></code></pre></td></tr></table></figure><p><code>auth_basic</code>不为<code>off</code>，开启登录验证功能，</p><p><code>auth_basic_user_file</code>加载账号密码文件。</p><p>3、建立口令文件</p><p><code>登入需要密码</code></p><p>示例一</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># yum install -y httpd-tools #htpasswd 是开源 http 服务器 apache httpd 的一个命令工具，用于生成 http 基本认证的密码文件</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># htpasswd -cm /etc/nginx/auth_conf user10 # -c 创建解密文件，-m MD5加密</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># htpasswd -m /etc/nginx/auth_conf user20</span><br><span class="hljs-section">[root@192 ~]</span><span class="hljs-comment"># cat /etc/nginx/auth_conf </span><br>user10:$apr1$MOa9UVqF$RlYRMk7eprViEpNtDV0n40<br>user20:$apr1$biHJhW03$xboNUJgHME6yDd17gkQNb0<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 变量简介实验</title>
    <link href="/2025/11/06/Nginx-%E5%8F%98%E9%87%8F%E7%AE%80%E4%BB%8B/"/>
    <url>/2025/11/06/Nginx-%E5%8F%98%E9%87%8F%E7%AE%80%E4%BB%8B/</url>
    
    <content type="html"><![CDATA[<h1 id="Nginx-变量"><a href="#Nginx-变量" class="headerlink" title="Nginx 变量"></a>Nginx 变量</h1><p>nginx变量简介</p><ul><li><p>所有的 <code>Nginx</code>变量在<code>Nginx</code>配置文件中引用时都须带上 $ 前缀</p></li><li><p>在 <code>Nginx</code> 配置中，变量只能存放一种类型的值，而且也只存在一种类型，那就是字符串类型</p></li><li><p>所有的变量值都可以通过这种方式引用<code>$变量名</code></p></li></ul><p>nginx中的变量分为两种，自定义变量与内置预定义变量</p><ul><li><p>自定义变量<code>set $变量名 变量值</code></p></li><li><p>内置预定义变量</p></li></ul><p><code>$arg_PARAMETER</code>GET请求中变量名PARAMETER参数的值。  </p><p><code>$args</code>这个变量等于GET请求中的参数。例如，foo&#x3D;123&amp;bar&#x3D;blahblah;这个变量只可以被修改</p><p><code>$binary_remote_addr</code>二进制码形式的客户端地址</p><p><code>$body_bytes_sent</code>传送页面的字节数  </p><p><code>$content_length</code>请求头中的Content-length字段</p><p><code>$content_type</code>请求头中的Content-Type字段</p><p><code>$cookie_COOKIE</code>cookie COOKIE的值</p><p><code>$document_root</code>当前请求在root指令中指定的值</p><p><code>$host</code>请求中的主机头(Host)字段，如果请求中的主机头不可用或者空，则为处理请求的server名称(处理请求的server的server_name指令的值)。值为小写，不包含端口</p><p><code>$hostname</code>机器名使用 gethostname系统调用的值</p><p><code>$limit_rate</code>这个变量可以限制连接速率</p><p><code>$nginx_version</code>当前运行的nginx版本号</p><p><code>$remote_addr</code>客户端的IP地址</p><p><code>$remote_port</code>客户端的端口</p><p><code>$remote_user</code>已经经过Auth Basic Module验证的用户名</p><p><code>$request_filename</code>当前连接请求的文件路径，由root或alias指令与URI请求生成</p><p><code>$request_body</code>这个变量（0.7.58+）包含请求的主要信息。在使用proxy_pass或fastcgi_pass指令的location中比较有意义</p><p><code>$request_body_file</code>客户端请求主体信息的临时文件名</p><p><code>$request_completion</code>如果请求成功，设为”OK”；如果请求未完成或者不是一系列请求中最后一部分则设为空</p><p><code>$request_method</code>这个变量是客户端请求的动作，通常为GET或POST。包括0.8.20及之前的版本中，这个变量总为main request中的动作，如果当前请求是一个子请求，并不使用这个当前请求的动作</p><p><code>$server_addr</code>服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在listen中指定地址并且使用bind参数</p><p><code>$server_name</code>服务器名称</p><p><code>$server_port</code>请求到达服务器的端口号</p><p><code>$server_protocol</code>请求使用的协议，通常是HTTP&#x2F;1.0或HTTP&#x2F;1.1</p><p><code>$uri</code>请求中的当前URI(不带请求参数，参数位于args)，不同于浏览器传递的args)，不同于浏览器传递的args)，不同于浏览器传递的request_uri的值，它可以通过内部重定向，或者使用index指令进行修改。不包括协议和主机名，例如&#x2F;foo&#x2F;bar.html</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx 监控控制实验</title>
    <link href="/2025/11/06/Nginx-%E7%9B%91%E6%8E%A7%E6%8E%A7%E5%88%B6/"/>
    <url>/2025/11/06/Nginx-%E7%9B%91%E6%8E%A7%E6%8E%A7%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="Nginx-监控"><a href="#Nginx-监控" class="headerlink" title="Nginx 监控"></a>Nginx 监控</h1><p><code>nginx 提供了 ngx_http_stub_status_module.这个模块提供了基本的监控功能</code></p><h1 id="nginx的基础监控"><a href="#nginx的基础监控" class="headerlink" title="nginx的基础监控"></a>nginx的基础监控</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini">- 进程监控<br>- 端口监控<br></code></pre></td></tr></table></figure><h1 id="监控的指标"><a href="#监控的指标" class="headerlink" title="监控的指标"></a>监控的指标</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">Accepts（接受）、Handled（已处理）、Requests（请求数）是一直在增加的计数器。Active（活跃）、Waiting（等待）、Reading（读）、Writing（写）随着请求量而增减<br></code></pre></td></tr></table></figure><h1 id="nginx-Stub-Status-监控模块安装"><a href="#nginx-Stub-Status-监控模块安装" class="headerlink" title="nginx Stub Status 监控模块安装"></a>nginx Stub Status 监控模块安装</h1><h1 id="先使用命令查看是否已经安装这个模块"><a href="#先使用命令查看是否已经安装这个模块" class="headerlink" title="先使用命令查看是否已经安装这个模块"></a>先使用命令查看是否已经安装这个模块</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># -V大写会显示版本号和模块等信息、v小写仅显示版本信息</span><br><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># nginx -V</span><br></code></pre></td></tr></table></figure><h1 id="如果没有此模块，需要重新安装，编译命令如下"><a href="#如果没有此模块，需要重新安装，编译命令如下" class="headerlink" title="如果没有此模块，需要重新安装，编译命令如下"></a>如果没有此模块，需要重新安装，编译命令如下</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 添加--with-http_stub_status_module模块</span><br><br>./configure <span class="hljs-attr">--prefix</span>=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=<span class="hljs-string">&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#x27;</span> --with-ld-opt=<span class="hljs-string">&#x27;-Wl,-z,relro -Wl,-z,now -pie&#x27;</span> --add-module=/root/nginx-sticky-module-ng --with-http_stub_status_module<br></code></pre></td></tr></table></figure><h1 id="在配置文件里添加"><a href="#在配置文件里添加" class="headerlink" title="在配置文件里添加"></a>在配置文件里添加</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># vim /etc/nginx/conf.d/status.conf </span><br>server &#123;<br>        listen 80<span class="hljs-comment">;</span><br>        server_name localhost<span class="hljs-comment">;</span><br>        location /nginx-status &#123;<br>                stub_status     on<span class="hljs-comment">;</span><br>                access_log      on<span class="hljs-comment">;</span><br>                &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="nginx-状态查看"><a href="#nginx-状态查看" class="headerlink" title="nginx 状态查看"></a>nginx 状态查看</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini">配置完成后在浏览器中输入http://10.0.105.207/nginx-status 查看显示信息如下<br><br>Active connections: 2 <br>server accepts handled requests<br> 26 26 48 <br>Reading: 0 Writing: 1 Waiting: 1<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>安装Tomcat、JDK（java）实验</title>
    <link href="/2025/11/06/%E5%AE%89%E8%A3%85Tomcat%E3%80%81JDK%EF%BC%88java%EF%BC%89/"/>
    <url>/2025/11/06/%E5%AE%89%E8%A3%85Tomcat%E3%80%81JDK%EF%BC%88java%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h3 id="1、安装JDK"><a href="#1、安装JDK" class="headerlink" title="1、安装JDK"></a>1、安装JDK</h3><p>上传jdk1.8到服务器，安装jdk</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@java</span>-tomcat1 ~]<span class="hljs-meta"># tar xzf jdk-8u191-linux-x64.tar.gz -C /usr/local/</span><br>[root<span class="hljs-symbol">@java</span>-tomcat1 ~]<span class="hljs-meta"># cd /usr/local/</span><br>[root<span class="hljs-symbol">@java</span>-tomcat1 <span class="hljs-keyword">local</span>]<span class="hljs-meta"># mv jdk1.8.0_191/ java</span><br></code></pre></td></tr></table></figure><p>设置环境变量:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@java-tomcat1 <span class="hljs-built_in">local</span>]# vim /etc/profile<br>JAVA_HOME=/usr/local/java <span class="hljs-comment">#指定java安装目录</span><br>PATH=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span> <span class="hljs-comment">#用于指定java系统查找命令的路径</span><br><span class="hljs-built_in">export</span> JAVA_HOME PATH <span class="hljs-comment">#类的路径，在编译运行java程序时，如果有调用到其他类的时候，在classpath中寻找需要的类。</span><br></code></pre></td></tr></table></figure><p>检测JDK是否安装成功:</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">[root@<span class="hljs-keyword">java-tomcat1 </span>local]<span class="hljs-comment"># source /etc/profile</span><br>[root@<span class="hljs-keyword">java-tomcat1 </span>local]<span class="hljs-comment"># java -version </span><br><span class="hljs-keyword">java </span>version <span class="hljs-string">&quot;1.8.0_191&quot;</span><br><span class="hljs-keyword">Java(TM) </span>SE Runtime Environment (<span class="hljs-keyword">build </span><span class="hljs-number">1</span>.<span class="hljs-number">8</span>.<span class="hljs-number">0</span>_191-<span class="hljs-keyword">b12)</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">Java </span>HotSpot(TM) <span class="hljs-number">64</span>-<span class="hljs-keyword">Bit </span>Server VM (<span class="hljs-keyword">build </span><span class="hljs-number">25</span>.<span class="hljs-number">191</span>-<span class="hljs-keyword">b12, </span>mixed mode)<br></code></pre></td></tr></table></figure><h4 id="安装Tomcat"><a href="#安装Tomcat" class="headerlink" title="安装Tomcat"></a>安装Tomcat</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@java-tomcat1 ~]</span><span class="hljs-comment"># mkdir /data/application -p</span><br><span class="hljs-section">[root@java-tomcat1 ~]</span><span class="hljs-comment"># cd /usr/src/</span><br><span class="hljs-section">[root@java-tomcat1 src]</span><span class="hljs-comment"># wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.42/bin/apache-tomcat-8.5.42.tar.gz</span><br><span class="hljs-section">[root@java-tomcat1 src]</span><span class="hljs-comment"># tar xzf apache-tomcat-8.5.42.tar.gz -C /data/application/</span><br><span class="hljs-section">[root@java-tomcat1 src]</span><span class="hljs-comment"># cd /data/application/</span><br><span class="hljs-section">[root@java-tomcat1 application]</span><span class="hljs-comment"># mv apache-tomcat-8.5.42/ tomcat</span><br></code></pre></td></tr></table></figure><p>设置环境变量:</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs applescript">[root@java-tomcat1 <span class="hljs-built_in">application</span>]<span class="hljs-comment"># vim /etc/profile</span><br>export TOMCAT_HOME=/data/<span class="hljs-built_in">application</span>/tomcat   <span class="hljs-comment">#指定tomcat的安装目录</span><br>[root@java-tomcat1 <span class="hljs-built_in">application</span>]<span class="hljs-comment"># source  /etc/profile</span><br></code></pre></td></tr></table></figure><p>查看tomcat是否安装成功:</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nix">[root@java-tomcat1 tomcat]<span class="hljs-comment"># /data/application/tomcat/bin/startup.sh或 /data/application/tomcat/bin/version.sh</span><br>Using <span class="hljs-params">CATALINA_BASE:</span>   <span class="hljs-symbol">/data/application/tomcat</span><br>Using <span class="hljs-params">CATALINA_HOME:</span>   <span class="hljs-symbol">/data/application/tomcat</span><br>Using <span class="hljs-params">CATALINA_TMPDIR:</span> <span class="hljs-symbol">/data/application/tomcat/temp</span><br>Using <span class="hljs-params">JRE_HOME:</span>        <span class="hljs-symbol">/usr/local/java</span><br>Using <span class="hljs-params">CLASSPATH:</span>       <span class="hljs-operator">/</span>data<span class="hljs-operator">/</span>application<span class="hljs-operator">/</span>tomcat<span class="hljs-operator">/</span>bin<span class="hljs-operator">/</span>bootstrap.jar:<span class="hljs-symbol">/data/application/tomcat/bin/tomcat-juli.jar</span><br>Server <span class="hljs-params">version:</span> Apache Tomcat<span class="hljs-symbol">/8.5.42</span><br>Server <span class="hljs-params">built:</span>   Jun <span class="hljs-number">4</span> <span class="hljs-number">2019</span> <span class="hljs-number">20</span>:<span class="hljs-number">29</span>:<span class="hljs-number">04</span> UTC<br>Server <span class="hljs-params">number:</span>  <span class="hljs-number">8.5</span>.<span class="hljs-number">42.0</span><br>OS <span class="hljs-params">Name:</span>        Linux<br>OS <span class="hljs-params">Version:</span>     <span class="hljs-number">3.10</span>.<span class="hljs-number">0</span><span class="hljs-operator">-</span><span class="hljs-number">693</span>.el7.x86_64<br><span class="hljs-params">Architecture:</span>   amd64<br>JVM <span class="hljs-params">Version:</span>    <span class="hljs-number">1.8</span>.<span class="hljs-number">0</span>_191-b12<br>JVM <span class="hljs-params">Vendor:</span>     Oracle Corporation<br></code></pre></td></tr></table></figure><p>测试<br><code>游览器输入IP地址，出现Tomcat测试页面代表完成</code></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>4层--DR模式--负载均衡实验</title>
    <link href="/2025/11/06/4%E5%B1%82-DR%E6%A8%A1%E5%BC%8F-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    <url>/2025/11/06/4%E5%B1%82-DR%E6%A8%A1%E5%BC%8F-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</url>
    
    <content type="html"><![CDATA[<p>环境准备</p><p><code>准备3台纯洁的虚拟机，2台web服务器</code></p><p>安装lvs管理软件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y install ipvsadm<br></code></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini">程序包：ipvsadm（LVS管理工具）<br><br>主程序：/usr/sbin/ipvsadm<br><br>规则保存工具：/usr/sbin/ipvsadm-save  &gt; /path/to/file<br><br>配置文件：/etc/sysconfig/ipvsadm-config<br></code></pre></td></tr></table></figure><p>LVS&#x2F;DR 模式</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">DR模式的组网要求LVS和Real server在同一网段二层互通。因为LVS DR模式在负载均衡转发报文时，只修改目的mac为real server的mac，lvs要能将报文转发给real server，就必须满足LVS和real server是同网段二层互通。<br></code></pre></td></tr></table></figure><p>实验说明：<br><code>1.网络使用NAT模式</code><br><code>2.DR模式要求Director DIP 和 所有RealServer RIP必须在同一个网段及广播域</code></p><p>1、关闭防火墙</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@lvs-server ~]# systemctl stop firewalld<br>[root@lvs-server ~]# setenforce 0<br></code></pre></td></tr></table></figure><p>2、负载均衡器的配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@lvs-server ~]# ip addr add dev ens33 192.168.246.160/32 #设置VIP<br>[root@lvs-server ~]# yum install -y ipvsadm   #RHEL确保LoadBalancer仓库可用<br>[root@lvs-server ~]# service ipvsadm start  #启动<br>注意:启动如果报错: /bin/bash: /etc/sysconfig/ipvsadm: 没有那个文件或目录<br>需要手动生成文件<br>[root@lvs-server ~]# ipvsadm --save &gt; /etc/sysconfig/ipvsadm<br><br>为什么RS上lo配置的VIP掩码为32位<br>这是由于lo设备的特殊性导致， 如果lo绑定VIP/24，则该设备会响应该网段所有IP(192.168.246.0-254)的请求，而不是只响应192.168.246.160这一个地址。,就算是不设置为32也是可以的，只不过会影响访问<br></code></pre></td></tr></table></figure><p>定义LVS分发策略</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">-A：添加VIP<br>-t：用的是tcp协议<br>-a：添加的是lo的vip地址<br>-r：转发到real-serve rip<br>-s：算法<br>-L|-l –list #显示内核虚拟服务器表<br>--numeric, -n：#以数字形式输出地址和端口号<br>-g --gatewaying #指定LVS工作模式为直接路由器模式（也是LVS默认的模式）<br>-S -save #保存虚拟服务器规则到标准输出，输出为-R 选项可读的格式<br>rr：轮循<br>如果添加ip错了，删除命令如下:<br><span class="hljs-meta prompt_"># </span><span class="language-bash">ip addr del 192.168.246.193 dev ens33</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@lvs-server ~]# ipvsadm -C  #清除内核虚拟服务器表中的所有记录。<br>[root@lvs-server ~]# ipvsadm -A -t 192.168.246.160:80 -s rr <br>[root@lvs-server ~]# ipvsadm -a -t 192.168.246.160:80 -r 192.168.246.161 -g<br>[root@lvs-server ~]# ipvsadm -a -t 192.168.246.160:80 -r 192.168.246.162 -g <br>[root@lvs-server ~]# service ipvsadm save #保存方式一，使用下面的保存方式，版本7已经不支持了<br>[root@lvs-server ~]# ipvsadm -S &gt; /etc/sysconfig/ipvsadm  #保存方式二，保存到一个文件中<br>[root@lvs-server ~]# ipvsadm -ln<br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br>TCP  192.168.246.160:80 rr<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">192.168.246.161:80           Route   1      0          0</span>         <br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">192.168.246.162:80           Route   1      0          0</span>         <br>[root@lvs-server ~]# ipvsadm -L -n<br></code></pre></td></tr></table></figure><p>3、配置RS后端机器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@real-server1 ~]# yum install -y nginx<br>[root@real-server1 ~]# echo &quot;real-server1&quot; &gt;&gt; /usr/share/nginx/html/index.html<br>两台机器都安装，按顺序添加不同的主机名以示区分<br>[root@real-server1 ~]# ip addr add dev lo 192.168.246.160/32   #在lo接口上绑定VIP<br>[root@real-server1 ~]# echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore  #忽略arp广播<br>[root@real-server1 ~]# echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce #匹配精确ip地址回包<br>[root@real-server1 ~]# systemctl start nginx <br>[root@real-server1 ~]# systemctl enable  nginx <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">关闭65秒的控制刷新</span><br>[root@real-server1 ~]# vim /etc/nginx/nginx.conf<br>65--改成--0<br>[root@real-server1 ~]# systemctl restart nginx <br>=============================================================================<br>因为：realServer的vip有了，接着就是同一个网段中拥有两个vip, 客户端在网关发送arp广播需找vip时需要让realServer不接受响应.  <br>解决：<br>echo 1 &gt;/proc/sys/net/ipv4/conf/eth0/arp_ignore <br>arp_ignore 设置为1，意味着当别人的arp请求过来的时候，如果接收的设备没有这个ip，就不做出响应(这个ip在lo上，lo不是接收设备的进口)<br>echo 2 &gt;/proc/sys/net/ipv4/conf/eth0/arp_announce   <br>使用最好的ip来回应，什么是最好的ip？同一个网段内子网掩码最长的<br></code></pre></td></tr></table></figure><p>4、测试</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gradle">测试一<br>在游览器上输入vip地址<br><br>测试二<br>[root@client ~]# elinks -<span class="hljs-keyword">dump</span> http:<span class="hljs-comment">//192.168.246.160</span><br>-<span class="hljs-keyword">dump</span>:非交互式模式<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>RabbiMQ集群部署</title>
    <link href="/2025/11/06/RabbiMQ%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/RabbiMQ%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="普通集群准备环境"><a href="#普通集群准备环境" class="headerlink" title="普通集群准备环境"></a>普通集群准备环境</h3><p><strong>注意，这⾥三台服务器都关闭防火墙和selinux</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">192.168.50.138 rabbitmq-1<br>192.168.50.139rabbitmq-2<br>192.168.50.140rabbitmq-3<br></code></pre></td></tr></table></figure><p>三台机器都操作:</p><h4 id="1、配置hosts⽂件"><a href="#1、配置hosts⽂件" class="headerlink" title="1、配置hosts⽂件"></a>1、配置hosts⽂件</h4><p>更改三台MQ节点的计算机名分别为rabbitmq-1、rabbitmq-2 和rabbitmq-3，然后修改hosts配置⽂件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rabbitmq-1 ~]# vim /etc/hosts<br>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.168.50.138 rabbitmq-1<br>192.168.50.139 rabbitmq-2<br>192.168.50.140 rabbitmq-3<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">主机的名字也要改了，不然后面命令匹配不到</span><br>[root@rabbitmq-1 ~]#//磁盘节点<br>[root@rabbitmq-2 ~]#//内存节点<br>[root@rabbitmq-3 ~]#//内存节点<br></code></pre></td></tr></table></figure><h4 id="2、三个节点配置安装rabbitmq软件"><a href="#2、三个节点配置安装rabbitmq软件" class="headerlink" title="2、三个节点配置安装rabbitmq软件"></a>2、三个节点配置安装rabbitmq软件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell">安装依赖<br>[root@rabbitmq-1 ~]# yum install -y *epel* gcc-c++ unixODBC unixODBC-devel openssl-devel ncurses-devel<br>yum安装erlang<br>[root@rabbitmq-1 ~]# curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | sudo bash<br>[root@rabbitmq-1 ~]# yum install erlang-21.3.8.21-1.el7.x86_64<br>测试；<br>[root@rabbitmq-1 ~]# erl<br>Erlang/OTP 20 [erts-9.3] [source] [64-bit] [smp:1:1] [ds:1:1:10] [async-threads:10] [hipe] [kernel-poll:false]<br><br>Eshell V9.3  (abort with ^G)<br><span class="hljs-meta prompt_">1&gt;</span><span class="language-bash">//这里按两次ctrl+c</span><br><br>安装rabbitmq<br>https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.7.10 ---选择版本<br>下载下来将其上传到服务器中，三台机器相同操作<br>https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.10/rabbitmq-server-3.7.10-1.el7.noarch.rpm//这个包在电脑笔记里有<br><br>[root@rabbitmq-1 ~]# yum install -y rabbitmq-server-3.7.10-1.el7.noarch.rpm<br><br>`注意：erlang 和 rabbitmq 两个版本配置要一样，不然不兼容`<br><span class="hljs-meta prompt_"># </span><span class="language-bash">erlang 版本选择</span><br>https://packagecloud.io/rabbitmq/erlang<br><span class="hljs-meta prompt_"># </span><span class="language-bash">rabbitmq 和erlang兼容版本</span><br>https://www.rabbitmq.com/which-erlang.html<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">需要下载的可以在以上两个网站分别下载，但要选好版本，保证要两个软件兼容</span><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">3.启动方式一：<br>[root@rabbitmq-1 ~]# systemctl daemon-reload<br>[root@rabbitmq-1 ~]# systemctl start rabbitmq-server<br>[root@rabbitmq-1 ~]# systemctl enable rabbitmq-server<br>启动方式二:<br>[root@rabbitmq-1 ~]# /sbin/service rabbitmq-server status  ---查看状态<br>[root@rabbitmq-1 ~]# /sbin/service rabbitmq-server start   ---启动<br>4、每台都操作开启rabbitmq的web访问界面：<br>[root@rabbitmq-1 ~]# rabbitmq-plugins enable rabbitmq_management<br></code></pre></td></tr></table></figure><h4 id="3、创建用户"><a href="#3、创建用户" class="headerlink" title="3、创建用户"></a>3、创建用户</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs shell">注意:在一台机器操作<br>添加用户和密码<br>[root@rabbitmq-1 ~]# rabbitmqctl add_user soho soso<br>Creating user &quot;soho&quot;<br>...done.<br>设置为管理员<br>[root@rabbitmq-1 ~]# rabbitmqctl set_user_tags soho administrator<br>Setting tags for user &quot;soho&quot; to [administrator] ...<br>...done.<br>查看用户<br>[root@rabbitmq-1 ~]# rabbitmqctl list_users<br>Listing users ...<br>guest[administrator]<br>soho[administrator]<br>...done.<br><br>此处设置权限时注意&#x27;.*&#x27;之间需要有空格 三个&#x27;.*&#x27;分别代表了conf权限，read权限与write权限 例如：当没有给<br>soho设置这三个权限前是没有权限查询队列，在ui界面也看不见<br>[root@rabbitmq-1 ~]# rabbitmqctl set_permissions -p &quot;/&quot; soho &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;<br>Setting permissions for user &quot;soho&quot; in vhost &quot;/&quot; ...<br>...done.<br></code></pre></td></tr></table></figure><h4 id="4、所有机器都操作-开启用户远程登录"><a href="#4、所有机器都操作-开启用户远程登录" class="headerlink" title="4、所有机器都操作:开启用户远程登录:"></a>4、所有机器都操作:开启用户远程登录:</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rabbitmq-1 ~]# cd /etc/rabbitmq/<br>[root@rabbitmq-1 rabbitmq]# cp /usr/share/doc/rabbitmq-server-3.7.5/rabbitmq.config.example /etc/rabbitmq/rabbitmq.config<br>[root@rabbitmq-1 rabbitmq]# ls<br>enabled_plugins  rabbitmq.config<br>[root@rabbitmq-1 rabbitmq]# vim rabbitmq.config<br>修改如下:<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># &#123;loopback_users, []&#125;，--&gt; &#123;loopback_users, []&#125;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">把前面的注释去了，另外把最后的逗号去了，保存重启服务</span><br><br>三台机器都操作重启服务服务:<br>[root@rabbitmq-1 ~]# systemctl restart rabbitmq-server<br></code></pre></td></tr></table></figure><h4 id="5、查看端口"><a href="#5、查看端口" class="headerlink" title="5、查看端口"></a>5、查看端口</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">4369 -- erlang端口<br>5672 --程序连接端口<br>15672 -- 管理界面ui端口<br>25672 -- server间内部通信口<br></code></pre></td></tr></table></figure><p><strong>！注意如果是云服务器，切记添加安全组端口放行。</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">输入网址访问</span><br>访问:192.168.50.138:15672<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">用户名和密码</span><br>默认的是：guest密码：guest<br>新添加的用户为:soho 密码:soso<br></code></pre></td></tr></table></figure><h3 id="开始部署集群三台机器都操作"><a href="#开始部署集群三台机器都操作" class="headerlink" title="开始部署集群三台机器都操作"></a>开始部署集群三台机器都操作</h3><h4 id="1-首先创建好数据存放目录和日志存放目录"><a href="#1-首先创建好数据存放目录和日志存放目录" class="headerlink" title="1.首先创建好数据存放目录和日志存放目录:"></a>1.首先创建好数据存放目录和日志存放目录:</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rabbitmq-1 ~]# mkdir -p /data/rabbitmq/data<br>[root@rabbitmq-1 ~]# mkdir -p /data/rabbitmq/logs<br>[root@rabbitmq-1 ~]# chmod 777 -R /data/rabbitmq<br>[root@rabbitmq-1 ~]# chown rabbitmq.rabbitmq /data/ -R<br>创建配置文件:<br>[root@rabbitmq-1 ~]# vim /etc/rabbitmq/rabbitmq-env.conf<br>[root@rabbitmq-1 ~]# cat /etc/rabbitmq/rabbitmq-env.conf<br>RABBITMQ_MNESIA_BASE=/data/rabbitmq/data<br>RABBITMQ_LOG_BASE=/data/rabbitmq/logs<br>重启服务<br>[root@rabbitmq-1 ~]# systemctl restart rabbitmq-server<br></code></pre></td></tr></table></figure><h4 id="2-拷⻉-erlang-cookie—-覆盖"><a href="#2-拷⻉-erlang-cookie—-覆盖" class="headerlink" title="2.拷⻉.erlang.cookie—-覆盖"></a>2.拷⻉.erlang.cookie—-覆盖</h4><p>Rabbitmq的集群是依附于erlang的集群来⼯作的,所以必须先构建起erlang的集群景象。Erlang的集群中</p><p>各节点是经由⼀个cookie来实现的,这个cookie存放在&#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie中，⽂件是400的权限。所以必须保证各节点cookie⼀致,不然节点之间就⽆法通信.</p><p>如果执行# rabbitmqctl stop_app 这条命令报错:需要执行</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">如果执行# rabbitmqctl stop_app 这条命令报错:需要执行</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">chmod</span> 400 .erlang.cookie</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">chown</span> rabbitmq.rabbitmq .erlang.cookie</span><br></code></pre></td></tr></table></figure><p>(官方在介绍集群的文档中提到过.erlang.cookie 一般会存在这两个地址：第一个是home&#x2F;.erlang.cookie；第二个地方就是&#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie。如果我们使用解压缩方式安装部署的rabbitmq，那么这个文件会在{home}目录下，也就是$home&#x2F;.erlang.cookie。如果我们使用rpm等安装包方式进行安装的，那么这个文件会在&#x2F;var&#x2F;lib&#x2F;rabbitmq目录下。)</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">覆盖副节点的cookie</span><br>[root@rabbitmq-1 ~]# cat /var/lib/rabbitmq/.erlang.cookie<br>HOUCUGJDZYTFZDSWXTHJ<br>⽤scp的⽅式将rabbitmq-1节点的.erlang.cookie的值复制到其他两个节点中。<br>[root@rabbitmq-1 ~]# scp /var/lib/rabbitmq/.erlang.cookie root@192.168.50.139:/var/lib/rabbitmq/<br>[root@rabbitmq-1 ~]# scp /var/lib/rabbitmq/.erlang.cookie root@192.168.50.140:/var/lib/rabbitmq/<br></code></pre></td></tr></table></figure><h4 id="3-将mq-2、mq-3作为内存节点加⼊mq-1节点集群中"><a href="#3-将mq-2、mq-3作为内存节点加⼊mq-1节点集群中" class="headerlink" title="3.将mq-2、mq-3作为内存节点加⼊mq-1节点集群中"></a>3.将mq-2、mq-3作为内存节点加⼊mq-1节点集群中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">停止stop_app会报错,在则之前查看下进程，杀死进程，重新启动服务</span><br>ps -ef |grep rabbitmq//查看进程号<br>kill -9 [进程名]<br>systemctl start rabbitmq-server<br><br>在mq-2、mq-3执⾏如下命令：<br>[root@rabbitmq-2 ~]# rabbitmqctl stop_app  #停止节点，切记不是停止服务---需要杀进程重新启动<br>[root@rabbitmq-2 ~]# rabbitmqctl reset   #如果有数据需要重置，没有则不用<br>[root@rabbitmq-2 ~]# rabbitmqctl join_cluster --ram rabbit@rabbitmq-1  #添加到磁盘节点<br>Clustering node &#x27;rabbit@rabbitmq-2&#x27; with &#x27;rabbit@rabbitmq-1&#x27; ...<br>[root@rabbitmq-2 ~]# rabbitmqctl start_app  #启动节点<br>Starting node &#x27;rabbit@rabbitmq-2&#x27; ...<br>======================================================================<br>[root@rabbitmq-3 ~]# rabbitmqctl stop_app<br>Stopping node &#x27;rabbit@rabbitmq-3&#x27; ...<br>[root@rabbitmq-3 ~]# rabbitmqctl reset<br>Resetting node &#x27;rabbit@rabbitmq-3&#x27; ...<br>[root@rabbitmq-3 ~]# rabbitmqctl join_cluster --ram rabbit@rabbitmq-1<br>Clustering node &#x27;rabbit@rabbitmq-3&#x27; with &#x27;rabbit@rabbitmq-1&#x27; ...<br>[root@rabbitmq-3 ~]# rabbitmqctl start_app<br>Starting node &#x27;rabbit@rabbitmq-3&#x27; ...<br><br>（1）默认rabbitmq启动后是磁盘节点，在这个cluster命令下，mq-2和mq-3是内存节点，<br>mq-1是磁盘节点。<br>（2）如果要使mq-2、mq-3都是磁盘节点，去掉--ram参数即可。<br>（3）如果想要更改节点类型，可以使⽤命令rabbitmqctl change_cluster_node_type<br>disc(ram),前提是必须停掉rabbit应⽤<br>注:<br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果有需要使用磁盘节点加入集群</span><br> [root@rabbitmq-2 ~]# rabbitmqctl join_cluster  rabbit@rabbitmq-1<br> [root@rabbitmq-3 ~]# rabbitmqctl join_cluster  rabbit@rabbitmq-1<br></code></pre></td></tr></table></figure><h4 id="4、查看集群状态"><a href="#4、查看集群状态" class="headerlink" title="4、查看集群状态"></a>4、查看集群状态</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">在 RabbitMQ 集群任意节点上执行 rabbitmqctl cluster_status来查看是否集群配置成功。<br>在mq-1磁盘节点上面查看<br>[root@rabbitmq-1 ~]# rabbitmqctl cluster_status<br></code></pre></td></tr></table></figure><h4 id="5-登录rabbitmq-web管理控制台，创建新的队列"><a href="#5-登录rabbitmq-web管理控制台，创建新的队列" class="headerlink" title="5.登录rabbitmq web管理控制台，创建新的队列"></a>5.登录rabbitmq web管理控制台，创建新的队列</h4><p>打开浏览器输⼊<a href="http://192.168.50.138:15672/">http://192.168.50.138:15672</a>, 输⼊默认的Username：guest，输⼊默认的</p><p>Password:guest </p><h3 id="RabbitMQ镜像集群配置"><a href="#RabbitMQ镜像集群配置" class="headerlink" title="RabbitMQ镜像集群配置"></a>RabbitMQ镜像集群配置</h3><p><strong>创建镜像集群</strong></p><p>rabbitmq set_policy ：设置策略</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@rabbitmq-1 ~]# rabbitmqctl set_policy  ha-all &quot;^&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;<br>Setting policy &quot;ha-all&quot; for pattern &quot;^&quot; to &quot;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&quot; with priority &quot;0&quot; for vhost &quot;/&quot; ...<br><br>[root@rabbitmq-1 ~]# rabbitmqctl set_policy  ha-all(策略名) &quot;^(队列名)&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;<br>[root@rabbitmq-1 ~]# rabbitmqctl set_policy  ha-all-1(策略名) &quot;^(队列名)&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;<br>[root@rabbitmq-1 ~]# rabbitmqctl set_policy -p xu ha-all-1(策略名) &quot;^(队列名)&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;<br><br>set_policy指定策略<br>-p 指定虚拟主机名<br>ha-all策略名<br>^队列名<br></code></pre></td></tr></table></figure><p><strong>“^”匹配所有的队列，策略名称为ha-all, ‘{“ha-mode”:”all”}’ 策略模式为 all 即复制到所有节点，包含新增节点。</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">设置策略介绍:<br>rabbitmqctl set_policy [-p Vhost] Name Pattern Definition<br>-p Vhost： 可选参数，针对指定vhost下的queue进行设置<br>Name: policy的名称，可以定义<br>Pattern: queue的匹配模式(正则表达式),也就是说会匹配一组。<br>Definition：镜像定义，包括ha-mode,ha-params,ha-sync-mode<br>    ha-mode:指明镜像队列的模式<br>        all：表示在集群中所有的节点上进行镜像<br>        exactly：表示在指定个数的节点上进行镜像，节点的个数由ha-params指定<br>    ha-sync-mode：进行队列中消息的同步方式，有效值为automatic和manual<br>    ha-params：ha-mode模式需要用到的参数<br>案例:<br>例如，对队列名称以hello开头的所有队列进行镜像，并在集群的两个节点上完成镜像，policy的设置命令为： <br>rabbitmqctl set_policy hello-ha “^hello” ‘&#123;“ha-mode”:”exactly”,”ha-params”:2,”ha-sync-mode”:”automatic”&#125;’<br></code></pre></td></tr></table></figure><p>则此时镜像队列设置成功。已经部署完成</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>负载高可用实验</title>
    <link href="/2025/11/06/%E8%B4%9F%E8%BD%BD%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%9E%E9%AA%8C/"/>
    <url>/2025/11/06/%E8%B4%9F%E8%BD%BD%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%9E%E9%AA%8C/</url>
    
    <content type="html"><![CDATA[<p><a href="http://xbd666.cn/">清风</a><br><img src="https://xbd666.cn/upload/%E9%AB%98%E5%8F%AF%E7%94%A801.png" alt="高可用01.png"></p><h1 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl stop firewalld<br>systemctl disable firewalld<br>setenforce 0<br></code></pre></td></tr></table></figure><h1 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# vim /etc/hosts<br>192.168.116.121 tomcat  安装tomcat<br>192.168.116.122 php     安装php-fpm、nginx<br>192.168.116.131 nginx1  安装nginx<br>192.168.116.132 nginx2  安装nginx<br>192.168.116.111 master  安装lvs、keepalived<br>192.168.116.156 backup  安装lvs、keepalived``<br></code></pre></td></tr></table></figure><h1 id="1、安装tomcat步骤–192-168-116-121"><a href="#1、安装tomcat步骤–192-168-116-121" class="headerlink" title="1、安装tomcat步骤–192.168.116.121"></a>1、安装tomcat步骤–192.168.116.121</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs shell">1、安装 JDK（java）<br>1.上传jdk到服务器中，安装jdk<br>[root@localhost ~]# mkdir /application   #创建工作目录<br>[root@localhost ~]# tar xzf jdk-8u60-linux-x64.tar.gz -C /application/<br>[root@localhost ~]# mv /application/jdk1.8.0_60 /application/jdk<br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置环境变量</span><br>[root@localhost ~]# vim /etc/profile<br>JAVA_HOME=/usr/local/java #指定java安装目录<br>PATH=$JAVA_HOME/bin:$PATH #用于指定java系统查找命令的路径<br>export JAVA_HOME PATH #类的路径，在编译运行java程序时，如果有调用到其他类的时候，在classpath中寻找需要的类。<br>[root@localhost ~]# source /etc/profile  #让环境变量生效<br><span class="hljs-meta prompt_">#</span><span class="language-bash">测试jdk是否安装成功</span><br>[root@localhost ~]# java -version<br>java version &quot;1.8.0_60&quot;<br>Java(TM) SE Runtime Environment (build 1.8.0_60-b27)<br>Java HotSpot(TM) 64-Bit Server VM (build 25.60-b23, mixed mode)<br><br>2、安装Tomcat<br>将tomcat安装包上传到服务器中：<br>[root@localhost ~]# tar xzf apache-tomcat-8.0.27.tar.gz -C /application/<br>[root@localhost ~]# mv /application/apache-tomcat-8.0.27 /application/tomcat<br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置环境变量</span><br>[root@localhost ~]# echo &#x27;export TOMCAT_HOME=/application/tomcat&#x27;&gt;&gt;/etc/profile<br>[root@localhost ~]# source /etc/profile<br>启动tomcat<br>[root@localhost ~]# /application/tomcat/bin/startup.sh<br></code></pre></td></tr></table></figure><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">网址输入192.168.116.121：8080，会出来tomcat测试页面192.168.116.121的tomcat的测试页面<br></code></pre></td></tr></table></figure><h1 id="2、安装php-fpm-nginx–步骤–192-168-116-122"><a href="#2、安装php-fpm-nginx–步骤–192-168-116-122" class="headerlink" title="2、安装php-fpm&#x2F;nginx–步骤–192.168.116.122"></a>2、安装php-fpm&#x2F;nginx–步骤–192.168.116.122</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">下载nginx</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">yum安装nginx</span><br>[root@localhost ~]#  vim /etc/yum.repo.d/nginx.repo<br>[nginx-stable]<br>name=nginx stable repo<br>baseurl=http://nginx.org/packages/centos/$releasever/$basearch/<br>gpgcheck=0<br>enabled=1<br>[root@localhost ~]#  yum install nginx -y<br>[root@localhost ~]#  systemctl start nginx<br>[root@localhost ~]#  systemctl enable nginx<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载PHP</span><br>[root@localhost ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/epel-release.rpm<br>[root@localhost ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm<br>[root@localhost ~]#  yum install php71w-xsl php71w <br>[root@localhost ~]#  yum -y install php71w-xsl php71w php71w-ldap php71w-cli php71w-common php71w-devel php71w-gd php71w-pdo php71w-mysql php71w-mbstring php71w-bcmath php71w-mcrypt//php依赖包<br>[root@localhost ~]#  yum install -y php71w-fpm//php主包<br>[root@localhost ~]#  systemctl start php-fpm<br>[root@localhost ~]#  systemctl enable php-fpm<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">验证nginx/php-fpm有没有起来</span><br>[root@localhost ~]#  systemctl status nginx<br>[root@localhost ~]#  systemctl status php-fpm<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">编辑配置文件</span><br>vim /etc/nginx/conf.d/php.conf<br>server &#123;<br>        listen      80;<br>        server_name     localhost;<br>      location ~ \.php$ &#123;<br>            root       /usr/share/nginx/html;  #指定网站目录<br>            fastcgi_pass   127.0.0.1:9000;    #开启fastcgi连接php地址<br>            fastcgi_index  index.php;#指定默认文件<br>            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name; #站点根目录，取决于root配置项<br>            include        fastcgi_params;  #包含fastcgi使用的常量<br>        &#125;<br>        &#125;<br>        <br>[root@localhost ~]#  vim /usr/share/nginx/html/test.php<br>&lt;?php<br> phpinfo();<br>?&gt;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启nginx</span><br>[root@localhost ~]#  systemctl restart nginx<br></code></pre></td></tr></table></figure><h1 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">输入网址192.168.116.122/test.php//会出来php的测试页面<br></code></pre></td></tr></table></figure><h1 id="3、安装nginx步骤–192-168-116-131"><a href="#3、安装nginx步骤–192-168-116-131" class="headerlink" title="3、安装nginx步骤–192.168.116.131"></a>3、安装nginx步骤–192.168.116.131</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">yum安装nginx--代理tomcat</span><br>[root@localhost ~]#  vim /etc/yum.repo.d/nginx.repo<br>[nginx-stable]<br>name=nginx stable repo<br>baseurl=http://nginx.org/packages/centos/$releasever/$basearch/<br>gpgcheck=0<br>enabled=1<br>[root@localhost ~]#  yum install nginx -y<br>[root@localhost ~]#  systemctl start nginx<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置负载均衡</span><br>[root@localhost ~]#  vim /etc/nginx/conf.d/upstream.conf<br>upstream tomcat01 &#123;<br>      server 192.168.116.121:8080;<br>      server 192.168.116.122;<br>    &#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置代理</span><br>[root@localhost ~]#  vim /etc/nginx/conf.d/tomcat_01.conf<br>server &#123;<br>        listen       80;<br>        server_name localhost;<br><br>        #access_log  logs/host.access.log  main;<br><br>        location / &#123;<br>            proxy_pass http://tomcat01;<br>            proxy_set_header Host $host:$server_port;<br>            proxy_set_header X-Real-IP $remote_addr;<br>            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>        &#125;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启nginx</span><br>systemctl restart nginx<br></code></pre></td></tr></table></figure><h1 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">输入网址192.168.116.131  //会出来192.168.116.(121/122)的页面<br></code></pre></td></tr></table></figure><h1 id="4、安装nginx步骤–192-168-116-132"><a href="#4、安装nginx步骤–192-168-116-132" class="headerlink" title="4、安装nginx步骤–192.168.116.132"></a>4、安装nginx步骤–192.168.116.132</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">yum安装nginx--代理php</span><br>[root@localhost ~]#  vim /etc/yum.repo.d/nginx.repo<br>[nginx-stable]<br>name=nginx stable repo<br>baseurl=http://nginx.org/packages/centos/$releasever/$basearch/<br>gpgcheck=0<br>enabled=1<br>[root@localhost ~]#  yum install nginx -y<br>[root@localhost ~]#  systemctl start nginx<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">负载均衡192.168.116.122</span><br>vim /etc/nginx/conf.d/upstream.conf<br>upstream php01 &#123;<br>      server 192.168.116.121:8080;<br>      server 192.168.116.122;<br>    &#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">代理配置</span><br>vim /etc/nginx/conf.d/php_01.conf<br>server &#123;<br>     listen      80;<br>     server_name     localhost;<br><br>     location / &#123;<br>            proxy_pass http://php01;<br>            proxy_set_header Host $host:$server_port;<br>            proxy_set_header X-Real-IP $remote_addr;<br>            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>      &#125;<br>&#125;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启nginx</span><br>systemctl restart nginx<br></code></pre></td></tr></table></figure><h1 id="测试-3"><a href="#测试-3" class="headerlink" title="测试"></a>测试</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">输入网址192.168.116.132//会出来192.168.116.(121/122)的页面<br></code></pre></td></tr></table></figure><h1 id="5、配置（lvs–keepalived-–192-168-116-111-MASTER"><a href="#5、配置（lvs–keepalived-–192-168-116-111-MASTER" class="headerlink" title="5、配置（lvs–keepalived)–192.168.116.111(MASTER)"></a>5、配置（lvs–keepalived)–192.168.116.111(MASTER)</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs shell">1. 主/备调度器安装软件<br>[root@lvs-keepalived-master ~]# yum -y install ipvsadm keepalived <br><br>2、配置keepalived,conf配置文件<br>lvs-master<br>[root@ha-proxy-master ~]# vim /etc/keepalived/keepalived.conf<br>! Configuration File for keepalived<br><br>global_defs &#123;<br>   router_id lvs-keepalived-master    #辅助改为lvs-backup<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state MASTER（修改的）<br>    interface ens33（修改的）                #VIP绑定接口<br>    virtual_router_id 80         #VRID 同一组集群，主备一致          <br>    priority 100            #本节点优先级，辅助改为50<br>    advert_int 1            #检查间隔，默认为1s<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.246.11/32（修改的）<br>    &#125;<br>&#125;<br><br>virtual_server 192.168.246.11 80 &#123;   （修改的） #LVS配置<br>delay_loop 6   #健康检查rs时间间隔<br>lb_algo rr    （修改的） #LVS调度算法<br>lb_kind DR     （修改的）#LVS集群模式（路由模式）<br>protocol TCP      #健康检查使用的协议<br>real_server 192.168.116.131 80 &#123;（修改的）<br>weight 1<br>inhibit_on_failure   #当该节点失败时，把权重设置为0，而不是从IPVS中删除<br>TCP_CHECK &#123;          #健康检查<br>connect_port 80   #检查的端口<br>connect_timeout 3  #连接超时的时间<br>&#125;<br>&#125;<br>real_server 192.168.116.132 80 &#123;（修改的）<br>weight 1<br>inhibit_on_failure<br>TCP_CHECK &#123;<br>connect_timeout 3<br>connect_port 80<br>&#125;<br>&#125;<br>&#125;<br><br>3. 启动KeepAlived（主备均启动）<br>[root@lvs-keepalived-master ~]# systemctl start keepalived<br>[root@lvs-keepalived-master ~]# systemctl enable keepalived<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看ip</span><br>[root@lvs-keepalived-master ~]# ipvsadm -Ln<br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br>TCP  192.168.246.110:80 rr persistent 20<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">192.168.246.162:80           Route   1      0          0</span>         <br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">192.168.246.163:80           Route   0      0          0</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置rs后端机器配置</span><br>4. 所有RS配置(nginx1,nginx2)<br>配置好网站服务器，测试所有RS<br>[root@test-nginx1 ~]# ip addr add dev lo 192.168.246.11/32<br>[root@test-nginx1 ~]# sysctl -p<br>[root@test-nginx1 ~]# systemctl start nginx<br></code></pre></td></tr></table></figure><h1 id="测试-4"><a href="#测试-4" class="headerlink" title="测试"></a>测试</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">输入网址192.168.116.11//会出来192.168.116.（131/132）的页面<br></code></pre></td></tr></table></figure><h1 id="6、配置（lvs–keepalived-–192-168-116-156（BACKUP）"><a href="#6、配置（lvs–keepalived-–192-168-116-156（BACKUP）" class="headerlink" title="6、配置（lvs–keepalived)–192.168.116.156（BACKUP）"></a>6、配置（lvs–keepalived)–192.168.116.156（BACKUP）</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs shell">1. 主/备调度器安装软件<br>[root@lvs-keepalived-master ~]# yum -y install ipvsadm keepalived <br><br>2、配置keepalived,conf配置文件<br>[root@lvs-keepalived-slave ~]# vim /etc/keepalived/keepalived.conf<br>! Configuration File for keepalived<br><br>global_defs &#123;<br>   router_id lvs-keepalived-slave（修改的）<br>&#125;<br><br>vrrp_instance VI_1 &#123;<br>    state BACKUP（修改的）<br>    interface ens33（修改的）<br>    virtual_router_id 80<br>    priority 50（修改的）<br>    advert_int 1<br>    authentication &#123;<br>        auth_type PASS<br>        auth_pass 1111<br>    &#125;<br>    virtual_ipaddress &#123;<br>        192.168.116.11/32（修改的）<br>    &#125;<br>&#125;<br>virtual_server 192.168.246.11 80 &#123;（修改的）<br>delay_loop 6<br>lb_algo rr（修改的）<br>lb_kind DR（修改的）<br>protocol TCP<br>real_server 192.168.116.131 80 &#123;（修改的）<br>weight 1<br>inhibit_on_failure<br>TCP_CHECK &#123;<br>connect_port 80<br>connect_timeout 3<br>&#125;<br>&#125;<br>real_server 192.168.116.132 80 &#123;（修改的）<br>weight 1<br>inhibit_on_failure<br>TCP_CHECK &#123;<br>connect_timeout 3<br>connect_port 80<br>&#125;<br>&#125;<br><br>3. 启动KeepAlived（主备均启动）<br>[root@lvs-keepalived-master ~]# systemctl start keepalived<br>[root@lvs-keepalived-master ~]# systemctl enable keepalived<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看ip</span><br>[root@lvs-keepalived-master ~]# ipvsadm -Ln<br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br>TCP  192.168.246.110:80 rr persistent 20<br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">192.168.246.162:80           Route   1      0          0</span>         <br><span class="hljs-meta prompt_">  -&gt; </span><span class="language-bash">192.168.246.163:80           Route   0      0          0</span><br><span class="hljs-meta prompt_">  </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置rs后端机器配置</span><br>4. 所有RS配置(nginx1,nginx2)<br>配置好网站服务器，测试所有RS<br>[root@test-nginx1 ~]# ip addr add dev lo 192.168.246.11/32<br>[root@test-nginx1 ~]# sysctl -p<br>[root@test-nginx1 ~]# systemctl start nginx<br></code></pre></td></tr></table></figure><h1 id="测试-5"><a href="#测试-5" class="headerlink" title="测试"></a>测试</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">输入网址192.168.116.11//会出来192.168.116.（131/132）的页面<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>deban12初始化问题、用法</title>
    <link href="/2025/11/06/deban12%E5%88%9D%E5%A7%8B%E5%8C%96%E9%97%AE%E9%A2%98%E3%80%81%E7%94%A8%E6%B3%95/"/>
    <url>/2025/11/06/deban12%E5%88%9D%E5%A7%8B%E5%8C%96%E9%97%AE%E9%A2%98%E3%80%81%E7%94%A8%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="debian和ubuntu本身的vi编辑器是不支持用退格键删除和用上下左右键的"><a href="#debian和ubuntu本身的vi编辑器是不支持用退格键删除和用上下左右键的" class="headerlink" title="debian和ubuntu本身的vi编辑器是不支持用退格键删除和用上下左右键的"></a>debian和ubuntu本身的vi编辑器是不支持用退格键删除和用上下左右键的</h1><p>所以要</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs routeros">vi /etc/vim/vimrc.tiny<br><br>把 <span class="hljs-built_in">set</span> compatible<br><br>修改改为：<span class="hljs-built_in">set</span> nocompatible<br><br>加入一句：<span class="hljs-built_in">set</span> <span class="hljs-attribute">backspace</span>=2<br></code></pre></td></tr></table></figure><h1 id="还有debian和ubuntu用不了ll命令"><a href="#还有debian和ubuntu用不了ll命令" class="headerlink" title="还有debian和ubuntu用不了ll命令"></a>还有debian和ubuntu用不了ll命令</h1><p>直接分别到普通用户的家目录和root用户的家目录</p><p>有个隐藏文件<code>.bashrc</code>在他们的家目录下，root和用户的都要改，因为root和每个普通用户的家目录下都有一个 <code>.bashrc</code>的文件你改那个用户就生效那个</p><p><code>vim  ~/.bashrc </code></p><p>在打开的文件里面加入(你想让什么命令变成什么命令就像这样写就行，而为这里的root用户本身是文件夹不显示颜色的，容易一定要加下面那个让文件夹显示颜色的命令。要添加的命令最好是想要转化成的命令的本身是这个系统没有的;</p><p>比如:debian本身没有ll这个命令的简写那就可以像这样添加)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">alias</span> ll=<span class="hljs-string">&#x27;ls -l&#x27;</span><br><span class="hljs-built_in">alias</span> tailf=<span class="hljs-string">&#x27;tail -f&#x27;</span><br><span class="hljs-built_in">alias</span> <span class="hljs-built_in">dir</span>=<span class="hljs-string">&#x27;dir --color=auto&#x27;</span>（让文件夹显示颜色，这个在linux也可以用你但是这个命令其实是 Windows 系统下的命令别名设置，将 `<span class="hljs-built_in">dir</span>` 命令设置为带颜色输出的别名。但是在 Linux 和 Unix 系统中，也可以使用这个别名命令，因为 Linux 和 Unix 系统的 Bash Shell 也支持 Windows 下的一些命令）<br><span class="hljs-built_in">alias</span> <span class="hljs-built_in">ls</span>=<span class="hljs-string">&#x27;ls --color=auto&#x27;</span>   （让<span class="hljs-built_in">ls</span>命令直接变成 <span class="hljs-built_in">ls</span> --color命令,也是让文件夹显示颜色，但是linux下最好用这个）<br></code></pre></td></tr></table></figure><p>！！！但是有个很重要的问题是改完一定要记得用命令 <code>source  ~/.bashrc</code>来重新加载<code>.bashrc</code>这个文件！！！</p><h1 id="时间问题"><a href="#时间问题" class="headerlink" title="时间问题"></a>时间问题</h1><p>当发现桌面时间是对的时候，但是终端里文件时间不对，说明终端时间和系统默认时间不同，需要修改终端时间</p><p>那么 先 输命令  <code>timedatectl</code>  查看当前终端的时间和时区对不对</p><h1 id="如何取消vim选中文本自动进入可视化模式"><a href="#如何取消vim选中文本自动进入可视化模式" class="headerlink" title="如何取消vim选中文本自动进入可视化模式"></a>如何取消vim选中文本自动进入可视化模式</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cd</span>  /usr/share/<span class="hljs-keyword">vim</span>/vim90   进入此目录<br><br><span class="hljs-keyword">vim</span> defaults.<span class="hljs-keyword">vim</span>   /mouse 查找此单词<br><br>修改<span class="hljs-keyword">set</span> mouse-=<span class="hljs-keyword">a</span><br></code></pre></td></tr></table></figure><h1 id="查看版本及内核"><a href="#查看版本及内核" class="headerlink" title="查看版本及内核"></a>查看版本及内核</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/os-release <br>或 <span class="hljs-built_in">uname</span> -a<br></code></pre></td></tr></table></figure><h1 id="查看apt的源"><a href="#查看apt的源" class="headerlink" title="查看apt的源"></a>查看apt的源</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim <span class="hljs-regexp">/etc/</span>apt/sources.list<br>或 vim <span class="hljs-regexp">/etc/</span>apt<span class="hljs-regexp">/sources.list.d/</span><br></code></pre></td></tr></table></figure><h1 id="apt下载源的指令"><a href="#apt下载源的指令" class="headerlink" title="apt下载源的指令"></a>apt下载源的指令</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">wget</span> https://dev.mysql.com/get/mysql-apt-config_0.<span class="hljs-number">8</span>.<span class="hljs-number">29</span>-<span class="hljs-number">1</span>_all.deb<br><span class="hljs-comment">#下载dpkg的依赖</span><br><span class="hljs-attribute">apt</span> install gnupg<br><span class="hljs-comment">#需要用dpkg指令下载源</span><br><span class="hljs-attribute">dpkg</span> -i mysql-apt-config_0.<span class="hljs-number">8</span>.<span class="hljs-number">29</span>-<span class="hljs-number">1</span>_all.deb <br><span class="hljs-comment">#下载好源需要用update指令更新西</span><br><span class="hljs-attribute">apt</span> update<br><span class="hljs-comment">#更新好后源就自动生效了，此时可以下载服务了</span><br><span class="hljs-attribute">apt</span> install -y mysql-server<br><span class="hljs-comment">#debian系统服务下安装后不需要启动，会自动启动，直接查看状态即可</span><br><span class="hljs-attribute">systemctl</span> status mysql<br></code></pre></td></tr></table></figure><h1 id="centos系统直接更改为debian系统"><a href="#centos系统直接更改为debian系统" class="headerlink" title="centos系统直接更改为debian系统"></a>centos系统直接更改为debian系统</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 下载的github网地址</span><br>https:<span class="hljs-regexp">//gi</span>thub.com/leitbogioro/Tools<br><span class="hljs-comment"># 下载</span><br>wget --<span class="hljs-keyword">no</span>-check-certificate -qO InstallNET.sh <span class="hljs-string">&#x27;https://gitee.com/mb9e8j2/Tools/raw/master/Linux_reinstall/InstallNET.sh&#x27;</span> &amp;&amp; <span class="hljs-keyword">chmod</span> a+<span class="hljs-keyword">x</span> InstallNET.sh<br><span class="hljs-comment"># 指定版本、指定登入密码</span><br>bash InstallNET.sh -debian <span class="hljs-number">12</span> -passwd <span class="hljs-string">&quot;12345&quot;</span><br><span class="hljs-comment"># 默认密码</span><br>默认密码<br>对于 Linux：LeitboGi0ro<br>对于 Windows：Teddysun.com<br>也可等直接进入系统后更改密码：passwd 用户名<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>docker 下载及配置镜像加速器</title>
    <link href="/2025/11/06/docker-%E4%B8%8B%E8%BD%BD%E5%8F%8A%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E5%99%A8/"/>
    <url>/2025/11/06/docker-%E4%B8%8B%E8%BD%BD%E5%8F%8A%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E5%99%A8/</url>
    
    <content type="html"><![CDATA[<p><strong>docker下载安装</strong><br><strong>卸载旧版本</strong></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">yum</span> remove docker <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>                  docker-client <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>                  docker-client-latest <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>                  docker-common <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>                  docker-latest <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>                  docker-latest-logrotate <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>                  docker-logrotate <span class="hljs-punctuation">\</span><br><span class="hljs-punctuation"></span>                  docker-engine<br></code></pre></td></tr></table></figure><p><strong>需要的安装包</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sudo</span> yum install -y yum-utils<br></code></pre></td></tr></table></figure><p><strong>设置镜像仓库</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 1）官方镜像源</span><br>sudo yum-config-manager --add-repo https:<span class="hljs-regexp">//</span>download.docker.com<span class="hljs-regexp">/linux/</span>centos/docker-ce.repo<br><span class="hljs-comment"># 2）阿里云镜像源</span><br>sudo yum-config-manager --add-repo https:<span class="hljs-regexp">//mi</span>rrors.aliyun.com<span class="hljs-regexp">/docker-ce/</span>linux<span class="hljs-regexp">/centos/</span>docker-ce.repo<br></code></pre></td></tr></table></figure><p><strong>更新yum软件包索引</strong></p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">yum makecache fast</span><br></code></pre></td></tr></table></figure><p><strong>下载依赖包</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">yum -y install docker-ce docker-ce-<span class="hljs-keyword">cli</span> containerd.io docker-buildx-<span class="hljs-keyword">plugin</span> docker-compose-<span class="hljs-keyword">plugin</span><br></code></pre></td></tr></table></figure><p><strong>启动docker</strong></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">systemctl <span class="hljs-literal">start</span> docker<br></code></pre></td></tr></table></figure><p><strong>查看版本号</strong></p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">docker <span class="hljs-built_in">version</span><br></code></pre></td></tr></table></figure><p><strong>测试hello-world</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">docker <span class="hljs-built_in">run</span> hello-world<br></code></pre></td></tr></table></figure><p><strong>查看下载的hello-world镜像在不在</strong></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@iZbp1guc0wov85gocdqeaiZ ~]<span class="hljs-comment"># docker images</span><br>REPOSITORY    <span class="hljs-keyword">TAG</span>       <span class="hljs-title">IMAGE</span> ID       CREATED        SIZE<br>hello-world   latest    <span class="hljs-number">9</span>c7a54a9a43c   <span class="hljs-number">6</span> months ago   <span class="hljs-number">13.3</span>kB<br></code></pre></td></tr></table></figure><p><strong>卸载docker(共3步)</strong></p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stata">yum remove docker-ce docker-ce-<span class="hljs-keyword">cli</span> containerd.io docker-buildx-<span class="hljs-keyword">plugin</span> docker-compose-<span class="hljs-keyword">plugin</span> docker-ce-rootless-extras   <span class="hljs-comment">//卸载依赖包</span><br><span class="hljs-keyword">rm</span> -rf /<span class="hljs-keyword">var</span>/lib/docker<span class="hljs-comment">//docker默认工作路径</span><br><span class="hljs-keyword">rm</span> -rf /<span class="hljs-keyword">var</span>/lib/containerd<br></code></pre></td></tr></table></figure><p><strong>配置镜像加速器</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">登入aliyun，找到容器镜像加速器</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">您可以通过修改daemon配置文件/etc/docker/daemon.json来使用加速器</span><br>mkdir -p /etc/docker<br>tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;https://8zc4xpn2.mirror.aliyuncs.com&quot;]<br>&#125;<br>EOF<br></code></pre></td></tr></table></figure><p><strong>重启docker服务</strong></p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs sqf">systemctl daemon-<span class="hljs-built_in">reload</span><span class="hljs-comment">//重启镜像</span><br>systemctl restart docker<span class="hljs-comment">//重启docker</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Markdown的基本语法</title>
    <link href="/2025/11/06/Markdown%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/"/>
    <url>/2025/11/06/Markdown%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<p><a href="http://xbd666.cn/">清风</a><br><code>Markdown是一种纯文本格式的标记语言。通过简单的标记语法，它可以使普通文本内容具有一定的格式。（文章内容引用网络）</code></p><p><code>优点：</code></p><ul><li>1、因为是纯文本，所以只要支持Markdown的地方都能获得一样的编辑效果，可以让作者摆脱排版的困扰，专心写作。</li><li>2、操作简单。比如:WYSIWYG编辑时标记个标题，先选中内容，再点击导航栏的标题按钮，选择几级标题。要三个步骤。而Markdown只需要在标题内容前加#即可</li></ul><p><code>缺点：</code></p><ul><li>1、需要记一些语法（当然，是很简单。五分钟学会）。</li><li>2、有些平台不支持Markdown编辑模式。</li></ul><p>还好，简书是支持Markdown编辑模式的。</p><h2 id="一、标题"><a href="#一、标题" class="headerlink" title="一、标题"></a>一、标题</h2><p>在想要设置为标题的文字前面加#来表示 <code>一个#</code>是一级标题，<code>二个#</code>是二级标题，<code>以此类推</code>。支持<code>六级标题</code>。</p><p>注：标准语法一般在#后跟个空格再写文字，貌似简书不加空格也行。</p><p>示例：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">这是一级标题</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 这是二级标题</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">## 这是三级标题</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">### 这是四级标题</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#### 这是五级标题</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">##### 这是六级标题</span></span><br></code></pre></td></tr></table></figure><h2 id="二、字体"><a href="#二、字体" class="headerlink" title="二、字体"></a>二、字体</h2><p>加粗 <strong>要加粗的文字左右<code>分别用两个\*号</code>包起来</strong></p><p>斜体 <em>要倾斜的文字左右<code>分别用一个*号</code>包起来</em></p><p>斜体加粗 <em><strong>要倾斜和加粗的文字左右<code>分别用三个\*号</code>包起来</strong></em></p><p>删除线 <del>要加删除线的文字左右&#96;分别用两个</del>号&#96;包起来~~</p><h2 id="三、引用"><a href="#三、引用" class="headerlink" title="三、引用"></a>三、引用</h2><ul><li>在引用的文字<code>前加&gt;即可</code>。引用也可以嵌套，如加两个&gt;&gt;三个&gt;&gt;&gt; n个… 貌似可以一直加下去，但没神马卵用</li></ul><p>示例：</p><blockquote><p>这是引用的内容</p><blockquote><p>这是引用的内容</p><blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><blockquote><p>这是引用的内容</p></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote></blockquote><h2 id="四、分割线"><a href="#四、分割线" class="headerlink" title="四、分割线"></a>四、分割线</h2><p>三个或者三个以上的 &#96;- 或者 * 都可以。</p><hr><hr><h2 id="五、图片"><a href="#五、图片" class="headerlink" title="五、图片"></a>五、图片</h2><p>语法</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs less">!<span class="hljs-selector-attr">[图片alt]</span>(图片地址 <span class="hljs-string">&#x27;&#x27;</span>图片title<span class="hljs-string">&#x27;&#x27;</span>)<br></code></pre></td></tr></table></figure><p><strong>Less</strong></p><p>图片alt就是显示在图片下面的文字，相当于对图片内容的解释。 图片title是图片的标题，当鼠标移到图片上时显示的内容。title可加可不加</p><p>例</p><p><img src="https://xbd666.cn/upload/%E6%B8%85%E9%A3%8E2-removebg-preview.png" alt="高可用01.png"></p><h2 id="六、超链接"><a href="#六、超链接" class="headerlink" title="六、超链接"></a>六、超链接</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-attr">[超链接名]</span>(超链接地址 <span class="hljs-string">&quot;超链接title&quot;</span>)<br><span class="hljs-selector-tag">title</span>可加可不加<br></code></pre></td></tr></table></figure><p><strong>Less</strong></p><p>例</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-attr">[清风]</span>(<span class="hljs-attribute">http</span>:<span class="hljs-comment">//xbd666.cn)</span><br>[简书](<span class="hljs-attribute">http</span>:<span class="hljs-comment">//jianshu.com)</span><br>[百度](<span class="hljs-attribute">http</span>:<span class="hljs-comment">//baidu.com)</span><br></code></pre></td></tr></table></figure><p>实例<br><a href="http://xbd666.cn/">清风</a><br><a href="http://jianshu.com/">简书</a><br><a href="http://baidu.com/">百度</a><br><strong>Less</strong></p><p>注：Markdown本身语法不支持链接在新页面中打开，貌似简书做了处理，是可以的。别的平台可能就不行了，如果想要在新页面中打开的话可以用html语言的a标签代替。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;超链接地址&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span>超链接名<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><br>示例<br><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;https://www.jianshu.com/u/1f5ac0cf6a8b&quot;</span> <span class="hljs-attr">target</span>=<span class="hljs-string">&quot;_blank&quot;</span>&gt;</span>简书<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure><p><strong>XML</strong></p><h2 id="表格"><a href="#表格" class="headerlink" title="表格"></a>表格</h2><table><thead><tr><th>name</th><th>Wang</th><th>Wei</th></tr></thead><tbody><tr><td>1111</td><td>1111</td><td>1111</td></tr></tbody></table><p>例如</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs diff">name|Wang|Wei<br><span class="hljs-comment">-----|----|------</span><br>1111|1111|1111<br></code></pre></td></tr></table></figure><p><strong>Diff</strong></p><blockquote><p>常用的目前就这么多，我也不清楚哎(づ￣3￣)づ╭❤～</p></blockquote>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>常用脚本</title>
    <link href="/2025/11/06/%E5%B8%B8%E7%94%A8%E8%84%9A%E6%9C%AC/"/>
    <url>/2025/11/06/%E5%B8%B8%E7%94%A8%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h2 id="IP质量检测"><a href="#IP质量检测" class="headerlink" title="IP质量检测"></a>IP质量检测</h2><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">bash &lt;(curl -Ls IP.Check.Place)<br></code></pre></td></tr></table></figure><h2 id="融合怪"><a href="#融合怪" class="headerlink" title="融合怪"></a>融合怪</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">curl -L https:<span class="hljs-regexp">//gi</span>tlab.com/spiritysdx/za/-<span class="hljs-regexp">/raw/main</span>/ecs.sh -o ecs.sh &amp;&amp; <span class="hljs-keyword">chmod</span> +<span class="hljs-keyword">x</span> ecs.sh &amp;&amp; bash ecs.sh<br></code></pre></td></tr></table></figure><h2 id="线路测试"><a href="#线路测试" class="headerlink" title="线路测试"></a>线路测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl https://raw.githubusercontent.com/zhucaidan/mtr_trace/main/mtr_trace.sh|bash  <span class="hljs-comment"># 检测回程脚本</span><br></code></pre></td></tr></table></figure><h2 id="综合工具箱"><a href="#综合工具箱" class="headerlink" title="综合工具箱"></a>综合工具箱</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -O box.sh https://raw.githubusercontent.com/BlueSkyXN/SKY-BOX/main/box.sh &amp;&amp; <span class="hljs-built_in">chmod</span> +x box.sh &amp;&amp; clear &amp;&amp; ./box.sh++<br></code></pre></td></tr></table></figure><h2 id="VPS工具箱"><a href="#VPS工具箱" class="headerlink" title="VPS工具箱"></a>VPS工具箱</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -fsSL https://raw.githubusercontent.com/eooce/ssh_tool/main/ssh_tool.sh -o ssh_tool.sh &amp;&amp; <span class="hljs-built_in">chmod</span> +x ssh_tool.sh &amp;&amp; ./ssh_tool.sh<br></code></pre></td></tr></table></figure><h2 id="最全脚本"><a href="#最全脚本" class="headerlink" title="最全脚本"></a>最全脚本</h2><p><strong>kejilin</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -sS -O https://github.7boe.top/https://raw.githubusercontent.com/kejilion/sh/main/kejilion.sh &amp;&amp; <span class="hljs-built_in">chmod</span> +x kejilion.sh &amp;&amp; ./kejilion.sh<br></code></pre></td></tr></table></figure><p><strong>ednova脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -P /root -N https://cdn.jsdelivr.net/gh/ednovas/vpstoolbox@main/ednovastool.sh &amp;&amp; <span class="hljs-built_in">chmod</span> +x ednovastool.sh &amp;&amp; ./ednovastool.sh<br></code></pre></td></tr></table></figure><p><strong>jcnf 常用脚本工具包</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -O jcnfbox.sh https://raw.githubusercontent.com/Netflixxp/jcnf-box/main/jcnfbox.sh &amp;&amp; <span class="hljs-built_in">chmod</span> +x jcnfbox.sh &amp;&amp; clear &amp;&amp; ./jcnfbox.sh<br></code></pre></td></tr></table></figure><h2 id="bbr内核加速最全脚本"><a href="#bbr内核加速最全脚本" class="headerlink" title="bbr内核加速最全脚本"></a>bbr内核加速最全脚本</h2><p><strong>不卸载内核</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget --no-check-certificate -O tcpx.sh https://raw.githubusercontent.com/ylx2016/Linux-NetSpeed/master/tcpx.sh<br></code></pre></td></tr></table></figure><p><strong>卸载内核</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -O tcp.sh <span class="hljs-string">&quot;https://github.com/ylx2016/Linux-NetSpeed/raw/master/tcp.sh&quot;</span> &amp;&amp; <span class="hljs-built_in">chmod</span> +x tcp.sh &amp;&amp; ./tcp.sh <br></code></pre></td></tr></table></figure><h2 id="一键分区挂载"><a href="#一键分区挂载" class="headerlink" title="一键分区挂载"></a>一键分区挂载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(wget --no-check-certificate -qO- https://download.bt.cn/tools/auto_disk.sh) /website      <span class="hljs-comment">#/后面是你要挂载到的位置</span><br></code></pre></td></tr></table></figure><h2 id="一键DD脚本"><a href="#一键DD脚本" class="headerlink" title="一键DD脚本"></a>一键DD脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -N --no-check-certificate https://down.vpsaff.net/linux/dd/network-reinstall-os.sh &amp;&amp; \<br><span class="hljs-built_in">chmod</span> +x network-reinstall-os.sh &amp;&amp; ./network-reinstall-os.sh<br></code></pre></td></tr></table></figure><h2 id="换源"><a href="#换源" class="headerlink" title="换源"></a>换源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -sSL https://linuxmirrors.cn/main.sh)<br></code></pre></td></tr></table></figure><h2 id="安装docker"><a href="#安装docker" class="headerlink" title="安装docker"></a>安装docker</h2><h3 id="官方Docker"><a href="#官方Docker" class="headerlink" title="官方Docker"></a>官方Docker</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -sSL https://get.docker.com/ | sh<br></code></pre></td></tr></table></figure><h3 id="一键docker脚本"><a href="#一键docker脚本" class="headerlink" title="一键docker脚本"></a>一键docker脚本</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -sSL https://gitee.com/SuperManito/LinuxMirrors/raw/main/DockerInstallation.sh)<br></code></pre></td></tr></table></figure><h2 id="流控脚本"><a href="#流控脚本" class="headerlink" title="流控脚本"></a>流控脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">wget -O fast.<span class="hljs-built_in">bin</span> <span class="hljs-string">&quot;https://daloradius.coding.net/p/fast/git/raw/master/fast-3.0.bin&quot;</span> &amp;&amp; chmod +x fast.<span class="hljs-built_in">bin</span> &amp;&amp; ./fast.<span class="hljs-built_in">bin</span><br></code></pre></td></tr></table></figure><p><strong>Python</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -LO klutztech.com/k &amp;&amp; bash k<br></code></pre></td></tr></table></figure><h2 id="测试速度"><a href="#测试速度" class="headerlink" title="测试速度"></a>测试速度</h2><p><strong>三网测速</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -sL res.yserver.ink/taier.sh)<br></code></pre></td></tr></table></figure><p><strong>三网</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -Lso- https://git.io/superspeed_uxh)<br></code></pre></td></tr></table></figure><h3 id="海外"><a href="#海外" class="headerlink" title="海外"></a>海外</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -qO- git.io/superbench.sh | bash<br></code></pre></td></tr></table></figure><h3 id="网络测速"><a href="#网络测速" class="headerlink" title="网络测速"></a>网络测速</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -N --no-check-certificate https://raw.githubusercontent.com/FunctionClub/ZBench/master/ZBench-CN.sh &amp;&amp; bash ZBench-CN.sh<br></code></pre></td></tr></table></figure><h3 id="单线程测试"><a href="#单线程测试" class="headerlink" title="单线程测试"></a>单线程测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -Lso- https://bench.im/hyperspeed)<br></code></pre></td></tr></table></figure><h3 id="SPEEDTEST官方脚本"><a href="#SPEEDTEST官方脚本" class="headerlink" title="SPEEDTEST官方脚本"></a>SPEEDTEST官方脚本</h3><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ruby">curl -s <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/packagecloud.io/install</span><span class="hljs-regexp">/repositories/ookla</span><span class="hljs-regexp">/speedtest-cli/script</span>.deb.sh |<span class="hljs-params"> sudo bash</span><br><span class="hljs-params"></span><br><span class="hljs-params">apt-get install speedtest</span><br></code></pre></td></tr></table></figure><h3 id="全速测试"><a href="#全速测试" class="headerlink" title="全速测试"></a>全速测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -fsL https://ilemonra.in/LemonBenchIntl | bash -s fast<br></code></pre></td></tr></table></figure><h3 id="四网测试"><a href="#四网测试" class="headerlink" title="四网测试"></a>四网测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -O jcnf.sh https://raw.githubusercontent.com/Netflixxp/jcnfbesttrace/main/jcnf.sh<br><br>bash jcnf.sh<br></code></pre></td></tr></table></figure><h3 id="三网测速脚本"><a href="#三网测速脚本" class="headerlink" title="三网测速脚本"></a>三网测速脚本</h3><p><strong>线路测试</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl https://raw.githubusercontent.com/zhanghanyun/backtrace/main/install.sh -sSf | sh<br></code></pre></td></tr></table></figure><h1 id="科学上网"><a href="#科学上网" class="headerlink" title="科学上网"></a>科学上网</h1><p><strong>Argo</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(wget -qO- https://raw.githubusercontent.com/fscarmen/argox/main/argox.sh)<br></code></pre></td></tr></table></figure><h2 id="最全脚本-1"><a href="#最全脚本-1" class="headerlink" title="最全脚本"></a>最全脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash -c <span class="hljs-string">&quot;<span class="hljs-subst">$(curl -fsSL https://raw.githubusercontent.com/JeannieStudio/all_install/master/SixForOne_install.sh)</span>&quot;</span>  //8合一脚本<br></code></pre></td></tr></table></figure><p><strong>BBR加速</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /usr/src &amp;&amp; wget -N --no-check-certificate <span class="hljs-string">&quot;https://raw.githubusercontent.com/chiakge/Linux-NetSpeed/master/tcp.sh&quot;</span> &amp;&amp; <span class="hljs-built_in">chmod</span> +x tcp.sh &amp;&amp; ./tcp.sh<br></code></pre></td></tr></table></figure><h2 id="hysteria2"><a href="#hysteria2" class="headerlink" title="hysteria2"></a>hysteria2</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -fsSL https://github.com/liuoqu444/sing-box-reality-hysteria2/raw/main/reality_hy2_ws.sh)<br></code></pre></td></tr></table></figure><p><strong>Bash</strong></p><p><strong>二次元</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -N --no-check-certificate https://raw.githubusercontent.com/Misaka-blog/hysteria-install/main/hy2/hysteria.sh &amp;&amp; bash hysteria.sh<br></code></pre></td></tr></table></figure><h2 id="SSR安装"><a href="#SSR安装" class="headerlink" title="SSR安装"></a>SSR安装</h2><p><strong>逗比大神(ToyoDAdoubi)</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -N --no-check-certificate https://raw.githubusercontent.com/ToyoDAdoubi/doubi/master/ssr.sh &amp;&amp; <span class="hljs-built_in">chmod</span> +x ssr.sh &amp;&amp; bash ssr.sh<br></code></pre></td></tr></table></figure><p><strong>M3chD09大佬的“Shadowsocks+WS+TLS+CDN”一键搭建脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -O ubuntu-ss-install.sh https://github.com/M3chD09/shadowsocks-with-v2ray-plugin-install/raw/master/ubuntu-ss-install.sh<br><span class="hljs-built_in">chmod</span> +x ubuntu-ss-install.sh<br>./ubuntu-ss-install.sh<br></code></pre></td></tr></table></figure><h2 id="v2ray安装"><a href="#v2ray安装" class="headerlink" title="v2ray安装"></a>v2ray安装</h2><p><strong>官方</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -s -L https://git.io/v2ray.sh)<br></code></pre></td></tr></table></figure><p><strong>multi-v2ray多用户管理脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> &lt;(curl -sL https://multi.netlify.app/v2ray.sh) --zh<br></code></pre></td></tr></table></figure><p><strong>v2ray+nginx+ws+tls</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">wget -N --<span class="hljs-keyword">no</span>-check-certificate -<span class="hljs-keyword">q</span> -O install.sh <span class="hljs-string">&quot;https://raw.githubusercontent.com/wulabing/V2Ray_ws-tls_bash_onekey/master/install.sh&quot;</span> &amp;&amp; <span class="hljs-keyword">chmod</span> +<span class="hljs-keyword">x</span> install.sh &amp;&amp; bash install.sh<br></code></pre></td></tr></table></figure><h2 id="TROJAN系列安装"><a href="#TROJAN系列安装" class="headerlink" title="TROJAN系列安装"></a>TROJAN系列安装</h2><p><strong>Trojan-Go</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash -c <span class="hljs-string">&quot;<span class="hljs-subst">$(curl -fsSL https://raw.githubusercontent.com/JeannieStudio/all_install/master/trojan-go_install.sh)</span>&quot;</span><br></code></pre></td></tr></table></figure><p><strong>官方一键</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> &lt;(curl -sL https://git.io/trojan-install)<br></code></pre></td></tr></table></figure><p><strong>二合一脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl -O https://raw.githubusercontent.com/jinwyp/one_click_script/master/trojan_v2ray_install.sh &amp;&amp; <span class="hljs-built_in">chmod</span> +x ./trojan_v2ray_install.sh &amp;&amp; ./trojan_v2ray_install.sh<br></code></pre></td></tr></table></figure><h2 id="x-ui安装"><a href="#x-ui安装" class="headerlink" title="x-ui安装"></a><strong>x-ui安装</strong></h2><p><strong>官网</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -Ls https://raw.githubusercontent.com/vaxilu/x-ui/master/install.sh)<br></code></pre></td></tr></table></figure><p><strong>魔改 英文-3xui</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -Ls https://raw.githubusercontent.com/mhsanaei/3x-ui/master/install.sh)<br></code></pre></td></tr></table></figure><p><strong>FranzKafkaYu</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -Ls https://raw.githubusercontent.com/FranzKafkaYu/x-ui/956bf85bbac978d56c0e319c5fac2d6db7df9564/install.sh)<br></code></pre></td></tr></table></figure><p><strong>美化 xui</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -Ls https://raw.githubusercontent.com/diditra/x-ui/master/install.sh)<br></code></pre></td></tr></table></figure><p><strong>魔改版</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby">bash &lt;(curl -<span class="hljs-title class_">Ls</span> <span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/gitlab.com/rwkgyg</span><span class="hljs-regexp">/x-ui-yg/raw</span><span class="hljs-regexp">/main/install</span>.sh)<br></code></pre></td></tr></table></figure><h2 id="跑分"><a href="#跑分" class="headerlink" title="跑分"></a>跑分</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://s3.amazonaws.com/cloudbench/software/UnixBench5.1.3.tgz<br>tar -xf UnixBench5.1.3.tgz<br><span class="hljs-built_in">cd</span> UnixBench/<br>make all<br>./Run<br></code></pre></td></tr></table></figure><h2 id="流媒体测试"><a href="#流媒体测试" class="headerlink" title="流媒体测试"></a>流媒体测试</h2><h3 id="全媒体测试"><a href="#全媒体测试" class="headerlink" title="全媒体测试"></a>全媒体测试</h3><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss">bash &lt;(curl -L -s check.unlock.media)<br></code></pre></td></tr></table></figure><h3 id="奈飞"><a href="#奈飞" class="headerlink" title="奈飞"></a>奈飞</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget -O nf https://github.com/sjlleo/netflix-verify/releases/download/2.5/nf_2.5_linux_amd64 &amp;&amp; <span class="hljs-built_in">chmod</span> +x nf &amp;&amp; clear &amp;&amp; ./nf<br></code></pre></td></tr></table></figure><h2 id="抓取节点脚本"><a href="#抓取节点脚本" class="headerlink" title="抓取节点脚本"></a>抓取节点脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget https://raw.githubusercontent.com/slobys/proxypool/master/onekey_install.sh &amp;&amp; <span class="hljs-built_in">chmod</span> +x onekey_install.sh &amp;&amp; ./onekey_install.sh<br></code></pre></td></tr></table></figure><h2 id="DD-系统"><a href="#DD-系统" class="headerlink" title="DD 系统"></a>DD 系统</h2><h3 id="Windows-DD-Linux"><a href="#Windows-DD-Linux" class="headerlink" title="Windows DD Linux"></a>Windows DD Linux</h3><p>开启tls1.2</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Ssl3 -bor [Net.SecurityProtocolType]::Tls -bor [Net.SecurityProtocolType]::Tls11 -bor [Net.SecurityProtocolType]::Tls12<br></code></pre></td></tr></table></figure><p>下载命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">Invoke-WebRequest -Uri https://raw.githubusercontent.com/bin456789/reinstall/main/reinstall.bat -OutFile reinstall.bat<br></code></pre></td></tr></table></figure><p>开始dd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">reinstall.bat debian-11<br></code></pre></td></tr></table></figure><p>重启</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">shutdown /r /t 0<br></code></pre></td></tr></table></figure><p>root<br>密码是123@@</p><h2 id="转发面板"><a href="#转发面板" class="headerlink" title="转发面板"></a>转发面板</h2><p><strong>极光面板</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -fsSL https://raw.githubusercontent.com/Aurora-Admin-Panel/deploy/main/install.sh)<br></code></pre></td></tr></table></figure><h2 id="Windows激活"><a href="#Windows激活" class="headerlink" title="Windows激活"></a>Windows激活</h2><p><strong>一键脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">irm https://massgrave.dev/get | iex<br></code></pre></td></tr></table></figure><p><strong>搭建KMS</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">wget --no-check-certificate https://raw.githubusercontent.com/Mr-xn/kms-server-deploy/master/kms-server-deploy.sh &amp;&amp; bash kms-server-deploy.sh<br></code></pre></td></tr></table></figure><p><strong>数字认证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">irm http://d.cmdpe.com/h|iex<br></code></pre></td></tr></table></figure><p><strong>KMS激活</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">irm http://d.cmdpe.com/k|iex<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Redis 部署单机-主从-哨兵模式</title>
    <link href="/2025/11/06/Redis-%E9%83%A8%E7%BD%B2%E5%8D%95%E6%9C%BA-%E4%B8%BB%E4%BB%8E-%E5%93%A8%E5%85%B5/"/>
    <url>/2025/11/06/Redis-%E9%83%A8%E7%BD%B2%E5%8D%95%E6%9C%BA-%E4%B8%BB%E4%BB%8E-%E5%93%A8%E5%85%B5/</url>
    
    <content type="html"><![CDATA[<p><strong>Redis</strong></p><p><strong>1、安装单机版redis</strong></p><p><strong>官网下载redis</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">https://redis.io/<br></code></pre></td></tr></table></figure><p><strong>点击download，往下拉，找到以下内容</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">List of all releases and hash digests<br>You can find a listing of all previous Redis releases on the releases page. SHA-256 digests for these downloads are available in the redis-hashes git repository.<br><br> listing of all previous Redis releases --&gt; 点击此内容--&gt;进入选取想要的版本（学习实验用的7.0.9版本）<br></code></pre></td></tr></table></figure><p><strong>下载</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# wget https://download.redis.io/releases/redis-7.0.9.tar.gz//7.0.9版本的<br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定解压路径</span><br>[root@localhost ~]# tar zxvf redis-7.0.9.tar.gz -C /usr/loval<br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cd</span>到/usr/loval/redis，改名</span><br>[root@localhost redis]# mv redis-7.0.9 redis<br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载编译工具</span><br>[root@localhost redis]# yum -y install gcc make<br><span class="hljs-meta prompt_"># </span><span class="language-bash">编译</span><br>[root@localhost redis]# make<br><span class="hljs-meta prompt_"># </span><span class="language-bash">注：如果报错请将刚才解压的安装包删除掉，再次重新解压并进行make安装即可</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">编辑配置文件，vim redis.conf</span><br>[root@localhost redis]# vim redis.conf<br>bind 192.168.246.202　　#只监听内网IP<br>daemonize yes　　　　　#开启后台模式将no改为yes<br>port 6379                      #端口号<br>dir /usr/local/redis/data　　#本地数据库存放持久化数据的目录该目录-----需要存在<br>protected-mode yes //开启密码，默认是yes，可以改no<br>requirepass 1122334 #设置密码<br>logfile &quot;/var/log/redis.log&quot;  #设置日志存放路径与日志名<br>创建存放数据的目录<br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建持久化目录</span><br>[root@localhost redis]# mkdir data<br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动redis</span><br>[root@localhost redis]# src/redis-server redis.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看端口</span><br>[root@localhost redis]# netstat -lnpt<br><span class="hljs-meta prompt_"># </span><span class="language-bash">登入redis</span><br>[root@localhost redis]# src/redis-cli -h 192.168.116.111 -p 6379<br>192.168.116.111:6379&gt; ping// ---测试redis是否可以用<br>PONG<br>192.168.116.111:6379&gt;<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 单机版redsi已经部署完成。将ip和端口发给开发就可以了。</span></span><br></code></pre></td></tr></table></figure><p><strong>2、数据持久化</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">关闭redis</span><br>[root@localhost redis]# pkill redis<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看端口</span><br>[root@localhost redis]# netstat -lnpt<br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动</span><br>[root@localhost redis]# src/redis-server redis.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">登入</span><br>[root@localhost redis]# src/redis-cli -h 192.168.116.111 -p 6379<br>192.168.116.111:6379&gt; keys *<br>(empty array)<br>192.168.116.111:6379&gt; set name qingfeng<br>OK<br>192.168.116.111:6379&gt; set age 18<br>OK<br>192.168.116.111:6379&gt; keys *//查看所有<br>1) &quot;age&quot;<br>2) &quot;name&quot;<br>192.168.116.111:6379&gt; bgsave//数据持久化命令<br>Background saving started<br>192.168.116.111:6379&gt; exit<br>[root@localhost redis]# cd data<br>[root@localhost data]# ls//在data目录下会生成一个数据文件<br>dump.rdb<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">此时在另一台机器上下载号redis，把数据复制到另一台机器上</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">注意 redis下载好先不要启动，把数据复制过来在启动</span><br>scp dump.rdb 192.168.116.131:/usr/local/redis/data<br><span class="hljs-meta prompt_"># </span><span class="language-bash">此时启动，数据持久化完成了</span><br></code></pre></td></tr></table></figure><p><strong>3、主从配置</strong></p><blockquote><p>配置主从配置要保证所有机器的数据一样</p><h5 id="设置主机名"><a href="#设置主机名" class="headerlink" title="设置主机名"></a>设置主机名</h5><p>redis-master—-192.168.116.111<br>redis-slave-1—–192.168.116.131<br>redis-slave-2—–192.168.116.132</p></blockquote><p><strong>设置配置文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs shell">master<br>[root@redis-master ~]# cd /usr/local/redis/<br>[root@redis-master redis]# vim redis.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">bind</span> 192.168.116.111注释了</span><br>bind 0.0.0.0<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">关闭，并重启服务</span><br>[root@redis-master redis]# pkill redis<br>[root@redis-master redis]# src/redis-server redis.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">登入，<span class="hljs-built_in">bind</span>设置的0.0.0.0，所以命令不用跟IP和端口</span><br>[root@redis-master redis]# src/redis-cli<br>127.0.0.1:6379&gt; ping<br>PONG<br>127.0.0.1:6379&gt; set name qingfeng<br>OK<br>127.0.0.1:6379&gt; get name<br>&quot;qingfeng&quot;<br>127.0.0.1:6379&gt; info replication//查看复制状态，详细信息<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>connected_slaves:2<br>slave0:ip=192.168.116.131,port=6379,state=online,offset=564,lag=1<br>slave1:ip=192.168.116.132,port=6379,state=online,offset=564,lag=1<br>master_failover_state:no-failover<br>master_replid:4111015d2d43dfe9b0553c0bb19389c95c7976c7<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:564<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:1<br>repl_backlog_histlen:564<br>127.0.0.1:6379&gt; exit<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs shell">slave-1<br><span class="hljs-meta prompt_"># </span><span class="language-bash">拷贝</span><br>scp 192.168.116.111:/root/redis-7.0.9.tar.gz /root<br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定解压路径</span><br>[root@localhost ~]# tar zxvf redis-7.0.9.tar.gz -C /usr/loval<br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cd</span>到/usr/loval/redis，改名</span><br>[root@localhost redis]# mv redis-7.0.9 redis<br>[root@localhost redis]# yum -y install gcc make<br><span class="hljs-meta prompt_"># </span><span class="language-bash">编译</span><br>[root@localhost redis]# make<br><span class="hljs-meta prompt_"># </span><span class="language-bash">编辑配置文件</span><br>[root@redis-master redis]# vim redis.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">bind</span> 192.168.116.111注释了</span><br>bind 0.0.0.0<br>protected-mode no//yes改no，设置密码的<br>replicaof 192.168.116.111 //添加master的内网和端口<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动，如果已经启动过了，需要关闭redis重新启动</span><br>[root@redis-slave-1 redis]# src/redis-server redis.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">登入，<span class="hljs-built_in">bind</span>设置的0.0.0.0，所以命令不用跟IP和端口</span><br>[root@redis-slave-1 redis]# src/redis-cli<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">此时输入命令可以看到master创建的数据了</span><br>127.0.0.1:6379&gt; get name<br>&quot;qingfeng&quot;<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:192.168.116.111<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:10<br>master_sync_in_progress:0<br>slave_read_repl_offset:802<br>slave_repl_offset:802<br>slave_priority:100<br>slave_read_only:1<br>replica_announced:1<br>connected_slaves:0<br>master_failover_state:no-failover<br>master_replid:4111015d2d43dfe9b0553c0bb19389c95c7976c7<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:802<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:15<br>repl_backlog_histlen:788<br>127.0.0.1:6379&gt; exit<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs shell">slave-2<br><span class="hljs-meta prompt_"># </span><span class="language-bash">拷贝</span><br>scp 192.168.116.111:/root/redis-7.0.9.tar.gz /root<br><span class="hljs-meta prompt_"># </span><span class="language-bash">指定解压路径</span><br>[root@localhost ~]# tar zxvf redis-7.0.9.tar.gz -C /usr/loval<br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">cd</span>到/usr/loval/redis，改名</span><br>[root@localhost redis]# mv redis-7.0.9 redis<br>[root@localhost redis]# yum -y install gcc make<br><span class="hljs-meta prompt_"># </span><span class="language-bash">编译</span><br>[root@localhost redis]# make<br><span class="hljs-meta prompt_"># </span><span class="language-bash">编辑配置文件</span><br>[root@redis-master redis]# vim redis.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-built_in">bind</span> 192.168.116.111注释了</span><br>bind 0.0.0.0<br>protected-mode no//yes改no，设置密码的<br>replicaof 192.168.116.111 //添加master的内网和端口<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动，如果已经启动过了，需要关闭redis重新启动</span><br>[root@redis-slave-2 redis]# src/redis-server redis.conf<br>[root@redis-slave-2 redis]# src/redis-cli<br>127.0.0.1:6379&gt; get name<br>&quot;qingfeng&quot;<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:slave<br>master_host:192.168.116.111<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:6<br>master_sync_in_progress:0<br>slave_read_repl_offset:816<br>slave_repl_offset:816<br>slave_priority:100<br>slave_read_only:1<br>replica_announced:1<br>connected_slaves:0<br>master_failover_state:no-failover<br>master_replid:4111015d2d43dfe9b0553c0bb19389c95c7976c7<br>master_replid2:0000000000000000000000000000000000000000<br>master_repl_offset:816<br>second_repl_offset:-1<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:295<br>repl_backlog_histlen:522<br>127.0.0.1:6379&gt; exit<br></code></pre></td></tr></table></figure><p><code>此时主从同步部署完成</code></p><p><strong>4、redis-sentinel—哨兵模式</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">每台机器上修改redis主配置文件redis.conf文件设置：<span class="hljs-built_in">bind</span> 0.0.0.0</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改配置文件</span><br>[root@redis-master redis]# vim sentinel.conf<br>daemonize yes #设置哨兵放后台运行<br>logfile &quot;/var/log/sentinel.log&quot; #设置哨兵日志<br>sentinel monitor mymaster 10.0.0.137 6379 2 #当集群中有2个sentinel认为master死了时，才能真正认为该master已经不可用了。 (slave上面写的是master的ip，master写自己ip)<br>sentinel auth-pass mymaster 1122334 #如果设置了密码那就需要指定密码，否则不需要<br>sentinel down-after-milliseconds mymaster 3000   #单位毫秒<br>sentinel failover-timeout mymaster 10000   #若sentinel在该配置值内未能完成failover(故障转移)操作（即故障时master/slave自动切换），则认为本次failover失败。<br><br>protected-mode no  #关闭加密模式--新添加到sentinel配置文件中  ----老版本中需需要添加<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动</span><br>[root@redis-master redis]# pkill redis<br>[root@redis-master redis]# src/redis-sentinel sentinel.conf<br>[root@redis-master redis]# src/redis-server redis.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">测试</span><br>[root@redis-slave-1 redis]# src/redis-cli<br>127.0.0.1:6379&gt; ping<br>PONG<br>127.0.0.1:6379&gt; info replication<br><span class="hljs-meta prompt_"># </span><span class="language-bash">Replication</span><br>role:master<br>master_host:192.168.116.111<br>master_port:6379<br>master_link_status:up<br>master_last_io_seconds_ago:0<br>master_sync_in_progress:0<br>slave_read_repl_offset:25387<br>slave_repl_offset:25387<br>slave_priority:100<br>slave_read_only:1<br>replica_announced:1<br>connected_slaves:0<br>master_failover_state:no-failover<br>master_replid:d09a4de58ff9c3e7f5c4e9fe7c39f5a7f7b7861c<br>master_replid2:4111015d2d43dfe9b0553c0bb19389c95c7976c7<br>master_repl_offset:25387<br>second_repl_offset:4205<br>repl_backlog_active:1<br>repl_backlog_size:1048576<br>repl_backlog_first_byte_offset:15<br>repl_backlog_histlen:25373<br></code></pre></td></tr></table></figure><p><code>此时哨兵模式部署完成</code></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>redis-cluster 集群部署</title>
    <link href="/2025/11/06/redis-cluster-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/redis-cluster-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<p><strong>redis-cluster集群</strong></p><p>准备环境</p><p><strong>准备3台机器，关闭防火墙和selinux</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">注:规划架构两种方案，一种是单机多实例，这里我们采用多机器部署:</span><br>三台机器，每台机器上面两个redis实例，一个master一个slave，第一列做主库，第二列做备库<br><span class="hljs-meta prompt_">#</span><span class="language-bash">记得选出控制节点</span><br><br>[root@localhost ~]# vim /etc/hosts<br>redis-cluster1 192.168.116.111 7000 7001<br>redis-cluster2 192.168.116.131 7002 7003<br>redis-cluster3 192.168.116.132 7004 7005<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改主机名</span><br>[root@localhost ~]# hostnamectl set-hostname redis-cluster1<br>[root@localhost ~]# hostnamectl set-hostname redis-cluster2<br>[root@localhost ~]# hostnamectl set-hostname redis-cluster3<br></code></pre></td></tr></table></figure><p><strong>三台机器相同的操作</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装redis依赖环境</span><br>[root@redis-cluster1 ~]# yum -y install gcc automake autoconf libtool make<br><span class="hljs-meta prompt_"># </span><span class="language-bash">官方下载redis，这里用的是6.2的版本</span><br>[root@redis-cluster1 ~]# wget https://download.redis.io/releases/redis-6.2.0.tar.gz<br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建目录、并指定路径解压软件包</span><br>[root@redis-cluster1 ~]# mkdir /data<br>[root@redis-cluster1 ~]# tar xzvf redis-6.2.0.tar.gz -C /data/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">切换目录</span><br>[root@redis-cluster1 ~]# cd /data/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改目录名</span><br>[root@redis-cluster1 data]# mv redis-6.2.0/ redis<br><span class="hljs-meta prompt_"># </span><span class="language-bash">进入redis目录</span><br>[root@redis-cluster1 data]# cd redis/<br><span class="hljs-meta prompt_"># </span><span class="language-bash">编译</span><br>[root@redis-cluster1 redis]# make<br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建存放数据的目录</span><br>[root@redis-cluster1 redis]# mkdir /data/redis/data <br></code></pre></td></tr></table></figure><p><strong>创建节点目录</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">创建节点目录:按照规划在每台redis节点的安装目录中创建对应的目录（以端口号命名）</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">redis-cluster1</span><br>[root@redis-cluster1 redis]# pwd<br>/data/redis<br>[root@redis-cluster1 redis]# mkdir cluster #创建集群目录<br>[root@redis-cluster1 redis]# cd cluster/<br>[root@redis-cluster1 cluster]# mkdir 7000 7001 #创建节点目录<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">redis-cluster2</span><br>[root@redis-cluster2 redis]# mkdir cluster<br>[root@redis-cluster2 redis]# cd cluster/<br>[root@redis-cluster2 cluster]# mkdir 7002 7003<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">redis-cluster3</span><br>[root@redis-cluster3 redis]# mkdir cluster<br>[root@redis-cluster3 redis]# cd cluster/<br>[root@redis-cluster3 cluster]# mkdir 7004 7005<br></code></pre></td></tr></table></figure><p><strong>修改集群每个redis配置文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">redis-cluster1</span><br>[root@redis-cluster1 cluster]# cp /data/reids/redis.conf ./7000<br>[root@redis-cluster1 cluster]# ls<br>7000  7001<br>[root@redis-cluster1 cluster]# vim ./7000/redis.conf<br>[root@redis-cluster1 cluster]# cp ./7000/redis.conf ./7001/<br>[root@redis-cluster1 cluster]# vim ./7001/redis.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改内容如下</span><br>bind 192.168.116.172  #每个实例的配置文件修改为对应节点的ip地址<br>protected-mode no#关闭密码服务<br>port 7000   #监听端口，运行多个实例时，需要指定规划的每个实例不同的端口号<br>daemonize yes #redis后台运行<br>pidfile /var/run/redis_7000.pid #pid文件，运行多个实例时，需要指定不同的pid文件<br>logfile /var/log/redis_7000.log #日志文件位置，运行多实例时，需要将文件修改的不同。<br>dir /data/redis/data #存放数据的目录<br>appendonly yes #开启AOF持久化，redis会把所接收到的每一次写操作请求都追加到appendonly.aof文件中，当redis重新启动时，会从该文件恢复出之前的状态。<br>appendfilename &quot;appendonly.aof&quot;  #AOF文件名称<br>appendfsync everysec #表示对写操作进行累积，每秒同步一次<br>以下为打开注释并修改<br>cluster-enabled yes #启用集群<br>cluster-config-file nodes-7000.conf #集群配置文件，由redis自动更新，不需要手动配置，运行多实例时请注修改为对应端口<br>cluster-node-timeout 5000 #单位毫秒。集群节点超时时间，即集群中主从节点断开连接时间阈值，超过该值则认为主节点不可以，从节点将有可能转为master<br>cluster-replica-validity-factor 10 #在进行故障转移的时候全部slave都会请求申请为master，但是有些slave可能与master断开连接一段时间了导致数据过于陈旧，不应该被提升为master。该参数就是用来判断slave节点与master断线的时间是否过长。<br>cluster-migration-barrier 1 #一个主机将保持连接的最小数量的从机，以便另一个从机迁移到不再被任何从机覆盖的主机<br>cluster-require-full-coverage yes #集群中的所有slot（16384个）全部覆盖，才能提供服务<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">注：</span><br>所有节点配置文件全部修改切记需要修改的ip、端口、pid文件...避免冲突。确保所有机器都修改。<br></code></pre></td></tr></table></figure><p><strong>redis-cluster2—-redis-cluster3</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">redis-cluster2----redis-cluster3<br>重复redis-cluster1步骤操作<br></code></pre></td></tr></table></figure><p><strong>启动三台机器上面的每个节点(三台机器相同操作)</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@redis-cluster1 ~]# cd /data/redis/src/<br>[root@redis-cluster1 src]# ./redis-server ../cluster/7000/redis.conf <br>[root@redis-cluster1 src]# ./redis-server ../cluster/7001/redis.conf<br><br>[root@redis-cluster2 7003]# cd /data/redis/src/<br>[root@redis-cluster2 src]# ./redis-server ../cluster/7002/redis.conf <br>[root@redis-cluster2 src]# ./redis-server ../cluster/7003/redis.conf<br><br>[root@redis-cluster3 7005]# cd /data/redis/src/<br>[root@redis-cluster3 src]# ./redis-server ../cluster/7004/redis.conf <br>[root@redis-cluster3 src]# ./redis-server ../cluster/7005/redis.conf<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">注意 如果没有报错，但是就是启动不了，看不到端口，把配置文件里的<span class="hljs-built_in">dir</span>路径写相对路径</span><br></code></pre></td></tr></table></figure><p><strong>查看端口</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">每个机器上都可以看下端口有没有起来</span><br>[root@redis-cluster1 reids]# netstat -lnpt<br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name<br>tcp        0      0 192.168.116.111:7000    0.0.0.0:*               LISTEN      16191/src/redis-ser<br>tcp        0      0 192.168.116.111:7001    0.0.0.0:*               LISTEN      16197/src/redis-ser<br>tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1137/master<br>tcp        0      0 192.168.116.111:17000   0.0.0.0:*               LISTEN      16191/src/redis-ser<br>tcp        0      0 192.168.116.111:17001   0.0.0.0:*               LISTEN      16197/src/redis-ser<br></code></pre></td></tr></table></figure><p><strong>创建集群：在其中一个节点操作就可以</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">redis节点搭建起来后，需要完成redis cluster集群搭建，搭建集群过程中，需要保证6个redis实例都是运行状态。<br>Redis是根据IP和Port的顺序，确定master和slave的，所以要排好序，再执行。<br><br>参数:<br>--cluster-replicas 1:表示为集群中的每个主节点创建一个从节点.书写流程:主节点ip+port 对应一个从节点ip+port（正常是前面三个节点为主节点，后面的为从节点）<br><br>[root@redis-cluster1 src]# cd /data/redis/src/<br>[root@redis-cluster1 src]# ./redis-cli --cluster create --cluster-replicas 1 192.168.116.111:7000 192.168.116.111:7001 192.168.116.131:7002 192.168.116.131:7003 192.168.116.132:7004 192.168.116.132:7005<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">Can I <span class="hljs-built_in">set</span> the above configuration? (<span class="hljs-built_in">type</span> <span class="hljs-string">&#x27;yes&#x27;</span> to accept): <span class="hljs-built_in">yes</span>  <span class="hljs-comment">#写yes同意</span></span><br></code></pre></td></tr></table></figure><p><strong>查看集群状态可连接集群中的任一节点</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">此处连接了集群中的节点--192.168.116.111</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">登录集群客户端，-c标识以集群方式登录</span><br>[root@redis-cluster1 src]# ./redis-cli -h 192.168.116.172 -c -p 7000<br>192.168.116.172:7000&gt; ping<br>PONG<br>192.168.116.173:7002&gt; cluster info  #查看集群信息<br>cluster_state:ok  #集群状态<br>cluster_slots_assigned:16384 #分配的槽<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6 #集群实例数<br>......<br><br>192.168.116.172:7000&gt; cluster nodes  #查看集群实例<br><br>参数解释：<br>runid: 该行描述的节点的id。<br>ip:prot: 该行描述的节点的ip和port<br>flags: 分隔的标记位，可能的值有：<br>1.master: 该行描述的节点是master<br>2.slave: 该行描述的节点是slave<br>3.fail?:该行描述的节点可能不可用<br>4.fail:该行描述的节点不可用（故障）<br>master_runid: 该行描述的节点的master的id,如果本身是master则显示-<br>ping-sent: 最近一次发送ping的Unix时间戳，0表示未发送过<br>pong-recv：最近一次收到pong的Unix时间戳，0表示未收到过<br>config-epoch: 主从切换的次数<br>link-state: 连接状态，connnected 和 disconnected<br>hash slot: 该行描述的master中存储的key的hash的范围<br></code></pre></td></tr></table></figure><p><strong>查看redis-cluster1，和连通性</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@redis-cluster1 src]# ./redis-cli -h 192.168.116.132 -c -p 7004<br>192.168.116.132:7004&gt; ping<br>PONG<br>192.168.116.132:7004&gt; cluster info<br>cluster_state:ok<br>cluster_slots_assigned:16384<br>cluster_slots_ok:16384<br>cluster_slots_pfail:0<br>cluster_slots_fail:0<br>cluster_known_nodes:6<br>cluster_size:3<br>cluster_current_epoch:6<br>cluster_my_epoch:5<br>cluster_stats_messages_ping_sent:837<br>cluster_stats_messages_pong_sent:962<br>cluster_stats_messages_meet_sent:1<br>cluster_stats_messages_sent:1800<br>cluster_stats_messages_ping_received:962<br>cluster_stats_messages_pong_received:838<br>cluster_stats_messages_received:1800<br>192.168.116.132:7004&gt; cluster nodes<br>e1784e05bc7220db5155e80787b4cc6af12ab0c5 192.168.116.131:7003@17003 slave 462577d2fbc035e6584f9ce7177d9e0df72e3c16 0 1702369829000 1 connected<br>bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 192.168.116.132:7004@17004 myself,master - 0 1702369827000 5 connected 10923-16383<br>c81d083a6b36882c955e76ed026b3d90c5ac61eb 192.168.116.131:7002@17002 master - 0 1702369830266 3 connected 5461-10922<br>462577d2fbc035e6584f9ce7177d9e0df72e3c16 192.168.116.111:7000@17000 master - 0 1702369829262 1 connected 0-5460<br>4cbe431c64d21483dd004b18207f647145e0c6fb 192.168.116.132:7005@17005 slave c81d083a6b36882c955e76ed026b3d90c5ac61eb 0 1702369830000 3 connected<br>9c5e3e52773043d74a01b8ebbe7f2b63f56dd8b0 192.168.116.111:7001@17001 slave bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 0 1702369829000 5 connected<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">验证--查看</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">可以数据联通--属于集群操作</span><br>redis-cluster1<br>192.168.116.132:7004&gt; set name qingfeng<br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [5798] located at 192.168.116.131:7002</span><br>OK<br>192.168.116.131:7002&gt;<br><br>redis-cluster3<br>192.168.116.111:7000&gt; get name<br><span class="hljs-meta prompt_">-&gt; </span><span class="language-bash">Redirected to slot [5798] located at 192.168.116.131:7002</span><br>&quot;qingfeng&quot;<br>192.168.116.131:7002&gt;<br></code></pre></td></tr></table></figure><p><strong>主从切换</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs shell">测试：<br><span class="hljs-meta prompt_"># </span><span class="language-bash">1.将节点cluster1的主节点7000端口的redis关掉</span><br>[root@redis-cluster1 src]# ./redis-cli -h 192.168.116.132 -c -p 7004<br>192.168.116.132:7004&gt; cluster nodes#此时查看7000在线<br>e1784e05bc7220db5155e80787b4cc6af12ab0c5 192.168.116.131:7003@17003 slave 462577d2fb<br>bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 192.168.116.132:7004@17004 myself,master -<br>c81d083a6b36882c955e76ed026b3d90c5ac61eb 192.168.116.131:7002@17002 master - 0 17023<br>462577d2fbc035e6584f9ce7177d9e0df72e3c16 192.168.116.111:7000@17000 master - 0 17023<br>4cbe431c64d21483dd004b18207f647145e0c6fb 192.168.116.132:7005@17005 slave c81d083a6b<br>9c5e3e52773043d74a01b8ebbe7f2b63f56dd8b0 192.168.116.111:7001@17001 slave bcbfcc14d0<br>192.168.116.132:7004&gt; exit<br>[root@redis-cluster1 src]# ps -ef |grep redis<br>root      16191      1  0 15:50 ?        00:00:07 src/redis-server 192.168.116.111:7<br>root      16197      1  0 15:50 ?        00:00:07 src/redis-server 192.168.116.111:7<br>root      16246   1538  0 16:39 pts/0    00:00:00 grep --color=auto redis<br>[root@redis-cluster1 src]# kill -9 16191<br>[root@redis-cluster1 src]# ps -ef |grep redis<br>root      16197      1  0 15:50 ?        00:00:07 src/redis-server 192.168.116.111:7<br>root      16248   1538  0 16:39 pts/0    00:00:00 grep --color=auto redis<br>[root@redis-cluster1 src]# netstat -lnpt#7000的端口关闭了，看不到<br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name<br>tcp        0      0 192.168.116.111:7001    0.0.0.0:*               LISTEN      16197/src/redis-ser<br>tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1137/master<br>tcp        0      0 192.168.116.111:17001   0.0.0.0:*               LISTEN      16197/src/redis-ser<br>tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      938/sshd<br>tcp6       0      0 ::1:25                  :::*                    LISTEN      1137/master<br>tcp6       0      0 :::22                   :::*                    LISTEN      938/sshd<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看集群信息：--在132的机器上输入命令查看</span><br>192.168.116.131:7002&gt; cluster nodes  #此时查看7000显示fail，下线了<br>c81d083a6b36882c955e76ed026b3d90c5ac61eb 192.168.116.131:7002@17002 myself,master - 0 1702370394000 3 connected 5461-10922<br>462577d2fbc035e6584f9ce7177d9e0df72e3c16 192.168.116.111:7000@17000 master,fail - 1702370373573 1702370371564 1 disconnected#显示fail，下线了<br>e1784e05bc7220db5155e80787b4cc6af12ab0c5 192.168.116.131:7003@17003 master - 0 1702370394653 7 connected 0-5460<br>4cbe431c64d21483dd004b18207f647145e0c6fb 192.168.116.132:7005@17005 slave c81d083a6b36882c955e76ed026b3d90c5ac61eb 0 1702370395055 3 connected<br>bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 192.168.116.132:7004@17004 master - 0 1702370395657 5 connected 10923-16383<br>9c5e3e52773043d74a01b8ebbe7f2b63f56dd8b0 192.168.116.111:7001@17001 slave bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 0 1702370395156 5 connected<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">2.将该节点的7000端口redis启动在查看</span><br>[root@redis-cluster1 src]# cd ..<br>[root@redis-cluster1 reids]# src/redis-server cluster/7000/redis.conf<br>[root@redis-cluster1 reids]# netstat -lnpt#此时7000的端口正常运行<br>Active Internet connections (only servers)<br>Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name<br>tcp        0      0 192.168.116.111:7000    0.0.0.0:*               LISTEN      16257/src/redis-ser<br>tcp        0      0 192.168.116.111:7001    0.0.0.0:*               LISTEN      16197/src/redis-ser<br>tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1137/master<br>tcp        0      0 192.168.116.111:17000   0.0.0.0:*               LISTEN      16257/src/redis-ser<br>tcp        0      0 192.168.116.111:17001   0.0.0.0:*               LISTEN      16197/src/redis-ser<br>tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      938/sshd<br>tcp6       0      0 ::1:25                  :::*                    LISTEN      1137/master<br>tcp6       0      0 :::22                   :::*                    LISTEN      938/sshd<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看节点信息：-- 用132的机器查看，此时7000的状态恢复正常，但是变成了从节点</span><br>192.168.116.131:7002&gt; cluster nodes<br>c81d083a6b36882c955e76ed026b3d90c5ac61eb 192.168.116.131:7002@17002 myself,master - 0 1702370727000 3 connected 5461-10922<br>462577d2fbc035e6584f9ce7177d9e0df72e3c16 192.168.116.111:7000@17000 slave e1784e05bc7220db5155e80787b4cc6af12ab0c5 0 1702370728000 7 connected<br>e1784e05bc7220db5155e80787b4cc6af12ab0c5 192.168.116.131:7003@17003 master - 0 1702370728580 7 connected 0-5460<br>4cbe431c64d21483dd004b18207f647145e0c6fb 192.168.116.132:7005@17005 slave c81d083a6b36882c955e76ed026b3d90c5ac61eb 0 1702370728000 3 connected<br>bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 192.168.116.132:7004@17004 master - 0 1702370727000 5 connected 10923-16383<br>9c5e3e52773043d74a01b8ebbe7f2b63f56dd8b0 192.168.116.111:7001@17001 slave bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 0 1702370728581 5 connected<br></code></pre></td></tr></table></figure><p>到此–主从切换完成<br><img src="https://xbd666.cn/upload/redis-cluster1.png" alt="image-20231212171231961"><br><img src="https://xbd666.cn/upload/redis-cluster2.png" alt="image-20231212171504750"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>gitee 仓库创建及上传文件</title>
    <link href="/2025/11/06/gitee-%E4%BB%93%E5%BA%93%E5%88%9B%E5%BB%BA%E5%8F%8A%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/"/>
    <url>/2025/11/06/gitee-%E4%BB%93%E5%BA%93%E5%88%9B%E5%BB%BA%E5%8F%8A%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<p><strong>首先由个gitee的账号</strong><br><strong>git 全局设置</strong></p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs verilog">git <span class="hljs-keyword">config</span> --<span class="hljs-keyword">global</span> user<span class="hljs-variable">.name</span><span class="hljs-string">&quot;名字&quot;</span><br>git <span class="hljs-keyword">config</span> --<span class="hljs-keyword">global</span> user<span class="hljs-variable">.email</span> <span class="hljs-string">&quot;邮箱&quot;</span><br></code></pre></td></tr></table></figure><p><strong>创建git仓库</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> qingfeng<br><span class="hljs-built_in">cd</span> qingfeng<br>git init<br><span class="hljs-built_in">touch</span> README.md<br>git add README.md<br>git commit -m <span class="hljs-string">&quot;first commit&quot;</span><br>git remote add origin https://gitee.com/xbd666/qingfeng.git<br>git push -u origin <span class="hljs-string">&quot;master&quot;</span><br></code></pre></td></tr></table></figure><h1 id="备注：也可以在搜索栏那里直接拉取，就不需要终端命令设置了"><a href="#备注：也可以在搜索栏那里直接拉取，就不需要终端命令设置了" class="headerlink" title="备注：也可以在搜索栏那里直接拉取，就不需要终端命令设置了"></a>备注：也可以在搜索栏那里直接拉取，就不需要终端命令设置了</h1><p><strong>已有仓库的</strong></p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">cd</span> existing_git_repo<br><span class="hljs-symbol">git</span> remote <span class="hljs-keyword">add</span> origin https:<span class="hljs-comment">//gitee.com/xbd666/qingfeng.git</span><br><span class="hljs-symbol">git</span> <span class="hljs-keyword">push</span> -u origin <span class="hljs-string">&quot;master&quot;</span><br></code></pre></td></tr></table></figure><p><strong>拉取</strong></p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git pull origin <span class="hljs-literal">master</span><br></code></pre></td></tr></table></figure><p><strong>上传到仓库</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">git <span class="hljs-built_in">add</span> .<br></code></pre></td></tr></table></figure><p><strong>备注描述</strong></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">git</span> commit -m <span class="hljs-string">&#x27;描述信息&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>上传</strong></p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">git <span class="hljs-built_in">push</span> orign master<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">令牌：<span class="hljs-number">30</span>acd398455f085b72e9d05343177631<br><br>bash &lt;(curl -sSL https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/xbd666/</span>qingfeng<span class="hljs-regexp">/raw/m</span>aster/system_tool.sh)<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>zabbix-proxy配置及邮件配置</title>
    <link href="/2025/11/06/zabbix-proxy%E9%85%8D%E7%BD%AE%E5%8F%8A%E9%82%AE%E4%BB%B6%E9%85%8D%E7%BD%AE/"/>
    <url>/2025/11/06/zabbix-proxy%E9%85%8D%E7%BD%AE%E5%8F%8A%E9%82%AE%E4%BB%B6%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="一、下载配置server，agent端"><a href="#一、下载配置server，agent端" class="headerlink" title="一、下载配置server，agent端"></a>一、下载配置server，agent端</h1><h1 id="下载zabbix-server，server客户端"><a href="#下载zabbix-server，server客户端" class="headerlink" title="下载zabbix-server，server客户端"></a>下载zabbix-server，server客户端</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">备注：zabbix源不能和epel源同时存在，要给epel源注释了</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">更新下载zabbix源</span><br>[root@zabbix-server ~]# rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">更新yum仓库</span><br>[root@zabbix-server ~]# yum clean all<br>[root@zabbix-server ~]# yum repolist<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装</span><br>安装 zabbix rpm 源,鉴于国内网络情况，使用阿里云 zabbix 源<br><span class="hljs-meta prompt_"># </span><span class="language-bash">更换源</span><br>[root@zabbix-server ~]# sed -i &#x27;s#http://repo.zabbix.com#https://mirrors.aliyun.com/zabbix#&#x27; /etc/yum.repos.d/zabbix.repo<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载软件包--用的时5.0版本的</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">如果有冲突用  yum -y remove `rpm -qa zabbix6.0*`</span> <br>[root@zabbix-server ~]# yum install zabbix-server-mysql zabbix-web-mysql zabbix-agent -y<br>[root@zabbix-server ~]# yum install -y zabbix-get.x86_64  #安装zabbix命令工具<br></code></pre></td></tr></table></figure><h1 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">1、安装数据库</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">安装 mariadb.repo</span><br>[root@zabbix-server ~]# yum install -y mariadb mariadb-server<br><span class="hljs-meta prompt_"># </span><span class="language-bash">2、启动数据库</span><br>[root@zabbix-server ~]# systemctl restart mariadb<br>[root@zabbix-server ~]# systemctl enable mariadb<br>[root@zabbix-server ~]# mysqladmin -u root password &#x27;zabbix&#x27;    #设置root密码<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">3、创建数据库并授权账号</span><br>[root@zabbix-server ~]# mysql -uroot -p&#x27;zabbix&#x27;<br>MariaDB [(none)]&gt; create database zabbix character set utf8 collate utf8_bin;  # 创建zabbix数据库<br>MriaDB [(none)]&gt; grant all privileges on zabbix.* to &#x27;zabbix&#x27;@&#x27;localhost&#x27; identified by &#x27;zabbix&#x27;;# 注意授权网段<br>MariaDB [(none)]&gt; flush privileges;           # 刷新授权<br>MariaDB [(none)]&gt; \q   #退出<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">4、导入数据</span><br>[root@zabbix-server ~]# zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix<br>Enter password:                   #输入密码<br></code></pre></td></tr></table></figure><h1 id="配置-server-端"><a href="#配置-server-端" class="headerlink" title="配置 server 端"></a>配置 server 端</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@zabbix-server ~]# cd /etc/zabbix/<br>[root@zabbix-server zabbix]# ls<br>web  zabbix_agentd.conf  zabbix_agentd.d  zabbix_server.conf<br><span class="hljs-meta prompt_">#</span><span class="language-bash">为了方便我们以后恢复，我们把配置文件备份一下</span><br>[root@zabbix-server zabbix]# cp zabbix_server.conf zabbix_server.conf.bak<br>[root@zabbix-server zabbix]# vim zabbix_server.conf<br> DBHost=localhost            #数据库对外的主机<br> DBName=zabbix               #数据库名称<br> DBUser=zabbix               #数据库用户<br> DBPassword=zabbix           #数据库密码<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"> # </span><span class="language-bash">启动zabbix-server</span><br> [root@zabbix-server zabbix]# systemctl start zabbix-server<br>[root@zabbix-server zabbix]# systemctl enable zabbix-server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">验证10051端口有没有起来</span><br>[root@zabbix-server zabbix]# netstat -lntp | grep 10051<br>tcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN      1574/zabbix_server  <br>tcp6       0      0 :::10051                :::*                    LISTEN      1574/zabbix_server<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置 web GUI</span><br>1.启用zabbix前端源，修改vim /etc/yum.repos.d/zabbix.repo，将[zabbix-frontend]下的 enabled 改为 1<br>[root@zabbix-server zabbix]# vim /etc/yum.repos.d/zabbix.repo<br>[zabbix-frontend]     #修改第二个【frontend】<br>...<br>enabled=1    #改为1<br>gpgcheck=0   #改为0<br>gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591<br>...<br>gpg--》都改成0<br><br>2.安装 Software Collections，便于后续安装高版本的 php，默认 yum 安装的 php 版本为 5.4 过低<br>[root@zabbix-server zabbix]# yum install centos-release-scl -y<br>3.安装 zabbix 前端和相关环境<br>[root@zabbix-server zabbix]# yum install zabbix-web-mysql-scl zabbix-apache-conf-scl -y<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">为Zabbix前端配置PHP</span><br>[root@zabbix-server ~]# vim /etc/opt/rh/rh-php72/php-fpm.d/zabbix.conf   #设置时区<br><span class="hljs-meta prompt_">#</span><span class="language-bash">里面基本不用动。只需要添加一行时区即可</span><br>php_value[date.timezone] = Asia/Shanghai       ---添加如下<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动`httpd`服务</span><br>[root@zabbix-server ~]# systemctl restart zabbix-server zabbix-agent httpd rh-php72-php-fpm<br>[root@zabbix-server ~]# systemctl enable zabbix-server zabbix-agent httpd rh-php72-php-fpm<br></code></pre></td></tr></table></figure><h1 id="验证：打开游览器访问"><a href="#验证：打开游览器访问" class="headerlink" title="验证：打开游览器访问"></a>验证：打开游览器访问</h1><p><code>192.168.246.228/zabbix</code>，第一次访问时需要进行一些初始化的设置</p><h1 id="初始账户及密码"><a href="#初始账户及密码" class="headerlink" title="初始账户及密码"></a>初始账户及密码</h1><p><code>user=Admin</code><br><code>password=zabbix</code></p><h1 id="配置agent端"><a href="#配置agent端" class="headerlink" title="配置agent端"></a>配置agent端</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">agent端可以是多台</span><br>[root@zabbix-node1 ~]# rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm<br>[root@zabbix-node1 ~]# yum install zabbix-agent zabbix-sender -y<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">备份配置文件</span><br>[root@zabbix-node1 ~]# cd /etc/zabbix/<br>[root@zabbix-node1 zabbix]# ls<br>zabbix_agentd.conf  zabbix_agentd.d<br>[root@zabbix-node1 zabbix]# cp zabbix_agentd.conf&#123;,.bak&#125;<br>[root@zabbix-node1 zabbix]# ls<br>zabbix_agentd.conf  zabbix_agentd.conf.bak  zabbix_agentd.d<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改配置文件</span><br>[root@zabbix-node1 zabbix]# vim zabbix_agentd.conf   ----修改如下<br>Server=192.168.246.228 zabbix服务器的地址 <br>ServerActive=192.168.246.228 主动模式 zabbix-server-ip <br>Hostname=zabbix-node1 <br>UnsafeUserParameters=1 是否限制用户自定义 keys 使用特殊字符 1是可以启用特殊字符 0是不可以启用特殊字符，是否允许别人执行远程操作命令，默认是禁用的，打开的话会有安全风险.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动agent服务</span><br>[root@zabbix-node1 zabbix]# systemctl start zabbix-agent<br>[root@zabbix-node1 zabbix]# systemctl enable zabbix-agent<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">验证10050端口有没有起来</span><br>[root@zabbix-node1 zabbix]# netstat -lntp | grep 10050<br>tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      9000/zabbix_agentd  <br>tcp6       0      0 :::10050                :::*                    LISTEN      9000/zabbix_agentd<br></code></pre></td></tr></table></figure><p><code>配置完成，此时可以在网址上做配置设置了</code></p><h1 id="修改语言–中文版"><a href="#修改语言–中文版" class="headerlink" title="修改语言–中文版"></a>修改语言–中文版</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">点开Administration--&gt;Users--&gt;Admin--&gt;Language(选择chinese)<br><span class="hljs-meta prompt_"># </span><span class="language-bash">现在界面是中文版的了</span><br></code></pre></td></tr></table></figure><h1 id="修改监控项字体"><a href="#修改监控项字体" class="headerlink" title="修改监控项字体"></a>修改监控项字体</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@zabbix-server ~]# cd /usr/share/zabbix/assets/fonts/<br>[root@zabbix-server fonts]# ls<br>graphfont.ttf<br>[root@zabbix-server fonts]# mv graphfont.ttf graphfont.ttf.bak<br>将本机上的simkai.ttf下载好，传到linunx<br>[root@zabbix-server fonts]# ls<br>graphfont.ttf.bak  simkai.ttf<br>[root@zabbix-server fonts]# mv simkai.ttf graphfont.ttf<br>[root@zabbix-server fonts]# ls<br>graphfont.ttf  graphfont.ttf.bak<br>这个时候监控项里面的字体就已经改好了<br></code></pre></td></tr></table></figure><h1 id="界面创建流程"><a href="#界面创建流程" class="headerlink" title="界面创建流程"></a>界面创建流程</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">监控方面，先创建一个主机（host），在创建一个监控项(item)用于采集数据。告警方面，在监控项里创建触发器（trigger），通过触发器（trigger）来触发告警动作（action）<br></code></pre></td></tr></table></figure><h1 id="二、自定义key"><a href="#二、自定义key" class="headerlink" title="二、自定义key"></a>二、自定义key</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">修改配置文件，把查找参数的命令设为用户参数</span><br>[root@zabbix-node1 ~]# cd /etc/zabbix/zabbix_agentd.d/<br>[root@zabbix-node1 zabbix_agentd.d]# vim memory_usage.conf<br>UserParameter=memory.used,free | awk &#x27;/^Mem/&#123;print $3&#125;&#x27;<br>UserParameter=定义的key，查看的命令语句<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启agent服务</span><br>[root@zabbix-node1 zabbix_agentd.d]# systemctl restart zabbix-agent.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在zabbix-server 端，查询验证</span><br>[root@zabbix-server fonts]# zabbix_get -s 192.168.246.226 -p 10050 -k &quot;memory.used&quot;<br>如果可以验证到结果，就可以到web界面去设置参数，启动监控了<br></code></pre></td></tr></table></figure><p><code>web界面先在设置里创建主机组--模板--创建主机----配置应用集--监控项--设置自定义监控项</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">也可以指定参数--传参</span><br>[root@zabbix-node1 ~]# cd /etc/zabbix/zabbix_agentd.d/<br>[root@zabbix-node1 zabbix_agentd.d]# vim memory_usage.conf<br>UserParameter=memory.stats[*],cat /proc/meminfo | awk &#x27;/^$1/&#123;print $$2&#125;&#x27;     --添加到文件中注意去掉反斜杠<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启agent服务</span><br>[root@zabbix-node1 zabbix_agentd.d]# systemctl restart zabbix-agent.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在zabbix-server 端，查询使用这个用户参数的key</span><br>传参:<br>[root@zabbix-server fonts]# zabbix_get -s 192.168.246.226 -p 10050 -k &quot;memory.stats[MemTotal]&quot;<br>999696<br>[root@zabbix-server fonts]# zabbix_get -s 192.168.246.226 -p 10050 -k &quot;memory.stats[Cache]&quot;<br>243832<br>[root@zabbix-server fonts]# zabbix_get -s 192.168.246.226 -p 10050 -k &quot;memory.stats[Buffer]&quot;<br>2108<br></code></pre></td></tr></table></figure><h1 id="三、网络发现-自动发现"><a href="#三、网络发现-自动发现" class="headerlink" title="三、网络发现(自动发现)"></a>三、网络发现(自动发现)</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装agent 段的包</span><br>[root@zabbix-node2 ~]# yum -y install zabbix-agent zabbix-sender<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置agent 配置，可以把之前设置好的node1的配置传过来</span><br>[root@zabbix-node2 ~]# vim /etc/zabbix/zabbix_agentd.conf<br>Hostname=zabbix-node2 #只需修改hostname<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">visudo赋予权限</span><br>[root@zabbix-node2 ~]# visudo       #修改sudo的配置,添加如下信息<br><span class="hljs-meta prompt_">#</span><span class="language-bash">Defaults !visiblepw</span><br><br>93 zabbix ALL=(ALL) NOPASSWD: ALL<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动服务</span><br>[root@zabbix-node2 ~]# systemctl start zabbix-agent<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在server端验证</span><br>[root@zabbix-server ~]# zabbix_get -s 192.168.246.227 -p 10050 -k &quot;system.hostname&quot;<br>zabbix-agent-none2<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">到web网址界面操作</span><br>配置--自动发现--自动发现规则--。。。<br></code></pre></td></tr></table></figure><h1 id="四、zabbix-proxy分布式监控"><a href="#四、zabbix-proxy分布式监控" class="headerlink" title="四、zabbix-proxy分布式监控"></a>四、zabbix-proxy分布式监控</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">需要对时，保证两台机器的时间一致</span><br>- ntpdate 192.168.198.156 制作时间服务器<br>[root@zabbix-server ~]# yum install -y ntp<br>[root@zabbix-server ~]# vim /etc/ntp.conf  #有4行server的位置，把那4行server行注释掉，填写以下两行<br>server 127.127.1.0 # local clock<br>fudge  127.127.1.0 stratum 10<br>[root@zabbix-server ~]#  systemctl start ntpd<br>[root@zabbix-server ~]#  systemctl enable ntpd<br>同步时间<br>[root@zabbix-proxy ~]# yum install -y ntpdate<br>[root@zabbix-proxy ~]# ntpdate 192.168.198.156<br><br>[root@zabbix-node2 ~]# yum install -y ntpdate<br>[root@zabbix-node2 ~]# ntpdate 192.168.198.156<br><br>- 关闭防火墙，selinux<br>- 设置主机名 hostnamectl set-hostname zabbix-proxy<br>[root@localhost ~]# hostnamectl set-hostname zabbix-proxy<br><br>- vim /etc/hosts 每个机器都设置hosts，以解析主机名；<br>监控端<br>[root@zabbix-server ~]# cat /etc/hosts<br>192.168.198.156 zabbix-server<br>192.168.198.158 zabbix-node2<br>192.168.198.159 zabbix-proxy<br><br>代理端<br>[root@zabbix-proxy ~]# cat /etc/hosts<br>192.168.198.156 zabbix-server<br>192.168.198.158 zabbix-node2<br>192.168.198.159 zabbix-proxy<br><br>被监控端<br>[root@zabbix-node2 ~]# cat /etc/hosts<br>192.168.198.156 zabbix-server<br>192.168.198.158 zabbix-node2<br>192.168.198.159 zabbix-proxy<br><br>| 机器名称      | IP配置          | 服务角色  |<br>| ------------- | --------------- | --------- |<br>| zabbix-server | 192.168.198.156 | 监控      |<br>| zabbix-node1  | 192.168.198.157 | 被监控端  |<br>| zabbix-node2  | 192.168.198.158 | 被监控端  |<br>| zabbix-proxy  | 192.168.198.159 | 代理proxy |<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在 zabbix-proxy 上配置 mysql</span><br>[root@zabbix-proxy ~]# yum install -y mariadb mariadb-server<br>[root@zabbix-proxy ~]# systemctl start mariadb<br>[root@zabbix-proxy ~]# mysqladmin -uroot password &#x27;zabbix&#x27;<br>[root@zabbix-proxy ~]# mysql -uroot -p&#x27;zabbix&#x27;<br>MariaDB [(none)]&gt; create database proxydb character set &#x27;utf8&#x27;;<br>MariaDB [(none)]&gt; grant all on proxydb.* to &#x27;proxy&#x27;@&#x27;localhost&#x27; identified by &#x27;zabbix&#x27;;<br>MariaDB [(none)]&gt; flush privileges;<br>MariaDB [(none)]&gt; \q<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在 zabbix-proxy上下载zabbix 相关的包，主要是代理proxy的包</span><br>[root@zabbix-server ~]# scp /etc/yum.repos.d/zabbix.repo 192.168.198.159:/etc/yum.repos.d/<br>编辑zabbix.repo源将里面的gpgcheck关闭<br>[root@zabbix-proxy ~]# yum -y install zabbix-proxy-mysql zabbix-get zabbix-agent zabbix-sender<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">将zabbix-proxy-mysql包里面的数据导入数据库中</span><br>[root@zabbix-proxy ~]# cp /usr/share/doc/zabbix-proxy-mysql-5.0.3（版本号）/schema.sql.gz ./<br>[root@zabbix-proxy ~]# ls<br>anaconda-ks.cfg  schema.sql.gz<br>[root@zabbix-proxy ~]# gzip -d schema.sql.gz <br>[root@zabbix-proxy ~]# ls<br>anaconda-ks.cfg  schema.sql<br>[root@zabbix-proxy ~]# mysql -uroot -p proxydb &lt; schema.sql <br>Enter password:<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置proxy端</span><br>[root@zabbix-proxy ~]# vim /etc/zabbix/zabbix_proxy.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">proxyMode=0  <span class="hljs-comment">#默认是主动模式（0是主动模式，1是被动模式）</span></span><br>Server=192.168.198.156        # server端 的IP<br>ServerPort=10051             # server端 的端口<br><br>Hostname=zabbix-proxy        # 主机名<br>ListenPort=10051             # proxy自己的监听端口<br>EnableRemoteCommands=1       # 允许远程命令<br>LogRemoteCommands=1          # 记录远程命令的日志<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">数据的配置</span><br>DBHost=localhost<br>DBName=proxydb<br>DBUser=proxy<br>DBPassword=zabbix<br><br>ConfigFrequency=30      # 多长时间，去服务端拖一次有自己监控的操作配置；为了实验更快的生效，这里设置30秒，默认3600s<br>DataSenderFrequency=1   # 每一秒向server 端发一次数据，发送频度<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动proxy服务</span><br>[root@zabbix-proxy ~]# systemctl start zabbix-proxy<br><br>[root@zabbix-proxy ~]# netstat -lntp | grep 10051<br>tcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN      15798/zabbix_proxy  <br>tcp6       0      0 :::10051                :::*                    LISTEN      15798/zabbix_proxy<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置agent端允许proxy代理监控</span><br>[root@zabbix-agent ~]#  vim /etc/zabbix/zabbix_agentd.conf---添加proxy的ip地址<br>Server=192.168.198.156,192.168.198.159<br>ServerActive=192.168.198.156,192.168.198.159<br>Hostname=zabbix-node2<br>[root@zabbix-agent ~]#  systemctl restart zabbix-agent #启动服务<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在web网址上配置</span><br>管理--agent代理程序--agent代理程序（要与配置文件中应以的一样）--添加--配置--主机--选好主机名称--已启用那里打开zabbix proxy<br></code></pre></td></tr></table></figure><h1 id="五、配置发送邮件"><a href="#五、配置发送邮件" class="headerlink" title="五、配置发送邮件"></a>五、配置发送邮件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment">#server服务器端</span></span><br>安装MUA软件：mailx<br>[root@zabbix-server ~]#  yum install mailx -y<br>[root@zabbix-server ~]# mailx -V <br>12.5 7/5/10<br>注：使用新的方式--利用公网邮件服务器发送报警，需要关闭postfix服务<br>[root@zabbix-server ~]# systemctl stop postfix<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置公网邮箱信息：</span><br>[root@zabbix-server ~]# vim /etc/mail.rc  ---在最后添加如下：<br>set from=12345678@163.com（邮箱地址） <br> set smtp=smtp.163.com（smtp服务器） <br> set smtp-auth-user=12345678@163.com(用户名) <br> set smtp-auth-password=qf123456（这里是邮箱的授权密码） <br> set smtp-auth=login<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_"> # </span><span class="language-bash">阿里云服务器--需要配置证书</span><br><span class="hljs-meta prompt_"> # </span><span class="language-bash">一、请求数字证书</span><br>mkdir -p /root/.certs/ ####创建目录，用来存放证书<br>echo -n | openssl s_client -connect smtp.163.com:465 | sed -ne &#x27;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#x27; &gt; ~/.certs/163.crt ####向163请求证书<br>certutil -A -n &quot;GeoTrust SSL CA&quot; -t &quot;C,,&quot; -d ~/.certs -i ~/.certs/163.crt ####添加一个SSL证书到证书数据库中<br>certutil -A -n &quot;GeoTrust Global CA&quot; -t &quot;C,,&quot; -d ~/.certs -i ~/.certs/163.crt ####添加一个Global 证书到证书数据库中<br>certutil -L -d /root/.certs ####列出目录下证书<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">二、配置发件人</span><br>[root@zabbix-server ~]# vim /etc/mail.rc  ---在最后添加如下：<br>set bsdcompat<br>set from=xxxxxx@163.com<br>set smtp=smtps://smtp.163.com:465<br>set smtp-auth-user=xxxxxx@163.com<br>set smtp-auth-password=xxxxxxx #此密码为第三方登录密码<br>set smtp-auth=login<br>set ssl-verify=ignore<br>set nss-config-dir=/root/.certs<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">三、测试</span><br>echo “test” | mail -s “zabbix” xxxxxxx@qq.com<br>登陆收件人邮箱查看<br>看似成功但是linux中报错：证书不被信任<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">四、解决最后一个问题-----证书不被信任</span><br>cd /root/.certs/<br>certutil -A -n &quot;GeoTrust SSL CA - G3&quot; -t &quot;Pu,Pu,Pu&quot; -d ./ -i 163.crt<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">成功标志：</span><br>Notice: Trust flag u is set automatically if the private key is present.<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># 发送邮箱方式</span></span><br>方式1：echo &quot;正文内容&quot; | mailx -s &quot;邮件标题&quot; 收件箱Email<br>方式2：mailx -s &quot;邮件标题&quot; 收件箱Email，回车按CTRL+D发送<br>参数：<br>-v ：显示发送的详细信息<br><br>手动发送邮件测试：<br>[root@zabbix-server ~]# mailx -v -s &#x27;hello&#x27; &#x27;zhangsan@163.com&#x27;<br>手写邮件内容 （回车，然后ctrl+D正常结束)<br>[root@zabbix-server ~]# mailx -v -s &#x27;hello&#x27; &#x27;zhangsan@163.com&#x27;<br>nihao<br>EOT<br>Resolving host smtp.163.com . . . done.<br>Connecting to 123.126.97.2:smtp . . . connected.<br>220 163.com Anti-spam GT for Coremail System (163com[20141201])<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; EHLO zabbix-server</span><br>250-mail<br>250-PIPELINING<br>250-AUTH LOGIN PLAIN <br>250-AUTH=LOGIN PLAIN<br>250-coremail 1Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2UFeF38eUCa0xDrUUUUj<br>250-STARTTLS<br>250 8BITMIME<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; AUTH LOGIN</span><br>334 dXNlcm5hbWU6<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; bHd4MTgzNjYwMTkzNTZAMTYzLmNvbQ==</span><br>334 UGFzc3dvcmQ6<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; bHd4MTgzNjYwMTkzNTY=</span><br>235 Authentication successful<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; MAIL FROM:&lt;lwx18366019356@163.com&gt;</span><br>250 Mail OK<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; RCPT TO:&lt;lwx18366019356@163.com&gt;</span><br>250 Mail OK<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; DATA</span><br>354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; .</span><br>250 Mail OK queued as smtp2,GtxpCgDXkqTEFERdskSAAA--.825S2 1564742867<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">&gt;&gt; QUIT</span><br>221 Bye<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">此时终端配置完成，在web网址上操作</span><br>配置 zabbix 的邮件报警功能需要以下三个角色的参与<br>注：脚本名称任意，存放于/usr/lib/zabbix/alertscripts ----路径可以改<br><br>名称：sendmail                   //名称任意<br>类型：脚本<br>脚本名称：sendmail.sh      <br>脚本参数：                          //一定要写，否则可能发送不成功<br>    &#123;ALERT.SENDTO&#125;              //照填，收件人变量<br>    &#123;ALERT.SUBJECT&#125;             //照填，邮件主题变量，变量值来源于‘动作’中的‘默认接收人’<br>    &#123;ALERT.MESSAGE&#125;           //照填，邮件正文变量，变量值来源于‘动作’中的‘默认信息’<br><br>配置完成后,不要忘记点击存档,保存你的配置。       <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">步骤</span><br>管理--报警媒介类型--名称（邮件报警）--类型（脚本）--脚本名字（要和终端上脚本名称的一致）--脚本参数（3个，上面模板）--添加<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改zabbix服务端配置文件＆编写脚本：指定脚本的存储路径:</span><br>[root@zabbix-server ~]# vim /etc/zabbix/zabbix_server.conf<br>AlertScriptsPath=/usr/lib/zabbix/alertscripts  #打开注释，核对路径，也可以修改路径<br><br>`编写邮件脚本:`<br>[root@zabbix-server ~]# cd /usr/lib/zabbix/alertscripts/<br>[root@zabbix-server alertscripts]# vim sendmail.sh   <br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/sh</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">export.UTF-8</span><br>echo &quot;$3&quot; | sed s/&#x27;\r&#x27;//g | mailx -s &quot;$2&quot; $1<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">1:接受者的邮箱地址：sendto</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">2:邮件的主题：subject</span><br><span class="hljs-meta prompt_">$</span><span class="language-bash">3:邮件内容：message</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改权限 及更用户和组：</span><br>[root@zabbix-server alertscripts]# chmod u+x sendmail.sh &amp;&amp; chown zabbix.zabbix sendmail.sh<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">返回web界面操作</span><br>管理--用户--Admin--报警媒介--添加类型（邮件报警）--填写收件人--点击更新------触发器（填写名称，严重性，表达式）--点添加------动作--点触发动作--填写名称--触发条件（触发器）--点操作--选择时间--标题及内容（填写西面的模板）<br><br>默认信息：邮件的主题<br><br>Problem:&#123;TRIGGER.NAME&#125;<br><br>故障恢复: &#123;TRIGGER.NAME&#125;<br><br>主机: &#123;HOST.NAME1&#125;<br>时间: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;<br>级别: &#123;TRIGGER.SEVERITY&#125;<br>触发: &#123;TRIGGER.NAME&#125;<br>详情: &#123;ITEM.NAME1&#125;:&#123;ITEM.KEY1&#125;:&#123;ITEM.VALUE1&#125;<br>状态: &#123;TRIGGER.STATUS&#125;<br>项目：&#123;TRIGGER.KEY1&#125; <br>事件ID：&#123;EVENT.ID&#125;<br></code></pre></td></tr></table></figure><h1 id="六、配置钉钉报警"><a href="#六、配置钉钉报警" class="headerlink" title="六、配置钉钉报警"></a>六、配置钉钉报警</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">钉钉需要创建公司名称，建团队群</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ELK+kafka+filebeat 集群部署</title>
    <link href="/2025/11/06/ELK-kafka-filebeat-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/ELK-kafka-filebeat-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">Elasticsearch: 7.13.2 #wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.13.2-linux-x86_64.tar.gz<br>Logstash: 7.13.2 #wget https://artifacts.elastic.co/downloads/logstash/logstash-7.13.2-linux-x86_64.tar.gz<br>Kibana: 7.13.2 #wget https://artifacts.elastic.co/downloads/kibana/kibana-7.13.2-linux-x86_64.tar.gz<br>Kafka: 2.11-2.1  #wget https://archive.apache.org/dist/kafka/2.1.0/kafka_2.11-2.1.0.tgz<br>Filebeat: 7.13.2<br>相应的版本最好下载对应的插件<br></code></pre></td></tr></table></figure><p><strong>相关地址：</strong></p><p>官网地址：<a href="https://www.elastic.co/">https://www.elastic.co</a></p><p>官网搭建：<a href="https://www.elastic.co/guide/index.html">https://www.elastic.co/guide/index.html</a></p><h2 id="实施部署"><a href="#实施部署" class="headerlink" title="实施部署"></a>实施部署</h2><p>关闭防火墙，关闭setenforce</p><h2 id="1、安装配置jdk8"><a href="#1、安装配置jdk8" class="headerlink" title="1、安装配置jdk8"></a>1、安装配置jdk8</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">三台机器都操作，安装jdk（java）<br>[root@mes-1 ~]# tar xzf jdk-8u191-linux-x64.tar.gz -C /usr/local/<br>[root@mes-1 ~]# cd /usr/local/<br>[root@mes-1 local]# mv jdk1.8.0_191/ java<br>[root@mes-1 local]# echo &#x27;<br>JAVA_HOME=/usr/local/java<br>PATH=$JAVA_HOME/bin:$PATH<br>export JAVA_HOME PATH<br>&#x27; &gt;&gt;/etc/profile<br>[root@mes-1 ~]# source /etc/profile<br>[root@mes-1 ~]# java -version<br></code></pre></td></tr></table></figure><h2 id="2、安装配置ES—-只在第一台操作操作下面的部分"><a href="#2、安装配置ES—-只在第一台操作操作下面的部分" class="headerlink" title="2、安装配置ES—-只在第一台操作操作下面的部分"></a>2、安装配置ES—-只在第一台操作操作下面的部分</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">创建运行ES的普通用户<br>[root@mes-1 ~]# useradd elsearch<br>[root@mes-1 ~]# echo &quot;123456&quot; | passwd --stdin &quot;elsearch&quot;<br>================<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果是集群三台机器都操作</span><br></code></pre></td></tr></table></figure><h2 id="安装配置ES–如果是集群三台机器都操作"><a href="#安装配置ES–如果是集群三台机器都操作" class="headerlink" title="安装配置ES–如果是集群三台机器都操作"></a>安装配置ES–如果是集群三台机器都操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 ~]# tar xzf elasticsearch-6.5.4.tar.gz -C /usr/local/<br>[root@mes-1 ~]# cd /usr/local/elasticsearch-6.5.4/config/<br>[root@mes-1 config]# ls<br>elasticsearch.yml  log4j2.properties  roles.yml  users_roles<br>jvm.options        role_mapping.yml   users<br>[root@mes-1 config]# cp elasticsearch.yml elasticsearch.yml.bak<br>[root@mes-1 config]# vim elasticsearch.yml    ----找个地方添加如下内容<br>cluster.name: elk<br>cluster.initial_master_nodes: [&quot;192.168.246.234&quot;,&quot;192.168.246.231&quot;,&quot;192.168.246.235&quot;]#写所有的IP地址<br>node.name: elk01#修改，自定义名字<br>node.master: true<br>node.data: true<br>path.data: /data/elasticsearch/data<br>path.logs: /data/elasticsearch/logs<br>bootstrap.memory_lock: false<br>bootstrap.system_call_filter: false<br>network.host: 0.0.0.0<br>http.port: 9200<br>transport.tcp.port: 9300<br>discovery.seed_hosts: [&quot;192.168.246.234&quot;, &quot;192.168.246.235&quot;]#改自己的另外两台IP<br>discovery.zen.minimum_master_nodes: 2<br>discovery.zen.ping_timeout: 150s<br>discovery.zen.fd.ping_retries: 10<br>client.transport.ping_timeout: 60s<br>http.cors.enabled: true<br>http.cors.allow-origin: &quot;*&quot;<br><br><br>单节点配置<br>cluster.name: elk<br>cluster.initial_master_nodes: [&quot;10.36.153.131&quot;] #单机只写本机ip<br>node.name: elk01#自定义名字<br>node.master: true<br>node.data: true<br>path.data: /data/elasticsearch/data<br>path.logs: /data/elasticsearch/logs<br>bootstrap.memory_lock: false<br>bootstrap.system_call_filter: false<br>network.host: 10.36.153.131 #单机只写本机ip<br>http.port: 9200<br>transport.tcp.port: 9300<br>discovery.seed_hosts: [&quot;10.36.153.131&quot;] #单机只写本机ip<br><span class="hljs-meta prompt_">#</span><span class="language-bash">discovery.zen.minimum_master_nodes: 2</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">discovery.zen.ping_timeout: 150s</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">discovery.zen.fd.ping_retries: 10</span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">client.transport.ping_timeout: 60s</span><br>http.cors.enabled: true<br>http.cors.allow-origin: &quot;*&quot;<br></code></pre></td></tr></table></figure><h2 id="设置JVM堆大小—-如果是集群三台机器都操作"><a href="#设置JVM堆大小—-如果是集群三台机器都操作" class="headerlink" title="设置JVM堆大小—#如果是集群三台机器都操作"></a>设置JVM堆大小—#如果是集群三台机器都操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 config]# vim jvm.options     ----配置文件里修改<br>-Xms1g    ----修改成 -Xms2g<br>-Xmx1g    ----修改成 -Xms2g<br><br>或者:<br>推荐设置为4G，请注意下面的说明：<br>sed -i &#x27;s/-Xms1g/-Xms4g/&#x27; /usr/local/elasticsearch-6.5.4/config/jvm.options<br>sed -i &#x27;s/-Xmx1g/-Xmx4g/&#x27; /usr/local/elasticsearch-6.5.4/config/jvm.options<br><br>堆内存大小不要超过系统内存的50%<br></code></pre></td></tr></table></figure><h2 id="创建ES数据及日志存储目录"><a href="#创建ES数据及日志存储目录" class="headerlink" title="创建ES数据及日志存储目录"></a>创建ES数据及日志存储目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 ~]# mkdir -p /data/elasticsearch/data       (/data/elasticsearch)<br>[root@mes-1 ~]# mkdir -p /data/elasticsearch/logs       (/log/elasticsearch)<br></code></pre></td></tr></table></figure><h2 id="修改安装目录及存储目录权限"><a href="#修改安装目录及存储目录权限" class="headerlink" title="修改安装目录及存储目录权限"></a>修改安装目录及存储目录权限</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 ~]# chown -R elsearch:elsearch /data/elasticsearch<br>[root@mes-1 ~]# chown -R elsearch:elsearch /usr/local/elasticsearch-7.13.2<br></code></pre></td></tr></table></figure><h2 id="3、系统优化"><a href="#3、系统优化" class="headerlink" title="3、系统优化"></a>3、系统优化</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">增加最大文件打开数<br>永久生效方法：----`看情况做，可不做`<br>echo &quot;* - nofile 65536&quot; &gt;&gt; /etc/security/limits.conf<br></code></pre></td></tr></table></figure><h2 id="增加最大进程数"><a href="#增加最大进程数" class="headerlink" title="增加最大进程数"></a>增加最大进程数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 ~]# vim /etc/security/limits.conf    ---在文件最后面添加如下内容<br>* soft nofile 65536<br>* hard nofile 131072<br>* soft nproc 2048<br>* hard nproc 4096<br>* hard nofile 65536<br>* hard nofile 65536<br>更多的参数调整可以直接用这个<br></code></pre></td></tr></table></figure><h2 id="增加最大内存映射数"><a href="#增加最大内存映射数" class="headerlink" title="增加最大内存映射数"></a>增加最大内存映射数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 ~]# vim /etc/sysctl.conf   ---添加如下<br>vm.max_map_count=262144<br>vm.swappiness=0<br>[root@mes-1 ~]# sysctl -p#看情况做，可不做<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">设置内存权限大小</span><br>[root@mes-1 ~]# sysctl -w vm.max_map_count=262144<br></code></pre></td></tr></table></figure><h2 id="4、启动ES"><a href="#4、启动ES" class="headerlink" title="4、启动ES"></a>4、启动ES</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash">如果是集群三台机器都启动</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">切换到不同用户启动</span> <br>`启动的时候一台机器一台机器的启动`<br>[root@mes-1 ~]# su - elsearch<br>Last login: Sat Aug  3 19:48:59 CST 2019 on pts/0<br><br>[root@mes-1 ~]$ cd /usr/local/elasticsearch-6.5.4/<br>[root@mes-1 elasticsearch-6.5.4]$ ./bin/elasticsearch  #先启动看看报错不，需要多等一会<br><br>`ctrl+c终止之后,启动后台运行`<br>[root@mes-1 elasticsearch-6.5.4]$ nohup ./bin/elasticsearch &amp;  #放后台启动<br>[1] 11462<br>nohup: ignoring input and appending output to ‘nohup.out’<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看9200、9300端口有没有起来</span><br>[root@mes-1 elasticsearch-6.5.4]$ netstat -lnpt<br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看日志</span><br>[root@mes-1 elasticsearch-6.5.4]$ tail -f nohup.out   #看一下是否启动<br>或者:<br>su - elsearch -c &quot;cd /usr/local/elasticsearch-6.5.4 &amp;&amp; nohup bin/elasticsearch &amp;&quot;<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><code>以上步骤三台机器都操作</code></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">浏览器访问http://172.16.246.234:9200<br><span class="hljs-meta prompt_"># </span><span class="language-bash">三台机器都可以访问，加端口9200</span><br></code></pre></td></tr></table></figure><h2 id="5-安装配置head监控插件（Web前端）—-只需要安装一台就可以了"><a href="#5-安装配置head监控插件（Web前端）—-只需要安装一台就可以了" class="headerlink" title="5.安装配置head监控插件（Web前端）—-只需要安装一台就可以了"></a>5.安装配置head监控插件（Web前端）—-只需要安装一台就可以了</h2><p>192.168.246.235</p><p>安装node</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# wget https://npm.taobao.org/mirrors/node/v14.15.3/node-v14.15.3-linux-x64.tar.gz<br>[root@es-3-head-kib ~]# tar xzvf node-v14.15.3-linux-x64.tar.gz -C /usr/local/<br>[root@es-3-head-kib ~]# vim /etc/profile   #添加如下变量<br>NODE_HOME=/usr/local/node-v14.15.3-linux-x64<br>PATH=$NODE_HOME/bin:$PATH<br>export NODE_HOME PATH<br>[root@es-3-head-kib ~]# source /etc/profile<br>[root@es-3-head-kib ~]# node --version  #检查node版本号<br>v14.15.3<br></code></pre></td></tr></table></figure><h2 id="下载head插件"><a href="#下载head插件" class="headerlink" title="下载head插件"></a>下载head插件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# wget https://github.com/mobz/elasticsearch-head/archive/master.zip<br>[root@es-3-head-kib ~]# unzip -d /usr/local/ master.zip<br>[root@es-3-head-kib ~]# cd /usr/local<br>或者<br>unzip –d /usr/local elasticsearch-head-master.zip<br></code></pre></td></tr></table></figure><h2 id="安装grunt"><a href="#安装grunt" class="headerlink" title="安装grunt"></a>安装grunt</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# cd elasticsearch-head-master/<br>[root@mes-3-head-kib elasticsearch-head-master]# npm config set registry https://registry.npm.taobao.org  #更换一个镜像，如果不更换下载会很慢<br>[root@mes-3-head-kib elasticsearch-head-master]# npm install -g grunt-cli  #时间会很长<br>[root@es-3-head-kib elasticsearch-head-master]# grunt --version  #检查grunt版本号<br></code></pre></td></tr></table></figure><h2 id="修改head源码"><a href="#修改head源码" class="headerlink" title="修改head源码"></a>修改head源码</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib elasticsearch-head-master]# vim /usr/local/elasticsearch-head-master/Gruntfile.js    #（95左右）<br>添加--hostname: &#x27;*&#x27;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">注意在上一行末尾添加逗号,hostname 不需要添加逗号</span><br><br>[root@es-3-head-kib elasticsearch-head-master]# vim /usr/local/elasticsearch-head-master/_site/app.js        #(4359左右)<br>原本是http://localhost:9200--http://192.168.116.111:9200<br><span class="hljs-meta prompt_"># </span><span class="language-bash">如果<span class="hljs-built_in">head</span>和ES不在同一个节点，注意修改成ES的IP地址</span><br></code></pre></td></tr></table></figure><h2 id="下载head必要的文件"><a href="#下载head必要的文件" class="headerlink" title="下载head必要的文件"></a>下载head必要的文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# wget https://github.com/Medium/phantomjs/releases/download/v2.1.1/phantomjs-2.1.1-linux-x86_64.tar.bz2<br>[root@es-3-head-kib ~]# yum -y install bzip2<br>[root@es-3-head-kib ~]# tar -jxf phantomjs-2.1.1-linux-x86_64.tar.bz2 -C /tmp/  #解压<br></code></pre></td></tr></table></figure><h2 id="运行head"><a href="#运行head" class="headerlink" title="运行head"></a>运行head</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# cd /usr/local/elasticsearch-head-master/<br>[root@es-3-head-kib elasticsearch-head-master]# npm config set registry https://registry.npm.taobao.org  #先执行这条命令更换一个镜像<br>[root@es-3-head-kib elasticsearch-head-master]# npm install<br>...<br>grunt-contrib-jasmine@1.0.3 node_modules/grunt-contrib-jasmine<br>├── sprintf-js@1.0.3<br>├── lodash@2.4.2<br>├── es5-shim@4.5.13<br>├── chalk@1.1.3 (escape-string-regexp@1.0.5, supports-color@2.0.0, ansi-styles@2.2.1, strip-ansi@3.0.1, has-ansi@2.0.0)<br>├── jasmine-core@2.99.1<br>├── rimraf@2.6.3 (glob@7.1.4)<br>└── grunt-lib-phantomjs@1.1.0 (eventemitter2@0.4.14, semver@5.7.0, temporary@0.0.8, phan<br><br>如果报错执行：npm install phantomjs-prebuilt@2.1.16 --ignore-scripts<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">后台运行</span><br>[root@es-3-head-kib elasticsearch-head-master]# nohup grunt server &amp;<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">清理缓存</span><br>echo 3 &gt; /proc/sys/vm/drop_caches<br></code></pre></td></tr></table></figure><h2 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h2><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># web访问安装node，head，grunt的机器IP地址</span><br>访问http<span class="hljs-punctuation">:</span><span class="hljs-comment">//172.16.246.235:9100</span><br></code></pre></td></tr></table></figure><h2 id="Kibana部署"><a href="#Kibana部署" class="headerlink" title="Kibana部署"></a>Kibana部署</h2><p>系统类型：Centos7.5<br>节点IP：192.168.246.235 D<br>软件版本：nginx-1.14.2、kibana-6.5.4-linux-x86_64.tar.gz</p><h2 id="1-安装配置Kibana"><a href="#1-安装配置Kibana" class="headerlink" title="1. 安装配置Kibana"></a>1. 安装配置Kibana</h2><h2 id="（1）安装"><a href="#（1）安装" class="headerlink" title="（1）安装"></a>（1）安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# tar zvxf kibana-6.5.4-linux-x86_64.tar.gz -C /usr/local/<br></code></pre></td></tr></table></figure><h2 id="（2）配置"><a href="#（2）配置" class="headerlink" title="（2）配置"></a>（2）配置</h2><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">[root@es<span class="hljs-number">-3</span>-head-kib ~]<span class="hljs-meta"># cd /usr/local/kibana-7.13.2-linux-x86_64/config/</span><br>[root@es<span class="hljs-number">-3</span>-head-kib config]<span class="hljs-meta"># vim kibana.yml</span><br><span class="hljs-symbol">server.port:</span> <span class="hljs-number">5601</span><br><span class="hljs-symbol">server.host:</span> <span class="hljs-string">&quot;192.168.246.235&quot;</span><span class="hljs-meta">#本机的IP</span><br><span class="hljs-symbol">elasticsearch.hosts:</span> [<span class="hljs-string">&quot;http://192.168.246.234:9200&quot;</span>]<span class="hljs-meta">#节点的IP（随便哪个都可以）</span><br><span class="hljs-symbol">kibana.index:</span> <span class="hljs-string">&quot;.kibana&quot;</span><br><span class="hljs-symbol">i18n.locale:</span> <span class="hljs-string">&quot;zh-CN&quot;</span><br></code></pre></td></tr></table></figure><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib config]# cd ..<br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动后台运行</span><br>[root@es-3-head-kib kibana-7.13.2-linux-x86_64]# nohup ./bin/kibana --allow-root &amp;<br>[1] 12054<br>[root@es-3-head-kib kibana-7.13.2-linux-x86_64]# nohup: ignoring input and appending output to ‘nohup.out’#此为显示内容<br></code></pre></td></tr></table></figure><h2 id="2-安装配置Nginx反向代理"><a href="#2-安装配置Nginx反向代理" class="headerlink" title="2. 安装配置Nginx反向代理"></a>2. 安装配置Nginx反向代理</h2><h2 id="配置YUM源："><a href="#配置YUM源：" class="headerlink" title="配置YUM源："></a>配置YUM源：</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm<br></code></pre></td></tr></table></figure><h2 id="安装："><a href="#安装：" class="headerlink" title="安装："></a>安装：</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# yum install -y nginx <br></code></pre></td></tr></table></figure><h2 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# cd /etc/nginx/conf.d/<br>[root@es-3-head-kib conf.d]# cp default.conf nginx.conf<br>[root@es-3-head-kib conf.d]# mv default.conf default.conf.bak<br>[root@es-3-head-kib conf.d]# vim nginx.conf<br><span class="hljs-meta prompt_"># </span><span class="language-bash">配置文件内容</span><br>[root@es-3-head-kib conf.d]# cat nginx.conf<br>server &#123;<br>        listen       80;<br>        server_name  192.168.246.235;<br><br>        #charset koi8-r;<br><br>       # access_log  /var/log/nginx/host.access.log  main;<br>       # access_log off;<br><br>         location / &#123;  <br>             proxy_pass http://192.168.246.235:5601;<br>             proxy_set_header Host $host:5601;  <br>             proxy_set_header X-Real-IP $remote_addr;  <br>             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  <br>             proxy_set_header Via &quot;nginx&quot;;  <br>                     &#125;<br><br>         location /head/&#123;<br>             proxy_pass http://192.168.246.235:9100;<br>             proxy_set_header Host $host:9100;<br>             proxy_set_header X-Real-IP $remote_addr;<br>             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>             proxy_set_header Via &quot;nginx&quot;;<br>                         &#125;  <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">1.将原来的log_format注释掉，添加json格式的配置信息，如下：<br>[root@es-3-head-kib conf.d]# vim /etc/nginx/nginx.conf<br>log_format  json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;<br>                           &#x27;&quot;@version&quot;:&quot;1&quot;,&#x27;<br>                           &#x27;&quot;client&quot;:&quot;$remote_addr&quot;,&#x27;<br>                           &#x27;&quot;url&quot;:&quot;$uri&quot;,&#x27;<br>                           &#x27;&quot;status&quot;:&quot;$status&quot;,&#x27;<br>                           &#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;<br>                           &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;<br>                           &#x27;&quot;size&quot;:$body_bytes_sent,&#x27;<br>                           &#x27;&quot;responsetime&quot;:$request_time,&#x27;<br>                           &#x27;&quot;referer&quot;: &quot;$http_referer&quot;,&#x27;<br>                           &#x27;&quot;ua&quot;: &quot;$http_user_agent&quot;&#x27;<br>               &#x27;&#125;&#x27;;<br>2.引用定义的json格式的日志：<br>access_log  /var/log/nginx/access_json.log  json;#在nginx.conf配置文件里<br></code></pre></td></tr></table></figure><h2 id="启动nginx"><a href="#启动nginx" class="headerlink" title="启动nginx"></a>启动nginx</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">root@es-3-head-kib ~]# systemctl start nginx<br></code></pre></td></tr></table></figure><h2 id="测试–访问当前机器IP"><a href="#测试–访问当前机器IP" class="headerlink" title="测试–访问当前机器IP"></a>测试–访问当前机器IP</h2><p><code>浏览器访问http://192.168.246.235 刚开始没有任何数据，会提示你创建新的索引</code></p><h2 id="Logstash部署—-192-168-246-231"><a href="#Logstash部署—-192-168-246-231" class="headerlink" title="Logstash部署—-192.168.246.231"></a>Logstash部署—-192.168.246.231</h2><p>系统类型：Centos7.5<br>节点IP：192.168.246.231   E<br>软件版本：jdk-8u121-linux-x64.tar.gz、logstash-6.5.4.tar.gz</p><h2 id="1-安装配置Logstash"><a href="#1-安装配置Logstash" class="headerlink" title="1.安装配置Logstash"></a>1.安装配置Logstash</h2><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-2-zk-log ~]# tar xvzf logstash-6.5.4.tar.gz -C /usr/local/<br></code></pre></td></tr></table></figure><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>创建目录，我们将所有input、filter、output配置文件全部放到该目录中。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs shell">1.安装nginx:<br>[root@es-2-zk-log ~]# rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm<br>[root@es-2-zk-log ~]# yum install -y nginx<br>将原来的日志格式注释掉定义成json格式：<br>[root@es-2-zk-log conf.d]# vim /etc/nginx/nginx.conf<br>log_format  json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;<br>                           &#x27;&quot;@version&quot;:&quot;1&quot;,&#x27;<br>                           &#x27;&quot;client&quot;:&quot;$remote_addr&quot;,&#x27;<br>                           &#x27;&quot;url&quot;:&quot;$uri&quot;,&#x27;<br>                           &#x27;&quot;status&quot;:&quot;$status&quot;,&#x27;<br>                           &#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;<br>                           &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;<br>                           &#x27;&quot;size&quot;:$body_bytes_sent,&#x27;<br>                           &#x27;&quot;responsetime&quot;:$request_time,&#x27;<br>                           &#x27;&quot;referer&quot;: &quot;$http_referer&quot;,&#x27;<br>                           &#x27;&quot;ua&quot;: &quot;$http_user_agent&quot;&#x27;<br>               &#x27;&#125;&#x27;;<br>2.引用定义的json格式的日志：<br>access_log  /var/log/nginx/access_json.log  json;#在配置文件里改<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">启动</span><br>[root@es-2-zk-log ~]# systemctl start nginx <br>[root@es-2-zk-log ~]# systemctl enable nginx<br>浏览器多访问几次<br>[root@es-2-zk-log ~]# mkdir -p /usr/local/logstash-7.13.2/etc/conf.d<br>[root@es-2-zk-log ~]# cd /usr/local/logstash-6.5.4/etc/conf.d/       <br>[root@es-2-zk-log conf.d]# vim input.conf       #---在下面添加<br>input&#123;                        #让logstash可以读取特定的事件源。<br><br>    file&#123;                                       #从文件读取<br><br>   path =&gt; [&quot;/var/log/nginx/access_json.log&quot;]        #要输入的文件路径<br><br>   type =&gt; &quot;shopweb&quot;                       #定义一个类型，通用选项. <br><br>    &#125;<br><br>&#125;<br><br><br>[root@es-2-zk-log conf.d]# vim output.conf<br>output&#123;           #输出插件，将事件发送到特定目标<br>    elasticsearch &#123;            #输出到es<br>    hosts =&gt; [&quot;192.168.246.234:9200&quot;,&quot;192.168.246.231:9200&quot;,&quot;192.168.246.235:9200&quot;]       #指定es服务的ip加端口<br>    index =&gt; [&quot;%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;]     #引用input中的type名称，定义输出的格式<br>    &#125;<br>&#125;<br><br>`启动：`<br>[root@es-2-zk-log conf.d]# cd /usr/local/logstash-7.13.2/<br>[root@es-2-zk-log logstash-7.13.2]# nohup bin/logstash -f etc/conf.d/  --config.reload.automatic &amp; <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">查看日志出现:</span><br>[root@es-2-zk-log logstash-7.13.2]# tail -f nohup.out<br></code></pre></td></tr></table></figure><p>在浏览器中访问本机的nginx网站</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">随便刷新，主要刷新点数据，进行测试<br>web浏览器访问http://IP地址<br></code></pre></td></tr></table></figure><h2 id="Kafka部署"><a href="#Kafka部署" class="headerlink" title="Kafka部署"></a>Kafka部署</h2><h2 id="1-安装配置jdk8"><a href="#1-安装配置jdk8" class="headerlink" title="1.安装配置jdk8"></a>1.安装配置jdk8</h2><h2 id="（1）Kafka、Zookeeper（简称：ZK）运行依赖jdk8"><a href="#（1）Kafka、Zookeeper（简称：ZK）运行依赖jdk8" class="headerlink" title="（1）Kafka、Zookeeper（简称：ZK）运行依赖jdk8"></a>（1）Kafka、Zookeeper（简称：ZK）运行依赖jdk8</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">tar zxvf /usr/local/package/jdk-8u121-linux-x64.tar.gz -C /usr/local/<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;</span><br><span class="hljs-string">JAVA_HOME=/usr/local/jdk1.8.0_121</span><br><span class="hljs-string">PATH=$JAVA_HOME/bin:$PATH</span><br><span class="hljs-string">export JAVA_HOME PATH</span><br><span class="hljs-string">&#x27;</span> &gt;&gt;/etc/profile<br><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure><h2 id="2-安装配置ZK"><a href="#2-安装配置ZK" class="headerlink" title="2.安装配置ZK"></a>2.安装配置ZK</h2><p>Kafka运行依赖ZK，Kafka官网提供的tar包中，已经包含了ZK，这里不再额下载ZK程序。</p><p>配置相互解析—三台机器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-2-zk-log ~]# vim /etc/hosts<br>192.168.246.234 mes-1<br>192.168.246.231 es-2-zk-log<br>192.168.246.235 es-3-head-kib<br></code></pre></td></tr></table></figure><h2 id="（1）安装-1"><a href="#（1）安装-1" class="headerlink" title="（1）安装"></a>（1）安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">安装kafka软件包，也可在官网搜索下载</span><br>[root@es-2-zk-log ~]# tar xzvf kafka_2.11-2.1.0.tgz -C /usr/local/<br></code></pre></td></tr></table></figure><h2 id="（2）配置-1"><a href="#（2）配置-1" class="headerlink" title="（2）配置"></a>（2）配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties<br>[root@mes-1 ~]# vim /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties  #添加如下配置<br>dataDir=/opt/data/zookeeper/data <br>dataLogDir=/opt/data/zookeeper/logs<br>clientPort=2181 <br>tickTime=2000 <br>initLimit=20 <br>syncLimit=10 <br>server.1=192.168.246.231:2888:3888       //kafka集群IP:Port<br>server.2=192.168.246.234:2888:3888<br>server.3=192.168.246.235:2888:3888<br><span class="hljs-meta prompt_"># </span><span class="language-bash">直接添加</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建data、<span class="hljs-built_in">log</span>目录</span><br>[root@mes-1 ~]# mkdir -p /opt/data/zookeeper/&#123;data,logs&#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建myid文件</span><br>[root@mes-1 ~]# echo 1 &gt; /opt/data/zookeeper/data/myid     #myid号按顺序排<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-2-zk-log ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties<br>[root@es-2-zk-log ~]# vim /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties<br>dataDir=/opt/data/zookeeper/data <br>dataLogDir=/opt/data/zookeeper/logs<br>clientPort=2181 <br>tickTime=2000 <br>initLimit=20 <br>syncLimit=10 <br>server.1=192.168.246.231:2888:3888<br>server.2=192.168.246.234:2888:3888<br>server.3=192.168.246.235:2888:3888<br><span class="hljs-meta prompt_"># </span><span class="language-bash">以上内容直接添加</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建data、<span class="hljs-built_in">log</span>目录</span><br>[root@es-2-zk-log ~]# mkdir -p /opt/data/zookeeper/&#123;data,logs&#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建myid文件</span><br>[root@es-2-zk-log ~]# echo 2 &gt; /opt/data/zookeeper/data/myid<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3 ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties<br>[root@es-3-head-kib ~]# vim /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties<br>dataDir=/opt/data/zookeeper/data <br>dataLogDir=/opt/data/zookeeper/logs<br>clientPort=2181 <br>tickTime=2000 <br>initLimit=20 <br>syncLimit=10 <br>server.1=192.168.246.231:2888:3888<br>server.2=192.168.246.234:2888:3888<br>server.3=192.168.246.235:2888:3888<br><span class="hljs-meta prompt_"># </span><span class="language-bash">直接添加</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建data、<span class="hljs-built_in">log</span>目录</span><br>[root@es-3-head-kib ~]# mkdir -p /opt/data/zookeeper/&#123;data,logs&#125;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">创建myid文件</span><br>[root@es-3-head-kib ~]# echo 3 &gt; /opt/data/zookeeper/data/myid<br></code></pre></td></tr></table></figure><h2 id="配置Kafka"><a href="#配置Kafka" class="headerlink" title="配置Kafka"></a>配置Kafka</h2><h2 id="1）配置"><a href="#1）配置" class="headerlink" title="(1）配置"></a>(1）配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/server.properties<br>[root@mes-1 ~]# vim /usr/local/kafka_2.11-2.1.0/config/server.properties  #在最后添加<br>broker.id=1#需修改<br>listeners=PLAINTEXT://192.168.246.231:9092#需修改本机IP<br>num.network.threads=3<br>num.io.threads=8<br>socket.send.buffer.bytes=102400<br>socket.receive.buffer.bytes=102400<br>socket.request.max.bytes=104857600<br>log.dirs=/opt/data/kafka/logs<br>num.partitions=6<br>num.recovery.threads.per.data.dir=1<br>offsets.topic.replication.factor=2<br>transaction.state.log.replication.factor=1<br>transaction.state.log.min.isr=1<br>log.retention.hours=168<br>log.segment.bytes=536870912<br>log.retention.check.interval.ms=300000<br>zookeeper.connect=192.168.246.231:2181,192.168.246.234:2181,192.168.246.235:2181#修改集群的IP<br>zookeeper.connection.timeout.ms=6000<br>group.initial.rebalance.delay.ms=0<br>[root@mes-1 ~]# mkdir -p /opt/data/kafka/logs<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-2-zk-log ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/server.properties<br>[root@es-2-zk-log ~]# vim /usr/local/kafka_2.11-2.1.0/config/server.properties<br>broker.id=2#修改的<br>listeners=PLAINTEXT://192.168.246.234:9092<br>num.network.threads=3<br>num.io.threads=8<br>socket.send.buffer.bytes=102400<br>socket.receive.buffer.bytes=102400<br>socket.request.max.bytes=104857600<br>log.dirs=/opt/data/kafka/logs<br>num.partitions=6<br>num.recovery.threads.per.data.dir=1<br>offsets.topic.replication.factor=2<br>transaction.state.log.replication.factor=1<br>transaction.state.log.min.isr=1<br>log.retention.hours=168<br>log.segment.bytes=536870912<br>log.retention.check.interval.ms=300000<br>zookeeper.connect=192.168.246.231:2181,192.168.246.234:2181,192.168.246.235:2181<br>zookeeper.connection.timeout.ms=6000<br>group.initial.rebalance.delay.ms=0<br>[root@es-2-zk-log ~]# mkdir -p /opt/data/kafka/logs<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/server.properties<br>[root@es-3-head-kib ~]# vim /usr/local/kafka_2.11-2.1.0/config/server.properties<br>broker.id=3<br>listeners=PLAINTEXT://192.168.246.235:9092<br>num.network.threads=3<br>num.io.threads=8<br>socket.send.buffer.bytes=102400<br>socket.receive.buffer.bytes=102400<br>socket.request.max.bytes=104857600<br>log.dirs=/opt/data/kafka/logs<br>num.partitions=6<br>num.recovery.threads.per.data.dir=1<br>offsets.topic.replication.factor=2<br>transaction.state.log.replication.factor=1<br>transaction.state.log.min.isr=1<br>log.retention.hours=168<br>log.segment.bytes=536870912<br>log.retention.check.interval.ms=300000<br>zookeeper.connect=192.168.246.231:2181,192.168.246.234:2181,192.168.246.235:2181<br>zookeeper.connection.timeout.ms=6000<br>group.initial.rebalance.delay.ms=0<br>[root@es-3-head-kib ~]# mkdir -p /opt/data/kafka/logs<br></code></pre></td></tr></table></figure><h2 id="启动、验证ZK集群"><a href="#启动、验证ZK集群" class="headerlink" title="启动、验证ZK集群"></a>启动、验证ZK集群</h2><h2 id="（1）启动"><a href="#（1）启动" class="headerlink" title="（1）启动"></a>（1）启动</h2><p>在三个节点依次执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 ~]# cd /usr/local/kafka_2.11-2.1.0/<br>[root@mes-1 kafka_2.11-2.1.0]# nohup bin/zookeeper-server-start.sh config/zookeeper.properties &amp;<br></code></pre></td></tr></table></figure><h2 id="（2）验证"><a href="#（2）验证" class="headerlink" title="（2）验证"></a>（2）验证</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">查看端口有没有起来</span><br>[root@mes-1 ~]# netstat -lntp | grep 2181<br>tcp6       0      0 :::2181                 :::*                    LISTEN      1226/java<br><br></code></pre></td></tr></table></figure><h2 id="6、启动、验证Kafka"><a href="#6、启动、验证Kafka" class="headerlink" title="6、启动、验证Kafka"></a>6、启动、验证Kafka</h2><h2 id="（1）启动-1"><a href="#（1）启动-1" class="headerlink" title="（1）启动"></a>（1）启动</h2><p>在三个节点依次执行：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 ~]# cd /usr/local/kafka_2.11-2.1.0/<br>[root@mes-1 kafka_2.11-2.1.0]# nohup bin/kafka-server-start.sh config/server.properties &amp;<br></code></pre></td></tr></table></figure><h2 id="（2）验证-1"><a href="#（2）验证-1" class="headerlink" title="（2）验证"></a>（2）验证</h2><p>在192.168.246.231上创建topic</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-2-zk-log kafka_2.11-2.1.0]# bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic testtopic<br>Created topic &quot;testtopic&quot;.<br><br>参数解释：<br>–zookeeper指定zookeeper的地址和端口，<br>–partitions指定partition的数量，<br>–replication-factor指定数据副本的数量<br></code></pre></td></tr></table></figure><p>在246.235上面查询192.168.246.231上的topic</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib kafka_2.11-2.1.0]# bin/kafka-topics.sh --zookeeper 192.168.246.231:2181 --list<br>testtopic<br></code></pre></td></tr></table></figure><p>模拟消息生产和消费<br>发送消息到192.168.246.231</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@mes-1 kafka_2.11-2.1.0]# bin/kafka-console-producer.sh --broker-list 192.168.246.231:9092 --topic testtopic<br><span class="hljs-meta prompt_">&gt;</span><span class="language-bash">hello</span><br></code></pre></td></tr></table></figure><p>从192.168.246.234接受消息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-2-zk-log kafka_2.11-2.1.0]# bin/kafka-console-consumer.sh --bootstrap-server  192.168.246.234:9092 --topic testtopic --from-beginning<br>hello<br></code></pre></td></tr></table></figure><h2 id="修改logstash配置文件"><a href="#修改logstash配置文件" class="headerlink" title="修改logstash配置文件"></a>修改logstash配置文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">先关闭logstash，再修改配置文件---关闭进程</span><br>[root@es-2-zk-log ~]# ps -ef |grep logstash<br>[root@es-2-zk-log ~]# kill -9 进程号<br><br>kafka没有问题之后，回到logstash服务器：<br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装完kafka之后的操作：</span><br>[root@es-2-zk-log ~]# cd /usr/local/logstash-6.5.4/etc/conf.d/<br>[root@es-2-zk-log conf.d]# cp input.conf input.conf.bak<br>[root@es-2-zk-log conf.d]# vim input.conf<br>input &#123;<br>kafka &#123;               #指定kafka服务<br>    type =&gt; &quot;nginx_log&quot;<br>    codec =&gt; &quot;json&quot;        #通用选项，用于输入数据的编解码器<br>    topics =&gt; &quot;nginx&quot;        #这里定义的topic<br>    decorate_events =&gt; true  #会将当前topic信息也带到message中<br>    bootstrap_servers =&gt; &quot;192.168.246.234:9092, 192.168.246.231:9092, 192.168.246.235:9092&quot;<br>  &#125;<br>&#125;  <br><br>`启动 logstash`<br>[root@es-2-zk-log conf.d]# cd /usr/local/logstash-6.5.4/<br>[root@es-2-zk-log logstash-6.5.4]# nohup bin/logstash -f etc/conf.d/  --config.reload.automatic &amp;<br></code></pre></td></tr></table></figure><h2 id="Filebeat-部署"><a href="#Filebeat-部署" class="headerlink" title="Filebeat 部署"></a>Filebeat 部署</h2><h2 id="（1）下载"><a href="#（1）下载" class="headerlink" title="（1）下载"></a>（1）下载</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.13.2-linux-x86_64.tar.gz</span><br></code></pre></td></tr></table></figure><h2 id="（2）解压"><a href="#（2）解压" class="headerlink" title="（2）解压"></a>（2）解压</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@es-3-head-kib ~]</span><span class="hljs-comment"># tar xzvf filebeat-6.5.4-linux-x86_64.tar.gz -C /usr/local/</span><br><span class="hljs-section">[root@es-3-head-kib ~]</span><span class="hljs-comment"># cd /usr/local/</span><br><span class="hljs-section">[root@es-3-head-kib local]</span><span class="hljs-comment"># mv filebeat-6.5.4-linux-x86_64 filebeat</span><br><span class="hljs-section">[root@es-3-head-kib local]</span><span class="hljs-comment"># cd filebeat/</span><br></code></pre></td></tr></table></figure><h2 id="（3）修改配置"><a href="#（3）修改配置" class="headerlink" title="（3）修改配置"></a>（3）修改配置</h2><p>修改 Filebeat 配置，支持收集本地目录日志，并输出日志到 Kafka 集群中</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib filebeat]# mv filebeat.yml filebeat.yml.bak<br>[root@es-3-head-kib filebeat]# vim filebeat.yml<br>filebeat.inputs:<br>- type: log   #指定输入类型<br>  enable: true<br>  paths:<br>    -  /var/log/nginx/*.log  #日志路径<br><br>output.kafka:   <br>  hosts: [&quot;192.168.246.234:9092&quot;,&quot;192.168.246.231:9092&quot;,&quot;192.168.246.235:9092&quot;]   #kafka服务器<br>  topic: &#x27;nginx&#x27;        #输出到kafka中的topic<br></code></pre></td></tr></table></figure><h2 id="（4）启动"><a href="#（4）启动" class="headerlink" title="（4）启动"></a>（4）启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@es-3-head-kib filebeat]# nohup ./filebeat -e -c filebeat.yml &amp; <br>[root@es-3-head-kib filebeat]# tail -f nohup.out <br>2019-08-04T16:55:54.708+0800INFOkafka/log.go:53kafka message: client/metadata found some partitions to be leaderless<br>2019-08-04T16:55:54.708+0800INFOkafka/log.go:53client/metadata retrying after 250ms... (2 attempts remaining)<br>...<br><br>验证kafka是否生成topic<br>[root@es-3-head-kib filebeat]# cd /usr/local/kafka_2.11-2.1.0/<br>[root@es-3-head-kib kafka_2.11-2.1.0]# bin/kafka-topics.sh --zookeeper 192.168.246.231:2181 --list<br>__consumer_offsets<br>nginx     #已经生成topic<br>testtopic<br></code></pre></td></tr></table></figure><h2 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">浏览filebeat机器的IP地址，和浏览filebeat机器的IP地址+9100端口<br><br>web界面步骤<br>点击发现--创建索引模式--创建索引--再点左上角的3横杠里面的发现--这时候就可以看到创建好的索引了<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ansible 配置jspgou商城上线（mariadb版）</title>
    <link href="/2025/11/06/ansible-%E9%85%8D%E7%BD%AEjspgou%E5%95%86%E5%9F%8E%E4%B8%8A%E7%BA%BF%EF%BC%88mariadb%E7%89%88%EF%BC%89/"/>
    <url>/2025/11/06/ansible-%E9%85%8D%E7%BD%AEjspgou%E5%95%86%E5%9F%8E%E4%B8%8A%E7%BA%BF%EF%BC%88mariadb%E7%89%88%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h2 id="准备实验环境，准备两台电脑"><a href="#准备实验环境，准备两台电脑" class="headerlink" title="准备实验环境，准备两台电脑"></a>准备实验环境，准备两台电脑</h2><p>10.31.162.24—-10.31.162.25<br>此实验配置的是—-mariadb</p><p>关闭防火墙，关闭setenforce 0</p><h2 id="hosts解析"><a href="#hosts解析" class="headerlink" title="hosts解析"></a>hosts解析</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@ansible-server ~]# vim /etc/hosts<br>10.31.162.24    ansible-server<br>10.31.162.25    ansible-web<br></code></pre></td></tr></table></figure><h2 id="更改主机名"><a href="#更改主机名" class="headerlink" title="更改主机名"></a>更改主机名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">10.31.162.24<br>[root@ansible-server ~]# hostnamectl set-hostname ansible-server<br><br>10.31.162.25<br>[root@ansible-web ~]# hostnamectl set-hostname ansible-web<br></code></pre></td></tr></table></figure><h2 id="安装ansible"><a href="#安装ansible" class="headerlink" title="安装ansible"></a>安装ansible</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">10.31.162.24<br>安装：控制节点<br> 1. 配置EPEL网络yum源<br> [root@ansible-server ~]# yum install -y epel*<br> 2. 安装ansible<br> [root@ansible-server ~]# yum install -y ansible<br> 3.查看版本<br> [root@ansiable-server ~]# ansible --version<br> 4.查看配置文件：<br>[root@ansible-server ~]# rpm  -qc ansible<br>---1.主配置文件：/etc/ansible/ansible.cfg  #主要设置一些ansible初始化的信息，比如日志存放路径、模块、插件等配置信息<br>---2.主机清单文件:默认位置/etc/ansible/hosts<br></code></pre></td></tr></table></figure><h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">配置nginx源</span><br>[root@ansible-server ~]# vim /etc/yum.repos.d/nginx.repo<br>[nginx-stable]<br>name=nginx stable repo<br>baseurl=http://nginx.org/packages/centos/$releasever/$basearch/<br>gpgcheck=1<br>enabled=1<br>gpgkey=https://nginx.org/keys/nginx_signing.key<br>module_hotfixes=true<br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载nginx</span><br>[root@ansible-server ~]# yum install -y nginx<br>[root@ansible-server ~]# systemctl start nginx<br></code></pre></td></tr></table></figure><h2 id="上传压缩包"><a href="#上传压缩包" class="headerlink" title="上传压缩包"></a>上传压缩包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">将下载好的jdk、tomcat、jspgou，上传到server机器上<br><span class="hljs-meta prompt_"># </span><span class="language-bash">也可以直接官网下载</span><br>apache-tomcat-9.0.83.tar.gz<br>jdk-8u321-linux-x64.tar.gz<br>jspgouV6.1-ROOT.zip<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">jspgou包是gz的包，需要解压重新压缩才可以用，只能用tar包</span><br>[root@ansible-server ~]# yum -y install unzip<br>[root@ansible-server ~]# unzip jspgouV6.1-ROOT.zip<br>[root@ansible-server ~]# ls<br>DB ROOT<br>[root@ansible-server ~]# tar zcvf jspgouv6.1.tar.gz DB ROOT<br>jspgouv6.1.tar.gz<br></code></pre></td></tr></table></figure><h2 id="添加主机"><a href="#添加主机" class="headerlink" title="添加主机"></a>添加主机</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">添加主机清单</span><br>[root@ansible-server ~]# vim /etc/ansible/hosts<br>[jspgou]<br>ansible-web<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">其他语法</span><br>1.添加主机或者主机组：<br>[root@ansible-server ~]# vim /etc/ansible/hosts  #在最后追加被管理端的机器<br>ansible-web1                      #单独指定主机，可以使用主机名称或IP地址<br>2.添加主机组：<br>[webservers]        #使用[]标签指定主机组 ----标签自定义<br>192.168.10.11        #如果未解析添加ip<br>ansible-web2      #解析添加主机名<br>3.组可以包含其他组：<br>[webservers1]     #组一<br>ansible-web1<br>[webservers2]     #组二<br>ansible-web2<br>[weball:children]      #caildren-照写 #weball包括两个子组<br>webservers1        #组一<br>webservers2        #组二<br>4.为一个组指定变量，组内每个主机都可以使用该变量：<br>[weball:vars]         #设置变量,vars--照写<br>ansible_ssh_port=22     <br>ansible_ssh_user=root   <br>ansible_ssh_private_key_file=/root/.ssh/id_rsa  <br><span class="hljs-meta prompt_">#</span><span class="language-bash">ansible_ssh_pass=1      <span class="hljs-comment">#也可以定义密码，如果没有互传秘钥可以使用密码。</span></span><br></code></pre></td></tr></table></figure><h2 id="配置ssh密钥"><a href="#配置ssh密钥" class="headerlink" title="配置ssh密钥"></a>配置ssh密钥</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">配置ssh公钥认证：控制节点需要发送ssh公钥给所有非被控制节点<br>[root@ansible-server ~]# ssh-keygen<br>[root@ansible-server ~]# ssh-copy-id -i 10.31.126.25  #所有机器<br></code></pre></td></tr></table></figure><h2 id="配置ansible剧本"><a href="#配置ansible剧本" class="headerlink" title="配置ansible剧本"></a>配置ansible剧本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">在vars目录里配置file.yml配置文件</span><br>[root@ansible-server ~]# vim /etc/ansible/vars/file.yml<br>src_gou_path: /root/jspgouv6.1.tar.gz<br>src_jdk_path: /root/jdk-8u321-linux-x64.tar.gz<br>src_tomcat_path: /root/apache-tomcat-9.0.83.tar.gz<br>dest_gou_path: /root<br>dest_jdk_path: /root<br>dest_tomcat_path: /root<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在ansible目录里配置jspgou.yml配置文件</span><br>[root@ansible-server ~]# vim /etc/ansible/jspgou.yml<br>- hosts: jspgou<br>  user: root<br>  vars_files:<br>  - /etc/ansible/vars/file.yml<br>  <br>  tasks:<br>  - name: configure jdk1<br>    copy: src=&#123;&#123; src_jdk_path &#125;&#125; dest=&#123;&#123; dest_jdk_path &#125;&#125;<br><br>  - name: unzip jdk<br>    unarchive: src=&#123;&#123; dest_jdk_path &#125;&#125;/jdk-8u321-linux-x64.tar.gz dest=/usr/local/ copy=no<br><br>  - name: rename java<br>    shell: mv /usr/local/jdk1.8.0_321 /usr/local/java<br><br>  - name: configure jdk envirement1<br>    shell: echo &quot;JAVA_HOME=/usr/local/java&quot; &gt;&gt; /etc/profile<br><br>  - name: configure jdk envirement2<br>    shell: echo &#x27;PATH=$JAVA_HOME/bin:$PATH&#x27; &gt;&gt; /etc/profile<br><br>  - name: copy tomcat<br>    copy: src=&#123;&#123; src_tomcat_path &#125;&#125; dest=&#123;&#123; dest_tomcat_path &#125;&#125;<br><br>  - name: unzip tomcat<br>    unarchive: src=&#123;&#123; dest_tomcat_path &#125;&#125;/apache-tomcat-9.0.83.tar.gz dest=/usr/local/ copy=no<br><br>  - name: rename tomcat<br>    shell: mv /usr/local/apache-tomcat-9.0.83 /usr/local/tomcat<br><br>  - name: rm -rf webapps<br>    shell: rm -rf /usr/local/tomcat/webapps/*<br><br>  - name: add /etc/profile<br>    shell: sed -i &quot;2i source /etc/profile&quot; /usr/local/tomcat/bin/startup.sh<br><br>  - name: add /etc/profile to shutdown.sh<br>    shell: sed -i &quot;2i source /etc/profile&quot; /usr/local/tomcat/bin/shutdown.sh<br><br>  - name: copy jspgou<br>    copy: src=&#123;&#123; src_gou_path &#125;&#125; dest=&#123;&#123; dest_gou_path &#125;&#125;<br><br>  - name: unzip jspgou<br>    unarchive: src=&#123;&#123; dest_gou_path &#125;&#125;/jspgouv6.1.tar.gz dest=/usr/local/tomcat/webapps copy=no<br><br>  - name: install mariadb<br>    shell: yum -y install mariadb mariadb-server<br><br>  - name: start mariadb<br>    shell: systemctl start mariadb &amp;&amp; systemctl enable mariadb<br><br>  - name: start mysql1<br>    shell: mysqladmin -uroot password &quot;666888&quot;<br><br>  - name: enter mariadb<br>    shell: mysql -uroot -p&#x27;666888&#x27; -e &quot;create database jspgou default charset=utf8;&quot;<br><br>  - name: edit mysqld<br>    shell: sed -i &#x27;s/jdbc.password=/jdbc.password=666888/&#x27; /usr/local/tomcat/webapps/ROOT/WEB-INF/config/jdbc.properties<br><br>  - name: append mysql<br>    shell: echo &quot;max_allowed_packet= 64m&quot; &gt;&gt; /etc/my.cnf<br><br>  - name: append mysql1<br>    shell: echo &quot;sql_mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUB&quot; &gt;&gt; /etc/my.cnf<br><br>  - name: append mysql2<br>    shell: echo &quot;explicit_defaults_for_timestamp=1&quot; &gt;&gt; /etc/my.cnf<br><br>  - name: restart mariadb<br>    shell: systemctl restart mariadb<br><br>  - name: Import data<br>    shell: mysql -uroot -p&quot;666888&quot; -D jspgou &lt; /usr/local/tomcat/webapps/DB/jspgou.sql<br><br>  - name: restart mysql<br>    shell: systemctl restart mariadb<br>    notify: start jspgou<br>  handlers:<br><br>  - name: start jspgou<br>    shell: nohup /usr/local/tomcat/bin/startup.sh &amp;<br></code></pre></td></tr></table></figure><h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@ansible</span> ansible]<span class="hljs-meta"># ansible-playbook jspgou.yml</span><br></code></pre></td></tr></table></figure><h1 id="配置nginx代理"><a href="#配置nginx代理" class="headerlink" title="配置nginx代理"></a>配置nginx代理</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">备份原有配置文件</span><br>[root@ansible-server ~]#  cp default.conf default.conf.bak<br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加jspgou.conf配置文件</span><br>[root@ansible-server ~]#  vim /etc/nginx/conf.d/jspgou.conf <br>server &#123;<br>    listen       80;<br>    server_name  localhost;<br><br>    location / &#123;<br>        proxy_pass http://10.31.162.25:8080;<br>        proxy_set_header Host $host:$server_port;<br>        proxy_set_header X-Real-IP $remote_addr;<br>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>    &#125;<br><br>&#125;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启nginx</span><br>[root@ansible-server ~]#  systemctl restart nginx<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">打开网址输入10.31.162.24----会出来jspgou商城界面<br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/jspgou1.png" alt="jspgou1.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ansible 配置jspgou商城上线（MySQL版）</title>
    <link href="/2025/11/06/ansible-%E9%85%8D%E7%BD%AEjspgou%E5%95%86%E5%9F%8E%E4%B8%8A%E7%BA%BF%EF%BC%88MySQL%E7%89%88%EF%BC%89/"/>
    <url>/2025/11/06/ansible-%E9%85%8D%E7%BD%AEjspgou%E5%95%86%E5%9F%8E%E4%B8%8A%E7%BA%BF%EF%BC%88MySQL%E7%89%88%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h2 id="准备实验环境，准备两台电脑"><a href="#准备实验环境，准备两台电脑" class="headerlink" title="准备实验环境，准备两台电脑"></a>准备实验环境，准备两台电脑</h2><p>10.31.162.24—-10.31.162.25</p><p>关闭防火墙，关闭setenforce 0</p><h2 id="hosts解析"><a href="#hosts解析" class="headerlink" title="hosts解析"></a>hosts解析</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@ansible-server ~]# vim /etc/hosts<br>10.31.162.24    ansible-server<br>10.31.162.25    ansible-web<br></code></pre></td></tr></table></figure><h2 id="更改主机名"><a href="#更改主机名" class="headerlink" title="更改主机名"></a>更改主机名</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">10.31.162.24<br>[root@ansible-server ~]# hostnamectl set-hostname ansible-server<br><br>10.31.162.25<br>[root@ansible-web ~]# hostnamectl set-hostname ansible-web<br></code></pre></td></tr></table></figure><h2 id="安装ansible"><a href="#安装ansible" class="headerlink" title="安装ansible"></a>安装ansible</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">10.31.162.24<br>安装：控制节点<br> 1. 配置EPEL网络yum源<br> [root@ansible-server ~]# yum install -y epel*<br> 2. 安装ansible<br> [root@ansible-server ~]# yum install -y ansible<br> 3.查看版本<br> [root@ansiable-server ~]# ansible --version<br> 4.查看配置文件：<br>[root@ansible-server ~]# rpm  -qc ansible<br>---1.主配置文件：/etc/ansible/ansible.cfg  #主要设置一些ansible初始化的信息，比如日志存放路径、模块、插件等配置信息<br>---2.主机清单文件:默认位置/etc/ansible/hosts<br></code></pre></td></tr></table></figure><h2 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">配置nginx源</span><br>[root@ansible-server ~]# vim /etc/yum.repos.d/nginx.repo<br>[nginx-stable]<br>name=nginx stable repo<br>baseurl=http://nginx.org/packages/centos/$releasever/$basearch/<br>gpgcheck=0<br>enabled=1<br>gpgkey=https://nginx.org/keys/nginx_signing.key<br>module_hotfixes=true<br><span class="hljs-meta prompt_"># </span><span class="language-bash">下载nginx</span><br>[root@ansible-server ~]# yum install -y nginx<br>[root@ansible-server ~]# systemctl start nginx<br>[root@ansible-server ~]# systemctl enable nginx<br></code></pre></td></tr></table></figure><h2 id="上传jdk、tomcat、jspgou压缩包"><a href="#上传jdk、tomcat、jspgou压缩包" class="headerlink" title="上传jdk、tomcat、jspgou压缩包"></a>上传jdk、tomcat、jspgou压缩包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs shell">将下载好的jdk、tomcat、jspgou，上传到server机器上<br><span class="hljs-meta prompt_"># </span><span class="language-bash">也可以直接官网下载</span><br>apache-tomcat-9.0.83.tar.gz<br>jdk-8u321-linux-x64.tar.gz<br>jspgouV6.1-ROOT.zip<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">jspgou包是gz的包，需要解压重新压缩才可以用，只能用tar包</span><br>[root@ansible-server ~]# yum -y install unzip<br>[root@ansible-server ~]# unzip jspgouV6.1-ROOT.zip<br>[root@ansible-server ~]# ls<br>DB ROOT<br>[root@ansible-server ~]# tar zcvf jspgouv6.1.tar.gz DB ROOT<br>jspgouv6.1.tar.gz<br></code></pre></td></tr></table></figure><h2 id="添加主机"><a href="#添加主机" class="headerlink" title="添加主机"></a>添加主机</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">添加主机清单</span><br>[root@ansible-server ~]# vim /etc/ansible/hosts<br>[jspgou]<br>ansible-web<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">其他语法</span><br>1.添加主机或者主机组：<br>[root@ansible-server ~]# vim /etc/ansible/hosts  #在最后追加被管理端的机器<br>ansible-web1                      #单独指定主机，可以使用主机名称或IP地址<br>2.添加主机组：<br>[webservers]        #使用[]标签指定主机组 ----标签自定义<br>192.168.10.11        #如果未解析添加ip<br>ansible-web2      #解析添加主机名<br>3.组可以包含其他组：<br>[webservers1]     #组一<br>ansible-web1<br>[webservers2]     #组二<br>ansible-web2<br>[weball:children]      #caildren-照写 #weball包括两个子组<br>webservers1        #组一<br>webservers2        #组二<br>4.为一个组指定变量，组内每个主机都可以使用该变量：<br>[weball:vars]         #设置变量,vars--照写<br>ansible_ssh_port=22     <br>ansible_ssh_user=root   <br>ansible_ssh_private_key_file=/root/.ssh/id_rsa  <br><span class="hljs-meta prompt_">#</span><span class="language-bash">ansible_ssh_pass=1      <span class="hljs-comment">#也可以定义密码，如果没有互传秘钥可以使用密码。</span></span><br></code></pre></td></tr></table></figure><h2 id="配置ssh密钥"><a href="#配置ssh密钥" class="headerlink" title="配置ssh密钥"></a>配置ssh密钥</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">配置ssh公钥认证：控制节点需要发送ssh公钥给所有非被控制节点<br>[root@ansible-server ~]# ssh-keygen<br>[root@ansible-server ~]# ssh-copy-id -i 10.31.126.25  #所有机器<br></code></pre></td></tr></table></figure><h2 id="配置剧本"><a href="#配置剧本" class="headerlink" title="配置剧本"></a>配置剧本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">在vars目录里配置file.yml配置文件</span><br>[root@ansible-server ~]# vim /etc/ansible/vars/file.yml<br>src_gou_path: /root/jspgouv6.1.tar.gz<br>src_jdk_path: /root/jdk-8u321-linux-x64.tar.gz<br>src_tomcat_path: /root/apache-tomcat-9.0.83.tar.gz<br>dest_gou_path: /root<br>dest_jdk_path: /root<br>dest_tomcat_path: /root<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置安装MySQL脚本</span><br>[root@ansible-server ~]# vim /etc/ansible/jsp.sh<br><span class="hljs-meta prompt_">#</span><span class="language-bash">!/bin/bash</span><br>PASS_WORD=&quot;Qianfeng@123&quot;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">配置源</span><br>cat &gt;&gt; /etc/yum.repos.d/mysql.repo &lt;&lt;EOF<br>[mysql]<br>name=mysql<br>baseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-5.7-community-el7-x86_64/<br>gpgcheck=0<br>enabled=1<br>gpgkey=https://mirrors.ustc.edu.cn/mysql-repo/RPM-GPG-KEY-mysql<br>EOF<br><span class="hljs-meta prompt_">#</span><span class="language-bash">下载mysql</span><br>yum repolist enabled | grep mysql<br>yum -y install mysql-community-server &amp;&gt; /dev/null<br><span class="hljs-meta prompt_">#</span><span class="language-bash">启动</span><br>systemctl start mysqld &amp;&amp; systemctl enable mysqld<br><span class="hljs-meta prompt_">#</span><span class="language-bash">获取密码</span><br>TEMP_PASSWORD=$(sudo grep &#x27;temporary password&#x27; /var/log/mysqld.log | awk &#x27;&#123;print $NF&#125;&#x27;)<br><span class="hljs-meta prompt_">#</span><span class="language-bash">修改密码</span><br>mysql -u root -p&quot;$&#123;TEMP_PASSWORD&#125;&quot; --connect-expired-password &lt;&lt;EOF<br>ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &quot;$PASS_WORD&quot;;<br>GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;localhost&#x27; WITH GRANT OPTION;<br>FLUSH PRIVILEGES;<br>EOF<br><span class="hljs-meta prompt_">#</span><span class="language-bash">重启mysql</span><br>systemctl restart mysqld<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">赋予jsp.sh权限</span><br>[root@ansible-server ~]# cd /etc/ansible/<br>[root@ansible-server ansible]# chmod o+x jsp.sh<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">在ansible目录里配置jspgou.yml配置文件</span><br>[root@ansible-server ~]# vim /etc/ansible/jspgou.yml<br>- hosts: jspgou<br>  user: root<br>  become: yes<br>  vars_files:<br>  - /etc/ansible/vars/file.yml<br>  <br>  tasks:<br>  - name: configure jdk1<br>    copy: src=&#123;&#123; src_jdk_path &#125;&#125; dest=&#123;&#123; dest_jdk_path &#125;&#125;<br><br>  - name: unzip jdk<br>    unarchive: src=&#123;&#123; dest_jdk_path &#125;&#125;/jdk-8u321-linux-x64.tar.gz dest=/usr/local/ copy=no<br><br>  - name: rename java<br>    shell: mv /usr/local/jdk1.8.0_321 /usr/local/java<br><br>  - name: configure jdk envirement1<br>    shell: echo &quot;JAVA_HOME=/usr/local/java&quot; &gt;&gt; /etc/profile<br><br>  - name: configure jdk envirement2<br>    shell: echo &#x27;PATH=$JAVA_HOME/bin:$PATH&#x27; &gt;&gt; /etc/profile<br><br>  - name: copy tomcat<br>    copy: src=&#123;&#123; src_tomcat_path &#125;&#125; dest=&#123;&#123; dest_tomcat_path &#125;&#125;<br><br>  - name: unzip tomcat<br>    unarchive: src=&#123;&#123; dest_tomcat_path &#125;&#125;/apache-tomcat-9.0.83.tar.gz dest=/usr/local/ copy=no<br><br>  - name: rename tomcat<br>    shell: mv /usr/local/apache-tomcat-9.0.83 /usr/local/tomcat<br><br>  - name: rm -rf webapps<br>    shell: rm -rf /usr/local/tomcat/webapps/*<br><br>  - name: add /etc/profile<br>    shell: sed -i &quot;2i source /etc/profile&quot; /usr/local/tomcat/bin/startup.sh<br><br>  - name: add /etc/profile to shutdown.sh<br>    shell: sed -i &quot;2i source /etc/profile&quot; /usr/local/tomcat/bin/shutdown.sh<br><br>  - name: copy jspgou<br>    copy: src=&#123;&#123; src_gou_path &#125;&#125; dest=&#123;&#123; dest_gou_path &#125;&#125;<br><br>  - name: unzip jspgou<br>    unarchive: src=&#123;&#123; dest_gou_path &#125;&#125;/jspgouv6.1.tar.gz dest=/usr/local/tomcat/webapps copy=no<br><br>  - name: Modify MySQL user initial password<br>    script: /etc/ansible/jsp.sh removes=/etc/passwd<br><br>  - name: enter MySQL<br>    shell: mysql -uroot -p&#x27;Qianfeng@123&#x27; -e &quot;create database jspgou default charset=utf8;&quot;<br>    <br>  - name: edit mysqld<br>    shell: sed -i &#x27;s/jdbc.password=/jdbc.password=Qianfeng@123/&#x27; /usr/local/tomcat/webapps/ROOT/WEB-INF/config/jdbc.properties<br><br>  - name: append mysql<br>    shell: echo &quot;max_allowed_packet= 64m&quot; &gt;&gt; /etc/my.cnf<br><br>  - name: append mysql1<br>    shell: echo &quot;sql_mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUB&quot; &gt;&gt; /etc/my.cnf<br><br>  - name: append mysql2<br>    shell: echo &quot;explicit_defaults_for_timestamp=1&quot; &gt;&gt; /etc/my.cnf<br><br>  - name: restart mysqld1<br>    shell: systemctl restart mysqld<br><br>  - name: Import data<br>    shell: mysql -uroot -p&quot;Qianfeng@123&quot; -D jspgou &lt; /usr/local/tomcat/webapps/DB/jspgou.sql<br><br>  - name: restart mysql11<br>    shell: systemctl restart mysqld<br>    notify: start jspgou<br>  handlers:<br>  <br>  - name: start jspgou<br>    shell: nohup /usr/local/tomcat/bin/startup.sh &amp;<br></code></pre></td></tr></table></figure><h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@ansible</span> ansible]<span class="hljs-meta"># ansible-playbook jspgou.yml</span><br></code></pre></td></tr></table></figure><h1 id="配置nginx代理"><a href="#配置nginx代理" class="headerlink" title="配置nginx代理"></a>配置nginx代理</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">备份原有配置文件</span><br>[root@ansible-server ~]#  cp default.conf default.conf.bak<br><span class="hljs-meta prompt_"># </span><span class="language-bash">添加jspgou.conf配置文件</span><br>[root@ansible-server ~]#  vim /etc/nginx/conf.d/jspgou.conf <br>server &#123;<br>    listen       80;<br>    server_name  localhost;<br><br>    location / &#123;<br>        proxy_pass http://10.31.162.25:8080;<br>        proxy_set_header Host $host:$server_port;<br>        proxy_set_header X-Real-IP $remote_addr;<br>        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br>    &#125;<br><br>&#125;<br><span class="hljs-meta prompt_"># </span><span class="language-bash">重启nginx</span><br>[root@ansible-server ~]#  systemctl restart nginx<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">打开网址输入10.31.162.24----会出来jspgou商城界面<br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/jspgou1.png" alt="jspgou1.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>gitlab 仓库创建及使用</title>
    <link href="/2025/11/06/gitlab-%E4%BB%93%E5%BA%93%E5%88%9B%E5%BB%BA%E5%8F%8A%E4%BD%BF%E7%94%A8/"/>
    <url>/2025/11/06/gitlab-%E4%BB%93%E5%BA%93%E5%88%9B%E5%BB%BA%E5%8F%8A%E4%BD%BF%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<p><strong>git的工作环境</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini">工作区<br>暂存区git add *<br>版本库git commit -m “版本描述信息” <br>HEAD<br>版本号<br>版本日志<br></code></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini">git clone git@IP地址:/自建的目录/自建的库/     <span class="hljs-comment">#克隆到本地</span><br>git add .    <span class="hljs-comment">#存储到暂存区</span><br>git commit -m &quot;描述信息&quot;    <span class="hljs-comment">#更新版本</span><br>git push origin master    <span class="hljs-comment">#上传到gitlab</span><br></code></pre></td></tr></table></figure><p><code>每个版本都会有一个id号，也就是commit id</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@vm20 ~]</span><span class="hljs-comment"># git log</span><br><br>commit fbecfa3d04ae5038aa11bf55942e46c840077ace  <span class="hljs-comment">#id号</span><br></code></pre></td></tr></table></figure><p><strong>部署git</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ini">环境：<br>    git-server    192.168.246.214  充当服务器<br>    client        192.168.246.213<br><br>安装：所有机器都安装<br>   <span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># yum install -y git</span><br>   <span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># git --version </span><br>   git version 1.8.3.1<br>   <br>`所有的机器都添加，只要邮箱和用户不一样就可以`   <br>    <span class="hljs-comment"># git config --global user.email &quot;soho@163.com&quot;     ----设置邮箱</span><br>    <span class="hljs-comment"># git config --global user.name &quot;soho&quot;              ----加添用户</span><br></code></pre></td></tr></table></figure><p><strong>1、git使用</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini">1.创建一个空目录：在中心服务器上创建<br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># mkdir /git-test</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># useradd git   #创建一个git用户用来运行git</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># passwd git  #给用户设置密码</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># cd /git-test/</span><br><br>2.通过git init命令把这个目录变成Git可以管理的仓库：<br> 第1种情况：可以改代码，还能上传到别人的机器，别人也能从你这里下载但是别人不能上传代码到你的机器上。<br> 第2种情况：只是为了上传代码用，别人从这台机器上下载代码也可以上传代码到这台机器上，经常用于核心代码库。<br></code></pre></td></tr></table></figure><p><strong>创建—-裸库：</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ini">`语法：git init --bare  库名字<br><br><span class="hljs-comment">#在server服务端</span><br><span class="hljs-section">[root@git-server git-test]</span><span class="hljs-comment"># git init --bare testgit</span><br>Initialized empty Git repository in /git-test/testgit/<br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># chown git.git /git-test -R  #修改权限</span><br>2.仓库创建完成后查看库目录：<br><span class="hljs-section">[root@git-server git-test]</span><span class="hljs-comment"># cd testgit/</span><br><span class="hljs-section">[root@git-server testgit]</span><span class="hljs-comment"># ls</span><br>branches  config  description  HEAD  hooks  info  objects  refs<br></code></pre></td></tr></table></figure><p><strong>客户端</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini">1.配置免密登录<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># ssh-keygen    #生成秘钥</span><br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># ssh-copy-id -i git@192.168.246.214   #将秘钥传输到git服务器中的git用户</span><br>2.克隆git仓库<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># git clone git@192.168.246.214:/git-test/testgit/</span><br>Cloning into &#x27;testgit&#x27;...<br>warning: You appear to have cloned an empty repository.<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># ls  #查看仓库已经克隆下来了</span><br>anaconda-ks.cfg    testgit <br></code></pre></td></tr></table></figure><p><strong>创建文件模拟代码提交到仓库</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs ini">1.在testgit目录下创建一个测试文件test.txt<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># cd testgit/</span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># vi test.txt   #随便写点东西</span><br>2.把文件添加到暂存区：使用 &quot;git add&quot; 建立跟踪<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git add test.txt</span><br>注: 这里可以使用 git add * 或者 git add -A<br>3.提交文件到本地仓库分支：<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git commit -m &quot;test1&quot;</span><br><span class="hljs-section">[master (root-commit) 2b51ff9]</span> test1<br> 1 file changed, 2 insertions(+)<br> create mode 100644 test.txt<br> -m:描述<br> 4.查看git状态：<br> <span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git status </span><br><span class="hljs-comment"># On branch master   #分支位于master</span><br>5.修改文件后再此查看状态：<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># echo &#x27;1122334&#x27; &gt;&gt; test.txt</span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git status</span><br><span class="hljs-comment"># 位于分支 master</span><br><span class="hljs-comment"># 尚未暂存以备提交的变更：</span><br><span class="hljs-comment">#   （使用 &quot;git add &lt;file&gt;...&quot; 更新要提交的内容）</span><br><span class="hljs-comment">#   （使用 &quot;git checkout -- &lt;file&gt;...&quot; 丢弃工作区的改动）</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment">#修改：      readme.txt</span><br><span class="hljs-comment">#</span><br>修改尚未加入提交（使用 &quot;git add&quot; 和/或 &quot;git commit &quot;<br>6.先add<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git add -A</span><br>8.再次提交commit：<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git commit  -m &quot;add2&quot; test.txt </span><br><span class="hljs-section">[master 73bf688]</span> add2<br> 1 file changed, 1 insertion(+)<br> <span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git status </span><br><span class="hljs-comment"># On branch master</span><br>nothing to commit, working directory clean<br></code></pre></td></tr></table></figure><p><strong>版本回退</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ini">查看现在的版本<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git log</span><br><br>回到上一个版本<br><span class="hljs-comment">#一个^代表回退一次，2个^代表回退2此，依此类推……</span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git reset --hard HEAD^ </span><br>HEAD is now at 0126755 test1<br>2.回到指定的版本(根据版本号): <br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git reset --hard dd66ff</span><br>HEAD is now at dd66ff9 <span class="hljs-attr">add2</span><br><br>==========================================================<br>注：消失的ID号：可以查看之前的所有的版本<br><span class="hljs-section">[root@vm20 gittest]</span><span class="hljs-comment"># git reflog</span><br></code></pre></td></tr></table></figure><p><strong>删除文件</strong></p><p>从工作区删除test.txt，并且从版本库一起删除</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini">从工作区删除<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># rm -rf test.txt </span><br>从版本库删除：<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git rm test.txt </span><br>rm &#x27;test.txt&#x27;<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git commit -m &quot;删除文件test.txt&quot;</span><br><span class="hljs-section">[master cebc081]</span> 删除文件test.txt<br> 1 file changed, 3 deletions(-)<br> delete mode 100644 test.txt<br></code></pre></td></tr></table></figure><p><strong>将代码上传到仓库的master分支</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># vi a.txt   #创建一个新文件</span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git add a.txt </span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git commit -m &quot;add&quot;</span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git push origin master   #上传到远程仓库master分支</span><br>Counting objects: 11, done.<br>Compressing objects: 100% (4/4), done.<br>Writing objects: 100% (11/11), 828 bytes | 0 bytes/s, done.<br>Total 11 (delta 0), reused 0 (delta 0)<br>To git@192.168.246.214:/git-test/testgit/<br> * <span class="hljs-section">[new branch]</span>      master -&gt; master<br></code></pre></td></tr></table></figure><p><strong>测试:</strong></p><p>在客户端将仓库删除掉然后在克隆下来查看仓库中是否有文件</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@git-client ~]</span><span class="hljs-comment"># rm -rf testgit/</span><br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># git clone git@192.168.246.214:/git-test/testgit/</span><br>Cloning into &#x27;testgit&#x27;...<br>remote: Counting objects: 11, done.<br>remote: Compressing objects: 100% (4/4), done.<br>remote: Total 11 (delta 0), reused 0 (delta 0)<br>Receiving objects: 100% (11/11), done.<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># cd testgit/</span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># ls</span><br>a.txt<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># cat a.txt </span><br>hello world<br></code></pre></td></tr></table></figure><p><strong>创建分支并合并分支</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># ls在客户端操作：</span><br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># git clone git@192.168.246.214:/git-test/testgit/</span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git status </span><br><span class="hljs-comment"># On branch master   #当前所在为master分支</span><br><span class="hljs-comment">#</span><br><span class="hljs-comment"># Initial commit</span><br><span class="hljs-comment">#</span><br>nothing to commit (create/copy files and use &quot;git add&quot; to track)<br><br>创建分支:<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git branch dev   #创建分支。</span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git branch    #查看分支。*在哪里就表示当前是哪个分支</span><br>  dev<br>* master<br>切换分支:<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git checkout dev</span><br>Switched to branch &#x27;dev&#x27;<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git branch </span><br>* dev<br>  master<br>在dev分支创建一个文件；<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># vi test.txt</span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git add test.txt </span><br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git commit -m &quot;add dev&quot;</span><br><span class="hljs-section">[dev f855bdf]</span> add dev<br> 1 file changed, 1 insertion(+)<br> create mode 100644 test.txt<br>现在，dev分支的工作完成，我们就可以切换回master分支：<br> <span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git checkout master</span><br>Switched to branch &#x27;master&#x27;<br><br>切换回`master`分支后，再查看一个`test.txt`文件，刚才添加的内容不见了！因为那个提交是在`dev`分支上，而`master`分支此刻的提交点并没有变：<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># ls</span><br>a.txt<br><br>现在，我们把`dev`分支的工作成果合并到`master`分支上：<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git merge dev</span><br>Updating 40833e0..f855bdf<br>Fast-forward<br> test.txt | 1 +<br> 1 file changed, 1 insertion(+)<br> create mode 100644 test.txt<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># ls</span><br>a.txt  test.txt<br>现在已经将dev分支的内容合并到master上。确认没有问题上传到远程仓库:<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git push origin master</span><br><br>合并完成后，就可以放心地删除`dev`分支了：<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git branch -d dev</span><br>Deleted branch dev (was f855bdf).<br><br>删除后，查看`branch`，就只剩下`master`分支了：<br><span class="hljs-section">[root@client testgit]</span><span class="hljs-comment"># git branch </span><br>* master<br></code></pre></td></tr></table></figure><p><strong>2、部署gitlab服务</strong></p><p><strong>官网下载gitlab地址</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">百度搜索gitlab--点击https://gitlab.com/users/sign_in<br>拉到最下面--点击 关于 GitLab<br>再拉到最下面--有个Resources--点击Install--往下拉点击有个cenos 7版本的下载--安装命令步骤操作即可<br></code></pre></td></tr></table></figure><p><strong>配置yum源</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># cd /etc/yum.repos.d/</span><br><span class="hljs-comment">#配置yum源</span><br><span class="hljs-section">[root@git-server yum.repos.d]</span><span class="hljs-comment"># vi gitlab-ce.repo</span><br><span class="hljs-section">[gitlab-ce]</span><br><span class="hljs-attr">name</span>=Gitlab CE Repository<br><span class="hljs-attr">baseurl</span>=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el<span class="hljs-variable">$releasever</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><br><span class="hljs-comment">#安装相关依赖</span><br><span class="hljs-section">[root@git-server yum.repos.d]</span><span class="hljs-comment"># yum install -y curl policycoreutils-python openssh-server</span><br><span class="hljs-section">[root@git-server yum.repos.d]</span><span class="hljs-comment"># systemctl enable sshd</span><br><span class="hljs-section">[root@git-server yum.repos.d]</span><span class="hljs-comment"># systemctl start sshd</span><br><br><span class="hljs-comment">#安装postfix</span><br><span class="hljs-section">[root@git-server yum.repos.d]</span><span class="hljs-comment"># yum install postfix  #安装邮箱</span><br><span class="hljs-section">[root@git-server yum.repos.d]</span><span class="hljs-comment"># systemctl enable postfix</span><br><span class="hljs-section">[root@git-server yum.repos.d]</span><span class="hljs-comment"># systemctl start postfix</span><br><br><span class="hljs-comment">#安装的版本，下面那条命令是安装最新版，可能存在不兼容的风险</span><br><span class="hljs-section">[root@git-server yum.repos.d]</span><span class="hljs-comment"># yum install -y gitlab-ce-13.1.1-ce.0.el7.x86_64  #安装的版本</span><br><span class="hljs-section">[root@git-server yum.repos.d]</span><span class="hljs-comment"># yum install -y gitlab-ce  #将会安装gitlab最新版本</span><br></code></pre></td></tr></table></figure><p><strong>配置gitlab</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># vim /etc/gitlab/gitlab.rb</span><br>1.<span class="hljs-comment"># 添加对外的域名（gitlab.papamk.com请添加A记录指向本服务器的公网IP）：将原来的修改为</span><br>external_url &#x27;http://192.168.246.214&#x27;<br>2.设置地区<br>gitlab_rails<span class="hljs-section">[&#x27;time_zone&#x27;]</span> = &#x27;Asia/Shanghai&#x27;<br><br>将数据路径的注释去掉，可以更改<br><span class="hljs-comment">#第501-505行，去除注释</span><br>git_data_dirs(&#123;<br>  <span class="hljs-attr">&quot;default&quot;</span> =&gt; &#123;<br>    <span class="hljs-attr">&quot;path&quot;</span> =&gt; <span class="hljs-string">&quot;/mnt/nfs-01/git-data&quot;</span><br>   &#125;<br>&#125;)<br><br>开启ssh服务:<br><span class="hljs-comment">#第519行，去除注释</span><br>gitlab_rails<span class="hljs-section">[&#x27;gitlab_shell_ssh_port&#x27;]</span> = 22<br><br>开启邮箱服务<br><span class="hljs-comment">#直接在637行开始添加以下内容</span><br>gitlab_rails<span class="hljs-section">[&#x27;smtp_enable&#x27;]</span> = true  <span class="hljs-comment">#开启smtp服务</span><br>gitlab_rails<span class="hljs-section">[&#x27;smtp_address&#x27;]</span> = &quot;smtp.163.com&quot; <span class="hljs-comment">#指定smtp地址</span><br>gitlab_rails<span class="hljs-section">[&#x27;smtp_port&#x27;]</span> = 465<br>gitlab_rails<span class="hljs-section">[&#x27;smtp_user_name&#x27;]</span> = &quot;xxxx@163.com&quot;  <span class="hljs-comment">#指定邮箱</span><br>gitlab_rails<span class="hljs-section">[&#x27;smtp_password&#x27;]</span> = &quot;邮箱授权密码&quot;<br>gitlab_rails<span class="hljs-section">[&#x27;smtp_domain&#x27;]</span> = &quot;163.com&quot;  <span class="hljs-comment">#邮箱地址的域</span><br>gitlab_rails<span class="hljs-section">[&#x27;smtp_authentication&#x27;]</span> = &quot;login&quot; <br>gitlab_rails<span class="hljs-section">[&#x27;smtp_enable_starttls_auto&#x27;]</span> = true<br>gitlab_rails<span class="hljs-section">[&#x27;smtp_tls&#x27;]</span> = true<br>gitlab_rails<span class="hljs-section">[&#x27;smtp_openssl_verify_mode&#x27;]</span> = &#x27;none&#x27;<br>gitlab_rails<span class="hljs-section">[&#x27;gitlab_email_from&#x27;]</span> = &#x27;xxxx@163.com&#x27; <span class="hljs-comment">#指定发件邮箱</span><br>gitlab_rails<span class="hljs-section">[&#x27;gitlab_email_display_name&#x27;]</span> = &#x27;Admin&#x27; <span class="hljs-comment">#指定发件人</span><br><span class="hljs-comment">#user[&quot;git_user_email&quot;] = &quot;xxxx@163.com&quot;</span><br></code></pre></td></tr></table></figure><p><strong>重置并启动GitLab执行:</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># gitlab-ctl reconfigure   #重新加载，需要等很长时间</span><br></code></pre></td></tr></table></figure><p><strong>启动</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># gitlab-ctl restart  #启动</span><br></code></pre></td></tr></table></figure><p><strong>邮箱测试</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@git-server ~]</span> <span class="hljs-comment"># gitlab-rails console#进入终端</span><br><br><span class="hljs-comment">#开始测试</span><br>irb(main):001:0&gt; Notify.test_email(&#x27;xxxx@qq.com&#x27;, &#x27;Message Subject&#x27;, &#x27;Message Body&#x27;).deliver_now <span class="hljs-comment">#测试发送邮件是否成功</span><br></code></pre></td></tr></table></figure><p><strong>测试web页面访问</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">输入IP地址，直接访问，会出来一个界面，它默认用户是root，直接输入密码就可以（设置密码）<br></code></pre></td></tr></table></figure><p><strong>在服务器通过在git客户端</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># git clone git@192.168.246.214:root/testapp.git</span><br>Cloning into &#x27;testapp&#x27;...<br>remote: Enumerating objects: 6, done.<br>remote: Counting objects: 100% (6/6), done.<br>remote: Compressing objects: 100% (4/4), done.<br>remote: Total 6 (delta 0), reused 0 (delta 0)<br>Receiving objects: 100% (6/6), done.<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># ls</span><br>testapp<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># cd testapp/</span><br><span class="hljs-section">[root@client testapp]</span><span class="hljs-comment"># ls</span><br>test.txt  同步时间.txt<br><span class="hljs-section">[root@client testapp]</span><span class="hljs-comment">#</span><br><br>注意:如果克隆不下来可以重新使用命令生成私钥<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># ssh-keygen -t rsa #然后将公钥添加到gitlab中。</span><br><br>使用http的<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># rm -rf testgit/</span><br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># git clone http://192.168.246.214/root/testapp.git</span><br>Cloning into &#x27;testapp&#x27;...<br>Username for &#x27;http://192.168.246.214&#x27;: root<br>Password for &#x27;http://root@192.168.246.214&#x27;:12345678  <span class="hljs-comment">#为自己设置的密码</span><br>remote: Enumerating objects: 6, done.<br>remote: Counting objects: 100% (6/6), done.<br>remote: Compressing objects: 100% (4/4), done.<br>remote: Total 6 (delta 0), reused 0 (delta 0)<br>Unpacking objects: 100% (6/6), done.<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># ls</span><br>testapp<br><br>提交到远程gitlab仓库<br><span class="hljs-section">[root@client ~]</span><span class="hljs-comment"># cd testapp/</span><br><span class="hljs-section">[root@client testapp]</span><span class="hljs-comment"># vi update.txt</span><br>1000phone<br><span class="hljs-section">[root@client testapp]</span><span class="hljs-comment"># git add .</span><br><span class="hljs-section">[root@client testapp]</span><span class="hljs-comment"># git commit -m &#x27;updata-test&#x27;</span><br><span class="hljs-section">[root@client testapp]</span><span class="hljs-comment"># git push origin master</span><br>Counting objects: 4, done.<br>Compressing objects: 100% (2/2), done.<br>Writing objects: 100% (3/3), 266 bytes | 0 bytes/s, done.<br>Total 3 (delta 1), reused 0 (delta 0)<br>To git@192.168.153.156:root/testapp.git<br>   4f35d4b..a0067ea  master -&gt; master<br></code></pre></td></tr></table></figure><p><strong>Gitlab 备份与恢复</strong></p><p><strong>1、查看系统版本和软件版本</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># cat /etc/redhat-release </span><br>CentOS Linux release 7.4.1708 (Core)<br><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># cat /opt/gitlab/embedded/service/gitlab-rails/VERSION</span><br>13.1.1<br></code></pre></td></tr></table></figure><p><strong>2、数据备份</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs ini">打开/etc/gitlab/gitlab.rb配置文件，查看一个和备份相关的配置项：<br>vim /etc/gitlab/gitlab.rb<br>gitlab_rails<span class="hljs-section">[&#x27;backup_path&#x27;]</span> = &quot;/var/opt/gitlab/backups&quot;<span class="hljs-comment">#备份的路径</span><br>gitlab_rails<span class="hljs-section">[&#x27;backup_archive_permissions&#x27;]</span> = 0644<span class="hljs-comment">#备份文件的默认权限</span><br>gitlab_rails<span class="hljs-section">[&#x27;backup_keep_time&#x27;]</span> = 604800<span class="hljs-comment">#保留时长，秒为单位</span><br><br><span class="hljs-comment"># 重启</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># gitlab-ctl reconfigure</span><br>或者<br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># gitlab-ctl  restart</span><br><br><span class="hljs-comment"># 执行备份命令进行备份</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># /opt/gitlab/bin/gitlab-rake gitlab:backup:create</span><br><br>也可以添加到 crontab -e 中定时执行：<br>0 2 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create <br><br>备份完成，会在备份目录中生成一个当天日期的tar包。<br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># ls /var/opt/gitlab/backups/</span><br>1588774133_2020_05_06_12.10.3_gitlab_backup.tar<br></code></pre></td></tr></table></figure><p><strong>数据恢复</strong></p><p><strong>特别注意：</strong></p><p><code>备份目录和gitlab.rb中定义的备份目录必须一致</code><br><code>GitLab的版本和备份文件中的版本必须一致，否则还原时会报错</code></p><p><strong>在恢复之前，可以删除一个文件，以便查看效果</strong></p><p><strong>执行恢复操作：</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># cd /var/opt/gitlab/backups/</span><br><span class="hljs-section">[root@git-server backups]</span><span class="hljs-comment"># gitlab-rake gitlab:backup:restore BACKUP=1588774133_2020_05_06_12.10.3</span><br>注意恢复文件的名称<br><br><span class="hljs-comment"># 中途会输入2次yes</span><br><br>恢复完成后，或者重启服务，再打开浏览器进行访问，发现数据和之前的一致：<br><span class="hljs-section">[root@git-server backups]</span><span class="hljs-comment"># gitlab-ctl  restart</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>gitee 部署及操作步骤</title>
    <link href="/2025/11/06/gitee-%E9%83%A8%E7%BD%B2%E5%8F%8A%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4/"/>
    <url>/2025/11/06/gitee-%E9%83%A8%E7%BD%B2%E5%8F%8A%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4/</url>
    
    <content type="html"><![CDATA[<p><strong>gitee 部署及操作步骤</strong></p><h2 id="配置密钥"><a href="#配置密钥" class="headerlink" title="配置密钥"></a>配置密钥</h2><h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 获取密钥</span><br><span class="hljs-section">[root@git-client ~]</span><span class="hljs-comment">#ssh-keygen</span><br></code></pre></td></tr></table></figure><h2 id="配置gitee密钥"><a href="#配置gitee密钥" class="headerlink" title="配置gitee密钥"></a>配置gitee密钥</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 配置gitee密钥</span><br><span class="hljs-section">[root@git-client ~]</span><span class="hljs-comment">#cat .ssh/id_rsa.pub</span><br>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDMKR4f2AfwFMbd7YtOHPzOHcIuMY5OjQbt5jnx8BRm8xDAdFDG5XHNW39APOrXxc5AAD6YOoAvIxxw+lLxDrvbR6KKKllZb6Y7XJn1Y7G4r8+beBkz0jQpK1haG39pJwCAcZenwRhwy0xa9Z7PzKmTPBblf9kmR7PTuT6ndxuWx8ekIqLil0eT1BbXc3sO7zRTyIJPiLsWn4VlLdgZkU6UDw4R0iMlSdpEL3f9NfxztWNjp/8vdG6tq5DXmEKcIjI0grl9KNRcRc+PdfaUXaUPjf1MS5zCmuECg0T+1dcKS1q8KQUOIYaG3vyFZ4GqZKxn2OcuWYanr4mChvtu3Esh root@git-client<br><span class="hljs-comment"># 将密钥复制粘贴到gitee上面</span><br><br><span class="hljs-comment"># 步骤</span><br>右上角头像--设置--左侧SSH公钥--复制粘贴密钥保存即可<br></code></pre></td></tr></table></figure><h2 id="获取gitee的ssh克隆路径"><a href="#获取gitee的ssh克隆路径" class="headerlink" title="获取gitee的ssh克隆路径"></a>获取gitee的ssh克隆路径</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">在gitee个人仓库页面--点击克隆/下载--复制里面的ssh路径<br></code></pre></td></tr></table></figure><h2 id="终端操作"><a href="#终端操作" class="headerlink" title="终端操作"></a>终端操作</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 创建gitee目录</span><br><span class="hljs-section">[root@git-client ~]</span><span class="hljs-comment"># mkdir gitee</span><br><br><span class="hljs-comment"># 进入目录</span><br><span class="hljs-section">[root@git-client ~]</span><span class="hljs-comment"># cd gitee</span><br><br><span class="hljs-comment"># 克隆gitee仓库</span><br><span class="hljs-section">[root@git-client gitee]</span><span class="hljs-comment"># git clone git@gitee.com:xbd666/qingfeng.git</span><br><br><span class="hljs-comment"># 验证是否克隆成功</span><br><span class="hljs-section">[root@git-client gitee]</span><span class="hljs-comment"># ll</span><br>总用量 0<br>drwxr-xr-x 3 root root 92 12月 25 19:54 qingfeng<br></code></pre></td></tr></table></figure><h2 id="终端操作上传"><a href="#终端操作上传" class="headerlink" title="终端操作上传"></a>终端操作上传</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 进入仓库目录</span><br><span class="hljs-section">[root@git-client gitee]</span><span class="hljs-comment"># cd qingfeng/</span><br><span class="hljs-section">[root@git-client qingfeng]</span><span class="hljs-comment"># ll</span><br>-rw-rw-rw- 1 root root 2170 11月 23 15:23 beifen.sh<br><span class="hljs-section">[root@git-client qingfeng]</span><span class="hljs-comment"># pwd</span><br>/root/gitee/qingfeng<br><br><span class="hljs-comment"># 保存到存储区</span><br><span class="hljs-section">[root@git-client qingfeng]</span><span class="hljs-comment"># git add .</span><br><br><span class="hljs-comment"># 更新</span><br><span class="hljs-section">[root@git-client qingfeng]</span><span class="hljs-comment"># git commit -m &quot;beifeng1&quot;</span><br><span class="hljs-section">[master 5c2679a]</span> beifeng1<br> 1 file changed, 69 insertions(+)<br> create mode 100644 beifen.sh<br><br><span class="hljs-comment"># 上传到gitee仓库里</span><br><span class="hljs-section">[root@git-client qingfeng]</span><span class="hljs-comment"># git push origin master</span><br>Counting objects: 4, done.<br>Delta compression using up to 2 threads.<br>Compressing objects: 100% (3/3), done.<br>Writing objects: 100% (3/3), 1.10 KiB | 0 bytes/s, done.<br>Total 3 (delta 1), reused 0 (delta 0)<br>remote: Powered by GITEE.COM <span class="hljs-section">[GNK-6.4]</span><br>To git@gitee.com:xbd666/qingfeng.git<br>   8881a7f..5c2679a  master -&gt; master<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>偌依 项目部署及上线步骤</title>
    <link href="/2025/11/06/%E5%81%8C%E4%BE%9D-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E5%8F%8A%E4%B8%8A%E7%BA%BF%E6%AD%A5%E9%AA%A4/"/>
    <url>/2025/11/06/%E5%81%8C%E4%BE%9D-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E5%8F%8A%E4%B8%8A%E7%BA%BF%E6%AD%A5%E9%AA%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="准备实验环境，准备3台机器"><a href="#准备实验环境，准备3台机器" class="headerlink" title="准备实验环境，准备3台机器"></a>准备实验环境，准备3台机器</h2><ul><li><p>1.作为前端服务器，mysql,redis服务器–同时临时作为代码打包服务器<br>192.168.2.65nginx-server</p></li><li><p>2.作为后端服务器<br>192.168.2.66java-server-1<br>192.168.2.67java-server-2</p></li></ul><p><code>关闭防火墙，selinux</code></p><h2 id="环境一键脚本"><a href="#环境一键脚本" class="headerlink" title="环境一键脚本"></a>环境一键脚本</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/toolbox.sh<br></code></pre></td></tr></table></figure><h2 id="安装nginx-mysql"><a href="#安装nginx-mysql" class="headerlink" title="安装nginx&#x2F;mysql"></a>安装nginx&#x2F;mysql</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#安装nginx</span><br><span class="hljs-section">[root@web-nginx ~]</span><span class="hljs-comment"># vim /etc/yum.repos.d/nginx.repo</span><br><span class="hljs-section">[nginx-stable]</span><br><span class="hljs-attr">name</span>=nginx stable repo<br><span class="hljs-attr">baseurl</span>=http://nginx.org/packages/centos/<span class="hljs-variable">$releasever</span>/<span class="hljs-variable">$basearch</span>/<br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">0</span><br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-section">[root@web-nginx ~]</span><span class="hljs-comment"># yum install -y nginx</span><br><br><span class="hljs-comment">#安装mysql5.7</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># rpm -ivh mysql80-community-release-el7-3.noarch.rpm </span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># vim /etc/yum.repos.d/mysql-community.repo </span><br>将mysql8.0关闭将mysql5.7开启<br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">0</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># yum install -y mysql-community-server</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># systemctl start mysqld</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># grep pass /var/log/mysqld.log </span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># mysqladmin -uroot -p&#x27;HdV&gt;.f&gt;Ir8;h&#x27; password &#x27;QingFeng@123!&#x27;</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># mysql -uroot -p&#x27;QingFeng@123!&#x27;</span><br><span class="hljs-comment">#创建数据库ry</span><br>mysql&gt; create database ry character set utf8 collate  utf8_general_ci<span class="hljs-comment">;</span><br>Query OK, 1 row affected (0.00 sec)<br><br><span class="hljs-comment">#设置root允许远程登录</span><br>mysql&gt; update mysql.user set <span class="hljs-attr">host</span> = <span class="hljs-string">&#x27;%&#x27;</span> where user = <span class="hljs-string">&#x27;root&#x27;</span><span class="hljs-comment">;</span><br>Query OK, 1 row affected (0.10 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0<br><span class="hljs-comment">#刷新权限</span><br>mysql&gt; flush privileges<span class="hljs-comment">;</span><br><span class="hljs-comment">#退出</span><br>mysql&gt; \q<br></code></pre></td></tr></table></figure><h2 id="安装redis"><a href="#安装redis" class="headerlink" title="安装redis"></a>安装redis</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/redis-4.0.9.tar.gz</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># tar xzvf redis-4.0.9.tar.gz -C /usr/local/</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># mv /usr/local/redis-4.0.9 /usr/local/redis</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># yum install -y gcc make</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cd /usr/local/redis</span><br><span class="hljs-section">[root@nginx-server redis]</span><span class="hljs-comment"># make</span><br><span class="hljs-section">[root@nginx-server redis]</span><span class="hljs-comment"># cp /usr/local/redis/redis.conf /usr/local/redis/redis.conf.bak</span><br><span class="hljs-section">[root@nginx-server redis]</span><span class="hljs-comment"># vim redis.conf </span><br>bind 192.168.198.160　　<span class="hljs-comment">#只监听内网IP</span><br>daemonize yes　　　　　<span class="hljs-comment">#开启后台模式将on改为yes</span><br>port 6379                      <span class="hljs-comment">#端口号</span><br><br><span class="hljs-comment">#启动redis, 放后台运行</span><br><span class="hljs-section">[root@nginx-server redis]</span><span class="hljs-comment"># src/redis-server redis.conf &amp;</span><br><span class="hljs-comment">#查看端口有没有起来</span><br><span class="hljs-section">[root@nginx-server redis]</span><span class="hljs-comment"># netstat -lntp | egrep &#x27;3306|6379&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="前后端打包环境并打包"><a href="#前后端打包环境并打包" class="headerlink" title="前后端打包环境并打包"></a>前后端打包环境并打包</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs ini">安装后端打包工具<br><span class="hljs-comment">#安装jdk</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/jdk-8u271-linux-x64.tar.gz</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># tar zxvf jdk-11.0.20_linux-x64_bin.tar.gz -C /usr/local</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># mv /usr/local/jdk-11.0.20 /usr/local/java</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-attr">JAVA_HOME</span>=/usr/local/java<br><span class="hljs-attr">PATH</span>=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br>export JAVA_HOME PATH<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># source /etc/profile</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># java -version</span><br><br><span class="hljs-comment">#下载maven包</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/apache-maven-3.9.6-bin.tar.gz</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># tar zxvf apache-maven-3.9.6-bin.tar.gz -C /usr/local</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># mv /usr/local/apache-maven-3.9.6 /usr/local/maven</span><br><span class="hljs-comment">#设置环境变量</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-attr">MAVEN_HOME</span>=/usr/local/maven<br><span class="hljs-attr">PATH</span>=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$MAVEN_HOME</span>/bin<br>export MAVEN_HOME PATH<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># source /etc/profile</span><br><span class="hljs-comment">#检测maven是否安装成功</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># mvn -version</span><br><br><span class="hljs-comment">#安装node.js前端打包工具命令npm</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># wget https://nodejs.org/dist/v12.18.4/node-v12.18.4-linux-x64.tar.xz</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># tar xf node-v12.18.4-linux-x64.tar.xz -C /usr/local/</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># mv /usr/local/node-v12.18.4-linux-x64 /usr/local/node</span><br><span class="hljs-comment">#设置变量</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-attr">NODE_HOME</span>=/usr/local/node<br><span class="hljs-attr">PATH</span>=<span class="hljs-variable">$NODE_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br>export NODE_HOME PATH<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># source /etc/profile</span><br><span class="hljs-comment">#查看版本</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># node --version</span><br><br><span class="hljs-comment">#下载偌依代码包，也可以下载git仓库拉取代码包</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/RuoYi-Vue-master.zip</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># yum -y install unzip</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># unzip RuoYi-Vue-master.zip</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cd RuoYi-Vue-master/</span><br><span class="hljs-section">[root@nginx-server RuoYi-Vue-master]</span><span class="hljs-comment"># cd RuoYi-Vue</span><br><span class="hljs-section">[root@nginx-server RuoYi-Vue]</span><span class="hljs-comment"># cd ruoyi-admin/src/main/resources/</span><br>编辑代码配置文件修改数据库与redis连接地址<br>1.修改redis<br><span class="hljs-section">[root@nginx-server resources]</span><span class="hljs-comment"># vim application.yml</span><br><span class="hljs-comment"># redis 配置</span><br>  redis:<br>    <span class="hljs-comment"># 地址</span><br>    host: 192.168.2.65<span class="hljs-comment">#需修改</span><br>    <span class="hljs-comment"># 端口，默认为6379</span><br>    port: 6379<br>    <span class="hljs-comment"># 密码</span><br>    password:<br>2.修改mysql<br><span class="hljs-section">[root@nginx-server resources]</span><span class="hljs-comment"># vim application-druid.yml</span><br><span class="hljs-comment"># 数据源配置</span><br>spring:<br>    datasource:<br>        type: com.alibaba.druid.pool.DruidDataSource<br>        driverClassName: com.mysql.cj.jdbc.Driver<br>        druid:<br>            <span class="hljs-comment"># 主库数据源</span><br>            master:<br>                url: jdbc:mysql://192.168.2.65:3306/（ry）?<span class="hljs-attr">useUnicode</span>=<span class="hljs-literal">true</span>&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull（&amp;useSSL=<span class="hljs-literal">false</span>&amp;）serverTimezone=GMT%<span class="hljs-number">2</span>B8<br>                username: root<br>                password: QianFeng@123!<br><span class="hljs-comment">#另外打括号的地方是需修改的地方</span><br>`ry 是数据库的名字，需要和数据库名字一致`<br>&amp;<span class="hljs-attr">useSSL</span>=<span class="hljs-literal">false</span>&amp; 改成取消加密<br>同时注意数据库连接这里是否启动加密连接，如果启用了加密连接有可能会造成代码与数据库连接不上。修改为:<br>&amp;<span class="hljs-attr">useSSL</span>=<span class="hljs-literal">false</span>&amp;<br></code></pre></td></tr></table></figure><h2 id="打包前端代码"><a href="#打包前端代码" class="headerlink" title="打包前端代码"></a>打包前端代码</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cd RuoYi-Vue-master/ruoyi-ui/</span><br><span class="hljs-comment">#替换为国内淘宝镜像源</span><br><span class="hljs-section">[root@nginx-server ruoyi-ui]</span><span class="hljs-comment"># npm install --unsafe-perm --registry=https://registry.npm.taobao.org</span><br><span class="hljs-comment">#正式环境打包前端代码</span><br><span class="hljs-section">[root@nginx-server ruoyi-ui]</span><span class="hljs-comment"># npm run build:prod</span><br><br>构建打包成功之后，会在根目录生成 dist 文件夹，里面就是构建打包好的文件，通常是 xxx.js 、xxx.css、index.html 等静态文件。<br><br>通常情况下 dist 文件夹的静态文件发布到你的 nginx 或者静态服务器即可，其中的 index.html 是后台服务的入口页面。<br><span class="hljs-section">[root@nginx-server ruoyi-ui]</span><span class="hljs-comment"># ls</span><br>babel.config.js  build  node_modules  package-lock.json  README.md  vue.config.js<br>bin              dist   package.json  public             src<br><span class="hljs-section">[root@nginx-server ruoyi-ui]</span><span class="hljs-comment"># cd dist/</span><br><span class="hljs-section">[root@nginx-server dist]</span><span class="hljs-comment"># ls   ----前端代码完成</span><br>favicon.ico  index.html  robots.txt  static<br></code></pre></td></tr></table></figure><h2 id="打包后端代码"><a href="#打包后端代码" class="headerlink" title="打包后端代码"></a>打包后端代码</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cd RuoYi-Vue-master/</span><br><span class="hljs-section">[root@nginx-server RuoYi-Vue-master]</span><span class="hljs-comment"># cd sql/</span><br><span class="hljs-section">[root@nginx-server sql]</span><span class="hljs-comment"># ls</span><br>quartz.sql  ry_20200920.sql<br><span class="hljs-comment">#导入数据给创建的数据库里面</span><br><span class="hljs-section">[root@nginx-server sql]</span><span class="hljs-comment"># mysql -uroot -p&#x27;QianFeng@123!&#x27; ry &lt; quartz.sql </span><br>mysql: <span class="hljs-section">[Warning]</span> Using a password on the command line interface can be insecure.<br><span class="hljs-section">[root@nginx-server sql]</span><span class="hljs-comment"># mysql -uroot -p&#x27;QianFeng@123!&#x27; ry &lt; ry_20200920.sql</span><br>mysql: <span class="hljs-section">[Warning]</span> Using a password on the command line interface can be insecure.<br><br><span class="hljs-comment">#开始后端打包jar包</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cd RuoYi-Vue-master/</span><br><span class="hljs-section">[root@nginx-server RuoYi-Vue-master]</span><span class="hljs-comment"># mvn package  ---后端打包命令 ----时间较长</span><br><span class="hljs-comment">#然后会在项目下生成 target文件夹包含 war 或jar （多模块生成在ruoyi-admin）</span><br><span class="hljs-section">[root@nginx-server RuoYi-Vue-master]</span><span class="hljs-comment"># cd ruoyi-admin/</span><br><span class="hljs-section">[root@nginx-server ruoyi-admin]</span><span class="hljs-comment"># ls</span><br>pom.xml  src  target<br><span class="hljs-section">[root@nginx-server target]</span><span class="hljs-comment"># ls</span><br>classes  generated-sources  maven-archiver  maven-status  ruoyi-admin.jar  ruoyi-admin.jar.original<br></code></pre></td></tr></table></figure><h2 id="准备后端java服务"><a href="#准备后端java服务" class="headerlink" title="准备后端java服务"></a>准备后端java服务</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs ini">两台机器修改主机名<br><span class="hljs-comment"># hostnamectl set-hostname java-server</span><br>关闭防火墙和selinux<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># systemctl stop firewalld</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># setenforce 0</span><br>两台机器上传idk<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/jdk-8u271-linux-x64.tar.gz</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># tar zxvf jdk-8u271-linux-x64.tar.gz -C /usr/local</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># mv /usr/local/jdk1.8.0_271 /usr/local/java</span><br><span class="hljs-comment">#设置环境变量</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-attr">JAVA_HOME</span>=/usr/local/java<br><span class="hljs-attr">PATH</span>=<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br>export JAVA_HOME PATH<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># source /etc/profile</span><br>查看版本信息<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># java -version</span><br><br>后端机器上都创建<br><span class="hljs-comment">#创建工作目录以及代码上线目录</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># mkdir /application/java-server -p</span><br></code></pre></td></tr></table></figure><h2 id="开始上线服务"><a href="#开始上线服务" class="headerlink" title="开始上线服务"></a>开始上线服务</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini">1.将前端代码放到nginx网站发布目录并启动<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cd /usr/share/nginx/html/</span><br><span class="hljs-section">[root@nginx-server html]</span><span class="hljs-comment"># rm -rf *</span><br><span class="hljs-comment">#拷贝dist目录下所有文件到到当前目录</span><br><span class="hljs-section">[root@nginx-server html]</span><span class="hljs-comment"># cp -r /mnt/ruoyi-ui/dist/* .</span><br><span class="hljs-section">[root@nginx-server html]</span><span class="hljs-comment"># ls #将所有前端代码放到nginx的网站发布目录中</span><br>favicon.ico  index.html  robots.txt  static<br><span class="hljs-section">[root@nginx-server html]</span><span class="hljs-comment"># systemctl start nginx</span><br></code></pre></td></tr></table></figure><p><code>浏览器访问</code></p><h2 id="后端服务上线"><a href="#后端服务上线" class="headerlink" title="后端服务上线"></a>后端服务上线</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#后端机器都操作</span><br>1.将打包好的后端jar包上传到两台后端服务器中<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cd RuoYi-Vue-master/ruoyi-admin/target/</span><br><span class="hljs-section">[root@nginx-server target]</span><span class="hljs-comment"># scp ruoyi-admin.jar 192.168.2.66:/root/</span><br>2.开始上线后端--两台机器相同操作<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># cp ruoyi-admin.jar /application/java-server/</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># cd /application/java-server/</span><br><span class="hljs-section">[root@java-server java-server]</span><span class="hljs-comment"># nohup java -jar -server -Xmx1024m -Xms1024m ruoyi-admin.jar &amp;</span><br><span class="hljs-section">[1]</span> 1212<br><span class="hljs-section">[root@java-server java-server]</span><span class="hljs-comment"># tail -f nohup.out   查看日志</span><br>查看服务端口<br><span class="hljs-section">[root@java-server java-server]</span><span class="hljs-comment"># netstat -lntp </span><br></code></pre></td></tr></table></figure><h2 id="配置反向代理"><a href="#配置反向代理" class="headerlink" title="配置反向代理"></a>配置反向代理</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs ini">配置nginx路径转发与负载均衡<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cd /etc/nginx/conf.d/</span><br><span class="hljs-section">[root@nginx-server conf.d]</span><span class="hljs-comment"># mv default.conf nginx.conf</span><br><span class="hljs-section">[root@nginx-server conf.d]</span><span class="hljs-comment"># vim upstream.conf</span><br>upstream java-web &#123;<br>        server 192.168.198.162:8080 <span class="hljs-attr">weight</span>=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">5</span>s<span class="hljs-comment">;</span><br>        server 192.168.198.163:8080 <span class="hljs-attr">weight</span>=<span class="hljs-number">1</span> max_fails=<span class="hljs-number">2</span> fail_timeout=<span class="hljs-number">5</span>s<span class="hljs-comment">;</span><br>&#125;<br><br><span class="hljs-section">[root@nginx-server conf.d]</span><span class="hljs-comment"># vim app.conf</span><br>server &#123;<br>    listen       80<span class="hljs-comment">;</span><br>    server_name  localhost<span class="hljs-comment">;</span><br><br>    <span class="hljs-comment">#charset koi8-r;</span><br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br>    location / &#123;<br>        root   /usr/share/nginx/html<span class="hljs-comment">;</span><br>        try_files $uri $uri/ /index.html<span class="hljs-comment">;</span><br>        index  index.html index.htm<span class="hljs-comment">;</span><br>    &#125;<br><br>    location /prod-api/&#123;<br>      proxy_pass http://java-web/<span class="hljs-comment">;</span><br>      proxy_set_header Host $http_host<span class="hljs-comment">;</span><br>      proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span><br>      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span><br>   &#125;<br><br>&#125;<br><br><span class="hljs-section">[root@nginx-server conf.d]</span><span class="hljs-comment"># nginx -t </span><br>nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br>nginx: configuration file /etc/nginx/nginx.conf test is successful<br><span class="hljs-section">[root@nginx-server conf.d]</span><span class="hljs-comment"># nginx -s reload</span><br><br><span class="hljs-comment">#解释：</span><br>try_files指令：可以实现自动检测网站根下是否存在用户在浏览器输入的名为URI文件和名为URI的目录，<br>当用户请求 http://localhost/example 时，这里的 $uri 就是 /example。 <br>try_file 会到硬盘里尝试找这个文件。如果存在名为 /$root/example（其中 $root 是项目代码安装目录）的文件，就直接把这个文件的内容发送给用户。 <br>如果目录中没有叫 example 的文件。然后就看 $uri/，增加了一个 /，也就是看有没有名为/$root/example/ 的目录。 <br>若不存在则会跳转至最后一个参数，这以上例子中最后一个参数是根下的/index.html，也就是相当于 nginx 发起一个 HTTP 请求到 http://localhost/index.html<br></code></pre></td></tr></table></figure><h2 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><code>默认账户 admin/admin123</code></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Docker项目：搭建服务器监控面板</title>
    <link href="/2025/11/06/Docker%E9%A1%B9%E7%9B%AE%EF%BC%9A%E6%90%AD%E5%BB%BA%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF/"/>
    <url>/2025/11/06/Docker%E9%A1%B9%E7%9B%AE%EF%BC%9A%E6%90%AD%E5%BB%BA%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF/</url>
    
    <content type="html"><![CDATA[<p><strong>搭建一个专属自己的网站监控——Uptime Kuma</strong><br><strong>安装Docker</strong><br><code>下载docker，docker官方网址docker.com</code><br><strong>创建yml配置文件</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ini">vim docker-compose.yml代码<br>version: &#x27;3.3&#x27;<br><br>services:<br>  uptime-kuma:<br>    image: louislam/uptime-kuma<br>    container_name: uptime-kuma<br>    volumes:<br>      - ./uptime-kuma:/app/data<br>    ports:<br>      - 3001:3001<br></code></pre></td></tr></table></figure><p><strong>反向代理</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ini">server  &#123;<br>    listen 80<span class="hljs-comment">;</span><br>    server_name    vps.7boe.top<span class="hljs-comment">;</span><br>    location / &#123;<br>        proxy_pass         http://localhost:3001<span class="hljs-comment">;</span><br>        proxy_http_version 1.1<span class="hljs-comment">;</span><br>        proxy_set_header   Upgrade $http_upgrade<span class="hljs-comment">;</span><br>        proxy_set_header   Connection &quot;upgrade&quot;<span class="hljs-comment">;</span><br>        proxy_set_header   Host $host<span class="hljs-comment">;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>Docker安装推送镜像</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">docker pull louislam/uptime-kuma<br></code></pre></td></tr></table></figure><p><strong>将宿主机的目录挂载到容器内</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">docker volume create uptime-kuma<br></code></pre></td></tr></table></figure><p><strong>创建容器</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">docker run -d <span class="hljs-attr">--restart</span>=always -p <span class="hljs-number">3001</span>:<span class="hljs-number">3001</span> -v uptime-kuma:/app/data --name uptime-kuma louislam/uptime-kuma:<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p><strong>测试</strong><br><code>浏览器打开IP：3001</code><strong>会出来kuma的登入界面</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Grafana和Prometheus的部署安装</title>
    <link href="/2025/11/06/Grafana%E5%92%8CPrometheus%E7%9A%84%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/"/>
    <url>/2025/11/06/Grafana%E5%92%8CPrometheus%E7%9A%84%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/</url>
    
    <content type="html"><![CDATA[<h1 id="Grafana和Prometheus的搭建"><a href="#Grafana和Prometheus的搭建" class="headerlink" title="Grafana和Prometheus的搭建"></a>Grafana和Prometheus的搭建</h1><h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><h2 id="首先搭建Prometheus-服务端"><a href="#首先搭建Prometheus-服务端" class="headerlink" title="首先搭建Prometheus 服务端"></a>首先搭建Prometheus 服务端</h2><p><code>在官网下载</code></p><h2 id="或者也可以在我的云盘直接下载"><a href="#或者也可以在我的云盘直接下载" class="headerlink" title="或者也可以在我的云盘直接下载"></a>或者也可以在我的云盘直接下载</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/prometheus-Grafana/prometheus-2.47.2.linux-amd64.tar.gz<br></code></pre></td></tr></table></figure><h2 id="下载到服务器后解压出来"><a href="#下载到服务器后解压出来" class="headerlink" title="下载到服务器后解压出来"></a>下载到服务器后解压出来</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># tar xvf prometheus-2.47.2.linux-amd64.tar.gz -C /usr/local/prometheus</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># cd /usr/local/prometheus</span><br><span class="hljs-section">[root@localhost prometheus]</span><span class="hljs-comment"># useradd prometheus -s /usr/sbin/nologin</span><br><span class="hljs-section">[root@localhost prometheus]</span><span class="hljs-comment"># chown -R prometheus.prometheus ./*</span><br></code></pre></td></tr></table></figure><h2 id="进入目录后编辑配置文件，需要改动的是最后几行，是添加其他节点以及主机的"><a href="#进入目录后编辑配置文件，需要改动的是最后几行，是添加其他节点以及主机的" class="headerlink" title="进入目录后编辑配置文件，需要改动的是最后几行，是添加其他节点以及主机的"></a>进入目录后编辑配置文件，需要改动的是最后几行，是添加其他节点以及主机的</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># cd /usr/local/prometheus/</span><br><span class="hljs-section">[root@localhost prometheus]</span><span class="hljs-comment"># vim prometheus.yml</span><br> - job_name: &quot;prometheus&quot;<br><br>    <span class="hljs-comment"># metrics_path defaults to &#x27;/metrics&#x27;</span><br>    <span class="hljs-comment"># scheme defaults to &#x27;http&#x27;.</span><br><br>    static_configs:<br>      - targets: <span class="hljs-section">[&quot;10.31.162.39:9100&quot;]</span><span class="hljs-comment">#更改成自己的IP地址，端口改为9100</span><br></code></pre></td></tr></table></figure><h2 id="启动查看测试"><a href="#启动查看测试" class="headerlink" title="启动查看测试"></a>启动查看测试</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@localhost prometheus]</span><span class="hljs-comment"># ./prometheus //启动后查看9090端口的服务里面tag里面有几台机器</span><br><br>测试<br>在浏览器输入IP：9090 -- 会出来prometheus的界面<br></code></pre></td></tr></table></figure><h2 id="然后写service服务文件，让其可以通过systemctl控制他-配置文件路径改成自己的"><a href="#然后写service服务文件，让其可以通过systemctl控制他-配置文件路径改成自己的" class="headerlink" title="然后写service服务文件，让其可以通过systemctl控制他,配置文件路径改成自己的"></a>然后写service服务文件，让其可以通过systemctl控制他,配置文件路径改成自己的</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ini">service文件要存放在/etc/systemd/system目录下    <br><span class="hljs-section">[root@localhost prometheus]</span><span class="hljs-comment"># cd /etc/systemd/system</span><br><span class="hljs-section">[root@localhost system]</span><span class="hljs-comment"># vim prometheus.service</span><br><span class="hljs-section">[Unit]</span><br><span class="hljs-attr">Description</span>=prometheus<br><span class="hljs-attr">After</span>=network.target <br><br><span class="hljs-section">[Service]</span><br><span class="hljs-attr">User</span>=prometheus<br><span class="hljs-attr">Group</span>=prometheus<br><span class="hljs-attr">WorkingDirectory</span>=/usr/local/prometheus<br><span class="hljs-attr">ExecStart</span>=/usr/local/prometheus/prometheus<br><span class="hljs-section">[Install]</span><br><span class="hljs-attr">WantedBy</span>=multi-user.target<br></code></pre></td></tr></table></figure><h2 id="重载服务，尝试用systemctl控制他开启"><a href="#重载服务，尝试用systemctl控制他开启" class="headerlink" title="重载服务，尝试用systemctl控制他开启"></a>重载服务，尝试用systemctl控制他开启</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini">➜ systemctl daemon-reload<br>➜ systemctl start prometheus.service<br>➜ systemctl enable prometheus.service<br>➜ systemctl status prometheus.service<br></code></pre></td></tr></table></figure><h2 id="安装-node-exporter"><a href="#安装-node-exporter" class="headerlink" title="安装 node_exporter"></a>安装 node_exporter</h2><p><strong>接下来安装node节点，统一采用docker方式安装，没什么因为快。</strong></p><h2 id="先安装docker环境"><a href="#先安装docker环境" class="headerlink" title="先安装docker环境"></a>先安装docker环境</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ini">sudo yum remove docker \<br>                  docker-client \<br>                  docker-client-latest \<br>                  docker-common \<br>                  docker-latest \<br>                  docker-latest-logrotate \<br>                  docker-logrotate \<br>                  docker-engine<br>                  <br>sudo yum install -y yum-utils<br>sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo<br>sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin<br>yum -y install docker-compose<br>sudo systemctl start docker<br></code></pre></td></tr></table></figure><h2 id="配置docker-compose-yml文件"><a href="#配置docker-compose-yml文件" class="headerlink" title="配置docker-compose.yml文件"></a>配置docker-compose.yml文件</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs ini">yml文件要在prometheus目录下的data目录里面<br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># cd /usr/local/prometheus/data/</span><br>version: &#x27;3.8&#x27;<br>services:<br>  grafana:<br>    image: grafana/grafana-enterprise<br>    container_name: grafana<br>    restart: alway<br>    user: &#x27;0&#x27;<br>    ports:<br>      - &#x27;3000:3000&#x27;<br>    <span class="hljs-comment"># adding the mount volume point which we create earlier</span><br>    volumes:<br>      - &#x27;./data:/var/lib/grafana&#x27; //和当前docker-compose文件放在一起的data下<br></code></pre></td></tr></table></figure><h2 id="拉取"><a href="#拉取" class="headerlink" title="拉取"></a>拉取</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">docker pull prom/node-exporter<br></code></pre></td></tr></table></figure><h2 id="一条命令启动"><a href="#一条命令启动" class="headerlink" title="一条命令启动"></a>一条命令启动</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">docker run -d --name node <span class="hljs-attr">--restart</span>=always -p <span class="hljs-number">9100</span>:<span class="hljs-number">9100</span> prom/node-exporter<br><br>直接映射到9100端口了，可以打开看一下测试页，因为是node没有其他东西正常只要在server端添加到配置文件就行了<br></code></pre></td></tr></table></figure><h2 id="安装-Grafana"><a href="#安装-Grafana" class="headerlink" title="安装 Grafana"></a>安装 Grafana</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini">docker run -d <span class="hljs-attr">--name</span>=grafana -p <span class="hljs-number">3000</span>:<span class="hljs-number">3000</span> grafana/grafana<br><br><span class="hljs-comment">#如果需要保持到卷里面,直接用这个(二选一)</span><br>docker run -d -p 3000:3000 <span class="hljs-attr">--name</span>=grafana \<br>  --volume grafana-storage:/var/lib/grafana \<br>  grafana/grafana-enterprise<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><code>在浏览器中输入IP：3000</code><strong>grafana的界面就出来了，此时配置成功</strong></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>KVM 虚拟机部署</title>
    <link href="/2025/11/06/KVM-%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/KVM-%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="什么是虚拟化"><a href="#什么是虚拟化" class="headerlink" title="什么是虚拟化:"></a>什么是虚拟化:</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">vmm、Hypervisor 是提供真正虚拟机管理程序的，---创建，删除-开关机。<br><br>Hypervisor是属于内核功能的，操作系统内核的一个模块。把和内核交互的工具称之为用户肽工具：比如：virsh命令行、virt-manager图形界面，<br></code></pre></td></tr></table></figure><h2 id="虚拟化产品分类"><a href="#虚拟化产品分类" class="headerlink" title="虚拟化产品分类:"></a>虚拟化产品分类:</h2><p><code>桌面级虚拟化</code><br><code>企业级虚拟机化</code></p><h2 id="虚拟化产品分类："><a href="#虚拟化产品分类：" class="headerlink" title="虚拟化产品分类："></a>虚拟化产品分类：</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini">1.Kvm（redhat-----企业级）<br>2.Vmware:<br>Vmware-workstation(windows和linux)----桌面级<br>Vmware-fusion(mac)<br>Vmware-esxi-----(企业级别)本身就是一个操作系统。<br>3.hyper-v(微软）<br>4.Ovm（oracle公司--Windows linux） virtulbox<br>5.Xen（rhel6之前所有版本默认用的虚拟化产品）<br></code></pre></td></tr></table></figure><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p><strong>第一步先在VMware上创建一个虚拟机（内存能多大就做多大）</strong></p><p><code>虚拟机安装好，打开设置--处理器--虚拟化引擎--勾选第一个</code></p><p><img src="/upload/kvm1.webp" alt="kvm1.webp"></p><p><strong>打开虚拟机，查看cpu是否支持虚拟化</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># cat /proc/cpuinfo | grep -E &#x27;vmx|svm&#x27;</span><br>cmx|svm支持其中一个就可以<br></code></pre></td></tr></table></figure><h2 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h2><p><code>关闭防火墙和selinux</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs ini">清理环境，卸载机器自带的kvm<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># yum -y remove `rpm -qa | egrep &#x27;qemu|virt|kvm&#x27;`</span><br><span class="hljs-comment">#删除储存虚拟机的介质、虚拟机配置文件</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># rm -rf /var/lib/libvirt  /etc/libvirt/</span><br><span class="hljs-comment">#升级所有包同时也升级软件和系统内核</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># yum upgrade -y</span><br><span class="hljs-comment">#安装软件</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># yum install *qemu*  *virt*  librbd1-devel -y</span><br>其实下载的是下面几款软件<br><span class="hljs-comment"># qemu-kvm libvirt virt-manager  librbd1-devel</span><br>qemu-kvm ： 主包<br>libvirt：api接口<br>virt-manager：图形化界面<br><br><span class="hljs-comment">#在所谓的kvm技术中，应用到的其实有2个东西：qemu+kvm</span><br>kvm负责cpu虚拟化+内存虚拟化，实现了cpu和内存的虚拟化，但kvm不能模拟其他设备；<br>qemu是模拟IO设备（网卡，磁盘），kvm加上qemu之后就能实现真正意义上服务器虚拟化。<br>因为用到了上面两个东西，所以一般都称之为qemu-kvm。<br>libvirt则是调用kvm虚拟化技术的接口用于管理的，用libvirt管理方便，直接用qemu-kvm的接口太繁琐。<br><br><span class="hljs-comment">#启动服务</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># systemctl start libvirtd</span><br><span class="hljs-comment">#查看kvm模块加载</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># lsmod | grep kvm</span><br>kvm_intel             188644  0 <br>kvm                   621480  1 kvm_intel<br>irqbypass              13503  1 kvm<br>如果看到有这两行，说明支持kvm模块<br></code></pre></td></tr></table></figure><p><strong>下面就可以在VMware里面再安装虚拟机了</strong></p><h2 id="图形添加虚拟机"><a href="#图形添加虚拟机" class="headerlink" title="图形添加虚拟机"></a>图形添加虚拟机</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">在终端输入virt-manager--点击电脑图标创建--本地安装介质--选择使用ISO映像，另外<br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/kvm2.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm3.webp" alt="kvm3.png"></p><p><img src="https://xbd666.cn/upload/kvm4.webp" alt="kvm4.png"></p><p><img src="https://xbd666.cn/upload/kvm5.webp" alt="kvm5.png"></p><p><img src="https://xbd666.cn/upload/kvm6.webp" alt="kvm6.png"></p><p><img src="https://xbd666.cn/upload/kvm7.webp" alt="kvm7.png"></p><h2 id="文本添加虚拟机"><a href="#文本添加虚拟机" class="headerlink" title="文本添加虚拟机"></a>文本添加虚拟机</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#安装ftp，并配置最后将镜像上传到ftp中</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># yum install -y vsftpd</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># mkdir /var/ftp/centos7u4</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># mount /root/CentOS-7-x86_64-DVD-1708.iso /var/ftp/centos7u4/</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virt-install --connect qemu:///system -n vm10 -r 2050 --disk path=/var/lib/libvirt/images/vm10.img,size=5  --os-type=linux --os-variant=centos7.0 --vcpus=1  --location=ftp://10.0.111.182/centos7u4 -x console=ttyS0 --nographics</span><br><br>注意:<br>virt-install <br>bash: virt-install: 未找到命令...<br><span class="hljs-comment"># yum install libguestfs-tools -y</span><br><span class="hljs-comment"># yum install virt-install.noarch -y</span><br><br>如果还是有问题没办法安装，需要vsftp匿名授权，添加以下内容<br>vim /etc/vsftpd/vsftpd.conf//配置文件<br><span class="hljs-attr">anonymous_enable</span>=<span class="hljs-literal">YES</span>  //开启匿名登录<br><span class="hljs-attr">anon_upload_enable</span>=<span class="hljs-literal">YES</span> //匿名读<br><span class="hljs-attr">anon_mkdir_write_enable</span>=<span class="hljs-literal">YES</span> //匿名写<br><br><span class="hljs-comment"># 重启下vsftp</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># systemctl restart vsftpd</span><br><br>参数解释：<br>-n name<br>-r  以M为单位指定分配给虚拟机的内存大小<br>--disk 指定作为客户机存储的媒介 size以G为单位的存储<br>--os-type   系统类型<br>--os-variant 系统类型版本<br>--vcpus 指定核数，不能超过物理cpu<br>--location  客户虚拟机安装源下载，必须为镜像挂载在ftp目录下<br>-x <span class="hljs-attr">console</span>=ttyS0 执行终端<span class="hljs-number">0</span><br>--nographics 无图形，文本模式<br><br><span class="hljs-comment">#以下就是进入命令安装</span><br>1、选2，进入use text mode<br>2、将所有的！进行编辑，编辑好的状态是×<br>3、更改时间选2 -- 1 set timezone-- 2 Asia -- 65 Shanghai<br>4、设置磁盘5 -- c to continue -- 2 Use All Space -- c to continue -- 3 LVM -- c to continue <br>5、设置密码8 -- 自己设定一个密码 -- yes<br>6、设置完成-- b<br>7、开始创建，大概20分钟左右<br>8、出现installation complete. press return to quit--按回车退出--下面的操作根据提示点点就可以了<br></code></pre></td></tr></table></figure><h2 id="模板镜像-配置文件-方式安装虚拟机—重点"><a href="#模板镜像-配置文件-方式安装虚拟机—重点" class="headerlink" title="模板镜像+配置文件 方式安装虚拟机—重点"></a>模板镜像+配置文件 方式安装虚拟机—重点</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs ini">1.虚拟机配置文件<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ls /etc/libvirt/qemu</span><br>networks  vm2.xml<br>2.储存虚拟机的介质<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ls /var/lib/libvirt/images/</span><br><span class="hljs-attr">vm2.img</span><br>==============================<br>define方式创建好，不会启动<br>create方式创建好，会启动<br><br><span class="hljs-comment"># 拷贝模板镜像和配置文件</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># cp /etc/libvirt/qemu/vm2.xml /etc/libvirt/qemu/vm3.xml(自定义名字)</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># cp /var/lib/libvirt/images/vm2.img /var/lib/libvirt/images/vm3.img (自定义名字)</span><br><span class="hljs-comment"># 修改配置文件</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># vim /etc/libvirt/qemu/vm3.xml</span><br>domain <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;kvm&#x27;</span>&gt;<br>  &lt;name&gt;vm3&lt;/name&gt;  <span class="hljs-comment">#名字不能一样需要修改</span><br>  &lt;uuid&gt;2e3fa6db-ff7f-41c3-bc8f-0428e81ebb57&lt;/uuid&gt; <span class="hljs-comment">#uuid不能一样需要修改</span><br>  &lt;memory <span class="hljs-attr">unit</span>=<span class="hljs-string">&#x27;KiB&#x27;</span>&gt;<span class="hljs-number">1024000</span>&lt;/memory&gt;  <span class="hljs-comment">#内存，可选</span><br>  &lt;currentMemory <span class="hljs-attr">unit</span>=<span class="hljs-string">&#x27;KiB&#x27;</span>&gt;<span class="hljs-number">1024000</span>&lt;/currentMemory&gt;  <span class="hljs-comment">#当前内存与上面定义一样</span><br>  &lt;vcpu <span class="hljs-attr">placement</span>=<span class="hljs-string">&#x27;static&#x27;</span>&gt;<span class="hljs-number">2</span>&lt;/vcpu&gt;  <span class="hljs-comment">#cpu可选</span><br>  &lt;os&gt;<br>  。。。<br>  。。。<br>  。。。<br>    &lt;devices&gt;<br>    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;<br>    &lt;disk <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;file&#x27;</span> device=<span class="hljs-string">&#x27;disk&#x27;</span>&gt;<br>      &lt;driver <span class="hljs-attr">name</span>=<span class="hljs-string">&#x27;qemu&#x27;</span> type=<span class="hljs-string">&#x27;qcow2&#x27;</span>/&gt;<br>      &lt;source <span class="hljs-attr">file</span>=<span class="hljs-string">&#x27;/var/lib/libvirt/images/vm3.img&#x27;</span>/&gt;   <span class="hljs-comment">#磁盘镜像需要修改</span><br>      &lt;target <span class="hljs-attr">dev</span>=<span class="hljs-string">&#x27;vda&#x27;</span> bus=<span class="hljs-string">&#x27;virtio&#x27;</span>/&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x07&#x27;</span> function=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br>    &lt;/disk&gt;<br> 。。。<br> 。。。<br> 。。。<br>     &lt;/controller&gt;<br>    &lt;interface <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;network&#x27;</span>&gt;<br>      &lt;mac <span class="hljs-attr">address</span>=<span class="hljs-string">&#x27;52:54:00:82:d6:3c&#x27;</span>/&gt;  <span class="hljs-comment">#mac地址不能一样需要修改，只能修改后三段。</span><br>      &lt;source <span class="hljs-attr">network</span>=<span class="hljs-string">&#x27;default&#x27;</span>/&gt;<br>      &lt;model <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;virtio&#x27;</span>/&gt;<br><br><span class="hljs-comment">#必须修改name，uuid,mac地址,磁盘文件名字,其余可选</span><br><br>用vim修改完之后需要define一下配置文件<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh define /etc/libvirt/qemu/vm3.xml</span><br>重启一下：<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># systemctl restart libvirtd</span><br>宿主机开启路由转发：<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># vim /etc/sysctl.conf </span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># sysctl -p</span><br><span class="hljs-attr">net.ipv4.ip_forward</span> = <span class="hljs-number">1</span><br>查看虚拟机列表：<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh list --all</span><br> Id    名称                         状态<br>----------------------------------------------------<br> -     vm2                            关闭<br> -     vm3                            关闭<br></code></pre></td></tr></table></figure><h2 id="KVM虚拟机管理"><a href="#KVM虚拟机管理" class="headerlink" title="KVM虚拟机管理"></a>KVM虚拟机管理</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh list  #列出在运行状态中的虚拟机</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh list --all  #列出所有虚拟机</span><br>查看kvm虚拟机配置文件：<br><span class="hljs-comment">#语法：virsh dumpxml vm_name</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh dumpxml vm3</span><br><br>启动<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh start vm2</span><br>域 vm2 已开始<br><br>暂停虚拟机：<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh suspend vm_name</span><br>域 vm2 被挂起<br><br>恢复虚拟机：<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh resume vm_name</span><br>域 vm2 被重新恢复<br><br>关闭：<br>方法1：<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh shutdown vm3</span><br>域 vm3 被关闭<br><br>重启：<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh reboot vm3</span><br>域 vm3 正在被重新启动<br><br>重置:<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh reset vm3</span><br>vm3   <span class="hljs-comment">#断电重启。速度快</span><br>Domain vm3 was reset<br><br>删除虚拟机:<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh undefine vm2</span><br>Domain vm2 has been undefined<br>注意:虚拟机在开启的情况下undefine是无法删除的只是将配置文件删除了，不能删除磁盘文件。需要手动rm，最好还是在virt-manager里面右击删除<br><br>虚拟机开机自动启动:<br><span class="hljs-comment">#如果虚拟机开机自启，里面的服务应该设置的有开机自启，不然没有意义</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh autostart vm_name</span><br>域 vm3标记为自动开始<br><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ls /etc/libvirt/qemu/autostart/     //此目录默认不存在，在有开机启动的虚拟机时自动创建</span><br>vm3.xml<br><br>关闭开机启动<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh autostart --disable vm_name</span><br>域 vm3取消标记为自动开始<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ls /etc/libvirt/qemu/autostart/</span><br><br>如何查看已启动的虚拟机ip地址<br>假如vm3虚拟机已启动<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh domifaddr vm3</span><br> 名称     MAC 地址           Protocol     Address<br>-------------------------------------------------------------------------------<br> vnet0      52:54:00:82:d6:3c    ipv4         192.168.122.85/24<br></code></pre></td></tr></table></figure><h2 id="虚拟机添加设备"><a href="#虚拟机添加设备" class="headerlink" title="虚拟机添加设备"></a>虚拟机添加设备</h2><p>1、图像方式添加</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">输入virt-manager--右击点击你想要添加设备的虚拟机--查看--详情--左下角--添加硬件--安装需求添加就可以了<br></code></pre></td></tr></table></figure><p>2、修改配置文件方式添加</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># qemu-img create -f qcow2 /var/lib/libvirt/images/vm4-1.qcow2 5G</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># cd /etc/libvirt/qemu/</span><br><span class="hljs-section">[root@kvm-server qemu]</span><span class="hljs-comment"># vim vm3.xml</span><br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/kvm8.webp" alt="kvm8.png"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ini">加好之后，启动虚拟机<br><span class="hljs-section">[root@kvm-server qemu]</span><span class="hljs-comment"># systemctl restart libvirtd</span><br><span class="hljs-section">[root@kvm-server qemu]</span><span class="hljs-comment"># virsh list --all</span><br> Id    名称                         状态<br>----------------------------------------------------<br> 6     centos7.0                      running<br> -     vm3                            关闭<br><span class="hljs-section">[root@kvm-server qemu]</span><span class="hljs-comment"># virsh start vm3</span><br><br>可以看到我们新添加的磁盘vdb<br><span class="hljs-comment">#然后可以正常分区，制作文件系统，进行挂载</span><br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/kvm9.webp" alt="kvm9.png"></p><h2 id="虚拟机克隆"><a href="#虚拟机克隆" class="headerlink" title="虚拟机克隆"></a>虚拟机克隆</h2><p>1.图形界面：Applications （左上角）—–&gt; System Tools ——&gt;Virtual Machine Manager<br>   <code>关闭要克隆的虚拟机，右键点击虚拟机选择Clone</code></p><p><img src="https://xbd666.cn/upload/kvm10.webp" alt="kvm10.png"></p><p>2.在终端执行命令克隆</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virt-clone -o vm2 -n vm5 --auto-clone</span><br>正在分配 &#x27;vm5.qcow2&#x27;                                    | 5.0 GB  00:00     <br>成功克隆 &#x27;vm5&#x27;。<br>-o      origin-原始<br>-n :指定新客户机的名字<br><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh list --all</span><br> Id    名称                         状态<br>----------------------------------------------------<br> -     vm2                            关闭<br> -     vm5                      关闭<br></code></pre></td></tr></table></figure><h2 id="kvm高级命令"><a href="#kvm高级命令" class="headerlink" title="kvm高级命令"></a>kvm高级命令</h2><p>磁盘镜像文件的格式：<code>raw  qcow2</code></p><ul><li>raw：立刻分配空间，不管你有没有用到那么多空间</li><li>qcow2：只是承诺给你分配空间，但是只有当你需要用空间的时候，才会给你空间。最多只给你承诺空间的大小，避免空间浪费</li></ul><h2 id="建立qcow2格式磁盘文件"><a href="#建立qcow2格式磁盘文件" class="headerlink" title="建立qcow2格式磁盘文件"></a>建立qcow2格式磁盘文件</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># pwd</span><br>/var/lib/libvirt/images<br><span class="hljs-comment">#创建qcow2格式磁盘格式文件（vm1.qcow2是自定义的磁盘名字）</span><br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># qemu-img create -f qcow2 vm1.qcow2 5G</span><br>Formatting &#x27;vm1.qcow2&#x27;, <span class="hljs-attr">fmt</span>=qcow2 size=<span class="hljs-number">5368709120</span> encryption=<span class="hljs-literal">off</span> cluster_size=<span class="hljs-number">65536</span> lazy_refcounts=<span class="hljs-literal">off</span> <br><br><span class="hljs-comment">#创建raw格式磁盘格式文件（vm2.raw是自定义的磁盘名字）</span><br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># qemu-img create -f raw vm2.raw 5G</span><br>Formatting &#x27;vm2.raw&#x27;, <span class="hljs-attr">fmt</span>=raw size=<span class="hljs-number">5368709120</span> <br><br><span class="hljs-comment">#查看已经创建的虚拟磁盘文件</span><br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># qemu-img info vm1.qcow2</span><br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># qemu-img info vm2.raw</span><br></code></pre></td></tr></table></figure><h2 id="挂载磁盘"><a href="#挂载磁盘" class="headerlink" title="挂载磁盘"></a>挂载磁盘</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 将虚拟机先关闭</span><br>查看vm2磁盘镜像分区信息--（需要等一会会）<br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># virt-df -h -d vm2</span><br>文件系统                                  大小      已用空间    可用空间     使用百分比%<br>vm2:/dev/sda1                            1014M        92M       922M         10%<br>vm2:/dev/centos/root                      3.5G       863M       2.6G         25%<br><br><span class="hljs-comment"># 创建一个挂载目录</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># mkdir /test</span><br><span class="hljs-comment">#挂载虚拟机的根分区到test目录</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># guestmount -d vm2 -m /dev/centos/root --rw /test/</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ll /test</span><br>bin   dev  home  lib64  mnt  proc  run   srv  tmp  var<br>boot  etc  lib   media  opt  root  sbin  sys  usr<br><br><span class="hljs-comment"># 取消挂载</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># guestunmount /test</span><br></code></pre></td></tr></table></figure><h2 id="KVM存储配置"><a href="#KVM存储配置" class="headerlink" title="KVM存储配置"></a>KVM存储配置</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#kvm默认存储池的位置：</span><br>    /var/lib/libvirt/images/    <br></code></pre></td></tr></table></figure><p>1、图形方式创建存储池</p><p><img src="https://xbd666.cn/upload/kvm11.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm12.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm13.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm14.webp" alt="kvm2.png"></p><p>2、命令方式创建存储池</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs ini">1.创建基于文件夹的存储池（目录，可自定义）<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># mkdir -p /data/vmfs</span><br><br>2.定义存储池与其目录--（vm1是存储池名字，自己自定义）<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh pool-define-as vm1 --type dir --target /data/vmfs</span><br>Pool vm1 defined<br><br>3.创建已定义的存储池<br>(1)构建已定义的存储池<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh pool-build vm1</span><br>Pool vm1 built<br><br>(2)查看已定义的存储池，存储池不激活无法使用。<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh pool-list --all</span><br>Name                 State      Autostart <br>-------------------------------------------<br> default             active       yes       <br> ISO                 active       yes       <br> vm1              inactive     no     <br> <br>4.激活并自动启动已定义的存储池<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh pool-start vm1</span><br>Pool vm1 started<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh pool-autostart vm1</span><br>Pool vm1 marked as autostarted<br><br><span class="hljs-comment">#此时查看都是在运行中，并且是开机自启</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh pool-list --all</span><br> Name                 State      Autostart <br>-------------------------------------------<br> default              active     yes       <br> ISO                 active     yes       <br> vm1               active     yes   <br>这里vm1存储池就已经创建好了，可以直接在这个存储池中创建虚拟磁盘文件了。<br><br>5.在存储池中创建虚拟机存储卷--（vm1-1.qcow2是自定义存储卷的名字，2G是自定义的大小）<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh vol-create-as vm1 vm1-1.qcow2 2G --format qcow2 </span><br>Vol vm1-1.qcow2 created<br><br><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ll /data/vmfs/ -h</span><br>总用量 196K<br>-rw------- 1 root root 193K 10月 25 16:04 vm1-1.qcow2<br><br>6.存储池相关管理命令<br>(1)在存储池中删除虚拟机存储卷<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh vol-delete --pool vm1 vm1-1.qcow2</span><br>Vol vm1-1.qcow2 deleted<br><br>(2)取消激活存储池<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh pool-destroy vm1</span><br>Pool vm1 destroyed<br><br>(3)删除存储池定义的目录/data/vmfs<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh pool-delete vm1</span><br>Pool vm1 deleted<br><br>(4)取消定义存储池<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh pool-undefine vm1</span><br>Pool vm1 has been undefined<br><br>到此kvm存储池配置与管理操作完毕。 <br></code></pre></td></tr></table></figure><h2 id="kvm快照"><a href="#kvm快照" class="headerlink" title="kvm快照"></a>kvm快照</h2><p>1、图形方式创建快照</p><p><img src="https://xbd666.cn/upload/kvm15.webp" alt="kvm2.png"></p><p>2、命令方式创建快照</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ini">为虚拟机vm2创建一个快照（磁盘格式必须为qcow2）<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh snapshot-create-as vm2 vm2.snap1</span><br><br>注意：如果在创建快照的时候报错：<br>error: unsupported configuration: internal snapshot for disk vda unsupported for storage type raw<br><br><span class="hljs-comment">#raw不支持snapshot--可以将raw格式转换成qcow2格式</span><br><br>查看磁盘文件格式<br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># qemu-img info /var/lib/libvirt/images/vm2.qcow2</span><br>image: /var/lib/libvirt/images/vm2.qcow2<br>file format: qcow2<br>virtual size: 5.0G (5368709120 bytes)<br>disk size: 5.0G<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: true<br></code></pre></td></tr></table></figure><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 查看某台虚拟机设备的快照</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh snapshot-list  vm2   </span><br> Name                 Creation Time             State<br>------------------------------------------------------------<br><br><span class="hljs-comment"># 创建一块磁盘</span><br>创建--格式为raw，名字为vm2-1.raw，大小为2G的磁盘<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># qemu-img create -f raw /var/lib/libvirt/images/vm2-1.raw 2G</span><br>Formatting &#x27;/var/lib/libvirt/images/vm2-1.raw&#x27;, <span class="hljs-attr">fmt</span>=raw size=<span class="hljs-number">2147483648</span> <br><span class="hljs-comment"># 查看</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ll -h /var/lib/libvirt/images/vm2-1.raw</span><br>-rw-r--r-- 1 root root 2.0G 10月 25 16:25 /var/lib/libvirt/images/vm2-1.raw<br><br><span class="hljs-comment"># 将其添加到vm2虚拟机上面</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># cd /etc/libvirt/qemu/</span><br><span class="hljs-section">[root@kvm-server qemu]</span><span class="hljs-comment"># vim vm2.xml </span><br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/kvm16.webp" alt="kvm2.png"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 定义配置文件</span><br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># virsh define /etc/libvirt/qemu/vm2.xml</span><br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># virsh start vm2</span><br><br><span class="hljs-comment"># 验证raw格式是不能拍快照的</span><br><span class="hljs-section">[root@kvm-server qemu]</span><span class="hljs-comment"># virsh snapshot-create-as vm2 vm2.snap1</span><br>错误：不支持的配置：存储类型 vdb 不支持磁盘 raw 的内部快照<br><br><br><span class="hljs-comment"># 磁盘格式的转换</span><br>由于raw的磁盘格式，不支持快照功能，我们需要将其转换为qcow2的格式<br><span class="hljs-section">[root@kvm-server qemu]</span><span class="hljs-comment"># qemu-img convert -O qcow2 /var/lib/libvirt/images/vm2-1.raw  /var/lib/libvirt/images/vm2-1.qcow2</span><br><br><span class="hljs-section">[root@kvm-server qemu]</span><span class="hljs-comment"># cd /var/lib/libvirt/images/</span><br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># ll -h </span><br>总用量 21G<br>-rw------- 1 root root 5.1G 10月 24 18:59 centos7.0.qcow2<br>-rw-r--r-- 1 root root 193K 10月 25 16:44 vm2-1.qcow2<br>-rw-r--r-- 1 root root 2.0G 10月 25 16:25 vm2-1.raw<br>-rw------- 1 root root 5.1G 10月 25 16:13 vm2.qcow2<br><br><span class="hljs-comment"># 查看</span><br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># qemu-img info /var/lib/libvirt/images/vm2-1.qcow2</span><br>image: /var/lib/libvirt/images/vm2-1.qcow2<br>file format: qcow2<br>virtual size: 2.0G (2147483648 bytes)<br>disk size: 196K<br>cluster_size: 65536<br>Format specific information:<br>    compat: 1.1<br>    lazy refcounts: false<br>    <br><span class="hljs-comment"># 然后去修改vm2虚拟机的磁盘格式和名称</span><br><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># vim /etc/libvirt/qemu/vm2.xml</span><br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/kvm17.webp" alt="kvm2.png"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kvm-server images]</span><span class="hljs-comment"># virsh define /etc/libvirt/qemu/vm2.xml</span><br><br><span class="hljs-comment"># 创建快照</span><br><span class="hljs-section">[root@kvm-server qemu]</span><span class="hljs-comment"># virsh snapshot-create-as vm2 vm2.snap2</span><br>已生成域快照 vm2.snap2<br><span class="hljs-comment"># 此时raw格式转换成qcow2格式，并快照成功</span><br><br>以下操作为回溯快照<br><span class="hljs-comment"># 开机并再次创建快照-- 选择一台虚拟机进行快照，此时处于关闭状态</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh snapshot-create-as vm3 vm3-snap1</span><br>已生成域快照 vm3-snap1<br><br><span class="hljs-comment">#此时开启vm3虚拟机，并进行快照</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh start vm3</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh snapshot-create-as vm3 vm3-snap2</span><br>已生成域快照 vm3-snap2<br><br>查看快照<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh snapshot-list vm3 </span><br> 名称               生成时间              状态<br>------------------------------------------------------------<br> vm3-snap1            2019-10-30 15:27:15 +0800 running<br> vm3-snap2            2019-10-30 15:29:37 +0800 shutoff<br><br><br><span class="hljs-comment"># 恢复到快照vm3-snap1，现在虚拟机处于开启状态</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh snapshot-revert vm3 vm3-snap1</span><br>此时你再看虚拟机状态，是处于关闭状态<br><br>删除虚拟机快照操作：--需要先关闭虚拟机<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh shutdown vm3</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh snapshot-list vm3</span><br> 名称               生成时间              状态<br>------------------------------------------------------------<br> vm3-snap1            2019-10-30 15:27:15 +0800 running<br> vm3-snap2            2019-10-30 15:29:37 +0800 shutoff<br><br><span class="hljs-comment"># 删除快照</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh snapshot-delete --snapshotname vm3-snap2 vm3</span><br>已删除域快照 vm2-snap3<br><br><span class="hljs-comment"># 查看验证</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># virsh snapshot-list vm3</span><br> 名称               生成时间              状态<br>------------------------------------------------------------<br> vm3-snap1            2019-10-30 15:27:15 +0800 running<br></code></pre></td></tr></table></figure><h2 id="自动化脚本管理kvm"><a href="#自动化脚本管理kvm" class="headerlink" title="自动化脚本管理kvm"></a>自动化脚本管理kvm</h2><p><code>运行脚本需要先更改好配置文件内容</code></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment">#kvm batch create vm tool</span><br><span class="hljs-comment">#version:0.1</span><br><span class="hljs-comment">#time:2024-1-7</span><br><span class="hljs-comment">#author:清风</span><br><span class="hljs-comment">#需要事先准备模板镜像和配置文件模板</span><br><br>batch_self_define() &#123;<br><br>        <span class="hljs-attr">kvmname</span>=`openssl rand -hex <span class="hljs-number">5</span>`<br><br>        <span class="hljs-attr">sourceimage</span>=/var/lib/libvirt/images/vmmodel.img<br>        <span class="hljs-attr">sourcexml</span>=/etc/libvirt/qemu/vmmodel.xml<br><br>        <span class="hljs-attr">newimg</span>=/var/lib/libvirt/images/<span class="hljs-variable">$&#123;kvmname&#125;</span>.img<br>        <span class="hljs-attr">newxml</span>=/etc/libvirt/qemu/<span class="hljs-variable">$&#123;kvmname&#125;</span>.xml<br><br>        cp $sourceimage  $newimg<br>        cp $sourcexml $newxml<br><br>        <span class="hljs-attr">kvmuuid</span>=`uuidgen`<br>        <span class="hljs-attr">kvmmem</span>=<span class="hljs-variable">$&#123;1&#125;</span><span class="hljs-number">000000</span><br>        <span class="hljs-attr">kvmcpu</span>=<span class="hljs-variable">$2</span><br>        <br>        <br>        <span class="hljs-attr">kvmimg</span>=<span class="hljs-variable">$newimg</span><br>        <span class="hljs-attr">kvmmac</span>=`openssl rand -hex <span class="hljs-number">3</span> | sed -r <span class="hljs-string">&#x27;s/..\B/&amp;:/g&#x27;</span>`<br><br>        sed -i &quot;s@kvmname@$kvmname@<span class="hljs-comment">;s@kvmuuid@$kvmuuid@;s@kvmmem@$kvmmem@;s@kvmcpu@$kvmcpu@;s@kvmimg@$kvmimg@;s@kvmmac@$kvmmac@&quot; $newxml</span><br>        virsh define $newxml<br>        virsh list --all<br>&#125;<br><br>self_define() &#123;<br>        read -p &quot;请输入新虚机名称:&quot; newname<br>        read -p &quot;请输入新虚机内存大小(G):&quot; newmem<br>        read -p &quot;请输入新虚机cpu个数:&quot; newcpu<br><br>        <span class="hljs-attr">sourceimage</span>=/var/lib/libvirt/images/vmmodel.img<br>        <span class="hljs-attr">sourcexml</span>=/etc/libvirt/qemu/vmmodel.xml<br><br>        <span class="hljs-attr">newimg</span>=/var/lib/libvirt/images/<span class="hljs-variable">$&#123;newname&#125;</span>.img<br>        <span class="hljs-attr">newxml</span>=/etc/libvirt/qemu/<span class="hljs-variable">$&#123;newname&#125;</span>.xml<br><br>        cp $sourceimage  $newimg<br>        cp $sourcexml $newxml<br><br>        <span class="hljs-attr">kvmname</span>=<span class="hljs-variable">$newname</span><br>        <span class="hljs-attr">kvmuuid</span>=`uuidgen`<br>        <span class="hljs-attr">kvmmem</span>=<span class="hljs-variable">$&#123;newmem&#125;</span><span class="hljs-number">000000</span><br>        <span class="hljs-attr">kvmcpu</span>=<span class="hljs-variable">$newcpu</span><br>        <span class="hljs-attr">kvmimg</span>=<span class="hljs-variable">$newimg</span><br>        <span class="hljs-attr">kvmmac</span>=`openssl rand -hex <span class="hljs-number">3</span> | sed -r <span class="hljs-string">&#x27;s/..\B/&amp;:/g&#x27;</span>`<br><br>        sed -i &quot;s@kvmname@$kvmname@<span class="hljs-comment">;s@kvmuuid@$kvmuuid@;s@kvmmem@$kvmmem@;s@kvmcpu@$kvmcpu@;s@kvmimg@$kvmimg@;s@kvmmac@$kvmmac@&quot; $newxml</span><br>        virsh define $newxml<br>        virsh list --all<br>&#125;<br><br>delete_kvm()&#123;<br>        virsh list<br>        while true<span class="hljs-comment">;do</span><br>        read -p &quot;是否需要关闭lvm或退出（Y/N/T）&quot; ynt<br>        if <span class="hljs-section">[ $ynt = y ]</span><span class="hljs-comment">;then</span><br>                read -p &quot;请输入你要关闭的kvm：&quot; numb<br>                virsh shutdown $numb<br>        elif <span class="hljs-section">[ $ynt = n ]</span><span class="hljs-comment">;then</span><br>                virsh list --all<br>                read -p &quot;请输入你要删除的kvm：&quot; num<br>                virsh undefine $num<br>                <span class="hljs-comment">#rm -rf /etc/libvirt/qemu/$num.xml</span><br>                rm -rf /var/lib/libvirt/images/$num*<br>                echo &quot;$num 虚拟机已被删除！&quot;<br>        else<br>                echo &quot;再见！&quot;<br>                break<br>        fi<br>        done<br>&#125;  <br><br>exit_menu()&#123;<br>    green &quot;再见！！！&quot;<br>    break<br>&#125;     <br><br>red()&#123;<br>    echo -e &quot;\033<span class="hljs-section">[31m\033[01m$1\033[0m&quot;</span><br><span class="hljs-section">&#125;</span><br><span class="hljs-section">green()&#123;</span><br><span class="hljs-section">    echo -e &quot;\033[32m\033[01m$1\033[0m&quot;</span><br><span class="hljs-section">&#125;</span><br><span class="hljs-section">yellow()&#123;</span><br><span class="hljs-section">    echo -e &quot;\033[33m\033[01m$1\033[0m&quot;</span><br><span class="hljs-section">&#125;</span><br><span class="hljs-section">blue()&#123;</span><br><span class="hljs-section">    echo -e &quot;\033[34m\033[01m$1\033[0m&quot;</span><br><span class="hljs-section">&#125;</span><br><span class="hljs-section"></span><br><span class="hljs-section"># 主菜单选择</span><br><span class="hljs-section">main_menu() &#123;</span><br><span class="hljs-section">    while true; do</span><br><span class="hljs-section">red      &quot;===============================================&quot;</span><br><span class="hljs-section">green   &quot;||  ____    _____  _______  _________  _______||&quot;</span><br><span class="hljs-section">yellow  &quot;|| / __ \  /  _/ |/ / ___/ / __/ __/ |/ / ___/||&quot;</span><br><span class="hljs-section">blue    &quot;||/ /_/ / _/ //    / (_ / / _// _//    / (_ / ||&quot;</span><br><span class="hljs-section">yellow  &quot;||\___\_\/___/_/|_/\___/ /_/ /___/_/|_/\___/  ||&quot;</span><br><span class="hljs-section">green   &quot;||                                            ||&quot;</span><br><span class="hljs-section">red     &quot;===============================================&quot;</span><br><span class="hljs-section">blue    &quot;||            &gt;&gt;&gt;&gt;&gt; 清风徐来 &lt;&lt;&lt;&lt;&lt;            ||&quot;</span><br><span class="hljs-section">red     &quot;===============================================&quot;</span><br><span class="hljs-section">echo &quot;1.创建自定义配置单个虚拟机&quot;</span><br><span class="hljs-section">echo &quot;2.批量创建自定义配置虚拟机&quot;</span><br><span class="hljs-section">echo &quot;3.批量创建默认配置虚拟机&quot;</span><br><span class="hljs-section">echo &quot;4.删除虚拟机&quot;</span><br><span class="hljs-section">echo &quot;5.退出&quot;</span><br><span class="hljs-section">red &quot;===============================================&quot;</span><br><span class="hljs-section"></span><br><span class="hljs-section">read -p &quot;选取你的操作(1/2/3/4/5):&quot; op</span><br><span class="hljs-section"></span><br><span class="hljs-section">case $op in</span><br><span class="hljs-section">1)self_define;;</span><br><span class="hljs-section">2)</span><br><span class="hljs-section">        read -p &quot;请输入要创建的虚拟机的个数:&quot; num</span><br><span class="hljs-section">        read -p &quot;请输入新虚机内存大小(G):&quot; newmem</span><br><span class="hljs-section">        read -p &quot;请输入新虚机cpu个数:&quot; newcpu</span><br><span class="hljs-section"></span><br><span class="hljs-section">        for((i=1;i&lt;=$num;i++))</span><br><span class="hljs-section">        do</span><br><span class="hljs-section">                batch_self_define $newmem $newcpu</span><br><span class="hljs-section">        done;;</span><br><span class="hljs-section"></span><br><span class="hljs-section">3)</span><br><span class="hljs-section">        read -p &quot;请输入要创建的虚拟机的个数:&quot; num</span><br><span class="hljs-section"></span><br><span class="hljs-section">        for((i=1;i&lt;=$num;i++))</span><br><span class="hljs-section">        do</span><br><span class="hljs-section">                batch_self_define 1 1</span><br><span class="hljs-section">        done;;</span><br><span class="hljs-section">4)</span><br><span class="hljs-section">        delete_kvm</span><br><span class="hljs-section">        ;;</span><br><span class="hljs-section">5)      </span><br><span class="hljs-section">        exit_menu</span><br><span class="hljs-section">        ;;</span><br><span class="hljs-section">*)</span><br><span class="hljs-section">        echo &quot;输入错误，请重新执行脚本&quot;</span><br><span class="hljs-section">        exit</span><br><span class="hljs-section">        ;;</span><br><span class="hljs-section">esac</span><br><span class="hljs-section"></span><br><span class="hljs-section">red &quot;===============================================&quot;</span><br><span class="hljs-section">read -p &quot;按任意键返回主菜单&quot; any_key</span><br><span class="hljs-section">clear</span><br><span class="hljs-section">done</span><br><span class="hljs-section"></span><br><span class="hljs-section">&#125;</span><br><span class="hljs-section"></span><br><span class="hljs-section">#运行</span><br><span class="hljs-section">main_menu</span><br></code></pre></td></tr></table></figure><h2 id="配置文件模板"><a href="#配置文件模板" class="headerlink" title="配置文件模板"></a>配置文件模板</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># vim /etc/libvirt/qemu/vmmodel.xml</span><br>&lt;domain <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;kvm&#x27;</span>&gt;<br>  &lt;name&gt;kvmname&lt;/name&gt;<br>  &lt;uuid&gt;kvmuuid&lt;/uuid&gt;<br>  &lt;memory <span class="hljs-attr">unit</span>=<span class="hljs-string">&#x27;KiB&#x27;</span>&gt;kvmmem&lt;/memory&gt;<br>  &lt;currentMemory <span class="hljs-attr">unit</span>=<span class="hljs-string">&#x27;KiB&#x27;</span>&gt;kvmmem&lt;/currentMemory&gt;<br>  &lt;vcpu <span class="hljs-attr">placement</span>=<span class="hljs-string">&#x27;static&#x27;</span>&gt;kvmcpu&lt;/vcpu&gt;<br>  &lt;os&gt;<br>    &lt;type <span class="hljs-attr">arch</span>=<span class="hljs-string">&#x27;x86_64&#x27;</span> machine=<span class="hljs-string">&#x27;pc-i440fx-rhel7.0.0&#x27;</span>&gt;hvm&lt;/type&gt;<br>    &lt;boot <span class="hljs-attr">dev</span>=<span class="hljs-string">&#x27;hd&#x27;</span>/&gt;<br>  &lt;/os&gt;<br>  &lt;features&gt;<br>    &lt;acpi/&gt;<br>    &lt;apic/&gt;<br>  &lt;/features&gt;<br>  &lt;cpu <span class="hljs-attr">mode</span>=<span class="hljs-string">&#x27;custom&#x27;</span> match=<span class="hljs-string">&#x27;exact&#x27;</span> check=<span class="hljs-string">&#x27;partial&#x27;</span>&gt;<br>    &lt;model <span class="hljs-attr">fallback</span>=<span class="hljs-string">&#x27;allow&#x27;</span>&gt;Haswell-noTSX&lt;/model&gt;<br>  &lt;/cpu&gt;<br>  &lt;clock <span class="hljs-attr">offset</span>=<span class="hljs-string">&#x27;utc&#x27;</span>&gt;<br>    &lt;timer <span class="hljs-attr">name</span>=<span class="hljs-string">&#x27;rtc&#x27;</span> tickpolicy=<span class="hljs-string">&#x27;catchup&#x27;</span>/&gt;<br>    &lt;timer <span class="hljs-attr">name</span>=<span class="hljs-string">&#x27;pit&#x27;</span> tickpolicy=<span class="hljs-string">&#x27;delay&#x27;</span>/&gt;<br>    &lt;timer <span class="hljs-attr">name</span>=<span class="hljs-string">&#x27;hpet&#x27;</span> present=<span class="hljs-string">&#x27;no&#x27;</span>/&gt;<br>  &lt;/clock&gt;<br>  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;<br>  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;<br>  &lt;on_crash&gt;destroy&lt;/on_crash&gt;<br>  &lt;pm&gt;<br>    &lt;suspend-to-mem <span class="hljs-attr">enabled</span>=<span class="hljs-string">&#x27;no&#x27;</span>/&gt;<br>    &lt;suspend-to-disk <span class="hljs-attr">enabled</span>=<span class="hljs-string">&#x27;no&#x27;</span>/&gt;<br>  &lt;/pm&gt;<br>  &lt;devices&gt;<br>    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;<br>    &lt;disk <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;file&#x27;</span> device=<span class="hljs-string">&#x27;disk&#x27;</span>&gt;<br>      &lt;driver <span class="hljs-attr">name</span>=<span class="hljs-string">&#x27;qemu&#x27;</span> type=<span class="hljs-string">&#x27;qcow2&#x27;</span>/&gt;<br>      &lt;source <span class="hljs-attr">file</span>=<span class="hljs-string">&#x27;kvmimg&#x27;</span>/&gt;<br>      &lt;target <span class="hljs-attr">dev</span>=<span class="hljs-string">&#x27;vda&#x27;</span> bus=<span class="hljs-string">&#x27;virtio&#x27;</span>/&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x06&#x27;</span> function=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br>    &lt;/disk&gt;<br>    &lt;controller <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;usb&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span> model=<span class="hljs-string">&#x27;ich9-ehci1&#x27;</span>&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x04&#x27;</span> function=<span class="hljs-string">&#x27;0x7&#x27;</span>/&gt;<br>    &lt;/controller&gt;<br>    &lt;controller <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;usb&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span> model=<span class="hljs-string">&#x27;ich9-uhci1&#x27;</span>&gt;<br>      &lt;master <span class="hljs-attr">startport</span>=<span class="hljs-string">&#x27;0&#x27;</span>/&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x04&#x27;</span> function=<span class="hljs-string">&#x27;0x0&#x27;</span> multifunction=<span class="hljs-string">&#x27;on&#x27;</span>/&gt;<br>    &lt;/controller&gt;<br>    &lt;controller <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;usb&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span> model=<span class="hljs-string">&#x27;ich9-uhci2&#x27;</span>&gt;<br>      &lt;master <span class="hljs-attr">startport</span>=<span class="hljs-string">&#x27;2&#x27;</span>/&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x04&#x27;</span> function=<span class="hljs-string">&#x27;0x1&#x27;</span>/&gt;<br>    &lt;/controller&gt;<br>    &lt;controller <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;usb&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span> model=<span class="hljs-string">&#x27;ich9-uhci3&#x27;</span>&gt;<br>      &lt;master <span class="hljs-attr">startport</span>=<span class="hljs-string">&#x27;4&#x27;</span>/&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x04&#x27;</span> function=<span class="hljs-string">&#x27;0x2&#x27;</span>/&gt;<br>    &lt;/controller&gt;<br>    &lt;controller <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span> model=<span class="hljs-string">&#x27;pci-root&#x27;</span>/&gt;<br>    &lt;controller <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;virtio-serial&#x27;</span> index=<span class="hljs-string">&#x27;0&#x27;</span>&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x05&#x27;</span> function=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br>    &lt;/controller&gt;<br>    &lt;interface <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;network&#x27;</span>&gt;<br>      &lt;mac <span class="hljs-attr">address</span>=<span class="hljs-string">&#x27;52:54:00:kvmmac&#x27;</span>/&gt;<br>      &lt;source <span class="hljs-attr">network</span>=<span class="hljs-string">&#x27;default&#x27;</span>/&gt;<br>      &lt;model <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;virtio&#x27;</span>/&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x03&#x27;</span> function=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br>    &lt;/interface&gt;<br>    &lt;serial <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pty&#x27;</span>&gt;<br>      &lt;target <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;isa-serial&#x27;</span> port=<span class="hljs-string">&#x27;0&#x27;</span>&gt;<br>        &lt;model <span class="hljs-attr">name</span>=<span class="hljs-string">&#x27;isa-serial&#x27;</span>/&gt;<br>      &lt;/target&gt;<br>    &lt;/serial&gt;<br>    &lt;console <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pty&#x27;</span>&gt;<br>      &lt;target <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;serial&#x27;</span> port=<span class="hljs-string">&#x27;0&#x27;</span>/&gt;<br>    &lt;/console&gt;<br>    &lt;channel <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;unix&#x27;</span>&gt;<br>      &lt;target <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;virtio&#x27;</span> name=<span class="hljs-string">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;virtio-serial&#x27;</span> controller=<span class="hljs-string">&#x27;0&#x27;</span> bus=<span class="hljs-string">&#x27;0&#x27;</span> port=<span class="hljs-string">&#x27;1&#x27;</span>/&gt;<br>    &lt;/channel&gt;<br>    &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;mouse&#x27;</span> bus=<span class="hljs-string">&#x27;ps2&#x27;</span>/&gt;<br>    &lt;input <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;keyboard&#x27;</span> bus=<span class="hljs-string">&#x27;ps2&#x27;</span>/&gt;<br>    &lt;memballoon <span class="hljs-attr">model</span>=<span class="hljs-string">&#x27;virtio&#x27;</span>&gt;<br>      &lt;address <span class="hljs-attr">type</span>=<span class="hljs-string">&#x27;pci&#x27;</span> domain=<span class="hljs-string">&#x27;0x0000&#x27;</span> bus=<span class="hljs-string">&#x27;0x00&#x27;</span> slot=<span class="hljs-string">&#x27;0x07&#x27;</span> function=<span class="hljs-string">&#x27;0x0&#x27;</span>/&gt;<br>    &lt;/memballoon&gt;<br>  &lt;/devices&gt;<br>&lt;/domain&gt;<br></code></pre></td></tr></table></figure><h2 id="随机生成mac地址"><a href="#随机生成mac地址" class="headerlink" title="随机生成mac地址"></a>随机生成mac地址</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ini">B:字母数字与字母数字分割，非字母数字与非字母数字分割<br>&amp;:表示原来的内容<br><br>其中方式如下：<br><span class="hljs-comment"># echo `openssl rand -hex 1`:`openssl rand -hex 1`:`openssl rand -hex 1`</span><br>99:6e:67<br><br><span class="hljs-comment"># openssl rand -hex 3 | sed -r &#x27;s/(..)(..)(..)/\1:\2:\3/g&#x27;</span><br>94:89:e3<br><br><span class="hljs-comment"># openssl rand -hex 3 | sed -r &#x27;s/..\B/&amp;:/g&#x27;</span><br>c5:66:90<br><br>参数解释：<br>openssl rand -hex 5<br>openssl rand  <span class="hljs-comment">#用来生成随机数的</span><br>-hex <span class="hljs-comment">#表示为16进制的数</span><br>5  <span class="hljs-comment">#表示长度</span><br></code></pre></td></tr></table></figure><h2 id="KVM网络配置"><a href="#KVM网络配置" class="headerlink" title="KVM网络配置"></a>KVM网络配置</h2><h2 id="四种网络"><a href="#四种网络" class="headerlink" title="四种网络"></a>四种网络</h2><p><code>1.NAT default方式：</code>支持主机与虚拟机互访，虚拟机访问外界网络，但不支持外界访问虚拟机。<br><code>2.isolated隔离，vmware--host-only：仅主机模式。</code>外网不能访问虚拟机，虚拟机也不能访问外网<br><code>3.bridge </code> —-桥接模式属于桥接口<br><code>4.路由模式</code></p><p><strong>nat网络</strong></p><p><img src="https://xbd666.cn/upload/kvm18.webp" alt="kvm2.png"></p><p><strong>桥接网络</strong></p><p><img src="https://xbd666.cn/upload/kvm19.webp" alt="kvm2.png"></p><p><strong>隔离网络</strong></p><p><img src="https://xbd666.cn/upload/kvm20.webp" alt="kvm2.png"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#查看管理接口对应的网卡</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># brctl show </span><br>bridge namebridge idSTP enabledinterfaces<br>virbr08000.525400831963yesvirbr0-nic<br>           vnet0<br>           vnet1<br><br>注意：这里vnet网卡，是每台启动的虚拟机正在使用的网卡设备，每台虚拟机使用的不同     <br><span class="hljs-comment"># 从交换机上把vnet网卡删除：</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># brctl delif virbr0 vnet0</span><br><br>来到vm2的虚拟机，ping不通百度<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ping baidu.com</span><br>ping:baidu.com:Name or service not known<br><br><span class="hljs-comment"># 添加vnet网卡添加到交换机上：</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># brctl addif virbr0 vnet0</span><br><br>来到vm2的虚拟机，恢复正常<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ping baidu.com</span><br>PING www.a.shifen.com (61.135.169.125)56(84) bytes of data.<br>64  bytes from 61.135.169.125(61.135.169.125): <span class="hljs-attr">icmp_seq</span>=<span class="hljs-number">1</span> ttl=<span class="hljs-number">55</span> time=<span class="hljs-number">2.24</span> ms<br></code></pre></td></tr></table></figure><h2 id="配置文件方式配置桥接：在宿主机上"><a href="#配置文件方式配置桥接：在宿主机上" class="headerlink" title="配置文件方式配置桥接：在宿主机上"></a>配置文件方式配置<code>桥接</code>：在宿主机上</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs ini">配置文件方式配置桥接：在宿主机上<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># ip a   #先找出宿主机用的哪个网卡设备，我的是enp0s25</span><br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># cd /etc/sysconfig/network-scripts/</span><br>1.定义网卡配置文件<br><span class="hljs-section">[root@kvm-server network-scripts]</span><span class="hljs-comment"># vim ifcfg-br0    #创建该桥接网卡，默认没有此文件需要新建</span><br><span class="hljs-section">[root@kvm-server network-scripts]</span><span class="hljs-comment"># cat ifcfg-br0</span><br><span class="hljs-attr">TYPE</span>=Bridge  <span class="hljs-comment">#定义类型</span><br><span class="hljs-attr">NAME</span>=br0  <span class="hljs-comment">#设备的名字</span><br><span class="hljs-attr">DEVICE</span>=br0<br><span class="hljs-attr">ONBOOT</span>=<span class="hljs-string">&quot;yes&quot;</span><br><span class="hljs-attr">BOOTPROTO</span>=static<br><span class="hljs-attr">IPADDR</span>=<span class="hljs-number">10.31</span>.<span class="hljs-number">162.90</span>   <span class="hljs-comment">#要和宿主机在一个网络，这里我用的是宿主机的ip</span><br><span class="hljs-attr">GATEWAY</span>=<span class="hljs-number">10.31</span>.<span class="hljs-number">162.1</span>   <span class="hljs-comment">#宿主的网关，nat的是.2,桥接是.1</span><br><span class="hljs-attr">NETMASK</span>=<span class="hljs-number">255.255</span>.<span class="hljs-number">255.0</span><br><span class="hljs-attr">DNS1</span>=<span class="hljs-number">114.144</span>.<span class="hljs-number">144.144</span><br><span class="hljs-attr">DNS2</span>=<span class="hljs-number">8.8</span>.<span class="hljs-number">8.8</span><br><br>然后看清楚宿主机正在使用的网卡，修改配置文件,(将物理机网卡桥到桥接网卡)<br><span class="hljs-section">[root@kvm-server network-scripts]</span><span class="hljs-comment"># cp ifcfg-enp0s25 ifcfg-enp0s25.back</span><br><span class="hljs-section">[root@kvm-server network-scripts]</span><span class="hljs-comment"># vim ifcfg-enp0s25</span><br><span class="hljs-attr">NAME</span>=enp0s25   <span class="hljs-comment">#定义网卡设备名称</span><br><span class="hljs-attr">DEVICE</span>=enp0s25   <span class="hljs-comment">#宿主机正在使用的网卡设备</span><br><span class="hljs-attr">ONBOOT</span>=<span class="hljs-literal">yes</span><br><span class="hljs-attr">BRIDGE</span>=br0     <span class="hljs-comment">#和ifcfg-br0文件里面的设备对应，新添加</span><br>  <br>2.重启libvirtd服务<br><span class="hljs-section">[root@kvm-server network-scripts]</span><span class="hljs-comment"># systemctl restart libvirtd </span><br>3.重启network服务 <br><span class="hljs-section">[root@kvm-server network-scripts]</span><span class="hljs-comment"># systemctl restart network     </span><br></code></pre></td></tr></table></figure><p><strong>然后去查看有没有新设备生成</strong></p><p><img src="https://xbd666.cn/upload/kvm21.webp" alt="kvm2.png"></p><p><strong>可以看到，我们先添加的网卡设备</strong></p><p><img src="https://xbd666.cn/upload/kvm22.webp" alt="kvm2.png"><br><code>添加完成后，运行虚拟机查看IP地址，就可以看到添加的桥接网卡了</code></p><h2 id="移除桥接网卡操作"><a href="#移除桥接网卡操作" class="headerlink" title="移除桥接网卡操作"></a>移除<code>桥接网卡</code>操作</h2><p><img src="https://xbd666.cn/upload/kvm23.webp" alt="kvm2.png"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs ini">删除桥接网卡步骤：<br>1.删除br0的配置文件<br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># cd /etc/sysconfig/network-scripts/</span><br><span class="hljs-section">[root@localhost network-scripts]</span><span class="hljs-comment"># rm -rf ifcfg-br0 </span><br><span class="hljs-section">[root@localhost network-scripts]</span><span class="hljs-comment"># rm -rf ifcfg-ens33</span><br><br>2.修改正常网卡的配置文件<br><span class="hljs-comment"># 将之前备份的恢复</span><br><span class="hljs-section">[root@localhost network-scripts]</span><span class="hljs-comment"># cp ifcfg-ens33.bak ifcfg-ens33</span><br>3.重启系统<br><span class="hljs-section">[root@localhost network-scripts]</span><span class="hljs-comment"># systemctl restart network</span><br><span class="hljs-section">[root@localhost network-scripts]</span><span class="hljs-comment"># systemctl restart libvirtd</span><br></code></pre></td></tr></table></figure><h2 id="通过配置文件方式创建nat网络："><a href="#通过配置文件方式创建nat网络：" class="headerlink" title="通过配置文件方式创建nat网络："></a>通过配置文件方式创建nat网络：</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini">配置文件方式创建nat网络：<br>1.首先需要一个模板文件，通过这个模板文件创建自定义的nat网络。<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># cd /etc/libvirt/qemu/networks</span><br><span class="hljs-section">[root@kvm-server networks]</span><span class="hljs-comment"># ls</span><br>autostar default.xml<br><span class="hljs-section">[root@kvm-server networks]</span><span class="hljs-comment"># cp default.xml nat1.xml</span><br><span class="hljs-section">[root@kvm-server networks]</span> <span class="hljs-comment"># vim nat1.xml  </span><br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/kvm24.webp" alt="kvm2.png"></p><p><strong>重启服务</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kvm-server netwoeks]</span><span class="hljs-comment"># systemctl  restart libvirtd</span><br><br><span class="hljs-comment">#然后选择一个虚拟机进行添加</span><br>在某个（比如vm3）虚拟机去添加此设备测试<br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/kvm25.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm26.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm27.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm28.webp" alt="kvm2.png"></p><h2 id="创建isolated网络，隔离网络"><a href="#创建isolated网络，隔离网络" class="headerlink" title="创建isolated网络，隔离网络"></a>创建isolated网络，隔离网络</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini">配置文件方式创建isolated网络隔离网络：<br><span class="hljs-section">[root@kvm-server ~]</span><span class="hljs-comment"># cd /etc/libvirt/qemu/networks</span><br><span class="hljs-section">[root@kvm-server networks]</span><span class="hljs-comment"># cp default.xml isolated200.xml</span><br><span class="hljs-section">[root@kvm-server networks]</span><span class="hljs-comment"># vim isolated200.xml</span><br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/kvm29.webp" alt="kvm2.png"></p><p><strong>启动：</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kvm-server networks]</span><span class="hljs-comment"># systemctl restart libvirtd</span><br>开机自启动:<br><span class="hljs-section">[root@kvm-server networks]</span><span class="hljs-comment"># virsh net-autostart  isolated200</span><br><br>查看所有的网络：<br><span class="hljs-section">[root@kvm-server networks]</span><span class="hljs-comment"># virsh net-list</span><br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/kvm30.webp" alt="kvm2.png"></p><h2 id="图文方式创建nat网络"><a href="#图文方式创建nat网络" class="headerlink" title="图文方式创建nat网络"></a>图文方式创建nat网络</h2><p><img src="https://xbd666.cn/upload/kvm31.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm32.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm33.webp" alt="kvm2.png"></p><p><img src="https://xbd666.cn/upload/kvm34.webp" alt="kvm2.png"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>常用的linux命令</title>
    <link href="/2025/11/06/%E5%B8%B8%E7%94%A8%E7%9A%84linux%E5%91%BD%E4%BB%A4/"/>
    <url>/2025/11/06/%E5%B8%B8%E7%94%A8%E7%9A%84linux%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="清理linux系统中的缓存-生产环境慎用"><a href="#清理linux系统中的缓存-生产环境慎用" class="headerlink" title="清理linux系统中的缓存(生产环境慎用!)"></a>清理linux系统中的缓存(生产环境慎用!)</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">echo <span class="hljs-number">3</span> &gt; <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/vm/</span>drop_caches<br></code></pre></td></tr></table></figure><p><code>drop_caches 文件允许三个不同的值： 1: 只清空页面缓存。 2: 只清空目录项和inode。 3: 清空页面缓存、目录项和inode。</code></p><h2 id="比较文件内容差异"><a href="#比较文件内容差异" class="headerlink" title="比较文件内容差异"></a>比较文件内容差异</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">diff <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.txt</span> <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.txt</span>     #正常比较<br>diff -c <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.txt</span> <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.txt</span>    #以上下文方式比较<br>diff -u <span class="hljs-selector-tag">a</span><span class="hljs-selector-class">.txt</span> <span class="hljs-selector-tag">b</span><span class="hljs-selector-class">.txt</span>    #联合方式比较<br></code></pre></td></tr></table></figure><h2 id="查看操作系统版本信息"><a href="#查看操作系统版本信息" class="headerlink" title="查看操作系统版本信息"></a>查看操作系统版本信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/redhat-release<br></code></pre></td></tr></table></figure><h2 id="统计出现相同行的次数"><a href="#统计出现相同行的次数" class="headerlink" title="统计出现相同行的次数"></a>统计出现相同行的次数</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">uniq</span> -c<br></code></pre></td></tr></table></figure><h2 id="标准错误重定向到标准输出的位置"><a href="#标准错误重定向到标准输出的位置" class="headerlink" title="标准错误重定向到标准输出的位置"></a>标准错误重定向到标准输出的位置</h2><p><code>2 是标准错误的文件描述符，1 是标准输出的文件描述符。而 &gt;&amp; 表示将一个文件描述符重定向到另一个文件描述符，1 表示标准输出。因此，2&gt;&amp;1 就表示将标准错误重定向到标准输出的位置</code></p><h2 id="要在Linux系统中添加一个HTTP代理，可以按照以下步骤进行操作："><a href="#要在Linux系统中添加一个HTTP代理，可以按照以下步骤进行操作：" class="headerlink" title="要在Linux系统中添加一个HTTP代理，可以按照以下步骤进行操作："></a>要在Linux系统中添加一个HTTP代理，可以按照以下步骤进行操作：</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#代理</span><br>先在Clash上开启Allow LAN,并设置代理端口<span class="hljs-number">8888</span><br><span class="hljs-comment"># 在终端上输入，代表代理</span><br>export http_proxy=http:<span class="hljs-regexp">//</span><span class="hljs-number">10.31</span>.<span class="hljs-number">162.98</span>:<span class="hljs-number">8888</span><br><span class="hljs-comment"># -x将IP地址+端口添加在前面就可以在github链接上下载了</span><br>curl -x http:<span class="hljs-regexp">//</span><span class="hljs-number">10.31</span>.<span class="hljs-number">162.98</span>:<span class="hljs-number">8888</span> -L https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/docker/</span>compose<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/1.22.0/</span>docker-compose-`uname -s`-`uname -m` -o <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>docker-compose<br><span class="hljs-comment">#取消代理</span><br>unset http_proxy <br><span class="hljs-comment">#重启</span><br>取消代理后如果不能ping就重启下，reboot<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>docker--harbor私有仓库部署</title>
    <link href="/2025/11/06/docker-harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/docker-harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="部署harbor–方式一"><a href="#部署harbor–方式一" class="headerlink" title="部署harbor–方式一"></a>部署harbor–方式一</h2><p><code>部署环境  关闭防火墙</code></p><h2 id="下载harbor包"><a href="#下载harbor包" class="headerlink" title="下载harbor包"></a>下载harbor包</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/docker/harbor-online-installer-v2.10.0.tgz<br></code></pre></td></tr></table></figure><h2 id="下载docker-compose"><a href="#下载docker-compose" class="headerlink" title="下载docker-compose"></a>下载docker-compose</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">curl -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose<br></code></pre></td></tr></table></figure><h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@iZ8vb3lp570ckxi53yb66gZ ~]</span><span class="hljs-comment"># chmod +x /usr/local/bin/docker-compose</span><br></code></pre></td></tr></table></figure><h2 id="解压"><a href="#解压" class="headerlink" title="解压"></a>解压</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kub-k8s-master ~]</span><span class="hljs-comment"># tar xf harbor-offline-installer-v1.8.0.tgz</span><br><span class="hljs-section">[root@kub-k8s-master ~]</span><span class="hljs-comment"># cd harbor</span><br></code></pre></td></tr></table></figure><h2 id="http访问方式的配置："><a href="#http访问方式的配置：" class="headerlink" title="http访问方式的配置："></a>http访问方式的配置：</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kub-k8s-master harbor]</span><span class="hljs-comment"># cp harbor.yml.tmpl  harbor.yml</span><br><span class="hljs-section">[root@kub-k8s-master harbor]</span><span class="hljs-comment"># vim harbor.yml #使用IP地址,需要修改的内容如下</span><br>hostname: 192.168.246.166  <span class="hljs-comment">#改成自己的ip</span><br>注释443的模块<br><br><span class="hljs-section">[root@kub-k8s-master harbor]</span><span class="hljs-comment"># ./prepare  #需要等待下载镜像</span><br>或   ./install.sh<br></code></pre></td></tr></table></figure><h2 id="docker-compose-使用"><a href="#docker-compose-使用" class="headerlink" title="docker-compose 使用"></a>docker-compose 使用</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@kub-k8s-master harbor]</span><span class="hljs-comment"># docker-compose up -d  #放后台</span><br><br><span class="hljs-section">[root@kub-k8s-master harbor]</span><span class="hljs-comment"># docker-compose down #停止服务</span><br></code></pre></td></tr></table></figure><h2 id="浏览器访问测试："><a href="#浏览器访问测试：" class="headerlink" title="浏览器访问测试："></a>浏览器访问测试：</h2><p><code>http://10.31.162.25</code><br><code>账号admin  密码Harbor12345</code></p><h2 id="设置域名"><a href="#设置域名" class="headerlink" title="设置域名"></a>设置域名</h2><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">配置域名，并通过反向代理docker客户端</span><br><span class="hljs-comment">1、网站</span><span class="hljs-literal">--</span><span class="hljs-comment">创建网站</span><span class="hljs-literal">--</span><span class="hljs-comment">定义域名</span><br><span class="hljs-comment">2、网站</span><span class="hljs-literal">--</span><span class="hljs-comment">证书</span><span class="hljs-literal">--</span><span class="hljs-comment">申请证书</span><br><span class="hljs-comment">3、网站</span><span class="hljs-literal">--</span><span class="hljs-comment">创建好的网站</span><span class="hljs-literal">--</span><span class="hljs-comment">HTTPS</span><span class="hljs-literal">--</span><span class="hljs-comment">启用 HTTPS</span><br></code></pre></td></tr></table></figure><h2 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment"># 在终端上登入</span><br>docker login IP地址<br><br>推送<br><span class="hljs-comment">#在项目中标记镜像：</span><br>现在终端上给要上传的镜像打标记tag<br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment">#docker tag mysql：5.7 har.xbd666.cn/qingfeng/mysql：5.7</span><br><span class="hljs-comment">#推送到仓库</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment">#docker push 120.27.128.132:81/qingfeng/REPOSITORY[:TAG]</span><br><br><span class="hljs-comment"># 备注</span><br>如果出现413<br>error parsing HTTP 413 response body: invalid character &#x27;&lt;&#x27; looking for beginning of value<br>回到1panel上做设置<br>1panel网址--网站--设置--性能调优--client_max_body_size（这里改成0）<br>或者 在nginx配置文件里更改最大上传文件大小值<br></code></pre></td></tr></table></figure><h2 id="下载镜像"><a href="#下载镜像" class="headerlink" title="下载镜像"></a>下载镜像</h2><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@localhost</span> ~]<span class="hljs-meta"># docker push har.xbd666.cn/qingfeng/mysql：5.7</span><br></code></pre></td></tr></table></figure><p><img src="https://xbd666.cn/upload/harbor1.webp" alt="harbor1.webp"></p><h2 id="部署harbor–方式二"><a href="#部署harbor–方式二" class="headerlink" title="部署harbor–方式二"></a>部署harbor–方式二</h2><h2 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">systemctl stop firewalld<br>setenforce 0<br>yum -y install vim wget net-tools lrzsz <br></code></pre></td></tr></table></figure><h2 id="下载docker"><a href="#下载docker" class="headerlink" title="下载docker"></a>下载docker</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-comment">#删除已安装的Docker</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># yum remove docker \</span><br>docker-client \<br>docker-client-latest \<br>docker-common \<br>docker-latest \<br>docker-latest-logrotate \<br>docker-logrotate \<br>docker-selinux \<br>docker-engine-selinux \<br>docker-engine<br><br><span class="hljs-comment">#配置阿里云Docker Yum源</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><br><span class="hljs-comment">#查看docker版本</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># yum list docker-ce --showduplicates</span><br>或<br>docker -v  或  dockers version<br><br><span class="hljs-comment">#安装Docker新版本或指定版本号</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># yum install -y docker-ce</span><br>或 <br>yum install docker-ce-18.03.0.ce  -y<br><br><span class="hljs-comment">#启动Docker服务：</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># systemctl start docker &amp;&amp; systemctl enable docker</span><br></code></pre></td></tr></table></figure><h2 id="配置Docker-加速器"><a href="#配置Docker-加速器" class="headerlink" title="配置Docker 加速器"></a>配置Docker 加速器</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># vim /etc/docker/daemon.json</span><br>&#123;<br>&quot;registry-mirrors&quot;: <span class="hljs-section">[&quot;https://br003st4.mirror.aliyuncs.com&quot;]</span><br>&#125;<br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># systemctl daemon-reload</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># systemctl restart docker</span><br></code></pre></td></tr></table></figure><h2 id="部署私有仓库–harbor"><a href="#部署私有仓库–harbor" class="headerlink" title="部署私有仓库–harbor"></a>部署私有仓库–harbor</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs ini">cwget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/docker/harbor-offline-installer-v1.8.0.tgz<br><br><span class="hljs-comment">#下载docker-compose</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># curl -L https://github.7boe.top/https://github.com/docker/compose/releases/download/1.22.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><br><span class="hljs-comment"># 给予执行权限</span><br><span class="hljs-comment">#[root@localhost ~]# mv docker-compose-Linux-x86_64 docker-compose</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># chmod +x /usr/local/bin/docker-compose</span><br><br><span class="hljs-comment"># 解压harbor仓库</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># tar xf harbor-offline-installer-v1.8.0.tgz</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># cd harbor</span><br><br><span class="hljs-comment"># http访问方式的配置：</span><br><span class="hljs-section">[root@localhost harbor]</span><span class="hljs-comment"># vim harbor.yml#使用IP地址,需要修改的内容如下</span><br>hostname: 10.31.162.39  <span class="hljs-comment">#改成自己的ip</span><br><span class="hljs-comment">#注释443的模块</span><br><br><span class="hljs-section">[root@localhost harbor]</span><span class="hljs-comment"># ./install.sh  #需要等待下载镜像</span><br>或  ./prepare <br><br><span class="hljs-comment"># docker-compose 使用</span><br><span class="hljs-comment">#[root@localhost harbor]#docker-compose up -d  #放后台</span><br><span class="hljs-comment">#[root@localhost harbor]#docker-compose down #停止服务</span><br></code></pre></td></tr></table></figure><h2 id="浏览器访问测试：-1"><a href="#浏览器访问测试：-1" class="headerlink" title="浏览器访问测试："></a>浏览器访问测试：</h2><p><code>http://10.31.162.39</code></p><p>然后在web界面新建项目，自定义名字</p><h2 id="客户端配置连接仓库地址"><a href="#客户端配置连接仓库地址" class="headerlink" title="客户端配置连接仓库地址"></a>客户端配置连接仓库地址</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># vim /etc/docker/daemon.json</span><br>&#123;<br>&quot;insecure-registries&quot;: <span class="hljs-section">[&quot;39.98.169.219&quot;]</span>  <span class="hljs-comment">#仓库的ip地址 </span><br>&#125;<span class="hljs-comment">#在镜像加速器下面添加时，要做镜像加速器代码后面添加逗号（,）作为分割</span><br><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># systemctl restart docker</span><br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># docker-compose up -d #启动harbor仓库</span><br></code></pre></td></tr></table></figure><h2 id="终端登入仓库"><a href="#终端登入仓库" class="headerlink" title="终端登入仓库"></a>终端登入仓库</h2><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># docker login 10.31.162.39</span><br>Username: admin<br>Password: Hardor12345<br>Login Succeeded  <span class="hljs-comment">#代表登入成功</span><br><br><span class="hljs-comment"># 将生成的jspgou镜像上传到仓库中</span><br>先打标签<br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># docker tag nginx:latest 10.31.162.39/qingfeng/nginx:1.1</span><br>上传镜像<br><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># docker push 10.31.162.39/qingfeng/nginx:1.1</span><br></code></pre></td></tr></table></figure><p><img src="/upload/harbor2.webp" alt="harbor2.webp"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>docker-偌依 项目部署</title>
    <link href="/2025/11/06/docker-%E5%81%8C%E4%BE%9D-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/docker-%E5%81%8C%E4%BE%9D-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h1 id="配置环境"><a href="#配置环境" class="headerlink" title="配置环境"></a>配置环境</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs ini">配置jenkins与前端服务器与git连接<br><br>10.31.162.25nginx-server<br>10.31.162.32java-server<br>10.31.162.35jenkinx-server<br>10.31.162.39mysql-redis-server<br>10.31.162.124haobor-server<br>10.31.162.125git-server<br></code></pre></td></tr></table></figure><h1 id="安装前端服务器"><a href="#安装前端服务器" class="headerlink" title="安装前端服务器"></a>安装前端服务器</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs ini">10.31.162.25nginx-server<br>安装docker<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># yum install -y yum-utils device-mapper-persistent-data lvm2 git</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># yum install -y docker-ce</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># systemctl start docker &amp;&amp; systemctl enable docker</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># mkdir /application/nginx/&#123;logs,html&#125; -p #创建工作目录</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># docker pull daocloud.io/library/nginx</span><br><br>先运行一次容器（为了拷贝配置文件）：<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># docker run -itd --name nginx-1 -p 80:80 daocloud.io/library/nginx</span><br>将容器内nginx的配置文件拷贝到宿主机上面<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># docker  cp web-nginx:/etc/nginx /application/nginx/</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cd /application/nginx/</span><br><span class="hljs-section">[root@nginx-server nginx]</span><span class="hljs-comment"># ll</span><br>total 0<br>drwxr-xr-x 2 root root   6 May 14 00:37 html<br>drwxr-xr-x 2 root root   6 May 14 00:37 logs<br>drwxr-xr-x 3 root root 177 Feb  9  2021 nginx<br><span class="hljs-comment"># 改名</span><br><span class="hljs-section">[root@nginx-server nginx]</span><span class="hljs-comment"># mv nginx/ conf </span><br><span class="hljs-section">[root@nginx-server nginx]</span><span class="hljs-comment"># ll</span><br>total 0<br>drwxr-xr-x 3 root root 177 Feb  9  2021 conf<br>drwxr-xr-x 2 root root   6 May 14 00:37 html<br>drwxr-xr-x 2 root root   6 May 14 00:37 logs<br><span class="hljs-section">[root@nginx-server nginx]</span><span class="hljs-comment"># cd conf/conf.d/</span><br><span class="hljs-section">[root@nginx-server conf.d]</span><span class="hljs-comment"># cp default.conf default.conf.bak</span><br><span class="hljs-section">[root@nginx-server conf.d]</span><span class="hljs-comment"># mv default.conf app.conf</span><br><span class="hljs-comment"># 配置负载均衡</span><br><span class="hljs-section">[root@nginx-server conf.d]</span><span class="hljs-comment"># cat upstream.conf </span><br>upstream java-web &#123;<br>server 10.31.162.32:8080<span class="hljs-comment">;</span><br>&#125;<br><span class="hljs-section">[root@nginx-server conf.d]</span><span class="hljs-comment"># cat app.conf </span><br>server &#123;<br>    listen       80<span class="hljs-comment">;</span><br>    listen  <span class="hljs-section">[::]</span>:80<span class="hljs-comment">;</span><br>    server_name  localhost<span class="hljs-comment">;</span><br><br>    <span class="hljs-comment">#charset koi8-r;</span><br>    <span class="hljs-comment">#access_log  /var/log/nginx/host.access.log  main;</span><br><br>    location / &#123;<br>        root   /usr/share/nginx/html<span class="hljs-comment">;</span><br>try_files $uri $uri/ /index.html<span class="hljs-comment">;</span><br>        index  index.html index.htm<span class="hljs-comment">;</span><br>    &#125;<br><br>    location /prod-api/&#123;<br>      proxy_pass http://java-web/<span class="hljs-comment">;</span><br>      proxy_set_header Host $http_host<span class="hljs-comment">;</span><br>      proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span><br>      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span><br>   &#125;<br>&#125;<br><br>停止并删除容器<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># docker stop web-nginx </span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment">#docker rm web-nginx</span><br><br>创建启动脚本<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># mkdir /opt/script</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># cat /opt/script/updata-nginx.sh </span><br>nginx.sh <br><span class="hljs-comment">#!/usr/bin/bash</span><br><span class="hljs-attr">up_path</span>=/root/upload/<br><span class="hljs-attr">code</span>=*.tar.gz<br><span class="hljs-attr">src</span>=/application/nginx/html<br><span class="hljs-attr">docker_name</span>=web-nginx<br><br>docker login -uadmin -p&#x27;Harbor12345&#x27; 10.31.162.124<br>cd $up_path<br>tar xzf $code -C $src<br>cd $src &amp;&amp; chmod 777 * -R<br>if <span class="hljs-section">[ $? -eq 0 ]</span><span class="hljs-comment">;then</span><br>docker run -itd <span class="hljs-attr">--restart</span>=always --name web-nginx -p <span class="hljs-number">80</span>:<span class="hljs-number">80</span> -v /application/nginx/html/:/usr/share/nginx/html -v /application/nginx/logs/:/var/log/nginx/ -v /application/nginx/conf:/etc/nginx <span class="hljs-number">10.31</span>.<span class="hljs-number">162.124</span>/nginx/mynginx:v1.<span class="hljs-number">0</span><br>sleep 1<br>if <span class="hljs-section">[ $? -eq 0 ]</span><span class="hljs-comment">;then</span><br>echo &quot;nginx is started&quot;<br>else<br>echo &quot;启动失败,请手动处理&quot;<br>fi<br>else<br>echo &quot;解压失败&quot;<br>fi<br>chmod 777 $src/ -R<br><br><span class="hljs-comment"># 赋予权限</span><br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># chmod +x /opt/script/updata-nginx.sh</span><br>配置连接harbor仓库地址<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># vim /etc/docker/daemon.json</span><br>&#123;<br>&quot;insecure-registries&quot;: <span class="hljs-section">[&quot;192.168.209.166&quot;]</span><br>&#125;<br><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># systemctl restart docker</span><br></code></pre></td></tr></table></figure><h1 id="安装mysql与redis"><a href="#安装mysql与redis" class="headerlink" title="安装mysql与redis"></a>安装mysql与redis</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs ini">10.31.162.39mysql-redis-server<br>1.安装redis<br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># wget https://download.redis.io/releases/redis-7.0.9.tar.gz</span><br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># tar xzvf redis-7.0.9.tar.gz -C /usr/local/</span><br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># mv /usr/local/redis-7.0.9/ /usr/local/redis</span><br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># cd /usr/local/redis/</span><br><span class="hljs-section">[root@mysql-redis redis]</span><span class="hljs-comment"># yum install -y gcc make</span><br><span class="hljs-section">[root@mysql-redis redis]</span><span class="hljs-comment"># make</span><br><span class="hljs-section">[root@mysql-redis redis]</span><span class="hljs-comment"># vim redis.conf</span><br>bind 10.31.162.39　　<span class="hljs-comment">#只监听内网IP</span><br>daemonize yes　　　　　<span class="hljs-comment">#开启后台模式将on改为yes</span><br>port 6379                      <span class="hljs-comment">#端口号</span><br>protected-mode no    <span class="hljs-comment">#将加密保护模式关闭</span><br><br>启动redis<br><span class="hljs-section">[root@mysql-redis redis]</span><span class="hljs-comment"># src/redis-server redis.conf &amp;</span><br><span class="hljs-section">[root@mysql-redis redis]</span><span class="hljs-comment"># netstat -lntp | grep 6379</span><br>tcp        0      0 192.168.209.159:6379    0.0.0.0:*               LISTEN      5770/src/redis-serv<br><br>2.安装mysql<br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># wget https://dev.mysql.com/get/mysql80-community-release-el7-7.noarch.rpm</span><br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># rpm -ivh mysql80-community-release-el7-7.noarch.rpm</span><br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># vim /etc/yum.repos.d/mysql-community.repo</span><br>将8.0关闭，将5.7开启<br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># yum install -y mysql-community-server</span><br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># systemctl start mysqld</span><br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># systemctl enable mysqld</span><br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># grep pass /var/log/mysqld.log </span><br>2023-05-09T12:37:58.805419Z 1 <span class="hljs-section">[Note]</span> A temporary password is generated for root@localhost: :h,=.RRr28kt<br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># mysqladmin -uroot -p&#x27;:h,=.RRr28kt&#x27; password &#x27;QianFeng@123!&#x27;</span><br><span class="hljs-section">[root@mysql-redis ~]</span><span class="hljs-comment"># mysql -uroot -p&#x27;QianFeng@123!&#x27;</span><br>mysql: <span class="hljs-section">[Warning]</span> Using a password on the command line interface can be insecure.<br>Welcome to the MySQL monitor.  Commands end with <span class="hljs-comment">; or \g.</span><br>Your MySQL connection id is 3<br>Server version: 5.7.31 MySQL Community Server (GPL)<br>...<br>创建数据库ry<br>mysql&gt; create database ry character set utf8 collate  utf8_general_ci<span class="hljs-comment">;</span><br>Query OK, 1 row affected (0.00 sec)<br><br>设置root允许远程登录<br>mysql&gt; update mysql.user set <span class="hljs-attr">host</span> = <span class="hljs-string">&#x27;%&#x27;</span> where user = <span class="hljs-string">&#x27;root&#x27;</span><span class="hljs-comment">;</span><br>Query OK, 1 row affected (0.10 sec)<br>Rows matched: 1  Changed: 1  Warnings: 0<br><br>mysql&gt; flush privileges<span class="hljs-comment">;</span><br><br>mysql&gt; \q<br>Bye<br></code></pre></td></tr></table></figure><h1 id="git-server获取代码"><a href="#git-server获取代码" class="headerlink" title="git-server获取代码"></a>git-server获取代码</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs ini">10.31.162.125git-server<br><span class="hljs-comment"># 配置git</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># git config --global user.email &quot;soho@163.com&quot;</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># git config --global user.name &quot;soho&quot;</span><br><span class="hljs-comment">#[root@git-server ~]# git clone https://gitee.com/y_project/RuoYi-Vue.git</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/RuoYi-Vue-master.zip</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># mv RuoYi-Vue-master/RuoYi-Vue</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># cd RuoYi-Vue/</span><br><span class="hljs-section">[root@git-server RuoYi-Vue]</span><span class="hljs-comment"># ls</span><br>bin      pom.xml      ruoyi-common     ruoyi-quartz  ry.bat<br>doc      README.md    ruoyi-framework  ruoyi-system  ry.sh<br>LICENSE  ruoyi-admin  ruoyi-generator  ruoyi-ui      sql<br><br><span class="hljs-comment"># 进行后端数据库与redis的配置</span><br>1.先配置连接redis服务<br><span class="hljs-section">[root@git-server RuoYi-Vue]</span><span class="hljs-comment"># cd ruoyi-admin/src/main/resources/</span><br><span class="hljs-section">[root@git-server resources]</span><span class="hljs-comment"># vim application.yml</span><br><span class="hljs-comment"># redis 配置</span><br>  redis:<br>    <span class="hljs-comment"># 地址--MySQL的IP地址</span><br>    host: 10.31.162.39<br>    <span class="hljs-comment"># 端口，默认为6379</span><br>    port: 6379<br>    <span class="hljs-comment"># 密码</span><br>    password:<br>    <br>2.修改mysql<br><span class="hljs-section">[root@git-server resources]</span><span class="hljs-comment"># vim application-druid.yml</span><br><span class="hljs-comment"># 数据源配置</span><br>spring:<br>    datasource:<br>        type: com.alibaba.druid.pool.DruidDataSource<br>        driverClassName: com.mysql.cj.jdbc.Driver<br>        druid:<br>            <span class="hljs-comment"># 主库数据源</span><br>            master:<br>                url: jdbc:mysql://10.31.162.39:3306/ry?<span class="hljs-attr">useUnicode</span>=<span class="hljs-literal">true</span>&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=<span class="hljs-literal">true</span>&amp;serverTimezone=GMT%<span class="hljs-number">2</span>B8<br>                username: root<br>                password: QianFeng@123!<br>                <br>同时注意数据库连接这里是否启动加密连接，如果启用了加密连接有可能会造成代码与数据库连接不上。修改为:<br>&amp;<span class="hljs-attr">useSSL</span>=<span class="hljs-literal">false</span>&amp;<br><br>配置完成<br><br><span class="hljs-comment">#导入数据给创建的数据库里面</span><br>安装mysql客户端<br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># yum install -y mysql</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># cd RuoYi-Vue/sql/</span><br><span class="hljs-section">[root@git-server sql]</span><span class="hljs-comment"># ls</span><br>quartz.sql  ry_20230223.sql<br><span class="hljs-section">[root@git-server sql]</span><span class="hljs-comment"># mysql -uroot -p&#x27;Qianfeng@123&#x27; -h 10.31.162.39 -D ry &lt; quartz.sql </span><br><span class="hljs-section">[root@git-server sql]</span><span class="hljs-comment"># mysql -uroot -p&#x27;Qianfeng@123&#x27; -h 10.31.162.39 -D  ry &lt; ry_20230223.sql</span><br><br>开始创建版本库<br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># mkdir /git-server</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># useradd git</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># passwd git</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># cd /git-server/</span><br><span class="hljs-section">[root@git-server git-server]</span><span class="hljs-comment"># git init --bare ryvue</span><br>Initialized empty Git repository in /git-server/ryvue/<br><span class="hljs-section">[root@git-server git-server]</span><span class="hljs-comment"># git init --bare ryjava</span><br>Initialized empty Git repository in /git-server/ryjava/<br><span class="hljs-section">[root@git-server git-server]</span><span class="hljs-comment"># chown git.git /git-server/ -R</span><br><br>在本机将两个仓库克隆下来进行代码提交：<br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># ssh-keygen</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># ssh-copy-id git@10.31.162.125  与自己的git用户配置免密</span><br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># git clone git@10.31.162.125:/git-server/ryvue/</span><br>Cloning into &#x27;ryvue&#x27;...<br>warning: You appear to have cloned an empty repository.<br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># git clone git@10.31.162.125:/git-server/ryjava</span><br>Cloning into &#x27;ryjava&#x27;...<br>warning: You appear to have cloned an empty repository.<br><br>将代码提交到相应的代码库中<br>注:在这里没有办法区分前端和后端打包时需要的依赖，顾将所有代码都拷贝到两个版本库中。<br><span class="hljs-section">[root@git-server ~]</span><span class="hljs-comment"># cd ryvue/</span><br><span class="hljs-section">[root@git-server ryvue]</span><span class="hljs-comment"># cp -r /root/RuoYi-Vue/ruoyi-ui/* .</span><br><span class="hljs-section">[root@git-server ryvue]</span><span class="hljs-comment"># cd ../ryjava/</span><br><span class="hljs-section">[root@git-server ryjava]</span><span class="hljs-comment"># cp -r /root/RuoYi-Vue/* .</span><br><span class="hljs-section">[root@git-server ryjava]</span><span class="hljs-comment"># git add -A</span><br><span class="hljs-section">[root@git-server ryjava]</span><span class="hljs-comment"># git commit -m &quot;add 1&quot;</span><br><span class="hljs-section">[root@git-server ryjava]</span><span class="hljs-comment"># git push origin master</span><br><br>在编写后端的Dockerfile<br><span class="hljs-section">[root@git-server ryjava]</span><span class="hljs-comment"># cat Dockerfile </span><br>FROM 10.31.162.124/myjdk/my-jdk:v1.0<br><br>WORKDIR /application/app<br><br>ADD ruoyi-admin/target/*.jar /application/app<br><br>EXPOSE 8080<br><br>ENTRYPOINT <span class="hljs-section">[&quot;java&quot;,&quot;-jar&quot;,&quot;ruoyi-admin.jar&quot;]</span><br><br><span class="hljs-section">[root@git-server ryjava]</span><span class="hljs-comment"># git add Dockerfile </span><br><span class="hljs-section">[root@git-server ryjava]</span><span class="hljs-comment"># git commit -m &quot;docker 1&quot;</span><br><span class="hljs-section">[master 76f71f4]</span> docker 1<br> 1 file changed, 1 insertion(+), 1 deletion(-)<br><span class="hljs-section">[root@git-server ryjava]</span><span class="hljs-comment"># git push origin master</span><br>Counting objects: 5, done.<br>Compressing objects: 100% (3/3), done.<br>Writing objects: 100% (3/3), 294 bytes | 0 bytes/s, done.<br>Total 3 (delta 2), reused 0 (delta 0)<br>To git@192.168.209.160:/git-server/ryjava/<br>   2b539ad..76f71f4  master -&gt; master<br><br><span class="hljs-section">[root@git-server ryjava]</span><span class="hljs-comment"># cd ../ryvue/</span><br><span class="hljs-section">[root@git-server ryvue]</span><span class="hljs-comment"># git add -A</span><br><span class="hljs-section">[root@git-server ryvue]</span><span class="hljs-comment"># git commit -m &quot;add 2&quot;</span><br><span class="hljs-section">[root@git-server ryvue]</span><span class="hljs-comment"># git push origin master</span><br><br></code></pre></td></tr></table></figure><h1 id="安装harbor仓库"><a href="#安装harbor仓库" class="headerlink" title="安装harbor仓库"></a>安装harbor仓库</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs ini">10.31.162.124haobor-server<br>安装docker<br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># yum install -y docker-ce</span><br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># systemctl start docker &amp;&amp; systemctl enable docker</span><br><br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># wget https://storage.googleapis.com/harbor-releases/release-1.8.0/harbor-offline-installer-v1.8.0.tgz</span><br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># yum -y install  lrzsz</span><br><br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># curl -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># chmod +x /usr/local/bin/docker-compose</span><br><br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># tar xf harbor-offline-installer-v1.8.0.tgz</span><br><br><span class="hljs-section">[root@harbor ~]</span><span class="hljs-comment"># cd harbor</span><br><br>http访问方式的配置：<br><span class="hljs-section">[root@harbor harbor]</span><span class="hljs-comment"># vim harbor.yml #主机名要可以解析(需要部署dns服务器，用/etc/hosts文件没有用)，如果不可以解析，可以使用IP地址,需要修改的内容如下</span><br>hostname: 10.31.162.124<br><br><span class="hljs-section">[root@harbor harbor]</span><span class="hljs-comment"># ./install.sh  #需要等待下载镜像</span><br><span class="hljs-section">[root@harbor-server harbor]</span><span class="hljs-comment"># docker-compose up -d</span><br>浏览器访问测试：<br>http://10.31.162.124<br>用户名admin 密码:Harbor12345<br><br><span class="hljs-section">[root@harbor harbor]</span><span class="hljs-comment"># docker login -uadmin -p&#x27;Harbor12345&#x27; 10.31.162.124</span><br></code></pre></td></tr></table></figure><h1 id="创建项目仓库"><a href="#创建项目仓库" class="headerlink" title="创建项目仓库"></a>创建项目仓库</h1><p><img src="/upload/docker-ruoyi1.webp" alt="docker-ruoyi1.webp"></p><h1 id="jenkins服务器"><a href="#jenkins服务器" class="headerlink" title="jenkins服务器"></a>jenkins服务器</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><code class="hljs ini">10.31.162.35jenkinx-server<br>1.安装jenkins 略<br>2.配置jenkins免密连接git、nginx、java服务器--略<br><br>安装git命令<br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># yum install git -y</span><br>安装java打包命令<br>安装maven打包命令--可以安装在java目录里<br>设置java、maven变量--/etc/profile<br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># source /etc/profile</span><br><span class="hljs-comment"># 查看版本，验证变量是否变量</span><br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># mvn -v</span><br>Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe<span class="hljs-comment">; 2018-06-</span><br><br>安装node.js前端打包工具命令npm<br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/node-v14.15.3-linux-x64.tar.gz</span><br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># tar xf node-v14.15.3-linux-x64.tar.gz -C /usr/local/</span><br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># cd /usr/local/</span><br><span class="hljs-section">[root@jenkins-server local]</span><span class="hljs-comment"># mv node-v14.15.3-linux-x64/ node</span><br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># vim /etc/profile</span><br><span class="hljs-attr">NODE_HOME</span>=/usr/local/node<br><span class="hljs-attr">PATH</span>=<span class="hljs-variable">$NODE_HOME</span>/bin:<span class="hljs-variable">$PATH</span><br>export NODE_HOME PATH<br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># source /etc/profile</span><br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># node -v</span><br>v12.18.4<br><br>安装docker<br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># yum install -y yum-utils device-mapper-persistent-data lvm2 git</span><br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># yum install -y docker-ce</span><br>启动并设置开机启动<br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># systemctl start docker &amp;&amp; systemctl enable docker</span><br><br>配置jenkins连接harbor仓库<br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># vim /etc/docker/daemon.json</span><br>&#123;<br>&quot;insecure-registries&quot;: <span class="hljs-section">[&quot;10.31.162.124&quot;]</span><br>&#125;<br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># systemctl restart docker </span><br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># docker login 10.31.162.124 -uadmin</span><br>Password: Harbor12345<br>Login Succeeded<br><br>创建带有java环境的基础镜像<br><span class="hljs-section">[root@jenkins-server ~]</span><span class="hljs-comment"># mkdir java</span><br>将对应版本的jdk包上传到该目录中<br><span class="hljs-section">[root@jenkins-server java]</span><span class="hljs-comment"># cat Dockerfile </span><br>FROM daocloud.io/library/centos:7<br><span class="hljs-comment"># 更新软件</span><br>RUN yum -y upgrade<br><span class="hljs-comment"># 安装中文包</span><br>RUN yum install -y kde-l10n-Chinese<br><span class="hljs-comment"># 重新安装glibc-common</span><br>RUN yum -y reinstall glibc-common<br><span class="hljs-comment"># 编译生成语言库</span><br>RUN localedef -c -f UTF-8 -i zh_CN zh_CN.utf8<br><span class="hljs-comment"># 设置语言默认值为中文，时区改为东八区</span><br>RUN echo &#x27;<span class="hljs-attr">LANG</span>=<span class="hljs-string">&quot;zh_CN.UTF-8&quot;</span><span class="hljs-string">&#x27; &gt; /etc/locale.conf</span><br><span class="hljs-string">RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="hljs-string">ENV LANG zh_CN.UTF-8</span><br><span class="hljs-string">ENV LC_ALL zh_CN.UTF-8</span><br><span class="hljs-string"># jdk1.8.0_321和自己下载的版本一致</span><br><span class="hljs-string">ENV JAVA_HOME /usr/local/jdk1.8.0_321</span><br><span class="hljs-string">ENV PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH</span><br><span class="hljs-string">ENV CLASSPATH=.:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar</span><br><span class="hljs-string"># jdk-8u321-linux-x64.tar.gz和自己下载的版本一致</span><br><span class="hljs-string">ADD jdk-8u321-linux-x64.tar.gz /usr/local/</span><br><span class="hljs-string"></span><br><span class="hljs-string">构建镜像</span><br><span class="hljs-string">[root@jenkins-server java]# docker build -t my-jdk:v1.0 .</span><br><span class="hljs-string">[root@jenkins-server java]# docker images</span><br><span class="hljs-string">[root@jenkins-server java]# docker images</span><br><span class="hljs-string">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="hljs-string">my-jdk                       v1.0                617a86a455e1        2 minutes ago  </span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@jenkins-server java]# docker tag my-jdk:v1.0 10.31.162.124/myjdk/my-jdk:v1.0</span><br><span class="hljs-string">将基础镜像上传到harbor仓库</span><br><span class="hljs-string">[root@jenkins-server java]# docker push 10.31.162.124/myjdk/my-jdk:v1.0</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">制作nginx基础镜像</span><br><span class="hljs-string">[root@jenkins-server nginx]# cat nginx.repo </span><br><span class="hljs-string">[nginx-stable]</span><br><span class="hljs-string">name=nginx stable repo</span><br><span class="hljs-string">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class="hljs-string">gpgcheck=0</span><br><span class="hljs-string">enabled=1</span><br><span class="hljs-string">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class="hljs-string">module_hotfixes=true</span><br><span class="hljs-string">[root@jenkins-server nginx]# cat Dockerfile </span><br><span class="hljs-string">FROM daocloud.io/library/centos:7</span><br><span class="hljs-string"># 更新软件</span><br><span class="hljs-string">RUN yum -y upgrade</span><br><span class="hljs-string"># 安装中文包</span><br><span class="hljs-string">RUN yum install -y kde-l10n-Chinese</span><br><span class="hljs-string"># 重新安装glibc-common</span><br><span class="hljs-string">RUN yum -y reinstall glibc-common</span><br><span class="hljs-string"># 编译生成语言库</span><br><span class="hljs-string">RUN localedef -c -f UTF-8 -i zh_CN zh_CN.utf8</span><br><span class="hljs-string"># 设置语言默认值为中文，时区改为东八区</span><br><span class="hljs-string">RUN echo &#x27;</span>LANG=<span class="hljs-string">&quot;zh_CN.UTF-8&quot;</span><span class="hljs-string">&#x27; &gt; /etc/locale.conf</span><br><span class="hljs-string">RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="hljs-string">ENV LANG zh_CN.UTF-8</span><br><span class="hljs-string">ENV LC_ALL zh_CN.UTF-8</span><br><span class="hljs-string"></span><br><span class="hljs-string">ADD nginx.repo /etc/yum.repos.d/</span><br><span class="hljs-string">RUN yum install -y nginx</span><br><span class="hljs-string">EXPOSE 80</span><br><span class="hljs-string">CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</span><br><span class="hljs-string"></span><br><span class="hljs-string">[root@jenkins-server nginx]# docker build -t myningx:v1.0 .</span><br><span class="hljs-string">[root@jenkins-server nginx]# docker tag myningx:v1.0 10.31.162.124/nginx/mynginx:v1.0</span><br><span class="hljs-string">[root@jenkins-server nginx]# docker push 10.31.162.124/nginx/mynginx:v1.0</span><br></code></pre></td></tr></table></figure><h1 id="配置ssh连接前端服务器"><a href="#配置ssh连接前端服务器" class="headerlink" title="配置ssh连接前端服务器"></a>配置ssh连接前端服务器</h1><h2 id="配置前端服务器"><a href="#配置前端服务器" class="headerlink" title="配置前端服务器"></a>配置前端服务器</h2><p><code>访问10.31.162.35:8080/jenkins</code></p><p><img src="/upload/docker-ruoyi2.webp" alt="docker-ruoyi1.webp"></p><p><img src="/upload/docker-ruoyi3.webp" alt="docker-ruoyi1.webp"></p><h1 id="创建后端构建任务"><a href="#创建后端构建任务" class="headerlink" title="创建后端构建任务"></a>创建后端构建任务</h1><p><img src="/upload/docker-ruoyi4.webp" alt="docker-ruoyi1.webp">)</p><p><img src="/upload/docker-ruoyi5.webp" alt="docker-ruoyi1.webp"></p><p><img src="/upload/docker-ruoyi6.webp" alt="docker-ruoyi1.webp"></p><p><img src="/upload/docker-ruoyi7.webp" alt="docker-ruoyi1.webp"></p><p><img src="/upload/docker-ruoyi8.webp" alt="docker-ruoyi1.webp"></p><p><img src="/upload/docker-ruoyi9.webp" alt="docker-ruoyi1.webp"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ini">脚本内容提供：<br>docker build -t java-server:v1.0 .<br>docker tag java-server:v1.0  10.31.162.124/java-server/java-server:v1.0<br>docker login -u admin -p Harbor12345 192.168.209.166<br>docker push 192.168.209.166/java-server/java-server:v1.0 &amp;&amp; docker rmi 10.31.162.124/java-server/java-server:v1.0<br></code></pre></td></tr></table></figure><p><img src="/upload/docker-ruoyi10.webp" alt="docker-ruoyi1.webp"></p><h1 id="创建前端构建任务"><a href="#创建前端构建任务" class="headerlink" title="创建前端构建任务"></a>创建前端构建任务</h1><p><img src="/upload/docker-ruoyi11.webp" alt="docker-ruoyi1.webp"></p><p><img src="/upload/docker-ruoyi12.webp" alt="docker-ruoyi1.webp"></p><p><img src="/upload/docker-ruoyi13.webp" alt="docker-ruoyi1.webp"></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs ini">前端脚本<br><span class="hljs-comment">#环境变量</span><br>echo $PATH<br><span class="hljs-comment">#进入jenkins workspace的项目目录</span><br>cd $&#123;WORKSPACE&#125;<br><span class="hljs-comment">#镜像选择淘宝的镜像</span><br>npm install --unsafe-perm <span class="hljs-attr">--registry</span>=https://registry.npm.taobao.org<br><span class="hljs-comment">#开始打包</span><br>npm run build:prod<br><br><span class="hljs-comment">#进入到打包目录</span><br>cd dist/<br><span class="hljs-comment">#删除上次打包生成的压缩文件</span><br>rm -rf *.tar.gz<br><span class="hljs-comment">#把生成的项目打包成压缩包方便传输到远程服务器</span><br>tar -zcvf `date +%F`.tar.gz *<br><span class="hljs-comment">#回到上层工作目录</span><br>cd ../<br></code></pre></td></tr></table></figure><h1 id="配置构建后操作"><a href="#配置构建后操作" class="headerlink" title="配置构建后操作"></a>配置构建后操作</h1><p><img src="/upload/docker-ruoyi14.webp" alt="docker-ruoyi1.webp"></p><p><img src="/upload/docker-ruoyi15.webp" alt="docker-ruoyi1.webp"></p><p><code>保存返回面板，开始构建</code></p><h1 id="部署后端java服务"><a href="#部署后端java服务" class="headerlink" title="部署后端java服务"></a>部署后端java服务</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ini">下载jocker<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># yum install -y docker-ce</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># systemctl start docker &amp;&amp; systemctl enable docker</span><br><br>配置连接harbor仓库地址<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># vim /etc/docker/daemon.json</span><br>&#123;<br>&quot;insecure-registries&quot;: <span class="hljs-section">[&quot;10.31.162.124&quot;]</span><br>&#125;<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># systemctl restart docker</span><br><br>登陆仓库<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># docker login -u admin -p Harbor12345 10.31.162.124</span><br>下载镜像<br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># docker pull 10.31.162.124/java-server/java-server:v1.0</span><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># docker images</span><br>REPOSITORY                                TAG       IMAGE ID       CREATED                  SIZE<br>192.168.209.166/java-server/java-server   v1.0      23d4017d23fc   Less than a second ago   725MB<br><br><span class="hljs-section">[root@java-server ~]</span><span class="hljs-comment"># docker run -itd --name java-server --restart=always --net host 10.31.162.124/java-server/java-server:v1.0</span><br></code></pre></td></tr></table></figure><h1 id="查看nginx服务器端口有没有起来"><a href="#查看nginx服务器端口有没有起来" class="headerlink" title="查看nginx服务器端口有没有起来"></a>查看nginx服务器端口有没有起来</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@nginx-server ~]</span><span class="hljs-comment"># ss -lnpt#查看80端口有没有起来</span><br></code></pre></td></tr></table></figure><h1 id="登入web测试"><a href="#登入web测试" class="headerlink" title="登入web测试"></a>登入web测试</h1><p><code>访问 10.31.162.25</code>会出来偌依的界面</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>kubeadm方式部署k8s集群</title>
    <link href="/2025/11/06/kubeadm%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/"/>
    <url>/2025/11/06/kubeadm%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/</url>
    
    <content type="html"><![CDATA[<p>k8s集群部署</p><h1 id="下载k8s谷歌镜像"><a href="#下载k8s谷歌镜像" class="headerlink" title="下载k8s谷歌镜像"></a>下载k8s谷歌镜像</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker pull k8s.gcr.io/kube-apiserver:v1.16.1<br>docker pull k8s.gcr.io/kube-proxy:v1.16.1<br>docker pull k8s.gcr.io/kube-controller-manager:v1.16.1<br>docker pull k8s.gcr.io/kube-scheduler:v1.16.1<br>docker pull k8s.gcr.io/etcd:3.3.15<br>docker pull k8s.gcr.io/pause:3.1<br>docker pull k8s.gcr.io/coredns:1.6.2<br><br>谷歌的k8s镜像库下载不下来<br></code></pre></td></tr></table></figure><h1 id="特别说明"><a href="#特别说明" class="headerlink" title="特别说明"></a>特别说明</h1><ul><li>所有机器都必须有镜像</li><li>每次部署都会有版本更新，具体版本要求，运行初始化过程失败会有版本提示</li><li>kubeadm的版本和镜像的版本必须是对应的</li></ul><h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs ini">本地解析<br><span class="hljs-section">[root@master ~]</span><span class="hljs-comment"># vim /etc/hosts</span><br>10.31.162.133kub-k8s-master<br>10.31.162.134kub-k8s-node1<br>10.31.162.135kub-k8s-node2<br><br>1.关闭防火墙：<br><span class="hljs-comment"># systemctl stop firewalld</span><br><span class="hljs-comment"># systemctl disable firewalld</span><br>2.禁用SELinux：<br><span class="hljs-comment"># setenforce 0</span><br>3.编辑文件/etc/selinux/config，将SELINUX修改为disabled，如下：<br><span class="hljs-comment"># sed -i &#x27;s/SELINUX=permissive/SELINUX=disabled/&#x27; /etc/sysconfig/selinux</span><br><span class="hljs-attr">SELINUX</span>=disabled <br><br>k8s集群需要关闭swap分区<br><span class="hljs-section">[root@master ~]</span><span class="hljs-comment"># swapoff -a</span><br>修改/etc/fstab文件，注释掉SWAP的自动挂载，使用free -m确认swap已经关闭。<br>2.注释掉swap分区：<br><span class="hljs-section">[root@master ~]</span><span class="hljs-comment"># sed -i &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="hljs-comment"># free -m</span><br>              total        used        free      shared  buff/cache   available<br>Mem:           3935         144        3415           8         375        3518<br>Swap:             0           0           0<br></code></pre></td></tr></table></figure><h1 id="安装docker–三台机器都操作"><a href="#安装docker–三台机器都操作" class="headerlink" title="安装docker–三台机器都操作"></a>安装docker–三台机器都操作</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs ini">清理环境<br><span class="hljs-section">[root@master ~]</span><span class="hljs-comment"># yum remove docker \</span><br>docker-client \<br>docker-client-latest \<br>docker-common \<br>docker-latest \<br>docker-latest-logrotate \<br>docker-logrotate \<br>docker-selinux \<br>docker-engine-selinux \<br>docker-engine<br>下载docker<br><span class="hljs-section">[root@master ~]</span><span class="hljs-comment"># yum install -y yum-utils device-mapper-persistent-data lvm2 git</span><br>更换阿里的源<br><span class="hljs-section">[root@master ~]</span><span class="hljs-comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br>下载dockers客户端<br><span class="hljs-section">[root@master ~]</span><span class="hljs-comment"># yum install docker-ce -y</span><br><span class="hljs-section">[root@master ~]</span><span class="hljs-comment"># systemctl start docker &amp;&amp; systemctl enable docker</span><br><br><span class="hljs-comment">#注:在目前k8s版本1.20以后将原来的cgroupfs驱动程序修改成了systemd来为容器做资源限制，故此需要将docker的驱动程序修改为systemd。(所有节点)</span><br><br><span class="hljs-section">[root@master ~]</span><span class="hljs-comment"># cat /etc/docker/daemon.json </span><br>&#123;<br> &quot;exec-opts&quot;:<span class="hljs-section">[&quot;native.cgroupdriver=systemd&quot;]</span><br>&#125;<br><br>重启docker<br></code></pre></td></tr></table></figure><h1 id="阿里仓库下载"><a href="#阿里仓库下载" class="headerlink" title="阿里仓库下载"></a>阿里仓库下载</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs ini">下载镜像<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># vim pull.sh </span><br><span class="hljs-comment">#!/usr/bin/bash</span><br>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.2<br>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.2<br>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.2<br>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.2<br>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.8.4<br>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0<br>docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5<br><br>下载完了之后需要将aliyun下载下来的所有镜像打成k8s.gcr.io/kube-controller-manager:v1.22.2这样的tag<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># vim tag.sh </span><br><span class="hljs-comment">#!/usr/bin/bash</span><br>docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.2 k8s.gcr.io/kube-controller-manager:v1.22.2<br>docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.2 k8s.gcr.io/kube-proxy:v1.22.2<br>docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.2 k8s.gcr.io/kube-apiserver:v1.22.2<br>docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.2 k8s.gcr.io/kube-scheduler:v1.22.2<br>docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.8.4 k8s.gcr.io/coredns/coredns:v1.8.4<br>docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0 k8s.gcr.io/etcd:3.5.0-0<br>docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5 k8s.gcr.io/pause:3.5<br>版本号不用变<br></code></pre></td></tr></table></figure><h1 id="使用kubeadm部署Kubernetes"><a href="#使用kubeadm部署Kubernetes" class="headerlink" title="使用kubeadm部署Kubernetes"></a>使用kubeadm部署Kubernetes</h1><p><strong>所有节点安装kubeadm和kubelet</strong></p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs ini">配置源<br><span class="hljs-section">[root@kub-k8s-master ~]</span><span class="hljs-comment"># cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class="hljs-section">[kubernetes]</span><br><span class="hljs-attr">name</span>=Kubernetes<br><span class="hljs-attr">baseurl</span>=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x<span class="hljs-number">86_64</span><br><span class="hljs-attr">enabled</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgcheck</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">repo_gpgcheck</span>=<span class="hljs-number">1</span><br><span class="hljs-attr">gpgkey</span>=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg<br>EOF<br><br>安装对应版本<br>1.安装最新版本<br><span class="hljs-comment"># yum makecache fast</span><br><span class="hljs-comment"># yum install -y kubelet kubeadm kubectl ipvsadm</span><br>=========================================<br>2.安装对应版本<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># yum install -y kubelet-1.22.2-0.x86_64 kubeadm-1.22.2-0.x86_64 kubectl-1.22.2-0.x86_64 ipvsadm</span><br><br>加载ipvs相关内核模块<br><span class="hljs-comment">#如果重新开机，需要重新加载（可以写在 /etc/rc.local 中开机自动加载）</span><br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># vim /etc/rc.local </span><br>modprobe ip_vs<br>modprobe ip_vs_rr<br>modprobe ip_vs_wrr<br>modprobe ip_vs_sh<br>modprobe nf_conntrack_ipv4<br><br>给与执行权限<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># chmod +x /etc/rc.local</span><br>重启服务器<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># init 6</span><br><br>配置转发相关参数，否则可能会出错<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span><br><span class="hljs-attr">net.bridge.bridge-nf-call-ip6tables</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">net.bridge.bridge-nf-call-iptables</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">vm.swappiness</span>=<span class="hljs-number">0</span><br>EOF<br><br>使配置生效<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># sysctl --system</span><br><br>如果net.bridge.bridge-nf-call-iptables报错，加载br_netfilter模块<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># modprobe br_netfilter</span><br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># sysctl -p /etc/sysctl.d/k8s.conf</span><br><br>查看是否加载成功<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># lsmod | grep ip_vs</span><br>ip_vs_sh               12688  0 <br>ip_vs_wrr              12697  0 <br>ip_vs_rr               12600  0 <br>ip_vs                 141092  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr<br>nf_conntrack          133387  2 ip_vs,nf_conntrack_ipv4<br>libcrc32c              12644  3 xfs,ip_vs,nf_conntrack<br></code></pre></td></tr></table></figure><h1 id="配置启动kubelet（所有节点）"><a href="#配置启动kubelet（所有节点）" class="headerlink" title="配置启动kubelet（所有节点）"></a>配置启动kubelet（所有节点）</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini">配置变量：<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># DOCKER_CGROUPS=`docker info |grep &#x27;Cgroup&#x27; | awk &#x27; NR==1 &#123;print $3&#125;&#x27;`</span><br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># echo $DOCKER_CGROUPS</span><br>cgroupfs 1<br><br>配置kubelet的cgroups<br><span class="hljs-comment"># cat &gt;/etc/sysconfig/kubelet&lt;&lt;EOF</span><br><span class="hljs-attr">KUBELET_EXTRA_ARGS</span>=<span class="hljs-string">&quot;--cgroup-driver=$DOCKER_CGROUPS --pod-infra-container-image=k8s.gcr.io/pause:3.5&quot;</span><br>EOF<br><br>启动<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># systemctl daemon-reload</span><br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># systemctl enable kubelet &amp;&amp; systemctl restart kubelet</span><br></code></pre></td></tr></table></figure><h1 id="配置master节点"><a href="#配置master节点" class="headerlink" title="配置master节点"></a>配置master节点</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># kubeadm init --kubernetes-version=v1.22.2 --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=10.31.162.133 --ignore-preflight-errors=Swap</span><br><br>kubeadm join 192.168.246.166:6443 --token 93erio.hbn2ti6z50he0lqs \<br>    --discovery-token-ca-cert-hash sha256:3bc60f06a19bd09f38f3e05e5cff4299011b7110ca3281796668f4edb29a56d9  <span class="hljs-comment">#需要记住，要保存好，配置node节点需要用到</span><br>注：<br><span class="hljs-attr">apiserver-advertise-address</span>=<span class="hljs-number">192.168</span>.<span class="hljs-number">246.166</span>    ---master的ip地址。<br><span class="hljs-attr">--kubernetes-version</span>=v1.<span class="hljs-number">16.1</span>   --更具具体版本进行修改<br>注意在检查一下swap分区是否关闭<br><br>如下操作在master节点操作<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># mkdir -p $HOME/.kube</span><br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># chown $(id -u):$(id -g) $HOME/.kube/config</span><br></code></pre></td></tr></table></figure><h1 id="配置使用网络插件"><a href="#配置使用网络插件" class="headerlink" title="配置使用网络插件"></a>配置使用网络插件</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs ini">在master节点操作<br>下载配置<br><span class="hljs-section">[root@k8s-master ~]</span><span class="hljs-comment"># cd ~ &amp;&amp; mkdir flannel &amp;&amp; cd flannel</span><br><br>下载flannel文件由于网站被墙了，需要如下操作：<br><span class="hljs-section">[root@k8s-master flannel]</span><span class="hljs-comment"># curl -O https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><br>修改配置文件kube-flannel.yml:<br>此处的ip配置要与上面kubeadm的pod-network一致，本来就一致，不用改<br>  net-conf.json: |<br>    &#123;<br>      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,<br>      &quot;Backend&quot;: &#123;<br>        &quot;Type&quot;: &quot;vxlan&quot;<br>      &#125;<br>    &#125;<br><span class="hljs-comment"># 如果Node有多个网卡的话，参考https://github.com/kubernetes/kubernetes/issues/39701</span><br><span class="hljs-comment"># 目前需要在kube-flannel.yml中使用--iface参数指定集群主机内网网卡的名称，否则可能会出现dns无法解析。容器无法通信的情况。</span><br><span class="hljs-comment">#需要将kube-flannel.yml下载到本地，</span><br><span class="hljs-comment"># flanneld启动参数加上--iface=&lt;iface-name&gt;</span><br>    containers:<br>      - name: kube-flannel<br>        image: quay.io/coreos/flannel:v0.12.0-amd64<br>        command:<br>        - /opt/bin/flanneld<br>        args:<br>        - --ip-masq<br>        - --kube-subnet-mgr<br>        - <span class="hljs-attr">--iface</span>=ens33<span class="hljs-comment">#如果一个，就添加这一个就行</span><br>        - <span class="hljs-attr">--iface</span>=eth0<br><span class="hljs-comment"># 如果有多个网卡可以多个添加，没有多个就添加一个ens33就可以</span><br>⚠️⚠️⚠️<span class="hljs-attr">--iface</span>=ens33 的值，是你当前的网卡,或者可以指定多网卡<br><br><span class="hljs-comment"># 1.12版本的kubeadm额外给node1节点设置了一个污点(Taint)：node.kubernetes.io/not-ready:NoSchedule，</span><br><span class="hljs-comment"># 很容易理解，即如果节点还没有ready之前，是不接受调度的。可是如果Kubernetes的网络插件还没有部署的话，节点是不会进入ready状态的。</span><br><span class="hljs-comment"># 因此修改以下kube-flannel.yaml的内容，加入对node.kubernetes.io/not-ready:NoSchedule这个污点的容忍：</span><br>    - key: beta.kubernetes.io/arch<br>                    operator: In<br>                    values:<br>                      - arm64<br>      hostNetwork: true<br>      tolerations:<br>      - operator: Exists<br>        effect: NoSchedule<br>      - key: node.kubernetes.io/not-ready  <span class="hljs-comment">#添加如下三行---在165行左右</span><br>        operator: Exists<br>        effect: NoSchedule<br>      serviceAccountName: flannel<br><br>启动：<br><span class="hljs-section">[root@k8s-master flannel]</span><span class="hljs-comment"># kubectl apply -f ~/flannel/kube-flannel.yml  #启动完成之后需要等待一会</span><br><br>查看、验证：<br><span class="hljs-comment"># 查看kube-system命名空间中的pod信息</span><br><span class="hljs-section">[root@k8s-master flannel]</span><span class="hljs-comment"># kubectl get pods --namespace kube-system</span><br><span class="hljs-comment"># 查看 Kubernetes 集群中的服务信息</span><br><span class="hljs-section">[root@k8s-master flannel]</span><span class="hljs-comment"># kubectl get service</span><br><span class="hljs-comment"># 查看 Kubernetes 集群中 kube-dns 服务的详细信息</span><br><span class="hljs-section">[root@k8s-master flannel]</span><span class="hljs-comment"># kubectl get svc --namespace kube-system</span><br>只有网络插件也安装配置完成之后，才能会显示为ready状态<br></code></pre></td></tr></table></figure><h1 id="所有node节点操作"><a href="#所有node节点操作" class="headerlink" title="所有node节点操作"></a>所有node节点操作</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs ini">配置node节点加入集群：<br>如果报错开启ip转发：<br><span class="hljs-comment"># sysctl -w net.ipv4.ip_forward=1</span><br><br>在所有node节点操作，此命令为初始化master成功后返回的结果<br><span class="hljs-section">[root@kub-k8s-node1 ~]</span><span class="hljs-comment"># kubeadm join 10.31.162.133:6443 --token 4pynt1.te3qf0zf7os3juf8 \</span><br>        --discovery-token-ca-cert-hash sha256:90142b9ae11196be81844225273cf64f74cc31b5f9250a81fdc2347dc55d2890 <br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>k8s 常用命令</title>
    <link href="/2025/11/06/k8s-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2025/11/06/k8s-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h1 id="k8s常用命令"><a href="#k8s常用命令" class="headerlink" title="k8s常用命令"></a>k8s常用命令</h1><h1 id="查看ststem命名空间中pod的信息"><a href="#查看ststem命名空间中pod的信息" class="headerlink" title="查看ststem命名空间中pod的信息"></a>查看ststem命名空间中pod的信息</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl get pods --namespace kube-system<br><br>kubectl get pods -n kube-system<br></code></pre></td></tr></table></figure><h1 id="查看k8s中的服务信息"><a href="#查看k8s中的服务信息" class="headerlink" title="查看k8s中的服务信息"></a>查看k8s中的服务信息</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl get service<br></code></pre></td></tr></table></figure><h1 id="查看k8s中kube-dns的服务信息"><a href="#查看k8s中kube-dns的服务信息" class="headerlink" title="查看k8s中kube-dns的服务信息"></a>查看k8s中kube-dns的服务信息</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl get svc --namespace kube-system<br></code></pre></td></tr></table></figure><h1 id="查看所有节点"><a href="#查看所有节点" class="headerlink" title="查看所有节点"></a>查看所有节点</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl get nodes<br></code></pre></td></tr></table></figure><h1 id="查看node节点详细信息"><a href="#查看node节点详细信息" class="headerlink" title="查看node节点详细信息"></a>查看node节点详细信息</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl describe node node-1<br></code></pre></td></tr></table></figure><h1 id="查看所有名称空间内的资源"><a href="#查看所有名称空间内的资源" class="headerlink" title="查看所有名称空间内的资源"></a>查看所有名称空间内的资源</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl get pods --all-namespaces<br></code></pre></td></tr></table></figure><h1 id="同时查看多种资源信息"><a href="#同时查看多种资源信息" class="headerlink" title="同时查看多种资源信息"></a>同时查看多种资源信息</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl get pod,svc -n kube-system<br></code></pre></td></tr></table></figure><h1 id="查看apiserver信息"><a href="#查看apiserver信息" class="headerlink" title="查看apiserver信息"></a>查看apiserver信息</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl cluster-info<br></code></pre></td></tr></table></figure><h1 id="api查询"><a href="#api查询" class="headerlink" title="api查询"></a>api查询</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl api-versions<br></code></pre></td></tr></table></figure><h1 id="创建yml文件时用来查看帮助的命令"><a href="#创建yml文件时用来查看帮助的命令" class="headerlink" title="创建yml文件时用来查看帮助的命令"></a>创建yml文件时用来查看帮助的命令</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl explain 类型名<br>例如：kubectl explain namespace.spec<br></code></pre></td></tr></table></figure><h1 id="创建yml文件资源的命令"><a href="#创建yml文件资源的命令" class="headerlink" title="创建yml文件资源的命令"></a>创建yml文件资源的命令</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl apply -f  yml文件名字<br></code></pre></td></tr></table></figure><h1 id="查看某一个namespace"><a href="#查看某一个namespace" class="headerlink" title="查看某一个namespace"></a>查看某一个namespace</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl get namespace 名称空间的名字<br></code></pre></td></tr></table></figure><h1 id="查看某个namespace的详细信息"><a href="#查看某个namespace的详细信息" class="headerlink" title="查看某个namespace的详细信息"></a>查看某个namespace的详细信息</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl describe namespace 名称空间的名字<br></code></pre></td></tr></table></figure><h1 id="查看在哪个node节点"><a href="#查看在哪个node节点" class="headerlink" title="查看在哪个node节点"></a>查看在哪个node节点</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl get po -n qingfeng -o wide<br></code></pre></td></tr></table></figure><h1 id="创建名称空间"><a href="#创建名称空间" class="headerlink" title="创建名称空间"></a>创建名称空间</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl create namespace qingfeng<br></code></pre></td></tr></table></figure><h1 id="查看默认命名空间信息"><a href="#查看默认命名空间信息" class="headerlink" title="查看默认命名空间信息"></a>查看默认命名空间信息</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl describe namespaces default <br></code></pre></td></tr></table></figure><h1 id="删除默认空间资源限制"><a href="#删除默认空间资源限制" class="headerlink" title="删除默认空间资源限制"></a>删除默认空间资源限制</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl delete resourcequotas limit-qianfeng <br></code></pre></td></tr></table></figure><h1 id="查看所有命名空间"><a href="#查看所有命名空间" class="headerlink" title="查看所有命名空间"></a>查看所有命名空间</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl get pod -A<br></code></pre></td></tr></table></figure><h1 id="查看pod详细信息"><a href="#查看pod详细信息" class="headerlink" title="查看pod详细信息"></a>查看pod详细信息</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl describe pod pod-1<br></code></pre></td></tr></table></figure><h1 id="在-master机器上进入容器"><a href="#在-master机器上进入容器" class="headerlink" title="在 master机器上进入容器"></a>在 master机器上进入容器</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl exec -it 元数据名字 -c 容器名字 -- bash<br>kubectl exec -it pod-1 -c centos -- bash<br></code></pre></td></tr></table></figure><h1 id="删除定义的容器"><a href="#删除定义的容器" class="headerlink" title="删除定义的容器"></a>删除定义的容器</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl delete -f yml名字 <br>kubectl delete -f app.yml <br></code></pre></td></tr></table></figure><h1 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubectl delete node 节点名<br></code></pre></td></tr></table></figure><h1 id="重置节点"><a href="#重置节点" class="headerlink" title="重置节点"></a>重置节点</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini">kubeadm reset<br><br>注2：master上在reset之后需要删除如下文件<br><span class="hljs-comment"># rm -rf /var/lib/cni/ $HOME/.kube/config</span><br></code></pre></td></tr></table></figure><h1 id="命令补全"><a href="#命令补全" class="headerlink" title="命令补全"></a>命令补全</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini">yum -y install bash-completion<br>source /usr/share/bash-completion/bash_completion<br>source &lt;(kubectl completion bash)<br>echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc<br></code></pre></td></tr></table></figure><h1 id="重新生成token"><a href="#重新生成token" class="headerlink" title="重新生成token"></a>重新生成token</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs ini">重新生成方法：<br>1. 重新生成新的token:<br><span class="hljs-section">[root@kub-k8s-master]</span><span class="hljs-comment"># kubeadm  token create</span><br>kiyfhw.xiacqbch8o8fa8qj<br><span class="hljs-section">[root@kub-k8s-master]</span><span class="hljs-comment"># kubeadm  token list</span><br>TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION   EXTRA GROUPS<br>gvvqwk.hn56nlsgsv11mik6   &lt;invalid&gt;   2018-10-25T14:16:06+08:00   authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token<br>kiyfhw.xiacqbch8o8fa8qj   23h         2018-10-27T06:39:24+08:00   authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token<br><br>2. 获取ca证书sha256编码hash值:<br><span class="hljs-section">[root@kub-k8s-master]</span><span class="hljs-comment"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#x27;s/^.* //&#x27;</span><br>5417eb1b68bd4e7a4c82aded83abc55ec91bd601e45734d6aba85de8b1ebb057<br><br>3. 节点加入集群:<br>  kubeadm join 18.16.202.35:6443 --token kiyfhw.xiacqbch8o8fa8qj --discovery-token-ca-cert-hash sha256:5417eb1b68bd4e7a4c82aded83abc55ec91bd601e45734d6aba85de8b1ebb057<br>几秒钟后，您应该注意到kubectl get nodes在主服务器上运行时输出中的此节点。<br><br>上面的方法比较繁琐，一步到位：<br><span class="hljs-section">[root@kub-k8s-master ~]</span><span class="hljs-comment"># kubeadm token create --print-join-command</span><br><br>第二种方法：<br><span class="hljs-section">[root@kub-k8s-master ~]</span><span class="hljs-comment"># token=$(kubeadm token generate)</span><br>kubeadm token create $token --print-join-command <span class="hljs-attr">--ttl</span>=<span class="hljs-number">0</span><br><br>然后在node节点执行<br><span class="hljs-section">[root@kub-k8s-node1 ~]</span><span class="hljs-comment"># kubeadm reset</span><br><span class="hljs-section">[root@kub-k8s-node1 ~]</span><span class="hljs-comment"># 执行生成得token</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>自定义下载--php版本</title>
    <link href="/2025/11/06/%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8B%E8%BD%BD-php%E7%89%88%E6%9C%AC/"/>
    <url>/2025/11/06/%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8B%E8%BD%BD-php%E7%89%88%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h1 id="下载官网php"><a href="#下载官网php" class="headerlink" title="下载官网php"></a>下载官网php</h1><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs 1c"><span class="hljs-meta"># wget http:<span class="hljs-comment">//rpms.remirepo.net/enterprise/remi-release-7.9.rpm</span></span><br><span class="hljs-meta"># -Uvh带有下载更新的作用,会有多个版本</span><br>rpm <span class="hljs-punctuation">-</span>Uvh http<span class="hljs-punctuation">:</span><span class="hljs-comment">//rpms.remirepo.net/enterprise/remi-release-7.rpm</span><br></code></pre></td></tr></table></figure><h1 id="会在-etc-yum-repos-d目录生成许多remi的仓库，其中包含不同版本的php仓库"><a href="#会在-etc-yum-repos-d目录生成许多remi的仓库，其中包含不同版本的php仓库" class="headerlink" title="会在&#x2F;etc&#x2F;yum.repos.d目录生成许多remi的仓库，其中包含不同版本的php仓库"></a>会在&#x2F;etc&#x2F;yum.repos.d目录生成许多remi的仓库，其中包含不同版本的php仓库</h1><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs smali">[root@server ~]<span class="hljs-comment"># cd /etc/yum.repos.d/</span><br>[root@server yum.repos.d]<span class="hljs-comment"># ls</span><br>CentOS-Base.repo   remi-modular.repo  remi-php72.repo  remi-php81.repo  remi-safe.repo<br>epel.repo          remi-php54.repo    remi-php73.repo  remi-php82.repo<br>epel.repo.rpmnew   remi-php70.repo    remi-php74.repo  remi-php83.repo<br>epel-testing.repo  remi-php71.repo    remi-php80.repo  remi.repo<br></code></pre></td></tr></table></figure><h1 id="安装yum-config-manager仓库管理工具并安装指定版本的php"><a href="#安装yum-config-manager仓库管理工具并安装指定版本的php" class="headerlink" title="安装yum-config-manager仓库管理工具并安装指定版本的php"></a>安装yum-config-manager仓库管理工具并安装指定版本的php</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">yum -y <span class="hljs-keyword">install </span>yum-utils<br>yum-<span class="hljs-built_in">config</span>-manager --enable remi-php72<br><br><span class="hljs-comment">#如果想选择其它版本的话，把remi-php72改为remi-php71、remi-php70等，要看/etc/yum.repos.d/里的remi仓库，一一对应上</span><br></code></pre></td></tr></table></figure><h1 id="安装php及对应的模块"><a href="#安装php及对应的模块" class="headerlink" title="安装php及对应的模块"></a>安装php及对应的模块</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">安装php<br><span class="hljs-meta prompt_">]# </span><span class="language-bash">yum -y install php</span> <br><span class="hljs-meta prompt_">#</span><span class="language-bash">因为直接用yum-config-manager --<span class="hljs-built_in">enable</span> 指定了php7.2版本了，这里安装的php为7.2版本的</span><br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装常用的php模块</span><br><span class="hljs-meta prompt_">]# </span><span class="language-bash">yum -y install php php72-php-opcache  php72-php-ldap php72-php-odbc php72-php-pear php72-php-xml php72-php-xmlrpc php72-php-soap curl curl-devel  php72-php-mbstring php72-php-mysqlnd  php72-php-fpm  php72-php-gd</span><br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">安装php-fpm</span><br><span class="hljs-meta prompt_">]# </span><span class="language-bash">yum -y install php72-php-fpm.x86_64</span><br><span class="hljs-meta prompt_">]# </span><span class="language-bash">systemctl restart php72-php-fpm       <span class="hljs-comment">#启动php-fpm服务</span></span><br><span class="hljs-meta prompt_">]#</span><span class="language-bash">netstat -tunlp|grep 9000               <span class="hljs-comment">#查看9000端口是否正常启动了</span></span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>syncTV远程共享视频网站部署</title>
    <link href="/2025/11/06/syncTV%E8%BF%9C%E7%A8%8B%E5%85%B1%E4%BA%AB%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/syncTV%E8%BF%9C%E7%A8%8B%E5%85%B1%E4%BA%AB%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h1 id="syncTV远程同步观看web部署"><a href="#syncTV远程同步观看web部署" class="headerlink" title="syncTV远程同步观看web部署"></a>syncTV远程同步观看web部署</h1><p><a href="https://synctv.wiki/#/quickstart?id=docker">官网地址点这里</a></p><h1 id="一、docker安装"><a href="#一、docker安装" class="headerlink" title="一、docker安装"></a>一、docker安装</h1><p><a href="https://docs.docker.com/engine/install/centos/https://docs.docker.com/engine/install/centos/">docker官网点这里</a></p><h1 id="docker一键脚本安装"><a href="#docker一键脚本安装" class="headerlink" title="docker一键脚本安装"></a>docker一键脚本安装</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">bash &lt;(curl -sSL https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/xbd666/</span>qingfeng<span class="hljs-regexp">/raw/m</span>aster/toolbox.sh)<br></code></pre></td></tr></table></figure><h1 id="二、可以直接用命令运行synctv，但是建议用下面yaml文件方式运行synctv"><a href="#二、可以直接用命令运行synctv，但是建议用下面yaml文件方式运行synctv" class="headerlink" title="二、可以直接用命令运行synctv，但是建议用下面yaml文件方式运行synctv"></a>二、可以直接用命令运行synctv，但是建议用下面yaml文件方式运行synctv</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> run --name synctv -d -p <span class="hljs-number">8080</span>:<span class="hljs-number">8080</span> synctvorg/synctv:latest<br></code></pre></td></tr></table></figure><h1 id="三、创建docker-compose-yaml文件"><a href="#三、创建docker-compose-yaml文件" class="headerlink" title="三、创建docker-compose.yaml文件"></a>三、创建docker-compose.yaml文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> synctv &amp;&amp; <span class="hljs-built_in">cd</span> synctv      <span class="hljs-comment">#创建一个目录，并进入此目录</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> docker-compose.yaml<br></code></pre></td></tr></table></figure><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">version:</span> <span class="hljs-string">&quot;3.3&quot;</span>    <span class="hljs-comment">#这是docker-compose文件版本的声明</span><br><span class="hljs-params">services:</span><br> <span class="hljs-params">synctv:</span>       <span class="hljs-comment">#服务的别名，可以自定义</span><br>  <span class="hljs-params">container_name:</span> synctv     <span class="hljs-comment">#容器名，可以自定义</span><br>  <span class="hljs-params">ports:</span><br>  <span class="hljs-operator">-</span> &#x27;<span class="hljs-number">8080</span>:<span class="hljs-number">8080</span>&#x27;   <span class="hljs-comment">#端口，左侧的8080可以自定义，映射到容器内部，右侧是容器内部端口</span><br>  <span class="hljs-params">environment:</span><br>  <span class="hljs-operator">-</span> PUID<span class="hljs-operator">=</span><span class="hljs-number">0</span>    <span class="hljs-comment"># 用户ID，在终端输入id可以查看到当前用户的id</span><br>  <span class="hljs-operator">-</span> PGID<span class="hljs-operator">=</span><span class="hljs-number">0</span>    <span class="hljs-comment"># 组ID同上</span><br>  <span class="hljs-operator">-</span> TZ<span class="hljs-operator">=</span>Asia<span class="hljs-symbol">/Shanghai</span>   <span class="hljs-comment"># 时区，可以自定义</span><br>  <span class="hljs-params">restart:</span> always      <span class="hljs-comment"># 开启自启动其他选项看以下备注</span><br>  <span class="hljs-params">volumes:</span><br>  <span class="hljs-operator">-</span> &#x27;.<span class="hljs-operator">/</span>data:<span class="hljs-operator">/</span>root<span class="hljs-operator">/</span>.synctv&#x27;   <span class="hljs-comment"># 数据持久目录映射</span><br>  <span class="hljs-params">image:</span> synctvorg<span class="hljs-symbol">/synctv</span>    <span class="hljs-comment"># 镜像名，一般都是使用的哪个镜像就写哪个镜像</span><br></code></pre></td></tr></table></figure><h1 id="查看容器有没有起来"><a href="#查看容器有没有起来" class="headerlink" title="查看容器有没有起来"></a>查看容器有没有起来</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell">docker <span class="hljs-built_in">ps</span><br>或<br>docker<span class="hljs-literal">-compose</span> <span class="hljs-built_in">ps</span><br></code></pre></td></tr></table></figure><h1 id="默认账户密码"><a href="#默认账户密码" class="headerlink" title="默认账户密码"></a>默认账户密码</h1><p><code>账户：root 密码：root</code></p><h1 id="四、网站更新"><a href="#四、网站更新" class="headerlink" title="四、网站更新"></a>四、网站更新</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> synctv    <span class="hljs-comment"># 进入目录</span><br>docker-compose down     <span class="hljs-comment"># 停止容器</span><br>docker-compose pull     <span class="hljs-comment"># 拉取最新镜像</span><br>docekr-compose up -d    <span class="hljs-comment"># 重新启动容器</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>rustdesk远程控制 部署</title>
    <link href="/2025/11/06/rustdesk%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6-%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/rustdesk%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6-%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<p><a href="https://rustdesk.com/">rustdesk官网</a></p><h1 id="配置rustdesk配置yaml文件"><a href="#配置rustdesk配置yaml文件" class="headerlink" title="配置rustdesk配置yaml文件"></a>配置rustdesk配置yaml文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> rustdesk &amp;&amp; <span class="hljs-built_in">cd</span> rustdesk<br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> docker-compose.yaml<br></code></pre></td></tr></table></figure><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-params">version:</span> &#x27;<span class="hljs-number">3</span>&#x27;<br><br><span class="hljs-params">services:</span><br>  <span class="hljs-params">hbbs:</span><br>    <span class="hljs-params">container_name:</span> hbbs<br>    <span class="hljs-params">image:</span> rustdesk<span class="hljs-operator">/</span>rustdesk-server:<span class="hljs-number">1.0</span><br>    <span class="hljs-params">command:</span> hbbs<br>    <span class="hljs-params">volumes:</span><br>      <span class="hljs-operator">-</span> .<span class="hljs-operator">/</span>data:<span class="hljs-symbol">/root</span><br>    <span class="hljs-params">network_mode:</span> <span class="hljs-string">&quot;host&quot;</span><br><br>    <span class="hljs-params">depends_on:</span><br>      <span class="hljs-operator">-</span> hbbr<br>    <span class="hljs-params">restart:</span> unless-stopped<br><br><br>  <span class="hljs-params">hbbr:</span><br>    <span class="hljs-params">container_name:</span> hbbr<br>    <span class="hljs-params">image:</span> rustdesk<span class="hljs-operator">/</span>rustdesk-server:<span class="hljs-number">1.0</span><br>    <span class="hljs-params">command:</span> hbbr<br>    <span class="hljs-params">volumes:</span><br>      <span class="hljs-operator">-</span> .<span class="hljs-operator">/</span>data:<span class="hljs-symbol">/root</span><br>    <span class="hljs-params">network_mode:</span> <span class="hljs-string">&quot;host&quot;</span><br>    <span class="hljs-params">restart:</span> unless-stopped<br></code></pre></td></tr></table></figure><h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">docker-compose up -d</span><br></code></pre></td></tr></table></figure><h1 id="查看容器有没有起来"><a href="#查看容器有没有起来" class="headerlink" title="查看容器有没有起来"></a>查看容器有没有起来</h1><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">docker ps</span><br></code></pre></td></tr></table></figure><h1 id="在官网下载客户端"><a href="#在官网下载客户端" class="headerlink" title="在官网下载客户端"></a>在官网下载客户端</h1><p><a href="https://rustdesk.com/">rustdesk官网</a></p><h1 id="app设置"><a href="#app设置" class="headerlink" title="app设置"></a>app设置</h1><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs clean">点击左侧<span class="hljs-number">3</span>个点---&gt; 点击网络---&gt; 配置ID服务器---&gt; 配置中继服务器<br><br># 注：ID服务器/中继服务器是你 服务器的IP<br></code></pre></td></tr></table></figure><h1 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h1><p><code>用另一台手机/电脑，就可以连接了</code></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ChatGPT部署</title>
    <link href="/2025/11/06/ChatGPT%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/ChatGPT%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h1 id="免费使用ChatGPT，网页版部署"><a href="#免费使用ChatGPT，网页版部署" class="headerlink" title="免费使用ChatGPT，网页版部署"></a>免费使用ChatGPT，网页版部署</h1><ul><li>API官网：<a href="https://api1.chenjianming.fun/">https://api1.chenjianming.fun</a></li><li>GitHub官网：<a href="https://github.com/">https://github.com</a> </li><li>vercel官网：<a href="https://vercel.com/">https://vercel.com</a></li></ul><h1 id="登入github，点击搜索chat，点第二个项目"><a href="#登入github，点击搜索chat，点第二个项目" class="headerlink" title="登入github，点击搜索chat，点第二个项目"></a>登入github，点击搜索chat，点第二个项目</h1><p><a href="https://github.com/xubaodong0511/ChatGPT-Next-Web">https://github.com/xubaodong0511/ChatGPT-Next-Web</a></p><h1 id="点击Fork到自己仓库"><a href="#点击Fork到自己仓库" class="headerlink" title="点击Fork到自己仓库"></a>点击Fork到自己仓库</h1><p><a href="https://vercel.com/new/xubaodong0511s-projects">https://vercel.com/new/xubaodong0511s-projects</a></p><h1 id="打开网站vercel-com"><a href="#打开网站vercel-com" class="headerlink" title="打开网站vercel.com"></a>打开网站vercel.com</h1><ul><li>点击新建项目</li><li>可以看到刚刚Fork的仓库</li><li>点击import导入</li><li>重新构建一个项目名字，不然不会分配免费的域名</li><li>点击Environment Variables</li></ul><h1 id="Environment-Variables-环境变量-步骤—直接复制下面内容"><a href="#Environment-Variables-环境变量-步骤—直接复制下面内容" class="headerlink" title="Environment Variables(环境变量)步骤—直接复制下面内容"></a>Environment Variables(环境变量)步骤—直接复制下面内容</h1><ul><li>BASE_URL</li><li><a href="https://api1.chenjianming.fun/">https://api1.chenjianming.fun</a></li><li>点击add</li></ul><h1 id="创建令牌密钥步骤"><a href="#创建令牌密钥步骤" class="headerlink" title="创建令牌密钥步骤"></a>创建令牌密钥步骤</h1><ul><li><a href="https://api1.chenjianming.fun/">https://api1.chenjianming.fun</a></li><li>点击密钥，创建—-设置名称，永不过期，设为无限额度</li><li>提交</li><li>回到Environment Variables步骤</li><li>OPENAI_API_KEY</li><li>添加刚刚创建的令牌密钥</li><li>点击add</li></ul><h1 id="CODE添加密码步骤（可选）"><a href="#CODE添加密码步骤（可选）" class="headerlink" title="CODE添加密码步骤（可选）"></a>CODE添加密码步骤（可选）</h1><ul><li>CODE</li><li>自己设置一个密码</li><li>add</li></ul><p>以上步骤完成点击Deploy构建（大概需要3分钟）</p><h1 id="构建成功后会自动跳转"><a href="#构建成功后会自动跳转" class="headerlink" title="构建成功后会自动跳转"></a>构建成功后会自动跳转</h1><ul><li>点击头像</li><li>点击港创建的项目</li><li>点击Visit(可以访问了)</li></ul><h1 id="仓库地址"><a href="#仓库地址" class="headerlink" title="仓库地址"></a>仓库地址</h1><p><a href="https://vercel.com/xubaodong0511s-projects/qingfeng">https://vercel.com/xubaodong0511s-projects/qingfeng</a></p><h1 id="GPT地址"><a href="#GPT地址" class="headerlink" title="GPT地址"></a>GPT地址</h1><p><a href="https://qingfeng-sepia.vercel.app/">https://qingfeng-sepia.vercel.app/</a></p><h1 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h1><p>如果不能访问解决方案</p><ul><li><p>点击Settings(设置)</p></li><li><p>点击Domains(域名)</p></li><li><p>添加自己的域名</p></li><li><p>add—-需要添加两条记录</p></li><li><p>TXT记录</p><ul><li>在chenjianming.fun—-记录—-添加—-选择类型（TXT）—-名称（_vercel）—-内容（vc-domain-verify&#x3D;test.chenjianming.fun,0327a7d9f3fa0d8d135e）</li></ul></li><li><p>name记录</p><ul><li>类型（CNAME）—-名称（自己添加的域名名字）—-目标（cname.vercel-dns.com）</li></ul></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>k8s--web平台部署</title>
    <link href="/2025/11/06/k8s-web%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/k8s-web%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h1 id="查看集群有没有启动正常"><a href="#查看集群有没有启动正常" class="headerlink" title="查看集群有没有启动正常"></a>查看集群有没有启动正常</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl get node</span><br><br><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl get pod -A</span><br></code></pre></td></tr></table></figure><h1 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">mkdir k8s &amp;&amp;  cd k8s<br></code></pre></td></tr></table></figure><h1 id="下载官方yaml文件"><a href="#下载官方yaml文件" class="headerlink" title="下载官方yaml文件"></a>下载官方yaml文件</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml<br></code></pre></td></tr></table></figure><h1 id="查看并创建"><a href="#查看并创建" class="headerlink" title="查看并创建"></a>查看并创建</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># ls</span><br>recommended.yaml<br><br><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># vim recommended.yaml    </span><br>apiVersion: v1<br>kind: Namespace<br>metadata:<br>  name: kubernetes-dashboard<br><br>---<br><br>apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>  namespace: kubernetes-dashboard<br><br>---<br><br>kind: Service<br>apiVersion: v1<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>  namespace: kubernetes-dashboard<br>spec:<br>  type: NodePort             <span class="hljs-comment">#在原文件添加这一行</span><br>  ports:<br>    - port: 443<br>      targetPort: 8443<br>  selector:<br>    k8s-app: kubernetes-dashboard<br><br>---<br><br>apiVersion: v1<br>kind: Secret<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard-certs<br>  namespace: kubernetes-dashboard<br>type: Opaque<br><br>---<br><br>apiVersion: v1<br>kind: Secret<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard-csrf<br>  namespace: kubernetes-dashboard<br>type: Opaque<br>data:<br>  csrf: &quot;&quot;<br><br>---<br><br>apiVersion: v1<br>kind: Secret<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard-key-holder<br>  namespace: kubernetes-dashboard<br>type: Opaque<br><br>---<br><br>kind: ConfigMap<br>apiVersion: v1<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard-settings<br>  namespace: kubernetes-dashboard<br><br>---<br><br>kind: Role<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>  namespace: kubernetes-dashboard<br>rules:<br>  <span class="hljs-comment"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span><br>  - apiGroups: <span class="hljs-section">[&quot;&quot;]</span><br>    resources: <span class="hljs-section">[&quot;secrets&quot;]</span><br>    resourceNames: <span class="hljs-section">[&quot;kubernetes-dashboard-key-holder&quot;, &quot;kubernetes-dashboard-certs&quot;, &quot;kubernetes-dashboard-csrf&quot;]</span><br>    verbs: <span class="hljs-section">[&quot;get&quot;, &quot;update&quot;, &quot;delete&quot;]</span><br>    <span class="hljs-comment"># Allow Dashboard to get and update &#x27;kubernetes-dashboard-settings&#x27; config map.</span><br>  - apiGroups: <span class="hljs-section">[&quot;&quot;]</span><br>    resources: <span class="hljs-section">[&quot;configmaps&quot;]</span><br>    resourceNames: <span class="hljs-section">[&quot;kubernetes-dashboard-settings&quot;]</span><br>    verbs: <span class="hljs-section">[&quot;get&quot;, &quot;update&quot;]</span><br>    <span class="hljs-comment"># Allow Dashboard to get metrics.</span><br>  - apiGroups: <span class="hljs-section">[&quot;&quot;]</span><br>    resources: <span class="hljs-section">[&quot;services&quot;]</span><br>    resourceNames: <span class="hljs-section">[&quot;heapster&quot;, &quot;dashboard-metrics-scraper&quot;]</span><br>    verbs: <span class="hljs-section">[&quot;proxy&quot;]</span><br>  - apiGroups: <span class="hljs-section">[&quot;&quot;]</span><br>    resources: <span class="hljs-section">[&quot;services/proxy&quot;]</span><br>    resourceNames: <span class="hljs-section">[&quot;heapster&quot;, &quot;http:heapster:&quot;, &quot;https:heapster:&quot;, &quot;dashboard-metrics-scraper&quot;, &quot;http:dashboard-metrics-scraper&quot;]</span><br>    verbs: <span class="hljs-section">[&quot;get&quot;]</span><br><br>---<br><br>kind: ClusterRole<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>rules:<br>  <span class="hljs-comment"># Allow Metrics Scraper to get metrics from the Metrics server</span><br>  - apiGroups: <span class="hljs-section">[&quot;metrics.k8s.io&quot;]</span><br>    resources: <span class="hljs-section">[&quot;pods&quot;, &quot;nodes&quot;]</span><br>    verbs: <span class="hljs-section">[&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><br>---<br><br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: RoleBinding<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>  namespace: kubernetes-dashboard<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: Role<br>  name: kubernetes-dashboard<br>subjects:<br>  - kind: ServiceAccount<br>    name: kubernetes-dashboard<br>    namespace: kubernetes-dashboard<br><br>---<br><br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: kubernetes-dashboard<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: kubernetes-dashboard<br>subjects:<br>  - kind: ServiceAccount<br>    name: kubernetes-dashboard<br>    namespace: kubernetes-dashboard<br><br>---<br><br>kind: Deployment<br>apiVersion: apps/v1<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: kubernetes-dashboard<br>  namespace: kubernetes-dashboard<br>spec:<br>  replicas: 1<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: kubernetes-dashboard<br>    spec:<br>      securityContext:<br>        seccompProfile:<br>          type: RuntimeDefault<br>      containers:<br>        - name: kubernetes-dashboard<br>          image: kubernetesui/dashboard:v2.7.0<br>          imagePullPolicy: Always<br>          ports:<br>            - containerPort: 8443<br>              protocol: TCP<br>          args:<br>            - --auto-generate-certificates<br>            - <span class="hljs-attr">--namespace</span>=kubernetes-dashboard<br>            <span class="hljs-comment"># Uncomment the following line to manually specify Kubernetes API server Host</span><br>            <span class="hljs-comment"># If not specified, Dashboard will attempt to auto discover the API server and connect</span><br>            <span class="hljs-comment"># to it. Uncomment only if the default does not work.</span><br>            <span class="hljs-comment"># - --apiserver-host=http://my-address:port</span><br>          volumeMounts:<br>            - name: kubernetes-dashboard-certs<br>              mountPath: /certs<br>              <span class="hljs-comment"># Create on-disk volume to store exec logs</span><br>            - mountPath: /tmp<br>              name: tmp-volume<br>          livenessProbe:<br>            httpGet:<br>              scheme: HTTPS<br>              path: /<br>              port: 8443<br>            initialDelaySeconds: 30<br>            timeoutSeconds: 30<br>          securityContext:<br>            allowPrivilegeEscalation: false<br>            readOnlyRootFilesystem: true<br>            runAsUser: 1001<br>            runAsGroup: 2001<br>      volumes:<br>        - name: kubernetes-dashboard-certs<br>          secret:<br>            secretName: kubernetes-dashboard-certs<br>        - name: tmp-volume<br>          emptyDir: &#123;&#125;<br>      serviceAccountName: kubernetes-dashboard<br>      nodeSelector:<br>        &quot;kubernetes.io/os&quot;: linux<br>      <span class="hljs-comment"># Comment the following tolerations if Dashboard must not be deployed on master</span><br>      tolerations:<br>        - key: node-role.kubernetes.io/master<br>          effect: NoSchedule<br>---<br><br>kind: Service<br>apiVersion: v1<br>metadata:<br>  labels:<br>    k8s-app: dashboard-metrics-scraper<br>  name: dashboard-metrics-scraper<br>  namespace: kubernetes-dashboard<br>spec:<br>  ports:<br>    - port: 8000<br>      targetPort: 8000<br>  selector:<br>    k8s-app: dashboard-metrics-scraper<br><br>---<br><br>kind: Deployment<br>apiVersion: apps/v1<br>metadata:<br>  labels:<br>    k8s-app: dashboard-metrics-scraper<br>  name: dashboard-metrics-scraper<br>  namespace: kubernetes-dashboard<br>spec:<br>  replicas: 1<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>      k8s-app: dashboard-metrics-scraper<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: dashboard-metrics-scraper<br>    spec:<br>      securityContext:<br>        seccompProfile:<br>          type: RuntimeDefault<br>      containers:<br>        - name: dashboard-metrics-scraper<br>          image: kubernetesui/metrics-scraper:v1.0.8<br>          ports:<br>            - containerPort: 8000<br>              protocol: TCP<br>          livenessProbe:<br>            httpGet:<br>              scheme: HTTP<br>              path: /<br>              port: 8000<br>            initialDelaySeconds: 30<br>            timeoutSeconds: 30<br>          volumeMounts:<br>          - mountPath: /tmp<br>            name: tmp-volume<br>          securityContext:<br>            allowPrivilegeEscalation: false<br>            readOnlyRootFilesystem: true<br>            runAsUser: 1001<br>            runAsGroup: 2001<br>      serviceAccountName: kubernetes-dashboard<br>      nodeSelector:<br>        &quot;kubernetes.io/os&quot;: linux<br>      <span class="hljs-comment"># Comment the following tolerations if Dashboard must not be deployed on master</span><br>      tolerations:<br>        - key: node-role.kubernetes.io/master<br>          effect: NoSchedule<br>      volumes:<br>        - name: tmp-volume<br>          emptyDir: &#123;&#125;<br><br><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl apply -f recommended.yaml </span><br></code></pre></td></tr></table></figure><h1 id="验证有没有起来"><a href="#验证有没有起来" class="headerlink" title="验证有没有起来"></a>验证有没有起来</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl get po -n kubernetes-dashboard</span><br>NAME                                         READY   STATUS    RESTARTS   AGE<br>dashboard-metrics-scraper-7c857855d9-wl4md   1/1     Running   0          41s<br>kubernetes-dashboard-658b66597c-n7dq6        1/1     Running   0          41s<br><br><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl get svc -n kubernetes-dashboard</span><br>NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE<br>dashboard-metrics-scraper   ClusterIP   10.105.21.218    &lt;none&gt;        8000/TCP        69s<br>kubernetes-dashboard        NodePort    10.105.252.141   &lt;none&gt;        443:32129/TCP   69s<br></code></pre></td></tr></table></figure><h1 id="此时可以登入web查看了"><a href="#此时可以登入web查看了" class="headerlink" title="此时可以登入web查看了"></a>此时可以登入web查看了</h1><p><code>IP地址 + 32129</code></p><p><code>这里的32129端口是体统映射的，具体是多少用get svc验证查看</code></p><h1 id="创建admin的key，登入web用"><a href="#创建admin的key，登入web用" class="headerlink" title="创建admin的key，登入web用"></a>创建admin的key，登入web用</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># cat dashoard-admin.yaml</span><br>apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-dashboard<br>  name: dashboard-admin<br>  namespace: kubernetes-dashboard<br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: dashboard-admin-cluster-role<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: cluster-admin<br>subjects:<br>  - kind: ServiceAccount<br>    name: dashboard-admin<br>    namespace: kubernetes-dashboard<br><br><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl apply -f dashoard-admin.yaml </span><br>serviceaccount/dashboard-admin unchanged<br>clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin-cluster-role created<br><br><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl get sa -n kubernetes-dashboard</span><br>NAME                   SECRETS   AGE<br>dashboard-admin        1         112s<br>default                1         14m<br>kubernetes-dashboard   1         14m<br><br><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl describe sa dashboard-admin -n kubernetes-dashboard</span><br>Name:                dashboard-admin<br>Namespace:           kubernetes-dashboard<br>Labels:              <span class="hljs-attr">k8s-app</span>=kubernetes-dashboard<br>Annotations:         &lt;none&gt;<br>Image pull secrets:  &lt;none&gt;<br>Mountable secrets:   dashboard-admin-token-7k482<span class="hljs-comment">#这个就是token</span><br>Tokens:              dashboard-admin-token-7k482<br>Events:              &lt;none&gt;<br><br><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl get secrets  -n kubernetes-dashboard</span><br>NAME                               TYPE                                  DATA   AGE<br>dashboard-admin-token-7k482        kubernetes.io/service-account-token   3      3m12s<br>default-token-gwp54                kubernetes.io/service-account-token   3      15m<br>kubernetes-dashboard-certs         Opaque                                0      15m<br>kubernetes-dashboard-csrf          Opaque                                1      15m<br>kubernetes-dashboard-key-holder    Opaque                                2      15m<br>kubernetes-dashboard-token-28xhj   kubernetes.io/service-account-token   3      15m<br><br><span class="hljs-comment"># 查看token</span><br><span class="hljs-section">[root@k8s-1 k8s]</span><span class="hljs-comment"># kubectl describe secrets dashboard-admin-token-7k482 -n kubernetes-dashboard</span><br>Name:         dashboard-admin-token-7k482<br>Namespace:    kubernetes-dashboard<br>Labels:       &lt;none&gt;<br>Annotations:  kubernetes.io/service-account.name: dashboard-admin<br>              kubernetes.io/service-account.uid: 04eda024-fc6c-4ae9-b949-7eb4f54b97f5<br><br>Type:  kubernetes.io/service-account-token<br><br><span class="hljs-attr">Data</span><br>====<br>ca.crt:     1099 bytes<br>namespace:  20 bytes<br>token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImRiWndwem04N2RmUXVOeFRjQ0ktSzI1azAzVUtwVXdRVkJGc0d1eVptRUUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tN2s0ODIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMDRlZGEwMjQtZmM2Yy00YWU5LWI5NDktN2ViNGY1NGI5N2Y1Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.eYnDkdG-VnshjgvBM5oiDEhQH2J3nKKc4Qud7hGpmt_bbcQUeaytpkvLWQY-kXu_kTaMXgZqhqTVHy0LaBsSURvTrJWL51d38EZE_5XOVj5JqlnWrmQaK9c7bJ9GmQ6BvCKHanIQNHizHQR6vHyDuJ9BkvuL2ZrXY-_OqgVwPUoN8c41BdF5iDqdYNLgILeTRi11nde4cnVgJIdzfpZZ7sPsYaNwnrgcSeQxQJPuPMrtn-TcXubyzVRdfFLWynf3_5ItJGqL8JS7oUc4Sv41Lmu90ofiehcyS-4KZ1jP16s_LdoY_7_j2Slg7urP34Vv3JmnyIryoPYNdx-1Nubq4Q<br><span class="hljs-comment"># 复制token到web界面登入就可以进入页面了</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>K8s 公网部署（错误修改）</title>
    <link href="/2025/11/06/K8s-%E5%85%AC%E7%BD%91%E9%83%A8%E7%BD%B2%EF%BC%88%E9%94%99%E8%AF%AF%E4%BF%AE%E6%94%B9%EF%BC%89/"/>
    <url>/2025/11/06/K8s-%E5%85%AC%E7%BD%91%E9%83%A8%E7%BD%B2%EF%BC%88%E9%94%99%E8%AF%AF%E4%BF%AE%E6%94%B9%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h1 id="k8s公网部署"><a href="#k8s公网部署" class="headerlink" title="k8s公网部署"></a>k8s公网部署</h1><p><strong>翻新之前的文章</strong><br><a href="https://7boe.top/archives/187">写的很乱的，多种安装方式</a></p><blockquote><p>本次实验使用三台机器在不同地区进行部署，实验环境使用到香港服务器和杭州阿里云服务器，公网环境部署网络稳定性不能得到保证，本文部署方式仅供参考。</p></blockquote><h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p><strong>环境</strong></p><table><thead><tr><th>软件</th><th>软件版本</th></tr></thead><tbody><tr><td>Docker</td><td>20.0.1</td></tr><tr><td>Kubernetes</td><td>1.23.6</td></tr></tbody></table><p><strong>服务器规划</strong></p><table><thead><tr><th>服务器主机名</th><th>服务器公网IP</th></tr></thead><tbody><tr><td>master</td><td>149.104.23.134</td></tr><tr><td>node1</td><td>121.41.53.83</td></tr><tr><td>node2</td><td>116.62.32.149</td></tr></tbody></table><hr><p><strong>解析hosts</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt;&gt; /etc/hosts &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">149.104.23.134 master</span><br><span class="hljs-string">121.41.53.83 node1</span><br><span class="hljs-string">116.62.32.149 node2</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><p><strong>执行初始化脚本</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -sSl https://git.7boe.top/root/Shell/-/raw/af8fc85f5d15181942fc791305dc64e94c32c36e/k8s.sh?inline=<span class="hljs-literal">false</span>)<br></code></pre></td></tr></table></figure><h3 id="Docker安装"><a href="#Docker安装" class="headerlink" title="Docker安装"></a>Docker安装</h3><p><strong>安装软件导入docker官方源</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">yum install -y yum-utils <br>yum-config-manager --<span class="hljs-keyword">add</span>-repo http:<span class="hljs-comment">//mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></code></pre></td></tr></table></figure><p><strong>使用docker20版本</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">sudo yum install docker-ce<span class="hljs-number">-20.10</span><span class="hljs-number">.14</span><span class="hljs-number">-3.</span>el7 docker-ce-cli<span class="hljs-number">-20.10</span><span class="hljs-number">.14</span><span class="hljs-number">-3.</span>el7 containerd.<span class="hljs-built_in">io</span> docker-compose-plugin<br></code></pre></td></tr></table></figure><p><strong>其他版本有部分差异，可能会出奇怪问题。</strong><br><strong>换docker镜像源</strong></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs javascript">cat &lt;&lt;<span class="hljs-variable constant_">EOF</span> &gt; <span class="hljs-regexp">/etc/</span>docker/daemon.<span class="hljs-property">json</span><br>&#123;<br>    <span class="hljs-string">&quot;registry-mirrors&quot;</span>: [<br>        <span class="hljs-string">&quot;http://hub-mirror.c.163.com&quot;</span>,<br>        <span class="hljs-string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<br>        <span class="hljs-string">&quot;https://registry.docker-cn.com&quot;</span><br>    ],<br>    <span class="hljs-string">&quot;exec-opts&quot;</span>: [<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>]<br>&#125;<br><span class="hljs-variable constant_">EOF</span><br></code></pre></td></tr></table></figure><p><strong>设置开机自启</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl <span class="hljs-built_in">enable</span> docker &amp;&amp; systemctl status docker <br></code></pre></td></tr></table></figure><blockquote><p>这里没有安装cri,因为k8s1.23版本还在提供docker作为容器运行</p></blockquote><p><strong>确认这里一定是systemd</strong></p><blockquote><p>因为k8s是默认systemd作为cgroup driver，如果Docker使用另外的驱动，则可能出现不稳定的情况。</p></blockquote><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">docker info | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;Cgroup Driver&quot;</span><br></code></pre></td></tr></table></figure><h3 id="安装k8s"><a href="#安装k8s" class="headerlink" title="安装k8s"></a>安装k8s</h3><p><strong>k8s导入源使用阿里云的源</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs makefile">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF<br>[kubernetes]<br>name=Kubernetes<br>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64<br>enabled=1<br>gpgcheck=0<br>repo_gpgcheck=0<br>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg<br>EOF<br></code></pre></td></tr></table></figure><p><strong>安装k8s</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">sudo yum install -y kubelet<span class="hljs-number">-1.23</span><span class="hljs-number">.6</span> kubeadm<span class="hljs-number">-1.23</span><span class="hljs-number">.6</span> kubectl<span class="hljs-number">-1.23</span><span class="hljs-number">.6</span> <span class="hljs-comment">--disableexcludes=kubernetes</span><br></code></pre></td></tr></table></figure><p><strong>开机自启</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">systemctl <span class="hljs-built_in">enable</span> kubelet &amp;&amp; systemctl start kubelet &amp;&amp; systemctl status kubelet<br></code></pre></td></tr></table></figure><p><strong>拉取镜像</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">kubeadm <span class="hljs-built_in">config</span> images pull <span class="hljs-comment">--kubernetes-version=v1.23.6 --image-repository registry.aliyuncs.com/google_containers</span><br></code></pre></td></tr></table></figure><p><strong>也可以使用配置文件拉取</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">vim kubeadm-<span class="hljs-built_in">config</span>-image.yaml<br></code></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-section">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class="hljs-section">kind: ClusterConfiguration</span><br><span class="hljs-section">imageRepository: registry.aliyuncs.com/google_containers </span><br></code></pre></td></tr></table></figure><p><strong>拉取</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">kubeadm <span class="hljs-built_in">config</span> images pull <span class="hljs-comment">--config kubeadm-config-image.yaml</span><br></code></pre></td></tr></table></figure><h3 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h3><blockquote><p>之前这里是最头疼的地方，如果是一个内网里面直接就好了，但是公网的话直接写公网ip他就一直报错，提示找不到这个ip，应为阿里云服务器网卡没有绑定公网ip，eth0写的是内网vpc专业网络内网ip，采用的自动对外映射公网方式。</p></blockquote><p><strong>这样初始化要变通一下</strong><br>先生成一个配置文件</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">kubeadm <span class="hljs-built_in">config</span> <span class="hljs-built_in">print</span> init-defaults &gt; kubeadm-<span class="hljs-built_in">config</span>.yaml<br></code></pre></td></tr></table></figure><ul><li>pod-network-cidr：pod资源的网段，需与pod网络插件的值设置一致。通常，Flannel网络插件的默认为10.244.0.0&#x2F;16，Calico插件的默认值为192.168.0.0&#x2F;16；</li><li>api-server：使用Master作为api-server，所以就是master机器的IP地址。</li><li>image-repository：拉取镜像的镜像仓库，默认是k8s.gcr.io。</li><li>nodeRegistration.name：改成master</li></ul><p>更改配置文件</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeadm.k8s.io/v1beta3</span><br><span class="hljs-attr">bootstrapTokens:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">groups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">system:bootstrappers:kubeadm:default-node-token</span><br>  <span class="hljs-attr">token:</span> <span class="hljs-string">abcdef.0123456789abcdef</span><br>  <span class="hljs-attr">ttl:</span> <span class="hljs-string">24h0m0s</span><br>  <span class="hljs-attr">usages:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">signing</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">authentication</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">InitConfiguration</span><br><span class="hljs-attr">localAPIEndpoint:</span><br>  <span class="hljs-attr">advertiseAddress:</span> <span class="hljs-number">149.104</span><span class="hljs-number">.23</span><span class="hljs-number">.134</span> <span class="hljs-comment">#这样改成master的公网ip</span><br>  <span class="hljs-attr">bindPort:</span> <span class="hljs-number">6443</span><br><span class="hljs-attr">nodeRegistration:</span><br>  <span class="hljs-attr">criSocket:</span> <span class="hljs-string">/var/run/dockershim.sock</span><br>  <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">master</span>  <span class="hljs-comment">#这样要改成解析的主机名</span><br>  <span class="hljs-attr">taints:</span> <span class="hljs-literal">null</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiServer:</span><br>  <span class="hljs-attr">timeoutForControlPlane:</span> <span class="hljs-string">4m0s</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubeadm.k8s.io/v1beta3</span><br><span class="hljs-attr">certificatesDir:</span> <span class="hljs-string">/etc/kubernetes/pki</span><br><span class="hljs-attr">clusterName:</span> <span class="hljs-string">kubernetes</span><br><span class="hljs-attr">controllerManager:</span> &#123;&#125;<br><span class="hljs-attr">dns:</span> &#123;&#125;<br><span class="hljs-attr">etcd:</span><br>  <span class="hljs-attr">local:</span><br>    <span class="hljs-attr">dataDir:</span> <span class="hljs-string">/var/lib/etcd</span><br><span class="hljs-attr">imageRepository:</span> <span class="hljs-string">registry.aliyuncs.com/google_containers</span> <span class="hljs-comment">#一定要改</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterConfiguration</span><br><span class="hljs-attr">kubernetesVersion:</span> <span class="hljs-number">1.23</span><span class="hljs-number">.6</span> <span class="hljs-comment">#确认版本号</span><br><span class="hljs-attr">networking:</span><br>  <span class="hljs-attr">dnsDomain:</span> <span class="hljs-string">cluster.local</span><br>  <span class="hljs-attr">serviceSubnet:</span> <span class="hljs-number">10.96</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/12</span><br>  <span class="hljs-attr">podSubnet:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span><span class="hljs-string">/16</span>  <span class="hljs-comment">#方便安装网络插件</span><br><span class="hljs-attr">scheduler:</span> &#123;&#125;<br></code></pre></td></tr></table></figure><p><strong>检查环境是否支持</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs csharp">kubeadm <span class="hljs-keyword">init</span> phase preflight --config=kubeadm-config.yaml <br>kubeadm <span class="hljs-keyword">init</span> --config=kubeadm-config.yaml<br></code></pre></td></tr></table></figure><blockquote><p>这里基本是初始化必失败的<br>到这里，会有2种结果：<br>如果是内网，上面的docker版本，kubeadm版本没错的话，会成功.<br>如果在云服务器（腾讯云，阿里云）上，一定会失败（原因和办法在这里）：</p></blockquote><h3 id="云服务器初始化失败"><a href="#云服务器初始化失败" class="headerlink" title="云服务器初始化失败"></a>云服务器初始化失败</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sql">[kubelet<span class="hljs-operator">-</span><span class="hljs-keyword">check</span>] <span class="hljs-keyword">Initial</span> timeout <span class="hljs-keyword">of</span> <span class="hljs-number">40</span>s passed.<br></code></pre></td></tr></table></figure><blockquote><p>卡在这里应为他找不到你设定的apiserver IP地址<br>但是你必须要初始化，目的是为了生成k8s的配置文件，否则下面的步骤中你会找不到etcd.yaml），失败后再执行下面的步骤！！</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /etc/kubernetes/manifests/etcd.yaml<br></code></pre></td></tr></table></figure><p>更改以下配置，<a href="https://blog.51cto.com/u_15152259/2690063">来源文章</a>。</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">- --<span class="hljs-keyword">listen</span>-client-urls=https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">2379</span>,https:<span class="hljs-regexp">//</span><span class="hljs-number">101.34</span><span class="hljs-number">.112</span><span class="hljs-number">.190</span>:<span class="hljs-number">2379</span><br>- --<span class="hljs-keyword">listen</span>-peer-urls=https:<span class="hljs-regexp">//</span><span class="hljs-number">101.34</span><span class="hljs-number">.112</span><span class="hljs-number">.190</span>:<span class="hljs-number">2380</span><br></code></pre></td></tr></table></figure><p><strong>改成</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">- --<span class="hljs-keyword">listen</span>-client-urls=https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">2379</span><br>- --<span class="hljs-keyword">listen</span>-peer-urls=https:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">2380</span><br></code></pre></td></tr></table></figure><p><strong>因为上方的地址他监听不到，要改成本地</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">systemctl stop kubelet <br>netstat -anp |<span class="hljs-keyword">grep</span> kube<br></code></pre></td></tr></table></figure><blockquote><p>请注意，不要执行 kubeadm reset，先 systemctl stop kubelet ，然后手动通过 netstat -anp |grep kube 来找pid，再通过 kill -9 pid 强杀。否则又会生成错误的etcd配置文件，这里非常关键！！！</p></blockquote><p><strong>重新初始化，但是跳过etcd文件已经存在的检查：</strong></p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-meta"># 重新启动kubelet</span><br>systemctl start kubelet<br>重新初始化，跳过配置文件生成环节，不要etcd的修改要被覆盖掉<br>kubeadm <span class="hljs-keyword">init</span> --config=kubeadm-config.yaml --skip-phases=preflight,certs,kubeconfig,kubelet-start,control-plane,etcd<br></code></pre></td></tr></table></figure><h3 id="成功初始化"><a href="#成功初始化" class="headerlink" title="成功初始化"></a>成功初始化</h3><p>如果所有配置都正常，很快会输出下面的信息（秒级别）代表了成功，否则大概率是失败（由于网络超时等）：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">Your Kubernetes control-plane has initialized successfully!<br><br>To start using your cluster, you need to run the following as a regular user:<br><br>  <span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br>  <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br>  <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br><br>Alternatively, <span class="hljs-keyword">if</span> you are the root user, you can run:<br><br>  <span class="hljs-built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf<br><br>You should now deploy a pod network to the cluster.<br>Run <span class="hljs-string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:<br>  https://kubernetes.io/docs/concepts/cluster-administration/addons/<br><br>Then you can <span class="hljs-built_in">join</span> any number of worker nodes by running the following on each as root:<br>加入k8s 命令<br></code></pre></td></tr></table></figure><p><strong>后面命令要是没了用这个，生成一个新的</strong></p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lua">kubeadm token <span class="hljs-built_in">create</span> <span class="hljs-comment">--print-join-command</span><br></code></pre></td></tr></table></figure><p><strong>token忘记</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs undefined">kubeadm token list<br></code></pre></td></tr></table></figure><p><strong>每一个节点都执行的话都可以操作kubectl,文件要scp过去</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$HOME</span>/.kube<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="hljs-variable">$HOME</span>/.kube/config<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chown</span> $(<span class="hljs-built_in">id</span> -u):$(<span class="hljs-built_in">id</span> -g) <span class="hljs-variable">$HOME</span>/.kube/config<br></code></pre></td></tr></table></figure><h2 id="安装网络插件"><a href="#安装网络插件" class="headerlink" title="安装网络插件"></a>安装网络插件</h2><h3 id="calico"><a href="#calico" class="headerlink" title="calico"></a>calico</h3><p><strong>查看官网文档，看对应版本</strong></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/docs.tigera.io/calico</span><span class="hljs-regexp">/3.25/getting</span>-started/kubernetes/<span class="hljs-variable language_">self</span>-managed-onprem/onpremises<br></code></pre></td></tr></table></figure><p><strong>3.25目前支持1.23的k8s</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">https://docs.tigera.io/calico/3.25/getting-started/kubernetes/requirements<br></code></pre></td></tr></table></figure><p><strong>安装</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml <br></code></pre></td></tr></table></figure><h3 id="flannel"><a href="#flannel" class="headerlink" title="flannel"></a>flannel</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">如果您使用自定义podCIDR（不是<span class="hljs-number">10.244</span>.<span class="hljs-number">0.0</span>/<span class="hljs-number">16</span>），您首先需要下载上述清单并修改网络以匹配您的网络。<br>kubectl apply -f https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/flannel-io/</span>flannel<span class="hljs-regexp">/releases/</span>latest<span class="hljs-regexp">/download/</span>kube-flannel.yml<br></code></pre></td></tr></table></figure><h2 id="允许master节点部署pod"><a href="#允许master节点部署pod" class="headerlink" title="允许master节点部署pod"></a>允许master节点部署pod</h2><p><strong>调度策略</strong></p><ul><li>NoSchedule: 一定不能被调度</li><li>PreferNoSchedule: 尽量不要调度</li><li>NoExecute: 不仅不会调度, 还会驱逐Node上已有的Pod</li></ul><p><strong>查看当前调度策略</strong></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl describe node|<span class="hljs-keyword">grep</span> -E <span class="hljs-string">&quot;Name:|Taints:&quot;</span><br></code></pre></td></tr></table></figure><p><strong>更改master节点可被部署pod</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl taint nodes --all node-role.kubernetes.io/master-<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>jenkins流水线发布项目到K8S集群实现CI/CD</title>
    <link href="/2025/11/06/jenkins%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%8F%91%E5%B8%83%E9%A1%B9%E7%9B%AE%E5%88%B0K8S%E9%9B%86%E7%BE%A4%E5%AE%9E%E7%8E%B0CI-CD/"/>
    <url>/2025/11/06/jenkins%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%8F%91%E5%B8%83%E9%A1%B9%E7%9B%AE%E5%88%B0K8S%E9%9B%86%E7%BE%A4%E5%AE%9E%E7%8E%B0CI-CD/</url>
    
    <content type="html"><![CDATA[<p>jenkins流水线发布项目到K8S集群实现CI&#x2F;CD</p><h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl">systemctl stop firewalld  &amp;&amp; setenforce <span class="hljs-number">0</span><br><br><span class="hljs-number">10.31</span><span class="hljs-number">.162</span><span class="hljs-number">.133</span>master<br><span class="hljs-number">10.31</span><span class="hljs-number">.162</span><span class="hljs-number">.134</span>node-<span class="hljs-number">1</span><br><span class="hljs-number">10.31</span><span class="hljs-number">.162</span><span class="hljs-number">.135</span>node2<br><span class="hljs-number">10.31</span><span class="hljs-number">.162</span><span class="hljs-number">.124</span>harbor<br><span class="hljs-number">10.31</span><span class="hljs-number">.162</span><span class="hljs-number">.35</span>  jenkins/git------&gt;充当开发角色模拟提交代码到gitlab<br>git仓库我们这里使用gitee代替gitlab<br></code></pre></td></tr></table></figure><h1 id="配置jenkins服务器"><a href="#配置jenkins服务器" class="headerlink" title="配置jenkins服务器"></a>配置jenkins服务器</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-number">1</span>.安装git客户端与docker<br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># yum install -y git</span><br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># yum install -y yum-utils device-mapper-persistent-data lvm2 git</span><br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># yum install -y docker</span><br>启动并设置开机启动<br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># systemctl start docker &amp;&amp; systemctl enable docker</span><br><br><span class="hljs-number">2</span>.安装jenkins---略<br><br><span class="hljs-number">3</span>.jenkins页面上额外安装插件<br>docker 和pipeline 插件<br></code></pre></td></tr></table></figure><h1 id="登入10-31-162-35-8080-jenkins安装插件"><a href="#登入10-31-162-35-8080-jenkins安装插件" class="headerlink" title="登入10.31.162.35:8080&#x2F;jenkins安装插件"></a>登入10.31.162.35:8080&#x2F;jenkins安装插件</h1><p><img src="/upload/K8S-CICD1.webp" alt="K8S-CICD1.webp"></p><h1 id="指定docker环境"><a href="#指定docker环境" class="headerlink" title="指定docker环境"></a>指定docker环境</h1><p><img src="/upload/K8S-CICD2.webp" alt="K8S-CICD1.webp"></p><h1 id="由于jenkins最后要将生成的镜像上传到harbor仓库，需要在jenkins上面配置登陆harbor仓库"><a href="#由于jenkins最后要将生成的镜像上传到harbor仓库，需要在jenkins上面配置登陆harbor仓库" class="headerlink" title="由于jenkins最后要将生成的镜像上传到harbor仓库，需要在jenkins上面配置登陆harbor仓库"></a>由于jenkins最后要将生成的镜像上传到harbor仓库，需要在jenkins上面配置登陆harbor仓库</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># cat /etc/docker/daemon.json</span><br>&#123;<br><span class="hljs-string">&quot;exec-opts&quot;</span>:[<span class="hljs-string">&quot;native.cgroupdriver=systemd&quot;</span>],<br><span class="hljs-string">&quot;insecure-registries&quot;</span>: [<span class="hljs-string">&quot;10.31.162.124&quot;</span>]<span class="hljs-comment">#添加hatbor仓库</span><br>&#125;<br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># systemctl restart docker </span><br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># docker login -u admin -p Harbor12345 10.31.162.124  #测试</span><br>Login Succeeded<br></code></pre></td></tr></table></figure><h1 id="登陆harbor创建相应项目的仓库"><a href="#登陆harbor创建相应项目的仓库" class="headerlink" title="登陆harbor创建相应项目的仓库"></a>登陆harbor创建相应项目的仓库</h1><p><img src="/upload/K8S-CICD3.webp" alt="K8S-CICD1.webp"></p><p><img src="/upload/K8S-CICD4.webp" alt="K8S-CICD1.webp"></p><h1 id="更新代码仓库"><a href="#更新代码仓库" class="headerlink" title="更新代码仓库"></a>更新代码仓库</h1><p><img src="/upload/K8S-CICD5.webp" alt="K8S-CICD1.webp"></p><h1 id="在git服务器上面创建公钥和私钥，将公钥上传到gitee"><a href="#在git服务器上面创建公钥和私钥，将公钥上传到gitee" class="headerlink" title="在git服务器上面创建公钥和私钥，将公钥上传到gitee"></a>在git服务器上面创建公钥和私钥，将公钥上传到gitee</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># ssh-keygen</span><br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># cd .ssh/</span><br>[root<span class="hljs-variable">@jenkins</span>-server .ssh]<span class="hljs-comment"># ls</span><br>id_rsa  id_rsa.pub  known_hosts<br>[root<span class="hljs-variable">@jenkins</span>-server .ssh]<span class="hljs-comment"># cat id_rsa.pub </span><br>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6rVm2pdguGz+Y72JRBk/lpbh3jfqriNWqv3QlP6iVP+tUTRZiGB5pcjCC8cHg6w64XPj4xRpQcj+Aviq7ORSuPGSk5hCMz9O7/wUMJsP4uVIvm5P/rwQBppdS3+qGE6COkhHdEY+GcjpLFVG2mW+ksQe3W2bvBKe7msNpqgUtQs+z99UXf9LlnGUCrRF/oddPSgq3tJDXZoYzdEb3a7bZDf3j72XOYubX0fcygS1fG615+xnJP9knfoKkr4YSZkxj25TwPEO5JToPtr4tcOpJRqBA7KrookicuiWeIe7J91mRVH1tx9GWnPMMyXqsy0LcyV2rUUhG4c71W0mEfLzn root<span class="hljs-variable">@jenkins</span>-server<br></code></pre></td></tr></table></figure><p><img src="/upload/K8S-CICD6.webp" alt="K8S-CICD1.webp"></p><p><img src="/upload/K8S-CICD7.webp" alt="K8S-CICD1.webp"></p><h1 id="将创建好的仓库克隆到本地"><a href="#将创建好的仓库克隆到本地" class="headerlink" title="将创建好的仓库克隆到本地"></a>将创建好的仓库克隆到本地</h1><p><img src="/upload/K8S-CICD8.webp" alt="K8S-CICD1.webp"></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># git clone git@gitee.com:testpm/javaweb.git</span><br>Cloning into <span class="hljs-string">&#x27;javaweb&#x27;</span>...<br>warning: You appear to have cloned an empty repository.<br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># ls</span><br>javaweb<br><br>克隆测试代码，将测试代码上传到gitlab<br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># git clone https://github.com/bingyue/easy-springmvc-maven</span><br>[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># cd easy-springmvc-maven/</span><br>[root<span class="hljs-variable">@jenkins</span>-server easy-springmvc-maven]<span class="hljs-comment"># ls</span><br>pom.xml  README.md  src<br>[root<span class="hljs-variable">@jenkins</span>-server easy-springmvc-maven]<span class="hljs-comment"># cp -r * /root/javaweb/</span><br>[root<span class="hljs-variable">@jenkins</span>-server easy-springmvc-maven]<span class="hljs-comment"># ls /root/javaweb/</span><br>pom.xml  README.md  src<br><br>将代码上传到公司的远程仓库<br>[root<span class="hljs-variable">@jenkins</span>-server easy-springmvc-maven]<span class="hljs-comment"># cd /root/javaweb/</span><br>[root<span class="hljs-variable">@jenkins</span>-server javaweb]<span class="hljs-comment"># git add .</span><br>[root<span class="hljs-variable">@jenkins</span>-server javaweb]<span class="hljs-comment"># git commit -m &quot;1.0&quot;</span><br>[root<span class="hljs-variable">@jenkins</span>-server javaweb]<span class="hljs-comment"># git push origin master</span><br></code></pre></td></tr></table></figure><p><img src="/upload/K8S-CICD9.webp" alt="K8S-CICD9.webp"></p><h1 id="编写dockerfile上传仓库"><a href="#编写dockerfile上传仓库" class="headerlink" title="编写dockerfile上传仓库"></a>编写dockerfile上传仓库</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs perl">编写dockerfile用于生成镜像<br>[root<span class="hljs-variable">@jenkins</span>-server javaweb]<span class="hljs-comment"># cat Dockerfile </span><br>From daocloud.io/library/tomcat:<span class="hljs-number">8.0</span><span class="hljs-number">.45</span><br>RUN rm -rf /usr/<span class="hljs-keyword">local</span>/tomcat/webapps/*<br>ADD ./target/easy-springmvc-maven.war /usr/<span class="hljs-keyword">local</span>/tomcat/webapps/<br>EXPOSE <span class="hljs-number">8080</span><br>ENTRYPOINT [<span class="hljs-string">&quot;/usr/local/tomcat/bin/catalina.sh&quot;</span>,<span class="hljs-string">&quot;run&quot;</span>]<br><br>重新上传到远程仓库<br>[root<span class="hljs-variable">@jenkins</span>-server javaweb]<span class="hljs-comment"># git add -A </span><br>[root<span class="hljs-variable">@jenkins</span>-server javaweb]<span class="hljs-comment"># git commit -m &quot;v2.0&quot;</span><br>[root<span class="hljs-variable">@jenkins</span>-server javaweb]<span class="hljs-comment"># git push origin master</span><br></code></pre></td></tr></table></figure><p><img src="/upload/K8S-CICD10.webp" alt="K8S-CICD1.webp"></p><h1 id="配置jenkins流水线进行打包编译生成镜像并推送到公司的harbor仓库"><a href="#配置jenkins流水线进行打包编译生成镜像并推送到公司的harbor仓库" class="headerlink" title="配置jenkins流水线进行打包编译生成镜像并推送到公司的harbor仓库"></a>配置jenkins流水线进行打包编译生成镜像并推送到公司的harbor仓库</h1><p><img src="/upload/K8S-CICD11.webp" alt="K8S-CICD1.webp"></p><p><img src="/upload/K8S-CICD12.webp" alt="K8S-CICD1.webp"></p><h1 id="基本配置略，开始编写pipeline脚本"><a href="#基本配置略，开始编写pipeline脚本" class="headerlink" title="基本配置略，开始编写pipeline脚本"></a>基本配置略，开始编写pipeline脚本</h1><p><img src="/upload/K8S-CICD13.webp" alt="K8S-CICD1.webp"></p><p><img src="/upload/K8S-CICD14.webp" alt="K8S-CICD1.webp"></p><p><img src="/upload/K8S-CICD15.webp" alt="K8S-CICD1.webp"></p><h1 id="复制私钥，创建用户"><a href="#复制私钥，创建用户" class="headerlink" title="复制私钥，创建用户"></a>复制私钥，创建用户</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Perl">[root<span class="hljs-variable">@jenkins</span>-server ~]<span class="hljs-comment"># cat /root/.ssh/id_rsa</span><br><br>复制私钥，生成用户<br></code></pre></td></tr></table></figure><p><img src="/upload/K8S-CICD16.webp" alt="K8S-CICD1.webp"></p><p><img src="/upload/K8S-CICD17.webp" alt="K8S-CICD1.webp"></p><h1 id="流水线完整脚本内容"><a href="#流水线完整脚本内容" class="headerlink" title="流水线完整脚本内容:"></a>流水线完整脚本内容:</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs perl">pipeline &#123;<br>    agent any<br><br>    stages &#123;<br>        stage(<span class="hljs-string">&#x27;pull code&#x27;</span>) &#123;<br>            steps &#123;<br>                checkout([<span class="hljs-variable">$class</span>: <span class="hljs-string">&#x27;GitSCM&#x27;</span>, branches: [[name: <span class="hljs-string">&#x27;*/master&#x27;</span>]], extensions: [], userRemoteConfigs: [[credentialsId: <span class="hljs-string">&#x27;da64354c-fffc-4fbf-9865-bf9c74e25b95&#x27;</span>, url: <span class="hljs-string">&#x27;git@gitee.com:testpm/javaweb.git&#x27;</span>]]])<span class="hljs-comment">#将生成的流水线脚本复制到到这里</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;build code&#x27;</span>) &#123;<br>            steps &#123;<br>                sh <span class="hljs-string">&#x27;cd /root/.jenkins/workspace/test-web1&#x27;</span><br>                sh <span class="hljs-string">&#x27;mvn clean package&#x27;</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;build image&#x27;</span>)&#123;<br>            steps &#123;<br>                sh <span class="hljs-string">&#x27;docker build -t 10.31.162.124/javapm/javaweb:v2.0 .&#x27;</span><span class="hljs-comment">#改成自己的仓库地址</span><br>            &#125;<br>        &#125;<br>        stage(<span class="hljs-string">&#x27;push image to harbor&#x27;</span>) &#123;<br>            steps &#123;<br>                sh <span class="hljs-string">&#x27;docker login -u admin -p Harbor12345 10.31.162.124&#x27;</span><br>                sh <span class="hljs-string">&#x27;docker push 10.31.162.124/javapm/javaweb:v2.0 &amp;&amp; docker rmi 10.31.162.124/javapm/javaweb:v2.0&#x27;</span><br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="/upload/K8S-CICD18.webp" alt="K8S-CICD1.webp"></p><p><img src="/upload/K8S-CICD19.webp" alt="K8S-CICD1.webp"></p><h1 id="登陆harbor仓库查看镜像是否上传成功"><a href="#登陆harbor仓库查看镜像是否上传成功" class="headerlink" title="登陆harbor仓库查看镜像是否上传成功"></a>登陆harbor仓库查看镜像是否上传成功</h1><p><img src="/upload/K8S-CICD20.webp" alt="K8S-CICD1.webp"></p><h1 id="K8S集群上部署Harbor仓库"><a href="#K8S集群上部署Harbor仓库" class="headerlink" title="K8S集群上部署Harbor仓库"></a>K8S集群上部署Harbor仓库</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs perl">所有机器上都操作，创建secret需要，不然创建不成功<br>[root<span class="hljs-variable">@master</span> ~]<span class="hljs-comment"># vim /etc/docker/daemon.json   #编辑文件</span><br>&#123;<br><span class="hljs-string">&quot;insecure-registries&quot;</span>: [<span class="hljs-string">&quot;10.31.162.133&quot;</span>]   <span class="hljs-comment">#该ip为部署仓库机器的ip</span><br>&#125;<br>[root<span class="hljs-variable">@master</span> ~]<span class="hljs-comment"># # systemctl restart docker</span><br><br>验证是否可以登入<br>[root<span class="hljs-variable">@master</span> ~]<span class="hljs-comment"># docker login -u admin -p Harbor 10.31.162.133</span><br></code></pre></td></tr></table></figure><h1 id="发布项目到k8s集群，编写deployment进行发布"><a href="#发布项目到k8s集群，编写deployment进行发布" class="headerlink" title="发布项目到k8s集群，编写deployment进行发布"></a>发布项目到k8s集群，编写deployment进行发布</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs perl">查看master上面认证的密钥文件<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># cat /root/.docker/config.json | base64 -w 0</span><br>ewoJImF1dGhzIjogewoJCSIxMC4zMS4xNjIuMTI0IjogewoJCQkiYXV0aCI6ICJZV1J0YVc0NlNHRnlZbTl5TVRJek5EVT0iCgkJfQoJfQp9<br><br>创建登入harbor仓库的secret<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># cat secret.yaml </span><br>apiVersion: <span class="hljs-number">v1</span><br>kind: Secret<br>metadata:<br> name: harbor-login<br> labels:<br>  app: harbor<br>type: kubernetes.io/dockerconfigjson<br>data:<br> .dockerconfigjson: ewoJImF1dGhzIjogewoJCSIxMC4zMS4xNjIuMTI0IjogewoJCQkiYXV0aCI6ICJZV1J0YVc0NlNHRnlZbTl5TVRJek5EVT0iCgkJfQoJfQp9      <span class="hljs-comment">#将上面生成的密钥复制到这里</span><br><br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># systemctl apply -f secret.yaml</span><br>secret/harbor-login created<br><br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># cat java-dep.yaml </span><br>apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br> name: tomcat-dep<br>spec:<br> selector:<br>  matchLabels:<br>   app: java<br> replicas: <span class="hljs-number">2</span><br> template:<br>  metadata:<br>   labels:<br>    app: java<br>  spec:<br>   volumes:<br>   - name: <span class="hljs-keyword">log</span>-vol<br>     hostPath:<br>      path: <span class="hljs-regexp">/var/</span>javaweb/<span class="hljs-keyword">log</span><br>   containers:<br>   - name: tomcat<br>     image: <span class="hljs-number">10.31</span><span class="hljs-number">.162</span><span class="hljs-number">.124</span>/javapm/javaweb:<span class="hljs-number">v2.0</span><br>     ports:<br>     - containerPort: <span class="hljs-number">8080</span><br>     volumeMounts:<br>     - mountPath: <span class="hljs-string">&quot;/usr/local/tomcat/logs&quot;</span><br>       name: <span class="hljs-keyword">log</span>-vol<br>   imagePullSecrets:<br>   - name: harbor-login<br>   <br>创建depolyment<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># kubectl apply -f java-dep.yaml</span><br>deployment.apps/tomcat-dep created<br><br>查看pod有没有运行起来<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># kubectl get po</span><br>NAME                          READY   STATUS    RESTARTS   AGE<br>tomcat-dep-7bd9fb7df9-4fz6x   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          26s<br>tomcat-dep-7bd9fb7df9-wsbth   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          26s<br></code></pre></td></tr></table></figure><h1 id="配置Ingress实现访问"><a href="#配置Ingress实现访问" class="headerlink" title="配置Ingress实现访问"></a>配置Ingress实现访问</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><code class="hljs perl">下载ingress配置文件: 如果下载不下来记得添加解析<br>[root<span class="hljs-variable">@master</span> ~]<span class="hljs-comment"># cat /etc/hosts</span><br><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::<span class="hljs-number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6<br><span class="hljs-number">192.168</span><span class="hljs-number">.116</span><span class="hljs-number">.138</span> master<br><span class="hljs-number">192.168</span><span class="hljs-number">.116</span><span class="hljs-number">.130</span> node1<br><span class="hljs-number">192.168</span><span class="hljs-number">.116</span><span class="hljs-number">.131</span> node2<br><span class="hljs-number">199.232</span><span class="hljs-number">.28</span><span class="hljs-number">.133</span> raw.githubusercontent.com  <span class="hljs-comment">#解析github的地址</span><br><br>可以直接进行这一步进行下载<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># cd /mnt/</span><br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.0/deploy/static/provider/cloud/deploy.yaml</span><br>修改配置文件<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># vim deploy.yaml</span><br>找到已下apiserver的版本：<br>---<br>apiVersion: apps/<span class="hljs-number">v1</span><br>kind: DaemonSet  <span class="hljs-comment">#将原来的Deployment修改为DaemonSet</span><br>metadata:<br>  labels:<br>    app.kubernetes.io/component: controller<br>    app.kubernetes.io/instance: ingress-nginx<br>    app.kubernetes.io/name: ingress-nginx<br>    app.kubernetes.io/part-of: ingress-nginx<br>    app.kubernetes.io/version: <span class="hljs-number">1.3</span>.<span class="hljs-number">0</span><br>  name: ingress-nginx-controller<br>  namespace: ingress-nginx<br>spec:<br>  minReadySeconds: <span class="hljs-number">0</span><br>  revisionHistoryLimit: <span class="hljs-number">10</span><br>  selector:<br>    matchLabels:<br>      app.kubernetes.io/component: controller<br>      app.kubernetes.io/instance: ingress-nginx<br>      app.kubernetes.io/name: ingress-nginx<br>  template:<br>    metadata:<br>      labels:<br>        app.kubernetes.io/component: controller<br>        app.kubernetes.io/instance: ingress-nginx<br>        app.kubernetes.io/name: ingress-nginx<br>    spec:<br>      hostNetwork: true  <span class="hljs-comment">#添加共享到主机网络</span><br>      containers:<br>      - args:<br>        - <span class="hljs-regexp">/nginx-ingress-controller</span><br><span class="hljs-regexp">        - --publish-service=$(POD_NAMESPACE)/ingr</span>ess-nginx-controller<br>        - --election-id=ingress-controller-leader<br>        - --controller-<span class="hljs-class"><span class="hljs-keyword">class</span>=<span class="hljs-title">k8s</span>.<span class="hljs-title">io</span>/<span class="hljs-title">ingress</span>-<span class="hljs-title">nginx</span></span><br><span class="hljs-class">        - --<span class="hljs-title">ingress</span>-<span class="hljs-title">class</span>=<span class="hljs-title">nginx</span></span><br><span class="hljs-class">        - --<span class="hljs-title">configmap</span>=$(<span class="hljs-title">POD_NAMESPACE</span>)/<span class="hljs-title">ingress</span>-<span class="hljs-title">nginx</span>-<span class="hljs-title">controller</span></span><br><span class="hljs-class">        - --<span class="hljs-title">validating</span>-<span class="hljs-title">webhook</span>=:<span class="hljs-number">8443</span></span><br><span class="hljs-class">        - --<span class="hljs-title">validating</span>-<span class="hljs-title">webhook</span>-<span class="hljs-title">certificate</span>=/<span class="hljs-title">usr</span>/<span class="hljs-title">local</span>/<span class="hljs-title">certificates</span>/<span class="hljs-title">cert</span></span><br><span class="hljs-class">        - --<span class="hljs-title">validating</span>-<span class="hljs-title">webhook</span>-<span class="hljs-title">key</span>=/<span class="hljs-title">usr</span>/<span class="hljs-title">local</span>/<span class="hljs-title">certificates</span>/<span class="hljs-title">key</span></span><br><span class="hljs-class">        <span class="hljs-title">env</span>:</span><br><span class="hljs-class">        - <span class="hljs-title">name</span>: <span class="hljs-title">POD_NAME</span></span><br><span class="hljs-class">          <span class="hljs-title">valueFrom</span>:</span><br><span class="hljs-class">            <span class="hljs-title">fieldRef</span>:</span><br><span class="hljs-class">              <span class="hljs-title">fieldPath</span>: <span class="hljs-title">metadata</span>.<span class="hljs-title">name</span></span><br><span class="hljs-class">        - <span class="hljs-title">name</span>: <span class="hljs-title">POD_NAMESPACE</span></span><br><span class="hljs-class">          <span class="hljs-title">valueFrom</span>:</span><br><span class="hljs-class">            <span class="hljs-title">fieldRef</span>:</span><br><span class="hljs-class">              <span class="hljs-title">fieldPath</span>: <span class="hljs-title">metadata</span>.<span class="hljs-title">namespace</span></span><br><span class="hljs-class">        - <span class="hljs-title">name</span>: <span class="hljs-title">LD_PRELOAD</span></span><br><span class="hljs-class">          <span class="hljs-title">value</span>: /<span class="hljs-title">usr</span>/<span class="hljs-title">local</span>/<span class="hljs-title">lib</span>/<span class="hljs-title">libmimalloc</span>.<span class="hljs-title">so</span></span><br><span class="hljs-class">        <span class="hljs-title">image</span>: <span class="hljs-title">registry</span>.<span class="hljs-title">cn</span>-<span class="hljs-title">hangzhou</span>.<span class="hljs-title">aliyuncs</span>.<span class="hljs-title">com</span>/<span class="hljs-title">google_containers</span>/<span class="hljs-title">nginx</span>-<span class="hljs-title">ingress</span>-<span class="hljs-title">controller</span>:<span class="hljs-title">v1</span>.<span class="hljs-number">3.0</span>@<span class="hljs-title">sha256</span>:<span class="hljs-title">d1707ca76d3b044ab8a28277a2466a02100ee9f58a86af1535a3edf9323ea1b5</span> #将原来的镜像替换成阿里云仓库的镜像</span><br><span class="hljs-class">        <span class="hljs-title">imagePullPolicy</span>: <span class="hljs-title">IfNotPresent</span></span><br><span class="hljs-class">        <span class="hljs-title">lifecycle</span>:</span><br><span class="hljs-class">          <span class="hljs-title">preStop</span>:</span><br><span class="hljs-class">            <span class="hljs-title">exec</span>:</span><br><span class="hljs-class">              <span class="hljs-title">command</span>:</span><br><span class="hljs-class">              - /<span class="hljs-title">wait</span>-<span class="hljs-title">shutdown</span></span><br><span class="hljs-class">   。。。</span><br><span class="hljs-class">        <span class="hljs-title">volumeMounts</span>:</span><br><span class="hljs-class">        - <span class="hljs-title">mountPath</span>: /<span class="hljs-title">usr</span>/<span class="hljs-title">local</span>/<span class="hljs-title">certificates</span>/</span><br><span class="hljs-class">          <span class="hljs-title">name</span>: <span class="hljs-title">webhook</span>-<span class="hljs-title">cert</span></span><br><span class="hljs-class">          <span class="hljs-title">readOnly</span>: <span class="hljs-title">true</span></span><br><span class="hljs-class">      <span class="hljs-title">dnsPolicy</span>: <span class="hljs-title">ClusterFirst</span></span><br><span class="hljs-class">      <span class="hljs-title">nodeSelector</span>:</span><br><span class="hljs-class">        <span class="hljs-title">custom</span>/<span class="hljs-title">ingress</span>-<span class="hljs-title">controller</span>-<span class="hljs-title">ready</span>: &quot;<span class="hljs-title">true</span>&quot;  #指定运行<span class="hljs-title">ingress</span>的<span class="hljs-title">node</span>标签</span><br><span class="hljs-class">      <span class="hljs-title">serviceAccountName</span>: <span class="hljs-title">ingress</span>-<span class="hljs-title">nginx</span></span><br><span class="hljs-class">      <span class="hljs-title">terminationGracePeriodSeconds</span>: <span class="hljs-number">300</span></span><br><span class="hljs-class">      <span class="hljs-title">volumes</span>:</span><br><span class="hljs-class">      - <span class="hljs-title">name</span>: <span class="hljs-title">webhook</span>-<span class="hljs-title">cert</span></span><br><span class="hljs-class">        <span class="hljs-title">secret</span>:</span><br><span class="hljs-class">          <span class="hljs-title">secretName</span>: <span class="hljs-title">ingress</span>-<span class="hljs-title">nginx</span>-<span class="hljs-title">admission</span></span><br><span class="hljs-class">---</span><br><span class="hljs-class"></span><br><span class="hljs-class">#注意:一共有两个镜像需要替换成阿里云仓库的镜像:</span><br><span class="hljs-class">[<span class="hljs-title">root</span>@<span class="hljs-title">master</span> ~]# <span class="hljs-title">cat</span> <span class="hljs-title">deploy</span>.<span class="hljs-title">yaml</span> | <span class="hljs-title">grep</span> <span class="hljs-title">image</span></span><br><span class="hljs-class">        <span class="hljs-title">image</span>: <span class="hljs-title">registry</span>.<span class="hljs-title">cn</span>-<span class="hljs-title">hangzhou</span>.<span class="hljs-title">aliyuncs</span>.<span class="hljs-title">com</span>/<span class="hljs-title">google_containers</span>/<span class="hljs-title">nginx</span>-<span class="hljs-title">ingress</span>-<span class="hljs-title">controller</span>:<span class="hljs-title">v1</span>.<span class="hljs-number">3.0</span>@<span class="hljs-title">sha256</span>:<span class="hljs-title">d1707ca76d3b044ab8a28277a2466a02100ee9f58a86af1535a3edf9323ea1b5</span></span><br><span class="hljs-class">        <span class="hljs-title">imagePullPolicy</span>: <span class="hljs-title">IfNotPresent</span></span><br><span class="hljs-class">        <span class="hljs-title">image</span>: <span class="hljs-title">registry</span>.<span class="hljs-title">cn</span>-<span class="hljs-title">hangzhou</span>.<span class="hljs-title">aliyuncs</span>.<span class="hljs-title">com</span>/<span class="hljs-title">google_containers</span>/<span class="hljs-title">kube</span>-<span class="hljs-title">webhook</span>-<span class="hljs-title">certgen</span>:<span class="hljs-title">v1</span>.<span class="hljs-number">1.1</span>@<span class="hljs-title">sha256</span>:64<span class="hljs-title">d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span></span><br><span class="hljs-class">        <span class="hljs-title">imagePullPolicy</span>: <span class="hljs-title">IfNotPresent</span></span><br><span class="hljs-class">        <span class="hljs-title">image</span>: <span class="hljs-title">registry</span>.<span class="hljs-title">cn</span>-<span class="hljs-title">hangzhou</span>.<span class="hljs-title">aliyuncs</span>.<span class="hljs-title">com</span>/<span class="hljs-title">google_containers</span>/<span class="hljs-title">kube</span>-<span class="hljs-title">webhook</span>-<span class="hljs-title">certgen</span>:<span class="hljs-title">v1</span>.<span class="hljs-number">1.1</span>@<span class="hljs-title">sha256</span>:64<span class="hljs-title">d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span></span><br><span class="hljs-class">        <span class="hljs-title">imagePullPolicy</span>: <span class="hljs-title">IfNotPresent</span></span><br></code></pre></td></tr></table></figure><h1 id="给两个node节点设置lable"><a href="#给两个node节点设置lable" class="headerlink" title="给两个node节点设置lable"></a>给两个node节点设置lable</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> ~]<span class="hljs-comment"># kubectl label nodes node-1 custom/ingress-controller-ready=true</span><br>node/node1 labeled<br>[root<span class="hljs-variable">@master</span> ~]<span class="hljs-comment"># kubectl label nodes node-2 custom/ingress-controller-ready=true</span><br>node/node2 labeled<br><br>同时在两个node节点下载镜像<br>[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.3.0</span><br>[root<span class="hljs-variable">@node1</span> ~]<span class="hljs-comment"># docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1</span><br></code></pre></td></tr></table></figure><h1 id="创建ingress-controller"><a href="#创建ingress-controller" class="headerlink" title="创建ingress-controller"></a>创建ingress-controller</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs perl">创建deploy<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># kubectl apply -f deploy.yaml </span><br>namespace/ingress-nginx created<br>serviceaccount/ingress-nginx created<br>。。。<br>ingressclass.networking.k8s.io/nginx created<br>validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created<br><br>查看ingress-controller资源<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># kubectl get po -n ingress-nginx</span><br>NAME                                      READY   STATUS      RESTARTS   AGE<br>ingress-nginx-admission-create--<span class="hljs-number">1</span>-vc8xc   <span class="hljs-number">0</span>/<span class="hljs-number">1</span>     Completed   <span class="hljs-number">0</span>          30s<br>ingress-nginx-admission-patch--<span class="hljs-number">1</span>-5crsl    <span class="hljs-number">0</span>/<span class="hljs-number">1</span>     Completed   <span class="hljs-number">1</span>          30s<br>ingress-nginx-controller-z4nzd            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running     <span class="hljs-number">0</span>          30s<br>ingress-nginx-controller-zmkpc            <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running     <span class="hljs-number">0</span>          30s<br><br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># ls</span><br>deploy.yaml  java-dep.yaml  secret.yaml<br></code></pre></td></tr></table></figure><p>测试ingress</p><h1 id="创建service"><a href="#创建service" class="headerlink" title="创建service"></a>创建service</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># cat java-service.yaml </span><br>apiVersion: <span class="hljs-number">v1</span><br>kind: Service<br>metadata:<br> name: <span class="hljs-keyword">my</span>-java<br> labels:<br>  run: <span class="hljs-keyword">my</span>-java<br>spec:<br> ports:<br> - port: <span class="hljs-number">80</span><br>   targetPort: <span class="hljs-number">8080</span><br> selector:<br>  app: java<br>  <br>创建service<br>root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># kubectl apply -f java-service.yaml </span><br>service/<span class="hljs-keyword">my</span>-tomcat created<br><br>查看资源<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># kubectl get po</span><br>NAME                          READY   STATUS    RESTARTS   AGE<br>tomcat-dep-7bd9fb7df9-4fz6x   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          18m<br>tomcat-dep-7bd9fb7df9-wsbth   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          18m<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># kubectl get svc</span><br>NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE<br>kubernetes   ClusterIP   <span class="hljs-number">10.96</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>        &lt;none&gt;        <span class="hljs-number">443</span>/TCP   2d1h<br><span class="hljs-keyword">my</span>-java      ClusterIP   <span class="hljs-number">10.104</span><span class="hljs-number">.150</span><span class="hljs-number">.165</span>   &lt;none&gt;        <span class="hljs-number">80</span>/TCP    27s<br></code></pre></td></tr></table></figure><h1 id="配置ingress转发文件"><a href="#配置ingress转发文件" class="headerlink" title="配置ingress转发文件"></a>配置ingress转发文件</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># cat ingress-test.yaml </span><br>apiVersion: networking.k8s.io/<span class="hljs-number">v1</span><br>kind: Ingress<br>metadata:<br> name: test-ingress<br> namespace: default<br> annotations:<br>  nginx.ingress.kubernetes.io/rewrite-target: <span class="hljs-regexp">/easy-springmvc-maven/</span><br>spec:<br> ingressClassName: nginx<span class="hljs-comment">#指定ingress的类型</span><br> rules:<span class="hljs-comment">#定义转发规则</span><br> - host: test.tomcat.com<span class="hljs-comment">#指定域名方式</span><br>   http:<br>    paths:<br>    - path:  <span class="hljs-regexp">/easy-springmvc-maven/</span><span class="hljs-comment">#指定访问的路径</span><br>      pathType: Prefix <span class="hljs-comment">#定义路径的类型</span><br>      backend:<span class="hljs-comment">#定义转发后端的服务</span><br>       service:<span class="hljs-comment">#定义转发的service</span><br>        name: <span class="hljs-keyword">my</span>-java<span class="hljs-comment">#这个定义的名字要和service的名字一样</span><br>        port:<br>         number: <span class="hljs-number">80</span><br>         <br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># kubectl apply -f ingress-test.yaml </span><br>ingress.networking.k8s.io/test-ingress created<br>[root<span class="hljs-variable">@master</span> k8s]<span class="hljs-comment"># kubectl get ingress</span><br>NAME           CLASS   HOSTS             ADDRESS   PORTS   AGE<br>test-ingress   nginx   test.tomcat.com             <span class="hljs-number">80</span>      13s<br></code></pre></td></tr></table></figure><h1 id="在wind电脑设置本机解析"><a href="#在wind电脑设置本机解析" class="headerlink" title="在wind电脑设置本机解析"></a>在wind电脑设置本机解析</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">在C:\Windows\System32\drivers\etc找到hosts文件里添加<br><span class="hljs-number">10.31</span><span class="hljs-number">.162</span><span class="hljs-number">.135</span>test.tomcat.com<span class="hljs-comment">#这个IP地址是选取的一个node节点IP</span><br></code></pre></td></tr></table></figure><p><img src="/upload/K8S-CICD21.webp" alt="K8S-CICD1.webp"></p><h1 id="测试访问"><a href="#测试访问" class="headerlink" title="测试访问"></a>测试访问</h1><p><img src="/upload/K8S-CICD22.webp" alt="K8S-CICD1.webp"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Oracle数据库部署、监听、优化、备份恢复</title>
    <link href="/2025/11/06/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E9%83%A8%E7%BD%B2%E3%80%81%E7%9B%91%E5%90%AC%E3%80%81%E4%BC%98%E5%8C%96%E3%80%81%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"/>
    <url>/2025/11/06/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E9%83%A8%E7%BD%B2%E3%80%81%E7%9B%91%E5%90%AC%E3%80%81%E4%BC%98%E5%8C%96%E3%80%81%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/</url>
    
    <content type="html"><![CDATA[<h2 id="VM虚拟机安装oracle"><a href="#VM虚拟机安装oracle" class="headerlink" title="VM虚拟机安装oracle"></a>VM虚拟机安装oracle</h2><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><h2 id="1-改操作系统核心参数"><a href="#1-改操作系统核心参数" class="headerlink" title="1.改操作系统核心参数"></a>1.改操作系统核心参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# vim /etc/security/limits.conf<br><br>oracle soft nofile 65536<br>oracle hard nofile 65536<br>oracle soft nproc 16384<br>oracle hard nproc 16384<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# vim /etc/sysctl.conf<br><br>kernel.shmmax = 2147483648<br>kernel.shmmni = 4096<br>kernel.shmall = 2097152<br>kernel.sem = 510 32000 100 128<br>fs.file-max ingfeng@123= 65536<br>net.ipv4.ip_local_port_range = 1024 65000<br>net.core.rmem_default = 4194304<br>net.core.rmem_max = 4194304<br>net.core.wmem_max = 16777216<br>net.core.wmem_default = 266960<br></code></pre></td></tr></table></figure><p>使&#x2F;etc&#x2F;sysctl.conf更改立即生效</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# sysctl -p<br></code></pre></td></tr></table></figure><h2 id="2-创建相关用户和用户组"><a href="#2-创建相关用户和用户组" class="headerlink" title="2.创建相关用户和用户组"></a>2.创建相关用户和用户组</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# groupadd oinstall<br>[root@localhost ~]# groupadd dba<br>[root@localhost ~]# useradd -g dba -G oinstall -m oracle<br>[root@localhost ~]# passwd oracle<br></code></pre></td></tr></table></figure><h2 id="3-创建数据库软件目录和数据文件存放目录"><a href="#3-创建数据库软件目录和数据文件存放目录" class="headerlink" title="3.创建数据库软件目录和数据文件存放目录"></a>3.创建数据库软件目录和数据文件存放目录</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# mkdir -p /opt/oracle/<br>[root@localhost ~]# mkdir -p /opt/oracle/oracle/product<br>[root@localhost ~]# mkdir -p /opt/oracle/oradata/<br>[root@localhost ~]# mkdir -p /opt/oracle/oralnventory<br></code></pre></td></tr></table></figure><p>更改oracle目录的own</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# chown -R oracle:dba /opt/oracle<br></code></pre></td></tr></table></figure><p>改变&#x2F;home&#x2F;oracle目录的拥有者</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# chown -R oracle:dba /home/oracle<br></code></pre></td></tr></table></figure><p>下载依赖</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# yum -y install libXp.i686 libXp-devel.i686 libXt.i686 libXt-devel.i686 libXtst.i686 libXtst-devel.i686 make.x86_64 gcc.x86_64 libaio.x86_64 glibc-devel.i686 libgcc.i686 glibc* gcc* make* compat-db* libstdc* libXp* libXtst* compat-libstdc++* libaio libaio-devel sysstat unixODBC unixODBC-devel<br></code></pre></td></tr></table></figure><h2 id="4-配置环境变量"><a href="#4-配置环境变量" class="headerlink" title="4.配置环境变量"></a>4.配置环境变量</h2><p>以root用户执行</p><p>su - oracle切换为oracle用户<br><strong>修改$HOME&#x2F;.bash_profile文件</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs shell">[oracle@localhost ~]$ vim .bash_profile   #设置以下变量<br><br>export ORACLE_BASE=/opt/oracle/<br>export ORACLE_HOME=/opt/oracle/oracle/product/11.2.0/dbhome_1<br>export ORACLE_SID=orcl<br>export PATH=$PATH:$HOME/bin:$ORACLE_HOME/bin<br>export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/lib<br><br>[oracle@localhost ~]$ source .bash_profile<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum install unzip   #如果没有unzip命令要先下载<br><br>[oracle@localhost ~]$ unzip p13390677_112040_Linux-x86-64_1of7.zip<br>[oracle@localhost ~]$ unzip p13390677_112040_Linux-x86-64_2of7.zip<br>解压时会默认自动生成database目录<br>[oracle@localhost ~]$ ls<br>database                                p13390677_112040_Linux-x86-64_2of7.zip<br>p13390677_112040_Linux-x86-64_1of7.zip<br>[oracle@localhost ~]$ cd database/<br>[oracle@localhost database]$ ls<br>install  readme.html  response  rpm  runInstaller  sshsetup  stage  welcome.html<br></code></pre></td></tr></table></figure><p>切换到root目录执行下列命令</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# export DISPLAY=:0.0<br>[root@localhost ~]# xhost +<br>access control disabled, clients can connect from any host<br></code></pre></td></tr></table></figure><h2 id="5-开始安装"><a href="#5-开始安装" class="headerlink" title="5.开始安装"></a>5.开始安装</h2><p>安装（oracle用户）进入到database目录</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">[oracle@localhost database]$ export DISPLAY=:0.0<br>[oracle@localhost database]$ export DISPLAY<br>[oracle@localhost database]$ echo $SHELL<br>/bin/bash<br><br>当检查均通过，会出现oracle安装界面，如此时安装界面出现乱码，可能是系统语言为中文导致，需要临时修改系统语言<br>[oracle@localhost database]$ echo $LANG<br>[oracle@localhost database]$ export LANG=&#x27;en_US&#x27;<br><span class="hljs-meta prompt_">#</span><span class="language-bash">不进行以上操作，启动会报错</span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">验证环境变量是否生效，不然后续配置会出错</span><br>[oracle@localhost database]$ echo $ORACLE_HOME <br>/opt/oracle/oracle/product/11.2.0/dbhome_1<br>[oracle@localhost database]$ echo $LD_LIBRARY_PATH<br>/opt/oracle/oracle/product/11.2.0/dbhome_1/lib:/usr/lib<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">在database目录下启动</span><br>[oracle@localhost database]$ ./runInstaller<br>这时在vm上设置oracle<br></code></pre></td></tr></table></figure><p>此时进入vm桌面进行操作</p><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">1</span>、取消邮件的勾选，点yes，<span class="hljs-keyword">Next</span><br><span class="hljs-number">2</span>、选Skip software updates跳过软件更新，下一步<span class="hljs-keyword">Next</span><br><span class="hljs-number">3</span>、Create <span class="hljs-keyword">and</span> configure a database创建和配置数据库，<span class="hljs-keyword">Next</span><br><span class="hljs-number">4</span>、Desktop ClassO Desktop类，<span class="hljs-keyword">Next</span><br><span class="hljs-number">5</span>、设置密码，<span class="hljs-keyword">Next</span><br><span class="hljs-number">6</span>、选择dba，<span class="hljs-keyword">Next</span>----这时候会出现报错，将路径(/opt/oracle/oralnventory)重新选择下就好,另外如果时重新安装，需要将oralnventory目录下清空才可以重新安装，点yes，<span class="hljs-keyword">Next</span><br><span class="hljs-number">7</span>、Prerequis ite Checks前提条件检查,在root用户下执行（/tmp/CVU_11.<span class="hljs-number">2.0</span>.<span class="hljs-number">4.0</span>_oracle/runfixup.sh）脚本，做<span class="hljs-keyword">swap</span>分区，安装需要安装的依赖包，然后再点检查，基本可以清空警告了---或者不重要的勾选Ignore All跳过，点yes，<span class="hljs-keyword">Next</span><br>注：需要安装pdksh-<span class="hljs-number">5.2</span>.<span class="hljs-number">14</span>---先root用户下卸载rpm -e ksh-<span class="hljs-number">20120801</span>-<span class="hljs-number">144</span>.el7_9.x86_64---安装rpm -ivh pdksh-<span class="hljs-number">5.2</span>.<span class="hljs-number">14</span>-<span class="hljs-number">37</span>.el5.x86_64.rpm<br><span class="hljs-number">8</span>、点install---安装到<span class="hljs-number">70</span>%左右会报错，更改以下参数就可以了<br>[oracle@localhost database]$ vim $ORACLE_HOME/sysman/lib/ins_emagent.mk<br>将$(MK_EMAGENT_NMECTL)改为$(MK_EMAGENT_NMECTL) -lnnz11<br><span class="hljs-number">9</span>、按照步骤点OK<br></code></pre></td></tr></table></figure><p>用root用户执行如下两个语句之后，点击OK</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# /opt/oracle/oralnventory/orainstRoot.sh<br>[root@localhost ~]# /opt/oracle/oracle/product/11.2.0/dbhome_1/root.sh<br></code></pre></td></tr></table></figure><h2 id="6、测试"><a href="#6、测试" class="headerlink" title="6、测试"></a>6、测试</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs shell">[oracle@localhost ~]$ sqlplus / as sysdba     登入数据库<br>create tablespace nk01 datafile &#x27;/home/oracle/app/oracle/oradata/meddate/nk01.dbf&#x27; size 200m autoextend on next 100m maxsize unlimited;创建一个空表<br>create user nk01 identified bu admin；<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">创建用户、授权、创建表空间</span><br>创建uk01用户<br>CREATE USER uk01 IDENTIFIED BY password;<br><br>授予 nk01 用户对表 table_name 的查询权限<br>GRANT SELECT ON table_name TO nk01;<br>授予 nk01 用户创建表的权限<br>GRANT CREATE TABLE TO nk01;<br><br>创建表空间<br>CREATE TABLESPACE tablespace_name<br>DATAFILE &#x27;file_path_and_name.dbf&#x27; SIZE size;<br><br>授权表空间给用户uk01<br>ALTER USER uk01 DEFAULT TABLESPACE tablespace_name;<br></code></pre></td></tr></table></figure><p>最后把防火墙的端口打开</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost ~]# firewall-cmd --add-port=1521/tcp<br>[root@localhost ~]# firewall-cmd --add-port=1521/tcp --permanent<br>[root@localhost ~]# firewall-cmd --add-port=1158/tcp<br>[root@localhost ~]# firewall-cmd --add-port=1158/tcp --permanent<br></code></pre></td></tr></table></figure><h1 id="监听"><a href="#监听" class="headerlink" title="监听"></a>监听</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs ini">1、netca监听<br><span class="hljs-section">[oracle@oracle ~]</span>$ netca<br>在oracle用户下执行 netca 命令<br>选择 Listener configuration，点击 Next<br>选择 Add 添加，点击 Next<br>输入监听程序名-可以自定义，点击 Next<br>选择TCP协议，点击 Next<br>选择端口号1521，点击 Next<br>是否需要配置另外一个监听器，选择 No，点击 Next<br>点击 Next，最后点击完成<br><br>示例：<br><span class="hljs-section">[oracle@oracle ~]</span>$ netca<br>Oracle Net Services Configuration:<br>Configuring Listener:LISTENER01<br>Listener configuration complete.<br>Configuring Listener:LISTENER02<br>Listener configuration complete.<br>Oracle Net Services configuration successful. The exit code is 0<br><br>2、netmgr监听<br><span class="hljs-section">[oracle@oracle ~]</span>$ netmgr<br>选择listeners---点+号---起个监听器的名字--点OK<br>监听的位置：点 Add Address---协议tcp--host主机名（自定义）---端口<br>点file---选择save network configuration 保存<br><br>3、修改配置文件方式监听<br>在/opt/oracle/oracle/product/11.2.0/dbhome_1/network/admin/listener.ora里修改<br>注：前面的路径为export定义的家目录<br></code></pre></td></tr></table></figure><h1 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h1><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs basic">增加<span class="hljs-keyword">swap</span>分区<br>swapon -s<br>#创建<span class="hljs-keyword">swap</span>文件 bs=<span class="hljs-number">2300</span>的设置的值一般为内存的<span class="hljs-number">1.5</span>倍以上 <br>dd <span class="hljs-keyword">if</span>=/dev/zero of=/var/<span class="hljs-keyword">swap</span> bs=<span class="hljs-number">2500</span> count=<span class="hljs-number">1000000</span><br>#需要更改<span class="hljs-keyword">swap</span>文件的权限，确保只有root才可读<br>chmod <span class="hljs-number">600</span> /var/<span class="hljs-keyword">swap</span><br>#告知系统将该文件用于<span class="hljs-keyword">swap</span><br>mkswap /var/<span class="hljs-keyword">swap</span><br>#开始使用该<span class="hljs-keyword">swap</span><br>swapon /var/<span class="hljs-keyword">swap</span><br>#使<span class="hljs-keyword">Swap</span>文件永久生效,/etc/fstab加入配置<br>echo <span class="hljs-string">&quot;/var/swap   swap    swap    sw  0   0&quot;</span> &gt;&gt; /etc/fstab<br><br>如果上面创建后发现，大小创建错误了。如何重置呢？<br>swapoff -a<br>rm /var/<span class="hljs-keyword">swap</span><br>上面命令就可以删除了，然后重新创建合适的<span class="hljs-keyword">swap</span>文件就行了。<br></code></pre></td></tr></table></figure><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs basic">调整aio-max-nr内核参数，你可以按照以下步骤进行操作：<br><span class="hljs-number">1</span>. sudo vi /etc/sysctl.conf<br><span class="hljs-number">2</span>. fs.aio-max-nr = <span class="hljs-number">65536</span>  自己修改合适的参数例如<span class="hljs-number">65536</span><br><span class="hljs-number">3</span>. 加载新的内核参数配置 sudo sysctl -p<br><span class="hljs-number">4</span>. 验证参数设置  sysctl fs.aio-max-nr<br><span class="hljs-number">5</span>. 重新运行预安装检查 确保aio-max-nr参数设置已满足要求<br>直到yes<br><br>解决内核参数，调优<br>vim /etc/sysctl.conf<br><br>kernel.shmmax = <span class="hljs-number">2147483648</span><br>kernel.shmmni = <span class="hljs-number">4096</span><br>kernel.shmall = <span class="hljs-number">2097152</span><br>kernel.sem = <span class="hljs-number">510</span> <span class="hljs-number">32000</span> <span class="hljs-number">100</span> <span class="hljs-number">128</span><br>fs.file-max ingfeng@<span class="hljs-number">123</span>= <span class="hljs-number">65536</span><br>net.ipv4.ip_local_port_range = <span class="hljs-number">1024</span> <span class="hljs-number">65000</span><br>net.core.rmem_default = <span class="hljs-number">4194304</span><br>net.core.rmem_max = <span class="hljs-number">4194304</span><br>net.core.wmem_max = <span class="hljs-number">16777216</span><br>net.core.wmem_default = <span class="hljs-number">266960</span><br></code></pre></td></tr></table></figure><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs basic">调优：<br>优化 SQL 查询：<br>- 分析和优化关键 SQL 查询的执行计划<br>#查看 SQL 查询的执行计划<br>EXPLAIN PLAN <span class="hljs-keyword">FOR</span> &lt;your_query&gt;;<br>#显示查询的执行计划<br>SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);<br>- 确保适当的索引被使用，以避免全表扫描<br>#查看表的索引<br>SELECT index_name, column_name FROM user_ind_columns WHERE table_name = <span class="hljs-comment">&#x27;&lt;table_name&gt;&#x27;;</span><br><br>合理配置数据库参数：<br>- 调整 SGA 大小需要根据系统的总内存和数据库负载情况来确定。一般建议将 SGA 大小设置为可用内存的 <span class="hljs-number">50</span>% 到 <span class="hljs-number">80</span>%<br>- 调整PGA，使用 PGA_AGGREGATE_TARGET 参数修改 PGA 大小<br>- 数据库缓存，调整 DB_CACHE_SIZE 参数来调整数据库缓冲区的大小<br>- 连接池用于管理数据库连接的分配和释放，PROCESSES 参数限制数据库的最大并发连接数，并通过设置 SESSIONS 参数限制连接数<br><br>优化索引：<br>- 确保表上存在适当的索引，以加快查询速度<br>CREATE INDEX index_name <span class="hljs-keyword">ON</span> table_name (column1, column2);<br>- 定期重建或重新组织索引，以减少索引碎片并提高查询性能<br>ALTER INDEX index_name REBUILD;<br>ALTER INDEX index_name REORGANIZE;<br>- 定期执行索引维护任务<br><br>使用分区表和分区索引：<br>- 可以使用分区表和分区索引来提高查询性能<br>- 示例：<br>分区示例：<br>CREATE TABLE sales (<br>    sales_id NUMBER,<br>    sales_date DATE,<br>    amount NUMBER<br>)<br>PARTITION BY RANGE (sales_date)<br>(<br>    PARTITION sales_2019 VALUES LESS THAN (TO_DATE(<span class="hljs-comment">&#x27;2020-01-01&#x27;, &#x27;YYYY-MM-DD&#x27;)),</span><br>    PARTITION sales_2020 VALUES LESS THAN (TO_DATE(<span class="hljs-comment">&#x27;2021-01-01&#x27;, &#x27;YYYY-MM-DD&#x27;)),</span><br>    PARTITION sales_future VALUES LESS THAN (MAXVALUE)<br>);<br>分区索引示例：<br>CREATE INDEX idx_sales_date <span class="hljs-keyword">ON</span> sales (sales_date)<br>LOCAL<br>(<br>    PARTITION sales_2019,<br>    PARTITION sales_2020,<br>    PARTITION sales_future<br>);<br><br>利用 Oracle 提供的 AWK 和 ASH 性能监控工具：<br>- awk：<br>#生成 AWR 报告（默认情况下，包含最近一小时的性能数据）<br>SELECT * FROM TABLE(DBMS_WORKLOAD_REPOSITORY.AWR_REPORT_HTML);<br>#生成 AWR 报告（默认情况下，包含最近一小时的性能数据）<br>SELECT * FROM TABLE(DBMS_WORKLOAD_REPOSITORY.AWR_REPORT_HTML);<br>-ASH<br>#查询当前活动会话信息<br>SELECT * FROM V$ACTIVE_SESSION_HISTORY;<br>#查询指定时间范围内的活动会话信息<br>SELECT * FROM V$ACTIVE_SESSION_HISTORY WHERE SAMPLE_TIME BETWEEN start_time <span class="hljs-keyword">AND</span> end_time;<br>#查询特定会话 ID 的活动会话信息<br>#SELECT * FROM V$ACTIVE_SESSION_HISTORY WHERE SESSION_ID = session_id;<br><br><br>定期执行数据库统计和优化任务：<br>- 收集指定表的统计信息<br>EXEC DBMS_STATS.GATHER_TABLE_STATS(<span class="hljs-comment">&#x27;schema_name&#x27;, &#x27;table_name&#x27;);</span><br>- 收集指定索引的统计信息<br>EXEC DBMS_STATS.GATHER_INDEX_STATS(<span class="hljs-comment">&#x27;schema_name&#x27;, &#x27;index_name&#x27;);</span><br>- 查询 SQL Tuning Advisor 的优化建议<br>SELECT dbms_sqltune.report_tuning_task(<span class="hljs-comment">&#x27;task_name_here&#x27;) AS recommendations FROM dual;</span><br><br>硬件和操作系统层面的优化：<br>- 确保数据库服务器具有足够的内存、CPU 和磁盘空间<br>- 使用 RAID 和 SSD 等高性能存储来提高磁盘 I/O 性能<br>- 调整操作系统参数，以优化数据库的整体性能<br></code></pre></td></tr></table></figure><h1 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h1><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs basic"><span class="hljs-number">1</span>. 逻辑备份：<br>适用情况：逻辑备份通过导出数据库对象的逻辑结构来创建备份文件，适用于需要备份和恢复特定表、模式或数据库对象的情况。逻辑备份可以跨平台和跨版本使用。<br>操作时机：可以在数据库运行时或离线时执行逻辑备份。<br><span class="hljs-number">2</span>. 物理备份：<br>适用情况：物理备份是通过备份数据库文件（如数据文件、控制文件和日志文件）来创建备份文件，适用于整个数据库或大部分数据库的备份和恢复。物理备份可以更快速地恢复整个数据库。<br>操作时机：通常在数据库处于归档模式下时执行物理备份，以确保备份文件包含了所有的数据文件和日志文件。<br><span class="hljs-number">3</span>. 快照备份：<br>适用情况：快照备份是通过创建数据库的快照来创建备份文件，适用于需要在数据库处于运行状态下快速恢复到以前状态的情况。<br>操作时机：可以在数据库运行时创建快照备份。<br><span class="hljs-number">4</span>. 文件系统备份：<br>适用情况：文件系统备份是通过备份数据库文件所在的文件系统来创建备份文件，适用于需要完整备份数据库且数据库可以停机的情况。<br>操作时机：通常在数据库停机时执行文件系统备份。<br><br><span class="hljs-number">1</span>、物理备份：<br>创建全量备份：RMAN&gt; BACKUP DATABASE;<br>创建增量备份：RMAN&gt; BACKUP INC<span class="hljs-comment">REMENTAL LEVEL 1 DATABASE;</span><br>导出数据：<span class="hljs-keyword">exp</span> username/password@db_name file=export_file.dmp<br>导入数据：<span class="hljs-keyword">imp</span> username/password@db_name file=export_file.dmp<br><br><span class="hljs-number">2</span>、逻辑备份：<br><span class="hljs-number">1</span>. 使用 <span class="hljs-keyword">EXP</span> 和 <span class="hljs-keyword">IMP</span> 工具进行逻辑备份和还原：<br>导出数据：<span class="hljs-keyword">exp</span> username/password@db_name file=backup_file.dmp<br>导入数据：<span class="hljs-keyword">imp</span> username/password@db_name file=export_file.dmp<br><span class="hljs-number">2</span>. 使用 EXPDP 和 IMPDP 工具进行逻辑备份和还原：<br>导出数据：expdp username/password@db_name dumpfile=export_file.dmp<br>导入数据：impdp username/password@db_name dumpfile=export_file.dmp<br><br><span class="hljs-number">3</span>、快照备份：<br>登录存储设备管理界面：<br>打开浏览器，输入存储设备的管理界面地址，输入用户名和密码登录，选择要备份的存储卷或 LUN<br>，在存储设备管理界面中，找到要备份的存储卷或 LUN，选择该存储卷或 LUN，并查看相关操作选项<br>创建快照：<br>在存储设备管理界面中，找到快照功能或选项，根据提示，在选择的存储卷或 LUN 上创建一个快照，在创建快照时，确保数据库处于一致性状态，可以选择使用数据库的快照功能来确保一致性<br>备份快照：<br>在存储设备管理界面中，找到备份或复制功能，选择要备份的快照，并指定备份的目标位置（可以是备份设备、备份服务器等），根据提示完成备份操作。有些存储设备支持将快照直接复制到备份设备上，而有些需要通过网络复制到备份服务器上<br>恢复备份：<br>如果需要恢复数据库，可以在存储设备管理界面中找到快照恢复或还原功能，选择要恢复的快照，并指定恢复的目标位置（通常是一个新的存储卷或 LUN），根据提示完成恢复操作<br><br><span class="hljs-number">4</span>、文件系统备份：<br>备份控制文件：SQL&gt; ALTER DATABASE BACKUP CONTROLFILE <span class="hljs-keyword">TO</span> <span class="hljs-comment">&#x27;&lt;目标路径&gt;&#x27;;</span><br>备份归档日志：SQL&gt; ALTER <span class="hljs-keyword">SYSTEM</span> ARCHIVE <span class="hljs-keyword">LOG</span> ALL;<br></code></pre></td></tr></table></figure><h1 id="备份恢复"><a href="#备份恢复" class="headerlink" title="备份恢复"></a>备份恢复</h1><figure class="highlight basic"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs basic">备份恢复<br>完全恢复：将你的数据库恢复到宕机前最后一次提交状态<br>不完全恢复：将你的数据库恢复到你指定的某个时间点<br><br>[oracle@localhost ~]$ rman target /<br><br>RMAN&gt; backup database format <span class="hljs-comment">&#x27;/opt/oracle/oradata/orcl&#x27;;</span><br><br>#新开一个终端，进入oracle<br>[oracle@localhost orcl]$ sqlplus / as sysdba<br><br>#查看有那些名称空间<br>SQL&gt; select tablespace_name from dba_tablespaces;<br>#查看有哪些文件<br>QL&gt; select <span class="hljs-keyword">name</span> from v$datafile;<br><br>#创建表<br>SQL&gt; create table bak(id number) tablespace TABLESPACE_NAME;<br>Table created.<br>#插入数据<br>SQL&gt; insert into bak values(<span class="hljs-number">1</span>);<br><span class="hljs-symbol">1 </span>row created.<br>SQL&gt; insert into bak values(<span class="hljs-number">2</span>);<br><span class="hljs-symbol">1 </span>row created.<br>SQL&gt; insert into bak values(<span class="hljs-number">3</span>);<br><span class="hljs-symbol">1 </span>row created.<br>#commit提交<br>SQL&gt; commit;<br>#查看<br>SQL&gt; select * from bak;<br>        ID<br>----------<br>         <span class="hljs-number">1</span><br>         <span class="hljs-number">2</span><br>         <span class="hljs-number">3</span><br>         <br>#删除的是文件类型，内容不会被删除，（！和host随便用哪个），！和host代表是调用操作系统命令<br>SQL&gt;!rm -rf /opt/oracle/oradata/orcl/NAMESPACE_NAME.pdf<br>此时你再root用户下查看目录文件已经被删除了<br><br>#删除物理文件后，继续插入数据，不会报错<br>SQL&gt; insert into bak values(<span class="hljs-number">4</span>);<br><span class="hljs-symbol">1 </span>row created.<br>#验证会出错<br>SQL&gt; startup force;    这时候会报错，如<span class="hljs-number">106</span>的编号<br><br>SQL&gt; select * from v$recover_file;   #会报编号为<span class="hljs-number">106</span>号的错误<br>SQL&gt; desc v$datafile_header;<br>SQL&gt; select file#,CHECKPOINT_CHANGE# from v$datafile_header where con_id=<span class="hljs-number">1</span>;   #查看ID是不一样的<br><br>#在root用户下<br>rman target /       #进入恢复界面<br><br>#数据恢复<br>RMAN&gt; <span class="hljs-keyword">restore</span> datafile <span class="hljs-number">106</span>;<br>RMAN&gt; recover datafile <span class="hljs-number">106</span>;   #此时数据已经恢复<br><br>#验证<br>SQL&gt; select * from v$recover_file;<br>SQL&gt; select file#,CHECKPOINT_CHANGE# from v$datafile_header where con_id=<span class="hljs-number">1</span>;   #此时所有的ID都一样了<br>SQL&gt; alter database <span class="hljs-keyword">open</span>;<br>注：如果ID不一致，无法打开数据库,<span class="hljs-keyword">OPEN</span>后再打开查看ID是一致的<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>nginx部署zabbix--告警飞书</title>
    <link href="/2025/11/06/nginx%E9%83%A8%E7%BD%B2zabbix-%E5%91%8A%E8%AD%A6%E9%A3%9E%E4%B9%A6/"/>
    <url>/2025/11/06/nginx%E9%83%A8%E7%BD%B2zabbix-%E5%91%8A%E8%AD%A6%E9%A3%9E%E4%B9%A6/</url>
    
    <content type="html"><![CDATA[<h3 id="nginx部署zabbix"><a href="#nginx部署zabbix" class="headerlink" title="nginx部署zabbix"></a>nginx部署zabbix</h3><h1 id="关闭防火墙"><a href="#关闭防火墙" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">systemctl <span class="hljs-selector-tag">stop</span> firewalld<br>setenforce <span class="hljs-number">0</span><br>sed -<span class="hljs-selector-tag">i</span> <span class="hljs-string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27;</span> /etc/selinux/config<br></code></pre></td></tr></table></figure><h1 id="安装Zabbix存储库"><a href="#安装Zabbix存储库" class="headerlink" title="安装Zabbix存储库"></a>安装Zabbix存储库</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">rpm</span> -Uvh https://repo.zabbix.com/zabbix/<span class="hljs-number">5</span>.<span class="hljs-number">0</span>/rhel/<span class="hljs-number">7</span>/x86_64/zabbix-release-<span class="hljs-number">5</span>.<span class="hljs-number">0</span>-<span class="hljs-number">1</span>.el7.noarch.rpm<br><span class="hljs-attribute">yum</span> clean <span class="hljs-literal">all</span><br></code></pre></td></tr></table></figure><h1 id="安装-Zabbix-server-and-agent"><a href="#安装-Zabbix-server-and-agent" class="headerlink" title="安装 Zabbix server and agent"></a>安装 Zabbix server and agent</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">yum <span class="hljs-keyword">install </span>zabbix-server-mysql zabbix-agent -y<br>yum <span class="hljs-keyword">install </span>centos-release-<span class="hljs-keyword">scl </span>-y<br></code></pre></td></tr></table></figure><h1 id="编辑配置文件-etc-yum-repos-d-zabbix-repo-并启用zabbix前端存储库"><a href="#编辑配置文件-etc-yum-repos-d-zabbix-repo-并启用zabbix前端存储库" class="headerlink" title="编辑配置文件 &#x2F;etc&#x2F;yum.repos.d&#x2F;zabbix.repo 并启用zabbix前端存储库"></a>编辑配置文件 &#x2F;etc&#x2F;yum.repos.d&#x2F;zabbix.repo 并启用zabbix前端存储库</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">sed -<span class="hljs-selector-tag">i</span> <span class="hljs-string">&quot;11s/enabled=0/enabled=1/&quot;</span> /etc/yum<span class="hljs-selector-class">.repos</span>.d/zabbix.repo<br></code></pre></td></tr></table></figure><h1 id="安装Zabbix前端软件包"><a href="#安装Zabbix前端软件包" class="headerlink" title="安装Zabbix前端软件包"></a>安装Zabbix前端软件包</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">yum -y <span class="hljs-keyword">install </span>zabbix-web-mysql-<span class="hljs-keyword">scl </span>zabbix-nginx-conf-<span class="hljs-keyword">scl</span><br></code></pre></td></tr></table></figure><h1 id="安装数据库并设置开机自启"><a href="#安装数据库并设置开机自启" class="headerlink" title="安装数据库并设置开机自启"></a>安装数据库并设置开机自启</h1><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">yum -y install mariadb-<span class="hljs-keyword">server</span><br>systemctl <span class="hljs-keyword">start</span> mariadb &amp;&amp; systemctl <span class="hljs-keyword">enable</span> mariadb<br></code></pre></td></tr></table></figure><h1 id="初始化数据库"><a href="#初始化数据库" class="headerlink" title="初始化数据库"></a>初始化数据库</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]# mysql_secure_installation<br><br>回车<br><br>出现Set root password? [Y/n] 提示:输出Y,并设置密码<br><br>Remove anonymous <span class="hljs-built_in">users</span>? [Y/n] Y<br><br>Disallow root login remotely? [Y/n] n<br><br>Remove <span class="hljs-built_in">test</span> database and access to it? [Y/n] Y<br><br>Reload privilege tables now? [Y/n] Y<br></code></pre></td></tr></table></figure><h1 id="创建数据库，用户，允许用户远程登录"><a href="#创建数据库，用户，允许用户远程登录" class="headerlink" title="创建数据库，用户，允许用户远程登录"></a>创建数据库，用户，允许用户远程登录</h1><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">mysql -uroot -p<span class="hljs-string">&#x27;密码&#x27;</span><br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">database</span> zabbix <span class="hljs-type">character</span> <span class="hljs-keyword">set</span> utf8 <span class="hljs-keyword">collate</span> utf8_bin;<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span> zabbix@localhost identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">privileges</span> <span class="hljs-keyword">on</span> zabbix.* <span class="hljs-keyword">to</span> zabbix@<span class="hljs-string">&#x27;%&#x27;</span>;<br>flush <span class="hljs-keyword">privileges</span>;<br>\q;<br></code></pre></td></tr></table></figure><h1 id="导入初始架构和数据，系统将提示您输入新创建的密码"><a href="#导入初始架构和数据，系统将提示您输入新创建的密码" class="headerlink" title="导入初始架构和数据，系统将提示您输入新创建的密码"></a>导入初始架构和数据，系统将提示您输入新创建的密码</h1><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">zcat /usr/<span class="hljs-keyword">share</span>/doc/zabbix-<span class="hljs-keyword">server</span>-mysql*/<span class="hljs-keyword">create</span>.<span class="hljs-keyword">sql</span>.gz | mysql -uzabbix -p<span class="hljs-string">&#x27;123456&#x27;</span> zabbix<br></code></pre></td></tr></table></figure><h1 id="为Zabbix-server配置数据库，编辑配置文件-etc-zabbix-zabbix-server-conf"><a href="#为Zabbix-server配置数据库，编辑配置文件-etc-zabbix-zabbix-server-conf" class="headerlink" title="为Zabbix server配置数据库，编辑配置文件 &#x2F;etc&#x2F;zabbix&#x2F;zabbix_server.conf"></a>为Zabbix server配置数据库，编辑配置文件 &#x2F;etc&#x2F;zabbix&#x2F;zabbix_server.conf</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">sed -i <span class="hljs-string">&quot;s/# DBPassword=.*/DBPassword=123456/&quot;</span> <span class="hljs-regexp">/etc/</span>zabbix/zabbix_server.conf<br></code></pre></td></tr></table></figure><h1 id="编辑配置文件-etc-opt-rh-rh-php72-php-fpm-d-zabbix-conf-添加nginx进行监听-然后取消注释并设置正确的时区"><a href="#编辑配置文件-etc-opt-rh-rh-php72-php-fpm-d-zabbix-conf-添加nginx进行监听-然后取消注释并设置正确的时区" class="headerlink" title="编辑配置文件 &#x2F;etc&#x2F;opt&#x2F;rh&#x2F;rh-php72&#x2F;php-fpm.d&#x2F;zabbix.conf, 添加nginx进行监听,然后取消注释并设置正确的时区"></a>编辑配置文件 &#x2F;etc&#x2F;opt&#x2F;rh&#x2F;rh-php72&#x2F;php-fpm.d&#x2F;zabbix.conf, 添加nginx进行监听,然后取消注释并设置正确的时区</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">sed -i <span class="hljs-string">&quot;s/listen.acl_users = apache/listen.acl_users = apache,nginx/&quot;</span> <span class="hljs-regexp">/etc/</span>opt<span class="hljs-regexp">/rh/</span>rh-php72<span class="hljs-regexp">/php-fpm.d/</span>zabbix.conf<br>echo <span class="hljs-string">&#x27;php_value[date.timezone] = Asia/Shanghai&#x27;</span> &gt;&gt; <span class="hljs-regexp">/etc/</span>opt<span class="hljs-regexp">/rh/</span>rh-php72<span class="hljs-regexp">/php-fpm.d/</span>zabbix.conf<br></code></pre></td></tr></table></figure><h1 id="启动Zabbix-server和agent进程，并为它们设置开机自启"><a href="#启动Zabbix-server和agent进程，并为它们设置开机自启" class="headerlink" title="启动Zabbix server和agent进程，并为它们设置开机自启"></a>启动Zabbix server和agent进程，并为它们设置开机自启</h1><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">systemctl <span class="hljs-keyword">restart</span> zabbix-<span class="hljs-keyword">server</span> zabbix-agent rh-nginx116-nginx rh-php72-php-fpm<br>systemctl <span class="hljs-keyword">enable</span> zabbix-<span class="hljs-keyword">server</span> zabbix-agent rh-nginx116-nginx rh-php72-php-fpm<br></code></pre></td></tr></table></figure><h1 id="停止rh-nginx116-nginx"><a href="#停止rh-nginx116-nginx" class="headerlink" title="停止rh-nginx116-nginx"></a>停止rh-nginx116-nginx</h1><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">systemctl stop rh-nginx116-nginx <br></code></pre></td></tr></table></figure><h1 id="验证80端口还在不在，如果不在就可以安装nginx了"><a href="#验证80端口还在不在，如果不在就可以安装nginx了" class="headerlink" title="验证80端口还在不在，如果不在就可以安装nginx了"></a>验证80端口还在不在，如果不在就可以安装nginx了</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">netstat -lnpt |grep <span class="hljs-number">80</span><br>bash &lt;(curl -sSL https:<span class="hljs-regexp">//gi</span>tee.com<span class="hljs-regexp">/xbd666/</span>qingfeng<span class="hljs-regexp">/raw/</span>dev/new-toolbox.sh)<span class="hljs-comment">#下载nginx</span><br></code></pre></td></tr></table></figure><h1 id="将-etc-opt-rh-rh-nginx116-nginx-conf-d-zabbix-conf目录下的配置文件复制到nginx-conf-d目录下，创建代理文件"><a href="#将-etc-opt-rh-rh-nginx116-nginx-conf-d-zabbix-conf目录下的配置文件复制到nginx-conf-d目录下，创建代理文件" class="headerlink" title="将 &#x2F;etc&#x2F;opt&#x2F;rh&#x2F;rh-nginx116&#x2F;nginx&#x2F;conf.d&#x2F;zabbix.conf目录下的配置文件复制到nginx&#x2F;conf.d目录下，创建代理文件"></a>将 &#x2F;etc&#x2F;opt&#x2F;rh&#x2F;rh-nginx116&#x2F;nginx&#x2F;conf.d&#x2F;zabbix.conf目录下的配置文件复制到nginx&#x2F;conf.d目录下，创建代理文件</h1><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">cp</span> /etc/<span class="hljs-keyword">opt</span>/rh/rh-nginx116/nginx/<span class="hljs-keyword">conf</span>.d/zabbix.<span class="hljs-keyword">conf</span>  /etc/nginx/<span class="hljs-keyword">conf</span>.d/zabbix.<span class="hljs-keyword">conf</span><br></code></pre></td></tr></table></figure><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">vim</span> zabbix.conf<span class="hljs-comment"># 修改2处位置</span><br>server &#123;<br>        <span class="hljs-attribute">listen</span>          <span class="hljs-number">80</span>;<span class="hljs-comment"># 定义要监听的端口，可以自定义，尽量别用80，容易冲突</span><br>        <span class="hljs-attribute">server_name</span>     <span class="hljs-number">192.168.0.253</span>;<span class="hljs-comment"># 更改为本机的IP地址</span><br><br>        <span class="hljs-attribute">root</span>    /usr/share/zabbix;<br><br>        <span class="hljs-attribute">index</span>   index.php;<br><br>        <span class="hljs-section">location</span> = /favicon.ico &#123;<br>                <span class="hljs-attribute">log_not_found</span>   <span class="hljs-literal">off</span>;<br>        &#125;<br><br>        <span class="hljs-section">location</span> / &#123;<br>                <span class="hljs-attribute">try_files</span>       <span class="hljs-variable">$uri</span> <span class="hljs-variable">$uri</span>/ =<span class="hljs-number">404</span>;<br>        &#125;<br><br>        <span class="hljs-section">location</span> /assets &#123;<br>                <span class="hljs-attribute">access_log</span>      <span class="hljs-literal">off</span>;<br>                <span class="hljs-attribute">expires</span>         <span class="hljs-number">10d</span>;<br>        &#125;<br><br>        <span class="hljs-section">location</span> <span class="hljs-regexp">~ /\.ht</span> &#123;<br>                <span class="hljs-attribute">deny</span>            all;<br>        &#125;<br><br>        <span class="hljs-section">location</span> <span class="hljs-regexp">~ /(api\/|conf[^\.]|include|locale|vendor)</span> &#123;<br>                <span class="hljs-attribute">deny</span>            all;<br>                <span class="hljs-attribute">return</span>          <span class="hljs-number">404</span>;<br>        &#125;<br><br>        <span class="hljs-section">location</span> <span class="hljs-regexp">~ [^/]\.php(/|$)</span> &#123;<br>                <span class="hljs-attribute">fastcgi_pass</span>    unix:/var/opt/rh/rh-php72/run/php-fpm/zabbix.sock;<br><span class="hljs-comment">#                fastcgi_pass    unix:/var/opt/rh/rh-php73/run/php-fpm/zabbix.sock;</span><br>                <span class="hljs-attribute">fastcgi_split_path_info</span><span class="hljs-regexp"> ^(.+\.php)(/.+)$</span>;<br>                <span class="hljs-attribute">fastcgi_index</span>   index.php;<br><br>                <span class="hljs-attribute">fastcgi_param</span>   DOCUMENT_ROOT   /usr/share/zabbix;<br>                <span class="hljs-attribute">fastcgi_param</span>   SCRIPT_FILENAME /usr/share/zabbix<span class="hljs-variable">$fastcgi_script_name</span>;<br>                <span class="hljs-attribute">fastcgi_param</span>   PATH_TRANSLATED /usr/share/zabbix<span class="hljs-variable">$fastcgi_script_name</span>;<br><br>                <span class="hljs-attribute">include</span> fastcgi_params;<br>                <span class="hljs-attribute">fastcgi_param</span>   QUERY_STRING    <span class="hljs-variable">$query_string</span>;<br>                <span class="hljs-attribute">fastcgi_param</span>   REQUEST_METHOD  <span class="hljs-variable">$request_method</span>;<br>                <span class="hljs-attribute">fastcgi_param</span>   CONTENT_TYPE    <span class="hljs-variable">$content_type</span>;<br>                <span class="hljs-attribute">fastcgi_param</span>   CONTENT_LENGTH  <span class="hljs-variable">$content_length</span>;<br><br>                <span class="hljs-attribute">fastcgi_intercept_errors</span>        <span class="hljs-literal">on</span>;<br>                <span class="hljs-attribute">fastcgi_ignore_client_abort</span>     <span class="hljs-literal">off</span>;<br>                <span class="hljs-attribute">fastcgi_connect_timeout</span>         <span class="hljs-number">60</span>;<br>                <span class="hljs-attribute">fastcgi_send_timeout</span>            <span class="hljs-number">180</span>;<br>                <span class="hljs-attribute">fastcgi_read_timeout</span>            <span class="hljs-number">180</span>;<br>                <span class="hljs-attribute">fastcgi_buffer_size</span>             <span class="hljs-number">128k</span>;<br>                <span class="hljs-attribute">fastcgi_buffers</span>                 <span class="hljs-number">4</span> <span class="hljs-number">256k</span>;<br>                <span class="hljs-attribute">fastcgi_busy_buffers_size</span>       <span class="hljs-number">256k</span>;<br>                <span class="hljs-attribute">fastcgi_temp_file_write_size</span>    <span class="hljs-number">256k</span>;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h1 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h1><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">systemctl <span class="hljs-keyword">restart</span> nginx<br>systemctl <span class="hljs-keyword">restart</span> zabbix-<span class="hljs-keyword">server</span> zabbix-agent rh-php72-php-fpm<br></code></pre></td></tr></table></figure><h1 id="访问地址"><a href="#访问地址" class="headerlink" title="访问地址"></a>访问地址</h1><p><code>本机的IP+端口</code><br><code>默认 用户： Admin密码：zabbix</code></p><h1 id="agent端配置"><a href="#agent端配置" class="headerlink" title="agent端配置"></a>agent端配置</h1><h1 id="关闭防火墙-1"><a href="#关闭防火墙-1" class="headerlink" title="关闭防火墙"></a>关闭防火墙</h1><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">systemctl <span class="hljs-selector-tag">stop</span> firewalld<br>setenforce <span class="hljs-number">0</span><br>sed -<span class="hljs-selector-tag">i</span> <span class="hljs-string">&#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27;</span> /etc/selinux/config<br></code></pre></td></tr></table></figure><h1 id="安装zabbix–agent端"><a href="#安装zabbix–agent端" class="headerlink" title="安装zabbix–agent端"></a>安装zabbix–agent端</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">rpm -Uvh https:<span class="hljs-regexp">//</span>repo.zabbix.com<span class="hljs-regexp">/zabbix/</span><span class="hljs-number">5.0</span><span class="hljs-regexp">/rhel/</span><span class="hljs-number">7</span><span class="hljs-regexp">/x86_64/</span>zabbix-release-<span class="hljs-number">5.0</span>-<span class="hljs-number">1</span>.el7.noarch.rpm<br>yum install zabbix-agent zabbix-sender -y<br>cp <span class="hljs-regexp">/etc/</span>zabbix<span class="hljs-regexp">/zabbix_agentd.conf /</span>etc<span class="hljs-regexp">/zabbix/</span>zabbix_agentd.conf.bak<br></code></pre></td></tr></table></figure><h1 id="定义配置文件"><a href="#定义配置文件" class="headerlink" title="定义配置文件"></a>定义配置文件</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs routeros">vim /etc/zabbix/zabbix_agentd.conf<br><span class="hljs-attribute">server</span>=127.0.0.1# 写server端的IP<br><span class="hljs-attribute">ServerActive</span>=127.0.0.1# 写server端的IP<br><span class="hljs-attribute">Hostname</span>=test# 定义被监控端的名字<br><span class="hljs-attribute">UnsafeUserParameters</span>=0# 改为<span class="hljs-attribute">UnsafeUserParameters</span>=1<br></code></pre></td></tr></table></figure><h1 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h1><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-params">system</span>ctl start zabbix-agent &amp;&amp; <span class="hljs-params">system</span>ctl enable zabbix-agent<br></code></pre></td></tr></table></figure><p><code>此时可以去web页面去配置了</code></p><h1 id="zabbix报警飞书机器人"><a href="#zabbix报警飞书机器人" class="headerlink" title="zabbix报警飞书机器人"></a>zabbix报警飞书机器人</h1><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs abnf">飞书PC端<span class="hljs-operator">=</span><span class="hljs-operator">=</span>&gt;&gt;创建群组<br>打开群组设置<span class="hljs-operator">=</span><span class="hljs-operator">=</span>&gt;&gt;添加“自定义机器人”<br>设置机器人名称、描述，复制保存生成的webhook地址<br></code></pre></td></tr></table></figure><h1 id="创建飞书脚本文件"><a href="#创建飞书脚本文件" class="headerlink" title="创建飞书脚本文件"></a>创建飞书脚本文件</h1><p>登录zabbix服务器，进入到&#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;alertscripts&#x2F;目录，新建feishu.py文件。</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">vi</span> /usr/lib/zabbix/alertscripts/feishu.py<br>添加以下内容：<br><span class="hljs-meta">#!/usr/bin/python3</span><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> json<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">import</span> datetime<br><br><span class="hljs-title">url</span> = <span class="hljs-string">&quot;webhook地址&quot;</span> #你复制的webhook地址粘贴进url内<br><br><br><span class="hljs-title">def</span> send_message(message):<br>    payload_message = &#123;<br>        <span class="hljs-string">&quot;msg_type&quot;</span>: <span class="hljs-string">&quot;text&quot;</span>,<br>        <span class="hljs-string">&quot;content&quot;</span>: &#123;<br>            <span class="hljs-string">&quot;text&quot;</span>: message<br>        &#125;<br>    &#125;<br>    headers = &#123;<br>        &#x27;<span class="hljs-type">Content</span>-<span class="hljs-type">Type&#x27;</span>: &#x27;application/json&#x27;<br>    &#125;<br><br>    response = requests.request(<span class="hljs-string">&quot;POST&quot;</span>, url, headers=headers, <span class="hljs-class"><span class="hljs-keyword">data</span>=json.dumps(<span class="hljs-title">payload_message</span>))</span><br>    return response<br><br><br><span class="hljs-title">if</span> __name__ == &#x27;__main__&#x27;:<br>    text = sys.argv[<span class="hljs-number">1</span>]<br>    send_message(text)<br></code></pre></td></tr></table></figure><h1 id="添加执行权限"><a href="#添加执行权限" class="headerlink" title="添加执行权限"></a>添加执行权限</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">chmod +x <span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/zabbix/</span>alertscripts/feishu.py<br></code></pre></td></tr></table></figure><h1 id="添加zabbix报警媒介"><a href="#添加zabbix报警媒介" class="headerlink" title="添加zabbix报警媒介"></a>添加zabbix报警媒介</h1><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cmake">创建报警媒介类型，参数添加：&#123;ALERT.<span class="hljs-keyword">MESSAGE</span>&#125;<br>用户内添加报警媒介<br>根据需求配置需要告警的级别<br>添加完成后点击更新<br><br>名称：feishu                   <span class="hljs-comment">#名称任意</span><br>类型：脚本<br>脚本名称：feishu.py      <br>脚本参数： &#123;ALERT.<span class="hljs-keyword">MESSAGE</span>&#125;     <span class="hljs-comment">#一定要写，否则可能发送不成功</span><br></code></pre></td></tr></table></figure><h1 id="创建动作并配置"><a href="#创建动作并配置" class="headerlink" title="创建动作并配置"></a>创建动作并配置</h1><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-comment">配置</span><span class="hljs-literal">--</span><span class="hljs-comment">创建动作</span><span class="hljs-literal">--</span><span class="hljs-comment">操作（设置通知用户，触发的脚本名称，消息内容）·</span><br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs css">报警脚本：<br><br>异常通知: &#123;EVENT<span class="hljs-selector-class">.NAME</span>&#125;<br><br>告警主机:&#123;HOSTNAME1&#125;<br>告警时间:&#123;EVENT<span class="hljs-selector-class">.TIME</span>&#125;<br>告警等级:&#123;TRIGGER<span class="hljs-selector-class">.SEVERITY</span>&#125; <br>告警信息:&#123;EVENT<span class="hljs-selector-class">.NAME</span>&#125; <br>告警项目:&#123;TRIGGER<span class="hljs-selector-class">.KEY1</span>&#125; <br>问题详情:&#123;ITEM<span class="hljs-selector-class">.NAME</span>&#125;:&#123;ITEM<span class="hljs-selector-class">.VALUE</span>&#125; <br>当前状态:&#123;TRIGGER<span class="hljs-selector-class">.STATUS</span>&#125;:&#123;ITEM<span class="hljs-selector-class">.VALUE1</span>&#125; <br>事件ID:&#123;EVENT<span class="hljs-selector-class">.ID</span>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs css">恢复操作脚本：<br><br>恢复通知: &#123;EVENT<span class="hljs-selector-class">.NAME</span>&#125;<br><br>告警主机:&#123;HOSTNAME1&#125;<br>告警时间:&#123;EVENT<span class="hljs-selector-class">.TIME</span>&#125;<br>告警等级:&#123;TRIGGER<span class="hljs-selector-class">.SEVERITY</span>&#125; <br>告警信息:&#123;EVENT<span class="hljs-selector-class">.NAME</span>&#125; <br>告警项目:&#123;TRIGGER<span class="hljs-selector-class">.KEY1</span>&#125; <br>问题详情:&#123;ITEM<span class="hljs-selector-class">.NAME</span>&#125;:&#123;ITEM<span class="hljs-selector-class">.VALUE</span>&#125; <br>当前状态:&#123;TRIGGER<span class="hljs-selector-class">.STATUS</span>&#125;:&#123;ITEM<span class="hljs-selector-class">.VALUE1</span>&#125; <br>事件ID:&#123;EVENT<span class="hljs-selector-class">.ID</span>&#125;<br><br>点击保存即可<br></code></pre></td></tr></table></figure><h1 id="告警媒介测试，及常见错误处理"><a href="#告警媒介测试，及常见错误处理" class="headerlink" title="告警媒介测试，及常见错误处理"></a>告警媒介测试，及常见错误处理</h1><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">测试告警媒介<br></code></pre></td></tr></table></figure><h1 id="没问题就可以在-配置–主机–-触发器里配置了"><a href="#没问题就可以在-配置–主机–-触发器里配置了" class="headerlink" title="没问题就可以在  配置–主机– 触发器里配置了"></a>没问题就可以在  配置–主机– 触发器里配置了</h1><h1 id="常见错误："><a href="#常见错误：" class="headerlink" title="常见错误："></a>常见错误：</h1><p>1.python3路径错误</p><p>feishu.py脚本的第一句配置的python3路径不对需要手动重新手动指定</p><p>找到当前系统python3的路径替换feishu.py脚本中的第一行#!&#x2F;usr&#x2F;bin&#x2F;python3</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dts">[root@Zabbix alertscripts]<span class="hljs-meta"># whereis python3</span><br><span class="hljs-symbol">python3:</span> <span class="hljs-keyword">/usr/</span>local<span class="hljs-keyword">/bin/</span>python3<span class="hljs-number">.8</span> <span class="hljs-keyword">/usr/</span>local<span class="hljs-keyword">/bin/</span>python3<span class="hljs-number">.8</span>-config <span class="hljs-keyword">/usr/</span>local<span class="hljs-keyword">/bin/</span>python3 <span class="hljs-keyword">/usr/</span>local<span class="hljs-keyword">/lib/</span>python3<span class="hljs-number">.8</span><br></code></pre></td></tr></table></figure><p>2.python3环境没有安装requests模块,使用pip3安装requests模块</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@Zabbix</span> alertscripts]<span class="hljs-meta"># pip3 install requests</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>K8S部署gitlab-redis</title>
    <link href="/2025/11/06/K8S%E9%83%A8%E7%BD%B2gitlab-redis/"/>
    <url>/2025/11/06/K8S%E9%83%A8%E7%BD%B2gitlab-redis/</url>
    
    <content type="html"><![CDATA[<h1 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h1><p>一、概述<br>二、持久化存储安装–ebs<br>三、创建命名空间<br>四、创建文件夹，及账号密码<br>五、Postgresql部署<br>六、Redis部署<br>七、GitLab部署<br>八、命令总结<br>九、访问GitLab</p><h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>在<a href="https://so.csdn.net/so/search?q=k8s&spm=1001.2101.3001.7020">k8s</a>中部署gitlab，然后使用gitlab来实现代码打包到打镜像再到使用镜像自动生成容器服务的过程<br>用到了reids、postgresql、<a href="https://so.csdn.net/so/search?q=gitlab&spm=1001.2101.3001.7020">gitlab</a>，将三个应用配置好之后启动即可安装gitlab</p><h1 id="二、持久化存储安装–ebs"><a href="#二、持久化存储安装–ebs" class="headerlink" title="二、持久化存储安装–ebs"></a>二、持久化存储安装–ebs</h1><p>安装持久化存储工具，可以使用nfs或ebs</p><p>以ebs为例（使用起来好像简单些）</p><h2 id="1-安装ebs"><a href="#1-安装ebs" class="headerlink" title="1. 安装ebs"></a>1. 安装ebs</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f https:<span class="hljs-regexp">//</span>openebs.github.io/charts/openebs-operator.yaml<br></code></pre></td></tr></table></figure><h2 id="2-查看ebs集群服务"><a href="#2-查看ebs集群服务" class="headerlink" title="2. 查看ebs集群服务"></a>2. 查看ebs集群服务</h2><p>查看集群的StorageClass</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get sc<br></code></pre></td></tr></table></figure><h2 id="3-设置ebs为默认"><a href="#3-设置ebs为默认" class="headerlink" title="3. 设置ebs为默认"></a>3. 设置ebs为默认</h2><p>设置openobs-hostpath为default</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl patch storageclass openebs-hostpath -p <span class="hljs-string">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="4-使用ebs"><a href="#4-使用ebs" class="headerlink" title="4. 使用ebs"></a>4. 使用ebs</h2><p>在配置持久化时可根据安装的持久化工具将storageClassName参数的值填充:<br>先查看sc的名称</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get sc<br></code></pre></td></tr></table></figure><h1 id="三、创建命名空间"><a href="#三、创建命名空间" class="headerlink" title="三、创建命名空间"></a>三、创建命名空间</h1><p>在部署之前先创建一个namespace用于分类管理服务<br>创建一个名为gitlab-dev的命名空间</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl create namespace gitlab-dev<br></code></pre></td></tr></table></figure><h1 id="四、创建文件夹，及账号密码"><a href="#四、创建文件夹，及账号密码" class="headerlink" title="四、创建文件夹，及账号密码"></a>四、创建文件夹，及账号密码</h1><p>分别创建gitlab目录，存储账号和密码的文件</p><h2 id="账号文件username，用于存储账号信息"><a href="#账号文件username，用于存储账号信息" class="headerlink" title="账号文件username，用于存储账号信息"></a>账号文件username，用于存储账号信息</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-keyword">mkdir</span> /opt/k8s/gitlab-yaml<br>echo -n <span class="hljs-string">&quot;gitlab-admin&quot;</span> &gt; ./username<br></code></pre></td></tr></table></figure><h2 id="密码文件password，用于存储密码信息"><a href="#密码文件password，用于存储密码信息" class="headerlink" title="密码文件password，用于存储密码信息"></a>密码文件password，用于存储密码信息</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">echo -n <span class="hljs-string">&quot;gitlab.123&quot;</span> &gt; ./password<br></code></pre></td></tr></table></figure><h2 id="查看文件-文件内容"><a href="#查看文件-文件内容" class="headerlink" title="查看文件&#x2F;文件内容"></a>查看文件&#x2F;文件内容</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">ls<br>cat ./username<br>cat ./password<br></code></pre></td></tr></table></figure><h2 id="secret对象生成"><a href="#secret对象生成" class="headerlink" title="secret对象生成"></a>secret对象生成</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl create secret generic git-user-pass --from-file=./username --from-file=./password -n gitlab-dev<br><br></code></pre></td></tr></table></figure><h2 id="查看secret"><a href="#查看secret" class="headerlink" title="查看secret"></a>查看secret</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl -n gitlab-dev get secret git-user-pass -o yaml<br></code></pre></td></tr></table></figure><h2 id="拓展：如果创建错误或者想重新创建secret，则需先删除"><a href="#拓展：如果创建错误或者想重新创建secret，则需先删除" class="headerlink" title="拓展：如果创建错误或者想重新创建secret，则需先删除"></a><strong>拓展：</strong>如果创建错误或者想重新创建secret，则需先删除</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl <span class="hljs-keyword">delete</span> secret git-user-pass -n gitlab-dev<br></code></pre></td></tr></table></figure><h1 id="五、Postgresql部署"><a href="#五、Postgresql部署" class="headerlink" title="五、Postgresql部署"></a>五、Postgresql部署</h1><p>为了方便管理以及后续修改更新文件，本篇对每个结构部分都创建一个yaml文件，且创建的文件都放在当前目录下的gitlab-yaml文件夹下，后续redis和gitlab的部分与此相同</p><p>参数：<br>pgs：Postgresql<br>dplm：Deployment<br>pvc：PersistentVolumeClaim<br>svc：Service</p><h2 id="1-持久化配置创建–pvc"><a href="#1-持久化配置创建–pvc" class="headerlink" title="1.持久化配置创建–pvc"></a>1.持久化配置创建–pvc</h2><h3 id="创建文件pgs-pvc-yaml"><a href="#创建文件pgs-pvc-yaml" class="headerlink" title="创建文件pgs-pvc.yaml"></a>创建文件pgs-pvc.yaml</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim ./gitlab-yaml/pgs-pvc.yaml<br></code></pre></td></tr></table></figure><h3 id="将以下内容复制粘贴到文件中"><a href="#将以下内容复制粘贴到文件中" class="headerlink" title="将以下内容复制粘贴到文件中"></a>将以下内容复制粘贴到文件中</h3><p>注：其中name可自定义，namespace前面创建了gitlab-dev</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs perl">apiVersion: <span class="hljs-number">v1</span><br>kind: PersistentVolumeClaim<br>metadata:<br>  name: pgs-pvc<br>  namespace: gitlab-dev<br>spec:<br>  accessModes:<br>    - ReadWriteOnce<br>  storageClassName: openebs-hostpath<br>  resources:<br>    requests:<br>      storage: 1Gi<br></code></pre></td></tr></table></figure><h3 id="部署命令"><a href="#部署命令" class="headerlink" title="部署命令"></a>部署命令</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/pgs-pvc.yaml<br></code></pre></td></tr></table></figure><h3 id="查看创建的服务"><a href="#查看创建的服务" class="headerlink" title="查看创建的服务"></a>查看创建的服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get pvc -n gitlab-dev pgs-pvc<br></code></pre></td></tr></table></figure><h2 id="2-部署配置–deployment"><a href="#2-部署配置–deployment" class="headerlink" title="2. 部署配置–deployment"></a>2. 部署配置–deployment</h2><h3 id="创建文件pgs-dplm-yaml"><a href="#创建文件pgs-dplm-yaml" class="headerlink" title="创建文件pgs-dplm.yaml"></a>创建文件pgs-dplm.yaml</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">vim .<span class="hljs-regexp">/gitlab-yaml/</span>pgs-dplm.yaml<br></code></pre></td></tr></table></figure><h3 id="将以下内容复制粘贴到文件中-1"><a href="#将以下内容复制粘贴到文件中-1" class="headerlink" title="将以下内容复制粘贴到文件中"></a>将以下内容复制粘贴到文件中</h3><p>注：nodeSelector的key的值就是namespace，最后的claimName的值是持久化配置文件的名称pgs-pvc</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><code class="hljs perl">apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  name: postgresql<br>  namespace: gitlab-dev<br>  labels:<br>    name: postgresql<br>spec:<br>  replicas: <span class="hljs-number">1</span><br>  selector:<br>    matchLabels:<br>      name: postgresql<br>  template:<br>    metadata:<br>      name: postgresql<br>      labels:<br>        name: postgresql<br>    spec:<br><span class="hljs-comment">#     tolerations:             # 添加的容忍污点，到下面300结束</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br>      <span class="hljs-comment">#nodeSelector:</span><br>        <span class="hljs-comment">#key: gitlab-dev</span><br>      containers:<br>        - name: postgresql<br>          image: sameersbn/postgresql<br>          imagePullPolicy: IfNotPresent<br>          env:<br>            - name: DB_USER<br>              value: gitlab<br>            - name: DB_PASS<br>              value: passw0rd<br>            - name: DB_NAME<br>              value: gitlab_production<br>            - name: DB_EXTENSION<br>              value: pg_trgm<br>          ports:<br>            - name: postgres<br>              containerPort: <span class="hljs-number">5432</span><br>          volumeMounts:<br>            - mountPath: <span class="hljs-regexp">/var/li</span>b/postgresql<br>              name: data<br>          livenessProbe:<br>            <span class="hljs-keyword">exec</span>:<br>              command:<br>                - pg_isready<br>                - -h<br>                - localhost<br>                - -U<br>                - postgres<br>            initialDelaySeconds: <span class="hljs-number">30</span><br>            timeoutSeconds: <span class="hljs-number">5</span><br>          readinessProbe:<br>            <span class="hljs-keyword">exec</span>:<br>              command:<br>                - pg_isready<br>                - -h<br>                - localhost<br>                - -U<br>                - postgres<br>            initialDelaySeconds: <span class="hljs-number">5</span><br>            timeoutSeconds: <span class="hljs-number">1</span><br>      volumes:<br>        - name: data<br>          persistentVolumeClaim:<br>            claimName: pgs-pvc<br></code></pre></td></tr></table></figure><h3 id="部署命令-1"><a href="#部署命令-1" class="headerlink" title="部署命令"></a>部署命令</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/pgs-dplm.yaml<br></code></pre></td></tr></table></figure><h3 id="查看已创建的服务"><a href="#查看已创建的服务" class="headerlink" title="查看已创建的服务"></a>查看已创建的服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get pod -n gitlab-dev<br><br>[root<span class="hljs-variable">@master</span> gitlab-yaml]<span class="hljs-comment"># kubectl get pod -n gitlab-dev</span><br>NAME                         READY   STATUS    RESTARTS      AGE<br>postgresql-bddc8596d-qxpgz   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">2</span> (22m ago)   3h33m<br></code></pre></td></tr></table></figure><h2 id="3-服务配置–svc"><a href="#3-服务配置–svc" class="headerlink" title="3. 服务配置–svc"></a>3. 服务配置–svc</h2><h3 id="创建文件pgs-svc-yaml"><a href="#创建文件pgs-svc-yaml" class="headerlink" title="创建文件pgs-svc.yaml"></a>创建文件pgs-svc.yaml</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim ./gitlab-yaml/pgs-svc.yaml<br></code></pre></td></tr></table></figure><h3 id="将以下内容复制粘贴到文件中-2"><a href="#将以下内容复制粘贴到文件中-2" class="headerlink" title="将以下内容复制粘贴到文件中"></a>将以下内容复制粘贴到文件中</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs perl">apiVersion: <span class="hljs-number">v1</span><br>kind: Service<br>metadata:<br>  name: postgresql<br>  namespace: gitlab-dev<br>  labels:<br>    name: postgresql<br>spec:<br>  ports:<br>    - name: postgres<br>      port: <span class="hljs-number">5432</span><br>      targetPort: postgres<br>  selector:<br>    name: postgresql<br></code></pre></td></tr></table></figure><h3 id="查看已部署的服务"><a href="#查看已部署的服务" class="headerlink" title="查看已部署的服务"></a>查看已部署的服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get svc -n gitlab-dev<br><br>[root<span class="hljs-variable">@master</span> gitlab-yaml]<span class="hljs-comment"># kubectl get svc -n gitlab-dev</span><br>NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                     AGE<br>postgresql   ClusterIP   <span class="hljs-number">10.104</span><span class="hljs-number">.67</span><span class="hljs-number">.253</span>    &lt;none&gt;        <span class="hljs-number">5432</span>/TCP                    3h31m<br><br></code></pre></td></tr></table></figure><h1 id="六、Redis部署"><a href="#六、Redis部署" class="headerlink" title="六、Redis部署"></a>六、Redis部署</h1><p>数据缓存redis</p><h2 id="1-持久化配置–pvc"><a href="#1-持久化配置–pvc" class="headerlink" title="1. 持久化配置–pvc"></a>1. 持久化配置–pvc</h2><h3 id="创建文件redis-pvc-yaml"><a href="#创建文件redis-pvc-yaml" class="headerlink" title="创建文件redis-pvc.yaml"></a>创建文件redis-pvc.yaml</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim ./gitlab-yaml/redis-pvc.yaml<br></code></pre></td></tr></table></figure><h3 id="将以下内容复制粘贴到文件中-3"><a href="#将以下内容复制粘贴到文件中-3" class="headerlink" title="将以下内容复制粘贴到文件中"></a>将以下内容复制粘贴到文件中</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs perl">apiVersion: <span class="hljs-number">v1</span><br>kind: PersistentVolumeClaim<br>metadata:<br>  name: redis-pvc<br>  namespace: gitlab-dev<br>spec:<br>  accessModes:<br>    - ReadWriteOnce<br>  storageClassName: openebs-hostpath<br>  resources:<br>    requests:<br>      storage: 1Gi<br></code></pre></td></tr></table></figure><h3 id="部署服务"><a href="#部署服务" class="headerlink" title="部署服务"></a>部署服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/redis-pvc.yaml<br></code></pre></td></tr></table></figure><h3 id="查看已部署的服务-1"><a href="#查看已部署的服务-1" class="headerlink" title="查看已部署的服务"></a>查看已部署的服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get pvc -n gitlab-dev redis-pvc<br></code></pre></td></tr></table></figure><h2 id="2-部署配置–deployment-1"><a href="#2-部署配置–deployment-1" class="headerlink" title="2. 部署配置–deployment"></a>2. 部署配置–deployment</h2><h3 id="创建redis-dplm-yaml文件"><a href="#创建redis-dplm-yaml文件" class="headerlink" title="创建redis-dplm.yaml文件"></a>创建redis-dplm.yaml文件</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim ./gitlab-yaml/redis-dplm.yaml<br></code></pre></td></tr></table></figure><h3 id="将以下内容复制粘贴到文件中-4"><a href="#将以下内容复制粘贴到文件中-4" class="headerlink" title="将以下内容复制粘贴到文件中"></a>将以下内容复制粘贴到文件中</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs perl">apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  name: redis<br>  namespace: gitlab-dev<br>  labels:<br>    name: redis<br>spec:<br>  replicas: <span class="hljs-number">2</span><br>  selector:<br>    matchLabels:<br>      name: redis<br>  template:<br>    metadata:<br>      name: redis<br>      labels:<br>        name: redis<br>    spec:<br><span class="hljs-comment">#     tolerations:             # 添加的容忍污点，到下面300结束</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br>      <span class="hljs-comment">#nodeSelector:</span><br>        <span class="hljs-comment">#key: gitlab-dev</span><br>      containers:<br>        - name: redis<br>          image: sameersbn/redis<br>          imagePullPolicy: IfNotPresent<br>          ports:<br>            - name: redis<br>              containerPort: <span class="hljs-number">6379</span><br>          volumeMounts:<br>            - mountPath: <span class="hljs-regexp">/var/li</span>b/redis<br>              name: data<br>          livenessProbe:<br>            <span class="hljs-keyword">exec</span>:<br>              command:<br>                - redis-cli<br>                - ping<br>            initialDelaySeconds: <span class="hljs-number">30</span><br>            timeoutSeconds: <span class="hljs-number">5</span><br>          readinessProbe:<br>            <span class="hljs-keyword">exec</span>:<br>              command:<br>                - redis-cli<br>                - ping<br>            initialDelaySeconds: <span class="hljs-number">5</span><br>            timeoutSeconds: <span class="hljs-number">1</span><br>      volumes:<br>        - name: data<br>          persistentVolumeClaim:<br>            claimName: redis-pvc<br></code></pre></td></tr></table></figure><h3 id="部署服务-1"><a href="#部署服务-1" class="headerlink" title="部署服务"></a>部署服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/redis-dplm.yaml<br></code></pre></td></tr></table></figure><h3 id="查看已部署的服务-2"><a href="#查看已部署的服务-2" class="headerlink" title="查看已部署的服务"></a>查看已部署的服务</h3><p>因为文件中配置的副本数为2，故生成了两个redis的pod</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get pod -n gitlab-dev<br><br>[root<span class="hljs-variable">@master</span> gitlab-yaml]<span class="hljs-comment"># kubectl get pod -n gitlab-dev</span><br>NAME                         READY   STATUS    RESTARTS      AGE<br>gitlab-955db8d9f-vp8zk       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">1</span> (21m ago)   32m<br>postgresql-bddc8596d-qxpgz   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">2</span> (22m ago)   3h33m<br>redis-56d5499794-clpkv       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">1</span> (35m ago)   3h26m<br>redis-56d5499794-gr977       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">1</span> (35m ago)   3h26m<br></code></pre></td></tr></table></figure><h2 id="3-服务配置–svc-1"><a href="#3-服务配置–svc-1" class="headerlink" title="3. 服务配置–svc"></a>3. 服务配置–svc</h2><h3 id="创建文件redis-svc-yaml"><a href="#创建文件redis-svc-yaml" class="headerlink" title="创建文件redis-svc.yaml"></a>创建文件redis-svc.yaml</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim ./gitlab-yaml/redis-svc.yaml<br></code></pre></td></tr></table></figure><h3 id="将一下内容复制粘贴进文件中"><a href="#将一下内容复制粘贴进文件中" class="headerlink" title="将一下内容复制粘贴进文件中"></a>将一下内容复制粘贴进文件中</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs perl">apiVersion: <span class="hljs-number">v1</span><br>kind: Service<br>metadata:<br>  name: redis-svc<br>  namespace: gitlab-dev<br>  labels:<br>    name: redis-svc<br>spec:<br>  ports:<br>    - name: redis<br>      port: <span class="hljs-number">6379</span><br>      targetPort: redis<br>  selector:<br>    name: redis<br></code></pre></td></tr></table></figure><h3 id="部署服务-2"><a href="#部署服务-2" class="headerlink" title="部署服务"></a>部署服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get svc -n gitlab-dev redis-svc<br><br>[root<span class="hljs-variable">@master</span> gitlab-yaml]<span class="hljs-comment"># kubectl get svc -n gitlab-dev redis-svc</span><br>NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE<br>redis-svc   ClusterIP   <span class="hljs-number">10.104</span><span class="hljs-number">.35</span><span class="hljs-number">.113</span>   &lt;none&gt;        <span class="hljs-number">6379</span>/TCP   3h33m<br></code></pre></td></tr></table></figure><h1 id="七、GitLab部署"><a href="#七、GitLab部署" class="headerlink" title="七、GitLab部署"></a>七、GitLab部署</h1><h2 id="持久化配置–pvc"><a href="#持久化配置–pvc" class="headerlink" title="持久化配置–pvc"></a>持久化配置–pvc</h2><h3 id="创建文件gitlab-pvc-yaml"><a href="#创建文件gitlab-pvc-yaml" class="headerlink" title="创建文件gitlab-pvc.yaml"></a>创建文件gitlab-pvc.yaml</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim ./gitlab-yaml/gitlab-pvc.yaml<br></code></pre></td></tr></table></figure><h3 id="将以下内容复制粘贴到文件中-5"><a href="#将以下内容复制粘贴到文件中-5" class="headerlink" title="将以下内容复制粘贴到文件中"></a>将以下内容复制粘贴到文件中</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs perl">apiVersion: <span class="hljs-number">v1</span><br>kind: PersistentVolumeClaim<br>metadata:<br>  name: gitlab-pvc<br>  namespace: gitlab-dev<br>spec:<br>  accessModes:<br>    - ReadWriteOnce<br>  storageClassName: openebs-hostpath<br>  resources:<br>    requests:<br>      storage: 5Gi<br></code></pre></td></tr></table></figure><h3 id="部署服务-3"><a href="#部署服务-3" class="headerlink" title="部署服务"></a>部署服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/gitlab-pvc.yaml<br></code></pre></td></tr></table></figure><h2 id="2-部署配置–deployment-2"><a href="#2-部署配置–deployment-2" class="headerlink" title="2. 部署配置–deployment"></a>2. 部署配置–deployment</h2><p>gitlab-ce-15.6.0-ce.0     gitlab-ce-14.0.0-ce.0</p><p>本篇以gitlab-ce-15.6.0-ce.0为例</p><h3 id="创建文件gitlab-dplm-yaml"><a href="#创建文件gitlab-dplm-yaml" class="headerlink" title="创建文件gitlab-dplm.yaml"></a>创建文件gitlab-dplm.yaml</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim ./gitlab-yaml/gitlab-dplm.yaml<br></code></pre></td></tr></table></figure><h3 id="将一下内容复制粘贴到文件中"><a href="#将一下内容复制粘贴到文件中" class="headerlink" title="将一下内容复制粘贴到文件中"></a>将一下内容复制粘贴到文件中</h3><p><code>GITLAB_ROOT_PASSWORD</code> 密码部分，可以直接将值设为密码，这里从第二章中设置的密码文件中读取<br><code>GITLAB_ROOT_EMAIL</code> 邮箱部分，自定义即可<br><code>GITLAB_HOST</code> 主机地址，可自定义</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs perl">apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  name: gitlab<br>  namespace: gitlab-dev<br>  labels:<br>    name: gitlab<br>spec:<br>  replicas: <span class="hljs-number">1</span><br>  selector:<br>    matchLabels:<br>      name: gitlab<br>  template:<br>    metadata:<br>      name: gitlab<br>      labels:<br>        name: gitlab<br>    spec:<br><span class="hljs-comment">#     tolerations:             # 添加的容忍污点，到下面300结束</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br>      <span class="hljs-comment">#nodeSelector:</span><br>        <span class="hljs-comment">#key: gitlab-dev</span><br>      containers:<br>        - name: gitlab<br>          <span class="hljs-comment"># image: sameersbn/gitlab:12.1.6</span><br>          image: gitlab/gitlab-ce:<span class="hljs-number">15.6</span>.<span class="hljs-number">0</span>-ce.<span class="hljs-number">0</span><br>          <span class="hljs-comment"># command: [&quot;/bin/bash&quot;,&quot;-ce&quot;,&quot;tail -f /dev/null&quot;]</span><br>          imagePullPolicy: IfNotPresent<br>          env:<br>            - name: TZ<br>              value: Asia/Shanghai<br>            - name: GITLAB_TIMEZONE<br>              value: Beijing<br>            - name: GITLAB_SECRETS_DB_KEY_BASE<br>              value: long-<span class="hljs-keyword">and</span>-random-alpha-numeric-string<br>            - name: GITLAB_SECRETS_SECRET_KEY_BASE<br>              value: long-<span class="hljs-keyword">and</span>-random-alpha-numeric-string<br>            - name: GITLAB_SECRETS_OTP_KEY_BASE<br>              value: long-<span class="hljs-keyword">and</span>-random-alpha-numeric-string<br>            - name: GITLAB_ROOT_PASSWORD<br>              <span class="hljs-comment">#value: admin321</span><br>              valueFrom:<br>                secretKeyRef:<br>                  name: git-user-pass<br>                  key: password<br>            - name: GITLAB_ROOT_EMAIL<br>              value: hslb<span class="hljs-variable">@163</span>.com<br>            - name: GITLAB_HOST<br>              value: gitlab.hslb.com<br>            - name: GITLAB_PORT<br>              value: <span class="hljs-string">&quot;30021&quot;</span><br>            - name: GITLAB_SSH_PORT<br>              value: <span class="hljs-string">&quot;30022&quot;</span><br>            - name: GITLAB_NOTIFY_ON_BROKEN_BUILDS<br>              value: <span class="hljs-string">&quot;true&quot;</span><br>            - name: GITLAB_NOTIFY_PUSHER<br>              value: <span class="hljs-string">&quot;false&quot;</span><br>            - name: GITLAB_BACKUP_SCHEDULE<br>              value: daily<br>            - name: GITLAB_BACKUP_TIME<br>              value: <span class="hljs-number">01</span>:<span class="hljs-number">00</span><br>            - name: DB_TYPE<br>              value: postgres<br>            - name: DB_HOST<br>              value: postgresql<br>            - name: DB_PORT<br>              value: <span class="hljs-string">&quot;5432&quot;</span><br>            - name: DB_USER<br>              value: gitlab<br>            - name: DB_PASS<br>              value: passw0rd<br>            - name: DB_NAME<br>              value: gitlab_production<br>            - name: REDIS_HOST<br>              value: redis<br>            - name: REDIS_PORT<br>              value: <span class="hljs-string">&quot;6379&quot;</span><br>          ports:<br>            - name: http<br>              containerPort: <span class="hljs-number">80</span><br>            - name: ssh<br>              containerPort: <span class="hljs-number">22</span><br>          volumeMounts:<br>            - mountPath: <span class="hljs-regexp">/home/gi</span>t/data<br>              name: data<br>          livenessProbe:<br>            httpGet:<br>              path: <span class="hljs-regexp">/</span><br><span class="hljs-regexp">              port: 80</span><br><span class="hljs-regexp">            initialDelaySeconds: 180</span><br><span class="hljs-regexp">            timeoutSeconds: 5</span><br><span class="hljs-regexp">          readinessProbe:</span><br><span class="hljs-regexp">            httpGet:</span><br><span class="hljs-regexp">              path: /</span><br>              port: <span class="hljs-number">80</span><br>            initialDelaySeconds: <span class="hljs-number">180</span><br>            timeoutSeconds: <span class="hljs-number">5</span><br>      volumes:<br>        - name: data<br>          persistentVolumeClaim:<br>            claimName: gitlab-pvc<br></code></pre></td></tr></table></figure><h3 id="部署服务-4"><a href="#部署服务-4" class="headerlink" title="部署服务"></a>部署服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/gitlab-dplm.yaml<br></code></pre></td></tr></table></figure><h3 id="查看已部署的服务-3"><a href="#查看已部署的服务-3" class="headerlink" title="查看已部署的服务"></a>查看已部署的服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get pod -n gitlab-dev -o wide<br><br>[root<span class="hljs-variable">@master</span> gitlab-yaml]<span class="hljs-comment"># kubectl get pod -n gitlab-dev -o wide</span><br>NAME                         READY   STATUS    RESTARTS      AGE     IP            NODE     NOMINATED NODE   READINESS GATES<br>gitlab-955db8d9f-vp8zk       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">1</span> (36m ago)   47m     <span class="hljs-number">10.244</span>.<span class="hljs-number">1.27</span>   node01   &lt;none&gt;           &lt;none&gt;<br>postgresql-bddc8596d-qxpgz   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">2</span> (36m ago)   3h47m   <span class="hljs-number">10.244</span>.<span class="hljs-number">1.23</span>   node01   &lt;none&gt;           &lt;none&gt;<br>redis-56d5499794-clpkv       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">1</span> (50m ago)   3h40m   <span class="hljs-number">10.244</span>.<span class="hljs-number">2.13</span>   node02   &lt;none&gt;           &lt;none&gt;<br>redis-56d5499794-gr977       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">1</span> (50m ago)   3h40m   <span class="hljs-number">10.244</span>.<span class="hljs-number">2.11</span>   node02   &lt;none&gt;           &lt;none&gt;<br></code></pre></td></tr></table></figure><p>注：如果k8s部署gitlab服务时出现pod状态为<code>Running</code>，Ready状态一直为<code>0/1</code>，重启一定次数后pod状态变为<code>CrashLoopBackOff</code></p><p>查看pod详细信息时看到的message为 Readiness probe failed: Get “<a href="http://10.244.0.8/">http://10.244.0.8:80/</a>“: dial tcp 10.244.0.8:80: connect: connection refused</p><h3 id="解决方案："><a href="#解决方案：" class="headerlink" title="解决方案："></a>解决方案：</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs per">删除原有gitlab对应的pod<br>kubectl delete deployment gitlab -n gitlab-dev<br>修改yaml文件镜像参数使用别的版本镜像<br>vim ./gitlab-yaml/gitlab-dplm.yaml<br><br>将镜像版本改为gitlab/gitlab-ce:14.0.0-ce.0<br>或者gitlab/gitlab-ce:15.6.0-ce.0<br>重新应用yaml<br>kubectl apply -f ./gitlab-yaml/gitlab-dplm.yaml<br></code></pre></td></tr></table></figure><h2 id="3-服务配置"><a href="#3-服务配置" class="headerlink" title="3. 服务配置"></a>3. 服务配置</h2><h3 id="创建文件gitlab-svc-yaml"><a href="#创建文件gitlab-svc-yaml" class="headerlink" title="创建文件gitlab-svc.yaml"></a>创建文件gitlab-svc.yaml</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim ./gitlab-yaml/gitlab-svc.yaml<br></code></pre></td></tr></table></figure><h3 id="将以下内容复制粘贴到文件中-6"><a href="#将以下内容复制粘贴到文件中-6" class="headerlink" title="将以下内容复制粘贴到文件中"></a>将以下内容复制粘贴到文件中</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs perl">apiVersion: <span class="hljs-number">v1</span><br>kind: Service<br>metadata:<br>  name: gitlab<br>  namespace: gitlab-dev<br>  labels:<br>    name: gitlab<br>spec:<br>  ports:<br>    - name: http<br>      port: <span class="hljs-number">80</span><br>      targetPort: http<br>      nodePort: <span class="hljs-number">30021</span><br>    - name: ssh<br>      port: <span class="hljs-number">22</span><br>      targetPort: ssh<br>      nodePort: <span class="hljs-number">30022</span><br>  selector:<br>    name: gitlab<br>  type: NodePort<br></code></pre></td></tr></table></figure><h3 id="部署服务-5"><a href="#部署服务-5" class="headerlink" title="部署服务"></a>部署服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/gitlab-svc.yaml<br></code></pre></td></tr></table></figure><h3 id="查看已部署的服务-4"><a href="#查看已部署的服务-4" class="headerlink" title="查看已部署的服务"></a>查看已部署的服务</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get svc -n gitlab-dev<br></code></pre></td></tr></table></figure><p><code>以上就是redis、postgresql、gitlab三个部分的部署</code></p><h1 id="八、命令总结"><a href="#八、命令总结" class="headerlink" title="八、命令总结"></a>八、命令总结</h1><p>如果出现问题需要删除创建的服务，可参考以下命令</p><h2 id="1-部署pvc"><a href="#1-部署pvc" class="headerlink" title="1.部署pvc"></a>1.部署pvc</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/pgs-pvc.yaml<br>kubectl apply -f ./gitlab-yaml/redis-pvc.yaml<br>kubectl apply -f ./gitlab-yaml/gitlab-pvc.yaml<br></code></pre></td></tr></table></figure><h2 id="2-查看pvc"><a href="#2-查看pvc" class="headerlink" title="2. 查看pvc"></a>2. 查看pvc</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get pvc -n gitlab-dev<br></code></pre></td></tr></table></figure><h2 id="3-删除指定pvc"><a href="#3-删除指定pvc" class="headerlink" title="3. 删除指定pvc"></a>3. 删除指定pvc</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl <span class="hljs-keyword">delete</span> pvc pgs-pvc -n gitlab-dev<br></code></pre></td></tr></table></figure><h2 id="4-部署pod"><a href="#4-部署pod" class="headerlink" title="4. 部署pod"></a>4. 部署pod</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/pgs-dplm.yaml<br>kubectl apply -f ./gitlab-yaml/redis-dplm.yaml<br>kubectl apply -f ./gitlab-yaml/gitlab-dplm.yaml<br></code></pre></td></tr></table></figure><h2 id="5-查看pod"><a href="#5-查看pod" class="headerlink" title="5. 查看pod"></a>5. 查看pod</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get pod -n gitlab-dev<br></code></pre></td></tr></table></figure><h2 id="6-删除pod"><a href="#6-删除pod" class="headerlink" title="6. 删除pod"></a>6. 删除pod</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 删除无副本设置的pod</span><br>kubectl <span class="hljs-keyword">delete</span> pod postgresql -n gitlab-dev<br><br><span class="hljs-comment"># 删除设置副本的pod</span><br>kubectl <span class="hljs-keyword">delete</span> deployment postgresql -n gitlab-dev<br></code></pre></td></tr></table></figure><h2 id="7-部署svc"><a href="#7-部署svc" class="headerlink" title="7. 部署svc"></a>7. 部署svc</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f ./gitlab-yaml/pgs-svc.yaml<br>kubectl apply -f ./gitlab-yaml/redis-svc.yaml<br>kubectl apply -f ./gitlab-yaml/gitlab-svc.yaml<br></code></pre></td></tr></table></figure><h2 id="8-查看svc"><a href="#8-查看svc" class="headerlink" title="8. 查看svc"></a>8. 查看svc</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get svc -n gitlab-dev<br></code></pre></td></tr></table></figure><h2 id="9-删除指定svc"><a href="#9-删除指定svc" class="headerlink" title="9. 删除指定svc"></a>9. 删除指定svc</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl <span class="hljs-keyword">delete</span> svc postgresql -n gitlab-dev<br></code></pre></td></tr></table></figure><h1 id="九、访问GitLab"><a href="#九、访问GitLab" class="headerlink" title="九、访问GitLab"></a>九、访问GitLab</h1><h2 id="1-访问地址"><a href="#1-访问地址" class="headerlink" title="1. 访问地址"></a>1. 访问地址</h2><p>首先根据自己的服务查看服务所在节点<br>然后使用 节点ip+端口 即可访问</p><h3 id="查看gitlab的pod部署在哪个节点"><a href="#查看gitlab的pod部署在哪个节点" class="headerlink" title="查看gitlab的pod部署在哪个节点"></a>查看gitlab的pod部署在哪个节点</h3><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs q">kubectl <span class="hljs-built_in">get</span> pod -n gitlab-<span class="hljs-built_in">dev</span> -o wide<br></code></pre></td></tr></table></figure><h3 id="节点在node01"><a href="#节点在node01" class="headerlink" title="节点在node01"></a>节点在node01</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> gitlab-yaml]<span class="hljs-comment"># kubectl get pod -n gitlab-dev -o wide</span><br>NAME                         READY   STATUS    RESTARTS      AGE     IP            NODE     NOMINATED NODE   READINESS GATES<br>gitlab-955db8d9f-vp8zk       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">2</span> (51s ago)   65m     <span class="hljs-number">10.244</span>.<span class="hljs-number">1.27</span>   node01   &lt;none&gt;           &lt;none&gt;<br>postgresql-bddc8596d-qxpgz   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">2</span> (55m ago)   4h6m    <span class="hljs-number">10.244</span>.<span class="hljs-number">1.23</span>   node01   &lt;none&gt;           &lt;none&gt;<br>redis-56d5499794-clpkv       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">1</span> (68m ago)   3h59m   <span class="hljs-number">10.244</span>.<span class="hljs-number">2.13</span>   node02   &lt;none&gt;           &lt;none&gt;<br>redis-56d5499794-gr977       <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">1</span> (68m ago)   3h59m   <span class="hljs-number">10.244</span>.<span class="hljs-number">2.11</span>   node02   &lt;none&gt;           &lt;none&gt;<br></code></pre></td></tr></table></figure><h3 id="查看gitlab服务映射的端口"><a href="#查看gitlab服务映射的端口" class="headerlink" title="查看gitlab服务映射的端口"></a>查看gitlab服务映射的端口</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">kubectl</span> <span class="hljs-meta">get</span> <span class="hljs-keyword">svc</span> -n gitlab-dev -o wide<br></code></pre></td></tr></table></figure><h3 id="映射的端口为30021"><a href="#映射的端口为30021" class="headerlink" title="映射的端口为30021"></a>映射的端口为30021</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> gitlab-yaml]<span class="hljs-comment"># kubectl get svc -n gitlab-dev -o wide</span><br>NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                     AGE     SELECTOR<br>gitlab       NodePort    <span class="hljs-number">10.110</span><span class="hljs-number">.192</span><span class="hljs-number">.219</span>   &lt;none&gt;        <span class="hljs-number">80</span>:<span class="hljs-number">30021</span>/TCP,<span class="hljs-number">22</span>:<span class="hljs-number">30022</span>/TCP   3h25m   name=gitlab<br>postgresql   ClusterIP   <span class="hljs-number">10.104</span><span class="hljs-number">.67</span><span class="hljs-number">.253</span>    &lt;none&gt;        <span class="hljs-number">5432</span>/TCP                    4h2m    name=postgresql<br>redis-svc    ClusterIP   <span class="hljs-number">10.104</span><span class="hljs-number">.35</span><span class="hljs-number">.113</span>    &lt;none&gt;        <span class="hljs-number">6379</span>/TCP                    3h56m   name=redis<br></code></pre></td></tr></table></figure><h2 id="2-访问gitlab"><a href="#2-访问gitlab" class="headerlink" title="2. 访问gitlab"></a>2. 访问gitlab</h2><p><code>访问网址gitlab服务所在节点ip:30021</code></p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs perl">注意，账号为root<br>密码为之前设置的gitlab<span class="hljs-number">.123</span><br>这里有个地方有点无语，我之前设置的账号为gitlab-admin<br>使用这个账号登录不进去，必须换成root<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>K8S部署nacos服务</title>
    <link href="/2025/11/06/K8S%E9%83%A8%E7%BD%B2nacos%E6%9C%8D%E5%8A%A1/"/>
    <url>/2025/11/06/K8S%E9%83%A8%E7%BD%B2nacos%E6%9C%8D%E5%8A%A1/</url>
    
    <content type="html"><![CDATA[<h1 id="K8S部署nacos服务"><a href="#K8S部署nacos服务" class="headerlink" title="K8S部署nacos服务"></a>K8S部署nacos服务</h1><h2 id="prod环境"><a href="#prod环境" class="headerlink" title="prod环境"></a>prod环境</h2><h3 id="prod数据库使用的端口3306的数据库"><a href="#prod数据库使用的端口3306的数据库" class="headerlink" title="prod数据库使用的端口3306的数据库"></a>prod数据库使用的端口3306的数据库</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> ~]<span class="hljs-comment"># mkdir nacos &amp;&amp; cd nacos</span><br>[root<span class="hljs-variable">@master</span> nacos]<span class="hljs-comment"># vim nacos-service.yaml</span><br>---<br>apiVersion: <span class="hljs-number">v1</span><br>kind: Service<br>metadata:<br>  name: nacos-prod<br>  labels:<br>    app: nacos-prod<br>spec:<br>  type: NodePort<br>  ports:<br>    - port: <span class="hljs-number">8848</span><br>      name: server<br>      targetPort: <span class="hljs-number">8848</span><br>      nodePort: <span class="hljs-number">31048</span><br>    - port: <span class="hljs-number">9848</span><br>      name: client-rpc<br>      targetPort: <span class="hljs-number">9848</span><br>    - port: <span class="hljs-number">9849</span><br>      name: raft-rpc<br>      targetPort: <span class="hljs-number">9849</span><br>    <span class="hljs-comment">## 兼容1.4.x版本的选举端口</span><br>    - port: <span class="hljs-number">7848</span><br>      name: old-raft-rpc<br>      targetPort: <span class="hljs-number">7848</span><br>  selector:<br>    app: nacos-prod<br>---<br>apiVersion: <span class="hljs-number">v1</span><br>kind: ConfigMap<br>metadata:<br>  name: nacos-cm<br>data:<br>  mysql.db.name: <span class="hljs-string">&quot;nacos_prod&quot;</span><br>  mysql.port: <span class="hljs-string">&quot;3306&quot;</span><br>  mysql.user: <span class="hljs-string">&quot;nacos&quot;</span><br>  mysql.password: <span class="hljs-string">&quot;nacos&quot;</span><br>---<br>apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  name: nacos-prod<br>spec:<br>  replicas: <span class="hljs-number">1</span><br>  template:<br>    metadata:<br>      labels:<br>        app: nacos-prod<br>      annotations:<br>        pod.alpha.kubernetes.io/initialized: <span class="hljs-string">&quot;true&quot;</span><br>    spec:<br>      affinity:<br>        podAntiAffinity:<br>          requiredDuringSchedulingIgnoredDuringExecution:<br>            - labelSelector:<br>                matchExpressions:<br>                  - key: <span class="hljs-string">&quot;app&quot;</span><br>                    operator: In<br>                    <span class="hljs-keyword">values</span>:<br>                      - nacos-prod<br>              topologyKey: <span class="hljs-string">&quot;kubernetes.io/hostname&quot;</span><br><span class="hljs-comment">#     tolerations:             # 添加的容忍污点，到下面300结束</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br>      containers:<br>        - name: k8snacos<br>          imagePullPolicy: Always<br>          image: nacos/nacos-server:latest<br>          resources:<br>            requests:<br>              memory: <span class="hljs-string">&quot;1Gi&quot;</span><br>              cpu: <span class="hljs-string">&quot;500m&quot;</span><br>          ports:<br>            - containerPort: <span class="hljs-number">8848</span><br>              name: client<br>            - containerPort: <span class="hljs-number">9848</span><br>              name: client-rpc<br>            - containerPort: <span class="hljs-number">9849</span><br>              name: raft-rpc<br>            - containerPort: <span class="hljs-number">7848</span><br>              name: old-raft-rpc<br>          env:<br>            - name: NACOS_REPLICAS<br>              value: <span class="hljs-string">&quot;1&quot;</span><br>            - name: MYSQL_SERVICE_DB_NAME<br>              valueFrom:<br>                configMapKeyRef:<br>                  name: nacos-cm<br>                  key: mysql.db.name<br>            - name: MYSQL_SERVICE_PORT<br>              valueFrom:<br>                configMapKeyRef:<br>                  name: nacos-cm<br>                  key: mysql.port<br>            - name: MYSQL_SERVICE_USER<br>              valueFrom:<br>                configMapKeyRef:<br>                  name: nacos-cm<br>                  key: mysql.user<br>            - name: MYSQL_SERVICE_PASSWORD<br>              valueFrom:<br>                configMapKeyRef:<br>                  name: nacos-cm<br>                  key: mysql.password<br>            - name: NACOS_SERVER_PORT<br>              value: <span class="hljs-string">&quot;8848&quot;</span><br>            - name: NACOS_APPLICATION_PORT<br>              value: <span class="hljs-string">&quot;8848&quot;</span><br>            - name: PREFER_HOST_MODE<br>              value: <span class="hljs-string">&quot;hostname&quot;</span><br>            - name: MODE<br>              value: <span class="hljs-string">&quot;standalone&quot;</span><br>  selector:<br>    matchLabels:<br>      app: nacos-prod<br>      <br><span class="hljs-comment"># 查看pod,发现处于Runing状态，并在node01的节点上，端口为31048</span><br>[root<span class="hljs-variable">@master</span> nacos]<span class="hljs-comment"># kubectl get po -o wide</span><br>NAME                          READY   STATUS    RESTARTS   AGE    IP           NODE     NOMINATED NODE   READINESS GATES<br>nacos-prod-55487457cd-vpjkn   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running   <span class="hljs-number">0</span>          6m7s   <span class="hljs-number">10.244</span>.<span class="hljs-number">1.3</span>   node01   &lt;none&gt;           &lt;none&gt;<br>[root<span class="hljs-variable">@master</span> nacos]<span class="hljs-comment"># kubectl get svc</span><br>NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                       AGE<br>kubernetes   ClusterIP   <span class="hljs-number">10.96</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>       &lt;none&gt;        <span class="hljs-number">443</span>/TCP                                                       7d23h<br>nacos-prod   NodePort    <span class="hljs-number">10.102</span><span class="hljs-number">.139</span><span class="hljs-number">.65</span>   &lt;none&gt;        <span class="hljs-number">8848</span>:<span class="hljs-number">31048</span>/TCP,<span class="hljs-number">9848</span>:<span class="hljs-number">31522</span>/TCP,<span class="hljs-number">9849</span>:<span class="hljs-number">32267</span>/TCP,<span class="hljs-number">7848</span>:<span class="hljs-number">31939</span>/TCP   43s<br><br><span class="hljs-comment"># 访问</span><br>http:<span class="hljs-regexp">//</span>IP + <span class="hljs-number">31048</span>/nacos<span class="hljs-comment"># 端口是yaml文件定义的，可以自已定义</span><br></code></pre></td></tr></table></figure><h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><h3 id="需要创建NFS，不然pod起不来"><a href="#需要创建NFS，不然pod起不来" class="headerlink" title="需要创建NFS，不然pod起不来"></a>需要创建NFS，不然pod起不来</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs perl">---<br>apiVersion: <span class="hljs-number">v1</span><br>kind: Service<br>metadata:<br>  name: mysql-dev<br>spec:<br>  ports:<br>    - port: <span class="hljs-number">3306</span><br>      nodePort: <span class="hljs-number">30070</span><br>  selector:<br>    app: mysql-dev<br>  type: NodePort<br>---<br>apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  name: mysql-dev<br>  labels:<br>    app: mysql-dev<br>spec:<br>  replicas: <span class="hljs-number">1</span> <span class="hljs-comment"># pod数量</span><br>  selector:<br>    matchLabels:<br>      app: mysql-dev<br>  template:<br>    metadata:<br>      labels:<br>        app: mysql-dev<br>    spec:<br>      containers:<br>        - name: mysql-dev<br>          image: nacos/nacos-mysql:<span class="hljs-number">5.7</span><br>          imagePullPolicy: IfNotPresent<br>          resources:<br>            limits:<br>              memory: <span class="hljs-string">&quot;0.5Gi&quot;</span><br>              cpu: <span class="hljs-string">&quot;1500m&quot;</span><br>          ports:<br>            - containerPort: <span class="hljs-number">3306</span><br>          env:<br>            - name: MYSQL_ROOT_PASSWORD<br>              value: <span class="hljs-string">&quot;root&quot;</span><br>            - name: MYSQL_DATABASE<br>              value: <span class="hljs-string">&quot;my_db&quot;</span><br>            - name: MYSQL_USER<br>              value: <span class="hljs-string">&quot;nacos&quot;</span><br>            - name: MYSQL_PASSWORD<br>              value: <span class="hljs-string">&quot;nacos&quot;</span><br>          volumeMounts:<br>            - name: mysql-data<br>              mountPath: <span class="hljs-regexp">/var/li</span>b/mysql<br>            - name: mysql-dev-conf<br>              mountPath: <span class="hljs-regexp">/etc/m</span>ysql<br>      volumes:<br>        - name: mysql-data<br>          nfs:<br>            server: localhost<br>            path: <span class="hljs-regexp">/data/d</span>ev/mysql<br>        - name: mysql-dev-conf<br>          configMap:<br>            name: <span class="hljs-keyword">my</span>-dev.cnf<br>---<br>apiVersion: <span class="hljs-number">v1</span><br>kind: ConfigMap<br>metadata:<br>  name: <span class="hljs-keyword">my</span>-dev.cnf<br>data:<br>  my.cnf: |<br>    [mysqld]<br>    port = <span class="hljs-number">3306</span><br>    character-set-server=utf8mb4<br>    collation-server=utf8mb4_unicode_ci<br>    skip-character-set-client-handshake=<span class="hljs-number">1</span><br>    default-storage-engine=INNODB<br>    max_allowed_packet = 500M<br>    explicit_defaults_for_timestamp=<span class="hljs-number">1</span><br>    long_query_time = <span class="hljs-number">10</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>K8S部署nexus</title>
    <link href="/2025/11/06/K8S%E9%83%A8%E7%BD%B2nexus/"/>
    <url>/2025/11/06/K8S%E9%83%A8%E7%BD%B2nexus/</url>
    
    <content type="html"><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs perl">服务器  IP地址<br>master<span class="hljs-number">192.168</span>.<span class="hljs-number">0.173</span><br>node1<span class="hljs-number">192.168</span>.<span class="hljs-number">0.253</span><br>node2<span class="hljs-number">192.168</span>.<span class="hljs-number">0.233</span><br></code></pre></td></tr></table></figure><h2 id="安装nfs"><a href="#安装nfs" class="headerlink" title="安装nfs"></a>安装nfs</h2><h3 id="安装nfs-1"><a href="#安装nfs-1" class="headerlink" title="安装nfs"></a>安装nfs</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># master节点</span><br>yum -<span class="hljs-keyword">y</span> install  nfs-utils rpcbind<br><br><span class="hljs-comment"># 创建共享目录</span><br><span class="hljs-keyword">mkdir</span> /var/nfs/nexus<br><span class="hljs-comment"># 授予权限</span><br><span class="hljs-keyword">chmod</span> <span class="hljs-number">777</span> /var/nfs/nexus<br><br><span class="hljs-comment"># 启动nfs服务</span><br>systemctl start nfs-server<br>systemctl enabled nfs-server<br>systemctl start rpcbind<br>systemctl enabled rpcbind<br><br><span class="hljs-comment"># node节点</span><br>yum -<span class="hljs-keyword">y</span> install  nfs-utils rpcbind<br><br>systemctl start nfs-server<br>systemctl enabled nfs-server<br>systemctl start rpcbind<br>systemctl enabled rpcbind<br></code></pre></td></tr></table></figure><h3 id="挂载NFS"><a href="#挂载NFS" class="headerlink" title="挂载NFS"></a>挂载NFS</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 配置共享目录以及权限(服务端master)</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat /etc/exports</span><br>/var/nfs/nexus        *(rw,no_root_squash,sync) 或 /var/nfs/nexus  <span class="hljs-number">172.20</span><span class="hljs-number">.10</span>.<span class="hljs-number">0</span>/<span class="hljs-number">24</span>(rw,no_root_squash,sync)<br> 共享的目录       共享的地址（共享的权限、选项）<br>systemctl restart nfs-server<br><span class="hljs-comment"># 客户端连接(客户端node节点)</span><br><span class="hljs-keyword">mkdir</span>  /test     <span class="hljs-comment"># 接收文件的目录</span><br>mount -t nfs <span class="hljs-number">192.168</span>.<span class="hljs-number">0.173</span>:<span class="hljs-regexp">/var/n</span>fs/nexus  /mnt/nfs  <span class="hljs-comment"># 挂载</span><br><br>umount /test <span class="hljs-comment"># 卸载，前提先要CD到家目录下</span><br><span class="hljs-comment"># 开机挂载</span><br>vim /etc/fstab<br>nfs:<span class="hljs-regexp">/data      /da</span>ta           nfs     defaults        <span class="hljs-number">0</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="创建名称空间"><a href="#创建名称空间" class="headerlink" title="创建名称空间"></a>创建名称空间</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 创建namespace</span><br>kubectl create ns nexus<br></code></pre></td></tr></table></figure><h3 id="创建nfs客户端撒授权"><a href="#创建nfs客户端撒授权" class="headerlink" title="创建nfs客户端撒授权"></a>创建nfs客户端撒授权</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat nexus-nfs-client-sa.yaml</span><br>apiVersion: <span class="hljs-number">v1</span><br>kind: ServiceAccount<br>metadata:<br>  name: nfs-client<br>  namespace: nexus<br>---<br>kind: ClusterRole<br>apiVersion: rbac.authorization.k8s.io/<span class="hljs-number">v1</span><br>metadata:<br>  name: nfs-client-runner<br>  namespace: nexus<br>rules:<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;persistentvolumes&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>,<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;delete&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;persistentvolumeclaims&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>,<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;delete&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;storage.k8s.io&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;storageclasses&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;events&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>,<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;update&quot;</span>,<span class="hljs-string">&quot;patch&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;endpoints&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;delete&quot;</span>,<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>,<span class="hljs-string">&quot;patch&quot;</span>,<span class="hljs-string">&quot;update&quot;</span>]<br> <br>---<br>kind: ClusterRoleBinding<br>apiVersion: rbac.authorization.k8s.io/<span class="hljs-number">v1</span><br>metadata:<br>  name: run-nfs-provisioner<br>  namespace: nexus<br>subjects:<br>  - kind: ServiceAccount<br>    name: nfs-client<br>    namespace: nexus<br>roleRef:<br>  kind: ClusterRole<br>  name: nfs-client-runner<br>  apiGroup: rbac.authorization.k8s.io<br>  <br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># kubectl apply -f nexus-nfs-client-sa.yaml</span><br></code></pre></td></tr></table></figure><h3 id="检查服务是否成功"><a href="#检查服务是否成功" class="headerlink" title="检查服务是否成功"></a>检查服务是否成功</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get ServiceAccount -n nexus -o wide<br> <br>kubectl get ClusterRole -n nexus -o wide<br> <br>kubectl get ClusterRoleBinding -n nexus -o wide<br></code></pre></td></tr></table></figure><h3 id="创建nfs-客户端"><a href="#创建nfs-客户端" class="headerlink" title="创建nfs 客户端"></a>创建nfs 客户端</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat nexus-nfs-client.yaml</span><br>apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  name: nfs-client<br>  labels:<br>    app: nfs-client<br>  namespace: nexus<br>spec:<br>  replicas: <span class="hljs-number">1</span><br>  strategy:<br>    type: Recreate<br>  selector:<br>    matchLabels:<br>      app: nfs-client<br>  template:<br>    metadata:<br>      labels:<br>        app: nfs-client<br>    spec:<br>      serviceAccountName: nfs-client<br>      containers:<br>        - name: nfs-client<br>          image: d3fk/nfs-client<br>          volumeMounts:<br>            - name: nfs-client-root<br>              mountPath: <span class="hljs-regexp">/persistentvolumes</span><br><span class="hljs-regexp">          env:</span><br><span class="hljs-regexp">            - name: PROVISIONER_NAME## 这个名字必须与storegeclass里面的名字一致</span><br><span class="hljs-regexp">              value:  my-nexus-nfs</span><br><span class="hljs-regexp">            - name: ENABLE_LEADER_ELECTION## 设置高可用允许选举，如果replicas参数等于1，可不用</span><br><span class="hljs-regexp">              value: &quot;True&quot;</span><br><span class="hljs-regexp">            - name: NFS_SERVER</span><br><span class="hljs-regexp">              value: 192.168.0.173#修改为自己的ip（部署nfs的机器ip）</span><br><span class="hljs-regexp">            - name: NFS_PATH</span><br><span class="hljs-regexp">              value: /</span>var/nfs/nexus<span class="hljs-comment">#修改为自己的nfs安装目录</span><br>      volumes:<br>        - name: nfs-client-root<br>          nfs:<br>            server: <span class="hljs-number">192.168</span>.<span class="hljs-number">0.173</span><span class="hljs-comment">#修改为自己的ip（部署nfs的机器ip）</span><br>            path: <span class="hljs-regexp">/var/n</span>fs/nexus<span class="hljs-comment">#修改为自己的nfs安装目录</span><br><br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># kubectl apply -f nexus-nfs-client.yaml</span><br></code></pre></td></tr></table></figure><h3 id="创建storeclass"><a href="#创建storeclass" class="headerlink" title="创建storeclass"></a>创建storeclass</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat nexus-store-class.yaml</span><br>apiVersion: storage.k8s.io/<span class="hljs-number">v1</span><br>kind: StorageClass<br>metadata:<br>  name: nexus-nfs-storage<br>  namespace: nexus<br>provisioner: <span class="hljs-keyword">my</span>-nexus-nfs<br><br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># kubectl apply -f nexus-store-class.yaml</span><br></code></pre></td></tr></table></figure><h3 id="检查nfs客户端和storeclass创建是否成功"><a href="#检查nfs客户端和storeclass创建是否成功" class="headerlink" title="检查nfs客户端和storeclass创建是否成功"></a>检查nfs客户端和storeclass创建是否成功</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get StorageClass -n nexus -o wide<br> <br>kubectl get pod -n nexus -o wide<br></code></pre></td></tr></table></figure><h2 id="安装nexus"><a href="#安装nexus" class="headerlink" title="安装nexus"></a>安装nexus</h2><h3 id="创建pv"><a href="#创建pv" class="headerlink" title="创建pv"></a>创建pv</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment">#  cat nexus-pv.yaml</span><br>apiVersion: <span class="hljs-number">v1</span><br>kind: PersistentVolume<br>metadata:<br>  name: nexus-pv<br>spec:<br>  capacity:<br>    storage: 2Gi    <span class="hljs-comment">#配置容量大小</span><br>  accessModes:<br>    - ReadWriteOnce     <span class="hljs-comment">#配置访问策略为只允许一个节点读写</span><br>  persistentVolumeReclaimPolicy: Retain  <span class="hljs-comment">#配置回收策略，Retain为手动回收</span><br>  storageClassName: nexus       <span class="hljs-comment">#配置为nfs</span><br>  nfs:<br>    path: <span class="hljs-regexp">/var/n</span>fs/nexus   <span class="hljs-comment">#配置nfs服务端的共享路径</span><br>    server: <span class="hljs-number">192.168</span>.<span class="hljs-number">0.173</span>    <span class="hljs-comment">#配置nfs服务器地址</span><br><br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment">#  kubectl apply -f nexus-pv.yaml</span><br></code></pre></td></tr></table></figure><h3 id="创建pvc"><a href="#创建pvc" class="headerlink" title="创建pvc"></a>创建pvc</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment">#  cat nexus-pvc.yaml</span><br>apiVersion: <span class="hljs-number">v1</span><br>kind: PersistentVolumeClaim<br>metadata:<br>  name: nexus-data-pvc<br>  namespace: nexus<br>spec:<br>  accessModes:<br>    - ReadWriteOnce<br>  resources:<br>    requests:<br>      storage: 2Gi<br>  storageClassName: nexus<br>  <br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment">#  kubectl apply -f nexus-pvc.yaml</span><br></code></pre></td></tr></table></figure><h3 id="创建service"><a href="#创建service" class="headerlink" title="创建service"></a>创建service</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat nexus-service.yaml</span><br>apiVersion: <span class="hljs-number">v1</span><br>kind: Service<br>metadata:<br>  name: nexus<br>  namespace: nexus<br>  labels:<br>    app: nexus<br>spec:<br>  selector:<br>    app: nexus<br>  type: NodePort<br>  ports:<br>    - name: web<br>      protocol: TCP<br>      port: <span class="hljs-number">8081</span><br>      targetPort: <span class="hljs-number">8081</span><br>      nodePort: <span class="hljs-number">30001</span><span class="hljs-comment"># 对外暴露的端口</span><br>      <br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment">#  kubectl apply -f nexus-service.yaml</span><br></code></pre></td></tr></table></figure><h3 id="创建deployment"><a href="#创建deployment" class="headerlink" title="创建deployment"></a>创建deployment</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat nexus-deploy.yaml</span><br>apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  labels:<br>    app: nexus<br>  name: nexus<br>  namespace: nexus<br>spec:<br>  replicas: <span class="hljs-number">1</span><br>  progressDeadlineSeconds: <span class="hljs-number">600</span><br>  minReadySeconds: <span class="hljs-number">30</span><br>  strategy:<br>    rollingUpdate:<br>      maxSurge: <span class="hljs-number">1</span><br>      maxUnavailable: <span class="hljs-number">0</span><br>    type: RollingUpdate<br>  selector:<br>    matchLabels:<br>      app: nexus<br>  template:<br>    metadata:<br>      labels:<br>        app: nexus<br>    spec:<br><span class="hljs-comment">#     tolerations:             # 添加的容忍污点，到下面300结束</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br>      containers:<br>      - name: nexus<br>        image: sonatype/nexus3:<span class="hljs-number">3.28</span>.<span class="hljs-number">0</span><br>        imagePullPolicy: IfNotPresent<br>        ports:<br>          - containerPort: <span class="hljs-number">8081</span><br>            name: web<br>            protocol: TCP<br>        livenessProbe:<br>          httpGet:<br>            path: <span class="hljs-regexp">/</span><br><span class="hljs-regexp">            port: 8081</span><br><span class="hljs-regexp">          initialDelaySeconds: 70</span><br><span class="hljs-regexp">          periodSeconds: 30</span><br><span class="hljs-regexp">          failureThreshold: 6</span><br><span class="hljs-regexp">        readinessProbe:</span><br><span class="hljs-regexp">          httpGet:</span><br><span class="hljs-regexp">            path: /</span><br>            port: <span class="hljs-number">8081</span><br>          initialDelaySeconds: <span class="hljs-number">60</span><br>          periodSeconds: <span class="hljs-number">30</span><br>          failureThreshold: <span class="hljs-number">6</span><br>        resources:<br>          limits:<br>            cpu: 1000m<br>            memory: 2Gi<br>          requests:<br>            cpu: 500m<br>            memory: 512Mi<br>        volumeMounts:<br>        - name: nexus-data<br>          mountPath: /nexus-data<br>      volumes:<br>        - name: nexus-data<br>          persistentVolumeClaim:<br>            claimName: nexus-data-pvc<br>            <br> <span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment">#  kubectl apply -f nexus-deploy.yaml</span><br></code></pre></td></tr></table></figure><h3 id="查询服务是否正常"><a href="#查询服务是否正常" class="headerlink" title="查询服务是否正常"></a>查询服务是否正常</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get all -n nexus<br><br>kubectl get po -n nexus -o wide<br>kubectl get pv,pvc -n nexus -o wide<br>kubectl get svc -n nexus -o wide<br></code></pre></td></tr></table></figure><h3 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">通过service的nodeport端口访问nexus服务<br><br>http:<span class="hljs-regexp">//</span>IP + 端口<span class="hljs-number">30001</span><span class="hljs-comment"># 端口是service文件里定义的（ nodePort: 30001）</span><br></code></pre></td></tr></table></figure><h3 id="服务启动正常后获取nexus初始的登录密码"><a href="#服务启动正常后获取nexus初始的登录密码" class="headerlink" title="服务启动正常后获取nexus初始的登录密码"></a>服务启动正常后获取nexus初始的登录密码</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># kubectl exec -it nexus-6b47d98b5c-tjchb -n nexus cat /nexus-data/admin.password</span><br>kubectl <span class="hljs-keyword">exec</span> [POD] [COMMAND] is DEPRECATED <span class="hljs-keyword">and</span> will be removed in a future version. Use kubectl <span class="hljs-keyword">exec</span> [POD] -- [COMMAND] instead.<br>f7f0f006-423c-4b2e-<span class="hljs-number">9256</span>-032adc74ceeb[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># </span><br>或<br><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># kubectl exec -it nexus-6b47d98b5c-tjchb -n nexus bash</span><br>kubectl <span class="hljs-keyword">exec</span> [POD] [COMMAND] is DEPRECATED <span class="hljs-keyword">and</span> will be removed in a future version. Use kubectl <span class="hljs-keyword">exec</span> [POD] -- [COMMAND] instead.<br>bash-<span class="hljs-number">4.4</span>$ cat /nexus-data/admin.password <br>f7f0f006-423c-4b2e-<span class="hljs-number">9256</span>-032adc74ceebbash-<span class="hljs-number">4.4</span>$<br><br><span class="hljs-comment"># 默认用户admin 密码使用上面获取的初始密码即可(密码：Zijian@123)</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>K8S部署zentao</title>
    <link href="/2025/11/06/K8S%E9%83%A8%E7%BD%B2zentao/"/>
    <url>/2025/11/06/K8S%E9%83%A8%E7%BD%B2zentao/</url>
    
    <content type="html"><![CDATA[<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs perl">服务器  IP地址<br>master<span class="hljs-number">192.168</span>.<span class="hljs-number">0.173</span><br>node1<span class="hljs-number">192.168</span>.<span class="hljs-number">0.253</span><br>node2<span class="hljs-number">192.168</span>.<span class="hljs-number">0.233</span><br></code></pre></td></tr></table></figure><h2 id="安装nfs"><a href="#安装nfs" class="headerlink" title="安装nfs"></a>安装nfs</h2><h3 id="安装nfs-1"><a href="#安装nfs-1" class="headerlink" title="安装nfs"></a>安装nfs</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># master节点</span><br>yum -<span class="hljs-keyword">y</span> install  nfs-utils rpcbind<br><br><span class="hljs-comment"># 创建共享目录</span><br><span class="hljs-keyword">mkdir</span> -p /data/zentao<br><br><span class="hljs-comment"># 启动nfs服务</span><br>systemctl restart nfs-server<br>systemctl enabled nfs-server<br>systemctl restart rpcbind<br>systemctl enabled rpcbind<br><br><span class="hljs-comment"># node节点</span><br>yum -<span class="hljs-keyword">y</span> install  nfs-utils rpcbind<br><br>systemctl restart nfs-server<br>systemctl enabled nfs-server<br>systemctl restart rpcbind<br>systemctl enabled rpcbind<br></code></pre></td></tr></table></figure><h3 id="挂载NFS"><a href="#挂载NFS" class="headerlink" title="挂载NFS"></a>挂载NFS</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 配置共享目录以及权限(服务端master)</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat /etc/exports</span><br>/var/nfs/nexus        *(rw,no_root_squash,sync)<br>/var/nfs/nexus  *(rw,no_root_squash,sync)<br><span class="hljs-comment"># 重新启动</span><br>systemctl restart nfs-server<br><br><span class="hljs-comment"># 验证</span><br>[root<span class="hljs-variable">@master</span> zentao]<span class="hljs-comment"># showmount -e 192.168.0.173</span><br>Export list <span class="hljs-keyword">for</span> <span class="hljs-number">192.168</span>.<span class="hljs-number">0.173</span>:<br><span class="hljs-regexp">/data/</span>zentao   *<br><span class="hljs-regexp">/var/n</span>fs/nexus *<br><br><span class="hljs-comment"># 客户端连接(客户端node节点)</span><br><span class="hljs-keyword">mkdir</span>  /test     <span class="hljs-comment"># 接收文件的目录</span><br>mount -t nfs <span class="hljs-number">192.168</span>.<span class="hljs-number">0.173</span>:<span class="hljs-regexp">/var/n</span>fs/nexus  /test  <span class="hljs-comment"># 挂载</span><br><br>umount /test <span class="hljs-comment"># 卸载，前提先要CD到家目录下</span><br><span class="hljs-comment"># 开机挂载</span><br>vim /etc/fstab<br>nfs:<span class="hljs-regexp">/data      /da</span>ta           nfs     defaults        <span class="hljs-number">0</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h3 id="创建名称空间"><a href="#创建名称空间" class="headerlink" title="创建名称空间"></a>创建名称空间</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 创建namespace</span><br>kubectl create ns work<span class="hljs-comment"># 可以自定义名称空间为为zentao</span><br></code></pre></td></tr></table></figure><h3 id="创建nfs客户端撒授权"><a href="#创建nfs客户端撒授权" class="headerlink" title="创建nfs客户端撒授权"></a>创建nfs客户端撒授权</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat nexus-nfs-client-sa.yaml</span><br>apiVersion: <span class="hljs-number">v1</span><br>kind: ServiceAccount<br>metadata:<br>  name: nfs-client<br>  namespace: nexus<br>---<br>kind: ClusterRole<br>apiVersion: rbac.authorization.k8s.io/<span class="hljs-number">v1</span><br>metadata:<br>  name: nfs-client-runner<br>  namespace: nexus<br>rules:<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;persistentvolumes&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>,<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;delete&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;persistentvolumeclaims&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>,<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;delete&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;storage.k8s.io&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;storageclasses&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;events&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>,<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;update&quot;</span>,<span class="hljs-string">&quot;patch&quot;</span>]<br>  - apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>    resources: [<span class="hljs-string">&quot;endpoints&quot;</span>]<br>    verbs: [<span class="hljs-string">&quot;create&quot;</span>,<span class="hljs-string">&quot;delete&quot;</span>,<span class="hljs-string">&quot;get&quot;</span>,<span class="hljs-string">&quot;list&quot;</span>,<span class="hljs-string">&quot;watch&quot;</span>,<span class="hljs-string">&quot;patch&quot;</span>,<span class="hljs-string">&quot;update&quot;</span>]<br> <br>---<br>kind: ClusterRoleBinding<br>apiVersion: rbac.authorization.k8s.io/<span class="hljs-number">v1</span><br>metadata:<br>  name: run-nfs-provisioner<br>  namespace: nexus<br>subjects:<br>  - kind: ServiceAccount<br>    name: nfs-client<br>    namespace: nexus<br>roleRef:<br>  kind: ClusterRole<br>  name: nfs-client-runner<br>  apiGroup: rbac.authorization.k8s.io<br>  <br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># kubectl apply -f nexus-nfs-client-sa.yaml</span><br></code></pre></td></tr></table></figure><h3 id="检查服务是否成功"><a href="#检查服务是否成功" class="headerlink" title="检查服务是否成功"></a>检查服务是否成功</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get ServiceAccount -n nexus -o wide<br> <br>kubectl get ClusterRole -n nexus -o wide<br> <br>kubectl get ClusterRoleBinding -n nexus -o wide<br></code></pre></td></tr></table></figure><h3 id="创建nfs-客户端"><a href="#创建nfs-客户端" class="headerlink" title="创建nfs 客户端"></a>创建nfs 客户端</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat nexus-nfs-client.yaml</span><br>apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  name: nfs-client<br>  labels:<br>    app: nfs-client<br>  namespace: nexus<br>spec:<br>  replicas: <span class="hljs-number">1</span><br>  strategy:<br>    type: Recreate<br>  selector:<br>    matchLabels:<br>      app: nfs-client<br>  template:<br>    metadata:<br>      labels:<br>        app: nfs-client<br>    spec:<br>      serviceAccountName: nfs-client<br>      containers:<br>        - name: nfs-client<br>          image: d3fk/nfs-client<br>          volumeMounts:<br>            - name: nfs-client-root<br>              mountPath: <span class="hljs-regexp">/persistentvolumes</span><br><span class="hljs-regexp">          env:</span><br><span class="hljs-regexp">            - name: PROVISIONER_NAME## 这个名字必须与storegeclass里面的名字一致</span><br><span class="hljs-regexp">              value:  my-nexus-nfs</span><br><span class="hljs-regexp">            - name: ENABLE_LEADER_ELECTION## 设置高可用允许选举，如果replicas参数等于1，可不用</span><br><span class="hljs-regexp">              value: &quot;True&quot;</span><br><span class="hljs-regexp">            - name: NFS_SERVER</span><br><span class="hljs-regexp">              value: 192.168.0.173#修改为自己的ip（部署nfs的机器ip）</span><br><span class="hljs-regexp">            - name: NFS_PATH</span><br><span class="hljs-regexp">              value: /</span>var/nfs/nexus<span class="hljs-comment">#修改为自己的nfs安装目录</span><br>      volumes:<br>        - name: nfs-client-root<br>          nfs:<br>            server: <span class="hljs-number">192.168</span>.<span class="hljs-number">0.173</span><span class="hljs-comment">#修改为自己的ip（部署nfs的机器ip）</span><br>            path: <span class="hljs-regexp">/var/n</span>fs/nexus<span class="hljs-comment">#修改为自己的nfs安装目录</span><br><br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># kubectl apply -f nexus-nfs-client.yaml</span><br></code></pre></td></tr></table></figure><h3 id="创建storeclass"><a href="#创建storeclass" class="headerlink" title="创建storeclass"></a>创建storeclass</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># cat nexus-store-class.yaml</span><br>apiVersion: storage.k8s.io/<span class="hljs-number">v1</span><br>kind: StorageClass<br>metadata:<br>  name: nexus-nfs-storage<br>  namespace: nexus<br>provisioner: <span class="hljs-keyword">my</span>-nexus-nfs<br><br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> nexus]<span class="hljs-comment"># kubectl apply -f nexus-store-class.yaml</span><br></code></pre></td></tr></table></figure><h3 id="检查nfs客户端和storeclass创建是否成功"><a href="#检查nfs客户端和storeclass创建是否成功" class="headerlink" title="检查nfs客户端和storeclass创建是否成功"></a>检查nfs客户端和storeclass创建是否成功</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get StorageClass -n nexus -o wide<br> <br>kubectl get pod -n nexus -o wide<br></code></pre></td></tr></table></figure><h2 id="部署禅道"><a href="#部署禅道" class="headerlink" title="部署禅道"></a>部署禅道</h2><h3 id="创建-pv-和-pvc"><a href="#创建-pv-和-pvc" class="headerlink" title="创建 pv 和 pvc"></a>创建 pv 和 pvc</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> zentao]<span class="hljs-comment"># cat zentao-pv-pvc.yaml </span><br>apiVersion: <span class="hljs-number">v1</span><br>kind: PersistentVolume<br>metadata:<br>  name: zentao-pv<br>  namespace: work<br>  labels:<br>    pv: zentao-pv<br>spec:<br>  capacity:<br>    storage: 3Gi<br>  accessModes:<br>    - ReadWriteOnce<br>  persistentVolumeReclaimPolicy: Recycle<br>  storageClassName: zentao-nfs<br>  nfs:<br>    path: <span class="hljs-regexp">/data/</span>zentao<br>    server: <span class="hljs-number">192.168</span>.<span class="hljs-number">0.173</span><br><br>---<br>kind: PersistentVolumeClaim<br>apiVersion: <span class="hljs-number">v1</span><br>metadata:<br>  name: zentao-pvc<br>  namespace: work<br>spec:<br>  accessModes:<br>    - ReadWriteOnce<br>  resources:<br>    requests:<br>      storage: 3Gi<br>  storageClassName: zentao-nfs<br>  selector:<br>    matchLabels:<br>      pv: zentao-pv<br><br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> zentao]<span class="hljs-comment"># kubectl apply -f zentao-pv-pvc.yaml</span><br></code></pre></td></tr></table></figure><h3 id="创建deployment"><a href="#创建deployment" class="headerlink" title="创建deployment"></a>创建deployment</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> zentao]<span class="hljs-comment"># cat zentao-deployment.yaml </span><br>apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  name: zentao<br>  namespace: work<br>  labels:<br>    app: zentao<br>spec:<br>  selector:<br>    matchLabels:<br>      app: zentao<br>  replicas: <span class="hljs-number">1</span><br>  template:<br>    metadata:<br>      labels:<br>        app: zentao<br>    spec:<br><span class="hljs-comment">#     tolerations:             # 添加的容忍污点，到下面300结束</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br><span class="hljs-comment">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span><br><span class="hljs-comment">#          operator: &quot;Exists&quot;</span><br><span class="hljs-comment">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span><br><span class="hljs-comment">#          tolerationSeconds: 300</span><br>      containers:<br>      - name: zentao<br>        image: easysoft/zentao<br>        env:<br>        - name: ADMINER_USER<br>          value: <span class="hljs-string">&#x27;root&#x27;</span><br>        - name: ADMINER_PASSWD<br>          value: <span class="hljs-string">&#x27;Qingfeng@123&#x27;</span><br>        - name: BIND_ADDRESS<br>          value: <span class="hljs-string">&#x27;true&#x27;</span><br>        - name: SMTP_HOST<br>          value: <span class="hljs-string">&#x27;192.168.0.211&#x27;</span><br>        ports:<br>        - name: zentao<br>          containerPort: <span class="hljs-number">80</span><br>        - name: mysql<br>          containerPort: <span class="hljs-number">3306</span><br>        volumeMounts:<br>        - name: zentao<br>          mountPath: <span class="hljs-regexp">/opt/</span>zentao<br>      volumes:<br>        - name: zentao<br>          persistentVolumeClaim:<br>            claimName: zentao-pvc<br><br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> zentao]<span class="hljs-comment"># kubectl apply -f zentao-deployment.yaml</span><br></code></pre></td></tr></table></figure><h3 id="创建service"><a href="#创建service" class="headerlink" title="创建service"></a>创建service</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs perl">[root<span class="hljs-variable">@master</span> zentao]<span class="hljs-comment"># cat zentao-svc.yaml </span><br>apiVersion: <span class="hljs-number">v1</span><br>kind: Service<br>metadata:<br>  labels:<br>    app: zentao<br>  name: zentao<br>  namespace: work<br>spec:<br>  ports:<br>  - name: zentao<br>    port: <span class="hljs-number">80</span><br>    protocol: TCP<br>    targetPort: <span class="hljs-number">80</span><br>    nodePort: <span class="hljs-number">30061</span><br>  - name: mysql<br>    port: <span class="hljs-number">3306</span><br>    protocol: TCP<br>    targetPort: <span class="hljs-number">3306</span><br>    nodePort: <span class="hljs-number">30056</span><br>  selector:<br>    app: zentao<br>  type: NodePort<br>  <br>  <br><span class="hljs-comment"># 创建</span><br>[root<span class="hljs-variable">@master</span> zentao]<span class="hljs-comment"># kubectl apply -f zentao-svc.yaml </span><br></code></pre></td></tr></table></figure><h3 id="查看创建的zentao服务是否正常运行"><a href="#查看创建的zentao服务是否正常运行" class="headerlink" title="查看创建的zentao服务是否正常运行"></a>查看创建的zentao服务是否正常运行</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get all -n work -o wide<br>kubeclt get pv,pvc -n work<br>kubectl get svc -n work<br>kubectl get po -n work -o wide<br>kubectl get po zentao-55bcc7c689-g45wr -n work -o wide<br>kubectl describe po zentao-55bcc7c689-g45wr -n work -o wide<br>kubectl logs zentao-55bcc7c689-g45wr -n work<br></code></pre></td></tr></table></figure><h2 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 在哪个节点上就用哪个节点的IP地址，</span><br>浏览器访问：IP + 端口<span class="hljs-number">30061</span><span class="hljs-comment"># 30061端口是在svc文件里自定义的</span><br><br><span class="hljs-comment"># 注：web上输入MySQL密码时，密码为123456</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>K8S部署nginx</title>
    <link href="/2025/11/06/K8S%E9%83%A8%E7%BD%B2nginx/"/>
    <url>/2025/11/06/K8S%E9%83%A8%E7%BD%B2nginx/</url>
    
    <content type="html"><![CDATA[<h1 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> /opt/k8s/nginx-yaml<br></code></pre></td></tr></table></figure><h1 id="创建名称空间"><a href="#创建名称空间" class="headerlink" title="创建名称空间"></a>创建名称空间</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl create namespace nginx<br></code></pre></td></tr></table></figure><h1 id="创建deployment"><a href="#创建deployment" class="headerlink" title="创建deployment"></a>创建deployment</h1><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim nginx-deploy.yaml<br><br>apiVersion: apps/<span class="hljs-number">v1</span><br>kind: Deployment<br>metadata:<br>  name: nginx-deployment<br>  namespace: nginx<br>spec:<br>  selector:<br>    matchLabels:<br>      app: nginx<br>  replicas: <span class="hljs-number">3</span><br>  template:<br>    metadata:<br>      labels:<br>        app: nginx<br>    spec:<br>      containers:<br>      - name: nginx<br>        image: nginx:alpine<br>        ports:<br>        - containerPort: <span class="hljs-number">80</span><br>        volumeMounts:<br>        - mountPath: <span class="hljs-regexp">/etc/l</span>ocaltime<br>          name: c-v-path<br>        - mountPath: <span class="hljs-regexp">/etc/nginx</span><span class="hljs-regexp">/conf.d</span><br><span class="hljs-regexp">          name: c-v-path-ng</span><br><span class="hljs-regexp">      restartPolicy: Always</span><br><span class="hljs-regexp">      volumes:</span><br><span class="hljs-regexp">        - hostPath:</span><br><span class="hljs-regexp">            path: /</span>etc/<span class="hljs-keyword">localtime</span><br>            type: <span class="hljs-string">&#x27;&#x27;</span><br>          name: c-v-path<br>        - hostPath:<br>            path: <span class="hljs-regexp">/root/</span>opt/k8s/nginx-yaml/nginx-conf<br>            type: <span class="hljs-string">&#x27;&#x27;</span><br>          name: c-v-path-ng<br></code></pre></td></tr></table></figure><p>创建service</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs perl">vim nginx-svc.yaml<br><br>apiVersion: <span class="hljs-number">v1</span><br>kind: Service<br>metadata:<br>  name: nginx-service<br>  namespace: nginx<br>spec:<br>  selector:<br>    app: nginx<br>  ports:<br>  - protocol: TCP<br>    port: <span class="hljs-number">80</span><br>    targetPort: <span class="hljs-number">80</span><br>    nodePort: <span class="hljs-number">30080</span><br>  type: NodePort<br><br></code></pre></td></tr></table></figure><p>创建</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl apply -f nginx-deploy.yaml<br>kubectl apply -f nginx-svc.yaml<br></code></pre></td></tr></table></figure><p>查看pod在哪个节点</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get deploy -n nginx -o wide<br><br>NAME               READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR<br>nginx-deployment   <span class="hljs-number">3</span>/<span class="hljs-number">3</span>     <span class="hljs-number">3</span>            <span class="hljs-number">3</span>           48s   nginx        nginx:alpine   app=nginx<br><br></code></pre></td></tr></table></figure><p>查看service状态–端口是30080</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl get svc nginx-service -o wide<br><br>NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR<br>nginx-service   NodePort   <span class="hljs-number">10.106</span><span class="hljs-number">.209</span><span class="hljs-number">.76</span>   &lt;none&gt;        <span class="hljs-number">80</span>:<span class="hljs-number">30080</span>/TCP   26s   app=nginx<br><br></code></pre></td></tr></table></figure><p>访问</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">pod节点 + 端口<br></code></pre></td></tr></table></figure><p>进入容器</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">kubectl <span class="hljs-keyword">exec</span> -it pod名称 --sh<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>日常工作（更新中）</title>
    <link href="/2025/11/06/%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%EF%BC%88%E6%9B%B4%E6%96%B0%E4%B8%AD%EF%BC%89/"/>
    <url>/2025/11/06/%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%EF%BC%88%E6%9B%B4%E6%96%B0%E4%B8%AD%EF%BC%89/</url>
    
    <content type="html"><![CDATA[<h2 id="磁盘-内存-清理"><a href="#磁盘-内存-清理" class="headerlink" title="磁盘&#x2F;内存 清理"></a>磁盘&#x2F;内存 清理</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 查看磁盘大小</span><br>df -Th<br><span class="hljs-comment"># 查看每个目录下的文件大小</span><br>du -sh /*<br>du -sh /*<span class="hljs-regexp">/*</span><br><span class="hljs-regexp"># 查看目录文件大小</span><br><span class="hljs-regexp">du -h</span><br><span class="hljs-regexp"># 数字化服务器占磁盘大的目录</span><br><span class="hljs-regexp">rm -rf /d</span>ocker/zentao/www/zentaopms/tmp<br>rm -rf /usr/tmp<br>rm -rf /var/<span class="hljs-keyword">log</span><br>s<br><span class="hljs-comment"># 查看内存使用率</span><br>free -m<br><span class="hljs-comment"># 清理缓存</span><br>echo <span class="hljs-number">3</span> &gt; <span class="hljs-regexp">/proc/s</span>ys/vm/drop_caches<br><br><span class="hljs-comment"># maven仓库地址</span><br>/usr/<span class="hljs-keyword">local</span>/repository/maven_repo/com<br><br><span class="hljs-comment"># 查看java服务内存</span><br>jps -l<br>jmap -heap PID号<br><br>top里的“ RES:： 进程使用的物理内存量 (Resident Memory)，即实际驻留在物理内存中的部分。<br>RES的数值 / <span class="hljs-number">1024</span> 得出的结果就是服务使用的内存<br></code></pre></td></tr></table></figure><h2 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs perl">mysqldump 逻辑备份<br>mysqldump -u用户 -p密码 库名 [表名] &gt; xxx.sql<br>mysql -u用户 -p密码 库名 &lt; xxx.sql<br><span class="hljs-comment"># MySQL数据库备份</span><br>[root<span class="hljs-variable">@figure</span> ~]<span class="hljs-comment"># ls</span><br>mul_java  mysql_db  nexus.log  nexus.tar  nohup.out<br>[root<span class="hljs-variable">@figure</span> ~]<span class="hljs-comment"># cd mysql_db/</span><br>[root<span class="hljs-variable">@figure</span> mysql_db]<span class="hljs-comment"># mysqldump -uroot -p&#x27;Qingfeng@123&#x27; zj_shops_dev &gt; zj_shops_dev.sql</span><br>[root<span class="hljs-variable">@figure</span> mysql_db]<span class="hljs-comment"># ls</span><br>dev.sql  mysql.sql  nacos.sql  test.sql  zj_shops_beta.sql  zj_shops_dev.sql  zj_shops_test.sql  zj_shops_uat.sql<br><br>示例：<br>mysql&gt; show databases;<br>[root<span class="hljs-variable">@localhost</span> cha]<span class="hljs-comment"># mysqldump -uroot -p&#x27;1&#x27; ku &gt; ku.sql</span><br>[root<span class="hljs-variable">@localhost</span> cha]<span class="hljs-comment"># vim ku.sql</span><br>create database ku;<br><span class="hljs-keyword">use</span> ku;<span class="hljs-regexp">//</span>看是否需要添加以上两行<br>DROP TABLE IF EXISTS <span class="hljs-string">`biao`</span>;<br>mysql&gt; drop database ku;<br>mysql&gt; show databases;<span class="hljs-regexp">//</span>再查看下<br>[root<span class="hljs-variable">@localhost</span> cha]<span class="hljs-comment"># mysql -uroot -p&#x27;1&#x27; &lt; ku.sql//回复数据</span><br>mysql&gt; show databases;<br><br><br><span class="hljs-comment"># java服务的jar包备份--2个方案，二选一就可以</span><br>[root<span class="hljs-variable">@uat</span> ~]<span class="hljs-comment"># ls</span><br>jarfile<br>[root<span class="hljs-variable">@uat</span> ~]<span class="hljs-comment"># cp jarfile/ jarfile_bak/ -r# 拷贝目录</span><br>[root<span class="hljs-variable">@uat</span> ~]<span class="hljs-comment"># tar czvf jarfile.tar.gz ./jarfile# 将目录打包成tar.gz的包</span><br>[root<span class="hljs-variable">@uat</span> ~]<span class="hljs-comment"># ls</span><br>jarfile  jarfile_bak  jarfile.tar.gz<br></code></pre></td></tr></table></figure><h3 id="MySQL数据每日全量备份"><a href="#MySQL数据每日全量备份" class="headerlink" title="MySQL数据每日全量备份"></a>MySQL数据每日全量备份</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 创建目录</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># mkdir /opt/mysql_back/backup</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># mkdir /opt/mysql_back/back_log</span><br><span class="hljs-comment"># 创建脚本</span><br>[root<span class="hljs-variable">@localhost</span> mysql_back]<span class="hljs-comment"># cat /opt/mysql_back/mysql_db_back.sh </span><br><span class="hljs-comment">#!/bin/bash</span><br><span class="hljs-comment"># Description: MySQL全量备份，备份所有库</span><br><br><span class="hljs-comment"># 用户名、密码</span><br>user=<span class="hljs-string">&quot;root&quot;</span><br>password=<span class="hljs-string">&quot;Qingfeng<span class="hljs-variable">@123</span>&quot;</span><br><br><span class="hljs-comment"># 备份开始时间</span><br>beginTime=<span class="hljs-variable">$(</span>date +<span class="hljs-string">&quot;<span class="hljs-variable">%Y</span>年<span class="hljs-variable">%m</span>月<span class="hljs-variable">%d</span>日 <span class="hljs-variable">%H</span>:<span class="hljs-variable">%M</span>:<span class="hljs-variable">%S</span>&quot;</span>)<br><span class="hljs-comment"># 备份结束时间</span><br>endTime=<span class="hljs-variable">$(</span>date +<span class="hljs-string">&quot;<span class="hljs-variable">%Y</span>年<span class="hljs-variable">%m</span>月<span class="hljs-variable">%d</span>日 <span class="hljs-variable">%H</span>:<span class="hljs-variable">%M</span>:<span class="hljs-variable">%S</span>&quot;</span>)<br><br><span class="hljs-comment"># 全量备份目录，提前手动创建这个目录</span><br>bakDir=<span class="hljs-string">&quot;/opt/mysql_back/backup&quot;</span><br><span class="hljs-comment"># 日志文件</span><br>logFile=<span class="hljs-string">&quot;/opt/mysql_back/back_log/fullybak.log&quot;</span><br><br><span class="hljs-comment"># 创建备份目录</span><br><span class="hljs-keyword">mkdir</span> -p <span class="hljs-string">&quot;<span class="hljs-variable">$bakDir</span>&quot;</span><br><br>cd <span class="hljs-string">&quot;<span class="hljs-variable">$bakDir</span>&quot;</span><br>echo <span class="hljs-string">&quot;全量备份开始: <span class="hljs-variable">$beginTime</span>&quot;</span> &gt;&gt; <span class="hljs-string">&quot;<span class="hljs-variable">$logFile</span>&quot;</span><br><br><span class="hljs-comment"># 全量备份</span><br>nowDate=<span class="hljs-variable">$(</span>date +<span class="hljs-string">&quot;%Y%m<span class="hljs-variable">%d</span>_%H%M<span class="hljs-variable">%S</span>&quot;</span>)<br>dumpFile=<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;nowDate&#125;</span>_alldb.sql&quot;</span><br>gzDumpFile=<span class="hljs-string">&quot;<span class="hljs-subst">$&#123;nowDate&#125;</span>_alldb.sql.tgz&quot;</span><br><br><span class="hljs-comment"># 备份所有数据库</span><br>mysqldump -u<span class="hljs-string">&quot;<span class="hljs-variable">$user</span>&quot;</span> -p<span class="hljs-string">&quot;<span class="hljs-variable">$password</span>&quot;</span> -A -E -<span class="hljs-keyword">q</span> --flush-privileges --single-transaction &gt; <span class="hljs-string">&quot;<span class="hljs-variable">$dumpFile</span>&quot;</span><br><br><span class="hljs-comment"># 判断备份是否成功</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$?</span> -eq <span class="hljs-number">0</span> ]; then<br>  <span class="hljs-comment"># 将备份SQL打包</span><br>  tar -zvcf <span class="hljs-string">&quot;<span class="hljs-variable">$gzDumpFile</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$dumpFile</span>&quot;</span><br>  rm <span class="hljs-string">&quot;<span class="hljs-variable">$dumpFile</span>&quot;</span><br>  echo <span class="hljs-string">&quot;全量备份结束: <span class="hljs-variable">$endTime</span>, 备份文件: <span class="hljs-variable">$gzDumpFile</span> ! SUCCESS !&quot;</span> &gt;&gt; <span class="hljs-string">&quot;<span class="hljs-variable">$logFile</span>&quot;</span><br><span class="hljs-keyword">else</span><br>  echo <span class="hljs-string">&quot;全量备份结束: <span class="hljs-variable">$endTime</span>, 备份文件: <span class="hljs-variable">$gzDumpFile</span> ! ERROR !&quot;</span> &gt;&gt; <span class="hljs-string">&quot;<span class="hljs-variable">$logFile</span>&quot;</span><br>fi<br><br><span class="hljs-comment"># 删除7天前的备份</span><br>find <span class="hljs-string">&quot;<span class="hljs-variable">$bakDir</span>&quot;</span> -name <span class="hljs-string">&quot;*.sql.tgz&quot;</span> -type f -mtime +<span class="hljs-number">7</span> -<span class="hljs-keyword">exec</span> rm -rf &#123;&#125; \; &gt; <span class="hljs-regexp">/dev/null</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span><br><span class="hljs-keyword">exit</span> <span class="hljs-number">0</span><br><br><span class="hljs-comment"># 授予脚本执行权限</span><br>[root<span class="hljs-variable">@localhost</span> mysql_back]<span class="hljs-comment"># chmod +x /opt/mysql_back/mysql_db_back.sh </span><br><span class="hljs-comment"># 创建定时计划任务</span><br>[root<span class="hljs-variable">@localhost</span> mysql_back]<span class="hljs-comment"># crontab -e</span><br><span class="hljs-number">0</span> <span class="hljs-number">1</span> * * * <span class="hljs-regexp">/bin/</span>bash -<span class="hljs-keyword">x</span> /opt/mysql_back/mysql_db_back.sh &gt;<span class="hljs-regexp">/dev/null</span> <span class="hljs-number">2</span>&gt;&amp;<span class="hljs-number">1</span><span class="hljs-comment"># 在每天的第1小时（凌晨1点）执行脚本。</span><br></code></pre></td></tr></table></figure><h2 id="挖矿程序清理"><a href="#挖矿程序清理" class="headerlink" title="挖矿程序清理"></a>挖矿程序清理</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 禁止服务开机自启</span><br>systemctl disable c3pool_miner.service<br><span class="hljs-comment"># 查看状态</span><br>systemctl status c3pool_miner.service <br><span class="hljs-comment"># 停止服务</span><br>systemctl stop c3pool_miner.service <br>systemctl status c3pool_miner.service <br><span class="hljs-comment"># 删除服务的system文件</span><br>rm -rf /etc/systemd/<span class="hljs-keyword">system</span>/c3pool_miner.service<br>systemctl list-units --type=service<br>systemctl list-units --type=service | <span class="hljs-keyword">grep</span> c3pool<br>htop<br>ps -ef<br>ps -ef |<span class="hljs-keyword">grep</span> xmrig<br>find / -name xmrig <br>ls -lah<br><span class="hljs-comment"># 删除挖矿的脚本执行文件</span><br>rm -rf c3pool/<br>find / -name xmrig<br><span class="hljs-comment"># 禁止域名访问</span><br>iptables -A OUTPUT -p tcp -d *.c3pool.org --dport <span class="hljs-number">80</span> -j DROP<br>iptables -A OUTPUT -p tcp -d <span class="hljs-string">&#x27;*.c3pool.org&#x27;</span> --dport <span class="hljs-number">80</span> -j DROP<br>iptables -A OUTPUT -p tcp -d <span class="hljs-string">&quot;*.c3pool.org&quot;</span> --dport <span class="hljs-number">80</span> -j DROP<br>iptables -A OUTPUT -p tcp -d download.c3pool.org --dport <span class="hljs-number">80</span> -j DROP<br>iptables -A OUTPUT -p tcp -d c3pool.org --dport <span class="hljs-number">80</span> -j DROP<br>ping c3pool.org<br><span class="hljs-comment"># 保持记录</span><br>iptables save<br>service iptables save<br><span class="hljs-comment"># 禁止执行脚本文件，并保存</span><br>iptables -I INPUT -m string --string <span class="hljs-string">&quot;setup_c3pool_miner.sh&quot;</span> --algo bm -j DROP<br>service iptables save<br><span class="hljs-comment"># 查看保存记录</span><br>iptables -L<br>iptables-save &gt; <span class="hljs-regexp">/etc/s</span>ysconfig/iptables<br>vim /etc/rc.d/rc.local<br>iptables-restore &lt; <span class="hljs-regexp">/etc/s</span>ysconfig/iptables<span class="hljs-comment">#添加这内容</span><br>vim /etc/sysconfig/iptables<span class="hljs-comment"># 可以看到已经添加了一下内容</span><br>-A INPUT -m string --string <span class="hljs-string">&quot;setup_c3pool_miner.sh&quot;</span> --algo bm --to <span class="hljs-number">65535</span> -j DROP<br>-A OUTPUT -d <span class="hljs-number">154.201</span><span class="hljs-number">.90</span><span class="hljs-number">.241</span>/<span class="hljs-number">32</span> -p tcp -m tcp --dport <span class="hljs-number">80</span> -j DROP<br>-A OUTPUT -d <span class="hljs-number">154.12</span><span class="hljs-number">.21</span><span class="hljs-number">.70</span>/<span class="hljs-number">32</span> -p tcp -m tcp --dport <span class="hljs-number">80</span> -j DROP<br></code></pre></td></tr></table></figure><h2 id="阿里云漏洞恢复，禁用api的访问"><a href="#阿里云漏洞恢复，禁用api的访问" class="headerlink" title="阿里云漏洞恢复，禁用api的访问"></a>阿里云漏洞恢复，禁用api的访问</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 问题：</span><br>Spring Boot Actuator 未授权访问远程代码执行漏洞【远程扫描】RASP支持实时防护<br><span class="hljs-comment"># 详情</span><br>uat<br><span class="hljs-number">47.116</span><span class="hljs-number">.200</span><span class="hljs-number">.165</span> 公  <span class="hljs-number">172.31</span><span class="hljs-number">.141</span><span class="hljs-number">.179</span> 私<br>漏洞地址：http:<span class="hljs-regexp">//</span><span class="hljs-number">47.116</span><span class="hljs-number">.200</span><span class="hljs-number">.165</span>:<span class="hljs-number">8090</span>/actuator<br>返回特征：nv-toMatch<span class="hljs-string">&quot;:&#123;&quot;</span>href<span class="hljs-string">&quot;:&quot;</span>http:<span class="hljs-regexp">//</span><span class="hljs-number">47.116</span><span class="hljs-number">.200</span><span class="hljs-number">.165</span>:<span class="hljs-number">8090</span>/actuator/env/<span class="hljs-string">&#123;toMatch&#125;</span><span class="hljs-string">&quot;,&quot;</span>templated<span class="hljs-string">&quot;:true&#125;,&quot;</span>env<span class="hljs-string">&quot;:&#123;&quot;</span>href<span class="hljs-string">&quot;:&quot;</span>htt<br><span class="hljs-comment"># 解决：</span><br><span class="hljs-comment"># 在代理里添加禁止访问的二级目录</span><br>[root<span class="hljs-variable">@prod</span>-network conf.d]<span class="hljs-comment"># cat prd-api.conf </span><br>server &#123;<br>        <span class="hljs-keyword">listen</span>  <span class="hljs-number">881</span>;<br><br>        location / &#123;<br>                proxy_pass http:<span class="hljs-regexp">//</span><span class="hljs-number">172.31</span><span class="hljs-number">.141</span><span class="hljs-number">.180</span>:<span class="hljs-number">8090</span>/;<br>                proxy_set_header Host <span class="hljs-variable">$host</span>:<span class="hljs-variable">$server_port</span>;<br>                proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>                proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        &#125;<br><br>        location /doc.html &#123;<span class="hljs-comment"># 访问api接口，返回403</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-number">403</span>;<br>    &#125;<br><br>        location ^~ <span class="hljs-regexp">/actuator/</span>  &#123;<span class="hljs-comment"># 补漏洞，添加以下这两个location</span><br>          deny all;<br>        &#125;<br><br>        location ^~ <span class="hljs-regexp">/actuator  &#123;</span><br><span class="hljs-regexp">          deny all;</span><br><span class="hljs-regexp">        &#125;</span><br><span class="hljs-regexp">&#125;</span><br><span class="hljs-regexp"></span><br><span class="hljs-regexp"># 问题</span><br><span class="hljs-regexp">fastjson &lt;= 1.2.80 反序列化任意代码执行漏洞RASP支持实时防护</span><br><span class="hljs-regexp"># 详情</span><br><span class="hljs-regexp">路径：/r</span>oot/jarfile/portal/zj-shop-portal.jar(BOOT-INF/lib/fastjson-<span class="hljs-number">1.2</span>.<span class="hljs-number">7</span>.jar)<br><span class="hljs-comment"># 解决</span><br>后端更代码漏洞<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>jenkins版本8部署</title>
    <link href="/2025/11/06/jenkins%E7%89%88%E6%9C%AC8%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/jenkins%E7%89%88%E6%9C%AC8%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="1-8版jenkins安装–适应java-8-环境"><a href="#1-8版jenkins安装–适应java-8-环境" class="headerlink" title="1.8版jenkins安装–适应java 8 环境"></a>1.8版jenkins安装–适应java 8 环境</h2><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs perl">dev-jenkins访问地址：<span class="hljs-number">106.15</span><span class="hljs-number">.94</span><span class="hljs-number">.146</span>:<span class="hljs-number">8181</span><br><span class="hljs-comment"># 用户 / 密码 / 邮箱</span><br>zijian / h8G*p%4d<span class="hljs-variable">%vqN</span>*wbJ  / <span class="hljs-number">13921808706</span><span class="hljs-variable">@163</span>.com<br>dev-network-jenkins访问地址：<span class="hljs-number">106.15</span><span class="hljs-number">.94</span><span class="hljs-number">.146</span>:<span class="hljs-number">8182</span><br><span class="hljs-comment"># 用户 / 密码 / 邮箱</span><br>zijian / h8G*p%4d<span class="hljs-variable">%vqN</span>*wbJ  / <span class="hljs-number">13921808706</span><span class="hljs-variable">@163</span>.com<br><br>博客地址：https:<span class="hljs-regexp">//</span>blog.csdn.net/DrakHP/article/details/<span class="hljs-number">136065639</span><br><br>wget https:<span class="hljs-regexp">//a</span>.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/tomcat-jdk/jdk-8u271-linux-x64.tar.gz<br><br>wget https:<span class="hljs-regexp">//a</span>.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/maven-nodejs/apache-maven-<span class="hljs-number">3.9</span>.<span class="hljs-number">3</span>-bin.tar.gz<br><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ls</span><br>anaconda-ks.cfg  apache-maven-<span class="hljs-number">3.9</span>.<span class="hljs-number">3</span>-bin.tar.gz  jdk-8u271-linux-x64.tar.gz<br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># tar xzf apache-maven-3.9.3-bin.tar.gz  -C /usr/local/</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># tar xzf jdk-8u271-linux-x64.tar.gz  -C /usr/local/</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># cd /usr/local/</span><br>[root<span class="hljs-variable">@localhost</span> <span class="hljs-keyword">local</span>]<span class="hljs-comment"># ls</span><br>apache-maven-<span class="hljs-number">3.9</span>.<span class="hljs-number">3</span>  bin  etc  games  include  jdk1.<span class="hljs-number">8.0_271</span>  lib  lib64  libexec  sbin  share  src<br>[root<span class="hljs-variable">@localhost</span> <span class="hljs-keyword">local</span>]<span class="hljs-comment"># mv apache-maven-3.9.3/ maven</span><br>[root<span class="hljs-variable">@localhost</span> <span class="hljs-keyword">local</span>]<span class="hljs-comment"># mv jdk1.8.0_271/ java</span><br>[root<span class="hljs-variable">@localhost</span> <span class="hljs-keyword">local</span>]<span class="hljs-comment"># ls</span><br>bin  etc  games  include  java  lib  lib64  libexec  maven  sbin  share  src<br>[root<span class="hljs-variable">@localhost</span> <span class="hljs-keyword">local</span>]<span class="hljs-comment"># mkdir jenkins</span><br>[root<span class="hljs-variable">@localhost</span> <span class="hljs-keyword">local</span>]<span class="hljs-comment"># cd jenkins/</span><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># ls</span><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment">#  wget https://repo.huaweicloud.com/jenkins/redhat-stable/jenkins-2.346.3-1.1.noarch.rpm</span><br><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># ls</span><br>jenkins-<span class="hljs-number">2.346</span>.<span class="hljs-number">3</span>-<span class="hljs-number">1.1</span>.noarch.rpm<br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># rpm -ivh jenkins-2.346.3-1.1.noarch.rpm</span><br>警告：jenkins-<span class="hljs-number">2.346</span>.<span class="hljs-number">3</span>-<span class="hljs-number">1.1</span>.noarch.rpm: 头V4 RSA/SHA512 Signature, 密钥 ID 45f2c3d5: NOKEY<br>准备中...                          <span class="hljs-comment">################################# [100%]</span><br><span class="hljs-keyword">stat</span>: 无法获取<span class="hljs-string">&quot;/var/cache/jenkins&quot;</span> 的文件状态(<span class="hljs-keyword">stat</span>): 没有那个文件或目录<br><span class="hljs-keyword">stat</span>: 无法获取<span class="hljs-string">&quot;/var/log/jenkins&quot;</span> 的文件状态(<span class="hljs-keyword">stat</span>): 没有那个文件或目录<br><span class="hljs-keyword">stat</span>: 无法获取<span class="hljs-string">&quot;/var/lib/jenkins&quot;</span> 的文件状态(<span class="hljs-keyword">stat</span>): 没有那个文件或目录<br>错误：<span class="hljs-variable">%pre</span>(jenkins-<span class="hljs-number">2.346</span>.<span class="hljs-number">3</span>-<span class="hljs-number">1.1</span>.noarch) 脚本执行失败，退出状态码为 <span class="hljs-number">1</span><br>错误：jenkins-<span class="hljs-number">2.346</span>.<span class="hljs-number">3</span>-<span class="hljs-number">1.1</span>.noarch: 安裝 已失败<br><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># mkdir -p /var/cache/jenkins</span><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># mkdir -p /var/log/jenkins</span><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># mkdir -p /var/lib/jenkins</span><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># rpm -ivh jenkins-2.346.3-1.1.noarch.rpm</span><br>警告：jenkins-<span class="hljs-number">2.346</span>.<span class="hljs-number">3</span>-<span class="hljs-number">1.1</span>.noarch.rpm: 头V4 RSA/SHA512 Signature, 密钥 ID 45f2c3d5: NOKEY<br>准备中...                          <span class="hljs-comment">################################# [100%]</span><br>正在升级/安装...<br>   <span class="hljs-number">1</span>:jenkins-<span class="hljs-number">2.346</span>.<span class="hljs-number">3</span>-<span class="hljs-number">1.1</span>              <span class="hljs-comment">################################# [100%]</span><br><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># vim /etc/profile</span><br><br>JAVA_HOME=<span class="hljs-regexp">/usr/l</span>ocal/java<br>MAVEN_HOME=<span class="hljs-regexp">/usr/l</span>ocal/maven<br>PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$MAVEN_HOME</span>/bin<br>export JAVA_HOME MAVEN_HOME PATH<br>export JENKINS_HOME=<span class="hljs-regexp">/usr/l</span>ocal/jenkins<span class="hljs-comment">#添加到最后一行,并添加环境变量</span><br><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># vim /etc/sysconfig/jenkins</span><br><br>JENKINS_HOME=<span class="hljs-string">&quot;/var/lib/jenkins&quot;</span>改为JENKINS_HOME=<span class="hljs-string">&quot;/usr/local/jenkins&quot;</span><br><br>JENKINS_USER=<span class="hljs-string">&quot;jenkins&quot;</span>改为JENKINS_USER=<span class="hljs-string">&quot;root&quot;</span><br><br>JENKINS_PORT=<span class="hljs-string">&quot;8080&quot;</span>端口改为JENKINS_PORT=<span class="hljs-string">&quot;8181&quot;</span><br><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># source /etc/profile</span><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># which java</span><br>/usr/<span class="hljs-keyword">local</span>/java/bin/java<br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># vim /etc/init.d/jenkins </span><br><br>往下滑，找到 candidates=<br><br>将“”中的最后一行改为我们刚刚得到的jdk路径  /usr/<span class="hljs-keyword">local</span>/java/bin/java<br><br>candidates=<span class="hljs-string">&quot;</span><br><span class="hljs-string">/etc/alternatives/java</span><br><span class="hljs-string">/usr/lib/jvm/java-1.8.0/bin/java</span><br><span class="hljs-string">/usr/lib/jvm/jre-1.8.0/bin/java</span><br><span class="hljs-string">/usr/lib/jvm/java-11.0/bin/java</span><br><span class="hljs-string">/usr/lib/jvm/jre-11.0/bin/java</span><br><span class="hljs-string">/usr/lib/jvm/java-11-openjdk-amd64</span><br><span class="hljs-string">/usr/bin/java</span><br><span class="hljs-string">/usr/local/java/bin/java#直接添加我们刚刚得到的JDK路径</span><br><span class="hljs-string">&quot;</span><br><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># systemctl daemon-reload</span><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># systemctl stop firewalld</span><br>[root<span class="hljs-variable">@localhost</span> jenkins]<span class="hljs-comment"># cd /etc/init.d/</span><br>[root<span class="hljs-variable">@localhost</span> init.d]<span class="hljs-comment"># ls</span><br>functions  jenkins  netconsole  network  README<br>[root<span class="hljs-variable">@localhost</span> init.d]<span class="hljs-comment"># ./jenkins start</span><br><br><span class="hljs-comment">#访问网址：139.224.245.121:8181</span><br><br>接下来，先别安装插件，此时重新输入网址，ip+端口号/pluginManager/advanced<br><br>例如：<span class="hljs-number">139.224</span><span class="hljs-number">.245</span><span class="hljs-number">.121</span>:<span class="hljs-number">8181</span>/pluginManager/advanced<br><br>进入界面后，往下滑，找到Update Site，修改URL<br><br>https:<span class="hljs-regexp">//mirr</span>or.tuna.tsinghua.edu.cn/jenkins/updates/dynamic-stable-<span class="hljs-number">2.346</span>.<span class="hljs-number">1</span>/update-center.json<span class="hljs-comment"># 将原有的更改为这个URL</span><br><br>然后点击上方的Availabale  后  点击Check now<br><br>然后需要重新启动jenkins，更新配置<br><br>输入网址：<span class="hljs-number">172.16</span><span class="hljs-number">.11</span><span class="hljs-number">.31</span>:<span class="hljs-number">8181</span>/restart<br><br>会提示我们是否要重启，点击Yes，等待重启成功<br><br>然后需要再重复一次输入管理面密码的操作，进入finalshell中，输入cat 得到的密码进行访问<br><br><span class="hljs-comment">#访问网址：139.224.245.121:8181</span><br><br><span class="hljs-comment"># 在网关的机器上配置Nginx代理</span><br>server &#123;<br>        <span class="hljs-keyword">listen</span>  <span class="hljs-number">9966</span>;<br><br>        location / &#123;<br>                proxy_pass http:<span class="hljs-regexp">//</span><span class="hljs-number">172.16</span><span class="hljs-number">.174</span><span class="hljs-number">.124</span>:<span class="hljs-number">8181</span>/;<br>                proxy_set_header Host <span class="hljs-variable">$host</span>:<span class="hljs-variable">$server_port</span>;<br>                proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>                proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        &#125;<br>&#125;<br><span class="hljs-comment"># 访问网址：http://106.15.94.146:9966/</span><br><br><span class="hljs-comment"># 用户 / 密码 / 邮箱</span><br>zijian / h8G*p%4d<span class="hljs-variable">%vqN</span>*wbJ  / <span class="hljs-number">13921808706</span><span class="hljs-variable">@163</span>.com<br><br><span class="hljs-comment"># git安装--脚本安装</span><br>密码：Zj123456<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>部署</title>
    <link href="/2025/11/06/%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nginx可视化分类部署</title>
    <link href="/2025/11/06/Nginx%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E7%B1%BB%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/Nginx%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E7%B1%BB%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="部署Nginx可视化界面"><a href="#部署Nginx可视化界面" class="headerlink" title="部署Nginx可视化界面"></a>部署Nginx可视化界面</h2><h3 id="1、长亭雷池SafeLine部署"><a href="#1、长亭雷池SafeLine部署" class="headerlink" title="1、长亭雷池SafeLine部署"></a>1、长亭雷池SafeLine部署</h3><h4 id="最低配置要求"><a href="#最低配置要求" class="headerlink" title="最低配置要求"></a>最低配置要求</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs perl">操作系统：Linux<br>指令架构：x86_64<br>软件依赖：Docker <span class="hljs-number">20.10</span><span class="hljs-number">.14</span> 版本以上<br>软件依赖：Docker Compose <span class="hljs-number">2.0</span>.<span class="hljs-number">0</span> 版本以上<br>最小化环境：<span class="hljs-number">1</span> 核 CPU / <span class="hljs-number">1</span> GB 内存 / <span class="hljs-number">5</span> GB 磁盘<br></code></pre></td></tr></table></figure><h4 id="一键脚本安装"><a href="#一键脚本安装" class="headerlink" title="一键脚本安装"></a>一键脚本安装</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs perl">bash -c <span class="hljs-string">&quot;<span class="hljs-variable">$(</span>curl -fsSLk https://waf-ce.chaitin.cn/release/latest/setup.sh)&quot;</span><br><br><span class="hljs-comment"># 脚本地址</span><br>https:<span class="hljs-regexp">//</span>waf-ce.chaitin.cn/docs/guide/install<br></code></pre></td></tr></table></figure><h3 id="2、nginxWebUI界面部署"><a href="#2、nginxWebUI界面部署" class="headerlink" title="2、nginxWebUI界面部署"></a>2、nginxWebUI界面部署</h3><h4 id="安装jdk、nginx"><a href="#安装jdk、nginx" class="headerlink" title="安装jdk、nginx"></a>安装jdk、nginx</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">bash &lt;(curl -sSL https:<span class="hljs-regexp">//gi</span>tee.com/xbd666/qingfeng/raw/master/toolbox.sh)<br></code></pre></td></tr></table></figure><h4 id="下载nginxWebUI-jarbao"><a href="#下载nginxWebUI-jarbao" class="headerlink" title="下载nginxWebUI.jarbao"></a>下载nginxWebUI.jarbao</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-keyword">mkdir</span> /opt/nginxWebUI/ <br>wget -O /opt/nginxWebUI/nginxWebUI.jar http:<span class="hljs-regexp">//</span>file.nginxwebui.cn/nginxWebUI-<span class="hljs-number">3.8</span>.<span class="hljs-number">2</span>.jar<br></code></pre></td></tr></table></figure><h4 id="启动程序"><a href="#启动程序" class="headerlink" title="启动程序"></a>启动程序</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs perl">nohup java -jar -Dfile.encoding=UTF-<span class="hljs-number">8</span> /opt/nginxWebUI/nginxWebUI.jar --server.port=<span class="hljs-number">8080</span> --project.home=<span class="hljs-regexp">/opt/nginx</span>WebUI/ &gt; <span class="hljs-regexp">/dev/null</span> &amp;<br><span class="hljs-comment"># 端口可以自定义</span><br></code></pre></td></tr></table></figure><h4 id="登入访问页面"><a href="#登入访问页面" class="headerlink" title="登入访问页面"></a>登入访问页面</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs perl">http:<span class="hljs-regexp">//ip</span>:<span class="hljs-number">8080</span>   进入主页<span class="hljs-comment"># 端口可以自定义</span><br><span class="hljs-comment"># 第一次登入需要设置用户名 和 用户密码</span><br><br><span class="hljs-comment"># 在http参数配置中可以配置nginx的http项目，进行http转发，默认会给出几个常用配置，其他需要的配置可自由增删改查。可以勾选开启日志跟踪，生成日志文件</span><br><br><span class="hljs-comment"># 在反向代理中可配置nginx的反向代理即server项功能，可开启ssl功能，可以直接从网页上上传pem文件和key文件，或者使用系统内申请的证书，可以直接开启http转跳https功能，也可开启http2协议</span><br><br><br><span class="hljs-comment"># 在负载均衡中可配置nginx的负载均衡即upstream项功能，在反向代理管理中可选择代理目标为配置好的负载均衡</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>zipkin日志收集部署</title>
    <link href="/2025/11/06/zipkin%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/zipkin%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h2 id="zipkin日志收集部署"><a href="#zipkin日志收集部署" class="headerlink" title="zipkin日志收集部署"></a>zipkin日志收集部署</h2><h3 id="jar包部署"><a href="#jar包部署" class="headerlink" title="jar包部署"></a>jar包部署</h3><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 安装jdk8</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/tomcat-jdk/jdk-8u271-linux-x64.tar.gz</span><br><span class="hljs-comment"># 变量</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># vim /etc/profile</span><br>JAVA_HOME=<span class="hljs-regexp">/usr/l</span>ocal/java<br>MAVEN_HOME=<span class="hljs-regexp">/usr/l</span>ocal/maven<br>PATH=<span class="hljs-variable">$PATH</span>:<span class="hljs-variable">$JAVA_HOME</span>/bin:<span class="hljs-variable">$MAVEN_HOME</span>/bin<br>export JAVA_HOME MAVEN_HOME PATH<br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># source /etc/profile</span><br><br><span class="hljs-comment"># npm环境安装</span><br>这个国内目前知道的只有淘宝有。<br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># alias npm=&quot;npm --registry=https://registry.npm.taobao.org --disturl=https://npm.taobao.org/mirrors/node&quot;</span><br><span class="hljs-comment"># node环境安装（版本：V5.5.0）</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># yum install npm -y</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># git clone https://github.com/creationix/nvm.git /usr/local/nvm</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># source /usr/local/nvm/install.sh</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># nvm --version</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># nvm install v5.5.0#会报错</span><br><span class="hljs-comment"># 解决办法：--在当前用户家目录的.bash_profile文件中添加如下内容</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># cat /root/.bash_profile</span><br>.....<br>export NVM_DIR=<span class="hljs-string">&quot;/usr/local/nvm&quot;</span><br>[ -s <span class="hljs-string">&quot;<span class="hljs-variable">$NVM_DIR</span>/nvm.sh&quot;</span> ] &amp;&amp; . <span class="hljs-string">&quot;<span class="hljs-variable">$NVM_DIR</span>/nvm.sh&quot;</span>  <span class="hljs-comment"># This loads nvm</span><br><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># source /root/.bash_profile</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># nvm install v5.5.0# 再次执行就 OK 了</span><br><br><span class="hljs-comment"># Zipkin安装部署</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># wget -O zipkin.jar &#x27;https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec&#x27;</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># ls</span><br>nohup.out  zipkin.jar<br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment"># nohup java -jar zipkin.jar &amp;               //回车，放到后台去执行</span><br>[root<span class="hljs-variable">@dev</span> ~]<span class="hljs-comment">#  lsof -i:9411</span><br>COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME<br>java    <span class="hljs-number">8440</span> root   33u  IPv6  <span class="hljs-number">64454</span>      0t0  TCP *:<span class="hljs-number">9411</span> (LISTEN)<br><span class="hljs-comment"># 访问</span><br>浏览器输入： IP + <span class="hljs-number">9411</span><br></code></pre></td></tr></table></figure><h3 id="dockers部署zipkin"><a href="#dockers部署zipkin" class="headerlink" title="dockers部署zipkin"></a>dockers部署zipkin</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment"># 搜索</span><br>docker search zipkin<br><span class="hljs-comment"># 下载</span><br>docker pull openzipkin/zipkin<br><span class="hljs-comment"># 运行</span><br>docker <span class="hljs-built_in">run</span> -d -p 9411:9411 openzipkin/zipkin<br><span class="hljs-comment"># 访问</span><br>浏览器输入：<span class="hljs-built_in"> IP </span>+ 9411<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>MongoDB部署</title>
    <link href="/2025/11/06/MongoDB%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/MongoDB%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>MongoDB 是一种开源的文档型 NoSQL 数据库，采用 BSON（二进制 JSON）格式存储数据。以下是 MongoDB 的主要作用和用途：</p><ol><li><p><strong>灵活的数据模型</strong>:</p><ul><li>MongoDB 使用文档存储数据，文档之间可以有不同的结构。这种灵活性使得 MongoDB 非常适合处理不规则和变化频繁的数据。</li></ul></li><li><p><strong>大数据和实时分析</strong>:</p><ul><li>MongoDB 的高性能和扩展性使其适合处理大数据和实时分析应用。它能够快速存储和查询大量数据，并支持实时数据处理。</li></ul></li><li><p><strong>内容管理和目录服务</strong>:</p><ul><li>MongoDB 常用于内容管理系统（CMS）和目录服务，适合存储和管理大量的文档、图像、视频等非结构化数据。</li></ul></li><li><p><strong>物联网（IoT）和传感器数据</strong>:</p><ul><li>由于 MongoDB 可以高效地存储和处理大量的时间序列数据，它非常适合物联网应用中的传感器数据存储和分析。</li></ul></li><li><p><strong>移动应用和社交网络</strong>:</p><ul><li>MongoDB 的灵活性和高性能使其成为移动应用和社交网络的理想选择，能够处理用户生成的内容、用户个人资料、消息和活动流等数据。</li></ul></li><li><p><strong>电子商务</strong>:</p><ul><li>在电子商务平台中，MongoDB 可以用于存储产品目录、用户数据、订单信息等，并支持复杂的查询和数据分析。</li></ul></li><li><p><strong>日志和事件存储</strong>:</p><ul><li>MongoDB 可以用于存储和分析日志数据和事件数据，适用于日志管理、监控和审计等场景。</li></ul></li><li><p><strong>地理空间数据</strong>:</p><ul><li>MongoDB 提供了强大的地理空间查询功能，可以存储和查询地理位置数据，适用于地图服务、定位服务等应用。</li></ul></li><li><p><strong>分布式文件存储</strong>:</p><ul><li>MongoDB 的 GridFS 功能允许存储和检索大文件，如图像、视频和音频文件，适合作为分布式文件存储系统。</li></ul></li><li><p><strong>高可用性和扩展性</strong>:</p><ul><li>MongoDB 支持复制集和分片机制，能够实现数据的高可用性和水平扩展，适合大规模分布式系统。</li></ul></li><li><p><strong>快速开发和迭代</strong>:</p><ul><li>由于 MongoDB 的模式灵活性，开发人员可以快速进行数据模型的修改和应用程序的迭代，适合敏捷开发和快速原型设计。</li></ul></li></ol><p>MongoDB 的文档存储模型、灵活性、高性能和扩展性使其成为现代应用程序中处理多样化和大规模数据的理想选择。</p><h4 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h4><ul><li><strong>CPU</strong>:  4 核 </li><li><strong>内存</strong>: 32GB </li><li><strong>存储</strong>: 500G</li><li><strong>节点</strong>：1</li></ul><h4 id="网络端口"><a href="#网络端口" class="headerlink" title="网络端口"></a>网络端口</h4><ul><li><p><strong>默认端口</strong></p><ul><li><p><strong>端口号</strong>: 27017</p></li><li><p><strong>用途</strong>: MongoDB 默认的客户端连接端口，用于应用程序和用户连接到 MongoDB 数据库进行数据操作。</p></li></ul></li><li><p><strong>副本集成员之间的通信端口</strong></p><ul><li><strong>端口号</strong>: 27017（默认）</li><li><strong>用途</strong>: 副本集成员之间通过该端口进行数据同步和心跳检测。</li></ul></li><li><p><strong>分片集群配置服务器端口</strong></p><ul><li><strong>端口号</strong>: 27019</li><li><strong>用途</strong>: 分片集群中的配置服务器使用的默认端口。</li></ul></li><li><p><strong>分片服务器端口</strong></p><ul><li><strong>端口号</strong>: 27018</li></ul></li></ul><h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 下载安装包</span><br>wget https:<span class="hljs-regexp">//</span>fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-<span class="hljs-number">4.0</span>.<span class="hljs-number">6</span>.tgz<br>curl -O https:<span class="hljs-regexp">//</span>fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-<span class="hljs-number">3.4</span><span class="hljs-number">.24</span>.tgz<br><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ls</span><br>anaconda-ks.cfg  mongodb-linux-x86_64-rhel70-<span class="hljs-number">4.0</span>.<span class="hljs-number">6</span>.tgz<br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># systemctl stop friewalld</span><br>Failed to stop friewalld.service: Unit friewalld.service <span class="hljs-keyword">not</span> loaded.<br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># setenforce 0</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># systemctl disable firewalld</span><br>Removed <span class="hljs-keyword">symlink</span> /etc/systemd/<span class="hljs-keyword">system</span>/multi-user.target.wants/firewalld.service.<br>Removed <span class="hljs-keyword">symlink</span> /etc/systemd/<span class="hljs-keyword">system</span>/dbus-org.fedoraproject.FirewallD1.service.<br><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ulimit -n</span><br><span class="hljs-number">1024</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ulimit -n 65535</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ulimit -n</span><br><span class="hljs-number">65535</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ulimit -u</span><br><span class="hljs-number">63447</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ulimit -u 65535</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ulimit -u</span><br><span class="hljs-number">65535</span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># vim  /etc/rc.local </span><br>[root<span class="hljs-variable">@localhost</span> ~]<span class="hljs-comment"># ls</span><br>anaconda-ks.cfg  mongodb-linux-x86_64-rhel70-<span class="hljs-number">4.0</span>.<span class="hljs-number">6</span>.tgz<br><br>[root<span class="hljs-variable">@worker02</span> ~]<span class="hljs-comment"># mkdir /data/mongodb</span><br>[root<span class="hljs-variable">@worker02</span> ~]<span class="hljs-comment"># tar xzf mongodb-linux-x86_64-rhel70-4.0.6.tgz -C /data/mongodb/</span><br>[root<span class="hljs-variable">@worker02</span> mongodb]<span class="hljs-comment"># mv mongodb-linux-x86_64-rhel70-4.0.6/ mongodb</span><br><br>[root<span class="hljs-variable">@worker02</span> mongodb]<span class="hljs-comment"># ln -s /data/mongodb/mongodb/bin/* /bin/</span><br><br>[root<span class="hljs-variable">@worker02</span> mongodb]<span class="hljs-comment"># mkdir  data</span><br>[root<span class="hljs-variable">@worker02</span> mongodb]<span class="hljs-comment"># mkdir logs</span><br>[root<span class="hljs-variable">@worker02</span> mongodb]<span class="hljs-comment"># touch logs/mongodb.log</span><br><br>[root<span class="hljs-variable">@worker02</span> mongodb]<span class="hljs-comment"># ls</span><br>data  logs  mongodb<br>[root<span class="hljs-variable">@worker02</span> mongodb]<span class="hljs-comment"># mkdir conf</span><br>[root<span class="hljs-variable">@worker02</span> mongodb]<span class="hljs-comment"># vim conf/mongodb.conf</span><br><span class="hljs-comment"># 添加以下内容</span><br>port=<span class="hljs-number">27017</span><br>dbpath=<span class="hljs-regexp">/data/m</span>ongodb/data<br>logpath=<span class="hljs-regexp">/data/m</span>ongodb/logs/mongodb.log<br>logappend=true<br><span class="hljs-keyword">fork</span>=true<br>maxConns=<span class="hljs-number">5000</span><br><span class="hljs-comment"># 将存储引擎切换为 WiredTiger</span><br>storageEngine=wiredTiger  <br><span class="hljs-comment"># 绑定到所有 IP 地址</span><br>bind_ip=<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>  <br><span class="hljs-comment"># 启用访问控制</span><br>auth=true<br><br><span class="hljs-comment"># 启动</span><br>[root<span class="hljs-variable">@worker02</span> mongodb]<span class="hljs-comment"># /data/mongodb/mongodb/bin/mongod -f /data/mongodb/conf/mongodb.conf </span><br>about to <span class="hljs-keyword">fork</span> child process, waiting <span class="hljs-keyword">until</span> server is ready <span class="hljs-keyword">for</span> connections.<br>forked process: <span class="hljs-number">1834</span><br>[root<span class="hljs-variable">@localhost</span> mongodb]<span class="hljs-comment">#  netstat -lnpt | grep mongod</span><br>tcp        <span class="hljs-number">0</span>      <span class="hljs-number">0</span> <span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">27017</span>         <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>:*               LISTEN      <span class="hljs-number">1834</span>/mongod<br>[root<span class="hljs-variable">@localhost</span> mongodb]<span class="hljs-comment"># ps aux | grep mongod | grep -v grep</span><br>root      <span class="hljs-number">1834</span> <span class="hljs-number">24.7</span>  <span class="hljs-number">0</span>.<span class="hljs-number">5</span> <span class="hljs-number">1502384</span> <span class="hljs-number">96948</span> ?       Sl   <span class="hljs-number">5</span>月<span class="hljs-number">27</span>   <span class="hljs-number">1</span>:<span class="hljs-number">41</span> /usr/<span class="hljs-keyword">local</span>/mongodb/bin/mongod -f /usr/<span class="hljs-keyword">local</span>/mongodb/conf/mongodb1.conf<br>设置开机自动启动<br>[root<span class="hljs-variable">@mongodb</span> mongodb]<span class="hljs-comment"># vim /etc/rc.local</span><br>rm -f /data/mongodb1/mongod.lock<br>mongod -f /usr/<span class="hljs-keyword">local</span>/mongodb/conf/mongodb1.conf<br>[root<span class="hljs-variable">@localhost</span> mongodb]<span class="hljs-comment"># mongo</span><br>MongoDB shell version <span class="hljs-number">v4.0</span>.<span class="hljs-number">6</span><br>connecting to: mongodb:<span class="hljs-regexp">//</span><span class="hljs-number">127.0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">1</span>:<span class="hljs-number">27017</span>/?gssapiServiceName=mongodb<br>Implicit session: session &#123; <span class="hljs-string">&quot;id&quot;</span> : UUID(<span class="hljs-string">&quot;be032cef-e2b3-4856-927c-0a560a40d1fd&quot;</span>) &#125;<br>MongoDB server version: <span class="hljs-number">4.0</span>.<span class="hljs-number">6</span><br>Welcome to the MongoDB shell.<br><br><br>&gt; show dbs<br>admin   <span class="hljs-number">0</span>.078GB<br>config  <span class="hljs-number">0</span>.078GB<br><span class="hljs-keyword">local</span>   <span class="hljs-number">0</span>.078GB<br>&gt; <span class="hljs-keyword">exit</span><br></code></pre></td></tr></table></figure><pre><code class="hljs">报错处理：dmesg | grep -i watchdogjournalctl -k | grep -i watchdogvim /etc/sysctl.conf添加以下内容kernel.watchdog_thresh = 60#使其生效 sysctl -p#启动/data/mongodb/mongodb/bin/mongod -f /data/mongodb/conf/mongodb.conf # 可做可不做--作用是禁用透明大页vim /etc/default/grub添加以下内容GRUB_CMDLINE_LINUX=&quot;... transparent_hugepage=never&quot;</code></pre>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>TDEngine时序数据库部署</title>
    <link href="/2025/11/06/TDEngine%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/TDEngine%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="TDEngine–集群"><a href="#TDEngine–集群" class="headerlink" title="TDEngine–集群"></a>TDEngine–集群</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>TDEngine 是一种高性能、分布式、时间序列数据库（TSDB），专门为物联网（IoT）、工业互联网、车联网、金融、IT 运维监控等领域设计。它具有高效的数据写入和查询性能，适合处理大规模的时间序列数据。以下是 TDEngine 的主要作用和用途：</p><ol><li><p><strong>物联网（IoT）数据存储和分析</strong>:</p><ul><li>TDEngine 能够高效地存储和处理来自各种 IoT 设备和传感器的大量时间序列数据，支持实时数据写入和复杂查询。</li></ul></li><li><p><strong>工业互联网</strong>:</p><ul><li>在工业互联网应用中，TDEngine 可以用于存储和分析工业设备的运行数据、传感器数据、生产线数据等，帮助进行设备监控、预测性维护和优化生产流程。</li></ul></li><li><p><strong>车联网</strong>:</p><ul><li>TDEngine 能够存储和处理车辆的运行数据、位置数据、传感器数据等，支持实时数据分析和查询，适用于车联网应用中的数据管理和分析。</li></ul></li><li><p><strong>金融数据分析</strong>:</p><ul><li>在金融领域，TDEngine 可以用于存储和分析股票、期货、外汇等金融市场的时间序列数据，支持高频交易数据的存储和实时查询分析。</li></ul></li><li><p><strong>IT 运维监控</strong>:</p><ul><li>TDEngine 适用于 IT 运维监控场景，可以存储和分析服务器性能数据、应用程序日志、网络流量数据等，帮助运维人员进行系统监控和故障排除。</li></ul></li><li><p><strong>高效的数据写入和查询</strong>:</p><ul><li>TDEngine 具有高效的数据写入和查询性能，能够处理每秒数百万条数据的写入和查询操作，适合大规模时间序列数据的存储和分析。</li></ul></li><li><p><strong>分布式架构</strong>:</p><ul><li>TDEngine 采用分布式架构，支持数据的水平扩展和高可用性，能够处理海量数据并保证系统的稳定性和可靠性。</li></ul></li><li><p><strong>内置计算能力</strong>:</p><ul><li>TDEngine 提供了丰富的内置计算能力，包括聚合计算、统计分析、数据过滤等，支持复杂的查询和数据分析操作。</li></ul></li><li><p><strong>低存储成本</strong>:</p><ul><li>TDEngine 采用高效的数据压缩算法，能够显著降低存储成本，同时保证数据的高效查询和分析。</li></ul></li><li><p><strong>支持多种数据接口</strong>:</p><ul><li>TDEngine 支持多种数据接口和协议，包括 SQL、RESTful API、MQTT 等，方便与各种应用和系统进行集成。</li></ul></li><li><p><strong>实时流处理</strong>:</p><ul><li>TDEngine 支持实时流处理，可以对流数据进行实时计算和分析，适用于需要实时数据处理的应用场景。</li></ul></li></ol><p>综上所述，TDEngine 是一种专门为时间序列数据设计的高性能数据库，适合处理大规模、高频率的时间序列数据，广泛应用于物联网、工业互联网、车联网、金融、IT 运维监控等领域。</p><h4 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h4><ul><li><strong>CPU</strong>: 4 核 </li><li><strong>内存</strong>:  8 GB </li><li><strong>存储</strong>: 1T</li><li><strong>节点</strong>：2</li></ul><h4 id="网络端口"><a href="#网络端口" class="headerlink" title="网络端口"></a>网络端口</h4><ul><li><p><strong>客户端连接端口</strong></p><ul><li><p><strong>默认端口</strong>: 6030</p></li><li><p><strong>用途</strong>: 客户端（如应用程序、用户）通过该端口连接到 TDEngine 进行数据查询和写入操作。</p></li></ul></li><li><p><strong>管理端口</strong></p><ul><li><strong>默认端口</strong>: 6041</li><li><strong>用途</strong>: 用于 TDEngine 管理工具（如 taos）连接到服务器进行管理操作。</li></ul></li><li><p><strong>数据传输端口</strong></p><ul><li><strong>默认端口</strong>: 6042</li><li><strong>用途</strong>: 用于集群内部节点之间的数据传输和同步。</li></ul></li><li><p><strong>RESTful API 端口</strong></p><ul><li><strong>默认端口</strong>: 6043</li><li><strong>用途</strong>: 提供 RESTful API 服务，允许通过 HTTP 协议进行数据操作。</li></ul></li><li><p><strong>MQTT 端口</strong></p><ul><li><strong>默认端口</strong>: 6044</li><li><strong>用途</strong>: 支持 MQTT 协议，用于物联网设备的数据接入。</li></ul></li></ul><h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><pre><code class="hljs">#下载地址https://docs.taosdata.com/get-started/package/#!从列表中下载获得 tar.gz 安装包；TDengine-server-3.1.1.0-Linux-x64.tar.gz (126.7 M)      # Linux客户端下载# 创建目录mkdir -p /data/tasosi# 解压到指定目录tar xzf TDengine-server-3.1.1.0-Linux-x64.tar.gz -C /data/tasosi/# 切换目录cd /data/tasosi/TDengine-server-3.1.1.0/# 启动./install.sh -e no# install.sh 安装脚本在执行过程中，会通过命令行交互界面询问一些配置信息。如果希望采取无交互安装方式，那么可以运行 ./install.sh -e no。运行 ./install.sh -h 指令可以查看所有参数的详细说明信息。# 安装是交互式操作1、提供机器的 IP 地址：#填写本机的IP2、当安装第一个节点时，出现 Enter FQDN: 提示的时候，不需要输入任何内容。只有当安装第二个或以后更多的节点时，才需要输入已有集群中任何一个可用节点的 FQDN，支持该新节点加入集群。当然也可以不输入，而是在新节点启动前，配置到新节点的配置文件中：#直接回车3、选择是否输入电子邮件地址，选择跳过： #直接回车# 先不要启动--添加好集群再启动-单节点直接启动vim  /etc/taos/taos.cfg    # 此文件下可以修改端口，增加节点，修改数据、日记的存储目录# firstEp     hostname:6030  改为  firstEp       10.100.40.171:6030fqdn          10.100.40.171  改为  写本机的IP地址logDir                    /data/tasosi/logdataDir                   /data/tasosi/data#创建目录并赋予权限mkdir -p /data/tasosi/datamkdir -p /data/tasosi/logchown -R taos:taos /data/tasosi/datachown -R taos:taos /data/tasosi/logchmod -R 755 /data/tasosi/*# 复制原有数据--如果是有数据的前提下# cp -r /var/lib/taos /data/tasosi/data# 所有集群的配置文件都改好后-从节点一按顺序启动systemctl start taosd# 所有的启动后在（主节点）上添加集群taosshow dnodes;create dnode &quot;10.100.40.172&quot;;  #若有多个添加多次IP，从节点的IP # 验证show dnodes;   # 此时就可以看到多台集群信息了# 删除节点DROP DNODE &quot;fqdn:port&quot;;或DROP DNODE dnodeId;扩展：# 启动命令分为systemctl start taosdsystemctl start taosadaptersystemctl start taoskeepersystemctl start taos-explorersystemctl stop taosdsystemctl restart taosdsystemctl status taosd如果系统中不支持 systemd，也可以用手动运行 /usr/local/taos/bin/taosd 方式启动 TDengine 服务# 进入命令taos# 在 TDengine CLI 中，用户可以通过 SQL 命令来创建/删除数据库、表等，并进行数据库（Database）插入查询操作。在终端中运行的 SQL 语句需要以分号（;）结束来运行。示例：CREATE DATABASE demo;USE demo;CREATE TABLE t (ts TIMESTAMP, speed INT);INSERT INTO t VALUES (&#39;2019-07-15 00:00:00&#39;, 10);INSERT INTO t VALUES (&#39;2019-07-15 01:00:00&#39;, 20);SELECT * FROM t;           ts            |    speed    |======================================== 2019-07-15 00:00:00.000 |          10 | 2019-07-15 01:00:00.000 |          20 |Query OK, 2 row(s) in set (0.003128s)# 修改端口号vim /etc/taos/taos.cfg# 此文件下可以修改端口，增加节点，修改数据、日记的存储目录</code></pre>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Nacos集群部署</title>
    <link href="/2025/11/06/Nacos%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/06/Nacos%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="Nacos–集群"><a href="#Nacos–集群" class="headerlink" title="Nacos–集群"></a>Nacos–集群</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>Nacos（Dynamic Naming and Configuration Service）是阿里巴巴开源的一个动态服务发现、配置管理和服务管理平台。它主要用于微服务架构中的服务注册与发现、分布式配置管理和动态 DNS 服务。Nacos 的核心功能和作用如下：</p><ol><li><strong>服务发现和注册</strong></li></ol><ul><li><strong>服务注册</strong>：Nacos 允许服务实例在启动时向 Nacos 注册自己的信息（如 IP 地址、端口、服务名称等），从而使其他服务能够发现它们。</li><li><strong>服务发现</strong>：服务消费者可以通过 Nacos 查询到所需服务的实例信息，从而实现服务间的调用。Nacos 支持多种服务发现机制，如 DNS 和 HTTP。</li></ul><ol start="2"><li><strong>分布式配置管理</strong></li></ol><ul><li><strong>配置管理</strong>：Nacos 提供了集中化的配置管理功能，允许开发者将应用配置存储在 Nacos 服务器上。配置的变更可以实时推送到各个服务实例，避免了因配置变更而重启服务的需求。</li><li><strong>动态配置</strong>：通过 Nacos，配置可以在运行时动态更新，服务实例会自动感知配置的变化并做出相应调整。</li></ul><ol start="3"><li><strong>动态 DNS 服务</strong></li></ol><ul><li><strong>动态 DNS</strong>：Nacos 支持动态 DNS 服务，可以将服务名解析为服务实例的 IP 地址和端口，方便服务间的调用和负载均衡。</li></ul><ol start="4"><li><strong>集群管理</strong></li></ol><ul><li><strong>集群管理</strong>：Nacos 支持对服务实例进行健康检查和集群管理，确保服务的高可用性和可靠性。它可以自动剔除不健康的实例，并在实例恢复后重新加入到服务列表中。</li></ul><ol start="5"><li><strong>多语言支持</strong></li></ol><ul><li><strong>多语言支持</strong>：Nacos 提供了丰富的客户端 SDK，支持 Java、Go、C++ 等多种编程语言，方便开发者在不同语言的项目中集成 Nacos。</li></ul><ol start="6"><li><strong>可视化管理界面</strong></li></ol><ul><li><strong>可视化界面</strong>：Nacos 提供了友好的 Web 管理界面，方便开发者和运维人员对服务和配置进行管理和监控。</li></ul><ol start="7"><li><strong>高可用和扩展性</strong></li></ol><ul><li><strong>高可用</strong>：Nacos 支持集群部署，保证服务的高可用性和容错性。</li><li><strong>扩展性</strong>：Nacos 设计灵活，支持插件机制，可以根据需要扩展功能。</li></ul><p><strong>典型应用场景</strong></p><ol><li><strong>微服务架构</strong>：在微服务架构中，Nacos 作为服务注册与发现的核心组件，简化了服务间的通信和管理。</li><li><strong>分布式系统</strong>：在分布式系统中，Nacos 提供集中化的配置管理，简化了配置的管理和推送。</li><li><strong>云原生应用</strong>：在云原生应用中，Nacos 提供动态 DNS 和服务发现功能，支持服务的弹性伸缩和动态管理。</li></ol><h4 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h4><ul><li><strong>CPU</strong>: 4 核 </li><li><strong>内存</strong>:  8 GB </li><li><strong>存储</strong>: 300G</li><li><strong>节点</strong>：2</li></ul><h4 id="网络端口"><a href="#网络端口" class="headerlink" title="网络端口"></a>网络端口</h4><ol><li><strong>默认端口</strong><ul><li><strong>端口号</strong>: 8848</li><li><strong>用途</strong>: Nacos 的 HTTP API 端口，用于服务注册、配置管理和其他 API 调用。</li></ul></li><li><strong>集群通信端口</strong><ul><li><strong>端口号</strong>: 7848</li><li><strong>用途</strong>: Nacos 集群节点之间的通信端口。</li></ul></li></ol><h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><pre><code class="hljs"># 安装jdkwget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/tomcat-jdk/jdk-8u271-linux-x64.tar.gzjdk在/usr/local目录下，设置变量# 下载nacos安装包wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/nacos/nacos-server-1.2.1.tar.gz#创建目录mkdir -p /data/nacos# 解压tar xzf nacos-server-2.3.2.tar.gz -C /data/nacoscd /data/nacos/nacos/conf# 编辑连数据库的 配置文件vim application.properties更改以下内容spring.datasource.platform=mysql      # 去除注释# spring.sql.init.platform=mysql### Count of DB:db.num=1    # 去除注释### Connect URL of DB:db.url.0=jdbc:mysql://10.100.40.171:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC    # 改MySQL机器的IP地址db.user.0=root     # 改为root用户db.password.0=Kunyue@123     # 改为MySQL的密码spring.data.dir=/data/nacos/data#定义数据存放目录#创建目录mkdir -p /data/nacos/datachmod -R 755 /data/nacos# 导入数据--并创建nacos数据库CREATE USER &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39;;GRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39;;flush privileges;# 编辑集群配置文件--添加集群IP地址cp cluster.conf.example cluster.conf.example.bakmv cluster.conf.example cluster.confvim cluster.conf添加nacos集群的IP地址10.100.40.170:884810.100.40.171:884810.100.40.172:8848# 启动./bin/startup.sh# 停止./bin/shutdown.sh# 登入、验证http://IP + 8848/nacos在web界面左侧栏--集群管理--节点管理   # 可以看到所有集群的状态                                 ### 开启鉴权通过base64命令随机生成token[root@emqx01 conf]# echo -n &#39;ThisIsARandomlyGeneratedSecureKey32CharactersLong&#39; | base64VGhpc0lzQVJhbmRvbWx5R2VuZXJhdGVkU2VjdXJlS2V5MzJDaGFyYWN0ZXJzTG9uZw==#编辑配置vim /data/nacos/nacos/conf/application.propertiesnacos.core.auth.enabled=true### 关闭使用user-agent判断服务端请求并放行鉴权的功能nacos.core.auth.enable.userAgentAuthWhite=false### 配置自定义身份识别的key（不可为空）和value（不可为空）nacos.core.auth.server.identity.key=examplenacos.core.auth.server.identity.value=examplenacos.core.auth.plugin.nacos.token.secret.key=VGhpc0lzQVJhbmRvbWx5R2VuZXJhdGVkU2VjdXJlS2V5MzJDaGFyYWN0ZXJzTG9uZw==</code></pre>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>EMQX集群部署</title>
    <link href="/2025/11/05/EMQX%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/05/EMQX%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="emqx–集群"><a href="#emqx–集群" class="headerlink" title="emqx–集群"></a>emqx–集群</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>EMQX（Erlang MQTT Broker）是一个高性能、可扩展的开源 MQTT 消息代理服务器。它基于 Erlang&#x2F;OTP 开发，专为大规模物联网（IoT）应用设计。EMQX 的核心作用和功能如下：</p><ol><li><strong>消息代理</strong>：EMQX 作为 MQTT 消息代理，负责在发布者和订阅者之间路由消息。它支持 MQTT 协议的所有功能，包括 QoS（Quality of Service）级别、持久会话和遗嘱消息等。</li><li><strong>设备连接管理</strong>：EMQX 可以管理大量 IoT 设备的连接，支持数百万级别的并发连接，适用于大规模的物联网应用。</li><li><strong>数据分发</strong>：EMQX 能够高效地分发数据，确保消息在发布者和订阅者之间的快速传递，支持多种消息格式和传输协议。</li><li><strong>扩展性</strong>：EMQX 支持插件机制，用户可以根据需求扩展其功能，如数据持久化、规则引擎、认证和授权等。</li></ol><p><strong>主要功能</strong></p><ol><li><p><strong>支持多种协议</strong></p><ul><li><strong>MQTT&#x2F;MQTT-SN</strong>：原生支持 MQTT 3.1.1 和 MQTT 5.0 协议。</li><li><strong>HTTP&#x2F;HTTPS</strong>：支持通过 HTTP&#x2F;HTTPS 协议进行消息发布和订阅。</li><li><strong>CoAP</strong>：支持 Constrained Application Protocol（CoAP），适用于资源受限的设备。</li><li><strong>WebSocket</strong>：支持通过 WebSocket 进行 MQTT 通信，方便 Web 应用集成。</li></ul></li><li><p><strong>高性能和高可用性</strong></p><ul><li><strong>高并发连接</strong>：支持数百万级别的并发连接，适用于大规模 IoT 部署。</li><li><strong>集群支持</strong>：支持集群部署，提供高可用性和负载均衡。</li><li><strong>水平扩展</strong>：可以通过增加节点来扩展系统容量。</li></ul></li><li><p><strong>安全性</strong></p><ul><li><strong>认证和授权</strong>：支持多种认证方式（如用户名&#x2F;密码、客户端证书、LDAP 等）和细粒度的访问控制。</li><li><strong>加密通信</strong>：支持 TLS&#x2F;SSL 加密，确保数据传输的安全性。</li></ul></li><li><p><strong>规则引擎</strong></p><ul><li><strong>数据处理</strong>：内置规则引擎，可以根据预定义的规则对消息进行处理、过滤和转发。</li><li><strong>集成外部系统</strong>：支持与数据库、消息队列、HTTP 服务等外部系统集成。</li></ul></li><li><p><strong>监控和管理</strong></p><ul><li><strong>管理控制台</strong>：提供友好的 Web 管理控制台，方便用户进行配置和管理。</li><li><strong>监控和告警</strong>：支持实时监控系统状态和性能，提供告警机制。</li></ul></li></ol><p><strong>典型应用场景</strong></p><ol><li><strong>智能家居</strong>：管理和控制大量智能家居设备，实现设备间的消息通信和数据共享。</li><li><strong>工业物联网</strong>：在工业环境中，管理各种传感器和设备的数据采集和传输。</li><li><strong>车联网</strong>：支持车辆与云端的实时通信，管理车辆数据和远程控制。</li><li><strong>智慧城市</strong>：管理城市基础设施（如路灯、交通信号灯、环境监测设备等）的数据通信。</li></ol><h4 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h4><ul><li><strong>CPU</strong>: 4 核 </li><li><strong>内存</strong>:  8 GB </li><li><strong>存储</strong>: 300G</li><li><strong>节点</strong>：2</li></ul><h4 id="网络端口"><a href="#网络端口" class="headerlink" title="网络端口"></a>网络端口</h4><ol><li><strong>默认管理端口</strong><ul><li><strong>端口号</strong>: 18083</li><li><strong>用途</strong>: EMQX Dashboard（管理控制台）端口，用于管理和监控 EMQX。</li></ul></li><li><strong>MQTT 端口</strong><ul><li><strong>端口号</strong>: 1883</li><li><strong>用途</strong>: MQTT 协议默认端口，用于客户端连接。</li></ul></li><li><strong>MQTT&#x2F;TLS 端口</strong><ul><li><strong>端口号</strong>: 8883</li><li><strong>用途</strong>: 使用 TLS&#x2F;SSL 加密的 MQTT 连接端口。</li></ul></li><li><strong>WebSocket 端口</strong><ul><li><strong>端口号</strong>: 8083</li><li><strong>用途</strong>: 支持 WebSocket 的 MQTT 连接端口。</li></ul></li><li><strong>WebSocket&#x2F;TLS 端口</strong><ul><li><strong>端口号</strong>: 8084</li><li><strong>用途</strong>: 使用 TLS&#x2F;SSL 加密的 WebSocket 连接端口。</li></ul></li><li><strong>集群通信端口</strong><ul><li><strong>端口号</strong>: 4369, 6000-6999</li><li><strong>用途</strong>: EMQX 集群节点之间的通信端口。</li></ul></li></ol><h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><pre><code class="hljs"># 下载安装包wget https://www.emqx.com/zh/downloads/broker/5.7.0/emqx-5.7.0-el7-amd64.tar.gzmkdir -p /data/emqx/data# 创建目录、解压mkdir -p /data/emqx/data &amp;&amp; tar -zxvf emqx-5.7.0-el7-amd64.tar.gz -C /data/emqx# 编辑配置文件cd /data/emqxvim etc/emqx.conf# 将原有的改为以下内容--在每个节点上添加更改，更后按顺序启动node &#123;  name = &quot;emqx@10.100.40.171&quot;     # 本机IP  cookie = &quot;emqxsecretcookie&quot;  data_dir = &quot;/data/emqx/data&quot;     # 数据存放目录&#125;cluster &#123;  name = emqxcl  discovery_strategy = manual  static &#123;    seeds = [      &quot;emqx@10.100.40.171&quot;,     # 添加集群      &quot;emqx@10.100.40.172&quot;    ]  &#125;&#125;# 启动./emqx/bin/emqx start# 加入集群--在从机器上操作cd /data/emqx./bin/emqx_ctl cluster join emqx@10.100.40.172      # 在从机器上操作，写主节点的IP# 验证--在主机器上操作，查看状态./bin/emqx_ctl cluster status# 验证数据目录路径[root@emqx01 data]# grep &#39;data_dir&#39; /data/emqx/etc/emqx.conf  data_dir = &quot;/data/emqx/data&quot;# 访问10.1.15.101:18083默认账号: admin 默认密码：public10.1.15.102:18083默认账号: admin 默认密码：public</code></pre>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Minio存储部署</title>
    <link href="/2025/11/05/Minio%E5%AD%98%E5%82%A8%E9%83%A8%E7%BD%B2/"/>
    <url>/2025/11/05/Minio%E5%AD%98%E5%82%A8%E9%83%A8%E7%BD%B2/</url>
    
    <content type="html"><![CDATA[<h3 id="minio–单节点"><a href="#minio–单节点" class="headerlink" title="minio–单节点"></a>minio–单节点</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>MinIO 是一个高性能的对象存储服务器，兼容 Amazon S3 API。它主要用于存储海量的非结构化数据，如图片、视频、备份文件、日志文件等。MinIO 是开源的，并且设计为云原生应用，适用于私有云、公有云和混合云环境。</p><ol><li><p><strong>对象存储</strong>：</p><ul><li>MinIO 提供了对象存储服务，允许用户存储和检索任意数量的非结构化数据。</li><li>数据以对象的形式存储，每个对象包含文件数据、元数据和唯一的对象标识符。</li></ul></li><li><p><strong>兼容 S3 API</strong>：</p><ul><li>MinIO 兼容 Amazon S3 API，这意味着使用 S3 API 的应用可以无缝迁移到 MinIO。</li><li>支持常用的 S3 操作，如创建桶（bucket）、上传&#x2F;下载对象、设置权限等。</li></ul></li><li><p><strong>高性能</strong>：</p><ul><li>MinIO 设计为高性能对象存储，能够在标准硬件上提供极高的吞吐量和低延迟。</li><li>适用于需要快速数据访问的场景，如实时数据分析、机器学习等。</li></ul></li><li><p><strong>可扩展性</strong>：</p><ul><li>MinIO 支持水平扩展，通过增加节点可以扩展存储容量和处理能力。</li><li>支持分布式部署，适用于大规模存储需求。</li></ul></li><li><p><strong>高可用性</strong>：</p><ul><li>MinIO 提供数据冗余和自动故障恢复，确保数据的高可用性和可靠性。</li><li>支持多副本存储和纠删码（Erasure Coding）技术，防止数据丢失。</li></ul></li><li><p><strong>安全性</strong>：</p><ul><li>MinIO 支持数据加密、访问控制和审计日志，确保数据存储和传输的安全性。</li><li>支持基于角色的访问控制（RBAC）和细粒度的权限管理。</li></ul></li><li><p><strong>多云和混合云支持</strong>：</p><ul><li>MinIO 可以在私有云、公有云和混合云环境中部署，支持跨云的数据管理。</li><li>提供统一的存储接口，简化多云环境中的数据管理。</li></ul></li></ol><h4 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h4><ul><li><strong>CPU</strong>: 4 核 </li><li><strong>内存</strong>:  8 GB </li><li><strong>存储</strong>: 4T</li><li><strong>节点</strong>：1</li></ul><h4 id="网络端口"><a href="#网络端口" class="headerlink" title="网络端口"></a>网络端口</h4><ol><li><strong>默认服务端口</strong><ul><li><strong>端口号</strong>: 9000</li><li><strong>用途</strong>: MinIO API 服务端口，用于客户端与 MinIO 服务器的通信。</li></ul></li><li><strong>控制台端口（Console）</strong><ul><li><strong>端口号</strong>: 9001</li><li><strong>用途</strong>: MinIO 控制台（管理界面）端口，用于管理和监控 MinIO。</li></ul></li></ol><h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><pre><code class="hljs"># 下载docker# 下载minio镜像docker pull minio/minio:RELEASE.2024-05-27T19-17-46Z.fips# 创建目录mkdir -p /data/minio/data#启动docker run -d \   --net=host \   --user $(id -u):$(id -g) \   --name minio \   -e &quot;MINIO_ROOT_USER=minioadmin&quot; \   -e &quot;MINIO_ROOT_PASSWORD=minioadmin&quot; \   -v /data/minio/data:/data \   minio/minio:RELEASE.2024-05-27T19-17-46Z.fips server /data --console-address &quot;:9001&quot; --address &quot;:9000&quot;    # 访问：http://10.100.40.212:9001/login 用户名：密码  minioadmin：minioadmin</code></pre>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>kkFileview文件预览</title>
    <link href="/2025/11/05/kkFileview%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88/"/>
    <url>/2025/11/05/kkFileview%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88/</url>
    
    <content type="html"><![CDATA[<h3 id="kkfileview–单节点"><a href="#kkfileview–单节点" class="headerlink" title="kkfileview–单节点"></a>kkfileview–单节点</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ol><li><strong>文档预览</strong>：<ul><li>支持预览多种文档格式，如 Word（.doc、.docx）、Excel（.xls、.xlsx）、PowerPoint（.ppt、.pptx）、PDF、TXT、图片（.jpg、.png、.gif）等。</li><li>用户无需下载文件即可在浏览器中查看文档内容。</li></ul></li><li><strong>跨平台支持</strong>：<ul><li>兼容多种操作系统和浏览器，用户可以在不同设备上进行文档预览。</li></ul></li><li><strong>集成简单</strong>：<ul><li>提供 RESTful API，方便与其他系统集成，如文件管理系统、内容管理系统（CMS）、企业内部系统等。</li><li>通过简单的 HTTP 请求即可实现文档预览功能。</li></ul></li><li><strong>高性能</strong>：<ul><li>采用高效的文档转换和渲染技术，确保文档预览的速度和质量。</li><li>支持缓存机制，提高文档预览的响应速度。</li></ul></li><li><strong>安全性</strong>：<ul><li>提供多种安全配置选项，如访问控制、数据加密等，确保文档预览过程中的数据安全。</li><li>支持配置白名单，限制只有特定 IP 地址可以访问预览服务。</li></ul></li><li><strong>扩展性</strong>：<ul><li>支持插件机制，用户可以根据需求扩展支持的文档格式和功能。</li><li>提供详细的文档和示例，方便用户进行二次开发和定制。</li></ul></li></ol><h4 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h4><ul><li><strong>CPU</strong>: 4 核 </li><li><strong>内存</strong>:  8 GB </li><li><strong>存储</strong>: 4T</li><li><strong>节点</strong>：1</li></ul><h4 id="网络端口"><a href="#网络端口" class="headerlink" title="网络端口"></a>网络端口</h4><ul><li><strong>端口号</strong>: 8012</li><li><strong>用途</strong>: <ul><li><strong>服务监听端口</strong>：<ul><li>KKFileView 作为一个文档预览服务，会在指定的端口上监听 HTTP 请求。默认情况下，许多服务会使用 8080 端口，但为了避免冲突或出于其他配置需求，可以将其设置为 8012。</li></ul></li><li><strong>客户端请求</strong>：<ul><li>客户端（例如浏览器或其他应用程序）需要通过这个端口访问 KKFileView 提供的文档预览服务。例如，用户在浏览器中访问 <code>http://&lt;server-ip&gt;:8012/</code> 来查看文档。</li></ul></li><li><strong>负载均衡和代理</strong>：<ul><li>在一些复杂的部署环境中，8012 端口可能会被配置在负载均衡器或反向代理服务器（如 Nginx 或 Apache）后面，这些服务器会将请求转发到 KKFileView 服务。</li></ul></li></ul></li></ul><h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><h5 id="上传安装包"><a href="#上传安装包" class="headerlink" title="上传安装包"></a>上传安装包</h5><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget  https:<span class="hljs-regexp">//</span>a.xbd666.cn<span class="hljs-regexp">/d/</span>Aliyun<span class="hljs-regexp">/Cloud_computing/</span>Software_package<span class="hljs-regexp">/kkFileView/</span>LibreOffice_7.<span class="hljs-number">1.4</span>_Linux_x86-<span class="hljs-number">64</span>_rpm.tar.gz<br><br>wget  https:<span class="hljs-regexp">//</span>a.xbd666.cn<span class="hljs-regexp">/d/</span>Aliyun<span class="hljs-regexp">/Cloud_computing/</span>Software_package<span class="hljs-regexp">/kkFileView/</span>kkFileView-<span class="hljs-number">4.0</span>.<span class="hljs-number">0</span>.tar.gz<br><br>wget  https:<span class="hljs-regexp">//</span>a.xbd666.cn<span class="hljs-regexp">/d/</span>Aliyun<span class="hljs-regexp">/Cloud_computing/</span>Software_package<span class="hljs-regexp">/JDK/</span>jdk-<span class="hljs-number">11.0</span>.<span class="hljs-number">20</span>_linux-x64_bin.tar.gz<br><br></code></pre></td></tr></table></figure><h5 id="定义主机组"><a href="#定义主机组" class="headerlink" title="定义主机组"></a>定义主机组</h5><figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs accesslog"><span class="hljs-string">[root@localhost ~]</span># vim kkfile<br><span class="hljs-string">[kkfile]</span><br><span class="hljs-number">10.100.40.254</span><br><br></code></pre></td></tr></table></figure><h5 id="编辑脚本"><a href="#编辑脚本" class="headerlink" title="编辑脚本"></a>编辑脚本</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs bash">[root@localhost ~]# vim kkfile.sh<br><span class="hljs-comment">#!/bin/bash</span><br><br><br><span class="hljs-comment"># 设置变量</span><br>KKFILEVIEW_DIR=/data/kkFileView<br>LIBREOFFICE_ARCHIVE=/root/LibreOffice_7.1.4_Linux_x86-64_rpm.tar.gz<br>JDK_ARCHIVE=/root/jdk-11.0.20_linux-x64_bin.tar.gz<br>KKFILEVIEW_ARCHIVE=/root/kkFileView-4.0.0.tar.gz<br>JAVA_HOME_DIR=/usr/local/java<br><br><br><span class="hljs-comment"># 创建目录</span><br><span class="hljs-built_in">mkdir</span> -p <span class="hljs-variable">$KKFILEVIEW_DIR</span><br><br><br><span class="hljs-comment"># 解压 LibreOffice</span><br>tar xzf <span class="hljs-variable">$LIBREOFFICE_ARCHIVE</span> -C <span class="hljs-variable">$KKFILEVIEW_DIR</span><br><br><br><span class="hljs-comment"># 解压 JDK</span><br>tar xzf <span class="hljs-variable">$JDK_ARCHIVE</span> -C /usr/local<br><br><br><span class="hljs-comment"># 更名</span><br><span class="hljs-built_in">mv</span> /usr/local/jdk-11.0.20 <span class="hljs-variable">$JAVA_HOME_DIR</span><br><br><br><span class="hljs-comment"># 配置环境变量</span><br><span class="hljs-built_in">cat</span> &gt;&gt; /etc/profile &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">JAVA_HOME=$JAVA_HOME_DIR</span><br><span class="hljs-string">PATH=&quot;\$JAVA_HOME/bin:\$PATH&quot;</span><br><span class="hljs-string">export JAVA_HOME PATH</span><br><span class="hljs-string">EOF</span><br><br><br><span class="hljs-comment"># 变量生效</span><br><span class="hljs-built_in">source</span> /etc/profile<br><br><br><span class="hljs-comment"># 安装 LibreOffice 依赖包</span><br>yum install -y <span class="hljs-variable">$KKFILEVIEW_DIR</span>/LibreOffice_7.1.4.2_Linux_x86-64_rpm/RPMS/*.rpm<br><br><br><span class="hljs-comment"># 安装其他依赖库</span><br>yum -y install cairo<br>yum -y install cups-libs<br>yum -y install libSM<br><br><br><span class="hljs-comment"># 验证库文件</span><br><span class="hljs-keyword">if</span> [ ! -f /usr/lib64/libcairo.so.2 ] || [ ! -f /usr/lib64/libcups.so.2 ] || [ ! -f /usr/lib64/libSM.so.6 ]; <span class="hljs-keyword">then</span><br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;One or more library files are missing. Exiting...&quot;</span><br>    <span class="hljs-built_in">exit</span> 1<br><span class="hljs-keyword">fi</span><br><br><br><span class="hljs-comment"># 更新库缓存</span><br>ldconfig<br><br><br><span class="hljs-comment"># 查看 LibreOffice 版本</span><br>/opt/libreoffice7.1/program/soffice --version<br><br><br><span class="hljs-comment"># 解压 kkFileView</span><br>tar xzf <span class="hljs-variable">$KKFILEVIEW_ARCHIVE</span> -C <span class="hljs-variable">$KKFILEVIEW_DIR</span><br><br><br><span class="hljs-comment"># 修改配置文件</span><br>sed -i <span class="hljs-string">&#x27;s|office.home=.*|office.home=/opt/libreoffice7.1|g&#x27;</span> <span class="hljs-variable">$KKFILEVIEW_DIR</span>/kkFileView-4.0.0/config/application.properties<br>sed -i <span class="hljs-string">&#x27;s|office.plugin.server.ports=.*|office.plugin.server.ports=2001,2002|g&#x27;</span> <span class="hljs-variable">$KKFILEVIEW_DIR</span>/kkFileView-4.0.0/config/application.properties<br><br><br><span class="hljs-comment"># 查出所有 office 进程并杀掉</span><br>pkill -f office<br><br><br><span class="hljs-built_in">sleep</span> 5<br><br><br><span class="hljs-comment"># 启动 kkFileView</span><br><span class="hljs-variable">$KKFILEVIEW_DIR</span>/kkFileView-4.0.0/bin/startup.sh<br><br></code></pre></td></tr></table></figure><h5 id="拷贝至目标主机"><a href="#拷贝至目标主机" class="headerlink" title="拷贝至目标主机"></a>拷贝至目标主机</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@localhost</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim kkfile.yaml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">kkfileview</span> <span class="hljs-string">cluster</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-string">kkfile</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Copy</span> <span class="hljs-string">kkfileview</span> <span class="hljs-string">tarball</span> <span class="hljs-string">to</span> <span class="hljs-string">target</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">copy:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/root/LibreOffice_7.1.4_Linux_x86-64_rpm.tar.gz</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/root/LibreOffice_7.1.4_Linux_x86-64_rpm.tar.gz</span><br><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Copy</span> <span class="hljs-string">kkfileview</span> <span class="hljs-string">tarball</span> <span class="hljs-string">to</span> <span class="hljs-string">target</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">copy:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/root/jdk-11.0.20_linux-x64_bin.tar.gz</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/root/jdk-11.0.20_linux-x64_bin.tar.gz</span><br><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Copy</span> <span class="hljs-string">kkfileview</span> <span class="hljs-string">tarball</span> <span class="hljs-string">to</span> <span class="hljs-string">target</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">copy:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/root/kkFileView-4.0.0.tar.gz</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/root/kkFileView-4.0.0.tar.gz</span><br><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Copy</span> <span class="hljs-string">kkfileview</span> <span class="hljs-string">tarball</span> <span class="hljs-string">to</span> <span class="hljs-string">target</span> <span class="hljs-string">hosts</span><br>      <span class="hljs-attr">copy:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/root/kkfile.sh</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/root/kkfile.sh</span><br>        <span class="hljs-attr">mode:</span> <span class="hljs-string">&#x27;0755&#x27;</span><br><br></code></pre></td></tr></table></figure><h5 id="执行传输"><a href="#执行传输" class="headerlink" title="执行传输"></a>执行传输</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@localhost</span> ~]<span class="hljs-meta"># ansible-playbook -i /root/kkfile  kkfile.yaml</span><br></code></pre></td></tr></table></figure><h5 id="执行脚本"><a href="#执行脚本" class="headerlink" title="执行脚本"></a>执行脚本</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@localhost</span> ~]<span class="hljs-meta"># ansible -i /root/kkfile kkfile -m shell -a <span class="hljs-string">&#x27;/root/kkfile.sh&#x27;</span></span><br></code></pre></td></tr></table></figure><h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><pre><code class="hljs">http:// IP + 8012</code></pre>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>RocketMQ消息队列</title>
    <link href="/2025/11/05/RocketMQ%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/"/>
    <url>/2025/11/05/RocketMQ%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/</url>
    
    <content type="html"><![CDATA[<h3 id="RocketMQ–集群"><a href="#RocketMQ–集群" class="headerlink" title="RocketMQ–集群"></a>RocketMQ–集群</h3><h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><p>Apache RocketMQ 是一个分布式消息中间件，主要用于消息的发布与订阅（Pub&#x2F;Sub）和消息队列（Message Queue）模式。它在高性能、高可靠性和高可扩展性方面有着显著的优势。以下是 RocketMQ 的主要作用和应用场景：</p><ol><li><strong>消息发布与订阅（Pub&#x2F;Sub）</strong>：<ul><li>RocketMQ 支持发布&#x2F;订阅模式，允许消息生产者将消息发布到一个主题（Topic），然后多个消费者可以订阅这个主题以接收消息。这种模式适用于广播消息和事件通知。</li></ul></li><li><strong>消息队列（Message Queue）</strong>：<ul><li>在消息队列模式下，消息生产者将消息发送到队列，消费者从队列中读取并处理消息。消息队列模式适用于任务分发和负载均衡。</li></ul></li><li><strong>异步通信</strong>：<ul><li>RocketMQ 支持异步消息传递，允许系统组件之间进行松耦合的通信，从而提高系统的响应速度和处理能力。</li></ul></li><li><strong>削峰填谷</strong>：<ul><li>在高并发场景下，RocketMQ 可以通过消息队列的缓冲作用来平滑流量，防止系统在短时间内被大量请求压垮。</li></ul></li><li><strong>事件驱动架构</strong>：<ul><li>RocketMQ 支持事件驱动架构，系统可以通过事件通知机制来触发后续操作，实现松耦合的系统设计。</li></ul></li><li><strong>数据同步</strong>：<ul><li>RocketMQ 可以用于分布式系统中的数据同步，确保不同系统或组件之间的数据一致性。</li></ul></li></ol><h4 id="资源需求"><a href="#资源需求" class="headerlink" title="资源需求"></a>资源需求</h4><ul><li><strong>CPU</strong>: 4 核 </li><li><strong>内存</strong>:  8 GB </li><li><strong>存储</strong>: 100G</li><li><strong>节点</strong>：2</li></ul><h4 id="网络端口"><a href="#网络端口" class="headerlink" title="网络端口"></a>网络端口</h4><ol><li><strong>Nameserver 端口</strong>：<ul><li>默认端口：9876</li><li>用于 Nameserver 服务，负责管理和发现 Broker。</li></ul></li><li><strong>Broker 端口</strong>：<ul><li>默认端口：10911</li><li>用于 Broker 服务，负责消息存储和转发。</li></ul></li><li><strong>Broker HA 端口</strong>：<ul><li>默认端口：10912</li><li>用于 Broker 高可用（HA）复制。</li></ul></li><li><strong>Console 端口</strong>（可选）：<ul><li>默认端口：8080</li><li>用于 RocketMQ 控制台管理界面。</li></ul></li></ol><h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><pre><code class="服务器">10.1.15.10610.1.11.10310.1.11.1043台机器都操作#下载安装包wget https://archive.apache.org/dist/rocketmq/4.8.0/rocketmq-all-4.8.0-bin-release.zipjdk 1.8mkdir -p /data/rocketmqchmod -R 755 /data/rocketmq#添加环境变量JAVA_HOME=/usr/local/javaJRE_HOME=/usr/local/java/jreexport CLASSPATH=.:\$JAVA_HOME/jre/lib:\$JAVA_HOME/lib:\$JAVA_HOME/lib/tools.jarROCKETMQ_HOME=/data/rocketmq/rocketmq-4.8PATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin:$ROCKETMQ_HOME/binexport JAVA_HOME JRE_HOME CLASS_PATH PATH ROCKETMQ_HOME#环境生效source /etc/porfilecd /data/rocketmq#解压upzip rocketmq-all-4.8.0-bin-release.zip#修改文件夹mv rocketmq-all-4.8.0-bin-release rocketmq-4.8#创建日志目录mkdir logs10.1.15.106--nameserver#编写脚本[root@minio rocketmq]# cat start.sh#!/bin/bashJAVA_HOME=/usr/local/javaROCKETMQ_HOME=/data/rocketmq/rocketmq-4.8JAVA_OPT=&quot;-server -Xms4g -Xmx4g -Xmn2g -XX:+UseConcMarkSweepGC&quot;# 将 lib 目录中的所有 JAR 文件添加到 CLASSPATH 中CLASSPATH=$(find $&#123;ROCKETMQ_HOME&#125;/lib -name &#39;*.jar&#39; | tr &#39;\n&#39; &#39;:&#39;)JAVA_OPT=&quot;$&#123;JAVA_OPT&#125; -classpath $&#123;CLASSPATH&#125;&quot;java $&#123;JAVA_OPT&#125; org.apache.rocketmq.namesrv.NamesrvStartup -n 10.1.15.106:9876#启动脚本chmod +x start.shnohup ./start.sh &amp;10.1.11.103部署broker机器A配置#创建文件夹store,store-s（store-a：master数据存储文件夹，store-b-s:salve数据存储文件夹）mkdir /data/rocket/rocketmq-4.8/store-a#机器A上修改master的broker-a.properties配置文件cd /data/rocket/rocketmq-5.2/conf/2m-2s-asyncvim broker-a.properties配置内容如下面：# 集群名称,这里要master和slave保持一样brokerClusterName=cjsCluster# broker名字brokerName=broker-a#0 表示 Master，&gt;0 表示 SlavebrokerId=0#删除文件时间点，默认凌晨 4点deleteWhen=04#文件保留时间，默认48小时，这里设置5天fileReservedTime=120#Broker 的角色 - ASYNC_MASTER 异步复制MasterbrokerRole=ASYNC_MASTER#刷盘方式 - ASYNC_FLUSH 异步刷盘flushDiskType=ASYNC_FLUSH#开启账号密码连接，需要配置plain_acl.yml文件里面的账号密码用于连接aclEnable=false # Broker 对外服务的监听端口listenPort=10911# nameserver地址，分号分割namesrvAddr=10.1.15.106:9876#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数defaultTopicQueueNums=4#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭autoCreateTopicEnable=true#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭autoCreateSubscriptionGroup=true#本机IPbrokerIP1=10.1.11.103storePathRootDir=/data/rocketmq/rocketmq-4.8/store-astorePathCommitLog=/data/rocketmq/rocketmq-4.8/store-a/commitlog#消费队列存储路径存储路径storePathConsumerQueue=/data/rocketmq/rocketmq-4.8/store-a/consumequeue#消息索引存储路径storePathIndex=/data/rocketmq/rocketmq-4.8/store-a/index#checkpoint 文件存储路径storeCheckpoint=/data/rocketmq/rocketmq-4.8/store-a/checkpoint#abort文件存储路径abortFile=/data/rocketmq/rocketmq-4.8/store-a/abort# commitLog每个文件的大小默认1GmapedFileSizeCommitLog=1073741824#ConsumeQueue每个文件默认存30W条，根据业务情况调整mapedFileSizeConsumeQueue=30000010.1.11.104机器B上修改slave的broker-a-slave.properties配置文件mkdir -p /data/rocketmq/rocketmq-4.8/store-a-scd /data/rocket/rocketmq-4.8/conf/2m-2s-asyncvim broker-a-s.properties配置内容如下：# 集群名称brokerClusterName=cjsCluster# broker名字brokerName=broker-a#0 表示 Master，&gt;0 表示 SlavebrokerId=1#删除文件时间点，默认凌晨 4点deleteWhen=04#文件保留时间，默认 48 小时，这里设置5天fileReservedTime=120brokerRole=SLAVEflushDiskType=ASYNC_FLUSH#开启账号密码连接aclEnable=false # Broker 对外服务的监听端口listenPort=10922# nameserver地址，分号分割namesrvAddr=10.1.15.106:9876#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数defaultTopicQueueNums=4#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭autoCreateTopicEnable=true#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭autoCreateSubscriptionGroup=true#master的IPmasterAddress=10.1.11.103storePathRootDir=/data/rocketmq/rocketmq-4.8/store-a-sstorePathCommitLog=/data/rocketmq/rocketmq-4.8/store-a-s/commitlog#消费队列存储路径存储路径storePathConsumerQueue=/data/rocketmq/rocketmq-4.8/store-a-s/consumequeue#消息索引存储路径storePathIndex=/data/rocketmq/rocketmq-4.8/store-a-s/index#checkpoint 文件存储路径storeCheckpoint=/data/rocketmq/rocketmq-4.8/store-a-s/checkpoint#abort文件存储路径abortFile=/data/rocketmq/rocketmq-4.8/store-a-s/abort# commitLog每个文件的大小默认1GmapedFileSizeCommitLog=1073741824#ConsumeQueue每个文件默认存30W条，根据业务情况调整mapedFileSizeConsumeQueue=300000#机器A上编写启动文件  [root@rocketmq01 rocketmq]# cat mqbrokerStart-a.sh#!/bin/shcd /data/rocketmq/rocketmq-4.8/binnohup sh mqbroker -c /data/rocketmq/rocketmq-4.8/conf/2m-2s-async/broker-a.properties &gt; /data/rocketmq/logs/broker-a.log 2&gt;&amp;1 &amp;#slave启动文件mqbrokerStart-a-s.sh内容如下编写vim mqbrokerStart-a-s.sh#!/bin/sh cd /data/rocketmq/rocketmq-4.8/bin nohup sh mqbroker -c /data/rocketmq/rocketmq-4.8/conf/2m-2s-async/broker-a-s.properties &gt; /data/rocketmq/logs/broker-a-s.log 2&gt;&amp;1 &amp; exit#给与权限chmod +x mqbrokerStart-a.shchmod +x mqbrokerStart-a-s.sh启动broker--按顺序启动机器A上启动master：broker-acd /data/rocketmq./mqbrokerStart-a.sh机器B上启动slave：broker-a-scd /data/rocketmq./mqbrokerStart-a-s.sh#验证机器信息cd /data/rocketmq/rocketmq-4.8/bin/./mqadmin clusterList -n 10.1.15.106:9876</code></pre>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ansible部署mysql主从</title>
    <link href="/2025/11/05/ansible%E9%83%A8%E7%BD%B2mysql%E4%B8%BB%E4%BB%8E/"/>
    <url>/2025/11/05/ansible%E9%83%A8%E7%BD%B2mysql%E4%B8%BB%E4%BB%8E/</url>
    
    <content type="html"><![CDATA[<h3 id="MySQL主从"><a href="#MySQL主从" class="headerlink" title="MySQL主从"></a>MySQL主从</h3><h4 id="作用："><a href="#作用：" class="headerlink" title="作用："></a>作用：</h4><p>MySQL 是一种开源的关系数据库管理系统（RDBMS），广泛用于各种应用场景。以下是 MySQL 的主要作用和用途：</p><ol><li><p><strong>数据存储和管理</strong>:</p><ul><li>MySQL 用于存储和管理大量结构化数据。它支持多种数据类型和复杂的查询操作，适合处理各种业务数据。</li></ul></li><li><p><strong>Web 应用程序</strong>:</p><ul><li>MySQL 是许多 Web 应用程序的后端数据库，尤其是与 PHP 结合使用。常见的内容管理系统（CMS）如 WordPress、Joomla 和 Drupal 都依赖 MySQL。</li></ul></li><li><p><strong>电子商务</strong>:</p><ul><li>电子商务平台如 Magento、WooCommerce 和 Shopify 使用 MySQL 来管理产品信息、订单、客户数据等。</li></ul></li><li><p><strong>数据分析</strong>:</p><ul><li>MySQL 可以用于数据分析和商业智能（BI），通过与工具如 Tableau、Power BI 和 Excel 集成，帮助企业做出数据驱动的决策。</li></ul></li><li><p><strong>企业应用</strong>:</p><ul><li>企业资源计划（ERP）、客户关系管理（CRM）和其他企业级应用程序常常使用 MySQL 作为其数据库后端。</li></ul></li><li><p><strong>高可用性和扩展性</strong>:</p><ul><li>MySQL 支持复制和集群功能，可以实现高可用性和扩展性，满足大规模应用的需求。</li></ul></li><li><p><strong>开发和测试</strong>:</p><ul><li>开发人员使用 MySQL 进行应用程序开发和测试，得益于其易用性和广泛的社区支持。</li></ul></li><li><p><strong>数据备份和恢复</strong>:</p><ul><li>MySQL 提供多种数据备份和恢复工具，确保数据安全和完整性。</li></ul></li><li><p><strong>支持多种编程语言</strong>:</p><ul><li>MySQL 支持多种编程语言，如 Java、Python、PHP、C++ 等，方便开发者集成和使用。</li></ul></li><li><p><strong>开源和社区支持</strong>:</p><ul><li>作为开源软件，MySQL 拥有庞大的用户社区，提供丰富的资源、插件和扩展，用户可以根据需要进行定制和优化。</li></ul></li></ol><p>MySQL 的广泛应用和灵活性使其成为许多企业和开发者的首选数据库管理系统。</p><h4 id="资源需求："><a href="#资源需求：" class="headerlink" title="资源需求："></a>资源需求：</h4><ul><li><strong>CPU</strong>: 4核 </li><li><strong>内存</strong>:  8GB </li><li><strong>存储</strong>: 1T</li><li><strong>节点</strong>：2</li></ul><h4 id="网络端口"><a href="#网络端口" class="headerlink" title="网络端口:"></a>网络端口:</h4><p><strong>默认端口</strong></p><ul><li><strong>MySQL 端口</strong>：3306</li><li><strong>用途：</strong><ul><li><strong>客户端连接</strong>：<ul><li>MySQL 客户端（如 <code>mysql</code> 命令行工具、MySQL Workbench、各种编程语言的 MySQL 驱动等）使用端口 3306 连接到 MySQL 服务器进行数据库操作，如查询、插入、更新和删除数据。</li></ul></li><li><strong>应用程序连接</strong>：<ul><li>各种应用程序（如 Web 应用、企业应用、数据分析工具等）通过端口 3306 连接到 MySQL 服务器，以访问和操作存储在数据库中的数据。</li></ul></li><li><strong>数据库管理工具</strong>：<ul><li>数据库管理工具（如 phpMyAdmin、Adminer、HeidiSQL 等）通过端口 3306 连接到 MySQL 服务器，提供图形化的数据库管理界面，方便用户进行数据库管理和维护。</li></ul></li></ul></li></ul><h4 id="安装部署"><a href="#安装部署" class="headerlink" title="安装部署"></a>安装部署</h4><h5 id="定义主机组"><a href="#定义主机组" class="headerlink" title="定义主机组"></a>定义主机组</h5><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">[root@localhost ~]<span class="hljs-comment"># vim inventory.ini </span><br>[mysql_master]<br><span class="hljs-keyword">master</span> <span class="hljs-title">ansible_host</span>=<span class="hljs-number">10.100</span>.<span class="hljs-number">40.251</span><br><br><br>[mysql_slave]<br><span class="hljs-literal">slave</span> <span class="hljs-attr">ansible_host=</span><span class="hljs-number">10.100</span>.<span class="hljs-number">40.252</span><br><br></code></pre></td></tr></table></figure><h5 id="设置主机组"><a href="#设置主机组" class="headerlink" title="设置主机组"></a>设置主机组</h5><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[root@localhost ~]</span><span class="hljs-comment"># vim ansible.cfg </span><br><span class="hljs-section">[defaults]</span><br><span class="hljs-attr">inventory</span> = ./inventory.ini<br></code></pre></td></tr></table></figure><h5 id="编写剧本"><a href="#编写剧本" class="headerlink" title="编写剧本"></a>编写剧本</h5><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><code class="hljs nix">[root@localhost ~]<span class="hljs-comment"># vim mysql_cluster.yaml </span><br><span class="hljs-operator">-</span>--<br><span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Install and configure MySQL master-slave replication<br>  <span class="hljs-params">hosts:</span> all<br>  <span class="hljs-params">become:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-params">gather_facts:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-params">vars:</span><br>    <span class="hljs-params">mysql_pass:</span> <span class="hljs-string">&quot;Kunyue@123&quot;</span><br>    <span class="hljs-params">repl_password:</span> <span class="hljs-string">&quot;Kunyue@123&quot;</span><br>    <span class="hljs-params">master_ip:</span> <span class="hljs-string">&quot;10.100.40.251&quot;</span><br>    <span class="hljs-params">mysql_repo_url:</span> <span class="hljs-string">&quot;https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-5.7-community-el7-x86_64/&quot;</span><br>    <span class="hljs-params">mysql_gpg_key_url:</span> <span class="hljs-string">&quot;https://mirrors.ustc.edu.cn/mysql-repo/RPM-GPG-KEY-mysql&quot;</span><br>    <span class="hljs-params">is_master:</span> <span class="hljs-string">&quot;&#123;&#123; inventory_hostname == &#x27;master&#x27; &#125;&#125;&quot;</span><br>    <span class="hljs-params">temp_password:</span> <span class="hljs-string">&quot;&quot;</span><br><br><br>  <span class="hljs-params">tasks:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Ensure Python <span class="hljs-number">2</span> is installed<br>      <span class="hljs-params">yum:</span><br>        <span class="hljs-params">name:</span> python2<br>        <span class="hljs-params">state:</span> present<br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Ensure pip for Python <span class="hljs-number">2</span> is installed<br>      <span class="hljs-params">get_url:</span><br>        <span class="hljs-params">url:</span> https:<span class="hljs-symbol">//bootstrap.pypa.io/pip/2.7/get-pip.py</span><br>        <span class="hljs-params">dest:</span> <span class="hljs-symbol">/tmp/get-pip.py</span><br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Install pip for Python <span class="hljs-number">2</span><br>      <span class="hljs-params">command:</span> python2 <span class="hljs-symbol">/tmp/get-pip.py</span><br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Install MySQL repository<br>      <span class="hljs-params">yum_repository:</span><br>        <span class="hljs-params">name:</span> mysql<br>        <span class="hljs-params">description:</span> MySQL Community Edition<br>        <span class="hljs-params">baseurl:</span> <span class="hljs-string">&quot;&#123;&#123; mysql_repo_url &#125;&#125;&quot;</span><br>        <span class="hljs-params">gpgcheck:</span> no<br>        <span class="hljs-params">enabled:</span> yes<br>        <span class="hljs-params">gpgkey:</span> <span class="hljs-string">&quot;&#123;&#123; mysql_gpg_key_url &#125;&#125;&quot;</span><br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Install MySQL packages<br>      <span class="hljs-params">yum:</span><br>        <span class="hljs-params">name:</span> mysql-community-server<br>        <span class="hljs-params">state:</span> present<br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Install setuptools for Python <span class="hljs-number">2</span><br>      <span class="hljs-params">yum:</span><br>        <span class="hljs-params">name:</span> python-setuptools<br>        <span class="hljs-params">state:</span> present<br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Install PyMySQL using pip for Python <span class="hljs-number">2</span><br>      <span class="hljs-params">pip:</span><br>        <span class="hljs-params">name:</span> PyMySQL<br>        <span class="hljs-params">executable:</span> pip2<br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Start MySQL service<br>      <span class="hljs-params">service:</span><br>        <span class="hljs-params">name:</span> mysqld<br>        <span class="hljs-params">state:</span> started<br>        <span class="hljs-params">enabled:</span> yes<br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Get temporary MySQL root password<br>      <span class="hljs-params">shell:</span> grep &#x27;temporary password&#x27; <span class="hljs-symbol">/var/log/mysqld.log</span> | awk &#x27;&#123;print $NF&#125;&#x27;<br>      <span class="hljs-params">register:</span> temp_password<br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Reset MySQL root password and handle expired password<br>      <span class="hljs-params">command:</span> <span class="hljs-operator">&gt;</span><br>        mysql <span class="hljs-operator">-</span>-connect-expired-password <span class="hljs-operator">-</span>uroot <span class="hljs-operator">-</span>p&#123;&#123; temp_password.stdout &#125;&#125; <span class="hljs-operator">-</span>e <span class="hljs-string">&quot;ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;&#123;&#123; mysql_pass &#125;&#125;&#x27;;&quot;</span><br>      <span class="hljs-params">ignore_errors:</span> yes<br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Restart MySQL service<br>      <span class="hljs-params">service:</span><br>        <span class="hljs-params">name:</span> mysqld<br>        <span class="hljs-params">state:</span> restarted<br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Configure MySQL master<br>      <span class="hljs-params">when:</span> is_master<br>      <span class="hljs-params">block:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Add MySQL configuration for master<br>          <span class="hljs-params">lineinfile:</span><br>            <span class="hljs-params">path:</span> <span class="hljs-symbol">/etc/my.cnf</span><br>            <span class="hljs-params">regexp:</span> &#x27;^log-bin&#x27;<br>            <span class="hljs-params">line:</span> |<br>              <span class="hljs-attr">log-bin</span><span class="hljs-operator">=</span><span class="hljs-symbol">/var/lib/mysql/master</span><br>              <span class="hljs-attr">server-id</span><span class="hljs-operator">=</span><span class="hljs-number">1</span><br>              <span class="hljs-attr">gtid_mode</span><span class="hljs-operator">=</span>ON<br>              <span class="hljs-attr">enforce_gtid_consistency</span><span class="hljs-operator">=</span><span class="hljs-number">1</span><br>          <span class="hljs-params">notify:</span> restart mysql<br><br><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Create replication user on master<br>          <span class="hljs-params">mysql_user:</span><br>            <span class="hljs-params">login_user:</span> root<br>            <span class="hljs-params">login_password:</span> <span class="hljs-string">&quot;&#123;&#123; mysql_pass &#125;&#125;&quot;</span><br>            <span class="hljs-params">name:</span> slave<br>            <span class="hljs-params">password:</span> <span class="hljs-string">&quot;&#123;&#123; repl_password &#125;&#125;&quot;</span><br>            <span class="hljs-params">priv:</span> <span class="hljs-string">&quot;*.*:REPLICATION SLAVE,SUPER,RELOAD&quot;</span><br>            <span class="hljs-params">host:</span> <span class="hljs-string">&quot;%&quot;</span><br>          <span class="hljs-params">environment:</span><br>            <span class="hljs-params">MYSQL_PWD:</span> <span class="hljs-string">&quot;&#123;&#123; mysql_pass &#125;&#125;&quot;</span><br><br><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Configure MySQL slave<br>      <span class="hljs-params">when:</span> not is_master<br>      <span class="hljs-params">block:</span><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Add MySQL configuration for slave<br>          <span class="hljs-params">lineinfile:</span><br>            <span class="hljs-params">path:</span> <span class="hljs-symbol">/etc/my.cnf</span><br>            <span class="hljs-params">regexp:</span> &#x27;^log-bin&#x27;<br>            <span class="hljs-params">line:</span> |<br>              <span class="hljs-attr">log-bin</span><span class="hljs-operator">=</span><span class="hljs-symbol">/var/lib/mysql/slave</span><br>              <span class="hljs-attr">server-id</span><span class="hljs-operator">=</span><span class="hljs-number">2</span><br>              <span class="hljs-attr">gtid_mode</span><span class="hljs-operator">=</span>ON<br>              <span class="hljs-attr">enforce_gtid_consistency</span><span class="hljs-operator">=</span><span class="hljs-number">1</span><br>          <span class="hljs-params">notify:</span> restart mysql<br><br><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Restart MySQL service<br>          <span class="hljs-params">service:</span><br>            <span class="hljs-params">name:</span> mysqld<br>            <span class="hljs-params">state:</span> restarted<br><br><br>        <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> Set master info and start replication on slave<br>          <span class="hljs-params">mysql_replication:</span><br>            <span class="hljs-params">login_user:</span> root<br>            <span class="hljs-params">login_password:</span> <span class="hljs-string">&quot;&#123;&#123; mysql_pass &#125;&#125;&quot;</span><br>            <span class="hljs-params">mode:</span> changemaster<br>            <span class="hljs-params">master_host:</span> <span class="hljs-string">&quot;&#123;&#123; master_ip &#125;&#125;&quot;</span><br>            <span class="hljs-params">master_user:</span> slave<br>            <span class="hljs-params">master_password:</span> <span class="hljs-string">&quot;&#123;&#123; repl_password &#125;&#125;&quot;</span><br>            <span class="hljs-params">master_auto_position:</span> yes<br>          <span class="hljs-params">environment:</span><br>            <span class="hljs-params">MYSQL_PWD:</span> <span class="hljs-string">&quot;&#123;&#123; mysql_pass &#125;&#125;&quot;</span><br><br><br>  <span class="hljs-params">handlers:</span><br>    <span class="hljs-operator">-</span> <span class="hljs-params">name:</span> restart mysql<br>      <span class="hljs-params">service:</span><br>        <span class="hljs-params">name:</span> mysqld<br>        <span class="hljs-params">state:</span> restarted<br><br></code></pre></td></tr></table></figure><h5 id="执行剧本"><a href="#执行剧本" class="headerlink" title="执行剧本"></a>执行剧本</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">[root<span class="hljs-symbol">@localhost</span> ~]<span class="hljs-meta"># ansible-playbook -i inventory.ini mysql_cluster.yaml</span><br></code></pre></td></tr></table></figure><h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dart">mysql -uroot -p<span class="hljs-string">&#x27;密码&#x27;</span><br><br><span class="hljs-keyword">show</span> slave status \G<br></code></pre></td></tr></table></figure><h5 id="更改存储目录"><a href="#更改存储目录" class="headerlink" title="更改存储目录"></a>更改存储目录</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># 停止MySQL<br>systemctl stop mysqld<br>mkdir -p /data/mysql/data<br>chown -R mysql:mysql /data/mysql<br>chmod -R  <span class="hljs-number">755</span> /data/mysql<br><br>vim /etc/my.cnf<br>datadir=/data/mysql/data#更改位置<br>#启动<br>systemctl <span class="hljs-keyword">start</span> mysqld<br>#更改密码<br>cat /var/<span class="hljs-keyword">log</span>/mysqld.<span class="hljs-keyword">log</span> |grep <span class="hljs-keyword">password</span><br><br>#验证目录位置<br><span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">&#x27;datadir&#x27;</span>;<br><br><br># 设置主从<br><span class="hljs-string">&#x27;先对时间&#x27;</span><br>firewalld selinux //关闭<br>vim /etc/hosts//hosts解析 可选项<br><span class="hljs-number">192.168</span><span class="hljs-number">.116</span><span class="hljs-number">.111</span>master<br><span class="hljs-number">192.168</span><span class="hljs-number">.116</span><span class="hljs-number">.124</span>slave<br><br>完全备份,保持两台mysql数据一样<br>scp -r /xtrabackup/<span class="hljs-keyword">full</span>/<span class="hljs-number">2023</span><span class="hljs-number">-11</span><span class="hljs-number">-10</span>_14<span class="hljs-number">-18</span><span class="hljs-number">-09</span>/ root@<span class="hljs-number">192.168</span><span class="hljs-number">.116</span><span class="hljs-number">.124</span>:/<br><br>ping一下网络连接： ping master<br> ping slave<br>实验示例：<br><span class="hljs-string">&#x27;主&#x27;</span>：<br>vim /etc/my.cnf<br><span class="hljs-keyword">log</span>-bin=/var/lib/mysql/master<br><span class="hljs-keyword">server</span>-id=<span class="hljs-number">1</span> //ID号需要跟从的配置不一样<br>gtid_mode=<span class="hljs-keyword">ON</span><br>enforce_gtid_consistency=<span class="hljs-number">1</span><br><br># 进入MySQL里面<br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">replication</span> slave,super,reload <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> slave@<span class="hljs-string">&#x27;%&#x27;</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;Qingfeng123!&#x27;</span>;<br>flush <span class="hljs-keyword">privileges</span>;<br><br><span class="hljs-string">&#x27;从&#x27;</span>：<br>vim /etc/my.cnf<br><span class="hljs-keyword">log</span>-bin=/var/lib/mysql/slave<br><span class="hljs-keyword">server</span>-id=<span class="hljs-number">2</span> //ID号需要跟主的配置不一样<br>gtid_mode=<span class="hljs-keyword">ON</span><br>enforce_gtid_consistency=<span class="hljs-number">1</span><br><br># master_host=<span class="hljs-string">&#x27;master&#x27;</span><br># 如果没有hosts没有解析，解析ip，已经解析了就写master<br>change master <span class="hljs-keyword">to</span> master_host=<span class="hljs-string">&#x27;master&#x27;</span>,master_user=<span class="hljs-string">&#x27;slave&#x27;</span>,master_password=<span class="hljs-string">&#x27;Qingfeng@123&#x27;</span>,master_auto_position=<span class="hljs-number">1</span>;<br><span class="hljs-keyword">start</span> slave;<br><span class="hljs-keyword">show</span> slave status\G<br><br><span class="hljs-string">&#x27;互为主从&#x27;</span><br>从：<span class="hljs-keyword">grant</span> <span class="hljs-keyword">replication</span> slave,super,reload <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> slave@<span class="hljs-string">&#x27;%&#x27;</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;Qingfeng123!&#x27;</span>;<br>flush <span class="hljs-keyword">privileges</span>;<br>主:change master <span class="hljs-keyword">to</span> master_host=<span class="hljs-string">&#x27;slave&#x27;</span>,master_user=<span class="hljs-string">&#x27;slave&#x27;</span>,master_password=<span class="hljs-string">&#x27;Qingfeng@123&#x27;</span>,master_auto_position=<span class="hljs-number">1</span>;<br><span class="hljs-keyword">start</span> slave;<br><span class="hljs-keyword">show</span> slave status\G<br>验证：<br>主上写数据<br>从上面读数据<br></code></pre></td></tr></table></figure><h5 id="设置主从"><a href="#设置主从" class="headerlink" title="设置主从"></a>设置主从</h5><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"># 主节点<br><span class="hljs-keyword">grant</span> <span class="hljs-keyword">replication</span> slave,super,reload <span class="hljs-keyword">on</span> *.* <span class="hljs-keyword">to</span> slave@<span class="hljs-string">&#x27;%&#x27;</span> identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br>flush <span class="hljs-keyword">privileges</span>;<br><br>#从节点<br>change master <span class="hljs-keyword">to</span> master_host=<span class="hljs-string">&#x27;10.100.40.171&#x27;</span>,master_user=<span class="hljs-string">&#x27;slave&#x27;</span>,master_password=<span class="hljs-string">&#x27;123456&#x27;</span>,master_auto_position=<span class="hljs-number">1</span>;<br><span class="hljs-keyword">start</span> slave;<br><span class="hljs-keyword">show</span> slave status\G<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>项目前期准备</title>
    <link href="/2025/11/05/%E9%A1%B9%E7%9B%AE%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87/"/>
    <url>/2025/11/05/%E9%A1%B9%E7%9B%AE%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87/</url>
    
    <content type="html"><![CDATA[<h2 id="前期环境准备"><a href="#前期环境准备" class="headerlink" title="前期环境准备"></a>前期环境准备</h2><h3 id="环境基于ansible剧本"><a href="#环境基于ansible剧本" class="headerlink" title="环境基于ansible剧本"></a>环境基于ansible剧本</h3><h4 id="主要作用"><a href="#主要作用" class="headerlink" title="主要作用"></a><strong>主要作用</strong></h4><ol><li><strong>配置管理</strong>：<ul><li>Ansible 可以自动化地配置和管理服务器的状态，包括安装软件包、配置文件管理、用户和权限设置等。</li></ul></li><li><strong>应用程序部署</strong>：<ul><li>Ansible 可以自动化地部署应用程序，从代码库的拉取、依赖安装到应用程序的启动和配置，简化了复杂的部署过程。</li></ul></li><li><strong>任务自动化</strong>：<ul><li>Ansible 可以自动化日常运维任务，如备份、日志轮转、监控配置等，减少人为错误，提高工作效率。</li></ul></li><li><strong>多平台支持</strong>：<ul><li>Ansible 支持多种操作系统和云平台，包括 Linux、Windows、macOS，以及 AWS、Azure、GCP 等云服务提供商。</li></ul></li><li><strong>无代理架构</strong>：<ul><li>Ansible 通过 SSH 连接到目标节点，无需在目标节点上安装任何代理软件，简化了管理和维护。</li></ul></li><li><strong>编排</strong>：<ul><li>Ansible 可以编排复杂的 IT 任务，跨多个系统和环境执行一系列步骤，确保任务按顺序执行并保持一致性。</li></ul></li></ol><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs cmake">yum -y <span class="hljs-keyword">install</span> epel*<br>yum -y <span class="hljs-keyword">install</span> ansible<br></code></pre></td></tr></table></figure><h3 id="免密"><a href="#免密" class="headerlink" title="免密"></a>免密</h3><h5 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h5><ul><li><strong>日志和审计</strong>：<ul><li>一致的时间戳对于日志记录和审计是至关重要的。不同服务器上的日志条目需要统一的时间基准，方便事件的追踪和问题的排查。</li></ul></li><li><strong>数据一致性</strong>：<ul><li>分布式系统和数据库集群依赖于精确的时间同步来确保数据一致性。例如，事务处理和数据复制需要准确的时间戳。</li></ul></li><li><strong>安全性</strong>：<ul><li>许多安全协议和认证机制依赖于准确的时间。例如，Kerberos 认证协议使用时间戳来防止重放攻击。</li></ul></li><li><strong>调度和自动化任务</strong>：<ul><li>计划任务（如 cron 作业）和自动化脚本依赖于系统时间来按预定时间执行。如果时间不同步，可能导致任务执行失败或错过执行时间。</li></ul></li><li><strong>网络协议</strong>：<ul><li>一些网络协议（如 NTP、TLS）需要准确的时间来确保正确的操作和安全性。</li></ul></li></ul><h5 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h5><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs perl"><span class="hljs-comment"># 生成免密</span><br>ssh-keygen<br><br><span class="hljs-comment"># 编写免密脚本</span><br>[root<span class="hljs-variable">@k8s</span>-master ~]<span class="hljs-comment"># vim ssh_key_send.sh </span><br><span class="hljs-comment">#!/bin/bash</span><br><br><span class="hljs-comment"># 下载连接工具</span><br>yum -<span class="hljs-keyword">y</span> install sshpass<br><br><span class="hljs-comment"># 远程主机列表，换成你自己的主机 IP 地址--ip可以写多个</span><br>HOSTS=<span class="hljs-string">&quot;10.100.40.252 10.100.40.253 10.100.40.254&quot;</span><br><br><span class="hljs-comment"># 本地公钥文件路径，换成你自己的公钥文件路径</span><br>PUBLIC_KEY_FILE=~<span class="hljs-regexp">/.ssh/id</span>_rsa.pub<br><br><span class="hljs-comment"># 遍历远程主机</span><br><span class="hljs-keyword">for</span> host in <span class="hljs-variable">$&#123;HOSTS&#125;</span>; <span class="hljs-keyword">do</span><br>    <span class="hljs-comment"># 将本地公钥文件复制到远程主机的 authorized_keys 文件中--更换自己定义的密码</span><br>    echo <span class="hljs-string">&quot;Kunyue<span class="hljs-variable">@123</span>&quot;</span> | sshpass -p <span class="hljs-string">&#x27;Kunyue@123&#x27;</span> ssh-copy-id -o StrictHostKeyChecking=<span class="hljs-keyword">no</span> -i <span class="hljs-variable">$&#123;PUBLIC_KEY_FILE&#125;</span> <span class="hljs-variable">$&#123;host&#125;</span><br>done<br></code></pre></td></tr></table></figure><h3 id="时间同步"><a href="#时间同步" class="headerlink" title="时间同步"></a>时间同步</h3><h5 id="作用-1"><a href="#作用-1" class="headerlink" title="作用"></a>作用</h5><ul><li><strong>日志和审计</strong>：<ul><li>一致的时间戳对于日志记录和审计是至关重要的。不同服务器上的日志条目需要统一的时间基准，方便事件的追踪和问题的排查。</li></ul></li><li><strong>数据一致性</strong>：<ul><li>分布式系统和数据库集群依赖于精确的时间同步来确保数据一致性。例如，事务处理和数据复制需要准确的时间戳。</li></ul></li><li><strong>安全性</strong>：<ul><li>许多安全协议和认证机制依赖于准确的时间。例如，Kerberos 认证协议使用时间戳来防止重放攻击。</li></ul></li><li><strong>调度和自动化任务</strong>：<ul><li>计划任务（如 cron 作业）和自动化脚本依赖于系统时间来按预定时间执行。如果时间不同步，可能导致任务执行失败或错过执行时间。</li></ul></li><li><strong>网络协议</strong>：<ul><li>一些网络协议（如 NTP、TLS）需要准确的时间来确保正确的操作和安全性。</li></ul></li></ul><h5 id="部署-1"><a href="#部署-1" class="headerlink" title="部署"></a>部署</h5><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs yaml">[<span class="hljs-string">root@localhost</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim check_time.sh</span><br><span class="hljs-comment">#！/bin/bash</span><br><br><span class="hljs-comment">#对时</span><br><span class="hljs-comment"># 关闭防火墙</span><br><span class="hljs-comment">#systemctl stop firewalld</span><br><span class="hljs-comment">#setenforce 0</span><br><span class="hljs-comment"># 下载软件</span><br><span class="hljs-string">yum</span> <span class="hljs-string">-y</span> <span class="hljs-string">instal</span> <span class="hljs-string">ntpdate</span><br><span class="hljs-comment"># 查看当前时区</span><br><span class="hljs-string">timedatectl</span><br><span class="hljs-comment"># 列出可用时区</span><br><span class="hljs-comment">#timedatectl list-timezones</span><br><span class="hljs-comment"># 修改上海时区</span><br><span class="hljs-string">timedatectl</span> <span class="hljs-string">set-timezone</span> <span class="hljs-string">Asia/Shanghai</span><br><span class="hljs-comment"># 验证修改是否生效</span><br><span class="hljs-string">timedatectl</span><br><span class="hljs-comment"># 对时</span><br><span class="hljs-string">ntpdate</span> <span class="hljs-string">ntp.aliyun.com</span><br><span class="hljs-string">echo</span> <span class="hljs-string">&quot;对时成功，当前时间为：&quot;</span> <br><span class="hljs-string">date</span> <span class="hljs-string">+&#x27;%F</span> <span class="hljs-string">%H:%M:%S&#x27;</span><br><br><br><span class="hljs-comment"># 定义主机组</span><br>[<span class="hljs-string">root@k8s-master</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim time</span><br>[<span class="hljs-string">all</span>]<br><span class="hljs-number">10.100</span><span class="hljs-number">.40</span><span class="hljs-number">.252</span><br><span class="hljs-number">10.100</span><span class="hljs-number">.40</span><span class="hljs-number">.253</span><br><span class="hljs-number">10.100</span><span class="hljs-number">.40</span><span class="hljs-number">.254</span><br><br><span class="hljs-comment"># 配置yaml文件</span><br>[<span class="hljs-string">root@k8s-master</span> <span class="hljs-string">~</span>]<span class="hljs-comment"># vim time.yaml</span><br><span class="hljs-meta">---</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">更新</span> <span class="hljs-string">time</span><br>  <span class="hljs-attr">hosts:</span> <span class="hljs-string">all</span><br>  <span class="hljs-attr">become:</span> <span class="hljs-literal">yes</span><br>  <span class="hljs-attr">tasks:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">copy</span> <span class="hljs-string">time</span> <span class="hljs-string">script</span> <span class="hljs-string">to</span> <span class="hljs-string">remote</span> <span class="hljs-string">host</span><br>      <span class="hljs-attr">copy:</span><br>        <span class="hljs-attr">src:</span> <span class="hljs-string">/root/check_time.sh</span><br>        <span class="hljs-attr">dest:</span> <span class="hljs-string">/root/check_time.sh</span><br>        <span class="hljs-attr">owner:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">group:</span> <span class="hljs-string">root</span><br>        <span class="hljs-attr">mode:</span> <span class="hljs-number">0755</span><br><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">execute</span> <span class="hljs-string">time</span> <span class="hljs-string">script</span><br>      <span class="hljs-attr">shell:</span> <span class="hljs-string">bash</span> <span class="hljs-string">/root/check_time.sh</span><br>      <span class="hljs-attr">args:</span><br>        <span class="hljs-attr">chdir:</span> <span class="hljs-string">/root</span><br><br><span class="hljs-comment"># 启动命令</span><br><span class="hljs-string">ansible-playbook</span> <span class="hljs-string">-i</span> <span class="hljs-string">/root/time</span> <span class="hljs-string">time.yaml</span> <br><br></code></pre></td></tr></table></figure><h3 id="挂载数据盘"><a href="#挂载数据盘" class="headerlink" title="挂载数据盘"></a>挂载数据盘</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#创建目录</span><br><span class="hljs-built_in">mkdir</span> /data<br><span class="hljs-comment">#分区</span><br>fdisk /dev/sdb1<br><span class="hljs-comment">#格式化</span><br>mkfs.xfs -t ext4 /dev/sdb1<br>mount /dev/sdb1 /data<br><span class="hljs-comment"># 永久挂载</span><br>vim /etc/fstab<br>/dev/sdb1 /data xfs defaults 0 0    <span class="hljs-comment">#添加</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>部署prometheus</title>
    <link href="/2025/11/05/%E9%83%A8%E7%BD%B2prometheus/"/>
    <url>/2025/11/05/%E9%83%A8%E7%BD%B2prometheus/</url>
    
    <content type="html"><![CDATA[<h1 id="部署prometheus"><a href="#部署prometheus" class="headerlink" title="部署prometheus"></a>部署prometheus</h1><h2 id="一、准备环境"><a href="#一、准备环境" class="headerlink" title="一、准备环境"></a>一、准备环境</h2><table><thead><tr><th align="center">主机名</th><th align="center">IP</th><th align="center">配置</th></tr></thead><tbody><tr><td align="center">client</td><td align="center">10.100.40.185</td><td align="center"></td></tr><tr><td align="center">agent</td><td align="center">10.100.40.171</td><td align="center"></td></tr><tr><td align="center">agent</td><td align="center"></td><td align="center"></td></tr></tbody></table><h2 id="二、部署prometheus"><a href="#二、部署prometheus" class="headerlink" title="二、部署prometheus"></a>二、部署prometheus</h2><h3 id="1、下载地址"><a href="#1、下载地址" class="headerlink" title="1、下载地址"></a>1、下载地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget prometheus-2.47.2.linux-amd64.tar.gz<br><br>官网地址<br>https://prometheus.io/download/<br></code></pre></td></tr></table></figure><h3 id="2、创建目录"><a href="#2、创建目录" class="headerlink" title="2、创建目录"></a>2、创建目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mkdir -pv /data/pormetheus/&#123;data,soft,lag&#125;<br></code></pre></td></tr></table></figure><h3 id="3、解压安装包"><a href="#3、解压安装包" class="headerlink" title="3、解压安装包"></a>3、解压安装包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar xzf prometheus-2.47.2.linux-amd64.tar.gz -C /data/prometheus/soft<br></code></pre></td></tr></table></figure><h4 id="做个软连接，方便操作"><a href="#做个软连接，方便操作" class="headerlink" title="做个软连接，方便操作"></a>做个软连接，方便操作</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">cd /data/prometheus/soft<br>ln -sv prometheus-2.47.2.linux-amd64 prometheus<br></code></pre></td></tr></table></figure><h2 id="三、启动"><a href="#三、启动" class="headerlink" title="三、启动"></a>三、启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">在/data/prometheus/soft/prometfeus目录下启动<br>nohup ./prometheus &amp;<br></code></pre></td></tr></table></figure><h2 id="四、检查，并查看"><a href="#四、检查，并查看" class="headerlink" title="四、检查，并查看"></a>四、检查，并查看</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">netstat -lnpt#查看9090端口有没有<br><br>浏览器访问<br>http://IP + 9090<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707100611303.png" alt="image-20240707100611303"></p><h2 id="五、配置systemctl启动文件"><a href="#五、配置systemctl启动文件" class="headerlink" title="五、配置systemctl启动文件"></a>五、配置systemctl启动文件</h2><h3 id="1、编辑启动项"><a href="#1、编辑启动项" class="headerlink" title="1、编辑启动项"></a>1、编辑启动项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/systemd/system/prometheus-server.service<br><br>[Unit]<br>Description=xinjizhiwa Prometheus Server<br>Documentation=https://prometheus.io/docs/introduction/overview/<br>After=network.target<br><br>[Service]<br>Restart=on-failure<br>ExecStart=/data/prometheus/soft/prometheus/prometheus \<br>    --config.file=/data/prometheus/soft/prometheus/prometheus.yml \<br>    --web.enable-lifecycle<br>ExecReload=/bin/kill -HUP \$MAINPID<br>LimitNOFILE=65535<br><br>[Install]<br>WantedBy=multi-user.target<br><br></code></pre></td></tr></table></figure><h3 id="2、重新加载systemctl"><a href="#2、重新加载systemctl" class="headerlink" title="2、重新加载systemctl"></a>2、重新加载systemctl</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable --now prometheus-server.serivce<br></code></pre></td></tr></table></figure><h3 id="3、重新加载prometfeus"><a href="#3、重新加载prometfeus" class="headerlink" title="3、重新加载prometfeus"></a>3、重新加载prometfeus</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl reload prometheus-server.service<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">如果不管用，则使用下面的命令</span><br>curl -X POST http://本机IP:9090/-/reload<br></code></pre></td></tr></table></figure><h1 id="部署被监控节点node-exporter"><a href="#部署被监控节点node-exporter" class="headerlink" title="部署被监控节点node-exporter"></a>部署被监控节点node-exporter</h1><h2 id="一、部署node节点"><a href="#一、部署node节点" class="headerlink" title="一、部署node节点"></a>一、部署node节点</h2><h3 id="1、下载地址-1"><a href="#1、下载地址-1" class="headerlink" title="1、下载地址"></a>1、下载地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget node_exporter-1.8.1.linux-amd64.tar.gz<br></code></pre></td></tr></table></figure><h3 id="2、创建目录-1"><a href="#2、创建目录-1" class="headerlink" title="2、创建目录"></a>2、创建目录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shel">mkdir -pv /data/node_export/&#123;data,soft,logs&#125;<br></code></pre></td></tr></table></figure><h3 id="3、解压"><a href="#3、解压" class="headerlink" title="3、解压"></a>3、解压</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">tar xzf node_exporter-1.8.1.linux-amd64 -C /data/prometfeus/soft<br></code></pre></td></tr></table></figure><h3 id="4、创建软链接"><a href="#4、创建软链接" class="headerlink" title="4、创建软链接"></a>4、创建软链接</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">ln -sv /node-export/soft/node_exporter-1.6.1.linux-amd64 /node-export/soft/node-exporter<br></code></pre></td></tr></table></figure><h3 id="5、配置启动项"><a href="#5、配置启动项" class="headerlink" title="5、配置启动项"></a>5、配置启动项</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/systemd/system/node-exporter.service<br><br>[Unit]<br>Description=xinjizhiwa node-exporter<br>Documentation=https://prometheus.io/docs/introduction/overview/<br>After=network.target<br><br>[Service]<br>Restart=on-failure<br>ExecStart=/data/node-export/soft/node-exporter/node_exporter<br>ExecReload=/bin/kill -HUP \$MAINPID<br>LimitNOFILE=65535<br><br>[Install]<br>WantedBy=multi-user.target<br><br></code></pre></td></tr></table></figure><h3 id="6、重新加载systemd启动"><a href="#6、重新加载systemd启动" class="headerlink" title="6、重新加载systemd启动"></a>6、重新加载systemd启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl enable --now node-exporter.service <br></code></pre></td></tr></table></figure><h3 id="7、检查，并查看"><a href="#7、检查，并查看" class="headerlink" title="7、检查，并查看"></a>7、检查，并查看</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shlel">netstat -lnpt#查看端口9100有么有起来<br><br>浏览器<br>http://IP +9100<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707102747085.png" alt="image-20240707102747085"></p><h2 id="二、配置prometheus收集node-exporter采集数据"><a href="#二、配置prometheus收集node-exporter采集数据" class="headerlink" title="二、配置prometheus收集node-exporter采集数据"></a>二、配置prometheus收集node-exporter采集数据</h2><h3 id="1、在prometheus上操作，配置node节点的信息"><a href="#1、在prometheus上操作，配置node节点的信息" class="headerlink" title="1、在prometheus上操作，配置node节点的信息"></a>1、在prometheus上操作，配置node节点的信息</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs shell"> vim /data/prometheus/soft/prometheus/prometheus.yml <br> <br><span class="hljs-meta prompt_">   #</span><span class="language-bash">抓取监控的间隔时间，多长时间获取一次数据（生产环境，建议15-30s）；</span><br>  scrape_interval: 3s<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">多久读一次规则</span><br>  evaluation_interval: 15s<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">先不解释，之后会讲</span><br>alerting:<br>  alertmanagers:<br>    - static_configs:<br>        - targets:<br>          # - alertmanager:9093<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">先不讲，之后会讲</span><br>rule_files:<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">- <span class="hljs-string">&quot;first_rules.yml&quot;</span></span><br><span class="hljs-meta prompt_">  # </span><span class="language-bash">- <span class="hljs-string">&quot;second_rules.yml&quot;</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">被监控的配置</span><br>scrape_configs:<br>  - job_name: &quot;prometheus&quot;<br>    static_configs:<br>      - targets: [&quot;localhost:9090&quot;]<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">另起一个job名称，被监控的主体自定义名称</span><br>  - job_name: &quot;node-exporter&quot;#名字可以自定义<br>    static_configs:<br>      #被监控的数据抓取地址；<br>      - targets: [&quot;10.0.0.41:9100&quot;]#填被监控节点的IP和端口<br><br></code></pre></td></tr></table></figure><h3 id="2、重新加载prometheus服务"><a href="#2、重新加载prometheus服务" class="headerlink" title="2、重新加载prometheus服务"></a>2、重新加载prometheus服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -X POST http://IP:9090/-/reload<br><br>此时刷新页面，就可以看到node节点的信息了<br></code></pre></td></tr></table></figure><p>3、PromeQL语句查询</p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707103527708.png"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">up #代表查看所有被监控节点是否存活<br><br>1表示存活；<br><br>0表示存活；<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707103558165.png" alt="image-20240707103558165"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707103635031.png" alt="image-20240707103635031"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707103656865.png" alt="image-20240707103656865"></p><h1 id="部署grafana"><a href="#部署grafana" class="headerlink" title="部署grafana"></a>部署grafana</h1><h3 id="1、下载地址-2"><a href="#1、下载地址-2" class="headerlink" title="1、下载地址"></a>1、下载地址</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget grafana-enterprise-11.1.0-1.x86_64.rpm<br><br>官网地址<br>https://grafana.com/grafana/dashboards/<br></code></pre></td></tr></table></figure><h3 id="2、移动到prometfeus的soft目录下，好管理"><a href="#2、移动到prometfeus的soft目录下，好管理" class="headerlink" title="2、移动到prometfeus的soft目录下，好管理"></a>2、移动到prometfeus的soft目录下，好管理</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">mv /root/grafana-enterprise-11.1.0-1.x86_64.rpm /data/prometfeus/soft<br></code></pre></td></tr></table></figure><p>3、安装grafana</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum -y localinstall grafana-enterprise-11.1.0-1.x86_64.rpm<br><br>或<br>yum install -y fontconfig<br>rpm -ivh grafana-enterprise-11.1.0-1.x86_64.rpm<br></code></pre></td></tr></table></figure><p>4、启动</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl enable --now grafana-server.service<br></code></pre></td></tr></table></figure><p>5、检查，并查看</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dts">netstat -lnpt<span class="hljs-meta">#查看3000端口有没有</span><br><br>浏览器访问<br><span class="hljs-symbol">http:</span><span class="hljs-comment">//IP + 3000</span><br>默认账号密码： admin/admin<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104421113.png" alt="image-20240707104421113"></p><h3 id="3、配置数据源"><a href="#3、配置数据源" class="headerlink" title="3、配置数据源"></a>3、配置数据源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">【home】-【adminstration】-【data sources】-【add  data-sources】-【prometheus】<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104530460.png" alt="image-20240707104530460"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104552366.png" alt="image-20240707104552366"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104606770.png" alt="image-20240707104606770"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104619454.png" alt="image-20240707104619454"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104639259.png" alt="image-20240707104639259"></p><h3 id="4、新建仪表盘"><a href="#4、新建仪表盘" class="headerlink" title="4、新建仪表盘"></a>4、新建仪表盘</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">【home】-【dashboards】-【new】-【new  folder】<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104725376.png" alt="image-20240707104725376"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104739176.png" alt="image-20240707104739176"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104752529.png" alt="image-20240707104752529"></p><h3 id="5、创建一个新的folder"><a href="#5、创建一个新的folder" class="headerlink" title="5、创建一个新的folder"></a>5、创建一个新的folder</h3><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104821412.png" alt="image-20240707104821412"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">进入目录后，创建仪表盘<br><br>【create  dashboard】<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104846803.png" alt="image-20240707104846803"></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs routeros">选择数据源<br><br>【<span class="hljs-built_in">Add</span> visualization】<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707104955023.png" alt="image-20240707104955023"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">选择刚刚添加的数据源<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707105013229.png" alt="image-20240707105013229"></p><p>6、测试</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">第一步，测试代码，就是计算一个<span class="hljs-meta">cpu</span>使用率的PromeQL代码；<br><br>测试没问题，就复制；<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707105107524.png" alt="image-20240707105107524"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">写入grafana图形<br><br>(1-sum(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;)/sum(node_cpu_seconds_total))*100<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707105152631.png" alt="image-20240707105152631"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707105209270.png" alt="image-20240707105209270"></p><h3 id="6、下载开源的仪表盘"><a href="#6、下载开源的仪表盘" class="headerlink" title="6、下载开源的仪表盘"></a>6、下载开源的仪表盘</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#grafana官网查询dashboard模板id</span><br>https:<span class="hljs-regexp">//g</span>rafana.com<span class="hljs-regexp">/grafana/</span>dashboards<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707105255145.png" alt="image-20240707105255145"></p><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs livescript">Copy ID <span class="hljs-keyword">to</span> clipboard<span class="hljs-comment">#复制仪表ID直接使用，需要有网络的情况下使用</span><br><br>Download <span class="hljs-built_in">JSON</span><span class="hljs-comment">#下载json文件，然后上传到prometfeus，支持离线</span><br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707105309914.png" alt="image-20240707105309914"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">上传仪表盘json文件到grafana<br>【home】-【dashboard】-【new】-【import】<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707105537863.png" alt="image-20240707105537863"></p><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707105550579.png" alt="image-20240707105550579"></p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">回到自己的dashboard列表可以看到成功了<br></code></pre></td></tr></table></figure><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707105638228.png" alt="image-20240707105638228"></p><h1 id="grafana的变量"><a href="#grafana的变量" class="headerlink" title="grafana的变量"></a>grafana的变量</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">grafana的下拉列表选项制作-grafana的变量<br>教程<br>https://blog.csdn.net/2302_79199605/article/details/136438841?spm=1001.2014.3001.5501<br></code></pre></td></tr></table></figure><h1 id="配置prometheus服务的动态发现"><a href="#配置prometheus服务的动态发现" class="headerlink" title="配置prometheus服务的动态发现"></a>配置prometheus服务的动态发现</h1><h2 id="一、基于文档的自动发现"><a href="#一、基于文档的自动发现" class="headerlink" title="一、基于文档的自动发现"></a>一、基于文档的自动发现</h2><h3 id="1、修改prometheus的配置文件"><a href="#1、修改prometheus的配置文件" class="headerlink" title="1、修改prometheus的配置文件"></a>1、修改prometheus的配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /prometheus/soft/prometheus/prometheus.yml <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">通用设置</span><br>global:<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">抓取监控的间隔时间，多长时间获取一次数据（生产环境，建议15-30s）；</span><br>  scrape_interval: 3s <br><span class="hljs-meta prompt_">  #</span><span class="language-bash">多久读一次规则</span><br>  evaluation_interval: 15s <br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">先不解释，之后会讲</span><br>alerting:<br>  alertmanagers:<br>    - static_configs:<br>        - targets:<br>          # - alertmanager:9093<br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">先不讲，之后会讲</span><br>rule_files:<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">- <span class="hljs-string">&quot;first_rules.yml&quot;</span></span><br><span class="hljs-meta prompt_">  # </span><span class="language-bash">- <span class="hljs-string">&quot;second_rules.yml&quot;</span></span><br><span class="hljs-meta prompt_"></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">被监控的配置</span><br>scrape_configs:<br>  - job_name: &quot;prometheus&quot;<br>    static_configs:<br>      - targets: [&quot;localhost:9090&quot;]<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">另起一个job名称，被监控的主体自定义名称</span><br>  - job_name: &quot;node-exporter01&quot;<br>    #基于文档自动发现<br>    file_sd_configs:<br>      #文档的地址路径<br>      - files:<br>          #- /prometheus/soft/prometheus/file-sd.json<br>          - /data/prometheus/soft/prometheus/file-sd.yaml#自己定义的发现文档路径<br><br></code></pre></td></tr></table></figure><h3 id="2、重新加载prometheus服务-1"><a href="#2、重新加载prometheus服务-1" class="headerlink" title="2、重新加载prometheus服务"></a>2、重新加载prometheus服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">curl -X POST http://IP:9090/-/reload<br></code></pre></td></tr></table></figure><h3 id="3、编辑自动发现文档"><a href="#3、编辑自动发现文档" class="headerlink" title="3、编辑自动发现文档"></a>3、编辑自动发现文档</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /data/prometheus/soft/prometheus/file-sd.yaml<br>- targets:<br>    - &#x27;10.0.0.41:9100&#x27;<br>  labels:<br>    xinjizhiwa: prometheus-learn<br>    office: www.xinjizhiwa.com<br></code></pre></td></tr></table></figure><h3 id="4、刷新浏览器查看"><a href="#4、刷新浏览器查看" class="headerlink" title="4、刷新浏览器查看"></a>4、刷新浏览器查看</h3><p><img src="C:\Users\徐保东\AppData\Roaming\Typora\typora-user-images\image-20240707110535539.png" alt="image-20240707110535539"></p><h1 id="配置prometheus的数据存储"><a href="#配置prometheus的数据存储" class="headerlink" title="配置prometheus的数据存储"></a>配置prometheus的数据存储</h1><h2 id="一、本地存储prometheus收集的监控数据"><a href="#一、本地存储prometheus收集的监控数据" class="headerlink" title="一、本地存储prometheus收集的监控数据"></a>一、本地存储prometheus收集的监控数据</h2><h3 id="1、配置systemctl启动文件"><a href="#1、配置systemctl启动文件" class="headerlink" title="1、配置systemctl启动文件"></a>1、配置systemctl启动文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs shell">vim /etc/systemd/system/prometheus-server.service<br>[Unit]<br>Description=Prometheus Server<br>Documentation=https://prometheus.io/docs/introduction/overview/<br>After=network.target<br><br>[Service]<br>Restart=on-failure<br>ExecStart=/data/prometheus/softwares/prometheus-2.47.2.linux-amd64/prometheus \<br>    --config.file=/data/prometheus/softwares/prometheus-2.47.2.linux-amd64/prometheus.yml \<br>    --web.enable-lifecycle \<br>    --storage.tsdb.path=/data/prometheus/data/prometheus \<br>    --storage.tsdb.retention.time=60d \<br>    --web.listen-address=0.0.0.0:9090 \<br>    --web.max-connections=4096 \<br>    --storage.tsdb.retention.size=512MB \<br>    --query.timeout=10s \<br>    --query.max-concurrency=20 \<br>    --log.level=info \<br>    --log.format=json \<br>    --web.read-timeout=5m<br>ExecReload=/bin/kill -HUP $MAINPID<br>LimitNOFILE=65535<br><br>[Install]<br>WantedBy=multi-user.target<br><br><br>参数说明：<br>--config.file=/prometheus/softwares/prometheus/prometheus.yml <br>    指定prometheus的配置文件。<br>--web.enable-lifecycle <br>    启用web方式热加载。<br>--storage.tsdb.path=&quot;/prometheus/data/prometheus&quot; <br>    指定prometheus数据存储路径。如果不指定，则默认其实时的同级目录下。<br>--storage.tsdb.retention.time=&quot;60d&quot; <br>    指定prometheus数据存储周期。<br>--web.listen-address=&quot;0.0.0.0:9090&quot; <br>    指定prometheus的监听端口。<br>--web.max-connections=4096 <br>    指定最大的连接数。<br>--storage.tsdb.retention.size=&quot;512MB&quot; <br>    指定prometheus数据块的滚动大小（每到512M缓存，进行一次落盘存储）。<br>--query.timeout=10s <br>    查询数据的超时时间。<br>--query.max-concurrency=20<br>    最大并发查询数量。<br>--log.level=info<br>    指定日志级别。<br>--log.format=logfmt<br>    指定日志格式。<br>--web.read-timeout=5m<br>    最大的空闲超时时间。<br></code></pre></td></tr></table></figure><h3 id="3、重新加载systemctl"><a href="#3、重新加载systemctl" class="headerlink" title="3、重新加载systemctl"></a>3、重新加载systemctl</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl daemon-reload<br>systemctl restart prometheus-server<br></code></pre></td></tr></table></figure><h2 id="二、prometheus数据远端存储"><a href="#二、prometheus数据远端存储" class="headerlink" title="二、prometheus数据远端存储"></a>二、prometheus数据远端存储</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">这里就不作介绍了<br>教程<br>https://blog.csdn.net/2302_79199605/article/details/136467629?spm=1001.2014.3001.5501<br></code></pre></td></tr></table></figure><h1 id="监控的告警通知-alertmanager组件工具"><a href="#监控的告警通知-alertmanager组件工具" class="headerlink" title="监控的告警通知-alertmanager组件工具"></a>监控的告警通知-alertmanager组件工具</h1><h2 id="1、定义告警规则"><a href="#1、定义告警规则" class="headerlink" title="1、定义告警规则"></a>1、定义告警规则</h2><p>修改Prometheus配置文件prometheus.yml,添加以下配置：</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs perl">rule_files:<br>  - <span class="hljs-regexp">/usr/l</span>ocal/prometheus/rules/*.rules<span class="hljs-comment">#改成自己的目录，我的是/data目录下</span><br><br>alerting:<br>  alertmanagers:<br>    - static_configs:<br>        - targets:<br>           - localhost:<span class="hljs-number">9093</span><br><br></code></pre></td></tr></table></figure><p>在目录&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;rules&#x2F;下创建告警文件hoststats-alert.rules内容如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs shell">groups:<br>- name: hostStatsAlert<br>  rules:<br>  - alert: hostCpuUsageAlert<br>    expr: sum by (instance) (avg without (cpu) (irate(node_cpu_seconds_total&#123;mode!=&quot;idle&quot;&#125;[5m]))) &gt; 0.5<br>    for: 1m<br>    labels:<br>      # 严重性<br>      severity: warning<br>    annotations:<br>      title: cpu飚高告警<br>      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; CPU usgae high&quot;<br>      description: &quot;&#123;&#123; $labels.instance &#125;&#125; CPU usage above 50% (current value: &#123;&#123; $value &#125;&#125;)&quot;<br>  - alert: hostMemUsageAlert<br>    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)/node_memory_MemTotal_bytes &gt; 0.85<br>    for: 1m<br>    labels:<br>      severity: warning<br>    annotations:<br>      title: 内存使用率飚高告警<br>      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; MEM usgae high&quot;<br>      description: &quot;&#123;&#123; $labels.instance &#125;&#125; MEM usage above 85% (current value: &#123;&#123; $value &#125;&#125;)&quot;<br><br></code></pre></td></tr></table></figure><p>重启Prometheus后访问Prometheus http:&#x2F;&#x2F; IP:9090&#x2F;rules可以查看当前以加载的规则文件</p><h2 id="2、安装配置prometheus-webhook-dingtalk"><a href="#2、安装配置prometheus-webhook-dingtalk" class="headerlink" title="2、安装配置prometheus-webhook-dingtalk"></a>2、安装配置prometheus-webhook-dingtalk</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz<br>tar -zxvf prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz -C /usr/local<br>mv /usr/local/prometheus-webhook-dingtalk-2.1.0.linux-amd64 /usr/local/prometheus-webhook-dingtalk<br>cp /usr/local/prometheus-webhook-dingtalk/config.example.yml  /usr/local/prometheus-webhook-dingtalk/config.yml<br>vim config.yml      # 将配置文件修改成下面这样<br><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Request timeout</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"><span class="hljs-built_in">timeout</span>: 5s</span><br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Uncomment following line in order to write template from scratch (be careful!)</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">no_builtin_template: <span class="hljs-literal">true</span></span><br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Customizable templates path</span></span><br>templates:<br>  - contrib/templates/mytemplate.tmpl # 这里指向你生成的模板<br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># You can also override default template using `default_message`</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># The following example to use the &#x27;legacy&#x27; template from v0.3.0</span></span><br><span class="hljs-meta prompt_">#</span><span class="language-bash">default_message:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> title: <span class="hljs-string">&#x27;&#123;&#123; template &quot;legacy.title&quot; . &#125;&#125;&#x27;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> text: <span class="hljs-string">&#x27;&#123;&#123; template &quot;legacy.content&quot; . &#125;&#125;&#x27;</span></span><br><span class="hljs-meta prompt_"> </span><br><span class="hljs-meta prompt_">#</span><span class="language-bash"><span class="hljs-comment"># Targets, previously was known as &quot;profiles&quot;</span></span><br>targets:<br>  webhook1:<br>    # 钉钉机器人的webhook, 是从钉钉机器人中获取的值<br>    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br>    # secret for signature 加签后得到的值， 机器人的加签<br>    # secret: xxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br><span class="hljs-meta prompt_"># </span><span class="language-bash"> webhook2:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> webhook_legacy:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   <span class="hljs-comment"># Customize template content</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   message:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">     <span class="hljs-comment"># Use legacy template</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">     title: <span class="hljs-string">&#x27;&#123;&#123; template &quot;legacy.title&quot; . &#125;&#125;&#x27;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">     text: <span class="hljs-string">&#x27;&#123;&#123; template &quot;legacy.content&quot; . &#125;&#125;&#x27;</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> webhook_mention_all:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   mention:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">     all: <span class="hljs-literal">true</span></span><br><span class="hljs-meta prompt_"># </span><span class="language-bash"> webhook_mention_users:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">   mention:</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">     mobiles: [<span class="hljs-string">&#x27;156xxxx8827&#x27;</span>, <span class="hljs-string">&#x27;189xxxx8325&#x27;</span>]</span><br><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">添加如下模板，模板中需要有prometheus添加的 Annotations中需要title、description；Labels中需要有severity</span><br>vim /usr/local/prometheus-webhook-dingtalk/contrib/templates/mytemplate.tmpl<br><br>cd /usr/local/prometheus-webhook-dingtalk/<br><br>./prometheus-webhook-dingtalk --config.file=config.yml &gt;dingtalk.log 2&gt;&amp;1 &amp;<br><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs shell">&#123;&#123; define &quot;__subject&quot; &#125;&#125;<br>[&#123;&#123; .Status | toUpper &#125;&#125;&#123;&#123; if eq .Status &quot;firing&quot; &#125;&#125;:&#123;&#123; .Alerts.Firing | len &#125;&#125;&#123;&#123; end &#125;&#125;]<br>&#123;&#123; end &#125;&#125;<br> <br> <br>&#123;&#123; define &quot;__alert_list&quot; &#125;&#125;&#123;&#123; range . &#125;&#125;<br>---<br>&#123;&#123; if .Labels.owner &#125;&#125;@&#123;&#123; .Labels.owner &#125;&#125;&#123;&#123; end &#125;&#125;<br><br>**告警名称**: &#123;&#123; index .Annotations &quot;title&quot; &#125;&#125; <br> <br>**告警级别**: &#123;&#123; .Labels.severity &#125;&#125; <br> <br>**告警主机**: &#123;&#123; .Labels.instance &#125;&#125; <br> <br>**告警信息**: &#123;&#123; index .Annotations &quot;description&quot; &#125;&#125;<br> <br>**告警时间**: &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; &#125;&#125;<br>&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;<br> <br>&#123;&#123; define &quot;__resolved_list&quot; &#125;&#125;&#123;&#123; range . &#125;&#125;<br>---<br>&#123;&#123; if .Labels.owner &#125;&#125;@&#123;&#123; .Labels.owner &#125;&#125;&#123;&#123; end &#125;&#125;<br> <br>**告警名称**: &#123;&#123; index .Annotations &quot;title&quot; &#125;&#125;<br> <br>**告警级别**: &#123;&#123; .Labels.severity &#125;&#125;<br> <br>**告警主机**: &#123;&#123; .Labels.instance &#125;&#125;<br> <br>**告警信息**: &#123;&#123; index .Annotations &quot;description&quot; &#125;&#125;<br> <br>**告警时间**: &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; &#125;&#125;<br> <br>**恢复时间**: &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.EndsAt) &quot;Asia/Shanghai&quot; &#125;&#125;<br>&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;<br> <br> <br>&#123;&#123; define &quot;default.title&quot; &#125;&#125;<br>&#123;&#123; template &quot;__subject&quot; . &#125;&#125;<br>&#123;&#123; end &#125;&#125;<br> <br>&#123;&#123; define &quot;default.content&quot; &#125;&#125;<br>&#123;&#123; if gt (len .Alerts.Firing) 0 &#125;&#125;<br>**====侦测到&#123;&#123; .Alerts.Firing | len  &#125;&#125;个故障====**<br>&#123;&#123; template &quot;__alert_list&quot; .Alerts.Firing &#125;&#125;<br>---<br>&#123;&#123; end &#125;&#125;<br> <br>&#123;&#123; if gt (len .Alerts.Resolved) 0 &#125;&#125;<br>**====恢复&#123;&#123; .Alerts.Resolved | len  &#125;&#125;个故障====**<br>&#123;&#123; template &quot;__resolved_list&quot; .Alerts.Resolved &#125;&#125;<br>&#123;&#123; end &#125;&#125;<br>&#123;&#123; end &#125;&#125;<br> <br> <br>&#123;&#123; define &quot;ding.link.title&quot; &#125;&#125;&#123;&#123; template &quot;default.title&quot; . &#125;&#125;&#123;&#123; end &#125;&#125;<br>&#123;&#123; define &quot;ding.link.content&quot; &#125;&#125;&#123;&#123; template &quot;default.content&quot; . &#125;&#125;&#123;&#123; end &#125;&#125;<br>&#123;&#123; template &quot;default.title&quot; . &#125;&#125;<br>&#123;&#123; template &quot;default.content&quot; . &#125;&#125;<br><br></code></pre></td></tr></table></figure><h2 id="3、安装配置prometheus-alertmanager"><a href="#3、安装配置prometheus-alertmanager" class="headerlink" title="3、安装配置prometheus-alertmanager"></a>3、安装配置prometheus-alertmanager</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://github.com/prometheus/alertmanager/releases/download/v0.25.0/alertmanager-0.25.0.linux-amd64.tar.gz<br>tar -zxvf alertmanager-0.25.0.linux-amd64.tar.gz <br>mv alertmanager-0.25.0.linux-amd64 /usr/local/alertmanager<br><span class="hljs-meta prompt_"># </span><span class="language-bash">修改告警管理的配置文件如下</span><br>vim /usr/local/alertmanager/alertmanager.yml<br>cd /usr/local/alertmanager/<br>./alertmanager --config.file=alertmanager.yml &gt;alertmanager.log 2&gt;&amp;1 &amp;<br><br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs shell">global:<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">每一分钟检查一次是否恢复</span><br>  resolve_timeout: 5m<br>route:<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">采用哪个标签来作为分组依据</span><br>  group_by: [&#x27;alertname&#x27;]<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">组告警等待时间。也就是告警产生后等待10s，如果有同组告警一起发出</span><br>  group_wait: 10s<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">两组告警的间隔时间</span><br>  group_interval: 1m<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">重复告警的间隔时间，减少相同告警的发送频率</span><br>  repeat_interval: 1m<br><span class="hljs-meta prompt_">  #</span><span class="language-bash">设置默认接收人</span><br>  receiver: &#x27;web.hook&#x27;<br>  routes:<br>  - receiver: &#x27;dingding.webhook1&#x27;<br>    match_re:<br>      alertname: &quot;.*&quot;<br>receivers:<br>- name: &#x27;web.hook&#x27;<br>  webhook_configs:<br>  - url: &#x27;http://127.0.0.1:5001/&#x27;<br>- name: &#x27;dingding.webhook1&#x27;<br>  webhook_configs:<br><span class="hljs-meta prompt_">  # </span><span class="language-bash">这里的webhook1，根据我们在钉钉告警插件配置文件中targets中指定的值做修改</span><br>  - url: &#x27;http://127.0.0.1:8060/dingtalk/webhook1/send&#x27;<br>    send_resolved: true<br>inhibit_rules:<br>  - source_match:<br>      severity: &#x27;critical&#x27;<br>    target_match:<br>      severity: &#x27;warning&#x27;<br>    equal: [&#x27;alertname&#x27;, &#x27;dev&#x27;, &#x27;instance&#x27;]<br><br></code></pre></td></tr></table></figure><p>此时，我们可以手动拉高系统的CPU使用率，验证Prometheus的告警流程，在主机上运行以下命令</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs llvm">cat /dev/zero&gt;/dev/<span class="hljs-keyword">null</span><br>等待告警状态为firing后钉钉群机器人会发出告警信息<br><br>连接地址:https://blog.csdn.net/weixin_<span class="hljs-number">44223946</span>/article/details/<span class="hljs-number">131411062</span>?ops_request_misc<span class="hljs-operator">=</span><span class="hljs-variable">%257</span>B<span class="hljs-variable">%2522</span>request<span class="hljs-variable">%255</span>Fid<span class="hljs-variable">%2522</span><span class="hljs-variable">%253</span>A<span class="hljs-variable">%2522172032212116800213088728</span><span class="hljs-variable">%2522</span><span class="hljs-variable">%252</span>C<span class="hljs-variable">%2522</span>scm<span class="hljs-variable">%2522</span><span class="hljs-variable">%253</span>A<span class="hljs-variable">%252220140713</span>.<span class="hljs-number">130102334</span>..<span class="hljs-variable">%2522</span><span class="hljs-variable">%257</span>D&amp;request_id<span class="hljs-operator">=</span><span class="hljs-number">172032212116800213088728</span>&amp;biz_id<span class="hljs-operator">=</span><span class="hljs-number">0</span>&amp;utm_medium<span class="hljs-operator">=</span>distribute.pc_search_result.none-task-blog<span class="hljs-number">-2</span>~all~sobaiduend~<span class="hljs-keyword">default</span><span class="hljs-number">-1</span><span class="hljs-number">-131411062</span>-<span class="hljs-keyword">null</span>-<span class="hljs-keyword">null</span>.<span class="hljs-number">142</span>^v<span class="hljs-number">100</span>^pc_search_result_base<span class="hljs-number">3</span>&amp;utm_term<span class="hljs-operator">=</span>prometheus<span class="hljs-variable">%E5</span><span class="hljs-variable">%91</span><span class="hljs-variable">%8</span>A<span class="hljs-variable">%E8</span><span class="hljs-variable">%AD</span><span class="hljs-variable">%A6</span><span class="hljs-variable">%E5</span><span class="hljs-variable">%8</span>F<span class="hljs-variable">%91</span><span class="hljs-variable">%E9</span><span class="hljs-variable">%80</span><span class="hljs-variable">%81</span><span class="hljs-variable">%E9</span><span class="hljs-variable">%92</span><span class="hljs-variable">%89</span><span class="hljs-variable">%E9</span><span class="hljs-variable">%92</span><span class="hljs-variable">%89</span>&amp;spm<span class="hljs-operator">=</span><span class="hljs-number">1018.2226</span>.<span class="hljs-number">3001.4187</span><br></code></pre></td></tr></table></figure><p>1、下载工具</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz<br><br>tar xf alertmanager-0.26.0.linux-amd64.tar.gz -C /prometheus/softwares/<br> <br>ln -svf /prometheus/softwares/alertmanager-0.26.0.linux-amd64/<br></code></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">教程<br>https://blog.csdn.net/2302_79199605/article/details/136494677?spm=1001.2014.3001.5501<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>k8s部署prometheus</title>
    <link href="/2025/11/05/k8s%E9%83%A8%E7%BD%B2prometheus/"/>
    <url>/2025/11/05/k8s%E9%83%A8%E7%BD%B2prometheus/</url>
    
    <content type="html"><![CDATA[<h1 id="k8s部署prometheus"><a href="#k8s部署prometheus" class="headerlink" title="k8s部署prometheus"></a>k8s部署prometheus</h1><h1 id="终端创建"><a href="#终端创建" class="headerlink" title="终端创建"></a>终端创建</h1><h2 id="创建namespace"><a href="#创建namespace" class="headerlink" title="创建namespace"></a>创建namespace</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /home/k8s/monitoring/&#123;node-exporter,k8s,kube-state-metrics,blackbox-exporter,dingtalk,alertmanager,prometheus,grafana&#125;<br><br><span class="hljs-built_in">cd</span> /home/k8s/monitoring<br><br>vim namespace.yaml<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Namespace<br>metadata:<br>  name: monitoring<br></code></pre></td></tr></table></figure><h2 id="node-exporter"><a href="#node-exporter" class="headerlink" title="node-exporter"></a>node-exporter</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim node-exporter/node-exporter.yaml<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: node-exporter<br>  namespace: monitoring<br>  labels:<br>    app: node-exporter<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>spec:<br>  selector:<br>    app: node-exporter<br>  ports:<br>  - name: node-exporter<br>    port: 9100<br>    protocol: TCP<br>    targetPort: 9100<br>  clusterIP: None<br><br>---<br>apiVersion: apps/v1<br>kind: DaemonSet<br>metadata:<br>  name: node-exporter<br>  namespace: monitoring<br>  labels:<br>    app: node-exporter<br>spec:<br>  selector:<br>    matchLabels:<br>      app: node-exporter<br>  template:<br>    metadata:<br>      name: node-exporter<br>      labels:<br>        app: node-exporter<br>    spec:<br>      containers:<br>      - name: node-exporter<br>        image: prom/node-exporter:latest<br>        imagePullPolicy: IfNotPresent<br>        ports:<br>        - containerPort: 9100<br>          hostPort: 9100<br>      hostNetwork: <span class="hljs-literal">true</span><br>      hostPID: <span class="hljs-literal">true</span><br>      tolerations:<br>      - key: node-role.kubernetes.io/master<br>        operator: Exists<br>        effect: NoSchedule<br><br></code></pre></td></tr></table></figure><h2 id="k8s组件"><a href="#k8s组件" class="headerlink" title="k8s组件"></a>k8s组件</h2><h2 id="controller-manager"><a href="#controller-manager" class="headerlink" title="controller-manager"></a>controller-manager</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim k8s/kube-controller-manager-prometheus-discovery.yaml<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: kube-controller-manager-prometheus-discovery<br>  namespace: kube-system<br>  labels:<br>    component: kube-controller-manager<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>spec:<br>  selector:<br>    component: kube-controller-manager<br>  ports:<br>  - name: http-metrics<br>    port: 10252<br>    targetPort: 10252<br>    protocol: TCP<br>  clusterIP: None<br><br></code></pre></td></tr></table></figure><h2 id="kube-scheduler"><a href="#kube-scheduler" class="headerlink" title="kube-scheduler"></a>kube-scheduler</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim k8s/kube-scheduler-prometheus-discovery.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: kube-scheduler-prometheus-discovery<br>  namespace: kube-system<br>  labels:<br>    component: kube-scheduler<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>spec:<br>  selector:<br>    component: kube-scheduler<br>  ports:<br>  - name: http-metrics<br>    port: 10251<br>    protocol: TCP<br>    targetPort: 10251<br>  clusterIP: None<br><br></code></pre></td></tr></table></figure><h2 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim k8s/kube-proxy-prometheus-discovery.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: kube-proxy-prometheus-discovery<br>  namespace: kube-system<br>  labels:<br>    k8s-app: kube-proxy<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>spec:<br>  selector:<br>    k8s-app: kube-proxy<br>  ports:<br>  - name: http-metrics<br>    port: 10249<br>    protocol: TCP<br>    targetPort: 10249<br>  clusterIP: None<br><br></code></pre></td></tr></table></figure><h2 id="kube-state-metrics"><a href="#kube-state-metrics" class="headerlink" title="kube-state-metrics"></a>kube-state-metrics</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim kube-state-metrics/rbac.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  name: kube-state-metrics<br>  namespace: monitoring<br>  labels:<br>    app: kube-state-metrics<br> <br>--- <br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRole<br>metadata:<br>  name: kube-state-metrics<br>  labels:<br>    app: kube-state-metrics<br>rules:<br>- apiGroups:<br>  - <span class="hljs-string">&quot;&quot;</span><br>  resources:<br>  - configmaps<br>  - secrets<br>  - nodes<br>  - pods<br>  - services<br>  - resourcequotas<br>  - replicationcontrollers<br>  - limitranges<br>  - persistentvolumeclaims<br>  - persistentvolumes<br>  - namespaces<br>  - endpoints<br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - extensions<br>  resources:<br>  - daemonsets<br>  - deployments<br>  - replicasets<br>  - ingresses<br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - apps<br>  resources:<br>  - statefulsets<br>  - daemonsets<br>  - deployments<br>  - replicasets<br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - batch<br>  resources:<br>  - cronjobs<br>  - <span class="hljs-built_in">jobs</span><br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - autoscaling<br>  resources:<br>  - horizontalpodautoscalers<br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - authentication.k8s.io<br>  resources:<br>  - tokenreviews<br>  verbs:<br>  - create<br>- apiGroups:<br>  - authorization.k8s.io<br>  resources:<br>  - subjectaccessreviews<br>  verbs:<br>  - create<br>- apiGroups:<br>  - policy<br>  resources:<br>  - poddisruptionbudgets<br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - certificates.k8s.io<br>  resources:<br>  - certificatesigningrequests<br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - storage.k8s.io<br>  resources:<br>  - storageclasses<br>  - volumeattachments<br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - admissionregistration.k8s.io<br>  resources:<br>  - mutatingwebhookconfigurations<br>  - validatingwebhookconfigurations<br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - networking.k8s.io<br>  resources:<br>  - networkpolicies<br>  verbs:<br>  - list<br>  - watch<br>- apiGroups:<br>  - coordination.k8s.io<br>  resources:<br>  - leases<br>  verbs:<br>  - list<br>  - watch<br>  <br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: kube-state-metrics<br>  labels:<br>    app: kube-state-metrics<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: kube-state-metrics<br>subjects:<br>- kind: ServiceAccount<br>  name: kube-state-metrics<br>  namespace: monitoring<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim kube-state-metrics/kube-state-metrics.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: kube-state-metrics<br>  namespace: monitoring<br>  labels:<br>    app: kube-state-metrics<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>    prometheus.io/http-probe: <span class="hljs-string">&#x27;true&#x27;</span><br>    prometheus.io/http-probe-path: <span class="hljs-string">&#x27;/healthz&#x27;</span><br>    prometheus.io/http-probe-port: <span class="hljs-string">&#x27;8080&#x27;</span><br>spec:<br>  selector:<br>    app: kube-state-metrics<br>  ports:<br>  - name: kube-state-metrics<br>    port: 8080<br>    protocol: TCP<br>    targetPort: 8080<br><br>---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: kube-state-metrics<br>  namespace: monitoring<br>  labels:<br>    app: kube-state-metrics<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: kube-state-metrics<br>  template:<br>    metadata:<br>      labels:<br>        app: kube-state-metrics<br>    spec:<br>      serviceAccountName: kube-state-metrics<br>      containers:<br>      - name: kube-state-metrics<br>        image: quay.io/coreos/kube-state-metrics:v1.8.0 <br>        imagePullPolicy: IfNotPresent<br>        ports:<br>        - containerPort: 8080<br>      <span class="hljs-comment"># Remove nodeSelector and tolerations for random scheduling</span><br><br></code></pre></td></tr></table></figure><h2 id="blackbox-exporter"><a href="#blackbox-exporter" class="headerlink" title="blackbox-exporter"></a>blackbox-exporter</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim blackbox-exporter/config.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: blackbox-exporter<br>  namespace: monitoring<br>  labels:<br>    app: blackbox-exporter<br>data:<br>  blackbox.yml: |-<br>    modules:<br>      http_2xx:<br>        prober: http<br>        <span class="hljs-built_in">timeout</span>: 10s<br>        http:<br>          valid_http_versions: [<span class="hljs-string">&quot;HTTP/1.1&quot;</span>, <span class="hljs-string">&quot;HTTP/2&quot;</span>]<br>          valid_status_codes: []<br>          method: GET<br>          preferred_ip_protocol: <span class="hljs-string">&quot;ip4&quot;</span><br>      http_post_2xx:<br>        prober: http<br>        <span class="hljs-built_in">timeout</span>: 10s<br>        http:<br>          valid_http_versions: [<span class="hljs-string">&quot;HTTP/1.1&quot;</span>, <span class="hljs-string">&quot;HTTP/2&quot;</span>]<br>          method: POST<br>          preferred_ip_protocol: <span class="hljs-string">&quot;ip4&quot;</span><br>      tcp_connect:<br>        prober: tcp<br>        <span class="hljs-built_in">timeout</span>: 10s<br>      icmp:<br>        prober: icmp<br>        <span class="hljs-built_in">timeout</span>: 10s<br>        icmp:<br>          preferred_ip_protocol: <span class="hljs-string">&quot;ip4&quot;</span><br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim blackbox-exporter/blackbox-exporter.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: blackbox-exporter<br>  namespace: monitoring<br>  labels:<br>    app: blackbox-exporter<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>spec:<br>  selector:<br>    app: blackbox-exporter<br>  ports:<br>  - name: blackbox<br>    port: 9115<br>    protocol: TCP<br>    targetPort: 9115<br>    nodePort: 30115<br>  <span class="hljs-built_in">type</span>: NodePort<br>  <br>---  <br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: blackbox-exporter<br>  namespace: monitoring<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: blackbox-exporter<br>  template:<br>    metadata:<br>      labels:<br>        app: blackbox-exporter<br>    spec:<br>      containers:<br>      - name: blackbox-exporter<br>        image: prom/blackbox-exporter:latest<br>        imagePullPolicy: IfNotPresent<br>        ports:<br>        - containerPort: 9115<br>        readinessProbe:<br>          tcpSocket:<br>            port: 9115<br>          initialDelaySeconds: 10<br>          timeoutSeconds: 5<br>        resources:<br>          requests:<br>            memory: 50Mi<br>            cpu: 100m<br>          limits:<br>            memory: 60Mi<br>            cpu: 200m<br>        volumeMounts:<br>        - name: config<br>          mountPath: /etc/blackbox_exporter<br>        args:<br>        - <span class="hljs-string">&#x27;--config.file=/etc/blackbox_exporter/blackbox.yml&#x27;</span><br>        - <span class="hljs-string">&#x27;--web.listen-address=:9115&#x27;</span><br>      volumes:<br>      - name: config<br>        configMap:<br>          name: blackbox-exporter<br>      nodeSelector:<br>        node-role.kubernetes.io/master: <span class="hljs-string">&quot;&quot;</span><br>      tolerations:<br>      - key: node-role.kubernetes.io/master<br>        operator: Exists<br>        effect: NoSchedule<br><br></code></pre></td></tr></table></figure><h2 id="dingtalk"><a href="#dingtalk" class="headerlink" title="dingtalk"></a>dingtalk</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim dingtalk/config.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: dingtalk-config<br>  namespace: monitoring<br>data:<br>  config.yml: |-<br>    targets:<br>      webhook:<br>        url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx             <span class="hljs-comment">#修改为钉钉机器人的webhook</span><br>        mention:<br>          all: <span class="hljs-literal">true</span>             <span class="hljs-comment">#@所有人</span><br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim dingtalk/dingtalk.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: dingtalk<br>  namespace: monitoring<br>  labels:<br>    app: dingtalk<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;false&#x27;</span><br>spec:<br>  selector:<br>    app: dingtalk<br>  ports:<br>  - name: dingtalk<br>    port: 8060<br>    protocol: TCP<br>    targetPort: 8060<br>  <br>---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: dingtalk<br>  namespace: monitoring<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: dingtalk<br>  template:<br>    metadata:<br>      name: dingtalk<br>      labels:<br>        app: dingtalk<br>    spec:<br>      containers:<br>      - name: dingtalk<br>        image: timonwong/prometheus-webhook-dingtalk:latest<br>        imagePullPolicy: IfNotPresent<br>        ports:<br>        - containerPort: 8060<br>        volumeMounts:<br>        - name: config<br>          mountPath: /etc/prometheus-webhook-dingtalk<br>      volumes:<br>      - name: config<br>        configMap:<br>          name: dingtalk-config<br><br></code></pre></td></tr></table></figure><h2 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim alertmanager/templates.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: alertmanager-templates<br>  namespace: monitoring<br>data:<br>  default.tmpl: |<br>    &#123;&#123; define <span class="hljs-string">&quot;__alertmanager&quot;</span> &#125;&#125;AlertManager&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;__alertmanagerURL&quot;</span> &#125;&#125;&#123;&#123; .ExternalURL &#125;&#125;/#/alerts?receiver=&#123;&#123; .Receiver &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;__subject&quot;</span> &#125;&#125;[&#123;&#123; .Status | toUpper &#125;&#125;&#123;&#123; <span class="hljs-keyword">if</span> eq .Status <span class="hljs-string">&quot;firing&quot;</span> &#125;&#125;:&#123;&#123; .Alerts.Firing | len &#125;&#125;&#123;&#123; end &#125;&#125;] &#123;&#123; .GroupLabels.SortedPairs.Values | <span class="hljs-built_in">join</span> <span class="hljs-string">&quot; &quot;</span> &#125;&#125; &#123;&#123; <span class="hljs-keyword">if</span> gt (len .CommonLabels) (len .GroupLabels) &#125;&#125;(&#123;&#123; with .CommonLabels.Remove .GroupLabels.Names &#125;&#125;&#123;&#123; .Values | <span class="hljs-built_in">join</span> <span class="hljs-string">&quot; &quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;)&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;__description&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;__text_alert_list&quot;</span> &#125;&#125;&#123;&#123; range . &#125;&#125;Labels:<br>    &#123;&#123; range .Labels.SortedPairs &#125;&#125; - &#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;<br>    &#123;&#123; end &#125;&#125;Annotations:<br>    &#123;&#123; range .Annotations.SortedPairs &#125;&#125; - &#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;<br>    &#123;&#123; end &#125;&#125;Source: &#123;&#123; .GeneratorURL &#125;&#125;<br>    &#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;slack.default.title&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;slack.default.username&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__alertmanager&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;slack.default.fallback&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;slack.default.title&quot;</span> . &#125;&#125; | &#123;&#123; template <span class="hljs-string">&quot;slack.default.titlelink&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;slack.default.pretext&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;slack.default.titlelink&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;slack.default.iconemoji&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;slack.default.iconurl&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;slack.default.text&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;hipchat.default.from&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__alertmanager&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;hipchat.default.message&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;pagerduty.default.description&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;pagerduty.default.client&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__alertmanager&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;pagerduty.default.clientURL&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;pagerduty.default.instances&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__text_alert_list&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;opsgenie.default.message&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;opsgenie.default.description&quot;</span> &#125;&#125;&#123;&#123; .CommonAnnotations.SortedPairs.Values | <span class="hljs-built_in">join</span> <span class="hljs-string">&quot; &quot;</span> &#125;&#125;<br>    &#123;&#123; <span class="hljs-keyword">if</span> gt (len .Alerts.Firing) 0 -&#125;&#125;<br>    Alerts Firing:<br>    &#123;&#123; template <span class="hljs-string">&quot;__text_alert_list&quot;</span> .Alerts.Firing &#125;&#125;<br>    &#123;&#123;- end &#125;&#125;<br>    &#123;&#123; <span class="hljs-keyword">if</span> gt (len .Alerts.Resolved) 0 -&#125;&#125;<br>    Alerts Resolved:<br>    &#123;&#123; template <span class="hljs-string">&quot;__text_alert_list&quot;</span> .Alerts.Resolved &#125;&#125;<br>    &#123;&#123;- end &#125;&#125;<br>    &#123;&#123;- end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;opsgenie.default.source&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;victorops.default.message&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__subject&quot;</span> . &#125;&#125; | &#123;&#123; template <span class="hljs-string">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;victorops.default.from&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__alertmanager&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;email.default.subject&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;email.default.html&quot;</span> &#125;&#125;<br>    &lt;!DOCTYPE html PUBLIC <span class="hljs-string">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span class="hljs-string">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span>&gt;<br>    &lt;!--<br>    Style and HTML derived from https://github.com/mailgun/transactional-email-templates<br>    The MIT License (MIT)<br>    Copyright (c) 2014 Mailgun<br>    Permission is hereby granted, free of charge, to any person obtaining a copy<br>    of this software and associated documentation files (the <span class="hljs-string">&quot;Software&quot;</span>), to deal<br>    <span class="hljs-keyword">in</span> the Software without restriction, including without limitation the rights<br>    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell<br>    copies of the Software, and to permit persons to whom the Software is<br>    furnished to <span class="hljs-keyword">do</span> so, subject to the following conditions:<br>    The above copyright notice and this permission notice shall be included <span class="hljs-keyword">in</span> all<br>    copies or substantial portions of the Software.<br>    THE SOFTWARE IS PROVIDED <span class="hljs-string">&quot;AS IS&quot;</span>, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR<br>    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,<br>    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE<br>    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER<br>    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,<br>    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE<br>    SOFTWARE.<br>    --&gt;<br>    &lt;html xmlns=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span> xmlns=<span class="hljs-string">&quot;http://www.w3.org/1999/xhtml&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>    &lt;<span class="hljs-built_in">head</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>    &lt;meta name=<span class="hljs-string">&quot;viewport&quot;</span> content=<span class="hljs-string">&quot;width=device-width&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;<br>    &lt;meta http-equiv=<span class="hljs-string">&quot;Content-Type&quot;</span> content=<span class="hljs-string">&quot;text/html; charset=UTF-8&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;<br>    &lt;title style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;&#123;&#123; template <span class="hljs-string">&quot;__subject&quot;</span> . &#125;&#125;&lt;/title&gt;<br>    &lt;/head&gt;<br>    &lt;body itemscope=<span class="hljs-string">&quot;&quot;</span> itemtype=<span class="hljs-string">&quot;http://schema.org/EmailMessage&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; -webkit-font-smoothing: antialiased; -webkit-text-size-adjust: none; height: 100%; line-height: 1.6em; width: 100% !important; background-color: #f6f6f6; margin: 0; padding: 0;&quot;</span> bgcolor=<span class="hljs-string">&quot;#f6f6f6&quot;</span>&gt;<br>    &lt;table style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; width: 100%; background-color: #f6f6f6; margin: 0;&quot;</span> bgcolor=<span class="hljs-string">&quot;#f6f6f6&quot;</span>&gt;<br>      &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>        &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;&lt;/td&gt;<br>        &lt;td width=<span class="hljs-string">&quot;600&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; display: block !important; max-width: 600px !important; clear: both !important; width: 100% !important; margin: 0 auto; padding: 0;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;<br>          &lt;div style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; max-width: 600px; display: block; margin: 0 auto; padding: 0;&quot;</span>&gt;<br>            &lt;table width=<span class="hljs-string">&quot;100%&quot;</span> cellpadding=<span class="hljs-string">&quot;0&quot;</span> cellspacing=<span class="hljs-string">&quot;0&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; border-radius: 3px; background-color: #fff; margin: 0; border: 1px solid #e9e9e9;&quot;</span> bgcolor=<span class="hljs-string">&quot;#fff&quot;</span>&gt;<br>              &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 16px; vertical-align: top; color: #fff; font-weight: 500; text-align: center; border-radius: 3px 3px 0 0; background-color: #E6522C; margin: 0; padding: 20px;&quot;</span> align=<span class="hljs-string">&quot;center&quot;</span> bgcolor=<span class="hljs-string">&quot;#E6522C&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;<br>                  &#123;&#123; .Alerts | len &#125;&#125; alert&#123;&#123; <span class="hljs-keyword">if</span> gt (len .Alerts) 1 &#125;&#125;s&#123;&#123; end &#125;&#125; <span class="hljs-keyword">for</span> &#123;&#123; range .GroupLabels.SortedPairs &#125;&#125;<br>                    &#123;&#123; .Name &#125;&#125;=&#123;&#123; .Value &#125;&#125;<br>                  &#123;&#123; end &#125;&#125;<br>                &lt;/td&gt;<br>              &lt;/tr&gt;<br>              &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 10px;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;<br>                  &lt;table width=<span class="hljs-string">&quot;100%&quot;</span> cellpadding=<span class="hljs-string">&quot;0&quot;</span> cellspacing=<span class="hljs-string">&quot;0&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                    &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                      &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;<br>                        &lt;a href=<span class="hljs-string">&quot;&#123;&#123; template &quot;</span>__alertmanagerURL<span class="hljs-string">&quot; . &#125;&#125;&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #FFF; text-decoration: none; line-height: 2em; font-weight: bold; text-align: center; cursor: pointer; display: inline-block; border-radius: 5px; text-transform: capitalize; background-color: #348eda; margin: 0; border-color: #348eda; border-style: solid; border-width: 10px 20px;&quot;</span>&gt;View <span class="hljs-keyword">in</span> &#123;&#123; template <span class="hljs-string">&quot;__alertmanager&quot;</span> . &#125;&#125;&lt;/a&gt;<br>                      &lt;/td&gt;<br>                    &lt;/tr&gt;<br>                    &#123;&#123; <span class="hljs-keyword">if</span> gt (len .Alerts.Firing) 0 &#125;&#125;<br>                    &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                      &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;<br>                        &lt;strong style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;[&#123;&#123; .Alerts.Firing | len &#125;&#125;] Firing&lt;/strong&gt;<br>                      &lt;/td&gt;<br>                    &lt;/tr&gt;<br>                    &#123;&#123; end &#125;&#125;<br>                    &#123;&#123; range .Alerts.Firing &#125;&#125;<br>                    &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                      &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;<br>                        &lt;strong style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;Labels&lt;/strong&gt;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;<br>                        &#123;&#123; range .Labels.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;<br>                        &#123;&#123; <span class="hljs-keyword">if</span> gt (len .Annotations) 0 &#125;&#125;&lt;strong style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;Annotations&lt;/strong&gt;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;<br>                        &#123;&#123; range .Annotations.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;<br>                        &lt;a href=<span class="hljs-string">&quot;&#123;&#123; .GeneratorURL &#125;&#125;&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #348eda; text-decoration: underline; margin: 0;&quot;</span>&gt;Source&lt;/a&gt;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;<br>                      &lt;/td&gt;<br>                    &lt;/tr&gt;<br>                    &#123;&#123; end &#125;&#125;<br>                    &#123;&#123; <span class="hljs-keyword">if</span> gt (len .Alerts.Resolved) 0 &#125;&#125;<br>                      &#123;&#123; <span class="hljs-keyword">if</span> gt (len .Alerts.Firing) 0 &#125;&#125;<br>                    &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                      &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;<br>                        &lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;<br>                        &lt;hr style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;<br>                        &lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;<br>                      &lt;/td&gt;<br>                    &lt;/tr&gt;<br>                      &#123;&#123; end &#125;&#125;<br>                    &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                      &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;<br>                        &lt;strong style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;[&#123;&#123; .Alerts.Resolved | len &#125;&#125;] Resolved&lt;/strong&gt;<br>                      &lt;/td&gt;<br>                    &lt;/tr&gt;<br>                    &#123;&#123; end &#125;&#125;<br>                    &#123;&#123; range .Alerts.Resolved &#125;&#125;<br>                    &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                      &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;<br>                        &lt;strong style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;Labels&lt;/strong&gt;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;<br>                        &#123;&#123; range .Labels.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;<br>                        &#123;&#123; <span class="hljs-keyword">if</span> gt (len .Annotations) 0 &#125;&#125;&lt;strong style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;Annotations&lt;/strong&gt;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;<br>                        &#123;&#123; range .Annotations.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;<br>                        &lt;a href=<span class="hljs-string">&quot;&#123;&#123; .GeneratorURL &#125;&#125;&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #348eda; text-decoration: underline; margin: 0;&quot;</span>&gt;Source&lt;/a&gt;&lt;br style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;<br>                      &lt;/td&gt;<br>                    &lt;/tr&gt;<br>                    &#123;&#123; end &#125;&#125;<br>                  &lt;/table&gt;<br>                &lt;/td&gt;<br>              &lt;/tr&gt;<br>            &lt;/table&gt;<br>            &lt;div style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; width: 100%; clear: both; color: #999; margin: 0; padding: 20px;&quot;</span>&gt;<br>              &lt;table width=<span class="hljs-string">&quot;100%&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                &lt;<span class="hljs-built_in">tr</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;<br>                  &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 12px; vertical-align: top; text-align: center; color: #999; margin: 0; padding: 0 0 20px;&quot;</span> align=<span class="hljs-string">&quot;center&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;&lt;a href=<span class="hljs-string">&quot;&#123;&#123; .ExternalURL &#125;&#125;&quot;</span> style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 12px; color: #999; text-decoration: underline; margin: 0;&quot;</span>&gt;Sent by &#123;&#123; template <span class="hljs-string">&quot;__alertmanager&quot;</span> . &#125;&#125;&lt;/a&gt;&lt;/td&gt;<br>                &lt;/tr&gt;<br>              &lt;/table&gt;<br>            &lt;/div&gt;&lt;/div&gt;<br>        &lt;/td&gt;<br>        &lt;td style=<span class="hljs-string">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0;&quot;</span> valign=<span class="hljs-string">&quot;top&quot;</span>&gt;&lt;/td&gt;<br>      &lt;/tr&gt;<br>    &lt;/table&gt;<br>    &lt;/body&gt;<br>    &lt;/html&gt;<br>    &#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;pushover.default.title&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;pushover.default.message&quot;</span> &#125;&#125;&#123;&#123; .CommonAnnotations.SortedPairs.Values | <span class="hljs-built_in">join</span> <span class="hljs-string">&quot; &quot;</span> &#125;&#125;<br>    &#123;&#123; <span class="hljs-keyword">if</span> gt (len .Alerts.Firing) 0 &#125;&#125;<br>    Alerts Firing:<br>    &#123;&#123; template <span class="hljs-string">&quot;__text_alert_list&quot;</span> .Alerts.Firing &#125;&#125;<br>    &#123;&#123; end &#125;&#125;<br>    &#123;&#123; <span class="hljs-keyword">if</span> gt (len .Alerts.Resolved) 0 &#125;&#125;<br>    Alerts Resolved:<br>    &#123;&#123; template <span class="hljs-string">&quot;__text_alert_list&quot;</span> .Alerts.Resolved &#125;&#125;<br>    &#123;&#123; end &#125;&#125;<br>    &#123;&#123; end &#125;&#125;<br>    &#123;&#123; define <span class="hljs-string">&quot;pushover.default.url&quot;</span> &#125;&#125;&#123;&#123; template <span class="hljs-string">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;<br>  slack.tmpl: |<br>    &#123;&#123; define <span class="hljs-string">&quot;slack.devops.text&quot;</span> &#125;&#125;<br>    &#123;&#123;range .Alerts&#125;&#125;&#123;&#123;.Annotations.DESCRIPTION&#125;&#125;<br>    &#123;&#123;end&#125;&#125;<br>    &#123;&#123; end &#125;&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim alertmanager/config.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: alertmanager-config<br>  namespace: monitoring<br>data:<br>  config.yml: |-<br>    global:<br>      resolve_timeout: 5m<br>      smtp_smarthost: <span class="hljs-string">&#x27;smtp.163.com:465&#x27;</span>                <span class="hljs-comment">#邮箱smtp服务器代理，启用SSL发信, 端口一般是465</span><br>      smtp_from: <span class="hljs-string">&#x27;alert@163.com&#x27;</span>                <span class="hljs-comment">#发送邮箱名称</span><br>      smtp_auth_username: <span class="hljs-string">&#x27;alert@163.com&#x27;</span>               <span class="hljs-comment">#邮箱名称</span><br>      smtp_auth_password: <span class="hljs-string">&#x27;password&#x27;</span>                <span class="hljs-comment">#邮箱密码或授权码</span><br>      smtp_require_tls: <span class="hljs-literal">false</span><br>    templates:<br>    - <span class="hljs-string">&#x27;/etc/templates/*.tmpl&#x27;</span><br>    route:<br>      receiver: <span class="hljs-string">&#x27;default&#x27;</span><br>      group_wait: 10s<br>      group_interval: 1m<br>      repeat_interval: 1h<br>      group_by: [<span class="hljs-string">&#x27;alertname&#x27;</span>, <span class="hljs-string">&#x27;instance&#x27;</span>, <span class="hljs-string">&#x27;cluster&#x27;</span>, <span class="hljs-string">&#x27;service&#x27;</span>]<br>      routes:<br>      - receiver: <span class="hljs-string">&#x27;default&#x27;</span><br>        match:<br>          severity: <span class="hljs-string">&#x27;warning&#x27;</span><br>      - receiver: <span class="hljs-string">&#x27;dingtalk&#x27;</span><br>        match:<br>          severity: <span class="hljs-string">&#x27;critical&#x27;</span><br>    inhibit_rules:<br>    - source_match:<br>        severity: <span class="hljs-string">&#x27;critical&#x27;</span><br>      target_match:<br>        severity: <span class="hljs-string">&#x27;warning&#x27;</span><br>      equal: [<span class="hljs-string">&#x27;alertname&#x27;</span>, <span class="hljs-string">&#x27;instance&#x27;</span>, <span class="hljs-string">&#x27;cluster&#x27;</span>, <span class="hljs-string">&#x27;service&#x27;</span>]<br>    receivers:<br>    - name: <span class="hljs-string">&#x27;default&#x27;</span><br>      email_configs:<br>      - to: <span class="hljs-string">&#x27;receiver@163.com&#x27;</span><br>        send_resolved: <span class="hljs-literal">true</span><br>    - name: <span class="hljs-string">&#x27;dingtalk&#x27;</span><br>      webhook_configs:<br>      - url: <span class="hljs-string">&#x27;http://dingtalk:8060/dingtalk/webhook/send&#x27;</span><br>        send_resolved: <span class="hljs-literal">true</span><br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim alertmanager/alertmanager.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: networking.k8s.io/v1<br>kind: Ingress<br>metadata:<br>  name: alertmanager<br>  namespace: monitoring<br>spec:<br>  rules:<br>  - host: 10.100.30.70<br>    http:<br>      paths:<br>      - path: /<br>        backend:<br>          serviceName: alertmanager<br>          servicePort: 9093<br>          <br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: alertmanager<br>  namespace: monitoring<br>  labels:<br>    name: alertmanager<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>spec:<br>  selector:<br>    app: alertmanager<br>  ports:<br>  - name: alertmanager<br>    port: 9093<br>    protocol: TCP<br>    targetPort: 9093<br>    <br>---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: alertmanager<br>  namespace: monitoring<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: alertmanager<br>  template:<br>    metadata:<br>      name: alertmanager<br>      labels:<br>        app: alertmanager<br>    spec:<br>      containers:<br>      - name: alertmanager<br>        image: prom/alertmanager:latest<br>        imagePullPolicy: IfNotPresent<br>        ports:<br>        - containerPort: 9093<br>        <span class="hljs-built_in">env</span>:<br>        - name: POD_IP<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: status.podIP<br>        args:<br>          - <span class="hljs-string">&quot;--config.file=/etc/alertmanager/config.yml&quot;</span><br>          - <span class="hljs-string">&quot;--storage.path=/alertmanager&quot;</span><br>          - <span class="hljs-string">&quot;--cluster.advertise-address=<span class="hljs-subst">$(POD_IP)</span>:6783&quot;</span>                <span class="hljs-comment">#没有该参数会报错：Failed to get final advertise address</span><br>        volumeMounts:<br>        - name: config<br>          mountPath: /etc/alertmanager<br>        - name: templates<br>          mountPath: /etc/templates<br>        - name: alertmanager<br>          mountPath: /alertmanager<br>      volumes:<br>      - name: config<br>        configMap:<br>          name: alertmanager-config<br>      - name: templates<br>        configMap:<br>          name: alertmanager-templates<br>      - name: alertmanager<br>        emptyDir: &#123;&#125;<br><br></code></pre></td></tr></table></figure><h2 id="prometheus"><a href="#prometheus" class="headerlink" title="prometheus"></a>prometheus</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim prometheus/rbac.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  name: prometheus<br>  namespace: monitoring<br><br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRole<br>metadata:<br>  name: prometheus<br>rules:<br>- apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>  resources:<br>  - nodes<br>  - nodes/proxy<br>  - services<br>  - endpoints<br>  - pods<br>  verbs: [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br>- apiGroups: [<span class="hljs-string">&quot;networking.k8s.io&quot;</span>]<br>  resources:<br>  - ingresses<br>  verbs: [<span class="hljs-string">&quot;get&quot;</span>, <span class="hljs-string">&quot;list&quot;</span>, <span class="hljs-string">&quot;watch&quot;</span>]<br>- apiGroups: [<span class="hljs-string">&quot;&quot;</span>]<br>  resources:<br>  - configmaps<br>  verbs: [<span class="hljs-string">&quot;get&quot;</span>]<br>- nonResourceURLs: [<span class="hljs-string">&quot;/metrics&quot;</span>]<br>  verbs: [<span class="hljs-string">&quot;get&quot;</span>]<br><br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: ClusterRoleBinding<br>metadata:<br>  name: prometheus<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: ClusterRole<br>  name: prometheus<br>subjects:<br>- kind: ServiceAccount<br>  name: prometheus<br>  namespace: monitoring<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim prometheus/config.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: prometheus-config<br>  namespace: monitoring<br>data:<br>  prometheus.yml: |<br>    global:<br>      scrape_interval: 10s<br>      scrape_timeout: 10s<br>      evaluation_interval: 10s<br>    alerting:<br>      alertmanagers:<br>      - static_configs:<br>        - targets:<br>          - alertmanager:9093<br>    rule_files:<br>      - <span class="hljs-string">&quot;/etc/prometheus-rules/*.rules&quot;</span><br>    scrape_configs:<br>      - job_name: <span class="hljs-string">&#x27;node-exporter&#x27;</span>                <span class="hljs-comment">#node节点性能指标数据</span><br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: endpoints<br>        relabel_configs:<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_endpoint_port_name]<br>          regex: <span class="hljs-literal">true</span>;node-exporter<br>          action: keep<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]<br>          action: replace<br>          target_label: __scheme__<br>          regex: (https?)<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]<br>          action: replace<br>          target_label: __metrics_path__<br>          regex: (.+)<br>        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]<br>          action: replace<br>          target_label: __address__<br>          regex: (.+)(?::\d+);(\d+)<br>          replacement: <span class="hljs-variable">$1</span>:<span class="hljs-variable">$2</span><br>        - action: labelmap<br>          regex: __meta_kubernetes_service_label_(.+)<br>        - source_labels: [__meta_kubernetes_namespace]<br>          action: replace<br>          target_label: kubernetes_namespace<br>        - source_labels: [__meta_kubernetes_service_name]<br>          action: replace<br>          target_label: kubernetes_name<br>          <br>      - job_name: <span class="hljs-string">&#x27;kube-apiservers&#x27;</span><br>        scheme: https<br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: endpoints<br>        relabel_configs:<br>        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]<br>          regex: default;kubernetes;https<br>          action: keep<br>        <br>      - job_name: <span class="hljs-string">&#x27;kube-controller-manager&#x27;</span><br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: endpoints<br>        relabel_configs:<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]<br>          regex: <span class="hljs-literal">true</span>;kube-system;kube-controller-manager-prometheus-discovery<br>          action: keep<br>          <br>      - job_name: <span class="hljs-string">&#x27;kube-scheduler&#x27;</span><br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: endpoints<br>        relabel_configs:<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]<br>          regex: <span class="hljs-literal">true</span>;kube-system;kube-scheduler-prometheus-discovery<br>          action: keep<br>          <br>      - job_name: <span class="hljs-string">&#x27;kubelet&#x27;</span><br>        scheme: https<br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: node<br>        relabel_configs:<br>        - action: labelmap<br>          regex: __meta_kubernetes_node_label_(.+)<br>        - target_label: __address__<br>          replacement: 192.168.30.188:6443<br>        - source_labels: [__meta_kubernetes_node_name]<br>          regex: (.+)<br>          target_label: __metrics_path__<br>          replacement: /api/v1/nodes/<span class="hljs-variable">$&#123;1&#125;</span>/proxy/metrics<br><br>      - job_name: <span class="hljs-string">&#x27;kube-proxy&#x27;</span><br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: endpoints<br>        relabel_configs:<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]<br>          regex: <span class="hljs-literal">true</span>;kube-system;kube-proxy-prometheus-discovery<br>          action: keep<br><br>      - job_name: <span class="hljs-string">&#x27;kubernetes-cadvisor&#x27;</span>                <span class="hljs-comment">#容器、Pod相关的性能指标数据</span><br>        scheme: https<br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: node<br>        relabel_configs:<br>        - action: labelmap<br>          regex: __meta_kubernetes_node_label_(.+)<br>        - target_label: __address__<br>          replacement: 192.168.30.188:6443<br>        - source_labels: [__meta_kubernetes_node_name]<br>          regex: (.+)<br>          target_label: __metrics_path__<br>          replacement: /api/v1/nodes/<span class="hljs-variable">$&#123;1&#125;</span>/proxy/metrics/cadvisor<br>        metric_relabel_configs:<br>        - source_labels: [<span class="hljs-built_in">id</span>]<br>          action: replace<br>          regex: <span class="hljs-string">&#x27;^/machine\.slice/machine-rkt\\x2d([^\\]+)\\.+/([^/]+)\.service$&#x27;</span><br>          target_label: rkt_container_name<br>          replacement: <span class="hljs-string">&#x27;$&#123;2&#125;-$&#123;1&#125;&#x27;</span><br>        - source_labels: [<span class="hljs-built_in">id</span>]<br>          action: replace<br>          regex: <span class="hljs-string">&#x27;^/system\.slice/(.+)\.service$&#x27;</span><br>          target_label: systemd_service_name<br>          replacement: <span class="hljs-string">&#x27;$&#123;1&#125;&#x27;</span><br>          <br>      - job_name: <span class="hljs-string">&#x27;kube-state-metrics&#x27;</span>              <span class="hljs-comment">#资源对象(Deployment、Pod等)的状态</span><br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: endpoints<br>        relabel_configs:<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_endpoint_port_name]<br>          regex: <span class="hljs-literal">true</span>;kube-state-metrics<br>          action: keep<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]<br>          action: replace<br>          target_label: __scheme__<br>          regex: (https?)<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]<br>          action: replace<br>          target_label: __metrics_path__<br>          regex: (.+)<br>        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]<br>          action: replace<br>          target_label: __address__<br>          regex: (.+)(?::\d+);(\d+)<br>          replacement: <span class="hljs-variable">$1</span>:<span class="hljs-variable">$2</span><br>        - action: labelmap<br>          regex: __meta_kubernetes_service_label_(.+)<br>        - source_labels: [__meta_kubernetes_namespace]<br>          action: replace<br>          target_label: kubernetes_namespace<br>        - source_labels: [__meta_kubernetes_service_name]<br>          action: replace<br>          target_label: kubernetes_name<br>          <br>      - job_name: <span class="hljs-string">&#x27;kubernetes-service-http-probe&#x27;</span>               <span class="hljs-comment">#通过http方式探测Service状态</span><br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: service<br>        metrics_path: /probe<br>        params:<br>          module: [http_2xx]<br>        relabel_configs:<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_http_probe]<br>          regex: <span class="hljs-literal">true</span>;<span class="hljs-literal">true</span><br>          action: keep<br>        - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_http_probe_port, __meta_kubernetes_service_annotation_prometheus_io_http_probe_path]<br>          action: replace<br>          target_label: __param_target<br>          regex: (.+);(.+);(.+);(.+)<br>          replacement: <span class="hljs-variable">$1</span>.<span class="hljs-variable">$2</span>:$3<span class="hljs-variable">$4</span><br>        - target_label: __address__<br>          replacement: 192.168.30.128:30115<br>        - source_labels: [__param_target]<br>          target_label: instance<br>        - action: labelmap<br>          regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)<br><br>      - job_name: <span class="hljs-string">&#x27;kubernetes-service-tcp-probe&#x27;</span>                <span class="hljs-comment">#通过tcp方式探测Service状态</span><br>        tls_config:<br>          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt<br>        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token<br>        kubernetes_sd_configs:<br>        - role: service<br>        metrics_path: /probe<br>        params:<br>          module: [tcp_connect]<br>        relabel_configs:<br>        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe]<br>          regex: <span class="hljs-literal">true</span>;<span class="hljs-literal">true</span><br>          action: keep<br>        - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe_port]<br>          action: replace<br>          target_label: __param_target<br>          regex: (.+);(.+);(.+)<br>          replacement: <span class="hljs-variable">$1</span>.<span class="hljs-variable">$2</span>:<span class="hljs-variable">$3</span><br>        - target_label: __address__<br>          replacement: 192.168.30.128:30115<br>        - source_labels: [__param_target]<br>          target_label: instance<br>        - action: labelmap<br>          regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)<br>          <br>      - job_name: <span class="hljs-string">&#x27;kubernetes-ingresses&#x27;</span>              <span class="hljs-comment">#通过http方式探测ingresses状态</span><br>        kubernetes_sd_configs:<br>        - role: ingress<br>        metrics_path: /probe<br>        params:<br>          module: [http_2xx]<br>        relabel_configs:<br>        - source_labels: [__meta_kubernetes_ingress_scheme, __address__, __meta_kubernetes_ingress_path]<br>          regex: (.+);(.+);(.+)<br>          replacement: <span class="hljs-variable">$&#123;1&#125;</span>://<span class="hljs-variable">$&#123;2&#125;</span><span class="hljs-variable">$&#123;3&#125;</span><br>          target_label: __param_target<br>        - target_label: __address__<br>          replacement: 192.168.30.128:30115<br>        - source_labels: [__param_target]<br>          target_label: instance<br>        - action: labelmap<br>          regex: __meta_kubernetes_ingress_label_(.+)<br>        - source_labels: [__meta_kubernetes_namespace]<br>          target_label: kubernetes_namespace<br>        - source_labels: [__meta_kubernetes_ingress_name]<br>          target_label: kubernetes_name<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim prometheus/rules.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: prometheus-rules<br>  namespace: monitoring<br>data:<br>  node.rules: |<br>    <span class="hljs-built_in">groups</span>:<br>    - name: node<br>      rules:<br>      - alert: NodeDown<br>        <span class="hljs-built_in">expr</span>: up == 0<br>        <span class="hljs-keyword">for</span>: 3m<br>        labels:<br>          severity: critical<br>        annotations:<br>          summary: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$labels</span>.instance &#125;&#125;: down&quot;</span><br>          description: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$labels</span>.instance &#125;&#125; has been down for more than 3m&quot;</span><br>          value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br><br>      - alert: NodeCPUHigh<br>        <span class="hljs-built_in">expr</span>: (1 - avg by (instance) (irate(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;idle&quot;</span>&#125;[5m]))) * 100 &gt; 75<br>        <span class="hljs-keyword">for</span>: 5m<br>        labels:<br>          severity: warning<br>        annotations:<br>          summary: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: High CPU usage&quot;</span><br>          description: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: CPU usage is above 75%&quot;</span><br>          value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br><br>      - alert: NodeCPUIowaitHigh<br>        <span class="hljs-built_in">expr</span>: avg by (instance) (irate(node_cpu_seconds_total&#123;mode=<span class="hljs-string">&quot;iowait&quot;</span>&#125;[5m])) * 100 &gt; 50<br>        <span class="hljs-keyword">for</span>: 5m<br>        labels:<br>          severity: warning<br>        annotations:<br>          summary: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: High CPU iowait usage&quot;</span><br>          description: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: CPU iowait usage is above 50%&quot;</span><br>          value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br><br>      - alert: NodeMemoryUsageHigh<br>        <span class="hljs-built_in">expr</span>: (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 &gt; 90<br>        <span class="hljs-keyword">for</span>: 5m<br>        labels:<br>          severity: warning<br>        annotations:<br>          summary: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: High memory usage&quot;</span><br>          description: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: Memory usage is above 90%&quot;</span><br>          value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br><br>      - alert: NodeDiskRootLow<br>        <span class="hljs-built_in">expr</span>: (1 - node_filesystem_avail_bytes&#123;fstype=~<span class="hljs-string">&quot;ext.*|xfs&quot;</span>,mountpoint =<span class="hljs-string">&quot;/&quot;</span>&#125; / node_filesystem_size_bytes&#123;fstype=~<span class="hljs-string">&quot;ext.*|xfs&quot;</span>,mountpoint =<span class="hljs-string">&quot;/&quot;</span>&#125;) * 100 &gt; 80<br>        <span class="hljs-keyword">for</span>: 10m<br>        labels:<br>          severity: warning<br>        annotations:<br>          summary: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: Low disk(the / partition) space&quot;</span><br>          description: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: Disk(the / partition) usage is above 80%&quot;</span><br>          value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br>        <br>      - alert: NodeDiskBootLow<br>        <span class="hljs-built_in">expr</span>: (1 - node_filesystem_avail_bytes&#123;fstype=~<span class="hljs-string">&quot;ext.*|xfs&quot;</span>,mountpoint =<span class="hljs-string">&quot;/boot&quot;</span>&#125; / node_filesystem_size_bytes&#123;fstype=~<span class="hljs-string">&quot;ext.*|xfs&quot;</span>,mountpoint =<span class="hljs-string">&quot;/boot&quot;</span>&#125;) * 100 &gt; 80<br>        <span class="hljs-keyword">for</span>: 10m<br>        labels:<br>          severity: warning<br>        annotations:<br>          summary: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: Low disk(the /boot partition) space&quot;</span><br>          description: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: Disk(the /boot partition) usage is above 80%&quot;</span><br>          value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br><br>      - alert: NodeLoad5High<br>        <span class="hljs-built_in">expr</span>: (node_load5) &gt; (count by (instance) (node_cpu_seconds_total&#123;mode=<span class="hljs-string">&#x27;system&#x27;</span>&#125;) * 2)<br>        <span class="hljs-keyword">for</span>: 5m<br>        labels:<br>          severity: warning<br>        annotations:<br>          summary: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: Load(5m) High&quot;</span><br>          description: <span class="hljs-string">&quot;&#123;&#123;<span class="hljs-variable">$labels</span>.instance&#125;&#125;: Load(5m) is 2 times the number of CPU cores&quot;</span><br>          value: <span class="hljs-string">&quot;&#123;&#123; <span class="hljs-variable">$value</span> &#125;&#125;&quot;</span><br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim prometheus/prometheus.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: networking.k8s.io/v1<br>kind: Ingress<br>metadata:<br>  name: prometheus<br>  namespace: monitoring<br>spec:<br>  rules:<br>  - host: prometheus.lzxlinux.cn<br>    http:<br>      paths:<br>      - path: /<br>        pathType: Prefix<br>        backend:<br>          service:<br>            name: prometheus<br>            port:<br>              number: 9090<br><br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: prometheus<br>  namespace: monitoring<br>  labels:<br>    app: prometheus<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>spec:<br>  selector:<br>    app: prometheus<br>  ports:<br>  - name: prometheus<br>    port: 9090<br>    protocol: TCP<br>    targetPort: 9090<br><br>---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: prometheus<br>  namespace: monitoring<br>  labels:<br>    app: prometheus<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: prometheus<br>  template:<br>    metadata:<br>      labels:<br>        app: prometheus<br>    spec:<br>      serviceAccountName: prometheus<br>      containers:<br>      - name: prometheus<br>        image: prom/prometheus:latest<br>        imagePullPolicy: IfNotPresent<br>        args:<br>          - <span class="hljs-string">&#x27;--storage.tsdb.path=/prometheus&#x27;</span><br>          - <span class="hljs-string">&#x27;--storage.tsdb.retention.time=30d&#x27;</span><br>          - <span class="hljs-string">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span><br>        ports:<br>        - containerPort: 9090<br>        resources:<br>          requests:<br>            cpu: 500m<br>            memory: 500M<br>          limits:<br>            cpu: 500m<br>            memory: 500M<br>        volumeMounts:<br>        - name: config<br>          mountPath: /etc/prometheus<br>        - name: rules<br>          mountPath: /etc/prometheus-rules<br>        - name: prometheus<br>          mountPath: /prometheus<br>      volumes:<br>      - name: config<br>        configMap:<br>          name: prometheus-config<br>      - name: rules<br>        configMap:<br>          name: prometheus-rules<br>      - name: prometheus<br>        emptyDir: &#123;&#125;<br>      nodeSelector:<br>        node-role.kubernetes.io/master: <span class="hljs-string">&quot;&quot;</span><br>        kubernetes.io/hostname: <span class="hljs-string">&quot;master2&quot;</span><br>      tolerations:<br>      - key: node-role.kubernetes.io/master<br>        operator: Exists<br>        effect: NoSchedule<br><br></code></pre></td></tr></table></figure><h2 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim grafana/secret.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Secret<br>metadata:<br>  name: grafana<br>  namespace: monitoring<br>data:<br>  admin-password: YWRtaW4=              <span class="hljs-comment"># base64 加解密</span><br>  admin-username: YWRtaW4=<br><span class="hljs-built_in">type</span>: Opaque<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim grafana/grafana.yaml<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: grafana<br>  namespace: monitoring<br>  labels:<br>    app: grafana<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>    prometheus.io/path: <span class="hljs-string">&#x27;/metrics&#x27;</span><br>spec:<br>  <span class="hljs-built_in">type</span>: NodePort<br>  selector:<br>    app: grafana<br>  ports:<br>  - name: grafana<br>    port: 3000<br>    protocol: TCP<br>    targetPort: 3000<br>    nodePort: 32000  <span class="hljs-comment"># 确保这个端口在你的范围内</span><br><br>---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: grafana<br>  namespace: monitoring<br>  labels:<br>    app: grafana<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      app: grafana<br>  template:<br>    metadata:<br>      labels:<br>        app: grafana<br>    spec:<br>      containers:<br>      - name: grafana<br>        image: grafana/grafana:latest<br>        imagePullPolicy: IfNotPresent<br>        ports:<br>        - containerPort: 3000<br>          name: grafana<br>        resources:<br>          limits:<br>            cpu: 100m<br>            memory: 100Mi<br>          requests:<br>            cpu: 100m<br>            memory: 100Mi<br>        <span class="hljs-built_in">env</span>:<br>          - name: GF_AUTH_BASIC_ENABLED<br>            value: <span class="hljs-string">&quot;true&quot;</span><br>          - name: GF_AUTH_ANONYMOUS_ENABLED<br>            value: <span class="hljs-string">&quot;false&quot;</span><br>          - name: GF_AUTH_ANONYMOUS_ORG_ROLE<br>            value: Admin<br>          - name: GF_DASHBOARDS_JSON_ENABLED<br>            value: <span class="hljs-string">&quot;true&quot;</span><br>          - name: GF_INSTALL_PLUGINS<br>            value: grafana-kubernetes-app<br>          - name: GF_SECURITY_ADMIN_USER<br>            valueFrom:<br>              secretKeyRef:<br>                name: grafana<br>                key: admin-username<br>          - name: GF_SECURITY_ADMIN_PASSWORD<br>            valueFrom:<br>              secretKeyRef:<br>                name: grafana<br>                key: admin-password<br>        readinessProbe:<br>          httpGet:<br>            path: /login<br>            port: 3000<br>          initialDelaySeconds: 10<br>          timeoutSeconds: 5<br>        volumeMounts:<br>        - name: grafana-storage<br>          mountPath: /var/lib/grafana<br>      volumes:<br>      - name: grafana-storage<br>        emptyDir: &#123;&#125;<br><br></code></pre></td></tr></table></figure><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl apply -f namespace.yaml<br><br>kubectl apply -f node-exporter/<br><br>kubectl apply -f k8s/<br><br>kubectl apply -f kube-state-metrics/<br><br>kubectl apply -f blackbox-exporter/<br><br>kubectl apply -f dingtalk/<br><br>kubectl apply -f alertmanager/<br><br>kubectl apply -f prometheus/<br><br>kubectl apply -f grafana/<br><br></code></pre></td></tr></table></figure><h2 id="查看"><a href="#查看" class="headerlink" title="查看"></a>查看</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs bash">kubectl get all -n monitoring<br><br>NAME                                      READY   STATUS    RESTARTS   AGE<br>pod/alertmanager-9c4bf8565-z9mp9          1/1     Running   0          2m54s<br>pod/blackbox-exporter-57d847fc4c-mq8mx    1/1     Running   0          2m58s<br>pod/dingtalk-957f5896-9bd9b               1/1     Running   0          2m56s<br>pod/grafana-76779dc8cf-2fk4x              1/1     Running   0          2m46s<br>pod/kube-state-metrics-5d5f7cd774-tw4sw   1/1     Running   0          2m58s<br>pod/node-exporter-29bkg                   1/1     Running   0          3m5s<br>pod/node-exporter-45k2d                   1/1     Running   0          3m5s<br>pod/node-exporter-8dbts                   1/1     Running   0          3m5s<br>pod/node-exporter-9kwwt                   1/1     Running   0          3m5s<br>pod/node-exporter-bxhcf                   1/1     Running   0          3m5s<br>pod/prometheus-65848cf9b4-m5kcf           1/1     Running   0          2m49s<br><br>NAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE<br>service/alertmanager         ClusterIP   10.98.52.72      &lt;none&gt;        9093/TCP         2m55s<br>service/blackbox-exporter    NodePort    10.106.73.127    &lt;none&gt;        9115:30115/TCP   2m58s<br>service/dingtalk             ClusterIP   10.103.205.136   &lt;none&gt;        8060/TCP         2m57s<br>service/grafana              ClusterIP   10.103.12.113    &lt;none&gt;        3000/TCP         2m47s<br>service/kube-state-metrics   ClusterIP   10.98.99.215     &lt;none&gt;        8080/TCP         3m1s<br>service/node-exporter        ClusterIP   None             &lt;none&gt;        9100/TCP         3m6s<br>service/prometheus           ClusterIP   10.99.50.109     &lt;none&gt;        9090/TCP         2m51s<br><br>NAME                           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE<br>daemonset.apps/node-exporter   5         5         5       5            5           &lt;none&gt;          3m5s<br><br>NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE<br>deployment.apps/alertmanager         1/1     1            1           2m55s<br>deployment.apps/blackbox-exporter    1/1     1            1           2m58s<br>deployment.apps/dingtalk             1/1     1            1           2m57s<br>deployment.apps/grafana              1/1     1            1           2m46s<br>deployment.apps/kube-state-metrics   1/1     1            1           3m<br>deployment.apps/prometheus           1/1     1            1           2m51s<br><br>NAME                                            DESIRED   CURRENT   READY   AGE<br>replicaset.apps/alertmanager-9c4bf8565          1         1         1       2m55s<br>replicaset.apps/blackbox-exporter-57d847fc4c    1         1         1       2m58s<br>replicaset.apps/dingtalk-957f5896               1         1         1       2m56s<br>replicaset.apps/grafana-76779dc8cf              1         1         1       2m46s<br>replicaset.apps/kube-state-metrics-5d5f7cd774   1         1         1       3m<br>replicaset.apps/prometheus-65848cf9b4           1         1         1       2m51s<br><br></code></pre></td></tr></table></figure><h2 id="grafana模板"><a href="#grafana模板" class="headerlink" title="grafana模板"></a>grafana模板</h2><p><code>8919</code></p><h2 id="grafana配置kubernetes数据源"><a href="#grafana配置kubernetes数据源" class="headerlink" title="grafana配置kubernetes数据源"></a>grafana配置kubernetes数据源</h2><p><code>启动插件：plugins--kubeernetes--enable</code>，然后配置集群访问地址及访问证书</p><p><code>如果是通过kubeadm方式搭建的k8s集群，会有一个/etc/kubernetes/admin.conf文件，里面包含了客户端的证书和密码base64编码</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/kubernetes/admin.conf<br><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs bash">apiVersion: v1<br>clusters:<br>- cluster:<br>    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJd01EVXhNakV3TURBek1Gb1hEVE13TURVeE1ERXdNREF6TUZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDVpCmYxTGcxUUlqN0VlWlZ0cVFmS3dGZjg4V3NVbVVialZldll5NDZTUittMWpwRWdvM2wxWEIvZHBFNzRWOGtqTGQKZkdGdmVWZkVxNy8rMzdyamNGMXRpSm1BbThLZnMrMW9QdEpLOE0yZjNTSm5FZVVIQUlBeFl2cUE4ZFNsbThTQwpmSkJWU2J3K1pROTBTelpKNzdQUzFuZTBmYnRod0Y2VHE0Uy9FV3h3cUZZMzF5cENub05lVUNtcElsSjVnYWdtCnJ2QmhkTmFNb2oyQlRrMWNDVjh3dkRVS3RlbXFVYVE4R2ZCalZLeHhkdWtwcjJ3S3RPbXZkem1vMEdLSE11MFcKWmQ1TVd0dStIQVZrTXhzcE95Yk41NkFkNnloUkN5YkFJbTN2ZWJlTFV5cjBEY2JhNzJXNVlPRHRCY3ZBOEJxOAoxR1JQc1EwaXBUdGtYbDVCZEhzQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFJS0lIb25wVllFWWpwR3JrN2wraGJyeGlxZXkKeGFQT1M3UW5TZEVZMC94TWtiUWxKcy9rUFcxU2lVemdoUk4wQWJxMnFtTXVuNHhlZ0pLdGVPNXhYRGJZNEhZbgpVVCtPWG0rQ1hBQjd3S3pYcDlmUTZBUDk3cmY0L2FRaXlGZEtsZUJ6Y3JNUkErZHZWTjk3NGlHUW94aFh3T1FNCmZXeGNrMDNhU0Qvc2s5UnJrcFhlL1g2NHQrV3BkUlFGRjE2YVFlSHVxNnJQRWZTR2VPUWVpcVIrQVgvdWpIOHoKZzJZY2JKWE85U3ZheXcyb3oxSlozTUx6K0FpeE5RTHFNYU00Tm43TklvMExxUHFqNzZoU3d1Qk1nREE0VnFtZAowZHRtS211OVZjTGZHcW9ITnZnajlTYlVlZ1crL3VEbzcwVXdvb2NGTmlnSnRnOVVSZWpEUXJJSm4rUT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=<br>    server: https://192.168.30.188:6443<br>  name: kubernetes<br>contexts:<br>- context:<br>    cluster: kubernetes<br>    user: kubernetes-admin<br>  name: kubernetes-admin@kubernetes<br>current-context: kubernetes-admin@kubernetes<br>kind: Config<br>preferences: &#123;&#125;<br><span class="hljs-built_in">users</span>:<br>- name: kubernetes-admin<br>  user:<br>    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM4akNDQWRxZ0F3SUJBZ0lJZWtMYS9Fc1ZDSGd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TURBMU1USXhNREF3TXpCYUZ3MHlNVEExTVRJeE1EQXdNekphTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXJ2a084MUg0ZW9zak5kM3oKSy9UUEhHcGtCR1FvZm1hbm9ldjRlWXNmUTlPZW0wYzBvVUJ3cXoxM2JabmJUbmJweFFqbmdZMkc4bHF4UmkwaQpCdlA2ZmtmS0ZFQlZzUTd4dGlqZXBrdnByWEdPL08wUUE1U0k4NHJzTjVHOVhOa2pQbWdzYTBlblZxNUVvRTBGClRaNXpRRjlwUlkxWUZZZXYrTDE1bU5FaXlScUg4UDJRY3BoUmxWK09IUXVHaVdLNEhIRVB2QWw2QUpJeWN6d3MKWWMrdk1IdHlZbmF5NUMwUldVWHhyUmc0ZytKMksrY1h1YlF0elhXdjdxaTNhNjFDekpaZi9TZkNOd0Jyam9zRwp0b215WEJWNVZTVGJUYVk1OFZrLzFPK1NSc3BybjF3TDc0djdXUXVEaE9ydXhBRXpuYmRXWWxOMEZBMm5MTjlZCmwxWkVKUUlEQVFBQm95Y3dKVEFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFHazlIRDAxRmRRUnd4THhGUi8yRjdPM2ZpdGRFV3pDTC9UawpsZUxZaGlQaVh3NjNwOGtWU0VabEIyNEYzNEd2WlB3YS9LWnNUQnZXM0Mwek9uNGpHQ2hueHEvaVdqTWFnVEdBCktPUFV2bUI2VzhvVzhlb0lrSStOOEs0NFhSRnZzeGIwNUtqaCtwd0VZZzJUQXpBNEFlQzlnSjZYaTBzbHpnVnIKcWRzbXZtV0QzNEdXYzJOcVIzSDA3cW43RlJwRHIrTjlrTHE4Ukt4L0YwMWNCV1I3VVRZcnJTLzJEQ2t1N3lsWgptdTcwcXZicndYWnF6TkI5b05hQk82SHJsZXpuU2JQbnFKZUo0Q1czc2NMNmJ1N3A3bEppV1VQb0VHT0xic3YvCnFjT0xqdnZSRFF6eC9Xak5DWFZLNFhxbzJjVERGYitXeFJ1U2xGaUlQclk1QjlkQlFJWT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=<br>    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBcnZrTzgxSDRlb3NqTmQzeksvVFBIR3BrQkdRb2ZtYW5vZXY0ZVlzZlE5T2VtMGMwCm9VQndxejEzYlpuYlRuYnB4UWpuZ1kyRzhscXhSaTBpQnZQNmZrZktGRUJWc1E3eHRpamVwa3ZwclhHTy9PMFEKQTVTSTg0cnNONUc5WE5ralBtZ3NhMGVuVnE1RW9FMEZUWjV6UUY5cFJZMVlGWWV2K0wxNW1ORWl5UnFIOFAyUQpjcGhSbFYrT0hRdUdpV0s0SEhFUHZBbDZBSkl5Y3p3c1ljK3ZNSHR5WW5heTVDMFJXVVh4clJnNGcrSjJLK2NYCnViUXR6WFd2N3FpM2E2MUN6SlpmL1NmQ053QnJqb3NHdG9teVhCVjVWU1RiVGFZNThWay8xTytTUnNwcm4xd0wKNzR2N1dRdURoT3J1eEFFem5iZFdZbE4wRkEybkxOOVlsMVpFSlFJREFRQUJBb0lCQUI4OHI0S1krN2RFNThCUwpJM3VSZFBncHRqbGllQ2c0dzJ5UTZBY3E0eVlFdmFnVENqNVBkczNiWjFyVndPVTlMWGJUcENEbzExS2xCa2owCi9jSW9CR3hPL0xDbzI2T0VlM3A5eVdIKzQzVG5kUk9LYnZWMHF3NXZtc1JBN0lHSzhsUE4zVUE1eHBJZkFubHIKeHFxWXd4S1c5Z0JJdjVUNGFGNEwxWTJHcUtNbUlhenVjLzVleU5rZjk3bnRyOFJncXQxcDJyaWJIVS9nRzFlYgpIWktyNm01UWx2MWJpYTFIYms2SWI2b1pYTVFIWWJSckpVemJSaWp6eE1RVkRmZ2tpalhSR3pSRjdZeVFZbTk5CmwwUzI1bDYzY1dIT3J6czM5R21xRmQ4Z0JJc0M3SkxuUThUY01nb1Axb0M5WXUzMGRrSDBvUi95M2lOTnFxRW8KZVJ2d0w0RUNnWUVBeG1tY2JDZXRlRDI5VWZDTE1kKzByTU14aVV4bHI3TTdrYUJOeWxPK2lOZWxKbUk5UHRXcwpkUzQzS2hkeElnSVNIQVRTdWxpR3VKMStEekxTWWNGZ2FkSmQxd25NNHppOUc2cW9NOXZTTVN2ZGtvK28ydXRqCmNscVBZcnVRbC9nK252dkE2N1ZyZzAyUXF0NFlqcmkrYmxQL1RNaDZGS3NGa0VQeXZPTHUxOTBDZ1lFQTRjSFgKUm43WUl2TWtMNGQrR3dkUmRwcXl5YStxVC9nbUtKTnNwb3VLUVZlaUd3aW9vR21BR0E0MEJBR2hyN24vMXB6Rwo5VkVQb201VDdPRnVmVWxGaUNURmJBblN2RWU5RTREUHJ3SDNhazlXR0JzcWxYcUZwMjdwWWFyZ3NSS2JDWU9UCm9Nc1FJR0wxelN4NEpkdFArMUxDQ1BuRnowMTNkajhRbmc4TVBPa0NnWUFwczF5cTVwUHc1NWo0dGNPcmtjYloKWUpUeXRGblMyYXExYXFtdTBuY0RMNytJRjdHam1Ta0wzOUM4U2Z6L0ZzeFRremZ1N2xneVNQZUxualRWVXQwKwpvSFlVa2Z5NzdOcmlDN1lhWUNNSExwNzlCTENLZ2xwK1dFWTJqQkZSdjF6NThST1U5cVpJREc5UldpaHpKcVR2CmJ6d0RHVWQvUElxSXpaOGd6OWsvQ1FLQmdIbEFRaDVEdkZReElNdENTM0c2NFg4QklXdC9wTXFrcmVIM0pGRGkKKzFPUy9LYm1aS01iWnNnRXdOMHgveVJCa3U0eWNBMk1Cd2lubHYzUUtpYXlOdDBqV3NGbkdUODBqSkd3Q2x1bApnN3dlZGxBbUx4M3ZtMTlOQzU0QVNBUHl5VUEzNGc5bllQYjBENjZ0NXEzMmQ2TzFWQys3N3dralF6bElMK1drCmtWOFpBb0dBVk01R1lLbnpNVjUzVzNXT3I0dFdLSm5XUHFiaHVlUEt5SXMzbTNkUzhGUE56SDU2UHhNKzRUM24Ka2NzT1VsZTlkQkFENXRXT3E5eHFmNWF4MXpaU2s1SzFhdUphSzRaa3RzNkdMRUgrU09WckdoK1JXQWtRcUFVbgo0Qmk4ZVA4MmR5M3N2RmV1UkNvTWFXRVQ0QlFHaGRQaFFCd1NNdlYrSWI2R3U0VldwN289Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==<br><br></code></pre></td></tr></table></figure><p><code>其中属性certificate-authority-data、client-certificate-data、client-key-data对应CA证书、client证书、、client私钥，文件里面的内容是base64编码过后的，分别执行echo &quot;&lt;base64 code&gt;&quot; | base64 -d 就能还原成证书源文件。</code></p><h1 id="yaml文件创建"><a href="#yaml文件创建" class="headerlink" title="yaml文件创建"></a>yaml文件创建</h1><p><code>先创建monitoring的名称空间：kubectl create namespace monitoring </code></p><h2 id="alertmanager的yaml文件"><a href="#alertmanager的yaml文件" class="headerlink" title="alertmanager的yaml文件"></a>alertmanager的yaml文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><code class="hljs bash">---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  annotations: &#123;&#125;<br>  labels: &#123;&#125;<br>  name: alertmanager<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;28485&#x27;</span><br>spec:<br>  progressDeadlineSeconds: 600<br>  replicas: 1<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>      app: alertmanager<br>  strategy:<br>    rollingUpdate:<br>      maxSurge: 25%<br>      maxUnavailable: 25%<br>    <span class="hljs-built_in">type</span>: RollingUpdate<br>  template:<br>    metadata:<br>      creationTimestamp: null<br>      labels:<br>        app: alertmanager<br>    spec:<br>      containers:<br>        - args:<br>            - <span class="hljs-string">&#x27;--config.file=/etc/alertmanager/config.yml&#x27;</span><br>            - <span class="hljs-string">&#x27;--storage.path=/alertmanager&#x27;</span><br>            - <span class="hljs-string">&#x27;--cluster.advertise-address=$(POD_IP):6783&#x27;</span><br>          <span class="hljs-built_in">env</span>:<br>            - name: POD_IP<br>              valueFrom:<br>                fieldRef:<br>                  apiVersion: v1<br>                  fieldPath: status.podIP<br>          image: <span class="hljs-string">&#x27;prom/alertmanager:latest&#x27;</span><br>          imagePullPolicy: IfNotPresent<br>          name: alertmanager<br>          ports:<br>            - containerPort: 9093<br>              protocol: TCP<br>          resources: &#123;&#125;<br>          terminationMessagePath: /dev/termination-log<br>          terminationMessagePolicy: File<br>          volumeMounts:<br>            - mountPath: /etc/alertmanager<br>              name: config<br>            - mountPath: /etc/templates<br>              name: templates<br>            - mountPath: /alertmanager<br>              name: alertmanager<br>      dnsPolicy: ClusterFirst<br>      restartPolicy: Always<br>      schedulerName: default-scheduler<br>      securityContext: &#123;&#125;<br>      terminationGracePeriodSeconds: 30<br>      volumes:<br>        - configMap:<br>            defaultMode: 420<br>            name: alertmanager-config<br>          name: config<br>        - configMap:<br>            defaultMode: 420<br>            name: alertmanager-templates<br>          name: templates<br>        - emptyDir: &#123;&#125;<br>          name: alertmanager<br><br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>  labels:<br>    name: alertmanager<br>  name: alertmanager<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;28635&#x27;</span><br>spec:<br>  clusterIP: 10.233.20.249<br>  clusterIPs:<br>    - 10.233.20.249<br>  externalTrafficPolicy: Cluster<br>  internalTrafficPolicy: Cluster<br>  ipFamilies:<br>    - IPv4<br>  ipFamilyPolicy: SingleStack<br>  ports:<br>    - name: alertmanager<br>      nodePort: 30093<br>      port: 9093<br>      protocol: TCP<br>      targetPort: 9093<br>  selector:<br>    app: alertmanager<br>  sessionAffinity: None<br>  <span class="hljs-built_in">type</span>: NodePort<br><br><br></code></pre></td></tr></table></figure><h2 id="blackbox-exporter-1"><a href="#blackbox-exporter-1" class="headerlink" title="blackbox-exporter"></a>blackbox-exporter</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs bash">---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  annotations: &#123;&#125;<br>  labels: &#123;&#125;<br>  name: blackbox-exporter<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;37640&#x27;</span><br>spec:<br>  progressDeadlineSeconds: 600<br>  replicas: 1<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>      app: blackbox-exporter<br>  strategy:<br>    rollingUpdate:<br>      maxSurge: 25%<br>      maxUnavailable: 25%<br>    <span class="hljs-built_in">type</span>: RollingUpdate<br>  template:<br>    metadata:<br>      creationTimestamp: null<br>      labels:<br>        app: blackbox-exporter<br>    spec:<br>      containers:<br>        - args:<br>            - <span class="hljs-string">&#x27;--config.file=/etc/blackbox_exporter/blackbox.yml&#x27;</span><br>            - <span class="hljs-string">&#x27;--web.listen-address=:9115&#x27;</span><br>          image: <span class="hljs-string">&#x27;prom/blackbox-exporter:latest&#x27;</span><br>          imagePullPolicy: IfNotPresent<br>          name: blackbox-exporter<br>          ports:<br>            - containerPort: 9115<br>              protocol: TCP<br>          readinessProbe:<br>            failureThreshold: 3<br>            initialDelaySeconds: 10<br>            periodSeconds: 10<br>            successThreshold: 1<br>            tcpSocket:<br>              port: 9115<br>            timeoutSeconds: 5<br>          resources:<br>            limits:<br>              cpu: 200m<br>              memory: 60Mi<br>            requests:<br>              cpu: 100m<br>              memory: 50Mi<br>          terminationMessagePath: /dev/termination-log<br>          terminationMessagePolicy: File<br>          volumeMounts:<br>            - mountPath: /etc/blackbox_exporter<br>              name: config<br>      dnsPolicy: ClusterFirst<br>      restartPolicy: Always<br>      schedulerName: default-scheduler<br>      securityContext: &#123;&#125;<br>      terminationGracePeriodSeconds: 30<br>      tolerations:<br>        - effect: NoSchedule<br>          key: node-role.kubernetes.io/master<br>          operator: Exists<br>      volumes:<br>        - configMap:<br>            defaultMode: 420<br>            name: blackbox-exporter<br>          name: config<br><br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>  labels:<br>    app: blackbox-exporter<br>  name: blackbox-exporter<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;27344&#x27;</span><br>spec:<br>  clusterIP: 10.233.60.92<br>  clusterIPs:<br>    - 10.233.60.92<br>  externalTrafficPolicy: Cluster<br>  internalTrafficPolicy: Cluster<br>  ipFamilies:<br>    - IPv4<br>  ipFamilyPolicy: SingleStack<br>  ports:<br>    - name: blackbox<br>      nodePort: 30115<br>      port: 9115<br>      protocol: TCP<br>      targetPort: 9115<br>  selector:<br>    app: blackbox-exporter<br>  sessionAffinity: None<br>  <span class="hljs-built_in">type</span>: NodePort<br><br><br></code></pre></td></tr></table></figure><h2 id="dingtalk-1"><a href="#dingtalk-1" class="headerlink" title="dingtalk"></a>dingtalk</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs bash">---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  annotations: &#123;&#125;<br>  labels:<br>    app: grafana<br>  name: grafana<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;39074&#x27;</span><br>spec:<br>  progressDeadlineSeconds: 600<br>  replicas: 1<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>      app: grafana<br>  strategy:<br>    rollingUpdate:<br>      maxSurge: 25%<br>      maxUnavailable: 25%<br>    <span class="hljs-built_in">type</span>: RollingUpdate<br>  template:<br>    metadata:<br>      creationTimestamp: null<br>      labels:<br>        app: grafana<br>    spec:<br>      containers:<br>        - <span class="hljs-built_in">env</span>:<br>            - name: GF_AUTH_BASIC_ENABLED<br>              value: <span class="hljs-string">&#x27;true&#x27;</span><br>            - name: GF_AUTH_ANONYMOUS_ENABLED<br>              value: <span class="hljs-string">&#x27;false&#x27;</span><br>            - name: GF_AUTH_ANONYMOUS_ORG_ROLE<br>              value: Admin<br>            - name: GF_DASHBOARDS_JSON_ENABLED<br>              value: <span class="hljs-string">&#x27;true&#x27;</span><br>            - name: GF_INSTALL_PLUGINS<br>              value: grafana-kubernetes-app<br>            - name: GF_SECURITY_ADMIN_USER<br>              valueFrom:<br>                secretKeyRef:<br>                  key: admin-username<br>                  name: grafana<br>            - name: GF_SECURITY_ADMIN_PASSWORD<br>              valueFrom:<br>                secretKeyRef:<br>                  key: admin-password<br>                  name: grafana<br>          image: <span class="hljs-string">&#x27;grafana/grafana:latest&#x27;</span><br>          imagePullPolicy: IfNotPresent<br>          name: grafana<br>          ports:<br>            - containerPort: 3000<br>              name: grafana<br>              protocol: TCP<br>          readinessProbe:<br>            failureThreshold: 3<br>            httpGet:<br>              path: /login<br>              port: 3000<br>              scheme: HTTP<br>            initialDelaySeconds: 30<br>            periodSeconds: 10<br>            successThreshold: 1<br>            timeoutSeconds: 5<br>          resources:<br>            limits:<br>              cpu: 100m<br>              memory: 100Mi<br>            requests:<br>              cpu: 100m<br>              memory: 100Mi<br>          terminationMessagePath: /dev/termination-log<br>          terminationMessagePolicy: File<br>          volumeMounts:<br>            - mountPath: /var/lib/grafana<br>              name: grafana-storage<br>      dnsPolicy: ClusterFirst<br>      restartPolicy: Always<br>      schedulerName: default-scheduler<br>      securityContext: &#123;&#125;<br>      terminationGracePeriodSeconds: 30<br>      volumes:<br>        - emptyDir: &#123;&#125;<br>          name: grafana-storage<br><br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  annotations: &#123;&#125;<br>  labels:<br>    app: grafana<br>  name: grafana<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;33834&#x27;</span><br>spec:<br>  clusterIP: 10.233.48.176<br>  clusterIPs:<br>    - 10.233.48.176<br>  externalTrafficPolicy: Cluster<br>  internalTrafficPolicy: Cluster<br>  ipFamilies:<br>    - IPv4<br>  ipFamilyPolicy: SingleStack<br>  ports:<br>    - name: grafana<br>      nodePort: 32000<br>      port: 3000<br>      protocol: TCP<br>      targetPort: 3000<br>  selector:<br>    app: grafana<br>  sessionAffinity: None<br>  <span class="hljs-built_in">type</span>: NodePort<br><br>---<br>apiVersion: networking.k8s.io/v1<br>kind: Ingress<br>metadata:<br>  annotations: &#123;&#125;<br>  name: grafana<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;33841&#x27;</span><br>spec:<br>  rules:<br>    - host: grafana.lzxlinux.cn<br>      http:<br>        paths:<br>          - backend:<br>              service:<br>                name: grafana<br>                port:<br>                  number: 3000<br>            path: /<br>            pathType: Prefix<br><br><br></code></pre></td></tr></table></figure><h2 id="kube-state-metrics-1"><a href="#kube-state-metrics-1" class="headerlink" title="kube-state-metrics"></a>kube-state-metrics</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs bash">---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  annotations: &#123;&#125;<br>  labels:<br>    app: kube-state-metrics<br>  name: kube-state-metrics<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;38566&#x27;</span><br>spec:<br>  progressDeadlineSeconds: 600<br>  replicas: 1<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>      app: kube-state-metrics<br>  strategy:<br>    rollingUpdate:<br>      maxSurge: 25%<br>      maxUnavailable: 25%<br>    <span class="hljs-built_in">type</span>: RollingUpdate<br>  template:<br>    metadata:<br>      creationTimestamp: null<br>      labels:<br>        app: kube-state-metrics<br>    spec:<br>      containers:<br>        - image: <span class="hljs-string">&#x27;quay.io/coreos/kube-state-metrics:v1.8.0&#x27;</span><br>          imagePullPolicy: IfNotPresent<br>          name: kube-state-metrics<br>          ports:<br>            - containerPort: 8080<br>              protocol: TCP<br>          resources: &#123;&#125;<br>          terminationMessagePath: /dev/termination-log<br>          terminationMessagePolicy: File<br>      dnsPolicy: ClusterFirst<br>      restartPolicy: Always<br>      schedulerName: default-scheduler<br>      securityContext: &#123;&#125;<br>      serviceAccount: kube-state-metrics<br>      serviceAccountName: kube-state-metrics<br>      terminationGracePeriodSeconds: 30<br><br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  annotations:<br>    prometheus.io/http-probe: <span class="hljs-string">&#x27;true&#x27;</span><br>    prometheus.io/http-probe-path: /healthz<br>    prometheus.io/http-probe-port: <span class="hljs-string">&#x27;8080&#x27;</span><br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>  labels:<br>    app: kube-state-metrics<br>  name: kube-state-metrics<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;38207&#x27;</span><br>spec:<br>  clusterIP: 10.233.21.4<br>  clusterIPs:<br>    - 10.233.21.4<br>  internalTrafficPolicy: Cluster<br>  ipFamilies:<br>    - IPv4<br>  ipFamilyPolicy: SingleStack<br>  ports:<br>    - name: kube-state-metrics<br>      port: 8080<br>      protocol: TCP<br>      targetPort: 8080<br>  selector:<br>    app: kube-state-metrics<br>  sessionAffinity: None<br>  <span class="hljs-built_in">type</span>: ClusterIP<br><br><br></code></pre></td></tr></table></figure><h2 id="node-exporter-1"><a href="#node-exporter-1" class="headerlink" title="node-exporter"></a>node-exporter</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs bash">---<br>apiVersion: apps/v1<br>kind: DaemonSet<br>metadata:<br>  annotations:<br>    deprecated.daemonset.template.generation: <span class="hljs-string">&#x27;1&#x27;</span><br>  labels:<br>    app: node-exporter<br>  name: node-exporter<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;27437&#x27;</span><br>spec:<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>      app: node-exporter<br>  template:<br>    metadata:<br>      creationTimestamp: null<br>      labels:<br>        app: node-exporter<br>      name: node-exporter<br>    spec:<br>      containers:<br>        - image: <span class="hljs-string">&#x27;prom/node-exporter:latest&#x27;</span><br>          imagePullPolicy: IfNotPresent<br>          name: node-exporter<br>          ports:<br>            - containerPort: 9100<br>              hostPort: 9100<br>              protocol: TCP<br>          resources: &#123;&#125;<br>          terminationMessagePath: /dev/termination-log<br>          terminationMessagePolicy: File<br>      dnsPolicy: ClusterFirst<br>      hostNetwork: <span class="hljs-literal">true</span><br>      hostPID: <span class="hljs-literal">true</span><br>      restartPolicy: Always<br>      schedulerName: default-scheduler<br>      securityContext: &#123;&#125;<br>      terminationGracePeriodSeconds: 30<br>      tolerations:<br>        - effect: NoSchedule<br>          key: node-role.kubernetes.io/master<br>          operator: Exists<br>  updateStrategy:<br>    rollingUpdate:<br>      maxSurge: 0<br>      maxUnavailable: 1<br>    <span class="hljs-built_in">type</span>: RollingUpdate<br><br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  annotations:<br>    prometheus.io/scrape: <span class="hljs-string">&#x27;true&#x27;</span><br>  labels:<br>    app: node-exporter<br>  name: node-exporter<br>  namespace: monitoring<br>  resourceVersion: <span class="hljs-string">&#x27;27267&#x27;</span><br>spec:<br>  clusterIP: None<br>  clusterIPs:<br>    - None<br>  internalTrafficPolicy: Cluster<br>  ipFamilies:<br>    - IPv4<br>  ipFamilyPolicy: SingleStack<br>  ports:<br>    - name: node-exporter<br>      port: 9100<br>      protocol: TCP<br>      targetPort: 9100<br>  selector:<br>    app: node-exporter<br>  sessionAffinity: None<br>  <span class="hljs-built_in">type</span>: ClusterIP<br><br><br></code></pre></td></tr></table></figure><h2 id="promethues"><a href="#promethues" class="headerlink" title="promethues"></a>promethues</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><code class="hljs sbash">---<br>apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  annotations: &#123;&#125;<br>  labels:<br>    app: prometheus<br>    k8s.kuboard.cn/name: prometheus<br>  name: prometheus<br>  namespace: monitoring<br>  resourceVersion: &#x27;33415&#x27;<br>spec:<br>  progressDeadlineSeconds: 600<br>  replicas: 1<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>      app: prometheus<br>  strategy:<br>    rollingUpdate:<br>      maxSurge: 25%<br>      maxUnavailable: 25%<br>    type: RollingUpdate<br>  template:<br>    metadata:<br>      creationTimestamp: null<br>      labels:<br>        app: prometheus<br>    spec:<br>      containers:<br>        - args:<br>            - &#x27;--storage.tsdb.path=/prometheus&#x27;<br>            - &#x27;--storage.tsdb.retention.time=30d&#x27;<br>            - &#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;<br>          image: &#x27;prom/prometheus:latest&#x27;<br>          imagePullPolicy: IfNotPresent<br>          name: prometheus<br>          ports:<br>            - containerPort: 9090<br>              protocol: TCP<br>          resources:<br>            limits:<br>              cpu: 500m<br>              memory: 500M<br>            requests:<br>              cpu: 500m<br>              memory: 500M<br>          terminationMessagePath: /dev/termination-log<br>          terminationMessagePolicy: File<br>          volumeMounts:<br>            - mountPath: /etc/prometheus<br>              name: config<br>            - mountPath: /etc/prometheus-rules<br>              name: rules<br>            - mountPath: /prometheus<br>              name: prometheus<br>      dnsPolicy: ClusterFirst<br>      restartPolicy: Always<br>      schedulerName: default-scheduler<br>      securityContext: &#123;&#125;<br>      serviceAccount: prometheus<br>      serviceAccountName: prometheus<br>      terminationGracePeriodSeconds: 30<br>      tolerations:<br>        - effect: NoSchedule<br>          key: node-role.kubernetes.io/control-plane<br>          operator: Exists<br>      volumes:<br>        - configMap:<br>            defaultMode: 420<br>            name: prometheus-config<br>          name: config<br>        - configMap:<br>            defaultMode: 420<br>            name: prometheus-rules<br>          name: rules<br>        - emptyDir: &#123;&#125;<br>          name: prometheus<br><br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  annotations:<br>    prometheus.io/scrape: &#x27;true&#x27;<br>  labels:<br>    app: prometheus<br>  name: prometheus<br>  namespace: monitoring<br>  resourceVersion: &#x27;33519&#x27;<br>spec:<br>  clusterIP: 10.233.51.128<br>  clusterIPs:<br>    - 10.233.51.128<br>  externalTrafficPolicy: Cluster<br>  internalTrafficPolicy: Cluster<br>  ipFamilies:<br>    - IPv4<br>  ipFamilyPolicy: SingleStack<br>  ports:<br>    - name: prometheus<br>      nodePort: 30090<br>      port: 9090<br>      protocol: TCP<br>      targetPort: 9090<br>  selector:<br>    app: prometheus<br>  sessionAffinity: None<br>  type: NodePort<br><br>---<br>apiVersion: networking.k8s.io/v1<br>kind: Ingress<br>metadata:<br>  annotations: &#123;&#125;<br>  name: prometheus<br>  namespace: monitoring<br>  resourceVersion: &#x27;33391&#x27;<br>spec:<br>  rules:<br>    - host: prometheus.lzxlinux.cn<br>      http:<br>        paths:<br>          - backend:<br>              service:<br>                name: prometheus<br>                port:<br>                  number: 9090<br>            path: /<br>            pathType: Prefix<br><br><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>hexo</title>
    <link href="/2025/01/17/hexo/"/>
    <url>/2025/01/17/hexo/</url>
    
    <content type="html"><![CDATA[<p>博客搭建教程视频地址：<a href="https://www.bilibili.com/video/BV1nY6xYmEw7?buvid=YD44F3D7CA9FF4654EA985A08644F4A38FB0&from_spmid=tm.recommend.0.0&is_story_h5=false&mid=QY8SLP3aFxWc3ZZhivkAwX8FTQ/SZMtL1rElX6M3iMo=&plat_id=116&share_from=ugc&share_medium=iphone&share_plat=ios&share_session_id=977D55C6-F8AF-4D06-88FF-5BF8DBEDBED8&share_source=COPY&share_tag=s_i&spmid=united.player-video-detail.0.0&timestamp=1735960479&unique_k=MFZ2A8W&up_id=258944527&vd_source=2faa5edeffeb71a8abb2307ca70fa880">https://www.bilibili.com/video/BV1nY6xYmEw7?buvid=YD44F3D7CA9FF4654EA985A08644F4A38FB0&amp;from_spmid=tm.recommend.0.0&amp;is_story_h5=false&amp;mid=QY8SLP3aFxWc3ZZhivkAwX8FTQ%2FSZMtL1rElX6M3iMo%3D&amp;plat_id=116&amp;share_from=ugc&amp;share_medium=iphone&amp;share_plat=ios&amp;share_session_id=977D55C6-F8AF-4D06-88FF-5BF8DBEDBED8&amp;share_source=COPY&amp;share_tag=s_i&amp;spmid=united.player-video-detail.0.0&amp;timestamp=1735960479&amp;unique_k=MFZ2A8W&amp;up_id=258944527&amp;vd_source=2faa5edeffeb71a8abb2307ca70fa880</a><br>1、环境准备</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">nodejs-18以上，git<br><span class="hljs-comment"># 验证</span><br>node -v<br>npm -v<br></code></pre></td></tr></table></figure><p>2、安装hexo客户端</p><figure class="highlight tcl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tcl">hexo是一个静态的博客框架，托管与gitee<br><span class="hljs-comment"># 更换为国内的npm源</span><br>npm config <span class="hljs-keyword">set</span> <span class="hljs-keyword">registry</span> https://<span class="hljs-keyword">registry</span>.npmmirror.com<br></code></pre></td></tr></table></figure><h1 id="安装hexo客户端"><a href="#安装hexo客户端" class="headerlink" title="安装hexo客户端"></a>安装hexo客户端</h1><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">npm install -g hexo-<span class="hljs-keyword">cli</span><br></code></pre></td></tr></table></figure><h1 id="使用hexo初始化一个文件夹，名字可以自定义，用于存放博客文章的文件夹"><a href="#使用hexo初始化一个文件夹，名字可以自定义，用于存放博客文章的文件夹" class="headerlink" title="使用hexo初始化一个文件夹，名字可以自定义，用于存放博客文章的文件夹"></a>使用hexo初始化一个文件夹，名字可以自定义，用于存放博客文章的文件夹</h1><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">hexo init <span class="hljs-keyword">my</span>-blog<br></code></pre></td></tr></table></figure><h1 id="安装依赖包"><a href="#安装依赖包" class="headerlink" title="安装依赖包"></a>安装依赖包</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">cd my-<span class="hljs-keyword">blog</span><br><span class="hljs-keyword"></span>npm <span class="hljs-keyword">install </span><br></code></pre></td></tr></table></figure><h1 id="前期准备完成，install完后会生成以下文件"><a href="#前期准备完成，install完后会生成以下文件" class="headerlink" title="前期准备完成，install完后会生成以下文件"></a>前期准备完成，install完后会生成以下文件</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">[root@localhost my-<span class="hljs-keyword">blog]# </span>ls<br>_<span class="hljs-built_in">config</span>.fluid.yml      _<span class="hljs-built_in">config</span>.yml  node_modules  package-lock.<span class="hljs-keyword">json </span> README.en.md  <span class="hljs-keyword">scaffolds </span> themes<br>_<span class="hljs-built_in">config</span>.landscape.yml  db.<span class="hljs-keyword">json </span>     package.<span class="hljs-keyword">json </span> public             README.md     source<br></code></pre></td></tr></table></figure><p>3、配置文件简介</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">_config.yaml：主文件夹，有博客名，作者等信息<br><span class="hljs-built_in">source</span>/_posts：用于存放我们文章的目录<br>themes：目录下存放的的博客的主题配置文件<br></code></pre></td></tr></table></figure><p>4、启动hexo</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs verilog"># 启动预览博客页面<br>hexo <span class="hljs-keyword">generate</span> &amp;&amp; hexo server<br></code></pre></td></tr></table></figure><h1 id="会生成个登入地址，用于在页面访问"><a href="#会生成个登入地址，用于在页面访问" class="headerlink" title="会生成个登入地址，用于在页面访问"></a>会生成个登入地址，用于在页面访问</h1><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">http:</span><span class="hljs-comment">//localhost:4000/ </span><br></code></pre></td></tr></table></figure><p>5、创建gitee&#x2F;githup仓库</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-comment"># gitee创建blog仓库</span><br><br><span class="hljs-comment"># 初始化</span><br><span class="hljs-string">git</span> <span class="hljs-string">init</span><br><span class="hljs-comment"># 设置远程仓库</span><br><span class="hljs-string">git</span> <span class="hljs-string">remote</span> <span class="hljs-string">add</span> <span class="hljs-string">origin</span> <span class="hljs-string">git</span>@<span class="hljs-string">github</span>.<span class="hljs-string">com:xubaodong0511/</span><span class="hljs-string">xubaodong0511</span>.<span class="hljs-string">github</span>.<span class="hljs-string">io</span>.<span class="hljs-string">git</span><br><span class="hljs-comment"># 更换远程仓库的命令</span><br><span class="hljs-string">git</span> <span class="hljs-string">remote</span> <span class="hljs-built_in">set-url</span> <span class="hljs-string">origin</span> <span class="hljs-string">git</span>@<span class="hljs-string">github</span>.<span class="hljs-string">com:xubaodong0511/</span><span class="hljs-string">blog</span>.<span class="hljs-string">io</span>.<span class="hljs-string">git</span><br><span class="hljs-comment"># 验证在哪个远程仓库</span><br><span class="hljs-string">git</span> <span class="hljs-string">remote</span> -<span class="hljs-string">v</span><br><br><span class="hljs-comment"># github上配置ssh密钥的时候需要在服务器上创建config文件，将以下内容添加到config文件中并保存</span><br><span class="hljs-string">Host</span> <span class="hljs-string">github</span>.<span class="hljs-string">com</span><br>  <span class="hljs-string">Hostname</span> <span class="hljs-string">ssh</span>.<span class="hljs-string">github</span>.<span class="hljs-string">com</span><br>  <span class="hljs-string">Port</span> <span class="hljs-string">443</span><br><span class="hljs-comment"># 拉取、推送文件</span><br><span class="hljs-string">git</span> <span class="hljs-string">clone</span> <span class="hljs-string">git</span>@<span class="hljs-string">github</span>.<span class="hljs-string">com:xubaodong0511/</span><span class="hljs-string">blog</span>.<span class="hljs-string">io</span>.<span class="hljs-string">git</span><br><span class="hljs-string">git</span> <span class="hljs-string">push</span> -<span class="hljs-string">u</span> <span class="hljs-string">origin</span> <span class="hljs-string">main</span> <span class="hljs-built_in">--force</span><br></code></pre></td></tr></table></figure><p>6、修改配置文件</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs ruby"><span class="hljs-comment"># 修改_config.yml文件，在末尾添加</span><br><span class="hljs-symbol">deploy:</span><br>  <span class="hljs-symbol">type:</span> <span class="hljs-string">&#x27;&#x27;</span><br>  <span class="hljs-comment"># 添加以下两行，git<span class="hljs-doctag">@gitee</span>.com:gitee用户名/仓库名.git，branch指定分支</span><br>  <span class="hljs-symbol">repository:</span> git<span class="hljs-variable">@github</span>.<span class="hljs-symbol">com:</span>xubaodong0511/xubaodong0511.github.io.git<br>  <span class="hljs-symbol">branch:</span> main<br>                   <br>注释：使用cursor运行hexo时会有管理员权限问题<br>解决：退出重新以管理员身份运行，并执行<span class="hljs-string">`Set-ExecutionPolicy RemoteSigned`</span>，如果有选择输入Y<br></code></pre></td></tr></table></figure><p>7、创建、及发布文章</p><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs crystal"><span class="hljs-comment"># 创建名为第一篇博客名的文章</span><br>[root<span class="hljs-variable">@localhost</span> my-blog]<span class="hljs-comment"># hexo new post 我的第一篇博客</span><br>INFO  Validating config<br>INFO  <span class="hljs-symbol">Created:</span> ~<span class="hljs-regexp">/my-blog/source</span><span class="hljs-regexp">/_posts/</span>我的第一篇博客.md<br></code></pre></td></tr></table></figure><h1 id="安装hexo-git插件"><a href="#安装hexo-git插件" class="headerlink" title="安装hexo-git插件"></a>安装hexo-git插件</h1><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">npm install hexo-deployer-git <span class="hljs-comment">--save</span><br></code></pre></td></tr></table></figure><h1 id="发布文章"><a href="#发布文章" class="headerlink" title="发布文章"></a>发布文章</h1><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs verilog">hexo clean &amp;&amp; hexo <span class="hljs-keyword">generate</span> &amp;&amp; hexo deploy<br>或<br>hexo c &amp;&amp; hexo g &amp;&amp; hexo d<br></code></pre></td></tr></table></figure><p>8、cloudflare托管网站，域名代理</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">点击worker和pages</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">选择pages</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">点击连接到git</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">选择githup或gitee</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">选第二个，only <span class="hljs-keyword">select</span> repositories(选择仓库)</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">授权</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">确认仓库，开始设置</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">确认分支，保存设置开始部署</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">继续处理项目</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">自定义域</span><br></code></pre></td></tr></table></figure><p>9、设置主题</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">githup上搜索hexo-theme-fluid<br>或直接打开以下地址<br><span class="hljs-symbol">https:</span>//github.com/fluid-dev/hexo-theme-fluid?tab=readme-ov-file<br><br>方式一：<br><span class="hljs-meta"># Hexo 5.0.0 版本以上，推荐通过 npm 直接安装，进入博客目录执行命令：</span><br>npm install --save hexo-theme-fluid<br>然后在博客目录下创建 _config.fluid.yml，将主题的 _config.yml 内容复制进去。<br>方式二：<br><span class="hljs-meta"># 修改 Hexo 博客目录中的 _config.yml：</span><br><span class="hljs-symbol">theme:</span> fluid  <span class="hljs-meta"># 指定主题</span><br><span class="hljs-symbol">language:</span> <span class="hljs-built_in">zh</span>-CN  <span class="hljs-meta"># 指定语言，会影响主题显示的语言，按需修改</span><br></code></pre></td></tr></table></figure><h1 id="主题配置"><a href="#主题配置" class="headerlink" title="主题配置"></a>主题配置</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 创建「关于页」，首次使用主题的「关于页」需要手动创建：</span><br><span class="hljs-string">hexo</span> <span class="hljs-string">new</span> <span class="hljs-string">page</span> <span class="hljs-string">about</span><br><span class="hljs-string">创建成功后，编辑博客目录下</span> <span class="hljs-string">/source/about/index.md，添加</span> <span class="hljs-string">layout</span> <span class="hljs-string">属性。</span><br><span class="hljs-string">修改后的文件示例如下：</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">title:</span> <span class="hljs-string">about</span><br><span class="hljs-attr">layout:</span> <span class="hljs-string">about</span><br><span class="hljs-meta">---</span><br></code></pre></td></tr></table></figure><h1 id="重新启动hexo"><a href="#重新启动hexo" class="headerlink" title="重新启动hexo"></a>重新启动hexo</h1><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs verilog">hexo clean &amp;&amp; hexo <span class="hljs-keyword">generate</span> &amp;&amp; hexo deploy<br></code></pre></td></tr></table></figure><p>10、设置文章的标签</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment"># 在文字的开头添加以下内容</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">title:</span> <span class="hljs-string">gicc升级</span><br><span class="hljs-attr">date:</span> <span class="hljs-number">2025-01-05</span><br><span class="hljs-attr">tags:</span> [<span class="hljs-string">Linux运维，系统</span>]<br><span class="hljs-meta">---</span><br></code></pre></td></tr></table></figure><p>11、增加评论功能</p><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs nix"><span class="hljs-comment"># 插件地址</span><br>https:<span class="hljs-symbol">//github.com/apps/utterances</span><br><br><span class="hljs-comment"># 点击install安装</span><br><br><span class="hljs-comment"># 选第二个，only select repositories(选择仓库)</span><br><br><span class="hljs-comment"># 在githup的blog仓库点settings设置</span><br><span class="hljs-comment"># 在下面找到Features下的Discussion的选项，选择打勾</span><br><span class="hljs-comment"># 修改_config.fluid.yml 文件，在最下发添加以下内容</span><br><span class="hljs-comment"># discuss</span><br><span class="hljs-params">post:</span><br>  <span class="hljs-params">comments:</span><br>    <span class="hljs-params">enable:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-params">type:</span> utterances<br><br><span class="hljs-params">utterances:</span><br>  <span class="hljs-params">repo:</span> xubaodong0511<span class="hljs-symbol">/xubaodong0511.github.io</span><br>  <span class="hljs-params">issue_term:</span> pathname<br>  <span class="hljs-params">label:</span> utterances<br>  <span class="hljs-params">theme:</span> github-light<br>  <span class="hljs-params">theme_dark:</span> github-dark<br>  <span class="hljs-params">crossorigin:</span> anonymous<br></code></pre></td></tr></table></figure><p>12、重启hexo</p><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs verilog"># 启动hexo<br>hexo clean &amp;&amp; hexo <span class="hljs-keyword">generate</span> &amp;&amp; hexo server<br>或<br>nohup hexo clean &amp;&amp; hexo <span class="hljs-keyword">generate</span> &amp;&amp; hexo server &amp;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>hexo</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>域名配置</title>
    <link href="/2025/01/09/%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE/"/>
    <url>/2025/01/09/%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<h1 id="一、使用子域名（方案一）"><a href="#一、使用子域名（方案一）" class="headerlink" title="一、使用子域名（方案一）"></a>一、使用子域名（方案一）</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">server &#123;<br>    listen 80;<br>    server_name service1.example.com;<br><br>    location / &#123;<br>        proxy_pass http://localhost:3000;<br>        proxy_set_header Host <span class="hljs-variable">$host</span>;<br>        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>    &#125;<br>&#125;<br><br>server &#123;<br>    listen 80;<br>    server_name service2.example.com;<br><br>    location / &#123;<br>        proxy_pass http://localhost:4000;<br>        proxy_set_header Host <span class="hljs-variable">$host</span>;<br>        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="二、使用同一个域名-方案二"><a href="#二、使用同一个域名-方案二" class="headerlink" title="二、使用同一个域名(方案二)"></a>二、使用同一个域名(方案二)</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs bash">server &#123;<br>    listen 80;<br>    server_name example.com;<br><br>    location /service1 &#123;<br>        proxy_pass http://localhost:3000;<br>        proxy_set_header Host <span class="hljs-variable">$host</span>;<br>        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>    &#125;<br><br>    location /service2 &#123;<br>        proxy_pass http://localhost:4000;<br>        proxy_set_header Host <span class="hljs-variable">$host</span>;<br>        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="配置ssl证书"><a href="#配置ssl证书" class="headerlink" title="配置ssl证书"></a>配置ssl证书</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># 1、安装Certbot，Certbot是一个自动化工具，可以帮助你获取和安装SSL证书</span><br><span class="hljs-comment"># 对于Ubuntu/Debian</span><br><span class="hljs-built_in">sudo</span> apt update<br><span class="hljs-built_in">sudo</span> apt install certbot python3-certbot-nginx<br><br><span class="hljs-comment"># 对于CentOS/RHEL</span><br><span class="hljs-built_in">sudo</span> yum install epel-release<br><span class="hljs-built_in">sudo</span> yum install certbot python3-certbot-nginx<br><br><span class="hljs-comment"># 2. 获取SSL证书，使用Certbot为每个子域名获取SSL证书：</span><br><span class="hljs-built_in">sudo</span> certbot --nginx -d service1.example.com -d service2.example.com<br></code></pre></td></tr></table></figure><h1 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs bash">server &#123;<br>    listen 80;<br>    server_name service1.example.com;<br>    <span class="hljs-built_in">return</span> 301 https://$host<span class="hljs-variable">$request_uri</span>;<br>&#125;<br><br>server &#123;<br>    listen 443 ssl;<br>    server_name service1.example.com;<br><br>    ssl_certificate /etc/letsencrypt/live/service1.example.com/fullchain.pem;<br>    ssl_certificate_key /etc/letsencrypt/live/service1.example.com/privkey.pem;<br><br>    location / &#123;<br>        proxy_pass http://localhost:3000;<br>        proxy_set_header Host <span class="hljs-variable">$host</span>;<br>        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>    &#125;<br>&#125;<br><br>server &#123;<br>    listen 80;<br>    server_name service2.example.com;<br>    <span class="hljs-built_in">return</span> 301 https://$host<span class="hljs-variable">$request_uri</span>;<br>&#125;<br><br>server &#123;<br>    listen 443 ssl;<br>    server_name service2.example.com;<br><br>    ssl_certificate /etc/letsencrypt/live/service2.example.com/fullchain.pem;<br>    ssl_certificate_key /etc/letsencrypt/live/service2.example.com/privkey.pem;<br><br>    location / &#123;<br>        proxy_pass http://localhost:4000;<br>        proxy_set_header Host <span class="hljs-variable">$host</span>;<br>        proxy_set_header X-Real-IP <span class="hljs-variable">$remote_addr</span>;<br>        proxy_set_header X-Forwarded-For <span class="hljs-variable">$proxy_add_x_forwarded_for</span>;<br>        proxy_set_header X-Forwarded-Proto <span class="hljs-variable">$scheme</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h1 id="自动续费"><a href="#自动续费" class="headerlink" title="自动续费"></a>自动续费</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">Let<span class="hljs-string">&#x27;s Encrypt的证书有效期为90天。Certbot会自动设置一个cron任务来续期证书。你可以手动测试续期</span><br><span class="hljs-string">sudo certbot renew --dry-run</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>nginx</tag>
      
      <tag>ssl</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>安装MySQL</title>
    <link href="/2025/01/09/%E5%AE%89%E8%A3%85MySQL/"/>
    <url>/2025/01/09/%E5%AE%89%E8%A3%85MySQL/</url>
    
    <content type="html"><![CDATA[<h1 id="1、yum安装MySQL"><a href="#1、yum安装MySQL" class="headerlink" title="1、yum安装MySQL"></a>1、yum安装MySQL</h1><p>#关闭防火墙</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">systemctl</span> stop firewalld<br><span class="hljs-attribute">setenforce</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h1 id="清理环境"><a href="#清理环境" class="headerlink" title="清理环境"></a>清理环境</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs shell">yum erase mariadb mariadb-server mariadb-libs mariadb-devel -y<br>userdel -r mysql<br>rm -rf /etc/my*//配置文件<br>rm -rf /var/lib/mysql//初始化生成密码的路径目录<br></code></pre></td></tr></table></figure><h1 id="编辑yum文件"><a href="#编辑yum文件" class="headerlink" title="编辑yum文件"></a>编辑yum文件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@localhost yum.repos.d]# vim mysql.repo<br>[mysql]<br>name=mysql<br>baseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-5.7-community-el7-x86_64/<br>gpgcheck=1<br>enabled=1<br>gpgkey=https://mirrors.ustc.edu.cn/mysql-repo/RPM-GPG-KEY-mysql<br></code></pre></td></tr></table></figure><h1 id="安装软件"><a href="#安装软件" class="headerlink" title="安装软件"></a>安装软件</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">yum repolist enabled | grep mysql</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">yum -y install mysql-community-server</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl start mysqld                        //第一次启动会自动始化数据库</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">systemctl <span class="hljs-built_in">enable</span>   mysqld</span><br><span class="hljs-meta prompt_"># </span><span class="language-bash">grep password /var/log/mysqld.log</span><br></code></pre></td></tr></table></figure><h1 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a><strong>修改密码</strong></h1><p>5.7默认有临时密码，需要修改，两种方式：<br>第一种</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell"><span class="hljs-meta prompt_"># </span><span class="language-bash">mysql -uroot -p<span class="hljs-string">&#x27;uopCBgXBu8,k&#x27;</span></span><br><span class="hljs-meta prompt_">mysql&gt; </span><span class="language-bash">alter user <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span> identified by <span class="hljs-string">&#x27;Qianfeng123!@&#x27;</span>;</span><br></code></pre></td></tr></table></figure><p>第二种</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># mysqladmin -u root -p&#x27;uopCBgXBu8,k&#x27; password &#x27;Qianfeng123!@&#x27;</span><br></code></pre></td></tr></table></figure><p><strong>关闭弱密码限制</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">rpm安装的5.7如下方式修改<br><span class="hljs-comment"># vim /etc/my.cnf</span><br>validate_password=off<br><br>编译安装的5.7如下方式修改<br>[mysqld]<br>basedir=/usr/local/mysql<br>datadir=/usr/local/mysql/data<br><br>[mysqld_safe]<br>validate_password=off<br></code></pre></td></tr></table></figure><h1 id="2、编译安装MySQL"><a href="#2、编译安装MySQL" class="headerlink" title="2、编译安装MySQL"></a>2、编译安装MySQL</h1><p>#关闭防火墙</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">systemctl</span> stop firewalld<br><span class="hljs-attribute">setenforce</span> <span class="hljs-number">0</span><br></code></pre></td></tr></table></figure><h1 id="清理环境-1"><a href="#清理环境-1" class="headerlink" title="清理环境"></a>清理环境</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">yum erase mariadb mariadb-server mariadb-libs mariadb-devel -y<br>userdel -r mysql<br><span class="hljs-built_in">rm</span> -rf /etc/my*<br><span class="hljs-built_in">rm</span> -rf /var/lib/mysql<br></code></pre></td></tr></table></figure><h1 id="创建MySQL用户"><a href="#创建MySQL用户" class="headerlink" title="创建MySQL用户"></a>创建MySQL用户</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">useradd -r mysql -M -s <span class="hljs-regexp">/sbin/</span>nologin<br><span class="hljs-comment"># -M指定不安装家目录</span><br></code></pre></td></tr></table></figure><h1 id="安装编译工具，以及依赖软件"><a href="#安装编译工具，以及依赖软件" class="headerlink" title="安装编译工具，以及依赖软件"></a>安装编译工具，以及依赖软件</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">yum -y <span class="hljs-keyword">install </span>ncurses ncurses-devel openssl-devel <span class="hljs-keyword">bison </span>gcc gcc-c++ make cmake<br></code></pre></td></tr></table></figure><h1 id="创建mysql目录"><a href="#创建mysql目录" class="headerlink" title="创建mysql目录"></a>创建mysql目录</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -p /usr/local/&#123;data,mysql,<span class="hljs-built_in">log</span>&#125;<br></code></pre></td></tr></table></figure><h1 id="官方下载MySQL的boost包"><a href="#官方下载MySQL的boost包" class="headerlink" title="官方下载MySQL的boost包"></a>官方下载MySQL的boost包</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">wget</span> https://mirrors.aliyun.com/mysql/MySQL-<span class="hljs-number">5</span>.<span class="hljs-number">7</span>/mysql-boost-<span class="hljs-number">5</span>.<span class="hljs-number">7</span>.<span class="hljs-number">36</span>.tar.gz?spm=a2c6h.<span class="hljs-number">25603864</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.b21f63aftvppVw<br></code></pre></td></tr></table></figure><h1 id="更改包名"><a href="#更改包名" class="headerlink" title="更改包名"></a>更改包名</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mv</span> mysql-boost-<span class="hljs-number">5</span>.<span class="hljs-number">7</span>.<span class="hljs-number">36</span>.tar.gz?spm=a2c6h.<span class="hljs-number">25603864</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.b21f63aftvppVw mysql-boost-<span class="hljs-number">5</span>.<span class="hljs-number">7</span>.<span class="hljs-number">36</span>.tar.gz<br></code></pre></td></tr></table></figure><h1 id="解压下载的软件包"><a href="#解压下载的软件包" class="headerlink" title="解压下载的软件包"></a>解压下载的软件包</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">tar</span> zxvf mysql-boost-<span class="hljs-number">5</span>.<span class="hljs-number">7</span>.<span class="hljs-number">36</span>.tar.gz -C /usr/local/<br></code></pre></td></tr></table></figure><h1 id="切换目录"><a href="#切换目录" class="headerlink" title="切换目录"></a>切换目录</h1><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cd</span> /usr/local/mysql-<span class="hljs-number">5</span>.<span class="hljs-number">7</span>.<span class="hljs-number">36</span>/<br></code></pre></td></tr></table></figure><h1 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h1><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs routeros">cmake . \<br><span class="hljs-attribute">-DWITH_BOOST</span>=boost/boost_1_59_0/ \<br><span class="hljs-attribute">-DCMAKE_INSTALL_PREFIX</span>=/usr/local/mysql \<br><span class="hljs-attribute">-DSYSCONFDIR</span>=/etc \<br><span class="hljs-attribute">-DMYSQL_DATADIR</span>=/usr/local/mysql/data \<br><span class="hljs-attribute">-DINSTALL_MANDIR</span>=/usr/share/man \<br><span class="hljs-attribute">-DMYSQL_TCP_PORT</span>=3306 \<br><span class="hljs-attribute">-DMYSQL_UNIX_ADDR</span>=/tmp/mysql.sock \<br><span class="hljs-attribute">-DDEFAULT_CHARSET</span>=utf8 \<br><span class="hljs-attribute">-DEXTRA_CHARSETS</span>=all \<br><span class="hljs-attribute">-DDEFAULT_COLLATION</span>=utf8_general_ci \<br><span class="hljs-attribute">-DWITH_READLINE</span>=1 \<br><span class="hljs-attribute">-DWITH_SSL</span>=system \<br><span class="hljs-attribute">-DWITH_EMBEDDED_SERVER</span>=1 \<br><span class="hljs-attribute">-DENABLED_LOCAL_INFILE</span>=1 \<br><span class="hljs-attribute">-DWITH_INNOBASE_STORAGE_ENGINE</span>=1<br></code></pre></td></tr></table></figure><h1 id="编译安装-1"><a href="#编译安装-1" class="headerlink" title="编译安装"></a>编译安装</h1><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">make -<span class="hljs-keyword">j2 </span>&amp;&amp; make -<span class="hljs-keyword">j2 </span><span class="hljs-keyword">install</span><br><span class="hljs-keyword"></span><span class="hljs-comment"># -j2是指定2核</span><br></code></pre></td></tr></table></figure><p>#如果安装出错，想重新安装：不用重新解压，只需要删除安装目录中的缓存文件</p><h1 id="配置文件添加命令路径"><a href="#配置文件添加命令路径" class="headerlink" title="配置文件添加命令路径"></a>配置文件添加命令路径</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> &gt;&gt; /etc/profile &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">mysql=/user/local/mysql/bin/</span><br><span class="hljs-string">EOF</span><br></code></pre></td></tr></table></figure><h1 id="重启profile文件"><a href="#重启profile文件" class="headerlink" title="重启profile文件"></a>重启profile文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">source</span> /etc/profile<br></code></pre></td></tr></table></figure><p>#找到安装目录，拷贝mysql.service脚本文件到&#x2F;etc&#x2F;init.d&#x2F;目录下，添加开机启动</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">cp <span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/mysql/</span>support-files<span class="hljs-regexp">/mysql.service /</span>etc<span class="hljs-regexp">/init.d/my</span>sqld<br>chmod a+x <span class="hljs-regexp">/etc/i</span>nit.d/mysqld<br><span class="hljs-comment"># chkconfig: 2346 63 80</span><br>chkconfig--add mysqld<br>systemctl daemon-reload<br></code></pre></td></tr></table></figure><h1 id="进入安装目录修改权限"><a href="#进入安装目录修改权限" class="headerlink" title="进入安装目录修改权限"></a>进入安装目录修改权限</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chown</span> -R mysql.mysql .<br></code></pre></td></tr></table></figure><h1 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs bash">./bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data<br>```<br><span class="hljs-comment"># 初始化,只需要初始化一次，初始化完成之后，一定要记住提示最后的密码用于登陆或者修改密码</span><br><span class="hljs-comment"># 添加配置文件,删除旧配置文件之后，再添加如下内容</span><br>```<br><span class="hljs-built_in">cat</span> &gt;&gt; /etc/my.cnf &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">[mysqld]</span><br><span class="hljs-string">basedir=/usr/local/mysql       #指定安装目录</span><br><span class="hljs-string">datadir=/usr/local/mysql/data  #指定数据存放目录</span><br><span class="hljs-string">EOF</span><br>```<br><span class="hljs-comment"># 杀死原进程</span><br>```<br>pkill mysqld<br>```<br><span class="hljs-comment"># 重启MySQL服务</span><br>```<br>systemctl start mysqld 前提关闭之前的进程，再用start启动MySQL<br><span class="hljs-comment">#systemctl status mysqld</span><br><span class="hljs-comment">#systemctl stop mysqld</span><br><span class="hljs-comment">#sh mysqld restart</span><br>```<br><span class="hljs-comment"># 启动</span><br>```<br><span class="hljs-built_in">cd</span> /usr/local/mysql<br>./bin/mysqld_safe --user=mysql &amp;<br>```<br><span class="hljs-comment"># 获取密码</span><br>```<br><span class="hljs-comment">#temp_password=$(sudo cat bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data | grep &#x27;temporary localhost&#x27; | awk &#x27;&#123;print $NF&#125;&#x27;)</span><br><span class="hljs-comment">#mysql -uroot -p&quot;$&#123;temp_password&#125;&quot; --connect-expired-password &lt;&lt;EOF</span><br><span class="hljs-comment">#ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &quot;$&#123;Mysql_Pass&#125;&quot;;</span><br><span class="hljs-comment">#FLUSH PRIVILEGES;</span><br><span class="hljs-comment">#EOF</span><br>```<br><span class="hljs-comment"># 登录测试</span><br>```<br><span class="hljs-comment"># /usr/local/mysql/bin/mysql -uroot -p&#x27;ZrSw)Ns_*9iR&#x27;</span><br>```<br><span class="hljs-comment">#如果需要重新初始化...</span><br>```<br><span class="hljs-comment"># killall mysqld</span><br><span class="hljs-comment"># rm -rf /usr/local/mysql/data</span><br><span class="hljs-comment"># bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</span><br>```<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>mysql</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Git使用以及推送代码到Github</title>
    <link href="/2025/01/09/Git%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E6%8E%A8%E9%80%81%E4%BB%A3%E7%A0%81%E5%88%B0Github/"/>
    <url>/2025/01/09/Git%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E6%8E%A8%E9%80%81%E4%BB%A3%E7%A0%81%E5%88%B0Github/</url>
    
    <content type="html"><![CDATA[<h1 id="Git使用以及推送代码到Github"><a href="#Git使用以及推送代码到Github" class="headerlink" title="Git使用以及推送代码到Github"></a>Git使用以及推送代码到Github</h1><p>GIT使用<br>创建Github账户。打开 <a href="https://github.com/">https://github.com</a> 并注册一个新账户。</p><p>安装Git。如果您的系统尚未安装Git，则需要先安装它。可以参考Git官方文档以获取更多详细信息。</p><p>配置Git用户名和电子邮件地址。在终端或命令提示符窗口中，运行以下命令以设置您的Git用户名和电子邮件地址：</p><p>安装git后需要设置github用户名以及邮箱,内容替换成自己的</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.name</span> <span class="hljs-string">&quot;Your Name&quot;</span><br>git config <span class="hljs-attr">--global</span> user<span class="hljs-selector-class">.email</span> <span class="hljs-string">&quot;youremail@example.com&quot;</span><br></code></pre></td></tr></table></figure><p>首先要有本地仓库</p><p>在Github上创建一个新的代码仓库</p><p>从终端命令行中进入本地代码仓库目录，并初始化仓库：</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs csharp">git <span class="hljs-keyword">init</span><br></code></pre></td></tr></table></figure><p>将您的代码添加到本地仓库缓冲区：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">git <span class="hljs-built_in">add</span> .<br></code></pre></td></tr></table></figure><p>为Github分配一个远程仓库：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">git</span> remote <span class="hljs-keyword">add</span> origin https:<span class="hljs-comment">//github.com/username/repo.git</span><br></code></pre></td></tr></table></figure><p>查看本地分支</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git branch</span><br></code></pre></td></tr></table></figure><p>该命令会列出当前本地仓库中存在的所有分支，并用星号标识当前所在的分支。例如，以下是一个示例输出：</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs arcade">* main<br>  <span class="hljs-built_in">feature</span><span class="hljs-number">-1</span><br>  <span class="hljs-built_in">feature</span><span class="hljs-number">-2</span><br></code></pre></td></tr></table></figure><p>查看远程分支</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">git branch -<span class="hljs-attribute">r</span><br></code></pre></td></tr></table></figure><p>创建分支</p><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">git checkout -b <span class="hljs-keyword">new</span>-branch<br></code></pre></td></tr></table></figure><p>将本地仓库推送到 GitHub 上，需要使用 git push 命令，并指定远程仓库的名称和分支名称。具体命令如下：</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">git push origin <span class="hljs-literal">master</span>:<span class="hljs-keyword">master</span>      <span class="hljs-title">#例如，将本地的 master</span> 分支推送到 GitHub 上的 origin 仓库的 <span class="hljs-keyword">master</span> <span class="hljs-title">分支</span><br><span class="hljs-title">git</span> push <span class="hljs-tag">&lt;远程仓库名称&gt;</span> <span class="hljs-tag">&lt;本地分支名称&gt;</span>:<span class="hljs-tag">&lt;远程分支名称&gt;</span><br></code></pre></td></tr></table></figure><p>设置仓库名称</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">git remote add <span class="hljs-tag">&lt;<span class="hljs-name">远程仓库名称</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">远程仓库</span> <span class="hljs-attr">URL</span>&gt;</span><br></code></pre></td></tr></table></figure><p>例如，如果你想要将一个 GitHub 仓库添加到本地仓库，并将其命名为 myrepo，可以使用以下命令：</p><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">git</span> remote <span class="hljs-keyword">add</span> myrepo https:<span class="hljs-comment">//github.com/username/myrepo.git</span><br></code></pre></td></tr></table></figure><p>添加完成后，你就可以使用 git push 命令将本地分支推送到该远程仓库，命令如下：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">git push myrepo <span class="hljs-tag">&lt;<span class="hljs-name">本地分支名称</span>&gt;</span>:<span class="hljs-tag">&lt;<span class="hljs-name">远程分支名称</span>&gt;</span><br></code></pre></td></tr></table></figure><p>删除分支</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">git branch -d <span class="hljs-tag">&lt;<span class="hljs-name">branch-name</span>&gt;</span><br></code></pre></td></tr></table></figure><p>其中，branch-name是要删除的分支名称。需要注意的是，如果该分支包含未合并的更改，则删除分支时会出现错误。这时需要使用“-D”选项强制删除分支。</p><p>删除远程分支</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">git <span class="hljs-built_in">push</span> <span class="hljs-built_in">origin</span> --<span class="hljs-built_in">delete</span> test<br></code></pre></td></tr></table></figure><p>切换分支</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">git checkout <span class="hljs-tag">&lt;<span class="hljs-name">branch-name</span>&gt;</span> #其中，“<span class="hljs-tag">&lt;<span class="hljs-name">branch-name</span>&gt;</span>”是要切换到的分支名称。<br></code></pre></td></tr></table></figure><p>创建新分支并切换到该分支</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade">git checkout -b <span class="hljs-keyword">new</span>-<span class="hljs-built_in">feature</span><br></code></pre></td></tr></table></figure><p>分支合并<br>首先，需要切换到要合并的目标分支上，例如：</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs aspectj">git checkout <span class="hljs-keyword">target</span>-branch<br></code></pre></td></tr></table></figure><p>然后，使用 git merge 命令将源分支合并到目标分支上，例如：</p><figure class="highlight cos"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cos">git <span class="hljs-keyword">merge</span> source-branch<br></code></pre></td></tr></table></figure><p>查看git状态</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git status</span><br></code></pre></td></tr></table></figure><p>比较文件的不同，即暂存区和工作区的差异。</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git diff</span><br></code></pre></td></tr></table></figure><p>连接远程仓库并且命名<br>您可以使用以下命令在 Git 中为仓库设置名称：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml">git remote add <span class="hljs-tag">&lt;<span class="hljs-name">remote</span> <span class="hljs-attr">name</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">remote</span> <span class="hljs-attr">repository</span> <span class="hljs-attr">URL</span>&gt;</span><br></code></pre></td></tr></table></figure><p>请将 <remote name> 替换为您想要设置的名称，<remote repository URL> 替换为您的远程仓库的 URL。例如，如果您想将远程仓库的名称设置为 origin，则可以使用以下命令：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">git remote <span class="hljs-built_in">add</span> origin &lt;remote repository <span class="hljs-built_in">URL</span>&gt;<br></code></pre></td></tr></table></figure><p>**请注意，这只是将远程仓库的名称设置为 origin，您可以将其替换为您想要的任何名称</p><p>重新命名仓库<br>您可以使用以下命令在 Git 中为仓库重命名</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">git remote <span class="hljs-keyword">rename</span> &lt;<span class="hljs-built_in">old</span> <span class="hljs-type">name</span>&gt; &lt;<span class="hljs-built_in">new</span> <span class="hljs-type">name</span>&gt;<br></code></pre></td></tr></table></figure><p>请将 <old name> 替换为您想要重命名的旧名称，<new name> 替换为您想要设置的新名称。例如，如果您想将远程仓库的名称从 origin 改为 new-origin，则可以使用以下命令：</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">git remote <span class="hljs-built_in">rename</span> <span class="hljs-built_in">origin</span> <span class="hljs-built_in">new</span>-<span class="hljs-built_in">origin</span><br></code></pre></td></tr></table></figure><p>请注意，这只是将远程仓库的名称从 origin 改为 new-origin，您可以将其替换为您想要的任何名称。</p><p>推送到GITHUB<br>提交你的更改</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">git</span> commit -m <span class="hljs-string">&quot;your commit message&quot;</span><br></code></pre></td></tr></table></figure><p>拉取远程仓库中最新的更改：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">git pull origin <span class="hljs-selector-tag">main</span><br></code></pre></td></tr></table></figure><p>推送代码更改到Github仓库：</p><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs avrasm">git <span class="hljs-keyword">push</span> origin main    <span class="hljs-meta">#main是分支，更改到你需要提交的分支也行</span><br></code></pre></td></tr></table></figure><p>提交到hero并且对更改进行描述</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">git</span> commit -m <span class="hljs-string">&quot;描述&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>git</tag>
      
      <tag>github</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>用户登入工具箱，注册</title>
    <link href="/2025/01/09/%E7%94%A8%E6%88%B7%E7%99%BB%E5%85%A5%E5%B7%A5%E5%85%B7%E7%AE%B1%EF%BC%8C%E6%B3%A8%E5%86%8C/"/>
    <url>/2025/01/09/%E7%94%A8%E6%88%B7%E7%99%BB%E5%85%A5%E5%B7%A5%E5%85%B7%E7%AE%B1%EF%BC%8C%E6%B3%A8%E5%86%8C/</url>
    
    <content type="html"><![CDATA[<h1 id="本脚本用于用户登入工具箱，注册"><a href="#本脚本用于用户登入工具箱，注册" class="headerlink" title="本脚本用于用户登入工具箱，注册"></a>本脚本用于用户登入工具箱，注册</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># !/bin/bash</span><br><br><span class="hljs-comment">#菜单函数</span><br>caidan()&#123;<br>cat &lt;&lt; EOF<br>===========菜单===========<br>||  <span class="hljs-number">1</span>.登入||<br>||  <span class="hljs-number">2</span>.注册||<br>||  <span class="hljs-number">3</span>.退出||<br>==========================<br>EOF<br><span class="hljs-comment"># 定义选项</span><br>read -p <span class="hljs-string">&quot;请你输出你要的选项：&quot;</span> num<br>case <span class="hljs-variable">$num</span> <span class="hljs-keyword">in</span><br>     <span class="hljs-number">1</span>)dengru;;<br>     <span class="hljs-number">2</span>)zhuce;;<br>     <span class="hljs-number">3</span>)tuichu;;<br>esac<br>&#125;<br><span class="hljs-comment"># 登入工具箱函数</span><br>dengru()&#123;<br>read -p <span class="hljs-string">&quot;请输入你的用户名：&quot;</span> name<br>id <span class="hljs-variable">$name</span> &amp;&gt; <span class="hljs-regexp">/dev/</span>null<br><span class="hljs-keyword">if</span> [ $? -eq <span class="hljs-number">0</span> ];then<br>read -p <span class="hljs-string">&quot;请输入你的密码 ：&quot;</span> pass<br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;#pass&#125;</span> -ge <span class="hljs-number">8</span>  &amp;&amp; <span class="hljs-variable">$pass</span> =~ [a-z] &amp;&amp; <span class="hljs-variable">$pass</span> =~ [A-Z] &amp;&amp; <span class="hljs-variable">$pass</span> =~ [<span class="hljs-number">0</span>-<span class="hljs-number">9</span>] &amp;&amp; <span class="hljs-variable">$pass</span> =~ [^<span class="hljs-number">0</span>-Z] ]];then<br>    <span class="hljs-keyword">while</span> :<br><span class="hljs-keyword">do</span><br>gongju<br>    read -p <span class="hljs-string">&quot;请你输入你需要的工具：&quot;</span> gg<br>    case <span class="hljs-variable">$gg</span> <span class="hljs-keyword">in</span><br>    <span class="hljs-number">1</span>)<br>echo <span class="hljs-string">&quot;=====磁盘信息=====&quot;</span><br>df -hT<br>echo <span class="hljs-string">&quot;=====磁盘信息=====&quot;</span><br>read -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];then<br>clear<br><span class="hljs-keyword">else</span><br><span class="hljs-keyword">exit</span> <span class="hljs-number">88</span><br>fi<br>;;<br><span class="hljs-number">2</span>)<br>echo <span class="hljs-string">&quot;=====内存信息=====&quot;</span><br>free -m<br>echo <span class="hljs-string">&quot;=====内存信息=====&quot;</span><br>               read -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];then<br>                        clear<br>                <span class="hljs-keyword">else</span><br>                        <span class="hljs-keyword">exit</span> <span class="hljs-number">88</span><br>                fi<br>;;<br><span class="hljs-number">3</span>)<br>echo <span class="hljs-string">&quot;=====CPU信息=====&quot;</span><br>uptime<br>echo <span class="hljs-string">&quot;=====CPU信息=====&quot;</span><br>               read -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];then<br>                        clear<br>                <span class="hljs-keyword">else</span><br>                        <span class="hljs-keyword">exit</span> <span class="hljs-number">88</span><br>                fi<br>;;<br><span class="hljs-number">4</span>)<br>echo <span class="hljs-string">&quot;=====网络信息=====&quot;</span><br>read -p <span class="hljs-string">&quot;请输入你要用的网络接口号&quot;</span> hao<br>netstat -anpt | grep <span class="hljs-variable">$hao</span><br>echo <span class="hljs-string">&quot;=====网络信息=====&quot;</span><br>               read -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];then<br>                        clear<br>                <span class="hljs-keyword">else</span><br>                        <span class="hljs-keyword">exit</span> <span class="hljs-number">88</span><br>                fi<br>;;<br><span class="hljs-number">5</span>)<br>echo <span class="hljs-string">&quot;=====进程信息=====&quot;</span><br>read -p <span class="hljs-string">&quot;请输入你要查询的进程名&quot;</span> pss<br>ps aux | grep <span class="hljs-variable">$pss</span><br>echo <span class="hljs-string">&quot;=====进程信息=====&quot;</span><br>               read -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];then<br>                        clear<br>                <span class="hljs-keyword">else</span><br>                        <span class="hljs-keyword">exit</span> <span class="hljs-number">88</span><br>                fi<br>;;<br><span class="hljs-number">6</span>)<br>echo <span class="hljs-string">&quot;=======退出=======&quot;</span><br><span class="hljs-keyword">exit</span> <span class="hljs-number">88</span><br>echo <span class="hljs-string">&quot;=======退出=======&quot;</span><br>;;<br>    esac<br>done<br><span class="hljs-keyword">else</span><br><br>    echo <span class="hljs-string">&quot;密码不符合规定&quot;</span><br>    echo <span class="hljs-string">&quot;密码要求大于等于8位，小写字母，大写字母，特殊字符&quot;</span><br>fi<br><span class="hljs-keyword">else</span><br>echo <span class="hljs-string">&quot;用户有误&quot;</span><br>fi<br>&#125;<br><span class="hljs-comment"># 定义工具箱菜单</span><br>gongju ()&#123;<br>cat &lt;&lt; EOF<br>===========系统工具箱===========<br>||       <span class="hljs-number">1</span>.查看磁盘信息        ||<br>||       <span class="hljs-number">2</span>.查看内存信息        ||<br>||       <span class="hljs-number">3</span>.查看CPU信息         ||<br>||       <span class="hljs-number">4</span>.查看网络信息        ||<br>||       <span class="hljs-number">5</span>.查看进程信息        ||<br>||       <span class="hljs-number">6</span>.退出                ||<br>================================<br>EOF<br>&#125;<br><span class="hljs-comment"># 注册函数</span><br>zhuce()&#123;<br>read -p <span class="hljs-string">&quot;请输入你需要创建的用户名：&quot;</span> name<br>id <span class="hljs-variable">$name</span> &amp;&gt; <span class="hljs-regexp">/dev/</span>null<br><span class="hljs-keyword">if</span> [ $? -eq <span class="hljs-number">1</span> ];then<br>read -p <span class="hljs-string">&quot;请设置$name的密码：&quot;</span> password<br><span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$&#123;#password&#125;</span> -ge <span class="hljs-number">8</span>  &amp;&amp; <span class="hljs-variable">$password</span> =~ [a-z] &amp;&amp; <span class="hljs-variable">$password</span> =~ [A-Z] &amp;&amp; <span class="hljs-variable">$password</span> =~ [<span class="hljs-number">0</span>-<span class="hljs-number">9</span>] &amp;&amp; <span class="hljs-variable">$password</span> =~ [^<span class="hljs-number">0</span>-Z] ]];then<br>echo <span class="hljs-string">&quot;$password&quot;</span> | passwd --stdin <span class="hljs-variable">$name</span> &amp;&gt; <span class="hljs-regexp">/dev/</span>null<br>echo <span class="hljs-string">&quot;$name用户密码设置成功，密码为$password&quot;</span><br><span class="hljs-keyword">else</span><br>echo <span class="hljs-string">&quot;你设置的密码有误，请按规定设置&quot;</span><br>caidan<br>fi<br><span class="hljs-keyword">else</span><br>echo <span class="hljs-string">&quot;$name用户创建有误&quot;</span><br>caidan<br>fi<br>&#125;<br><br>tuichu()&#123;<br>    echo <span class="hljs-string">&quot;再见&quot;</span><br>    <span class="hljs-keyword">break</span><br>&#125;<br><br>caidan<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>toolbox</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>查看面板选项工具箱-函数定义</title>
    <link href="/2025/01/09/%E6%9F%A5%E7%9C%8B%E9%9D%A2%E6%9D%BF%E9%80%89%E9%A1%B9%E5%B7%A5%E5%85%B7%E7%AE%B1-%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89/"/>
    <url>/2025/01/09/%E6%9F%A5%E7%9C%8B%E9%9D%A2%E6%9D%BF%E9%80%89%E9%A1%B9%E5%B7%A5%E5%85%B7%E7%AE%B1-%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89/</url>
    
    <content type="html"><![CDATA[<h1 id="打印工具箱"><a href="#打印工具箱" class="headerlink" title="打印工具箱"></a>打印工具箱</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># !/bin/bash</span><br><br><span class="hljs-comment">#定义菜单函数</span><br><span class="hljs-function"><span class="hljs-title">caidan</span></span> ()&#123;<br><span class="hljs-built_in">cat</span> &lt;&lt; <span class="hljs-string">EOF</span><br><span class="hljs-string">-----------系统工具箱----------</span><br><span class="hljs-string">|       1.查看磁盘信息        |</span><br><span class="hljs-string">|       2.查看内存信息        |</span><br><span class="hljs-string">|       3.查看CPU信息         |</span><br><span class="hljs-string">|       4.查看网络信息        |</span><br><span class="hljs-string">|       5.查看进程信息        |</span><br><span class="hljs-string">|       6.退出                |</span><br><span class="hljs-string">-------------------------------</span><br><span class="hljs-string">EOF</span><br>&#125;<br><br><span class="hljs-comment"># while循环选项操作</span><br><span class="hljs-keyword">while</span> :<br><span class="hljs-keyword">do</span><br>caidan<br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输出你的选择[1..6]&quot;</span> num<br><span class="hljs-comment"># case语句循环选项</span><br><span class="hljs-keyword">case</span> <span class="hljs-variable">$num</span> <span class="hljs-keyword">in</span><br>1)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====磁盘信息=====&quot;</span><br><span class="hljs-built_in">df</span> -hT<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====磁盘信息=====&quot;</span><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br><span class="hljs-comment">#if语句判断是否要继续面板选项</span><br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];<span class="hljs-keyword">then</span><br>clear<br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">exit</span> 88<br><span class="hljs-keyword">fi</span><br>;;<br>2)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====内存信息=====&quot;</span><br>free -m<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====内存信息=====&quot;</span><br>               <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];<span class="hljs-keyword">then</span><br>                        clear<br>                <span class="hljs-keyword">else</span><br>                        <span class="hljs-built_in">exit</span> 88<br>                <span class="hljs-keyword">fi</span><br>;;<br>3)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====CPU信息=====&quot;</span><br><span class="hljs-built_in">uptime</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====CPU信息=====&quot;</span><br>               <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];<span class="hljs-keyword">then</span><br>                        clear<br>                <span class="hljs-keyword">else</span><br>                        <span class="hljs-built_in">exit</span> 88<br>                <span class="hljs-keyword">fi</span><br>;;<br>4)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====网络信息=====&quot;</span><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入你要用的网络接口号&quot;</span> hao<br>netstat -anpt | grep <span class="hljs-variable">$hao</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====网络信息=====&quot;</span><br>               <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];<span class="hljs-keyword">then</span><br>                        clear<br>                <span class="hljs-keyword">else</span><br>                        <span class="hljs-built_in">exit</span> 88<br>                <span class="hljs-keyword">fi</span><br>;;<br>5)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====进程信息=====&quot;</span><br><span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;请输入你要查询的进程名&quot;</span> pss<br>ps aux | grep <span class="hljs-variable">$pss</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=====进程信息=====&quot;</span><br>               <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];<span class="hljs-keyword">then</span><br>                        clear<br>                <span class="hljs-keyword">else</span><br>                        <span class="hljs-built_in">exit</span> 88<br>                <span class="hljs-keyword">fi</span><br>;;<br>6)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=======退出=======&quot;</span><br><span class="hljs-built_in">exit</span> 88<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;=======退出=======&quot;</span><br>;;<br><br>*)<br>caidan<br>               <span class="hljs-built_in">read</span> -p <span class="hljs-string">&quot;继续y，退出n&quot;</span> yn<br>                <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$yn</span> = y ];<span class="hljs-keyword">then</span><br>                        clear<br>                <span class="hljs-keyword">else</span><br>                        <span class="hljs-built_in">break</span> 88<br>                <span class="hljs-keyword">fi</span><br>;;<br><span class="hljs-keyword">esac</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>Linux</tag>
      
      <tag>toolbox</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>linux网卡配置</title>
    <link href="/2025/01/08/linux%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE/"/>
    <url>/2025/01/08/linux%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE/</url>
    
    <content type="html"><![CDATA[<p><strong>永久设置网卡</strong></p><blockquote><p><code>另外也可以在终端上输入nmtui，进入网卡设置界面</code></p></blockquote><p><strong>1、Centos 7 配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs shell">Centos 7<br><span class="hljs-meta prompt_"># </span><span class="language-bash">vim/etc/sysconfig/network-scripts/ifcfg-ens33 //网卡配置文件的路径</span><br>TYPE=Ethernet//网卡类型<br>BOOTPROTO=dhcp //网卡模式<br>     --&gt;  dhcp //自动获取<br>     --&gt;  static //手动获取<br>     --&gt;  none //手动获取<br>NAME=ens33 //网卡名称（可以修改的）<br>DEVICE=ens33 //设备名称<br>ONBOOT=yes //网卡开关<br>IPADDR=192.168.10.104//IP地址<br>PREFIX=24//子网掩码<br>NETMASK=255.255.255.0 //子网掩码<br>GATEWAY=192.168.10.2 //网关<br>DNS1=192.168.10.2 //DNS<br></code></pre></td></tr></table></figure><p><strong>重启</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">systemctl restart network //重启网卡生效配置<br></code></pre></td></tr></table></figure><p><strong>2、Centos 9 配置</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">Centos9<br><span class="hljs-meta prompt_"># </span><span class="language-bash">vim /etc/NetworkManager/system-connections/ens33.nmconnection  //修改如下选项即可</span><br>address=192.168.10.120/24,192.168.26.2  //ip地址，子网掩码，网关<br>dns=192.168.10.2       //DNS<br>method=manual <br><span class="hljs-meta prompt_">   --&gt; </span><span class="language-bash">manual          //手动</span><br><span class="hljs-meta prompt_">   --&gt; </span><span class="language-bash">auto            //自动</span><br></code></pre></td></tr></table></figure><p><strong>重启</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs shell">nmcli c reload      //重启网络服务 <br>nmcli c down ens33  //开启网络 <br>nmcli c up ens33    //关闭网络<br></code></pre></td></tr></table></figure><p><strong>3、当network和networkmanager 网卡冲突</strong></p><figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs gauss">systemctl <span class="hljs-keyword">stop</span> NetworkManager <br><br>systemctl disabled NetworkManager   <span class="hljs-comment">//将NetworkManger停止</span><br><br>ifup ens33          <span class="hljs-comment">//输入此命令即可查看ens33网卡</span><br><br>systemctl restart network          <span class="hljs-comment">//重启网卡服务</span><br><br><span class="hljs-meta"># 此时应该就可以看到ens33的IP地址了</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>linux</tag>
      
      <tag>network</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQL全量备份/增量备份脚本</title>
    <link href="/2025/01/07/MySQL%E5%85%A8%E9%87%8F%E5%A4%87%E4%BB%BD-%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD%E8%84%9A%E6%9C%AC/"/>
    <url>/2025/01/07/MySQL%E5%85%A8%E9%87%8F%E5%A4%87%E4%BB%BD-%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD%E8%84%9A%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<p>#!&#x2F;bin&#x2F;bash</p><h1 id="mysql物理备份脚本"><a href="#mysql物理备份脚本" class="headerlink" title="mysql物理备份脚本"></a>mysql物理备份脚本</h1><h1 id="每周日进行全量备份，周一到周六进行增量备份，7天为一个周期"><a href="#每周日进行全量备份，周一到周六进行增量备份，7天为一个周期" class="headerlink" title="每周日进行全量备份，周一到周六进行增量备份，7天为一个周期"></a>每周日进行全量备份，周一到周六进行增量备份，7天为一个周期</h1><h1 id="备份路径、日志路径"><a href="#备份路径、日志路径" class="headerlink" title="备份路径、日志路径"></a>备份路径、日志路径</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">backup_dir</span>=<span class="hljs-string">&quot;/backup&quot;</span><br><span class="hljs-attr">log_dir</span>=<span class="hljs-string">&quot;/backup/log&quot;</span><br><span class="hljs-attr">full_backup_dir</span>=<span class="hljs-string">&quot;/backup/full&quot;</span><br><span class="hljs-attr">inc_backup_dir</span>=<span class="hljs-string">&quot;/backup/inc&quot;</span><br><br><span class="hljs-attr">log_date</span>=$(date <span class="hljs-string">&quot;+%F-%T&quot;</span>)<br></code></pre></td></tr></table></figure><h1 id="数据库用户、密码"><a href="#数据库用户、密码" class="headerlink" title="数据库用户、密码"></a>数据库用户、密码</h1><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">MY_USER</span>=root<br><span class="hljs-attr">MY_PASS</span>=P@ssword1<br></code></pre></td></tr></table></figure><h1 id="判断日志、备份路径是否存在"><a href="#判断日志、备份路径是否存在" class="headerlink" title="判断日志、备份路径是否存在"></a>判断日志、备份路径是否存在</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">[ -d <span class="hljs-variable">$backup_dir</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$backup_dir</span><br>[ -d <span class="hljs-variable">$log_dir</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$log_dir</span><br>[ -d <span class="hljs-variable">$full_backup_dir</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$full_backup_dir</span><br>[ -d <span class="hljs-variable">$inc_backup_dir</span> ] || <span class="hljs-built_in">mkdir</span> <span class="hljs-variable">$inc_backup_dir</span><br></code></pre></td></tr></table></figure><h1 id="全量备份函数"><a href="#全量备份函数" class="headerlink" title="全量备份函数"></a>全量备份函数</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">full_backup</span></span>()&#123;<br><span class="hljs-comment"># 全量备份命令 </span><br>innobackupex --user=<span class="hljs-variable">$MY_USER</span> --password=<span class="hljs-variable">$MY_PASS</span> <span class="hljs-variable">$full_backup_dir</span><br><span class="hljs-keyword">if</span> [ $? -eq 0 ];<span class="hljs-keyword">then</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> full backup!!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/back.log<br><span class="hljs-keyword">else</span><br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> full failed!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/err.log<br><span class="hljs-keyword">fi</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="获取上周日的时间-以-Y-m-d格式显示"><a href="#获取上周日的时间-以-Y-m-d格式显示" class="headerlink" title="获取上周日的时间,以%Y-%m-%d格式显示"></a>获取上周日的时间,以%Y-%m-%d格式显示</h1><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel">sunday=$(<span class="hljs-keyword">date</span> -d <span class="hljs-string">&quot;last sunday&quot;</span> +%F)<br></code></pre></td></tr></table></figure><h1 id="获取前一天的时间-以-Y-m-d格式显示"><a href="#获取前一天的时间-以-Y-m-d格式显示" class="headerlink" title="获取前一天的时间,以%Y-%m-%d格式显示"></a>获取前一天的时间,以%Y-%m-%d格式显示</h1><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel">yesterday=$(<span class="hljs-keyword">date</span> -d <span class="hljs-string">&quot;yesterday&quot;</span> +%F)<br></code></pre></td></tr></table></figure><h1 id="增量备份函数"><a href="#增量备份函数" class="headerlink" title="增量备份函数"></a>增量备份函数</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-function"><span class="hljs-title">inc_backup</span></span>()&#123;<br><span class="hljs-comment"># 判断当前时间是否为周一(周一需要去找全量备份，周二到周六找前一天的备份)</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$week_date</span> -eq 1 ];<span class="hljs-keyword">then</span><br><span class="hljs-comment"># 查找全量备份的文件路径</span><br><span class="hljs-built_in">local</span> full_backup_dir=$(find <span class="hljs-variable">$backup_dir</span> -name <span class="hljs-variable">$&#123;sunday&#125;</span>*)<br>innobackupex --user=<span class="hljs-variable">$MY_USER</span> --password=<span class="hljs-variable">$MY_PASS</span> --incremental <span class="hljs-variable">$&#123;inc_backup_dir&#125;</span> --incremental-basedir=<span class="hljs-variable">$&#123;full_backup_dir&#125;</span><br><span class="hljs-comment"># 判断命令是否执行成功,写入日志文件</span><br>    <span class="hljs-keyword">if</span> [ $? -eq 0 ];<span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> inc backup!!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/back.log<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> inc failed!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/err.log<br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">else</span><br><span class="hljs-comment"># 查找前一天的文件路径</span><br>        <span class="hljs-built_in">local</span> yesterday_backup_dir=$(find <span class="hljs-variable">$backup_dir</span> -name <span class="hljs-variable">$&#123;yesterday&#125;</span>*)<br>        innobackupex --user=<span class="hljs-variable">$MY_USER</span> --password=<span class="hljs-variable">$MY_PASS</span> --incremental <span class="hljs-variable">$&#123;inc_backup_dir&#125;</span> --incremental-basedir=<span class="hljs-variable">$&#123;yesterday_backup_dir&#125;</span><br><span class="hljs-comment"># 判断命令是否执行成功,写入日志文件</span><br>    <span class="hljs-keyword">if</span> [ $? -eq 0 ];<span class="hljs-keyword">then</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> inc backup!!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/back.log<br>    <span class="hljs-keyword">else</span><br>        <span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$&#123;log_date&#125;</span> inc failed!!&quot;</span> &gt;&gt; <span class="hljs-variable">$log_dir</span>/err.log<br>    <span class="hljs-keyword">fi</span><br><span class="hljs-keyword">fi</span><br>&#125;<br></code></pre></td></tr></table></figure><h1 id="查看当前是周几"><a href="#查看当前是周几" class="headerlink" title="查看当前是周几"></a>查看当前是周几</h1><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel">week_date=$(<span class="hljs-keyword">date</span> +%u)<br></code></pre></td></tr></table></figure><h1 id="判断当前是周几，周日则执行全量备份，周一到周六执行增量备份"><a href="#判断当前是周几，周日则执行全量备份，周一到周六执行增量备份" class="headerlink" title="判断当前是周几，周日则执行全量备份，周一到周六执行增量备份"></a>判断当前是周几，周日则执行全量备份，周一到周六执行增量备份</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-keyword">if</span> [ <span class="hljs-variable">$week_date</span> -eq 7 ];<span class="hljs-keyword">then</span><br>full_backup<br><span class="hljs-keyword">else</span><br>inc_backup<br><span class="hljs-keyword">fi</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    
    <tags>
      
      <tag>study，MySQL</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker部署halo博客</title>
    <link href="/2025/01/06/docker%E9%83%A8%E7%BD%B2halo%E5%8D%9A%E5%AE%A2/"/>
    <url>/2025/01/06/docker%E9%83%A8%E7%BD%B2halo%E5%8D%9A%E5%AE%A2/</url>
    
    <content type="html"><![CDATA[<h1 id="docker博客创建"><a href="#docker博客创建" class="headerlink" title="docker博客创建"></a>docker博客创建</h1><h2 id="编辑配置文件"><a href="#编辑配置文件" class="headerlink" title="编辑配置文件"></a>编辑配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs bash">vim /halo/docker-compose.yaml<br>version: <span class="hljs-string">&quot;3&quot;</span><br><br>services:<br>  halo<br>    image: halohub/halo:2.11<br>    container_name: halo<br>    restart: on-failure:3<br>    depends_on:<br>      halodb:<br>        condition: service_healthy<br>    networks:<br>      halo_network:<br>    volumes:<br><br>   - ./halo2:/root/.halo2<br>     rts:<br>        - <span class="hljs-string">&quot;8090:8090&quot;</span><br>          althcheck:<br>                <span class="hljs-built_in">test</span>: [<span class="hljs-string">&quot;CMD&quot;</span>, <span class="hljs-string">&quot;curl&quot;</span>, <span class="hljs-string">&quot;-f&quot;</span>, <span class="hljs-string">&quot;http://localhost:8090/actuator/health/readiness&quot;</span>]<br>                interval: 30s<br>                <span class="hljs-built_in">timeout</span>: 5s<br>                retries: 5<br>                start_period: 30s          <br>              <span class="hljs-built_in">command</span>:<br>             - --spring.r2dbc.url=r2dbc:pool:postgresql://halodb/halo<br>               --spring.r2dbc.username=halo<br><br>      <span class="hljs-comment"># PostgreSQL 的密码，请保证与下方 POSTGRES_PASSWORD 的变量值一致。</span><br><br>   - --spring.r2dbc.password=openpostgresql<br>     --spring.sql.init.platform=postgresql<br><br>      <span class="hljs-comment"># 外部访问地址，请根据实际需要修改</span><br><br>   - --halo.external-url=http://localhost:8090/<br>     halodb:<br>         image: postgres:15.4<br>         container_name: halodb<br>         restart: on-failure:3<br>         networks:<br>           halo_network:<br>         volumes:<br>        - ./db:/var/lib/postgresql/data<br>          rts:<br>             - <span class="hljs-string">&quot;5432:5432&quot;</span><br>               althcheck:<br>                     <span class="hljs-built_in">test</span>: [ <span class="hljs-string">&quot;CMD&quot;</span>, <span class="hljs-string">&quot;pg_isready&quot;</span> ]<br>                     interval: 10s<br>                     <span class="hljs-built_in">timeout</span>: 5s<br>                     retries: 5<br>                   environment:<br>                  - POSTGRES_PASSWORD=openpostgresql<br>                    POSTGRES_USER=halo<br>                       - POSTGRES_DB=halo<br>                         PGUSER=halo<br><br>networks:<br>  halo_network:<br></code></pre></td></tr></table></figure><h2 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> -pv /halo<br></code></pre></td></tr></table></figure><h2 id="重新指定文件目录"><a href="#重新指定文件目录" class="headerlink" title="重新指定文件目录"></a>重新指定文件目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mv</span> docker-compose.yaml /halo<br><span class="hljs-built_in">cd</span> /halo<br></code></pre></td></tr></table></figure><h2 id="运行以下命令卸载所有冲突的包"><a href="#运行以下命令卸载所有冲突的包" class="headerlink" title="运行以下命令卸载所有冲突的包"></a>运行以下命令卸载所有冲突的包</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-keyword">for</span> pkg <span class="hljs-keyword">in</span> docker.io docker-doc docker-compose podman-docker containerd runc; <span class="hljs-keyword">do</span> sudo apt-<span class="hljs-built_in">get</span> <span class="hljs-built_in">remove</span> <span class="hljs-variable">$pkg</span>; done<br></code></pre></td></tr></table></figure><h2 id="设置-Docker-的apt存储库"><a href="#设置-Docker-的apt存储库" class="headerlink" title="设置 Docker 的apt存储库"></a>设置 Docker 的apt存储库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># Add Docker&#x27;s official GPG key:</span><br><span class="hljs-built_in">sudo</span> apt-get update<br><span class="hljs-built_in">sudo</span> apt-get install ca-certificates curl gnupg<br><span class="hljs-built_in">sudo</span> install -m 0755 -d /etc/apt/keyrings<br>curl -fsSL https://download.docker.com/linux/debian/gpg | <span class="hljs-built_in">sudo</span> gpg --dearmor -o /etc/apt/keyrings/docker.gpg<br><span class="hljs-built_in">sudo</span> <span class="hljs-built_in">chmod</span> a+r /etc/apt/keyrings/docker.gpg<br><br><span class="hljs-comment"># Add the repository to Apt sources:</span><br><span class="hljs-built_in">echo</span> \<br>  <span class="hljs-string">&quot;deb [arch=<span class="hljs-subst">$(dpkg --print-architecture)</span> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \</span><br><span class="hljs-string">  <span class="hljs-subst">$(. /etc/os-release &amp;&amp; echo <span class="hljs-string">&quot;<span class="hljs-variable">$VERSION_CODENAME</span>&quot;</span>)</span> stable&quot;</span> | \<br>  <span class="hljs-built_in">sudo</span> <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null<br><span class="hljs-built_in">sudo</span> apt-get update<br></code></pre></td></tr></table></figure><h2 id="运行安装脚本"><a href="#运行安装脚本" class="headerlink" title="运行安装脚本"></a>运行安装脚本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">bash &lt;(curl -sSL https://linuxmirrors.cn/docker.sh)    //脚本运行<br>sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin    //新版docker版本脚本<br></code></pre></td></tr></table></figure><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">apt-get install -y docker-compose<br></code></pre></td></tr></table></figure><h2 id="验证版本号"><a href="#验证版本号" class="headerlink" title="验证版本号"></a>验证版本号</h2><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ada">docker-compose <span class="hljs-comment">--version</span><br>docker <span class="hljs-comment">--version</span><br></code></pre></td></tr></table></figure><h2 id="安装运行"><a href="#安装运行" class="headerlink" title="安装运行"></a>安装运行</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shel">docker-compose up -d<br>systemctl status docker<br></code></pre></td></tr></table></figure><h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p><code>输入IP地址+端口8090</code>进入注册页面</p>]]></content>
    
    
    
    <tags>
      
      <tag>study，blog</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>清风工具箱</title>
    <link href="/2025/01/06/%E6%B8%85%E9%A3%8E%E5%B7%A5%E5%85%B7%E7%AE%B1/"/>
    <url>/2025/01/06/%E6%B8%85%E9%A3%8E%E5%B7%A5%E5%85%B7%E7%AE%B1/</url>
    
    <content type="html"><![CDATA[<h2 id="工具箱一键脚本"><a href="#工具箱一键脚本" class="headerlink" title="工具箱一键脚本"></a>工具箱一键脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/toolbox.sh)<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -sSL https://gitee.com/xbd666/kunlun/raw/master/kunlun_tool.sh)<br></code></pre></td></tr></table></figure><h2 id="脚本一键安装MySQL-mariadb-并更改密码"><a href="#脚本一键安装MySQL-mariadb-并更改密码" class="headerlink" title="脚本一键安装MySQL&#x2F;mariadb,并更改密码"></a>脚本一键安装MySQL&#x2F;mariadb,并更改密码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/MySQL_install.sh)<br></code></pre></td></tr></table></figure><h2 id="添加swap分区–调用gitee仓库"><a href="#添加swap分区–调用gitee仓库" class="headerlink" title="添加swap分区–调用gitee仓库"></a>添加swap分区–调用gitee仓库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/swap.sh)<br></code></pre></td></tr></table></figure><h2 id="安装前-后端软件包一键脚本"><a href="#安装前-后端软件包一键脚本" class="headerlink" title="安装前&#x2F;后端软件包一键脚本"></a>安装前&#x2F;后端软件包一键脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/Software_package.sh)<br></code></pre></td></tr></table></figure><h2 id="gitee仓库超连接"><a href="#gitee仓库超连接" class="headerlink" title="gitee仓库超连接"></a>gitee仓库超连接</h2><p><a href="https://gitee.com/xbd666/qingfeng">gitee</a><br><a href="https://github.com/KKISO574/shell">github</a></p>]]></content>
    
    
    
    <tags>
      
      <tag>study，toolbox</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2025/01/06/hello-world/"/>
    <url>/2025/01/06/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
