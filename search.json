[{"title":"4层--DR模式--负载均衡实验","url":"/2025/11/06/4%E5%B1%82-DR%E6%A8%A1%E5%BC%8F-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/","content":"<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><p>准备3台纯洁的虚拟机，2台web服务器</p>\n<h3 id=\"安装lvs管理软件\"><a href=\"#安装lvs管理软件\" class=\"headerlink\" title=\"安装lvs管理软件\"></a>安装lvs管理软件</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install ipvsadm</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">程序包：ipvsadm（LVS管理工具）</span><br><span class=\"line\"></span><br><span class=\"line\">主程序：/usr/sbin/ipvsadm</span><br><span class=\"line\"></span><br><span class=\"line\">规则保存工具：/usr/sbin/ipvsadm-save  &gt; /path/to/file</span><br><span class=\"line\"></span><br><span class=\"line\">配置文件：/etc/sysconfig/ipvsadm-config</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"LVS-DR-模式简介\"><a href=\"#LVS-DR-模式简介\" class=\"headerlink\" title=\"LVS&#x2F;DR 模式简介\"></a>LVS&#x2F;DR 模式简介</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">DR模式的组网要求LVS和Real server在同一网段二层互通。因为LVS DR模式在负载均衡转发报文时，只修改目的mac为real server的mac，lvs要能将报文转发给real server，就必须满足LVS和real server是同网段二层互通。</span><br></pre></td></tr></table></figure>\n\n\n<h2 id=\"实验说明\"><a href=\"#实验说明\" class=\"headerlink\" title=\"实验说明\"></a>实验说明</h2><ol>\n<li>网络使用NAT模式</li>\n<li>DR模式要求Director DIP 和所有RealServer RIP必须在同一个网段及广播域</li>\n</ol>\n<h3 id=\"1-关闭防火墙\"><a href=\"#1-关闭防火墙\" class=\"headerlink\" title=\"1. 关闭防火墙\"></a>1. 关闭防火墙</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@lvs-server ~]# systemctl stop firewalld</span><br><span class=\"line\">[root@lvs-server ~]# setenforce 0</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"2-负载均衡器的配置\"><a href=\"#2-负载均衡器的配置\" class=\"headerlink\" title=\"2. 负载均衡器的配置\"></a>2. 负载均衡器的配置</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@lvs-server ~]# ip addr add dev ens33 192.168.246.160/32 #设置VIP</span><br><span class=\"line\">[root@lvs-server ~]# yum install -y ipvsadm   #RHEL确保LoadBalancer仓库可用</span><br><span class=\"line\">[root@lvs-server ~]# service ipvsadm start  #启动</span><br><span class=\"line\">注意:启动如果报错: /bin/bash: /etc/sysconfig/ipvsadm: 没有那个文件或目录</span><br><span class=\"line\">需要手动生成文件</span><br><span class=\"line\">[root@lvs-server ~]# ipvsadm --save &gt; /etc/sysconfig/ipvsadm</span><br><span class=\"line\"></span><br><span class=\"line\">为什么RS上lo配置的VIP掩码为32位</span><br><span class=\"line\">这是由于lo设备的特殊性导致， 如果lo绑定VIP/24，则该设备会响应该网段所有IP(192.168.246.0-254)的请求，而不是只响应192.168.246.160这一个地址。,就算是不设置为32也是可以的，只不过会影响访问</span><br></pre></td></tr></table></figure>\n\n\n<h4 id=\"定义LVS分发策略\"><a href=\"#定义LVS分发策略\" class=\"headerlink\" title=\"定义LVS分发策略\"></a>定义LVS分发策略</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">-A：添加VIP</span><br><span class=\"line\">-t：用的是tcp协议</span><br><span class=\"line\">-a：添加的是lo的vip地址</span><br><span class=\"line\">-r：转发到real-serve rip</span><br><span class=\"line\">-s：算法</span><br><span class=\"line\">-L|-l –list #显示内核虚拟服务器表</span><br><span class=\"line\">--numeric, -n：#以数字形式输出地址和端口号</span><br><span class=\"line\">-g --gatewaying #指定LVS工作模式为直接路由器模式（也是LVS默认的模式）</span><br><span class=\"line\">-S -save #保存虚拟服务器规则到标准输出，输出为-R 选项可读的格式</span><br><span class=\"line\">rr：轮循</span><br><span class=\"line\">如果添加ip错了，删除命令如下:</span><br><span class=\"line\"># ip addr del 192.168.246.193 dev ens33</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@lvs-server ~]# ipvsadm -C  #清除内核虚拟服务器表中的所有记录。</span><br><span class=\"line\">[root@lvs-server ~]# ipvsadm -A -t 192.168.246.160:80 -s rr </span><br><span class=\"line\">[root@lvs-server ~]# ipvsadm -a -t 192.168.246.160:80 -r 192.168.246.161 -g</span><br><span class=\"line\">[root@lvs-server ~]# ipvsadm -a -t 192.168.246.160:80 -r 192.168.246.162 -g </span><br><span class=\"line\">[root@lvs-server ~]# service ipvsadm save #保存方式一，使用下面的保存方式，版本7已经不支持了</span><br><span class=\"line\">[root@lvs-server ~]# ipvsadm -S &gt; /etc/sysconfig/ipvsadm  #保存方式二，保存到一个文件中</span><br><span class=\"line\">[root@lvs-server ~]# ipvsadm -ln</span><br><span class=\"line\">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class=\"line\">Prot LocalAddress:Port Scheduler Flags</span><br><span class=\"line\">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class=\"line\">TCP  192.168.246.160:80 rr</span><br><span class=\"line\">  -&gt; 192.168.246.161:80           Route   1      0          0         </span><br><span class=\"line\">  -&gt; 192.168.246.162:80           Route   1      0          0         </span><br><span class=\"line\">[root@lvs-server ~]# ipvsadm -L -n</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"3-配置RS后端机器\"><a href=\"#3-配置RS后端机器\" class=\"headerlink\" title=\"3. 配置RS后端机器\"></a>3. 配置RS后端机器</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@real-server1 ~]# yum install -y nginx</span><br><span class=\"line\">[root@real-server1 ~]# echo &quot;real-server1&quot; &gt;&gt; /usr/share/nginx/html/index.html</span><br><span class=\"line\">两台机器都安装，按顺序添加不同的主机名以示区分</span><br><span class=\"line\">[root@real-server1 ~]# ip addr add dev lo 192.168.246.160/32   #在lo接口上绑定VIP</span><br><span class=\"line\">[root@real-server1 ~]# echo 1 &gt; /proc/sys/net/ipv4/conf/all/arp_ignore  #忽略arp广播</span><br><span class=\"line\">[root@real-server1 ~]# echo 2 &gt; /proc/sys/net/ipv4/conf/all/arp_announce #匹配精确ip地址回包</span><br><span class=\"line\">[root@real-server1 ~]# systemctl start nginx </span><br><span class=\"line\">[root@real-server1 ~]# systemctl enable  nginx </span><br><span class=\"line\"></span><br><span class=\"line\">#关闭65秒的控制刷新</span><br><span class=\"line\">[root@real-server1 ~]# vim /etc/nginx/nginx.conf</span><br><span class=\"line\">65--改成--0</span><br><span class=\"line\">[root@real-server1 ~]# systemctl restart nginx </span><br><span class=\"line\">=============================================================================</span><br><span class=\"line\">因为：realServer的vip有了，接着就是同一个网段中拥有两个vip, 客户端在网关发送arp广播需找vip时需要让realServer不接受响应.  </span><br><span class=\"line\">解决：</span><br><span class=\"line\">echo 1 &gt;/proc/sys/net/ipv4/conf/eth0/arp_ignore </span><br><span class=\"line\">arp_ignore 设置为1，意味着当别人的arp请求过来的时候，如果接收的设备没有这个ip，就不做出响应(这个ip在lo上，lo不是接收设备的进口)</span><br><span class=\"line\">echo 2 &gt;/proc/sys/net/ipv4/conf/eth0/arp_announce   </span><br><span class=\"line\">使用最好的ip来回应，什么是最好的ip？同一个网段内子网掩码最长的</span><br></pre></td></tr></table></figure>\n\n\n<h3 id=\"4-测试\"><a href=\"#4-测试\" class=\"headerlink\" title=\"4. 测试\"></a>4. 测试</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">测试一</span><br><span class=\"line\">在游览器上输入vip地址</span><br><span class=\"line\"></span><br><span class=\"line\">测试二</span><br><span class=\"line\">[root@client ~]# elinks -dump http://192.168.246.160</span><br><span class=\"line\">-dump:非交互式模式</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Centos网卡配置","url":"/2025/11/06/Centos%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE/","content":"<h2 id=\"永久设置网卡\"><a href=\"#永久设置网卡\" class=\"headerlink\" title=\"永久设置网卡\"></a>永久设置网卡</h2><blockquote>\n<p>另外也可以在终端上输入 <code>nmtui</code>，进入网卡设置界面</p>\n</blockquote>\n<h3 id=\"1-Centos-7-配置\"><a href=\"#1-Centos-7-配置\" class=\"headerlink\" title=\"1. Centos 7 配置\"></a>1. Centos 7 配置</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">Centos 7</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">vim\t/etc/sysconfig/network-scripts/ifcfg-ens33 \t\t//网卡配置文件的路径</span></span><br><span class=\"line\">TYPE=Ethernet\t\t\t//网卡类型</span><br><span class=\"line\">BOOTPROTO=dhcp \t\t\t//网卡模式</span><br><span class=\"line\">     --&gt;  dhcp \t\t\t//自动获取</span><br><span class=\"line\">     --&gt;  static \t\t//手动获取</span><br><span class=\"line\">     --&gt;  none \t\t\t//手动获取</span><br><span class=\"line\">NAME=ens33 \t\t\t\t//网卡名称（可以修改的）</span><br><span class=\"line\">DEVICE=ens33 \t\t\t//设备名称</span><br><span class=\"line\">ONBOOT=yes \t\t\t\t//网卡开关</span><br><span class=\"line\">IPADDR=192.168.10.104\t//IP地址</span><br><span class=\"line\">PREFIX=24\t\t\t\t//子网掩码</span><br><span class=\"line\">NETMASK=255.255.255.0 \t//子网掩码</span><br><span class=\"line\">GATEWAY=192.168.10.2 \t//网关</span><br><span class=\"line\">DNS1=192.168.10.2 \t\t//DNS</span><br></pre></td></tr></table></figure>\n<h4 id=\"重启网卡服务\"><a href=\"#重启网卡服务\" class=\"headerlink\" title=\"重启网卡服务\"></a>重启网卡服务</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl restart network \t\t//重启网卡生效配置</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2-Centos-9-配置\"><a href=\"#2-Centos-9-配置\" class=\"headerlink\" title=\"2. Centos 9 配置\"></a>2. Centos 9 配置</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">Centos9</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">vim /etc/NetworkManager/system-connections/ens33.nmconnection  //修改如下选项即可</span></span><br><span class=\"line\">address=192.168.10.120/24,192.168.26.2 \t //ip地址，子网掩码，网关</span><br><span class=\"line\">dns=192.168.10.2       //DNS</span><br><span class=\"line\">method=manual \t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"meta prompt_\">   --&gt; </span><span class=\"language-bash\">manual          //手动</span></span><br><span class=\"line\"><span class=\"meta prompt_\">   --&gt; </span><span class=\"language-bash\">auto            //自动</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"重启网卡服务-1\"><a href=\"#重启网卡服务-1\" class=\"headerlink\" title=\"重启网卡服务\"></a>重启网卡服务</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">nmcli c reload      //重启网络服务 </span><br><span class=\"line\">nmcli c down ens33  //开启网络 </span><br><span class=\"line\">nmcli c up ens33    //关闭网络</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-当-network-和-NetworkManager-网卡冲突\"><a href=\"#3-当-network-和-NetworkManager-网卡冲突\" class=\"headerlink\" title=\"3. 当 network 和 NetworkManager 网卡冲突\"></a>3. 当 network 和 NetworkManager 网卡冲突</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop NetworkManager </span><br><span class=\"line\"></span><br><span class=\"line\">systemctl disabled NetworkManager   //将NetworkManger停止</span><br><span class=\"line\"></span><br><span class=\"line\">ifup ens33          //输入此命令即可查看ens33网卡</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl restart network          //重启网卡服务</span><br><span class=\"line\"></span><br><span class=\"line\"># 此时应该就可以看到ens33的IP地址了</span><br></pre></td></tr></table></figure>\n<hr>\n","categories":["operations"],"tags":["Linux","Centos"]},{"title":"ChatGPT部署","url":"/2025/11/06/ChatGPT%E9%83%A8%E7%BD%B2/","content":"<h1 id=\"免费使用ChatGPT，网页版部署\"><a href=\"#免费使用ChatGPT，网页版部署\" class=\"headerlink\" title=\"免费使用ChatGPT，网页版部署\"></a>免费使用ChatGPT，网页版部署</h1><ul>\n<li>API官网：<a href=\"https://api1.chenjianming.fun/\">https://api1.chenjianming.fun</a></li>\n<li>GitHub官网：<a href=\"https://github.com/\">https://github.com</a> </li>\n<li>vercel官网：<a href=\"https://vercel.com/\">https://vercel.com</a></li>\n</ul>\n<h1 id=\"登入github，点击搜索chat，点第二个项目\"><a href=\"#登入github，点击搜索chat，点第二个项目\" class=\"headerlink\" title=\"登入github，点击搜索chat，点第二个项目\"></a>登入github，点击搜索chat，点第二个项目</h1><p><a href=\"https://github.com/xubaodong0511/ChatGPT-Next-Web\">https://github.com/xubaodong0511/ChatGPT-Next-Web</a></p>\n<h1 id=\"点击Fork到自己仓库\"><a href=\"#点击Fork到自己仓库\" class=\"headerlink\" title=\"点击Fork到自己仓库\"></a>点击Fork到自己仓库</h1><p><a href=\"https://vercel.com/new/xubaodong0511s-projects\">https://vercel.com/new/xubaodong0511s-projects</a></p>\n<h1 id=\"打开网站vercel-com\"><a href=\"#打开网站vercel-com\" class=\"headerlink\" title=\"打开网站vercel.com\"></a>打开网站vercel.com</h1><ul>\n<li>点击新建项目</li>\n<li>可以看到刚刚Fork的仓库</li>\n<li>点击import导入</li>\n<li>重新构建一个项目名字，不然不会分配免费的域名</li>\n<li>点击Environment Variables</li>\n</ul>\n<h1 id=\"Environment-Variables-环境变量-步骤—直接复制下面内容\"><a href=\"#Environment-Variables-环境变量-步骤—直接复制下面内容\" class=\"headerlink\" title=\"Environment Variables(环境变量)步骤—直接复制下面内容\"></a>Environment Variables(环境变量)步骤—直接复制下面内容</h1><ul>\n<li>BASE_URL</li>\n<li><a href=\"https://api1.chenjianming.fun/\">https://api1.chenjianming.fun</a></li>\n<li>点击add</li>\n</ul>\n<h1 id=\"创建令牌密钥步骤\"><a href=\"#创建令牌密钥步骤\" class=\"headerlink\" title=\"创建令牌密钥步骤\"></a>创建令牌密钥步骤</h1><ul>\n<li><a href=\"https://api1.chenjianming.fun/\">https://api1.chenjianming.fun</a></li>\n<li>点击密钥，创建—-设置名称，永不过期，设为无限额度</li>\n<li>提交</li>\n<li>回到Environment Variables步骤</li>\n<li>OPENAI_API_KEY</li>\n<li>添加刚刚创建的令牌密钥</li>\n<li>点击add</li>\n</ul>\n<h1 id=\"CODE添加密码步骤（可选）\"><a href=\"#CODE添加密码步骤（可选）\" class=\"headerlink\" title=\"CODE添加密码步骤（可选）\"></a>CODE添加密码步骤（可选）</h1><ul>\n<li>CODE</li>\n<li>自己设置一个密码</li>\n<li>add</li>\n</ul>\n<p>以上步骤完成点击Deploy构建（大概需要3分钟）</p>\n<h1 id=\"构建成功后会自动跳转\"><a href=\"#构建成功后会自动跳转\" class=\"headerlink\" title=\"构建成功后会自动跳转\"></a>构建成功后会自动跳转</h1><ul>\n<li>点击头像</li>\n<li>点击港创建的项目</li>\n<li>点击Visit(可以访问了)</li>\n</ul>\n<h1 id=\"仓库地址\"><a href=\"#仓库地址\" class=\"headerlink\" title=\"仓库地址\"></a>仓库地址</h1><p><a href=\"https://vercel.com/xubaodong0511s-projects/qingfeng\">https://vercel.com/xubaodong0511s-projects/qingfeng</a></p>\n<h1 id=\"GPT地址\"><a href=\"#GPT地址\" class=\"headerlink\" title=\"GPT地址\"></a>GPT地址</h1><p><a href=\"https://qingfeng-sepia.vercel.app/\">https://qingfeng-sepia.vercel.app/</a></p>\n<h1 id=\"备注\"><a href=\"#备注\" class=\"headerlink\" title=\"备注\"></a>备注</h1><p>如果不能访问解决方案</p>\n<ul>\n<li><p>点击Settings(设置)</p>\n</li>\n<li><p>点击Domains(域名)</p>\n</li>\n<li><p>添加自己的域名</p>\n</li>\n<li><p>add—-需要添加两条记录</p>\n</li>\n<li><p>TXT记录</p>\n<ul>\n<li>在chenjianming.fun—-记录—-添加—-选择类型（TXT）—-名称（_vercel）—-内容（vc-domain-verify&#x3D;test.chenjianming.fun,0327a7d9f3fa0d8d135e）</li>\n</ul>\n</li>\n<li><p>name记录</p>\n<ul>\n<li>类型（CNAME）—-名称（自己添加的域名名字）—-目标（cname.vercel-dns.com）</li>\n</ul>\n</li>\n</ul>\n","categories":["operations"],"tags":["Linux","ChatGPT"]},{"title":"Docker项目：搭建服务器监控面板","url":"/2025/11/06/Docker%E9%A1%B9%E7%9B%AE%EF%BC%9A%E6%90%AD%E5%BB%BA%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF/","content":"<h2 id=\"搭建一个专属自己的网站监控——Uptime-Kuma\"><a href=\"#搭建一个专属自己的网站监控——Uptime-Kuma\" class=\"headerlink\" title=\"搭建一个专属自己的网站监控——Uptime Kuma\"></a>搭建一个专属自己的网站监控——Uptime Kuma</h2><h3 id=\"安装-Docker\"><a href=\"#安装-Docker\" class=\"headerlink\" title=\"安装 Docker\"></a>安装 Docker</h3><p><code>下载docker，docker官方网址docker.com</code></p>\n<h3 id=\"创建-yml-配置文件\"><a href=\"#创建-yml-配置文件\" class=\"headerlink\" title=\"创建 yml 配置文件\"></a>创建 yml 配置文件</h3><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim docker-compose.yml代码</span><br><span class=\"line\">version: &#x27;3.3&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">services:</span><br><span class=\"line\">  uptime-kuma:</span><br><span class=\"line\">    image: louislam/uptime-kuma</span><br><span class=\"line\">    container_name: uptime-kuma</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - ./uptime-kuma:/app/data</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - 3001:3001</span><br></pre></td></tr></table></figure>\n<h3 id=\"反向代理配置\"><a href=\"#反向代理配置\" class=\"headerlink\" title=\"反向代理配置\"></a>反向代理配置</h3><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">server  &#123;</span><br><span class=\"line\">    listen 80<span class=\"comment\">;</span></span><br><span class=\"line\">    server_name    vps.7boe.top<span class=\"comment\">;</span></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass         http://localhost:3001<span class=\"comment\">;</span></span><br><span class=\"line\">        proxy_http_version 1.1<span class=\"comment\">;</span></span><br><span class=\"line\">        proxy_set_header   Upgrade $http_upgrade<span class=\"comment\">;</span></span><br><span class=\"line\">        proxy_set_header   Connection &quot;upgrade&quot;<span class=\"comment\">;</span></span><br><span class=\"line\">        proxy_set_header   Host $host<span class=\"comment\">;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"Docker-安装与推送镜像\"><a href=\"#Docker-安装与推送镜像\" class=\"headerlink\" title=\"Docker 安装与推送镜像\"></a>Docker 安装与推送镜像</h3><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker pull louislam/uptime-kuma</span><br></pre></td></tr></table></figure>\n<h3 id=\"挂载宿主机目录到容器\"><a href=\"#挂载宿主机目录到容器\" class=\"headerlink\" title=\"挂载宿主机目录到容器\"></a>挂载宿主机目录到容器</h3><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker volume create uptime-kuma</span><br></pre></td></tr></table></figure>\n<h3 id=\"创建容器\"><a href=\"#创建容器\" class=\"headerlink\" title=\"创建容器\"></a>创建容器</h3><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker run -d <span class=\"attr\">--restart</span>=always -p <span class=\"number\">3001</span>:<span class=\"number\">3001</span> -v uptime-kuma:/app/data --name uptime-kuma louislam/uptime-kuma:<span class=\"number\">1</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p><code>浏览器打开IP：3001</code><strong>会出来kuma的登入界面</strong></p>\n","categories":["operations"],"tags":["Linux","Docker"]},{"title":"ELK+kafka+filebeat 集群部署","url":"/2025/11/06/ELK-kafka-filebeat-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","content":"<h2 id=\"版本说明\"><a href=\"#版本说明\" class=\"headerlink\" title=\"版本说明\"></a>版本说明</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">Elasticsearch: 7.13.2 #wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.13.2-linux-x86_64.tar.gz</span><br><span class=\"line\">Logstash: 7.13.2 #wget https://artifacts.elastic.co/downloads/logstash/logstash-7.13.2-linux-x86_64.tar.gz</span><br><span class=\"line\">Kibana: 7.13.2 #wget https://artifacts.elastic.co/downloads/kibana/kibana-7.13.2-linux-x86_64.tar.gz</span><br><span class=\"line\">Kafka: 2.11-2.1  #wget https://archive.apache.org/dist/kafka/2.1.0/kafka_2.11-2.1.0.tgz</span><br><span class=\"line\">Filebeat: 7.13.2</span><br><span class=\"line\">相应的版本最好下载对应的插件</span><br></pre></td></tr></table></figure>\n\n<p><strong>相关地址：</strong></p>\n<p>官网地址：<a href=\"https://www.elastic.co/\">https://www.elastic.co</a></p>\n<p>官网搭建：<a href=\"https://www.elastic.co/guide/index.html\">https://www.elastic.co/guide/index.html</a></p>\n<h2 id=\"实施部署\"><a href=\"#实施部署\" class=\"headerlink\" title=\"实施部署\"></a>实施部署</h2><p>关闭防火墙，关闭setenforce</p>\n<h2 id=\"1、安装配置jdk8\"><a href=\"#1、安装配置jdk8\" class=\"headerlink\" title=\"1、安装配置jdk8\"></a>1、安装配置jdk8</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">三台机器都操作，安装jdk（java）</span><br><span class=\"line\">[root@mes-1 ~]# tar xzf jdk-8u191-linux-x64.tar.gz -C /usr/local/</span><br><span class=\"line\">[root@mes-1 ~]# cd /usr/local/</span><br><span class=\"line\">[root@mes-1 local]# mv jdk1.8.0_191/ java</span><br><span class=\"line\">[root@mes-1 local]# echo &#x27;</span><br><span class=\"line\">JAVA_HOME=/usr/local/java</span><br><span class=\"line\">PATH=$JAVA_HOME/bin:$PATH</span><br><span class=\"line\">export JAVA_HOME PATH</span><br><span class=\"line\">&#x27; &gt;&gt;/etc/profile</span><br><span class=\"line\">[root@mes-1 ~]# source /etc/profile</span><br><span class=\"line\">[root@mes-1 ~]# java -version</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2、安装配置ES—-只在第一台操作操作下面的部分\"><a href=\"#2、安装配置ES—-只在第一台操作操作下面的部分\" class=\"headerlink\" title=\"2、安装配置ES—-只在第一台操作操作下面的部分\"></a>2、安装配置ES—-只在第一台操作操作下面的部分</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">创建运行ES的普通用户</span><br><span class=\"line\">[root@mes-1 ~]# useradd elsearch</span><br><span class=\"line\">[root@mes-1 ~]# echo &quot;123456&quot; | passwd --stdin &quot;elsearch&quot;</span><br><span class=\"line\">================</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">如果是集群三台机器都操作</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装配置ES–如果是集群三台机器都操作\"><a href=\"#安装配置ES–如果是集群三台机器都操作\" class=\"headerlink\" title=\"安装配置ES–如果是集群三台机器都操作\"></a>安装配置ES–如果是集群三台机器都操作</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 ~]# tar xzf elasticsearch-6.5.4.tar.gz -C /usr/local/</span><br><span class=\"line\">[root@mes-1 ~]# cd /usr/local/elasticsearch-6.5.4/config/</span><br><span class=\"line\">[root@mes-1 config]# ls</span><br><span class=\"line\">elasticsearch.yml  log4j2.properties  roles.yml  users_roles</span><br><span class=\"line\">jvm.options        role_mapping.yml   users</span><br><span class=\"line\">[root@mes-1 config]# cp elasticsearch.yml elasticsearch.yml.bak</span><br><span class=\"line\">[root@mes-1 config]# vim elasticsearch.yml    ----找个地方添加如下内容</span><br><span class=\"line\">cluster.name: elk</span><br><span class=\"line\">cluster.initial_master_nodes: [&quot;192.168.246.234&quot;,&quot;192.168.246.231&quot;,&quot;192.168.246.235&quot;]\t#写所有的IP地址</span><br><span class=\"line\">node.name: elk01\t#修改，自定义名字</span><br><span class=\"line\">node.master: true</span><br><span class=\"line\">node.data: true</span><br><span class=\"line\">path.data: /data/elasticsearch/data</span><br><span class=\"line\">path.logs: /data/elasticsearch/logs</span><br><span class=\"line\">bootstrap.memory_lock: false</span><br><span class=\"line\">bootstrap.system_call_filter: false</span><br><span class=\"line\">network.host: 0.0.0.0</span><br><span class=\"line\">http.port: 9200</span><br><span class=\"line\">transport.tcp.port: 9300</span><br><span class=\"line\">discovery.seed_hosts: [&quot;192.168.246.234&quot;, &quot;192.168.246.235&quot;]\t#改自己的另外两台IP</span><br><span class=\"line\">discovery.zen.minimum_master_nodes: 2</span><br><span class=\"line\">discovery.zen.ping_timeout: 150s</span><br><span class=\"line\">discovery.zen.fd.ping_retries: 10</span><br><span class=\"line\">client.transport.ping_timeout: 60s</span><br><span class=\"line\">http.cors.enabled: true</span><br><span class=\"line\">http.cors.allow-origin: &quot;*&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">单节点配置</span><br><span class=\"line\">cluster.name: elk</span><br><span class=\"line\">cluster.initial_master_nodes: [&quot;10.36.153.131&quot;] \t#单机只写本机ip</span><br><span class=\"line\">node.name: elk01\t#自定义名字</span><br><span class=\"line\">node.master: true</span><br><span class=\"line\">node.data: true</span><br><span class=\"line\">path.data: /data/elasticsearch/data</span><br><span class=\"line\">path.logs: /data/elasticsearch/logs</span><br><span class=\"line\">bootstrap.memory_lock: false</span><br><span class=\"line\">bootstrap.system_call_filter: false</span><br><span class=\"line\">network.host: 10.36.153.131 \t#单机只写本机ip</span><br><span class=\"line\">http.port: 9200</span><br><span class=\"line\">transport.tcp.port: 9300</span><br><span class=\"line\">discovery.seed_hosts: [&quot;10.36.153.131&quot;] #单机只写本机ip</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">discovery.zen.minimum_master_nodes: 2</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">discovery.zen.ping_timeout: 150s</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">discovery.zen.fd.ping_retries: 10</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">client.transport.ping_timeout: 60s</span></span><br><span class=\"line\">http.cors.enabled: true</span><br><span class=\"line\">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"设置JVM堆大小—-如果是集群三台机器都操作\"><a href=\"#设置JVM堆大小—-如果是集群三台机器都操作\" class=\"headerlink\" title=\"设置JVM堆大小—#如果是集群三台机器都操作\"></a>设置JVM堆大小—#如果是集群三台机器都操作</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 config]# vim jvm.options     ----配置文件里修改</span><br><span class=\"line\">-Xms1g    ----修改成 -Xms2g</span><br><span class=\"line\">-Xmx1g    ----修改成 -Xms2g</span><br><span class=\"line\"></span><br><span class=\"line\">或者:</span><br><span class=\"line\">推荐设置为4G，请注意下面的说明：</span><br><span class=\"line\">sed -i &#x27;s/-Xms1g/-Xms4g/&#x27; /usr/local/elasticsearch-6.5.4/config/jvm.options</span><br><span class=\"line\">sed -i &#x27;s/-Xmx1g/-Xmx4g/&#x27; /usr/local/elasticsearch-6.5.4/config/jvm.options</span><br><span class=\"line\"></span><br><span class=\"line\">堆内存大小不要超过系统内存的50%</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"创建ES数据及日志存储目录\"><a href=\"#创建ES数据及日志存储目录\" class=\"headerlink\" title=\"创建ES数据及日志存储目录\"></a>创建ES数据及日志存储目录</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 ~]# mkdir -p /data/elasticsearch/data       (/data/elasticsearch)</span><br><span class=\"line\">[root@mes-1 ~]# mkdir -p /data/elasticsearch/logs       (/log/elasticsearch)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"修改安装目录及存储目录权限\"><a href=\"#修改安装目录及存储目录权限\" class=\"headerlink\" title=\"修改安装目录及存储目录权限\"></a>修改安装目录及存储目录权限</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 ~]# chown -R elsearch:elsearch /data/elasticsearch</span><br><span class=\"line\">[root@mes-1 ~]# chown -R elsearch:elsearch /usr/local/elasticsearch-7.13.2</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3、系统优化\"><a href=\"#3、系统优化\" class=\"headerlink\" title=\"3、系统优化\"></a>3、系统优化</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">增加最大文件打开数</span><br><span class=\"line\">永久生效方法：----`看情况做，可不做`</span><br><span class=\"line\">echo &quot;* - nofile 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br></pre></td></tr></table></figure>\n<h2 id=\"增加最大进程数\"><a href=\"#增加最大进程数\" class=\"headerlink\" title=\"增加最大进程数\"></a>增加最大进程数</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 ~]# vim /etc/security/limits.conf    ---在文件最后面添加如下内容</span><br><span class=\"line\">* soft nofile 65536</span><br><span class=\"line\">* hard nofile 131072</span><br><span class=\"line\">* soft nproc 2048</span><br><span class=\"line\">* hard nproc 4096</span><br><span class=\"line\">* hard nofile 65536</span><br><span class=\"line\">* hard nofile 65536</span><br><span class=\"line\">更多的参数调整可以直接用这个</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"增加最大内存映射数\"><a href=\"#增加最大内存映射数\" class=\"headerlink\" title=\"增加最大内存映射数\"></a>增加最大内存映射数</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 ~]# vim /etc/sysctl.conf   ---添加如下</span><br><span class=\"line\">vm.max_map_count=262144</span><br><span class=\"line\">vm.swappiness=0</span><br><span class=\"line\">[root@mes-1 ~]# sysctl -p\t#看情况做，可不做</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">设置内存权限大小</span></span><br><span class=\"line\">[root@mes-1 ~]# sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4、启动ES\"><a href=\"#4、启动ES\" class=\"headerlink\" title=\"4、启动ES\"></a>4、启动ES</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">如果是集群三台机器都启动</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">切换到不同用户启动</span> </span><br><span class=\"line\">`启动的时候一台机器一台机器的启动`</span><br><span class=\"line\">[root@mes-1 ~]# su - elsearch</span><br><span class=\"line\">Last login: Sat Aug  3 19:48:59 CST 2019 on pts/0</span><br><span class=\"line\"></span><br><span class=\"line\">[root@mes-1 ~]$ cd /usr/local/elasticsearch-6.5.4/</span><br><span class=\"line\">[root@mes-1 elasticsearch-6.5.4]$ ./bin/elasticsearch  #先启动看看报错不，需要多等一会</span><br><span class=\"line\"></span><br><span class=\"line\">`ctrl+c终止之后,启动后台运行`</span><br><span class=\"line\">[root@mes-1 elasticsearch-6.5.4]$ nohup ./bin/elasticsearch &amp;  #放后台启动</span><br><span class=\"line\">[1] 11462</span><br><span class=\"line\">nohup: ignoring input and appending output to ‘nohup.out’</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看9200、9300端口有没有起来</span></span><br><span class=\"line\">[root@mes-1 elasticsearch-6.5.4]$ netstat -lnpt</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看日志</span></span><br><span class=\"line\">[root@mes-1 elasticsearch-6.5.4]$ tail -f nohup.out   #看一下是否启动</span><br><span class=\"line\">或者:</span><br><span class=\"line\">su - elsearch -c &quot;cd /usr/local/elasticsearch-6.5.4 &amp;&amp; nohup bin/elasticsearch &amp;&quot;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p><code>以上步骤三台机器都操作</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">浏览器访问http://172.16.246.234:9200</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">三台机器都可以访问，加端口9200</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-安装配置head监控插件（Web前端）—-只需要安装一台就可以了\"><a href=\"#5-安装配置head监控插件（Web前端）—-只需要安装一台就可以了\" class=\"headerlink\" title=\"5.安装配置head监控插件（Web前端）—-只需要安装一台就可以了\"></a>5.安装配置head监控插件（Web前端）—-只需要安装一台就可以了</h2><p>192.168.246.235</p>\n<p>安装node</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# wget https://npm.taobao.org/mirrors/node/v14.15.3/node-v14.15.3-linux-x64.tar.gz</span><br><span class=\"line\">[root@es-3-head-kib ~]# tar xzvf node-v14.15.3-linux-x64.tar.gz -C /usr/local/</span><br><span class=\"line\">[root@es-3-head-kib ~]# vim /etc/profile   #添加如下变量</span><br><span class=\"line\">NODE_HOME=/usr/local/node-v14.15.3-linux-x64</span><br><span class=\"line\">PATH=$NODE_HOME/bin:$PATH</span><br><span class=\"line\">export NODE_HOME PATH</span><br><span class=\"line\">[root@es-3-head-kib ~]# source /etc/profile</span><br><span class=\"line\">[root@es-3-head-kib ~]# node --version  #检查node版本号</span><br><span class=\"line\">v14.15.3</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"下载head插件\"><a href=\"#下载head插件\" class=\"headerlink\" title=\"下载head插件\"></a>下载head插件</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# wget https://github.com/mobz/elasticsearch-head/archive/master.zip</span><br><span class=\"line\">[root@es-3-head-kib ~]# unzip -d /usr/local/ master.zip</span><br><span class=\"line\">[root@es-3-head-kib ~]# cd /usr/local</span><br><span class=\"line\">或者</span><br><span class=\"line\">unzip –d /usr/local elasticsearch-head-master.zip</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装grunt\"><a href=\"#安装grunt\" class=\"headerlink\" title=\"安装grunt\"></a>安装grunt</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# cd elasticsearch-head-master/</span><br><span class=\"line\">[root@mes-3-head-kib elasticsearch-head-master]# npm config set registry https://registry.npm.taobao.org  #更换一个镜像，如果不更换下载会很慢</span><br><span class=\"line\">[root@mes-3-head-kib elasticsearch-head-master]# npm install -g grunt-cli  #时间会很长</span><br><span class=\"line\">[root@es-3-head-kib elasticsearch-head-master]# grunt --version  #检查grunt版本号</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"修改head源码\"><a href=\"#修改head源码\" class=\"headerlink\" title=\"修改head源码\"></a>修改head源码</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib elasticsearch-head-master]# vim /usr/local/elasticsearch-head-master/Gruntfile.js    #（95左右）</span><br><span class=\"line\">添加--hostname: &#x27;*&#x27;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">注意在上一行末尾添加逗号,hostname 不需要添加逗号</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@es-3-head-kib elasticsearch-head-master]# vim /usr/local/elasticsearch-head-master/_site/app.js        \t#(4359左右)</span><br><span class=\"line\">原本是http://localhost:9200--http://192.168.116.111:9200</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">如果<span class=\"built_in\">head</span>和ES不在同一个节点，注意修改成ES的IP地址</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"下载head必要的文件\"><a href=\"#下载head必要的文件\" class=\"headerlink\" title=\"下载head必要的文件\"></a>下载head必要的文件</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# wget https://github.com/Medium/phantomjs/releases/download/v2.1.1/phantomjs-2.1.1-linux-x86_64.tar.bz2</span><br><span class=\"line\">[root@es-3-head-kib ~]# yum -y install bzip2</span><br><span class=\"line\">[root@es-3-head-kib ~]# tar -jxf phantomjs-2.1.1-linux-x86_64.tar.bz2 -C /tmp/  #解压</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"运行head\"><a href=\"#运行head\" class=\"headerlink\" title=\"运行head\"></a>运行head</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# cd /usr/local/elasticsearch-head-master/</span><br><span class=\"line\">[root@es-3-head-kib elasticsearch-head-master]# npm config set registry https://registry.npm.taobao.org  #先执行这条命令更换一个镜像</span><br><span class=\"line\">[root@es-3-head-kib elasticsearch-head-master]# npm install</span><br><span class=\"line\">...</span><br><span class=\"line\">grunt-contrib-jasmine@1.0.3 node_modules/grunt-contrib-jasmine</span><br><span class=\"line\">├── sprintf-js@1.0.3</span><br><span class=\"line\">├── lodash@2.4.2</span><br><span class=\"line\">├── es5-shim@4.5.13</span><br><span class=\"line\">├── chalk@1.1.3 (escape-string-regexp@1.0.5, supports-color@2.0.0, ansi-styles@2.2.1, strip-ansi@3.0.1, has-ansi@2.0.0)</span><br><span class=\"line\">├── jasmine-core@2.99.1</span><br><span class=\"line\">├── rimraf@2.6.3 (glob@7.1.4)</span><br><span class=\"line\">└── grunt-lib-phantomjs@1.1.0 (eventemitter2@0.4.14, semver@5.7.0, temporary@0.0.8, phan</span><br><span class=\"line\"></span><br><span class=\"line\">如果报错执行：npm install phantomjs-prebuilt@2.1.16 --ignore-scripts</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">后台运行</span></span><br><span class=\"line\">[root@es-3-head-kib elasticsearch-head-master]# nohup grunt server &amp;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">清理缓存</span></span><br><span class=\"line\">echo 3 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试-1\"><a href=\"#测试-1\" class=\"headerlink\" title=\"测试\"></a>测试</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># web访问安装node，head，grunt的机器IP地址</span><br><span class=\"line\">访问http://172.16.246.235:9100</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Kibana部署\"><a href=\"#Kibana部署\" class=\"headerlink\" title=\"Kibana部署\"></a>Kibana部署</h2><p>系统类型：Centos7.5<br>节点IP：192.168.246.235 D<br>软件版本：nginx-1.14.2、kibana-6.5.4-linux-x86_64.tar.gz</p>\n<h2 id=\"1-安装配置Kibana\"><a href=\"#1-安装配置Kibana\" class=\"headerlink\" title=\"1. 安装配置Kibana\"></a>1. 安装配置Kibana</h2><h2 id=\"（1）安装\"><a href=\"#（1）安装\" class=\"headerlink\" title=\"（1）安装\"></a>（1）安装</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# tar zvxf kibana-6.5.4-linux-x86_64.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）配置\"><a href=\"#（2）配置\" class=\"headerlink\" title=\"（2）配置\"></a>（2）配置</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# cd /usr/local/kibana-7.13.2-linux-x86_64/config/</span><br><span class=\"line\">[root@es-3-head-kib config]# vim kibana.yml</span><br><span class=\"line\">server.port: 5601</span><br><span class=\"line\">server.host: &quot;192.168.246.235&quot;\t#本机的IP</span><br><span class=\"line\">elasticsearch.hosts: [&quot;http://192.168.246.234:9200&quot;]\t#节点的IP（随便哪个都可以）</span><br><span class=\"line\">kibana.index: &quot;.kibana&quot;</span><br><span class=\"line\">i18n.locale: &quot;zh-CN&quot;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib config]# cd ..</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动后台运行</span></span><br><span class=\"line\">[root@es-3-head-kib kibana-7.13.2-linux-x86_64]# nohup ./bin/kibana --allow-root &amp;</span><br><span class=\"line\">[1] 12054</span><br><span class=\"line\">[root@es-3-head-kib kibana-7.13.2-linux-x86_64]# nohup: ignoring input and appending output to ‘nohup.out’\t#此为显示内容</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-安装配置Nginx反向代理\"><a href=\"#2-安装配置Nginx反向代理\" class=\"headerlink\" title=\"2. 安装配置Nginx反向代理\"></a>2. 安装配置Nginx反向代理</h2><h2 id=\"配置YUM源：\"><a href=\"#配置YUM源：\" class=\"headerlink\" title=\"配置YUM源：\"></a>配置YUM源：</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装：\"><a href=\"#安装：\" class=\"headerlink\" title=\"安装：\"></a>安装：</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# yum install -y nginx </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置反向代理\"><a href=\"#配置反向代理\" class=\"headerlink\" title=\"配置反向代理\"></a>配置反向代理</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# cd /etc/nginx/conf.d/</span><br><span class=\"line\">[root@es-3-head-kib conf.d]# cp default.conf nginx.conf</span><br><span class=\"line\">[root@es-3-head-kib conf.d]# mv default.conf default.conf.bak</span><br><span class=\"line\">[root@es-3-head-kib conf.d]# vim nginx.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置文件内容</span></span><br><span class=\"line\">[root@es-3-head-kib conf.d]# cat nginx.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       80;</span><br><span class=\"line\">        server_name  192.168.246.235;</span><br><span class=\"line\"></span><br><span class=\"line\">        #charset koi8-r;</span><br><span class=\"line\"></span><br><span class=\"line\">       # access_log  /var/log/nginx/host.access.log  main;</span><br><span class=\"line\">       # access_log off;</span><br><span class=\"line\"></span><br><span class=\"line\">         location / &#123;  </span><br><span class=\"line\">             proxy_pass http://192.168.246.235:5601;</span><br><span class=\"line\">             proxy_set_header Host $host:5601;  </span><br><span class=\"line\">             proxy_set_header X-Real-IP $remote_addr;  </span><br><span class=\"line\">             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;  </span><br><span class=\"line\">             proxy_set_header Via &quot;nginx&quot;;  </span><br><span class=\"line\">                     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">         location /head/&#123;</span><br><span class=\"line\">             proxy_pass http://192.168.246.235:9100;</span><br><span class=\"line\">             proxy_set_header Host $host:9100;</span><br><span class=\"line\">             proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">             proxy_set_header Via &quot;nginx&quot;;</span><br><span class=\"line\">                         &#125;  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置nginx\"><a href=\"#配置nginx\" class=\"headerlink\" title=\"配置nginx\"></a>配置nginx</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.将原来的log_format注释掉，添加json格式的配置信息，如下：</span><br><span class=\"line\">[root@es-3-head-kib conf.d]# vim /etc/nginx/nginx.conf</span><br><span class=\"line\">log_format  json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;@version&quot;:&quot;1&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;client&quot;:&quot;$remote_addr&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;url&quot;:&quot;$uri&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;status&quot;:&quot;$status&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;referer&quot;: &quot;$http_referer&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;ua&quot;: &quot;$http_user_agent&quot;&#x27;</span><br><span class=\"line\">               &#x27;&#125;&#x27;;</span><br><span class=\"line\">2.引用定义的json格式的日志：</span><br><span class=\"line\">access_log  /var/log/nginx/access_json.log  json;\t#在nginx.conf配置文件里</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"启动nginx\"><a href=\"#启动nginx\" class=\"headerlink\" title=\"启动nginx\"></a>启动nginx</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@es-3-head-kib ~]# systemctl start nginx</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试–访问当前机器IP\"><a href=\"#测试–访问当前机器IP\" class=\"headerlink\" title=\"测试–访问当前机器IP\"></a>测试–访问当前机器IP</h2><p><code>浏览器访问http://192.168.246.235 刚开始没有任何数据，会提示你创建新的索引</code></p>\n<h2 id=\"Logstash部署—-192-168-246-231\"><a href=\"#Logstash部署—-192-168-246-231\" class=\"headerlink\" title=\"Logstash部署—-192.168.246.231\"></a>Logstash部署—-192.168.246.231</h2><p>系统类型：Centos7.5<br>节点IP：192.168.246.231   E<br>软件版本：jdk-8u121-linux-x64.tar.gz、logstash-6.5.4.tar.gz</p>\n<h2 id=\"1-安装配置Logstash\"><a href=\"#1-安装配置Logstash\" class=\"headerlink\" title=\"1.安装配置Logstash\"></a>1.安装配置Logstash</h2><h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-2-zk-log ~]# tar xvzf logstash-6.5.4.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h2><p>创建目录，我们将所有input、filter、output配置文件全部放到该目录中。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.安装nginx:</span><br><span class=\"line\">[root@es-2-zk-log ~]# rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm</span><br><span class=\"line\">[root@es-2-zk-log ~]# yum install -y nginx</span><br><span class=\"line\">将原来的日志格式注释掉定义成json格式：</span><br><span class=\"line\">[root@es-2-zk-log conf.d]# vim /etc/nginx/nginx.conf</span><br><span class=\"line\">log_format  json &#x27;&#123;&quot;@timestamp&quot;:&quot;$time_iso8601&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;@version&quot;:&quot;1&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;client&quot;:&quot;$remote_addr&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;url&quot;:&quot;$uri&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;status&quot;:&quot;$status&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;domain&quot;:&quot;$host&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;host&quot;:&quot;$server_addr&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;size&quot;:$body_bytes_sent,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;responsetime&quot;:$request_time,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;referer&quot;: &quot;$http_referer&quot;,&#x27;</span><br><span class=\"line\">                           &#x27;&quot;ua&quot;: &quot;$http_user_agent&quot;&#x27;</span><br><span class=\"line\">               &#x27;&#125;&#x27;;</span><br><span class=\"line\">2.引用定义的json格式的日志：</span><br><span class=\"line\">access_log  /var/log/nginx/access_json.log  json;\t#在配置文件里改</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动</span></span><br><span class=\"line\">[root@es-2-zk-log ~]# systemctl start nginx </span><br><span class=\"line\">[root@es-2-zk-log ~]# systemctl enable nginx</span><br><span class=\"line\">浏览器多访问几次</span><br><span class=\"line\">[root@es-2-zk-log ~]# mkdir -p /usr/local/logstash-7.13.2/etc/conf.d</span><br><span class=\"line\">[root@es-2-zk-log ~]# cd /usr/local/logstash-6.5.4/etc/conf.d/       </span><br><span class=\"line\">[root@es-2-zk-log conf.d]# vim input.conf       #---在下面添加</span><br><span class=\"line\">input&#123;                        #让logstash可以读取特定的事件源。</span><br><span class=\"line\"></span><br><span class=\"line\">    file&#123;                                       #从文件读取</span><br><span class=\"line\"></span><br><span class=\"line\">   path =&gt; [&quot;/var/log/nginx/access_json.log&quot;]        #要输入的文件路径</span><br><span class=\"line\"></span><br><span class=\"line\">   type =&gt; &quot;shopweb&quot;                       #定义一个类型，通用选项. </span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@es-2-zk-log conf.d]# vim output.conf</span><br><span class=\"line\">output&#123;           #输出插件，将事件发送到特定目标</span><br><span class=\"line\">    elasticsearch &#123;            #输出到es</span><br><span class=\"line\">    hosts =&gt; [&quot;192.168.246.234:9200&quot;,&quot;192.168.246.231:9200&quot;,&quot;192.168.246.235:9200&quot;]       #指定es服务的ip加端口</span><br><span class=\"line\">    index =&gt; [&quot;%&#123;type&#125;-%&#123;+YYYY.MM.dd&#125;&quot;]     #引用input中的type名称，定义输出的格式</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">`启动：`</span><br><span class=\"line\">[root@es-2-zk-log conf.d]# cd /usr/local/logstash-7.13.2/</span><br><span class=\"line\">[root@es-2-zk-log logstash-7.13.2]# nohup bin/logstash -f etc/conf.d/  --config.reload.automatic &amp; </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看日志出现:</span></span><br><span class=\"line\">[root@es-2-zk-log logstash-7.13.2]# tail -f nohup.out</span><br></pre></td></tr></table></figure>\n\n<p>在浏览器中访问本机的nginx网站</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">随便刷新，主要刷新点数据，进行测试</span><br><span class=\"line\">web浏览器访问http://IP地址</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Kafka部署\"><a href=\"#Kafka部署\" class=\"headerlink\" title=\"Kafka部署\"></a>Kafka部署</h2><h2 id=\"1-安装配置jdk8\"><a href=\"#1-安装配置jdk8\" class=\"headerlink\" title=\"1.安装配置jdk8\"></a>1.安装配置jdk8</h2><h2 id=\"（1）Kafka、Zookeeper（简称：ZK）运行依赖jdk8\"><a href=\"#（1）Kafka、Zookeeper（简称：ZK）运行依赖jdk8\" class=\"headerlink\" title=\"（1）Kafka、Zookeeper（简称：ZK）运行依赖jdk8\"></a>（1）Kafka、Zookeeper（简称：ZK）运行依赖jdk8</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">tar zxvf /usr/local/package/jdk-8u121-linux-x64.tar.gz -C /usr/local/</span><br><span class=\"line\">echo &#x27;</span><br><span class=\"line\">JAVA_HOME=/usr/local/jdk1.8.0_121</span><br><span class=\"line\">PATH=$JAVA_HOME/bin:$PATH</span><br><span class=\"line\">export JAVA_HOME PATH</span><br><span class=\"line\">&#x27; &gt;&gt;/etc/profile</span><br><span class=\"line\">source /etc/profile</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-安装配置ZK\"><a href=\"#2-安装配置ZK\" class=\"headerlink\" title=\"2.安装配置ZK\"></a>2.安装配置ZK</h2><p>Kafka运行依赖ZK，Kafka官网提供的tar包中，已经包含了ZK，这里不再额下载ZK程序。</p>\n<p>配置相互解析—三台机器</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-2-zk-log ~]# vim /etc/hosts</span><br><span class=\"line\">192.168.246.234 mes-1</span><br><span class=\"line\">192.168.246.231 es-2-zk-log</span><br><span class=\"line\">192.168.246.235 es-3-head-kib</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（1）安装-1\"><a href=\"#（1）安装-1\" class=\"headerlink\" title=\"（1）安装\"></a>（1）安装</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装kafka软件包，也可在官网搜索下载</span></span><br><span class=\"line\">[root@es-2-zk-log ~]# tar xzvf kafka_2.11-2.1.0.tgz -C /usr/local/</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）配置-1\"><a href=\"#（2）配置-1\" class=\"headerlink\" title=\"（2）配置\"></a>（2）配置</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties</span><br><span class=\"line\">[root@mes-1 ~]# vim /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties  #添加如下配置</span><br><span class=\"line\">dataDir=/opt/data/zookeeper/data </span><br><span class=\"line\">dataLogDir=/opt/data/zookeeper/logs</span><br><span class=\"line\">clientPort=2181 </span><br><span class=\"line\">tickTime=2000 </span><br><span class=\"line\">initLimit=20 </span><br><span class=\"line\">syncLimit=10 </span><br><span class=\"line\">server.1=192.168.246.231:2888:3888       //kafka集群IP:Port</span><br><span class=\"line\">server.2=192.168.246.234:2888:3888</span><br><span class=\"line\">server.3=192.168.246.235:2888:3888</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">直接添加</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">创建data、<span class=\"built_in\">log</span>目录</span></span><br><span class=\"line\">[root@mes-1 ~]# mkdir -p /opt/data/zookeeper/&#123;data,logs&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">创建myid文件</span></span><br><span class=\"line\">[root@mes-1 ~]# echo 1 &gt; /opt/data/zookeeper/data/myid     #myid号按顺序排</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-2-zk-log ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties</span><br><span class=\"line\">[root@es-2-zk-log ~]# vim /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties</span><br><span class=\"line\">dataDir=/opt/data/zookeeper/data </span><br><span class=\"line\">dataLogDir=/opt/data/zookeeper/logs</span><br><span class=\"line\">clientPort=2181 </span><br><span class=\"line\">tickTime=2000 </span><br><span class=\"line\">initLimit=20 </span><br><span class=\"line\">syncLimit=10 </span><br><span class=\"line\">server.1=192.168.246.231:2888:3888</span><br><span class=\"line\">server.2=192.168.246.234:2888:3888</span><br><span class=\"line\">server.3=192.168.246.235:2888:3888</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">以上内容直接添加</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">创建data、<span class=\"built_in\">log</span>目录</span></span><br><span class=\"line\">[root@es-2-zk-log ~]# mkdir -p /opt/data/zookeeper/&#123;data,logs&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">创建myid文件</span></span><br><span class=\"line\">[root@es-2-zk-log ~]# echo 2 &gt; /opt/data/zookeeper/data/myid</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3 ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties</span><br><span class=\"line\">[root@es-3-head-kib ~]# vim /usr/local/kafka_2.11-2.1.0/config/zookeeper.properties</span><br><span class=\"line\">dataDir=/opt/data/zookeeper/data </span><br><span class=\"line\">dataLogDir=/opt/data/zookeeper/logs</span><br><span class=\"line\">clientPort=2181 </span><br><span class=\"line\">tickTime=2000 </span><br><span class=\"line\">initLimit=20 </span><br><span class=\"line\">syncLimit=10 </span><br><span class=\"line\">server.1=192.168.246.231:2888:3888</span><br><span class=\"line\">server.2=192.168.246.234:2888:3888</span><br><span class=\"line\">server.3=192.168.246.235:2888:3888</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">直接添加</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">创建data、<span class=\"built_in\">log</span>目录</span></span><br><span class=\"line\">[root@es-3-head-kib ~]# mkdir -p /opt/data/zookeeper/&#123;data,logs&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">创建myid文件</span></span><br><span class=\"line\">[root@es-3-head-kib ~]# echo 3 &gt; /opt/data/zookeeper/data/myid</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置Kafka\"><a href=\"#配置Kafka\" class=\"headerlink\" title=\"配置Kafka\"></a>配置Kafka</h2><h2 id=\"1）配置\"><a href=\"#1）配置\" class=\"headerlink\" title=\"(1）配置\"></a>(1）配置</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/server.properties</span><br><span class=\"line\">[root@mes-1 ~]# vim /usr/local/kafka_2.11-2.1.0/config/server.properties  #在最后添加</span><br><span class=\"line\">broker.id=1\t\t#需修改</span><br><span class=\"line\">listeners=PLAINTEXT://192.168.246.231:9092\t#需修改本机IP</span><br><span class=\"line\">num.network.threads=3</span><br><span class=\"line\">num.io.threads=8</span><br><span class=\"line\">socket.send.buffer.bytes=102400</span><br><span class=\"line\">socket.receive.buffer.bytes=102400</span><br><span class=\"line\">socket.request.max.bytes=104857600</span><br><span class=\"line\">log.dirs=/opt/data/kafka/logs</span><br><span class=\"line\">num.partitions=6</span><br><span class=\"line\">num.recovery.threads.per.data.dir=1</span><br><span class=\"line\">offsets.topic.replication.factor=2</span><br><span class=\"line\">transaction.state.log.replication.factor=1</span><br><span class=\"line\">transaction.state.log.min.isr=1</span><br><span class=\"line\">log.retention.hours=168</span><br><span class=\"line\">log.segment.bytes=536870912</span><br><span class=\"line\">log.retention.check.interval.ms=300000</span><br><span class=\"line\">zookeeper.connect=192.168.246.231:2181,192.168.246.234:2181,192.168.246.235:2181\t#修改集群的IP</span><br><span class=\"line\">zookeeper.connection.timeout.ms=6000</span><br><span class=\"line\">group.initial.rebalance.delay.ms=0</span><br><span class=\"line\">[root@mes-1 ~]# mkdir -p /opt/data/kafka/logs</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-2-zk-log ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/server.properties</span><br><span class=\"line\">[root@es-2-zk-log ~]# vim /usr/local/kafka_2.11-2.1.0/config/server.properties</span><br><span class=\"line\">broker.id=2\t\t#修改的</span><br><span class=\"line\">listeners=PLAINTEXT://192.168.246.234:9092</span><br><span class=\"line\">num.network.threads=3</span><br><span class=\"line\">num.io.threads=8</span><br><span class=\"line\">socket.send.buffer.bytes=102400</span><br><span class=\"line\">socket.receive.buffer.bytes=102400</span><br><span class=\"line\">socket.request.max.bytes=104857600</span><br><span class=\"line\">log.dirs=/opt/data/kafka/logs</span><br><span class=\"line\">num.partitions=6</span><br><span class=\"line\">num.recovery.threads.per.data.dir=1</span><br><span class=\"line\">offsets.topic.replication.factor=2</span><br><span class=\"line\">transaction.state.log.replication.factor=1</span><br><span class=\"line\">transaction.state.log.min.isr=1</span><br><span class=\"line\">log.retention.hours=168</span><br><span class=\"line\">log.segment.bytes=536870912</span><br><span class=\"line\">log.retention.check.interval.ms=300000</span><br><span class=\"line\">zookeeper.connect=192.168.246.231:2181,192.168.246.234:2181,192.168.246.235:2181</span><br><span class=\"line\">zookeeper.connection.timeout.ms=6000</span><br><span class=\"line\">group.initial.rebalance.delay.ms=0</span><br><span class=\"line\">[root@es-2-zk-log ~]# mkdir -p /opt/data/kafka/logs</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib ~]# sed -i &#x27;s/^[^#]/#&amp;/&#x27; /usr/local/kafka_2.11-2.1.0/config/server.properties</span><br><span class=\"line\">[root@es-3-head-kib ~]# vim /usr/local/kafka_2.11-2.1.0/config/server.properties</span><br><span class=\"line\">broker.id=3</span><br><span class=\"line\">listeners=PLAINTEXT://192.168.246.235:9092</span><br><span class=\"line\">num.network.threads=3</span><br><span class=\"line\">num.io.threads=8</span><br><span class=\"line\">socket.send.buffer.bytes=102400</span><br><span class=\"line\">socket.receive.buffer.bytes=102400</span><br><span class=\"line\">socket.request.max.bytes=104857600</span><br><span class=\"line\">log.dirs=/opt/data/kafka/logs</span><br><span class=\"line\">num.partitions=6</span><br><span class=\"line\">num.recovery.threads.per.data.dir=1</span><br><span class=\"line\">offsets.topic.replication.factor=2</span><br><span class=\"line\">transaction.state.log.replication.factor=1</span><br><span class=\"line\">transaction.state.log.min.isr=1</span><br><span class=\"line\">log.retention.hours=168</span><br><span class=\"line\">log.segment.bytes=536870912</span><br><span class=\"line\">log.retention.check.interval.ms=300000</span><br><span class=\"line\">zookeeper.connect=192.168.246.231:2181,192.168.246.234:2181,192.168.246.235:2181</span><br><span class=\"line\">zookeeper.connection.timeout.ms=6000</span><br><span class=\"line\">group.initial.rebalance.delay.ms=0</span><br><span class=\"line\">[root@es-3-head-kib ~]# mkdir -p /opt/data/kafka/logs</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"启动、验证ZK集群\"><a href=\"#启动、验证ZK集群\" class=\"headerlink\" title=\"启动、验证ZK集群\"></a>启动、验证ZK集群</h2><h2 id=\"（1）启动\"><a href=\"#（1）启动\" class=\"headerlink\" title=\"（1）启动\"></a>（1）启动</h2><p>在三个节点依次执行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 ~]# cd /usr/local/kafka_2.11-2.1.0/</span><br><span class=\"line\">[root@mes-1 kafka_2.11-2.1.0]# nohup bin/zookeeper-server-start.sh config/zookeeper.properties &amp;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）验证\"><a href=\"#（2）验证\" class=\"headerlink\" title=\"（2）验证\"></a>（2）验证</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看端口有没有起来</span></span><br><span class=\"line\">[root@mes-1 ~]# netstat -lntp | grep 2181</span><br><span class=\"line\">tcp6       0      0 :::2181                 :::*                    LISTEN      1226/java</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6、启动、验证Kafka\"><a href=\"#6、启动、验证Kafka\" class=\"headerlink\" title=\"6、启动、验证Kafka\"></a>6、启动、验证Kafka</h2><h2 id=\"（1）启动-1\"><a href=\"#（1）启动-1\" class=\"headerlink\" title=\"（1）启动\"></a>（1）启动</h2><p>在三个节点依次执行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 ~]# cd /usr/local/kafka_2.11-2.1.0/</span><br><span class=\"line\">[root@mes-1 kafka_2.11-2.1.0]# nohup bin/kafka-server-start.sh config/server.properties &amp;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）验证-1\"><a href=\"#（2）验证-1\" class=\"headerlink\" title=\"（2）验证\"></a>（2）验证</h2><p>在192.168.246.231上创建topic</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-2-zk-log kafka_2.11-2.1.0]# bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic testtopic</span><br><span class=\"line\">Created topic &quot;testtopic&quot;.</span><br><span class=\"line\"></span><br><span class=\"line\">参数解释：</span><br><span class=\"line\">–zookeeper指定zookeeper的地址和端口，</span><br><span class=\"line\">–partitions指定partition的数量，</span><br><span class=\"line\">–replication-factor指定数据副本的数量</span><br></pre></td></tr></table></figure>\n\n<p>在246.235上面查询192.168.246.231上的topic</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib kafka_2.11-2.1.0]# bin/kafka-topics.sh --zookeeper 192.168.246.231:2181 --list</span><br><span class=\"line\">testtopic</span><br></pre></td></tr></table></figure>\n\n<p>模拟消息生产和消费<br>发送消息到192.168.246.231</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@mes-1 kafka_2.11-2.1.0]# bin/kafka-console-producer.sh --broker-list 192.168.246.231:9092 --topic testtopic</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">hello</span></span><br></pre></td></tr></table></figure>\n\n<p>从192.168.246.234接受消息</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-2-zk-log kafka_2.11-2.1.0]# bin/kafka-console-consumer.sh --bootstrap-server  192.168.246.234:9092 --topic testtopic --from-beginning</span><br><span class=\"line\">hello</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"修改logstash配置文件\"><a href=\"#修改logstash配置文件\" class=\"headerlink\" title=\"修改logstash配置文件\"></a>修改logstash配置文件</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">先关闭logstash，再修改配置文件---关闭进程</span></span><br><span class=\"line\">[root@es-2-zk-log ~]# ps -ef |grep logstash</span><br><span class=\"line\">[root@es-2-zk-log ~]# kill -9 进程号</span><br><span class=\"line\"></span><br><span class=\"line\">kafka没有问题之后，回到logstash服务器：</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">安装完kafka之后的操作：</span></span><br><span class=\"line\">[root@es-2-zk-log ~]# cd /usr/local/logstash-6.5.4/etc/conf.d/</span><br><span class=\"line\">[root@es-2-zk-log conf.d]# cp input.conf input.conf.bak</span><br><span class=\"line\">[root@es-2-zk-log conf.d]# vim input.conf</span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">kafka &#123;               #指定kafka服务</span><br><span class=\"line\">    type =&gt; &quot;nginx_log&quot;</span><br><span class=\"line\">    codec =&gt; &quot;json&quot;        #通用选项，用于输入数据的编解码器</span><br><span class=\"line\">    topics =&gt; &quot;nginx&quot;        #这里定义的topic</span><br><span class=\"line\">    decorate_events =&gt; true  #会将当前topic信息也带到message中</span><br><span class=\"line\">    bootstrap_servers =&gt; &quot;192.168.246.234:9092, 192.168.246.231:9092, 192.168.246.235:9092&quot;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"></span><br><span class=\"line\">`启动 logstash`</span><br><span class=\"line\">[root@es-2-zk-log conf.d]# cd /usr/local/logstash-6.5.4/</span><br><span class=\"line\">[root@es-2-zk-log logstash-6.5.4]# nohup bin/logstash -f etc/conf.d/  --config.reload.automatic &amp;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Filebeat-部署\"><a href=\"#Filebeat-部署\" class=\"headerlink\" title=\"Filebeat 部署\"></a>Filebeat 部署</h2><h2 id=\"（1）下载\"><a href=\"#（1）下载\" class=\"headerlink\" title=\"（1）下载\"></a>（1）下载</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.13.2-linux-x86_64.tar.gz</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）解压\"><a href=\"#（2）解压\" class=\"headerlink\" title=\"（2）解压\"></a>（2）解压</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@es-3-head-kib ~]</span><span class=\"comment\"># tar xzvf filebeat-6.5.4-linux-x86_64.tar.gz -C /usr/local/</span></span><br><span class=\"line\"><span class=\"section\">[root@es-3-head-kib ~]</span><span class=\"comment\"># cd /usr/local/</span></span><br><span class=\"line\"><span class=\"section\">[root@es-3-head-kib local]</span><span class=\"comment\"># mv filebeat-6.5.4-linux-x86_64 filebeat</span></span><br><span class=\"line\"><span class=\"section\">[root@es-3-head-kib local]</span><span class=\"comment\"># cd filebeat/</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（3）修改配置\"><a href=\"#（3）修改配置\" class=\"headerlink\" title=\"（3）修改配置\"></a>（3）修改配置</h2><p>修改 Filebeat 配置，支持收集本地目录日志，并输出日志到 Kafka 集群中</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib filebeat]# mv filebeat.yml filebeat.yml.bak</span><br><span class=\"line\">[root@es-3-head-kib filebeat]# vim filebeat.yml</span><br><span class=\"line\">filebeat.inputs:</span><br><span class=\"line\">- type: log   #指定输入类型</span><br><span class=\"line\">  enable: true</span><br><span class=\"line\">  paths:</span><br><span class=\"line\">    -  /var/log/nginx/*.log  #日志路径</span><br><span class=\"line\"></span><br><span class=\"line\">output.kafka:   </span><br><span class=\"line\">  hosts: [&quot;192.168.246.234:9092&quot;,&quot;192.168.246.231:9092&quot;,&quot;192.168.246.235:9092&quot;]   #kafka服务器</span><br><span class=\"line\">  topic: &#x27;nginx&#x27;        #输出到kafka中的topic</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（4）启动\"><a href=\"#（4）启动\" class=\"headerlink\" title=\"（4）启动\"></a>（4）启动</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@es-3-head-kib filebeat]# nohup ./filebeat -e -c filebeat.yml &amp; </span><br><span class=\"line\">[root@es-3-head-kib filebeat]# tail -f nohup.out </span><br><span class=\"line\">2019-08-04T16:55:54.708+0800\tINFO\tkafka/log.go:53\tkafka message: client/metadata found some partitions to be leaderless</span><br><span class=\"line\">2019-08-04T16:55:54.708+0800\tINFO\tkafka/log.go:53\tclient/metadata retrying after 250ms... (2 attempts remaining)</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">验证kafka是否生成topic</span><br><span class=\"line\">[root@es-3-head-kib filebeat]# cd /usr/local/kafka_2.11-2.1.0/</span><br><span class=\"line\">[root@es-3-head-kib kafka_2.11-2.1.0]# bin/kafka-topics.sh --zookeeper 192.168.246.231:2181 --list</span><br><span class=\"line\">__consumer_offsets</span><br><span class=\"line\">nginx     #已经生成topic</span><br><span class=\"line\">testtopic</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试-2\"><a href=\"#测试-2\" class=\"headerlink\" title=\"测试\"></a>测试</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">浏览filebeat机器的IP地址，和浏览filebeat机器的IP地址+9100端口</span><br><span class=\"line\"></span><br><span class=\"line\">web界面步骤</span><br><span class=\"line\">点击发现--创建索引模式--创建索引--再点左上角的3横杠里面的发现--这时候就可以看到创建好的索引了</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","ELK"]},{"title":"EMQX集群部署","url":"/2025/11/05/EMQX%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","content":"<h3 id=\"emqx–集群\"><a href=\"#emqx–集群\" class=\"headerlink\" title=\"emqx–集群\"></a>emqx–集群</h3><h4 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h4><p>EMQX（Erlang MQTT Broker）是一个高性能、可扩展的开源 MQTT 消息代理服务器。它基于 Erlang&#x2F;OTP 开发，专为大规模物联网（IoT）应用设计。EMQX 的核心作用和功能如下：</p>\n<ol>\n<li><strong>消息代理</strong>：EMQX 作为 MQTT 消息代理，负责在发布者和订阅者之间路由消息。它支持 MQTT 协议的所有功能，包括 QoS（Quality of Service）级别、持久会话和遗嘱消息等。</li>\n<li><strong>设备连接管理</strong>：EMQX 可以管理大量 IoT 设备的连接，支持数百万级别的并发连接，适用于大规模的物联网应用。</li>\n<li><strong>数据分发</strong>：EMQX 能够高效地分发数据，确保消息在发布者和订阅者之间的快速传递，支持多种消息格式和传输协议。</li>\n<li><strong>扩展性</strong>：EMQX 支持插件机制，用户可以根据需求扩展其功能，如数据持久化、规则引擎、认证和授权等。</li>\n</ol>\n<p><strong>主要功能</strong></p>\n<ol>\n<li><p><strong>支持多种协议</strong></p>\n<ul>\n<li><strong>MQTT&#x2F;MQTT-SN</strong>：原生支持 MQTT 3.1.1 和 MQTT 5.0 协议。</li>\n<li><strong>HTTP&#x2F;HTTPS</strong>：支持通过 HTTP&#x2F;HTTPS 协议进行消息发布和订阅。</li>\n<li><strong>CoAP</strong>：支持 Constrained Application Protocol（CoAP），适用于资源受限的设备。</li>\n<li><strong>WebSocket</strong>：支持通过 WebSocket 进行 MQTT 通信，方便 Web 应用集成。</li>\n</ul>\n</li>\n<li><p><strong>高性能和高可用性</strong></p>\n<ul>\n<li><strong>高并发连接</strong>：支持数百万级别的并发连接，适用于大规模 IoT 部署。</li>\n<li><strong>集群支持</strong>：支持集群部署，提供高可用性和负载均衡。</li>\n<li><strong>水平扩展</strong>：可以通过增加节点来扩展系统容量。</li>\n</ul>\n</li>\n<li><p><strong>安全性</strong></p>\n<ul>\n<li><strong>认证和授权</strong>：支持多种认证方式（如用户名&#x2F;密码、客户端证书、LDAP 等）和细粒度的访问控制。</li>\n<li><strong>加密通信</strong>：支持 TLS&#x2F;SSL 加密，确保数据传输的安全性。</li>\n</ul>\n</li>\n<li><p><strong>规则引擎</strong></p>\n<ul>\n<li><strong>数据处理</strong>：内置规则引擎，可以根据预定义的规则对消息进行处理、过滤和转发。</li>\n<li><strong>集成外部系统</strong>：支持与数据库、消息队列、HTTP 服务等外部系统集成。</li>\n</ul>\n</li>\n<li><p><strong>监控和管理</strong></p>\n<ul>\n<li><strong>管理控制台</strong>：提供友好的 Web 管理控制台，方便用户进行配置和管理。</li>\n<li><strong>监控和告警</strong>：支持实时监控系统状态和性能，提供告警机制。</li>\n</ul>\n</li>\n</ol>\n<p><strong>典型应用场景</strong></p>\n<ol>\n<li><strong>智能家居</strong>：管理和控制大量智能家居设备，实现设备间的消息通信和数据共享。</li>\n<li><strong>工业物联网</strong>：在工业环境中，管理各种传感器和设备的数据采集和传输。</li>\n<li><strong>车联网</strong>：支持车辆与云端的实时通信，管理车辆数据和远程控制。</li>\n<li><strong>智慧城市</strong>：管理城市基础设施（如路灯、交通信号灯、环境监测设备等）的数据通信。</li>\n</ol>\n<h4 id=\"资源需求\"><a href=\"#资源需求\" class=\"headerlink\" title=\"资源需求\"></a>资源需求</h4><ul>\n<li><strong>CPU</strong>: 4 核 </li>\n<li><strong>内存</strong>:  8 GB </li>\n<li><strong>存储</strong>: 300G</li>\n<li><strong>节点</strong>：2</li>\n</ul>\n<h4 id=\"网络端口\"><a href=\"#网络端口\" class=\"headerlink\" title=\"网络端口\"></a>网络端口</h4><ol>\n<li><strong>默认管理端口</strong><ul>\n<li><strong>端口号</strong>: 18083</li>\n<li><strong>用途</strong>: EMQX Dashboard（管理控制台）端口，用于管理和监控 EMQX。</li>\n</ul>\n</li>\n<li><strong>MQTT 端口</strong><ul>\n<li><strong>端口号</strong>: 1883</li>\n<li><strong>用途</strong>: MQTT 协议默认端口，用于客户端连接。</li>\n</ul>\n</li>\n<li><strong>MQTT&#x2F;TLS 端口</strong><ul>\n<li><strong>端口号</strong>: 8883</li>\n<li><strong>用途</strong>: 使用 TLS&#x2F;SSL 加密的 MQTT 连接端口。</li>\n</ul>\n</li>\n<li><strong>WebSocket 端口</strong><ul>\n<li><strong>端口号</strong>: 8083</li>\n<li><strong>用途</strong>: 支持 WebSocket 的 MQTT 连接端口。</li>\n</ul>\n</li>\n<li><strong>WebSocket&#x2F;TLS 端口</strong><ul>\n<li><strong>端口号</strong>: 8084</li>\n<li><strong>用途</strong>: 使用 TLS&#x2F;SSL 加密的 WebSocket 连接端口。</li>\n</ul>\n</li>\n<li><strong>集群通信端口</strong><ul>\n<li><strong>端口号</strong>: 4369, 6000-6999</li>\n<li><strong>用途</strong>: EMQX 集群节点之间的通信端口。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h4><pre><code># 下载安装包\nwget https://www.emqx.com/zh/downloads/broker/5.7.0/emqx-5.7.0-el7-amd64.tar.gz\n\nmkdir -p /data/emqx/data\n# 创建目录、解压\nmkdir -p /data/emqx/data &amp;&amp; tar -zxvf emqx-5.7.0-el7-amd64.tar.gz -C /data/emqx\n# 编辑配置文件\ncd /data/emqx\nvim etc/emqx.conf\n# 将原有的改为以下内容--在每个节点上添加更改，更后按顺序启动\nnode &#123;\n  name = &quot;emqx@10.100.40.171&quot;     # 本机IP\n  cookie = &quot;emqxsecretcookie&quot;\n  data_dir = &quot;/data/emqx/data&quot;     # 数据存放目录\n&#125;\n\ncluster &#123;\n  name = emqxcl\n  discovery_strategy = manual\n  static &#123;\n    seeds = [\n      &quot;emqx@10.100.40.171&quot;,     # 添加集群\n      &quot;emqx@10.100.40.172&quot;\n    ]\n  &#125;\n&#125;\n\n# 启动\n./emqx/bin/emqx start\n\n# 加入集群--在从机器上操作\ncd /data/emqx\n./bin/emqx_ctl cluster join emqx@10.100.40.172      # 在从机器上操作，写主节点的IP\n\n# 验证--在主机器上操作，查看状态\n./bin/emqx_ctl cluster status\n\n# 验证数据目录路径\n[root@emqx01 data]# grep &#39;data_dir&#39; /data/emqx/etc/emqx.conf\n  data_dir = &quot;/data/emqx/data&quot;\n\n# 访问\n10.1.15.101:18083\t\t默认账号: admin 默认密码：public\n10.1.15.102:18083\t\t默认账号: admin 默认密码：public\n</code></pre>\n","categories":["operations"],"tags":["Linux","EMQX"]},{"title":"Git使用以及推送代码到Github","url":"/2025/01/09/Git%E4%BD%BF%E7%94%A8%E4%BB%A5%E5%8F%8A%E6%8E%A8%E9%80%81%E4%BB%A3%E7%A0%81%E5%88%B0Github/","content":"<h1 id=\"Git使用以及推送代码到Github\"><a href=\"#Git使用以及推送代码到Github\" class=\"headerlink\" title=\"Git使用以及推送代码到Github\"></a>Git使用以及推送代码到Github</h1><p>GIT使用<br>创建Github账户。打开 <a href=\"https://github.com/\">https://github.com</a> 并注册一个新账户。</p>\n<h3 id=\"1-注册与安装\"><a href=\"#1-注册与安装\" class=\"headerlink\" title=\"1. 注册与安装\"></a>1. 注册与安装</h3><p>安装Git。如果您的系统尚未安装Git，则需要先安装它。可以参考Git官方文档以获取更多详细信息。</p>\n<p>配置Git用户名和电子邮件地址。在终端或命令提示符窗口中，运行以下命令以设置您的Git用户名和电子邮件地址：</p>\n<p>安装git后需要设置github用户名以及邮箱,内容替换成自己的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git config --global user.name &quot;Your Name&quot;</span><br><span class=\"line\">git config --global user.email &quot;youremail@example.com&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"2-配置Git用户名和邮箱\"><a href=\"#2-配置Git用户名和邮箱\" class=\"headerlink\" title=\"2. 配置Git用户名和邮箱\"></a>2. 配置Git用户名和邮箱</h3><p>首先要有本地仓库</p>\n<p>在Github上创建一个新的代码仓库</p>\n<p>从终端命令行中进入本地代码仓库目录，并初始化仓库：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git init</span><br></pre></td></tr></table></figure>\n<h3 id=\"3-初始化本地仓库\"><a href=\"#3-初始化本地仓库\" class=\"headerlink\" title=\"3. 初始化本地仓库\"></a>3. 初始化本地仓库</h3><p>将您的代码添加到本地仓库缓冲区：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git add .</span><br></pre></td></tr></table></figure>\n<p>为Github分配一个远程仓库：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git remote add origin https://github.com/username/repo.git</span><br></pre></td></tr></table></figure>\n<h3 id=\"4-分支管理\"><a href=\"#4-分支管理\" class=\"headerlink\" title=\"4. 分支管理\"></a>4. 分支管理</h3><p>查看本地分支</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git branch</span><br></pre></td></tr></table></figure>\n<p>该命令会列出当前本地仓库中存在的所有分支，并用星号标识当前所在的分支。例如，以下是一个示例输出：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">* main</span><br><span class=\"line\">  feature-1</span><br><span class=\"line\">  feature-2</span><br></pre></td></tr></table></figure>\n<p>查看远程分支：<br>查看远程分支</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git branch -r</span><br></pre></td></tr></table></figure>\n<p>创建分支</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git checkout -b new-branch</span><br></pre></td></tr></table></figure>\n<p>将本地仓库推送到 GitHub 上，需要使用 git push 命令，并指定远程仓库的名称和分支名称。具体命令如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git push origin master:master      #例如，将本地的 master 分支推送到 GitHub 上的 origin 仓库的 master 分支</span><br><span class=\"line\">git push &lt;远程仓库名称&gt; &lt;本地分支名称&gt;:&lt;远程分支名称&gt;</span><br></pre></td></tr></table></figure>\n<p>设置仓库名称</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git remote add &lt;远程仓库名称&gt; &lt;远程仓库 URL&gt;</span><br></pre></td></tr></table></figure>\n<p>例如，如果你想要将一个 GitHub 仓库添加到本地仓库，并将其命名为 myrepo，可以使用以下命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git remote add myrepo https://github.com/username/myrepo.git</span><br></pre></td></tr></table></figure>\n<p>添加完成后，你就可以使用 git push 命令将本地分支推送到该远程仓库，命令如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git push myrepo &lt;本地分支名称&gt;:&lt;远程分支名称&gt;</span><br></pre></td></tr></table></figure>\n<p>删除分支</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git branch -d &lt;branch-name&gt;</span><br></pre></td></tr></table></figure>\n<p>其中，branch-name是要删除的分支名称。需要注意的是，如果该分支包含未合并的更改，则删除分支时会出现错误。这时需要使用“-D”选项强制删除分支。</p>\n<p>删除远程分支</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git push origin --delete test</span><br></pre></td></tr></table></figure>\n<p>切换分支</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git checkout &lt;branch-name&gt; #其中，“&lt;branch-name&gt;”是要切换到的分支名称。</span><br></pre></td></tr></table></figure>\n<p>创建新分支并切换到该分支</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git checkout -b new-feature</span><br></pre></td></tr></table></figure>\n<p>分支合并<br>首先，需要切换到要合并的目标分支上，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git checkout target-branch</span><br></pre></td></tr></table></figure>\n<p>然后，使用 git merge 命令将源分支合并到目标分支上，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git merge source-branch</span><br></pre></td></tr></table></figure>\n<p>查看git状态</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git status</span><br></pre></td></tr></table></figure>\n<p>比较文件的不同，即暂存区和工作区的差异。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git diff</span><br></pre></td></tr></table></figure>\n<p>连接远程仓库并且命名<br>您可以使用以下命令在 Git 中为仓库设置名称：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git remote add &lt;remote name&gt; &lt;remote repository URL&gt;</span><br></pre></td></tr></table></figure>\n<p>请将 <remote name> 替换为您想要设置的名称，<remote repository URL> 替换为您的远程仓库的 URL。例如，如果您想将远程仓库的名称设置为 origin，则可以使用以下命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git remote add origin &lt;remote repository URL&gt;</span><br></pre></td></tr></table></figure>\n<p>**请注意，这只是将远程仓库的名称设置为 origin，您可以将其替换为您想要的任何名称</p>\n<p>重新命名仓库<br>您可以使用以下命令在 Git 中为仓库重命名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git remote rename &lt;old name&gt; &lt;new name&gt;</span><br></pre></td></tr></table></figure>\n<p>请将 <old name> 替换为您想要重命名的旧名称，<new name> 替换为您想要设置的新名称。例如，如果您想将远程仓库的名称从 origin 改为 new-origin，则可以使用以下命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git remote rename origin new-origin</span><br></pre></td></tr></table></figure>\n<p>请注意，这只是将远程仓库的名称从 origin 改为 new-origin，您可以将其替换为您想要的任何名称。</p>\n<p>推送到GITHUB<br>提交你的更改</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git commit -m &quot;your commit message&quot;</span><br></pre></td></tr></table></figure>\n<p>拉取远程仓库中最新的更改：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git pull origin main</span><br></pre></td></tr></table></figure>\n<p>推送代码更改到Github仓库：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git push origin main    #main是分支，更改到你需要提交的分支也行</span><br></pre></td></tr></table></figure>\n<p>提交到hero并且对更改进行描述</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git commit -m &quot;描述&quot;</span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Git"]},{"title":"Grafana和Prometheus的部署安装","url":"/2025/11/06/Grafana%E5%92%8CPrometheus%E7%9A%84%E9%83%A8%E7%BD%B2%E5%AE%89%E8%A3%85/","content":"<h1 id=\"Grafana和Prometheus的搭建\"><a href=\"#Grafana和Prometheus的搭建\" class=\"headerlink\" title=\"Grafana和Prometheus的搭建\"></a>Grafana和Prometheus的搭建</h1><h2 id=\"服务端\"><a href=\"#服务端\" class=\"headerlink\" title=\"服务端\"></a>服务端</h2><h2 id=\"首先搭建Prometheus-服务端\"><a href=\"#首先搭建Prometheus-服务端\" class=\"headerlink\" title=\"首先搭建Prometheus 服务端\"></a>首先搭建Prometheus 服务端</h2><p><code>在官网下载</code></p>\n<h2 id=\"或者也可以在我的云盘直接下载\"><a href=\"#或者也可以在我的云盘直接下载\" class=\"headerlink\" title=\"或者也可以在我的云盘直接下载\"></a>或者也可以在我的云盘直接下载</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/prometheus-Grafana/prometheus-2.47.2.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"下载到服务器后解压出来\"><a href=\"#下载到服务器后解压出来\" class=\"headerlink\" title=\"下载到服务器后解压出来\"></a>下载到服务器后解压出来</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># tar xvf prometheus-2.47.2.linux-amd64.tar.gz -C /usr/local/prometheus</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># cd /usr/local/prometheus</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost prometheus]</span><span class=\"comment\"># useradd prometheus -s /usr/sbin/nologin</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost prometheus]</span><span class=\"comment\"># chown -R prometheus.prometheus ./*</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"进入目录后编辑配置文件，需要改动的是最后几行，是添加其他节点以及主机的\"><a href=\"#进入目录后编辑配置文件，需要改动的是最后几行，是添加其他节点以及主机的\" class=\"headerlink\" title=\"进入目录后编辑配置文件，需要改动的是最后几行，是添加其他节点以及主机的\"></a>进入目录后编辑配置文件，需要改动的是最后几行，是添加其他节点以及主机的</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># cd /usr/local/prometheus/</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost prometheus]</span><span class=\"comment\"># vim prometheus.yml</span></span><br><span class=\"line\"> - job_name: &quot;prometheus&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># metrics_path defaults to &#x27;/metrics&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class=\"line\"></span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      - targets: <span class=\"section\">[&quot;10.31.162.39:9100&quot;]</span>\t\t<span class=\"comment\">#更改成自己的IP地址，端口改为9100</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"启动查看测试\"><a href=\"#启动查看测试\" class=\"headerlink\" title=\"启动查看测试\"></a>启动查看测试</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@localhost prometheus]</span><span class=\"comment\"># ./prometheus //启动后查看9090端口的服务里面tag里面有几台机器</span></span><br><span class=\"line\"></span><br><span class=\"line\">测试</span><br><span class=\"line\">在浏览器输入IP：9090 -- 会出来prometheus的界面</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"然后写service服务文件，让其可以通过systemctl控制他-配置文件路径改成自己的\"><a href=\"#然后写service服务文件，让其可以通过systemctl控制他-配置文件路径改成自己的\" class=\"headerlink\" title=\"然后写service服务文件，让其可以通过systemctl控制他,配置文件路径改成自己的\"></a>然后写service服务文件，让其可以通过systemctl控制他,配置文件路径改成自己的</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">service文件要存放在/etc/systemd/system目录下    </span><br><span class=\"line\"><span class=\"section\">[root@localhost prometheus]</span><span class=\"comment\"># cd /etc/systemd/system</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost system]</span><span class=\"comment\"># vim prometheus.service</span></span><br><span class=\"line\"><span class=\"section\">[Unit]</span></span><br><span class=\"line\"><span class=\"attr\">Description</span>=prometheus</span><br><span class=\"line\"><span class=\"attr\">After</span>=network.target </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[Service]</span></span><br><span class=\"line\"><span class=\"attr\">User</span>=prometheus</span><br><span class=\"line\"><span class=\"attr\">Group</span>=prometheus</span><br><span class=\"line\"><span class=\"attr\">WorkingDirectory</span>=/usr/local/prometheus</span><br><span class=\"line\"><span class=\"attr\">ExecStart</span>=/usr/local/prometheus/prometheus</span><br><span class=\"line\"><span class=\"section\">[Install]</span></span><br><span class=\"line\"><span class=\"attr\">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"重载服务，尝试用systemctl控制他开启\"><a href=\"#重载服务，尝试用systemctl控制他开启\" class=\"headerlink\" title=\"重载服务，尝试用systemctl控制他开启\"></a>重载服务，尝试用systemctl控制他开启</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">➜ systemctl daemon-reload</span><br><span class=\"line\">➜ systemctl start prometheus.service</span><br><span class=\"line\">➜ systemctl enable prometheus.service</span><br><span class=\"line\">➜ systemctl status prometheus.service</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装-node-exporter\"><a href=\"#安装-node-exporter\" class=\"headerlink\" title=\"安装 node_exporter\"></a>安装 node_exporter</h2><p><strong>接下来安装node节点，统一采用docker方式安装，没什么因为快。</strong></p>\n<h2 id=\"先安装docker环境\"><a href=\"#先安装docker环境\" class=\"headerlink\" title=\"先安装docker环境\"></a>先安装docker环境</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">sudo yum remove docker \\</span><br><span class=\"line\">                  docker-client \\</span><br><span class=\"line\">                  docker-client-latest \\</span><br><span class=\"line\">                  docker-common \\</span><br><span class=\"line\">                  docker-latest \\</span><br><span class=\"line\">                  docker-latest-logrotate \\</span><br><span class=\"line\">                  docker-logrotate \\</span><br><span class=\"line\">                  docker-engine</span><br><span class=\"line\">                  </span><br><span class=\"line\">sudo yum install -y yum-utils</span><br><span class=\"line\">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class=\"line\">sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br><span class=\"line\">yum -y install docker-compose</span><br><span class=\"line\">sudo systemctl start docker</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置docker-compose-yml文件\"><a href=\"#配置docker-compose-yml文件\" class=\"headerlink\" title=\"配置docker-compose.yml文件\"></a>配置docker-compose.yml文件</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">yml文件要在prometheus目录下的data目录里面</span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># cd /usr/local/prometheus/data/</span></span><br><span class=\"line\">version: &#x27;3.8&#x27;</span><br><span class=\"line\">services:</span><br><span class=\"line\">  grafana:</span><br><span class=\"line\">    image: grafana/grafana-enterprise</span><br><span class=\"line\">    container_name: grafana</span><br><span class=\"line\">    restart: alway</span><br><span class=\"line\">    user: &#x27;0&#x27;</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - &#x27;3000:3000&#x27;</span><br><span class=\"line\">    <span class=\"comment\"># adding the mount volume point which we create earlier</span></span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - &#x27;./data:/var/lib/grafana&#x27; //和当前docker-compose文件放在一起的data下</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"拉取\"><a href=\"#拉取\" class=\"headerlink\" title=\"拉取\"></a>拉取</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker pull prom/node-exporter</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"一条命令启动\"><a href=\"#一条命令启动\" class=\"headerlink\" title=\"一条命令启动\"></a>一条命令启动</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker run -d --name node <span class=\"attr\">--restart</span>=always -p <span class=\"number\">9100</span>:<span class=\"number\">9100</span> prom/node-exporter</span><br><span class=\"line\"></span><br><span class=\"line\">直接映射到9100端口了，可以打开看一下测试页，因为是node没有其他东西正常只要在server端添加到配置文件就行了</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装-Grafana\"><a href=\"#安装-Grafana\" class=\"headerlink\" title=\"安装 Grafana\"></a>安装 Grafana</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker run -d <span class=\"attr\">--name</span>=grafana -p <span class=\"number\">3000</span>:<span class=\"number\">3000</span> grafana/grafana</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#如果需要保持到卷里面,直接用这个(二选一)</span></span><br><span class=\"line\">docker run -d -p 3000:3000 <span class=\"attr\">--name</span>=grafana \\</span><br><span class=\"line\">  --volume grafana-storage:/var/lib/grafana \\</span><br><span class=\"line\">  grafana/grafana-enterprise</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p><code>在浏览器中输入IP：3000</code><strong>grafana的界面就出来了，此时配置成功</strong></p>\n","categories":["operations"],"tags":["Linux","Prometheus"]},{"title":"K8S部署nacos服务","url":"/2025/11/06/K8S%E9%83%A8%E7%BD%B2nacos%E6%9C%8D%E5%8A%A1/","content":"<h1 id=\"K8S部署nacos服务\"><a href=\"#K8S部署nacos服务\" class=\"headerlink\" title=\"K8S部署nacos服务\"></a>K8S部署nacos服务</h1><h2 id=\"prod环境\"><a href=\"#prod环境\" class=\"headerlink\" title=\"prod环境\"></a>prod环境</h2><h3 id=\"prod数据库使用的端口3306的数据库\"><a href=\"#prod数据库使用的端口3306的数据库\" class=\"headerlink\" title=\"prod数据库使用的端口3306的数据库\"></a>prod数据库使用的端口3306的数据库</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> ~]<span class=\"comment\"># mkdir nacos &amp;&amp; cd nacos</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nacos]<span class=\"comment\"># vim nacos-service.yaml</span></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nacos-prod</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: nacos-prod</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: <span class=\"number\">8848</span></span><br><span class=\"line\">      name: server</span><br><span class=\"line\">      targetPort: <span class=\"number\">8848</span></span><br><span class=\"line\">      nodePort: <span class=\"number\">31048</span></span><br><span class=\"line\">    - port: <span class=\"number\">9848</span></span><br><span class=\"line\">      name: client-rpc</span><br><span class=\"line\">      targetPort: <span class=\"number\">9848</span></span><br><span class=\"line\">    - port: <span class=\"number\">9849</span></span><br><span class=\"line\">      name: raft-rpc</span><br><span class=\"line\">      targetPort: <span class=\"number\">9849</span></span><br><span class=\"line\">    <span class=\"comment\">## 兼容1.4.x版本的选举端口</span></span><br><span class=\"line\">    - port: <span class=\"number\">7848</span></span><br><span class=\"line\">      name: old-raft-rpc</span><br><span class=\"line\">      targetPort: <span class=\"number\">7848</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: nacos-prod</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nacos-cm</span><br><span class=\"line\">data:</span><br><span class=\"line\">  mysql.db.name: <span class=\"string\">&quot;nacos_prod&quot;</span></span><br><span class=\"line\">  mysql.port: <span class=\"string\">&quot;3306&quot;</span></span><br><span class=\"line\">  mysql.user: <span class=\"string\">&quot;nacos&quot;</span></span><br><span class=\"line\">  mysql.password: <span class=\"string\">&quot;nacos&quot;</span></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nacos-prod</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: <span class=\"number\">1</span></span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: nacos-prod</span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        pod.alpha.kubernetes.io/initialized: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      affinity:</span><br><span class=\"line\">        podAntiAffinity:</span><br><span class=\"line\">          requiredDuringSchedulingIgnoredDuringExecution:</span><br><span class=\"line\">            - labelSelector:</span><br><span class=\"line\">                matchExpressions:</span><br><span class=\"line\">                  - key: <span class=\"string\">&quot;app&quot;</span></span><br><span class=\"line\">                    operator: In</span><br><span class=\"line\">                    <span class=\"keyword\">values</span>:</span><br><span class=\"line\">                      - nacos-prod</span><br><span class=\"line\">              topologyKey: <span class=\"string\">&quot;kubernetes.io/hostname&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#     tolerations:             # 添加的容忍污点，到下面300结束</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: k8snacos</span><br><span class=\"line\">          imagePullPolicy: Always</span><br><span class=\"line\">          image: nacos/nacos-server:latest</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            requests:</span><br><span class=\"line\">              memory: <span class=\"string\">&quot;1Gi&quot;</span></span><br><span class=\"line\">              cpu: <span class=\"string\">&quot;500m&quot;</span></span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: <span class=\"number\">8848</span></span><br><span class=\"line\">              name: client</span><br><span class=\"line\">            - containerPort: <span class=\"number\">9848</span></span><br><span class=\"line\">              name: client-rpc</span><br><span class=\"line\">            - containerPort: <span class=\"number\">9849</span></span><br><span class=\"line\">              name: raft-rpc</span><br><span class=\"line\">            - containerPort: <span class=\"number\">7848</span></span><br><span class=\"line\">              name: old-raft-rpc</span><br><span class=\"line\">          env:</span><br><span class=\"line\">            - name: NACOS_REPLICAS</span><br><span class=\"line\">              value: <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">            - name: MYSQL_SERVICE_DB_NAME</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                configMapKeyRef:</span><br><span class=\"line\">                  name: nacos-cm</span><br><span class=\"line\">                  key: mysql.db.name</span><br><span class=\"line\">            - name: MYSQL_SERVICE_PORT</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                configMapKeyRef:</span><br><span class=\"line\">                  name: nacos-cm</span><br><span class=\"line\">                  key: mysql.port</span><br><span class=\"line\">            - name: MYSQL_SERVICE_USER</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                configMapKeyRef:</span><br><span class=\"line\">                  name: nacos-cm</span><br><span class=\"line\">                  key: mysql.user</span><br><span class=\"line\">            - name: MYSQL_SERVICE_PASSWORD</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                configMapKeyRef:</span><br><span class=\"line\">                  name: nacos-cm</span><br><span class=\"line\">                  key: mysql.password</span><br><span class=\"line\">            - name: NACOS_SERVER_PORT</span><br><span class=\"line\">              value: <span class=\"string\">&quot;8848&quot;</span></span><br><span class=\"line\">            - name: NACOS_APPLICATION_PORT</span><br><span class=\"line\">              value: <span class=\"string\">&quot;8848&quot;</span></span><br><span class=\"line\">            - name: PREFER_HOST_MODE</span><br><span class=\"line\">              value: <span class=\"string\">&quot;hostname&quot;</span></span><br><span class=\"line\">            - name: MODE</span><br><span class=\"line\">              value: <span class=\"string\">&quot;standalone&quot;</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: nacos-prod</span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"comment\"># 查看pod,发现处于Runing状态，并在node01的节点上，端口为31048</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nacos]<span class=\"comment\"># kubectl get po -o wide</span></span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS   AGE    IP           NODE     NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">nacos-prod-55487457cd-vpjkn   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          6m7s   <span class=\"number\">10.244</span>.<span class=\"number\">1.3</span>   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nacos]<span class=\"comment\"># kubectl get svc</span></span><br><span class=\"line\">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                                                       AGE</span><br><span class=\"line\">kubernetes   ClusterIP   <span class=\"number\">10.96</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>       &lt;none&gt;        <span class=\"number\">443</span>/TCP                                                       7d23h</span><br><span class=\"line\">nacos-prod   NodePort    <span class=\"number\">10.102</span><span class=\"number\">.139</span><span class=\"number\">.65</span>   &lt;none&gt;        <span class=\"number\">8848</span>:<span class=\"number\">31048</span>/TCP,<span class=\"number\">9848</span>:<span class=\"number\">31522</span>/TCP,<span class=\"number\">9849</span>:<span class=\"number\">32267</span>/TCP,<span class=\"number\">7848</span>:<span class=\"number\">31939</span>/TCP   43s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 访问</span></span><br><span class=\"line\">http:<span class=\"regexp\">//</span>IP + <span class=\"number\">31048</span>/nacos\t\t\t<span class=\"comment\"># 端口是yaml文件定义的，可以自已定义</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试环境\"><a href=\"#测试环境\" class=\"headerlink\" title=\"测试环境\"></a>测试环境</h2><h3 id=\"需要创建NFS，不然pod起不来\"><a href=\"#需要创建NFS，不然pod起不来\" class=\"headerlink\" title=\"需要创建NFS，不然pod起不来\"></a>需要创建NFS，不然pod起不来</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: mysql-dev</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: <span class=\"number\">3306</span></span><br><span class=\"line\">      nodePort: <span class=\"number\">30070</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: mysql-dev</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: mysql-dev</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: mysql-dev</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: <span class=\"number\">1</span> <span class=\"comment\"># pod数量</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: mysql-dev</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: mysql-dev</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: mysql-dev</span><br><span class=\"line\">          image: nacos/nacos-mysql:<span class=\"number\">5.7</span></span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            limits:</span><br><span class=\"line\">              memory: <span class=\"string\">&quot;0.5Gi&quot;</span></span><br><span class=\"line\">              cpu: <span class=\"string\">&quot;1500m&quot;</span></span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: <span class=\"number\">3306</span></span><br><span class=\"line\">          env:</span><br><span class=\"line\">            - name: MYSQL_ROOT_PASSWORD</span><br><span class=\"line\">              value: <span class=\"string\">&quot;root&quot;</span></span><br><span class=\"line\">            - name: MYSQL_DATABASE</span><br><span class=\"line\">              value: <span class=\"string\">&quot;my_db&quot;</span></span><br><span class=\"line\">            - name: MYSQL_USER</span><br><span class=\"line\">              value: <span class=\"string\">&quot;nacos&quot;</span></span><br><span class=\"line\">            - name: MYSQL_PASSWORD</span><br><span class=\"line\">              value: <span class=\"string\">&quot;nacos&quot;</span></span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - name: mysql-data</span><br><span class=\"line\">              mountPath: <span class=\"regexp\">/var/li</span>b/mysql</span><br><span class=\"line\">            - name: mysql-dev-conf</span><br><span class=\"line\">              mountPath: <span class=\"regexp\">/etc/m</span>ysql</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: mysql-data</span><br><span class=\"line\">          nfs:</span><br><span class=\"line\">            server: localhost</span><br><span class=\"line\">            path: <span class=\"regexp\">/data/d</span>ev/mysql</span><br><span class=\"line\">        - name: mysql-dev-conf</span><br><span class=\"line\">          configMap:</span><br><span class=\"line\">            name: <span class=\"keyword\">my</span>-dev.cnf</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: <span class=\"keyword\">my</span>-dev.cnf</span><br><span class=\"line\">data:</span><br><span class=\"line\">  my.cnf: |</span><br><span class=\"line\">    [mysqld]</span><br><span class=\"line\">    port = <span class=\"number\">3306</span></span><br><span class=\"line\">    character-set-server=utf8mb4</span><br><span class=\"line\">    collation-server=utf8mb4_unicode_ci</span><br><span class=\"line\">    skip-character-set-client-handshake=<span class=\"number\">1</span></span><br><span class=\"line\">    default-storage-engine=INNODB</span><br><span class=\"line\">    max_allowed_packet = 500M</span><br><span class=\"line\">    explicit_defaults_for_timestamp=<span class=\"number\">1</span></span><br><span class=\"line\">    long_query_time = <span class=\"number\">10</span></span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Kubernetes","Nacos"]},{"title":"K8S部署gitlab-redis","url":"/2025/11/06/K8S%E9%83%A8%E7%BD%B2gitlab-redis/","content":"<h1 id=\"文章目录\"><a href=\"#文章目录\" class=\"headerlink\" title=\"文章目录\"></a>文章目录</h1><p>一、概述<br>二、持久化存储安装–ebs<br>三、创建命名空间<br>四、创建文件夹，及账号密码<br>五、Postgresql部署<br>六、Redis部署<br>七、GitLab部署<br>八、命令总结<br>九、访问GitLab</p>\n<h1 id=\"一、概述\"><a href=\"#一、概述\" class=\"headerlink\" title=\"一、概述\"></a>一、概述</h1><p>在<a href=\"https://so.csdn.net/so/search?q=k8s&spm=1001.2101.3001.7020\">k8s</a>中部署gitlab，然后使用gitlab来实现代码打包到打镜像再到使用镜像自动生成容器服务的过程<br>用到了reids、postgresql、<a href=\"https://so.csdn.net/so/search?q=gitlab&spm=1001.2101.3001.7020\">gitlab</a>，将三个应用配置好之后启动即可安装gitlab</p>\n<h1 id=\"二、持久化存储安装–ebs\"><a href=\"#二、持久化存储安装–ebs\" class=\"headerlink\" title=\"二、持久化存储安装–ebs\"></a>二、持久化存储安装–ebs</h1><p>安装持久化存储工具，可以使用nfs或ebs</p>\n<p>以ebs为例（使用起来好像简单些）</p>\n<h2 id=\"1-安装ebs\"><a href=\"#1-安装ebs\" class=\"headerlink\" title=\"1. 安装ebs\"></a>1. 安装ebs</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https:<span class=\"regexp\">//</span>openebs.github.io/charts/openebs-operator.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-查看ebs集群服务\"><a href=\"#2-查看ebs集群服务\" class=\"headerlink\" title=\"2. 查看ebs集群服务\"></a>2. 查看ebs集群服务</h2><p>查看集群的StorageClass</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get sc</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-设置ebs为默认\"><a href=\"#3-设置ebs为默认\" class=\"headerlink\" title=\"3. 设置ebs为默认\"></a>3. 设置ebs为默认</h2><p>设置openobs-hostpath为default</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl patch storageclass openebs-hostpath -p <span class=\"string\">&#x27;&#123;&quot;metadata&quot;: &#123;&quot;annotations&quot;:&#123;&quot;storageclass.kubernetes.io/is-default-class&quot;:&quot;true&quot;&#125;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-使用ebs\"><a href=\"#4-使用ebs\" class=\"headerlink\" title=\"4. 使用ebs\"></a>4. 使用ebs</h2><p>在配置持久化时可根据安装的持久化工具将storageClassName参数的值填充:<br>先查看sc的名称</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get sc</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"三、创建命名空间\"><a href=\"#三、创建命名空间\" class=\"headerlink\" title=\"三、创建命名空间\"></a>三、创建命名空间</h1><p>在部署之前先创建一个namespace用于分类管理服务<br>创建一个名为gitlab-dev的命名空间</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create namespace gitlab-dev</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"四、创建文件夹，及账号密码\"><a href=\"#四、创建文件夹，及账号密码\" class=\"headerlink\" title=\"四、创建文件夹，及账号密码\"></a>四、创建文件夹，及账号密码</h1><p>分别创建gitlab目录，存储账号和密码的文件</p>\n<h2 id=\"账号文件username，用于存储账号信息\"><a href=\"#账号文件username，用于存储账号信息\" class=\"headerlink\" title=\"账号文件username，用于存储账号信息\"></a>账号文件username，用于存储账号信息</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">mkdir</span> /opt/k8s/gitlab-yaml</span><br><span class=\"line\">echo -n <span class=\"string\">&quot;gitlab-admin&quot;</span> &gt; ./username</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"密码文件password，用于存储密码信息\"><a href=\"#密码文件password，用于存储密码信息\" class=\"headerlink\" title=\"密码文件password，用于存储密码信息\"></a>密码文件password，用于存储密码信息</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">echo -n <span class=\"string\">&quot;gitlab.123&quot;</span> &gt; ./password</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"查看文件-文件内容\"><a href=\"#查看文件-文件内容\" class=\"headerlink\" title=\"查看文件&#x2F;文件内容\"></a>查看文件&#x2F;文件内容</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">ls</span><br><span class=\"line\">cat ./username</span><br><span class=\"line\">cat ./password</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"secret对象生成\"><a href=\"#secret对象生成\" class=\"headerlink\" title=\"secret对象生成\"></a>secret对象生成</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create secret generic git-user-pass --from-file=./username --from-file=./password -n gitlab-dev</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"查看secret\"><a href=\"#查看secret\" class=\"headerlink\" title=\"查看secret\"></a>查看secret</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl -n gitlab-dev get secret git-user-pass -o yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"拓展：如果创建错误或者想重新创建secret，则需先删除\"><a href=\"#拓展：如果创建错误或者想重新创建secret，则需先删除\" class=\"headerlink\" title=\"拓展：如果创建错误或者想重新创建secret，则需先删除\"></a><strong>拓展：</strong>如果创建错误或者想重新创建secret，则需先删除</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"keyword\">delete</span> secret git-user-pass -n gitlab-dev</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"五、Postgresql部署\"><a href=\"#五、Postgresql部署\" class=\"headerlink\" title=\"五、Postgresql部署\"></a>五、Postgresql部署</h1><p>为了方便管理以及后续修改更新文件，本篇对每个结构部分都创建一个yaml文件，且创建的文件都放在当前目录下的gitlab-yaml文件夹下，后续redis和gitlab的部分与此相同</p>\n<p>参数：<br>pgs：Postgresql<br>dplm：Deployment<br>pvc：PersistentVolumeClaim<br>svc：Service</p>\n<h2 id=\"1-持久化配置创建–pvc\"><a href=\"#1-持久化配置创建–pvc\" class=\"headerlink\" title=\"1.持久化配置创建–pvc\"></a>1.持久化配置创建–pvc</h2><h3 id=\"创建文件pgs-pvc-yaml\"><a href=\"#创建文件pgs-pvc-yaml\" class=\"headerlink\" title=\"创建文件pgs-pvc.yaml\"></a>创建文件pgs-pvc.yaml</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim ./gitlab-yaml/pgs-pvc.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将以下内容复制粘贴到文件中\"><a href=\"#将以下内容复制粘贴到文件中\" class=\"headerlink\" title=\"将以下内容复制粘贴到文件中\"></a>将以下内容复制粘贴到文件中</h3><p>注：其中name可自定义，namespace前面创建了gitlab-dev</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: pgs-pvc</span><br><span class=\"line\">  namespace: gitlab-dev</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  storageClassName: openebs-hostpath</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 1Gi</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"部署命令\"><a href=\"#部署命令\" class=\"headerlink\" title=\"部署命令\"></a>部署命令</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/pgs-pvc.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看创建的服务\"><a href=\"#查看创建的服务\" class=\"headerlink\" title=\"查看创建的服务\"></a>查看创建的服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pvc -n gitlab-dev pgs-pvc</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-部署配置–deployment\"><a href=\"#2-部署配置–deployment\" class=\"headerlink\" title=\"2. 部署配置–deployment\"></a>2. 部署配置–deployment</h2><h3 id=\"创建文件pgs-dplm-yaml\"><a href=\"#创建文件pgs-dplm-yaml\" class=\"headerlink\" title=\"创建文件pgs-dplm.yaml\"></a>创建文件pgs-dplm.yaml</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim ./gitlab-yaml/pgs-dplm.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将以下内容复制粘贴到文件中-1\"><a href=\"#将以下内容复制粘贴到文件中-1\" class=\"headerlink\" title=\"将以下内容复制粘贴到文件中\"></a>将以下内容复制粘贴到文件中</h3><p>注：nodeSelector的key的值就是namespace，最后的claimName的值是持久化配置文件的名称pgs-pvc</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: postgresql</span><br><span class=\"line\">  namespace: gitlab-dev</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: postgresql</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: <span class=\"number\">1</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      name: postgresql</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      name: postgresql</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        name: postgresql</span><br><span class=\"line\">    spec:</span><br><span class=\"line\"><span class=\"comment\">#     tolerations:             # 添加的容忍污点，到下面300结束</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\">      <span class=\"comment\">#nodeSelector:</span></span><br><span class=\"line\">        <span class=\"comment\">#key: gitlab-dev</span></span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: postgresql</span><br><span class=\"line\">          image: sameersbn/postgresql</span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          env:</span><br><span class=\"line\">            - name: DB_USER</span><br><span class=\"line\">              value: gitlab</span><br><span class=\"line\">            - name: DB_PASS</span><br><span class=\"line\">              value: passw0rd</span><br><span class=\"line\">            - name: DB_NAME</span><br><span class=\"line\">              value: gitlab_production</span><br><span class=\"line\">            - name: DB_EXTENSION</span><br><span class=\"line\">              value: pg_trgm</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - name: postgres</span><br><span class=\"line\">              containerPort: <span class=\"number\">5432</span></span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - mountPath: <span class=\"regexp\">/var/li</span>b/postgresql</span><br><span class=\"line\">              name: data</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            <span class=\"keyword\">exec</span>:</span><br><span class=\"line\">              command:</span><br><span class=\"line\">                - pg_isready</span><br><span class=\"line\">                - -h</span><br><span class=\"line\">                - localhost</span><br><span class=\"line\">                - -U</span><br><span class=\"line\">                - postgres</span><br><span class=\"line\">            initialDelaySeconds: <span class=\"number\">30</span></span><br><span class=\"line\">            timeoutSeconds: <span class=\"number\">5</span></span><br><span class=\"line\">          readinessProbe:</span><br><span class=\"line\">            <span class=\"keyword\">exec</span>:</span><br><span class=\"line\">              command:</span><br><span class=\"line\">                - pg_isready</span><br><span class=\"line\">                - -h</span><br><span class=\"line\">                - localhost</span><br><span class=\"line\">                - -U</span><br><span class=\"line\">                - postgres</span><br><span class=\"line\">            initialDelaySeconds: <span class=\"number\">5</span></span><br><span class=\"line\">            timeoutSeconds: <span class=\"number\">1</span></span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: data</span><br><span class=\"line\">          persistentVolumeClaim:</span><br><span class=\"line\">            claimName: pgs-pvc</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"部署命令-1\"><a href=\"#部署命令-1\" class=\"headerlink\" title=\"部署命令\"></a>部署命令</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/pgs-dplm.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看已创建的服务\"><a href=\"#查看已创建的服务\" class=\"headerlink\" title=\"查看已创建的服务\"></a>查看已创建的服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n gitlab-dev</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> gitlab-yaml]<span class=\"comment\"># kubectl get pod -n gitlab-dev</span></span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS      AGE</span><br><span class=\"line\">postgresql-bddc8596d-qxpgz   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">2</span> (22m ago)   3h33m</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-服务配置–svc\"><a href=\"#3-服务配置–svc\" class=\"headerlink\" title=\"3. 服务配置–svc\"></a>3. 服务配置–svc</h2><h3 id=\"创建文件pgs-svc-yaml\"><a href=\"#创建文件pgs-svc-yaml\" class=\"headerlink\" title=\"创建文件pgs-svc.yaml\"></a>创建文件pgs-svc.yaml</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim ./gitlab-yaml/pgs-svc.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将以下内容复制粘贴到文件中-2\"><a href=\"#将以下内容复制粘贴到文件中-2\" class=\"headerlink\" title=\"将以下内容复制粘贴到文件中\"></a>将以下内容复制粘贴到文件中</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: postgresql</span><br><span class=\"line\">  namespace: gitlab-dev</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: postgresql</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: postgres</span><br><span class=\"line\">      port: <span class=\"number\">5432</span></span><br><span class=\"line\">      targetPort: postgres</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    name: postgresql</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看已部署的服务\"><a href=\"#查看已部署的服务\" class=\"headerlink\" title=\"查看已部署的服务\"></a>查看已部署的服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n gitlab-dev</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> gitlab-yaml]<span class=\"comment\"># kubectl get svc -n gitlab-dev</span></span><br><span class=\"line\">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                     AGE</span><br><span class=\"line\">postgresql   ClusterIP   <span class=\"number\">10.104</span><span class=\"number\">.67</span><span class=\"number\">.253</span>    &lt;none&gt;        <span class=\"number\">5432</span>/TCP                    3h31m</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"六、Redis部署\"><a href=\"#六、Redis部署\" class=\"headerlink\" title=\"六、Redis部署\"></a>六、Redis部署</h1><p>数据缓存redis</p>\n<h2 id=\"1-持久化配置–pvc\"><a href=\"#1-持久化配置–pvc\" class=\"headerlink\" title=\"1. 持久化配置–pvc\"></a>1. 持久化配置–pvc</h2><h3 id=\"创建文件redis-pvc-yaml\"><a href=\"#创建文件redis-pvc-yaml\" class=\"headerlink\" title=\"创建文件redis-pvc.yaml\"></a>创建文件redis-pvc.yaml</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim ./gitlab-yaml/redis-pvc.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将以下内容复制粘贴到文件中-3\"><a href=\"#将以下内容复制粘贴到文件中-3\" class=\"headerlink\" title=\"将以下内容复制粘贴到文件中\"></a>将以下内容复制粘贴到文件中</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: redis-pvc</span><br><span class=\"line\">  namespace: gitlab-dev</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  storageClassName: openebs-hostpath</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 1Gi</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"部署服务\"><a href=\"#部署服务\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/redis-pvc.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看已部署的服务-1\"><a href=\"#查看已部署的服务-1\" class=\"headerlink\" title=\"查看已部署的服务\"></a>查看已部署的服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pvc -n gitlab-dev redis-pvc</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-部署配置–deployment-1\"><a href=\"#2-部署配置–deployment-1\" class=\"headerlink\" title=\"2. 部署配置–deployment\"></a>2. 部署配置–deployment</h2><h3 id=\"创建redis-dplm-yaml文件\"><a href=\"#创建redis-dplm-yaml文件\" class=\"headerlink\" title=\"创建redis-dplm.yaml文件\"></a>创建redis-dplm.yaml文件</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim ./gitlab-yaml/redis-dplm.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将以下内容复制粘贴到文件中-4\"><a href=\"#将以下内容复制粘贴到文件中-4\" class=\"headerlink\" title=\"将以下内容复制粘贴到文件中\"></a>将以下内容复制粘贴到文件中</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: redis</span><br><span class=\"line\">  namespace: gitlab-dev</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: redis</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: <span class=\"number\">2</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      name: redis</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      name: redis</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        name: redis</span><br><span class=\"line\">    spec:</span><br><span class=\"line\"><span class=\"comment\">#     tolerations:             # 添加的容忍污点，到下面300结束</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\">      <span class=\"comment\">#nodeSelector:</span></span><br><span class=\"line\">        <span class=\"comment\">#key: gitlab-dev</span></span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: redis</span><br><span class=\"line\">          image: sameersbn/redis</span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - name: redis</span><br><span class=\"line\">              containerPort: <span class=\"number\">6379</span></span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - mountPath: <span class=\"regexp\">/var/li</span>b/redis</span><br><span class=\"line\">              name: data</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            <span class=\"keyword\">exec</span>:</span><br><span class=\"line\">              command:</span><br><span class=\"line\">                - redis-cli</span><br><span class=\"line\">                - ping</span><br><span class=\"line\">            initialDelaySeconds: <span class=\"number\">30</span></span><br><span class=\"line\">            timeoutSeconds: <span class=\"number\">5</span></span><br><span class=\"line\">          readinessProbe:</span><br><span class=\"line\">            <span class=\"keyword\">exec</span>:</span><br><span class=\"line\">              command:</span><br><span class=\"line\">                - redis-cli</span><br><span class=\"line\">                - ping</span><br><span class=\"line\">            initialDelaySeconds: <span class=\"number\">5</span></span><br><span class=\"line\">            timeoutSeconds: <span class=\"number\">1</span></span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: data</span><br><span class=\"line\">          persistentVolumeClaim:</span><br><span class=\"line\">            claimName: redis-pvc</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"部署服务-1\"><a href=\"#部署服务-1\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/redis-dplm.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看已部署的服务-2\"><a href=\"#查看已部署的服务-2\" class=\"headerlink\" title=\"查看已部署的服务\"></a>查看已部署的服务</h3><p>因为文件中配置的副本数为2，故生成了两个redis的pod</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n gitlab-dev</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> gitlab-yaml]<span class=\"comment\"># kubectl get pod -n gitlab-dev</span></span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS      AGE</span><br><span class=\"line\">gitlab-955db8d9f-vp8zk       <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (21m ago)   32m</span><br><span class=\"line\">postgresql-bddc8596d-qxpgz   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">2</span> (22m ago)   3h33m</span><br><span class=\"line\">redis-56d5499794-clpkv       <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (35m ago)   3h26m</span><br><span class=\"line\">redis-56d5499794-gr977       <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (35m ago)   3h26m</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-服务配置–svc-1\"><a href=\"#3-服务配置–svc-1\" class=\"headerlink\" title=\"3. 服务配置–svc\"></a>3. 服务配置–svc</h2><h3 id=\"创建文件redis-svc-yaml\"><a href=\"#创建文件redis-svc-yaml\" class=\"headerlink\" title=\"创建文件redis-svc.yaml\"></a>创建文件redis-svc.yaml</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim ./gitlab-yaml/redis-svc.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将一下内容复制粘贴进文件中\"><a href=\"#将一下内容复制粘贴进文件中\" class=\"headerlink\" title=\"将一下内容复制粘贴进文件中\"></a>将一下内容复制粘贴进文件中</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: redis-svc</span><br><span class=\"line\">  namespace: gitlab-dev</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: redis-svc</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: redis</span><br><span class=\"line\">      port: <span class=\"number\">6379</span></span><br><span class=\"line\">      targetPort: redis</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    name: redis</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"部署服务-2\"><a href=\"#部署服务-2\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n gitlab-dev redis-svc</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> gitlab-yaml]<span class=\"comment\"># kubectl get svc -n gitlab-dev redis-svc</span></span><br><span class=\"line\">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE</span><br><span class=\"line\">redis-svc   ClusterIP   <span class=\"number\">10.104</span><span class=\"number\">.35</span><span class=\"number\">.113</span>   &lt;none&gt;        <span class=\"number\">6379</span>/TCP   3h33m</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"七、GitLab部署\"><a href=\"#七、GitLab部署\" class=\"headerlink\" title=\"七、GitLab部署\"></a>七、GitLab部署</h1><h2 id=\"持久化配置–pvc\"><a href=\"#持久化配置–pvc\" class=\"headerlink\" title=\"持久化配置–pvc\"></a>持久化配置–pvc</h2><h3 id=\"创建文件gitlab-pvc-yaml\"><a href=\"#创建文件gitlab-pvc-yaml\" class=\"headerlink\" title=\"创建文件gitlab-pvc.yaml\"></a>创建文件gitlab-pvc.yaml</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim ./gitlab-yaml/gitlab-pvc.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将以下内容复制粘贴到文件中-5\"><a href=\"#将以下内容复制粘贴到文件中-5\" class=\"headerlink\" title=\"将以下内容复制粘贴到文件中\"></a>将以下内容复制粘贴到文件中</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: gitlab-pvc</span><br><span class=\"line\">  namespace: gitlab-dev</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  storageClassName: openebs-hostpath</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 5Gi</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"部署服务-3\"><a href=\"#部署服务-3\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/gitlab-pvc.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-部署配置–deployment-2\"><a href=\"#2-部署配置–deployment-2\" class=\"headerlink\" title=\"2. 部署配置–deployment\"></a>2. 部署配置–deployment</h2><p>gitlab-ce-15.6.0-ce.0     gitlab-ce-14.0.0-ce.0</p>\n<p>本篇以gitlab-ce-15.6.0-ce.0为例</p>\n<h3 id=\"创建文件gitlab-dplm-yaml\"><a href=\"#创建文件gitlab-dplm-yaml\" class=\"headerlink\" title=\"创建文件gitlab-dplm.yaml\"></a>创建文件gitlab-dplm.yaml</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim ./gitlab-yaml/gitlab-dplm.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将一下内容复制粘贴到文件中\"><a href=\"#将一下内容复制粘贴到文件中\" class=\"headerlink\" title=\"将一下内容复制粘贴到文件中\"></a>将一下内容复制粘贴到文件中</h3><p><code>GITLAB_ROOT_PASSWORD</code> 密码部分，可以直接将值设为密码，这里从第二章中设置的密码文件中读取<br><code>GITLAB_ROOT_EMAIL</code> 邮箱部分，自定义即可<br><code>GITLAB_HOST</code> 主机地址，可自定义</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: gitlab</span><br><span class=\"line\">  namespace: gitlab-dev</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: gitlab</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: <span class=\"number\">1</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      name: gitlab</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      name: gitlab</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        name: gitlab</span><br><span class=\"line\">    spec:</span><br><span class=\"line\"><span class=\"comment\">#     tolerations:             # 添加的容忍污点，到下面300结束</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\">      <span class=\"comment\">#nodeSelector:</span></span><br><span class=\"line\">        <span class=\"comment\">#key: gitlab-dev</span></span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: gitlab</span><br><span class=\"line\">          <span class=\"comment\"># image: sameersbn/gitlab:12.1.6</span></span><br><span class=\"line\">          image: gitlab/gitlab-ce:<span class=\"number\">15.6</span>.<span class=\"number\">0</span>-ce.<span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"comment\"># command: [&quot;/bin/bash&quot;,&quot;-ce&quot;,&quot;tail -f /dev/null&quot;]</span></span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          env:</span><br><span class=\"line\">            - name: TZ</span><br><span class=\"line\">              value: Asia/Shanghai</span><br><span class=\"line\">            - name: GITLAB_TIMEZONE</span><br><span class=\"line\">              value: Beijing</span><br><span class=\"line\">            - name: GITLAB_SECRETS_DB_KEY_BASE</span><br><span class=\"line\">              value: long-<span class=\"keyword\">and</span>-random-alpha-numeric-string</span><br><span class=\"line\">            - name: GITLAB_SECRETS_SECRET_KEY_BASE</span><br><span class=\"line\">              value: long-<span class=\"keyword\">and</span>-random-alpha-numeric-string</span><br><span class=\"line\">            - name: GITLAB_SECRETS_OTP_KEY_BASE</span><br><span class=\"line\">              value: long-<span class=\"keyword\">and</span>-random-alpha-numeric-string</span><br><span class=\"line\">            - name: GITLAB_ROOT_PASSWORD</span><br><span class=\"line\">              <span class=\"comment\">#value: admin321</span></span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                secretKeyRef:</span><br><span class=\"line\">                  name: git-user-pass</span><br><span class=\"line\">                  key: password</span><br><span class=\"line\">            - name: GITLAB_ROOT_EMAIL</span><br><span class=\"line\">              value: hslb<span class=\"variable\">@163</span>.com</span><br><span class=\"line\">            - name: GITLAB_HOST</span><br><span class=\"line\">              value: gitlab.hslb.com</span><br><span class=\"line\">            - name: GITLAB_PORT</span><br><span class=\"line\">              value: <span class=\"string\">&quot;30021&quot;</span></span><br><span class=\"line\">            - name: GITLAB_SSH_PORT</span><br><span class=\"line\">              value: <span class=\"string\">&quot;30022&quot;</span></span><br><span class=\"line\">            - name: GITLAB_NOTIFY_ON_BROKEN_BUILDS</span><br><span class=\"line\">              value: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">            - name: GITLAB_NOTIFY_PUSHER</span><br><span class=\"line\">              value: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">            - name: GITLAB_BACKUP_SCHEDULE</span><br><span class=\"line\">              value: daily</span><br><span class=\"line\">            - name: GITLAB_BACKUP_TIME</span><br><span class=\"line\">              value: <span class=\"number\">01</span>:<span class=\"number\">00</span></span><br><span class=\"line\">            - name: DB_TYPE</span><br><span class=\"line\">              value: postgres</span><br><span class=\"line\">            - name: DB_HOST</span><br><span class=\"line\">              value: postgresql</span><br><span class=\"line\">            - name: DB_PORT</span><br><span class=\"line\">              value: <span class=\"string\">&quot;5432&quot;</span></span><br><span class=\"line\">            - name: DB_USER</span><br><span class=\"line\">              value: gitlab</span><br><span class=\"line\">            - name: DB_PASS</span><br><span class=\"line\">              value: passw0rd</span><br><span class=\"line\">            - name: DB_NAME</span><br><span class=\"line\">              value: gitlab_production</span><br><span class=\"line\">            - name: REDIS_HOST</span><br><span class=\"line\">              value: redis</span><br><span class=\"line\">            - name: REDIS_PORT</span><br><span class=\"line\">              value: <span class=\"string\">&quot;6379&quot;</span></span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - name: http</span><br><span class=\"line\">              containerPort: <span class=\"number\">80</span></span><br><span class=\"line\">            - name: ssh</span><br><span class=\"line\">              containerPort: <span class=\"number\">22</span></span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - mountPath: <span class=\"regexp\">/home/gi</span>t/data</span><br><span class=\"line\">              name: data</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              path: <span class=\"regexp\">/</span></span><br><span class=\"line\"><span class=\"regexp\">              port: 80</span></span><br><span class=\"line\"><span class=\"regexp\">            initialDelaySeconds: 180</span></span><br><span class=\"line\"><span class=\"regexp\">            timeoutSeconds: 5</span></span><br><span class=\"line\"><span class=\"regexp\">          readinessProbe:</span></span><br><span class=\"line\"><span class=\"regexp\">            httpGet:</span></span><br><span class=\"line\"><span class=\"regexp\">              path: /</span></span><br><span class=\"line\">              port: <span class=\"number\">80</span></span><br><span class=\"line\">            initialDelaySeconds: <span class=\"number\">180</span></span><br><span class=\"line\">            timeoutSeconds: <span class=\"number\">5</span></span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: data</span><br><span class=\"line\">          persistentVolumeClaim:</span><br><span class=\"line\">            claimName: gitlab-pvc</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"部署服务-4\"><a href=\"#部署服务-4\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/gitlab-dplm.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看已部署的服务-3\"><a href=\"#查看已部署的服务-3\" class=\"headerlink\" title=\"查看已部署的服务\"></a>查看已部署的服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n gitlab-dev -o wide</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> gitlab-yaml]<span class=\"comment\"># kubectl get pod -n gitlab-dev -o wide</span></span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS      AGE     IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">gitlab-955db8d9f-vp8zk       <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (36m ago)   47m     <span class=\"number\">10.244</span>.<span class=\"number\">1.27</span>   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">postgresql-bddc8596d-qxpgz   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">2</span> (36m ago)   3h47m   <span class=\"number\">10.244</span>.<span class=\"number\">1.23</span>   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">redis-56d5499794-clpkv       <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (50m ago)   3h40m   <span class=\"number\">10.244</span>.<span class=\"number\">2.13</span>   node02   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">redis-56d5499794-gr977       <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (50m ago)   3h40m   <span class=\"number\">10.244</span>.<span class=\"number\">2.11</span>   node02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n\n<p>注：如果k8s部署gitlab服务时出现pod状态为<code>Running</code>，Ready状态一直为<code>0/1</code>，重启一定次数后pod状态变为<code>CrashLoopBackOff</code></p>\n<p>查看pod详细信息时看到的message为 Readiness probe failed: Get “<a href=\"http://10.244.0.8/\">http://10.244.0.8:80/</a>“: dial tcp 10.244.0.8:80: connect: connection refused</p>\n<h3 id=\"解决方案：\"><a href=\"#解决方案：\" class=\"headerlink\" title=\"解决方案：\"></a>解决方案：</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">删除原有gitlab对应的pod</span><br><span class=\"line\">kubectl delete deployment gitlab -n gitlab-dev</span><br><span class=\"line\">修改yaml文件镜像参数使用别的版本镜像</span><br><span class=\"line\">vim ./gitlab-yaml/gitlab-dplm.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">将镜像版本改为gitlab/gitlab-ce:14.0.0-ce.0</span><br><span class=\"line\">或者gitlab/gitlab-ce:15.6.0-ce.0</span><br><span class=\"line\">重新应用yaml</span><br><span class=\"line\">kubectl apply -f ./gitlab-yaml/gitlab-dplm.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-服务配置\"><a href=\"#3-服务配置\" class=\"headerlink\" title=\"3. 服务配置\"></a>3. 服务配置</h2><h3 id=\"创建文件gitlab-svc-yaml\"><a href=\"#创建文件gitlab-svc-yaml\" class=\"headerlink\" title=\"创建文件gitlab-svc.yaml\"></a>创建文件gitlab-svc.yaml</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim ./gitlab-yaml/gitlab-svc.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"将以下内容复制粘贴到文件中-6\"><a href=\"#将以下内容复制粘贴到文件中-6\" class=\"headerlink\" title=\"将以下内容复制粘贴到文件中\"></a>将以下内容复制粘贴到文件中</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: gitlab</span><br><span class=\"line\">  namespace: gitlab-dev</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: gitlab</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: http</span><br><span class=\"line\">      port: <span class=\"number\">80</span></span><br><span class=\"line\">      targetPort: http</span><br><span class=\"line\">      nodePort: <span class=\"number\">30021</span></span><br><span class=\"line\">    - name: ssh</span><br><span class=\"line\">      port: <span class=\"number\">22</span></span><br><span class=\"line\">      targetPort: ssh</span><br><span class=\"line\">      nodePort: <span class=\"number\">30022</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    name: gitlab</span><br><span class=\"line\">  type: NodePort</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"部署服务-5\"><a href=\"#部署服务-5\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/gitlab-svc.yaml</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看已部署的服务-4\"><a href=\"#查看已部署的服务-4\" class=\"headerlink\" title=\"查看已部署的服务\"></a>查看已部署的服务</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n gitlab-dev</span><br></pre></td></tr></table></figure>\n\n<p><code>以上就是redis、postgresql、gitlab三个部分的部署</code></p>\n<h1 id=\"八、命令总结\"><a href=\"#八、命令总结\" class=\"headerlink\" title=\"八、命令总结\"></a>八、命令总结</h1><p>如果出现问题需要删除创建的服务，可参考以下命令</p>\n<h2 id=\"1-部署pvc\"><a href=\"#1-部署pvc\" class=\"headerlink\" title=\"1.部署pvc\"></a>1.部署pvc</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/pgs-pvc.yaml</span><br><span class=\"line\">kubectl apply -f ./gitlab-yaml/redis-pvc.yaml</span><br><span class=\"line\">kubectl apply -f ./gitlab-yaml/gitlab-pvc.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-查看pvc\"><a href=\"#2-查看pvc\" class=\"headerlink\" title=\"2. 查看pvc\"></a>2. 查看pvc</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pvc -n gitlab-dev</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-删除指定pvc\"><a href=\"#3-删除指定pvc\" class=\"headerlink\" title=\"3. 删除指定pvc\"></a>3. 删除指定pvc</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"keyword\">delete</span> pvc pgs-pvc -n gitlab-dev</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-部署pod\"><a href=\"#4-部署pod\" class=\"headerlink\" title=\"4. 部署pod\"></a>4. 部署pod</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/pgs-dplm.yaml</span><br><span class=\"line\">kubectl apply -f ./gitlab-yaml/redis-dplm.yaml</span><br><span class=\"line\">kubectl apply -f ./gitlab-yaml/gitlab-dplm.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-查看pod\"><a href=\"#5-查看pod\" class=\"headerlink\" title=\"5. 查看pod\"></a>5. 查看pod</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n gitlab-dev</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-删除pod\"><a href=\"#6-删除pod\" class=\"headerlink\" title=\"6. 删除pod\"></a>6. 删除pod</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 删除无副本设置的pod</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">delete</span> pod postgresql -n gitlab-dev</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除设置副本的pod</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">delete</span> deployment postgresql -n gitlab-dev</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"7-部署svc\"><a href=\"#7-部署svc\" class=\"headerlink\" title=\"7. 部署svc\"></a>7. 部署svc</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f ./gitlab-yaml/pgs-svc.yaml</span><br><span class=\"line\">kubectl apply -f ./gitlab-yaml/redis-svc.yaml</span><br><span class=\"line\">kubectl apply -f ./gitlab-yaml/gitlab-svc.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"8-查看svc\"><a href=\"#8-查看svc\" class=\"headerlink\" title=\"8. 查看svc\"></a>8. 查看svc</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n gitlab-dev</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"9-删除指定svc\"><a href=\"#9-删除指定svc\" class=\"headerlink\" title=\"9. 删除指定svc\"></a>9. 删除指定svc</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"keyword\">delete</span> svc postgresql -n gitlab-dev</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"九、访问GitLab\"><a href=\"#九、访问GitLab\" class=\"headerlink\" title=\"九、访问GitLab\"></a>九、访问GitLab</h1><h2 id=\"1-访问地址\"><a href=\"#1-访问地址\" class=\"headerlink\" title=\"1. 访问地址\"></a>1. 访问地址</h2><p>首先根据自己的服务查看服务所在节点<br>然后使用 节点ip+端口 即可访问</p>\n<h3 id=\"查看gitlab的pod部署在哪个节点\"><a href=\"#查看gitlab的pod部署在哪个节点\" class=\"headerlink\" title=\"查看gitlab的pod部署在哪个节点\"></a>查看gitlab的pod部署在哪个节点</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pod -n gitlab-dev -o wide</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"节点在node01\"><a href=\"#节点在node01\" class=\"headerlink\" title=\"节点在node01\"></a>节点在node01</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> gitlab-yaml]<span class=\"comment\"># kubectl get pod -n gitlab-dev -o wide</span></span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS      AGE     IP            NODE     NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">gitlab-955db8d9f-vp8zk       <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">2</span> (51s ago)   65m     <span class=\"number\">10.244</span>.<span class=\"number\">1.27</span>   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">postgresql-bddc8596d-qxpgz   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">2</span> (55m ago)   4h6m    <span class=\"number\">10.244</span>.<span class=\"number\">1.23</span>   node01   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">redis-56d5499794-clpkv       <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (68m ago)   3h59m   <span class=\"number\">10.244</span>.<span class=\"number\">2.13</span>   node02   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">redis-56d5499794-gr977       <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">1</span> (68m ago)   3h59m   <span class=\"number\">10.244</span>.<span class=\"number\">2.11</span>   node02   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看gitlab服务映射的端口\"><a href=\"#查看gitlab服务映射的端口\" class=\"headerlink\" title=\"查看gitlab服务映射的端口\"></a>查看gitlab服务映射的端口</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get svc -n gitlab-dev -o wide</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"映射的端口为30021\"><a href=\"#映射的端口为30021\" class=\"headerlink\" title=\"映射的端口为30021\"></a>映射的端口为30021</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> gitlab-yaml]<span class=\"comment\"># kubectl get svc -n gitlab-dev -o wide</span></span><br><span class=\"line\">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                     AGE     SELECTOR</span><br><span class=\"line\">gitlab       NodePort    <span class=\"number\">10.110</span><span class=\"number\">.192</span><span class=\"number\">.219</span>   &lt;none&gt;        <span class=\"number\">80</span>:<span class=\"number\">30021</span>/TCP,<span class=\"number\">22</span>:<span class=\"number\">30022</span>/TCP   3h25m   name=gitlab</span><br><span class=\"line\">postgresql   ClusterIP   <span class=\"number\">10.104</span><span class=\"number\">.67</span><span class=\"number\">.253</span>    &lt;none&gt;        <span class=\"number\">5432</span>/TCP                    4h2m    name=postgresql</span><br><span class=\"line\">redis-svc    ClusterIP   <span class=\"number\">10.104</span><span class=\"number\">.35</span><span class=\"number\">.113</span>    &lt;none&gt;        <span class=\"number\">6379</span>/TCP                    3h56m   name=redis</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-访问gitlab\"><a href=\"#2-访问gitlab\" class=\"headerlink\" title=\"2. 访问gitlab\"></a>2. 访问gitlab</h2><p><code>访问网址gitlab服务所在节点ip:30021</code></p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">注意，账号为root</span><br><span class=\"line\">密码为之前设置的gitlab<span class=\"number\">.123</span></span><br><span class=\"line\">这里有个地方有点无语，我之前设置的账号为gitlab-admin</span><br><span class=\"line\">使用这个账号登录不进去，必须换成root</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Kubernetes","Gitlab","Redis"]},{"title":"K8S部署nexus","url":"/2025/11/06/K8S%E9%83%A8%E7%BD%B2nexus/","content":"<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">服务器\t  IP地址</span><br><span class=\"line\">master\t<span class=\"number\">192.168</span>.<span class=\"number\">0.173</span></span><br><span class=\"line\">node1\t<span class=\"number\">192.168</span>.<span class=\"number\">0.253</span></span><br><span class=\"line\">node2\t<span class=\"number\">192.168</span>.<span class=\"number\">0.233</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装nfs\"><a href=\"#安装nfs\" class=\"headerlink\" title=\"安装nfs\"></a>安装nfs</h2><h3 id=\"安装nfs-1\"><a href=\"#安装nfs-1\" class=\"headerlink\" title=\"安装nfs\"></a>安装nfs</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master节点</span></span><br><span class=\"line\">yum -<span class=\"keyword\">y</span> install  nfs-utils rpcbind</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建共享目录</span></span><br><span class=\"line\"><span class=\"keyword\">mkdir</span> /var/nfs/nexus</span><br><span class=\"line\"><span class=\"comment\"># 授予权限</span></span><br><span class=\"line\"><span class=\"keyword\">chmod</span> <span class=\"number\">777</span> /var/nfs/nexus</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动nfs服务</span></span><br><span class=\"line\">systemctl start nfs-server</span><br><span class=\"line\">systemctl enabled nfs-server</span><br><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl enabled rpcbind</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># node节点</span></span><br><span class=\"line\">yum -<span class=\"keyword\">y</span> install  nfs-utils rpcbind</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl start nfs-server</span><br><span class=\"line\">systemctl enabled nfs-server</span><br><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl enabled rpcbind</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"挂载NFS\"><a href=\"#挂载NFS\" class=\"headerlink\" title=\"挂载NFS\"></a>挂载NFS</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置共享目录以及权限(服务端master)</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat /etc/exports</span></span><br><span class=\"line\">/var/nfs/nexus        *(rw,no_root_squash,sync) 或 /var/nfs/nexus  <span class=\"number\">172.20</span><span class=\"number\">.10</span>.<span class=\"number\">0</span>/<span class=\"number\">24</span>(rw,no_root_squash,sync)</span><br><span class=\"line\"> 共享的目录\t       共享的地址（共享的权限、选项）</span><br><span class=\"line\">systemctl restart nfs-server</span><br><span class=\"line\"><span class=\"comment\"># 客户端连接(客户端node节点)</span></span><br><span class=\"line\"><span class=\"keyword\">mkdir</span>  /test \t    <span class=\"comment\"># 接收文件的目录</span></span><br><span class=\"line\">mount -t nfs <span class=\"number\">192.168</span>.<span class=\"number\">0.173</span>:<span class=\"regexp\">/var/n</span>fs/nexus  /mnt/nfs \t <span class=\"comment\"># 挂载</span></span><br><span class=\"line\"></span><br><span class=\"line\">umount /test \t\t<span class=\"comment\"># 卸载，前提先要CD到家目录下</span></span><br><span class=\"line\"><span class=\"comment\"># 开机挂载</span></span><br><span class=\"line\">vim /etc/fstab</span><br><span class=\"line\">nfs:<span class=\"regexp\">/data      /da</span>ta           nfs     defaults        <span class=\"number\">0</span> <span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建名称空间\"><a href=\"#创建名称空间\" class=\"headerlink\" title=\"创建名称空间\"></a>创建名称空间</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建namespace</span></span><br><span class=\"line\">kubectl create ns nexus</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建nfs客户端撒授权\"><a href=\"#创建nfs客户端撒授权\" class=\"headerlink\" title=\"创建nfs客户端撒授权\"></a>创建nfs客户端撒授权</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat nexus-nfs-client-sa.yaml</span></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nfs-client</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/<span class=\"number\">v1</span></span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nfs-client-runner</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;persistentvolumes&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;storage.k8s.io&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;storageclasses&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;events&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;update&quot;</span>,<span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;delete&quot;</span>,<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;patch&quot;</span>,<span class=\"string\">&quot;update&quot;</span>]</span><br><span class=\"line\"> </span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/<span class=\"number\">v1</span></span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: run-nfs-provisioner</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: nfs-client</span><br><span class=\"line\">    namespace: nexus</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: nfs-client-runner</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># kubectl apply -f nexus-nfs-client-sa.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"检查服务是否成功\"><a href=\"#检查服务是否成功\" class=\"headerlink\" title=\"检查服务是否成功\"></a>检查服务是否成功</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get ServiceAccount -n nexus -o wide</span><br><span class=\"line\"> </span><br><span class=\"line\">kubectl get ClusterRole -n nexus -o wide</span><br><span class=\"line\"> </span><br><span class=\"line\">kubectl get ClusterRoleBinding -n nexus -o wide</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建nfs-客户端\"><a href=\"#创建nfs-客户端\" class=\"headerlink\" title=\"创建nfs 客户端\"></a>创建nfs 客户端</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat nexus-nfs-client.yaml</span></span><br><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nfs-client</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: nfs-client</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: <span class=\"number\">1</span></span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    type: Recreate</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: nfs-client</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: nfs-client</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      serviceAccountName: nfs-client</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: nfs-client</span><br><span class=\"line\">          image: d3fk/nfs-client</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - name: nfs-client-root</span><br><span class=\"line\">              mountPath: <span class=\"regexp\">/persistentvolumes</span></span><br><span class=\"line\"><span class=\"regexp\">          env:</span></span><br><span class=\"line\"><span class=\"regexp\">            - name: PROVISIONER_NAME\t\t## 这个名字必须与storegeclass里面的名字一致</span></span><br><span class=\"line\"><span class=\"regexp\">              value:  my-nexus-nfs</span></span><br><span class=\"line\"><span class=\"regexp\">            - name: ENABLE_LEADER_ELECTION\t\t## 设置高可用允许选举，如果replicas参数等于1，可不用</span></span><br><span class=\"line\"><span class=\"regexp\">              value: &quot;True&quot;</span></span><br><span class=\"line\"><span class=\"regexp\">            - name: NFS_SERVER</span></span><br><span class=\"line\"><span class=\"regexp\">              value: 192.168.0.173\t\t#修改为自己的ip（部署nfs的机器ip）</span></span><br><span class=\"line\"><span class=\"regexp\">            - name: NFS_PATH</span></span><br><span class=\"line\"><span class=\"regexp\">              value: /</span>var/nfs/nexus\t\t<span class=\"comment\">#修改为自己的nfs安装目录</span></span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: nfs-client-root</span><br><span class=\"line\">          nfs:</span><br><span class=\"line\">            server: <span class=\"number\">192.168</span>.<span class=\"number\">0.173</span>\t\t<span class=\"comment\">#修改为自己的ip（部署nfs的机器ip）</span></span><br><span class=\"line\">            path: <span class=\"regexp\">/var/n</span>fs/nexus\t\t<span class=\"comment\">#修改为自己的nfs安装目录</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># kubectl apply -f nexus-nfs-client.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建storeclass\"><a href=\"#创建storeclass\" class=\"headerlink\" title=\"创建storeclass\"></a>创建storeclass</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat nexus-store-class.yaml</span></span><br><span class=\"line\">apiVersion: storage.k8s.io/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: StorageClass</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nexus-nfs-storage</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">provisioner: <span class=\"keyword\">my</span>-nexus-nfs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># kubectl apply -f nexus-store-class.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"检查nfs客户端和storeclass创建是否成功\"><a href=\"#检查nfs客户端和storeclass创建是否成功\" class=\"headerlink\" title=\"检查nfs客户端和storeclass创建是否成功\"></a>检查nfs客户端和storeclass创建是否成功</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get StorageClass -n nexus -o wide</span><br><span class=\"line\"> </span><br><span class=\"line\">kubectl get pod -n nexus -o wide</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装nexus\"><a href=\"#安装nexus\" class=\"headerlink\" title=\"安装nexus\"></a>安装nexus</h2><h3 id=\"创建pv\"><a href=\"#创建pv\" class=\"headerlink\" title=\"创建pv\"></a>创建pv</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\">#  cat nexus-pv.yaml</span></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: PersistentVolume</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nexus-pv</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  capacity:</span><br><span class=\"line\">    storage: 2Gi    <span class=\"comment\">#配置容量大小</span></span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce     <span class=\"comment\">#配置访问策略为只允许一个节点读写</span></span><br><span class=\"line\">  persistentVolumeReclaimPolicy: Retain  <span class=\"comment\">#配置回收策略，Retain为手动回收</span></span><br><span class=\"line\">  storageClassName: nexus       <span class=\"comment\">#配置为nfs</span></span><br><span class=\"line\">  nfs:</span><br><span class=\"line\">    path: <span class=\"regexp\">/var/n</span>fs/nexus   <span class=\"comment\">#配置nfs服务端的共享路径</span></span><br><span class=\"line\">    server: <span class=\"number\">192.168</span>.<span class=\"number\">0.173</span>    <span class=\"comment\">#配置nfs服务器地址</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\">#  kubectl apply -f nexus-pv.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建pvc\"><a href=\"#创建pvc\" class=\"headerlink\" title=\"创建pvc\"></a>创建pvc</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\">#  cat nexus-pvc.yaml</span></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nexus-data-pvc</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 2Gi</span><br><span class=\"line\">  storageClassName: nexus</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\">#  kubectl apply -f nexus-pvc.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建service\"><a href=\"#创建service\" class=\"headerlink\" title=\"创建service\"></a>创建service</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat nexus-service.yaml</span></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nexus</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: nexus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: nexus</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: web</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      port: <span class=\"number\">8081</span></span><br><span class=\"line\">      targetPort: <span class=\"number\">8081</span></span><br><span class=\"line\">      nodePort: <span class=\"number\">30001</span>\t\t\t<span class=\"comment\"># 对外暴露的端口</span></span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\">#  kubectl apply -f nexus-service.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建deployment\"><a href=\"#创建deployment\" class=\"headerlink\" title=\"创建deployment\"></a>创建deployment</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat nexus-deploy.yaml</span></span><br><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: nexus</span><br><span class=\"line\">  name: nexus</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: <span class=\"number\">1</span></span><br><span class=\"line\">  progressDeadlineSeconds: <span class=\"number\">600</span></span><br><span class=\"line\">  minReadySeconds: <span class=\"number\">30</span></span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    rollingUpdate:</span><br><span class=\"line\">      maxSurge: <span class=\"number\">1</span></span><br><span class=\"line\">      maxUnavailable: <span class=\"number\">0</span></span><br><span class=\"line\">    type: RollingUpdate</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: nexus</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: nexus</span><br><span class=\"line\">    spec:</span><br><span class=\"line\"><span class=\"comment\">#     tolerations:             # 添加的容忍污点，到下面300结束</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: nexus</span><br><span class=\"line\">        image: sonatype/nexus3:<span class=\"number\">3.28</span>.<span class=\"number\">0</span></span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">          - containerPort: <span class=\"number\">8081</span></span><br><span class=\"line\">            name: web</span><br><span class=\"line\">            protocol: TCP</span><br><span class=\"line\">        livenessProbe:</span><br><span class=\"line\">          httpGet:</span><br><span class=\"line\">            path: <span class=\"regexp\">/</span></span><br><span class=\"line\"><span class=\"regexp\">            port: 8081</span></span><br><span class=\"line\"><span class=\"regexp\">          initialDelaySeconds: 70</span></span><br><span class=\"line\"><span class=\"regexp\">          periodSeconds: 30</span></span><br><span class=\"line\"><span class=\"regexp\">          failureThreshold: 6</span></span><br><span class=\"line\"><span class=\"regexp\">        readinessProbe:</span></span><br><span class=\"line\"><span class=\"regexp\">          httpGet:</span></span><br><span class=\"line\"><span class=\"regexp\">            path: /</span></span><br><span class=\"line\">            port: <span class=\"number\">8081</span></span><br><span class=\"line\">          initialDelaySeconds: <span class=\"number\">60</span></span><br><span class=\"line\">          periodSeconds: <span class=\"number\">30</span></span><br><span class=\"line\">          failureThreshold: <span class=\"number\">6</span></span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 1000m</span><br><span class=\"line\">            memory: 2Gi</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 500m</span><br><span class=\"line\">            memory: 512Mi</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: nexus-data</span><br><span class=\"line\">          mountPath: /nexus-data</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: nexus-data</span><br><span class=\"line\">          persistentVolumeClaim:</span><br><span class=\"line\">            claimName: nexus-data-pvc</span><br><span class=\"line\">            </span><br><span class=\"line\"> <span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\">#  kubectl apply -f nexus-deploy.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查询服务是否正常\"><a href=\"#查询服务是否正常\" class=\"headerlink\" title=\"查询服务是否正常\"></a>查询服务是否正常</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get all -n nexus</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get po -n nexus -o wide</span><br><span class=\"line\">kubectl get pv,pvc -n nexus -o wide</span><br><span class=\"line\">kubectl get svc -n nexus -o wide</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"访问\"><a href=\"#访问\" class=\"headerlink\" title=\"访问\"></a>访问</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">通过service的nodeport端口访问nexus服务</span><br><span class=\"line\"></span><br><span class=\"line\">http:<span class=\"regexp\">//</span>IP + 端口<span class=\"number\">30001</span>\t\t<span class=\"comment\"># 端口是service文件里定义的（ nodePort: 30001\t）</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"服务启动正常后获取nexus初始的登录密码\"><a href=\"#服务启动正常后获取nexus初始的登录密码\" class=\"headerlink\" title=\"服务启动正常后获取nexus初始的登录密码\"></a>服务启动正常后获取nexus初始的登录密码</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># kubectl exec -it nexus-6b47d98b5c-tjchb -n nexus cat /nexus-data/admin.password</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">exec</span> [POD] [COMMAND] is DEPRECATED <span class=\"keyword\">and</span> will be removed in a future version. Use kubectl <span class=\"keyword\">exec</span> [POD] -- [COMMAND] instead.</span><br><span class=\"line\">f7f0f006-423c-4b2e-<span class=\"number\">9256</span>-032adc74ceeb[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># </span></span><br><span class=\"line\">或</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># kubectl exec -it nexus-6b47d98b5c-tjchb -n nexus bash</span></span><br><span class=\"line\">kubectl <span class=\"keyword\">exec</span> [POD] [COMMAND] is DEPRECATED <span class=\"keyword\">and</span> will be removed in a future version. Use kubectl <span class=\"keyword\">exec</span> [POD] -- [COMMAND] instead.</span><br><span class=\"line\">bash-<span class=\"number\">4.4</span>$ cat /nexus-data/admin.password </span><br><span class=\"line\">f7f0f006-423c-4b2e-<span class=\"number\">9256</span>-032adc74ceebbash-<span class=\"number\">4.4</span>$</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 默认用户admin 密码使用上面获取的初始密码即可(密码：Zijian@123)</span></span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Kubernetes","Nexus"]},{"title":"K8S部署nginx","url":"/2025/11/06/K8S%E9%83%A8%E7%BD%B2nginx/","content":"<h1 id=\"创建目录\"><a href=\"#创建目录\" class=\"headerlink\" title=\"创建目录\"></a>创建目录</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir /opt/k8s/nginx-yaml</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建名称空间\"><a href=\"#创建名称空间\" class=\"headerlink\" title=\"创建名称空间\"></a>创建名称空间</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create namespace nginx</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建deployment\"><a href=\"#创建deployment\" class=\"headerlink\" title=\"创建deployment\"></a>创建deployment</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim nginx-deploy.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-deployment</span><br><span class=\"line\">  namespace: nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: nginx</span><br><span class=\"line\">  replicas: <span class=\"number\">3</span></span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: nginx</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: nginx</span><br><span class=\"line\">        image: nginx:alpine</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: <span class=\"number\">80</span></span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - mountPath: <span class=\"regexp\">/etc/l</span>ocaltime</span><br><span class=\"line\">          name: c-v-path</span><br><span class=\"line\">        - mountPath: <span class=\"regexp\">/etc/nginx</span><span class=\"regexp\">/conf.d</span></span><br><span class=\"line\"><span class=\"regexp\">          name: c-v-path-ng</span></span><br><span class=\"line\"><span class=\"regexp\">      restartPolicy: Always</span></span><br><span class=\"line\"><span class=\"regexp\">      volumes:</span></span><br><span class=\"line\"><span class=\"regexp\">        - hostPath:</span></span><br><span class=\"line\"><span class=\"regexp\">            path: /</span>etc/<span class=\"keyword\">localtime</span></span><br><span class=\"line\">            type: <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">          name: c-v-path</span><br><span class=\"line\">        - hostPath:</span><br><span class=\"line\">            path: <span class=\"regexp\">/root/</span>opt/k8s/nginx-yaml/nginx-conf</span><br><span class=\"line\">            type: <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">          name: c-v-path-ng</span><br></pre></td></tr></table></figure>\n\n<p>创建service</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim nginx-svc.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-service</span><br><span class=\"line\">  namespace: nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: nginx</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - protocol: TCP</span><br><span class=\"line\">    port: <span class=\"number\">80</span></span><br><span class=\"line\">    targetPort: <span class=\"number\">80</span></span><br><span class=\"line\">    nodePort: <span class=\"number\">30080</span></span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>创建</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f nginx-deploy.yaml</span><br><span class=\"line\">kubectl apply -f nginx-svc.yaml</span><br></pre></td></tr></table></figure>\n\n<p>查看pod在哪个节点</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get deploy -n nginx -o wide</span><br><span class=\"line\"></span><br><span class=\"line\">NAME               READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR</span><br><span class=\"line\">nginx-deployment   <span class=\"number\">3</span>/<span class=\"number\">3</span>     <span class=\"number\">3</span>            <span class=\"number\">3</span>           48s   nginx        nginx:alpine   app=nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>查看service状态–端口是30080</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get svc nginx-service -o wide</span><br><span class=\"line\"></span><br><span class=\"line\">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR</span><br><span class=\"line\">nginx-service   NodePort   <span class=\"number\">10.106</span><span class=\"number\">.209</span><span class=\"number\">.76</span>   &lt;none&gt;        <span class=\"number\">80</span>:<span class=\"number\">30080</span>/TCP   26s   app=nginx</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>访问</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">pod节点 + 端口</span><br></pre></td></tr></table></figure>\n\n<p>进入容器</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl <span class=\"keyword\">exec</span> -it pod名称 --sh</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx","Kubernetes"]},{"title":"K8S部署zentao","url":"/2025/11/06/K8S%E9%83%A8%E7%BD%B2zentao/","content":"<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">服务器\t  IP地址</span><br><span class=\"line\">master\t<span class=\"number\">192.168</span>.<span class=\"number\">0.173</span></span><br><span class=\"line\">node1\t<span class=\"number\">192.168</span>.<span class=\"number\">0.253</span></span><br><span class=\"line\">node2\t<span class=\"number\">192.168</span>.<span class=\"number\">0.233</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装nfs\"><a href=\"#安装nfs\" class=\"headerlink\" title=\"安装nfs\"></a>安装nfs</h2><h3 id=\"安装nfs-1\"><a href=\"#安装nfs-1\" class=\"headerlink\" title=\"安装nfs\"></a>安装nfs</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master节点</span></span><br><span class=\"line\">yum -<span class=\"keyword\">y</span> install  nfs-utils rpcbind</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建共享目录</span></span><br><span class=\"line\"><span class=\"keyword\">mkdir</span> -p /data/zentao</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 启动nfs服务</span></span><br><span class=\"line\">systemctl restart nfs-server</span><br><span class=\"line\">systemctl enabled nfs-server</span><br><span class=\"line\">systemctl restart rpcbind</span><br><span class=\"line\">systemctl enabled rpcbind</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># node节点</span></span><br><span class=\"line\">yum -<span class=\"keyword\">y</span> install  nfs-utils rpcbind</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl restart nfs-server</span><br><span class=\"line\">systemctl enabled nfs-server</span><br><span class=\"line\">systemctl restart rpcbind</span><br><span class=\"line\">systemctl enabled rpcbind</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"挂载NFS\"><a href=\"#挂载NFS\" class=\"headerlink\" title=\"挂载NFS\"></a>挂载NFS</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置共享目录以及权限(服务端master)</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat /etc/exports</span></span><br><span class=\"line\">/var/nfs/nexus        *(rw,no_root_squash,sync)</span><br><span class=\"line\">/var/nfs/nexus\t\t  *(rw,no_root_squash,sync)</span><br><span class=\"line\"><span class=\"comment\"># 重新启动</span></span><br><span class=\"line\">systemctl restart nfs-server</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> zentao]<span class=\"comment\"># showmount -e 192.168.0.173</span></span><br><span class=\"line\">Export list <span class=\"keyword\">for</span> <span class=\"number\">192.168</span>.<span class=\"number\">0.173</span>:</span><br><span class=\"line\"><span class=\"regexp\">/data/</span>zentao   *</span><br><span class=\"line\"><span class=\"regexp\">/var/n</span>fs/nexus *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 客户端连接(客户端node节点)</span></span><br><span class=\"line\"><span class=\"keyword\">mkdir</span>  /test \t    <span class=\"comment\"># 接收文件的目录</span></span><br><span class=\"line\">mount -t nfs <span class=\"number\">192.168</span>.<span class=\"number\">0.173</span>:<span class=\"regexp\">/var/n</span>fs/nexus  /test \t <span class=\"comment\"># 挂载</span></span><br><span class=\"line\"></span><br><span class=\"line\">umount /test \t\t<span class=\"comment\"># 卸载，前提先要CD到家目录下</span></span><br><span class=\"line\"><span class=\"comment\"># 开机挂载</span></span><br><span class=\"line\">vim /etc/fstab</span><br><span class=\"line\">nfs:<span class=\"regexp\">/data      /da</span>ta           nfs     defaults        <span class=\"number\">0</span> <span class=\"number\">0</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建名称空间\"><a href=\"#创建名称空间\" class=\"headerlink\" title=\"创建名称空间\"></a>创建名称空间</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建namespace</span></span><br><span class=\"line\">kubectl create ns work\t\t\t<span class=\"comment\"># 可以自定义名称空间为为zentao</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建nfs客户端撒授权\"><a href=\"#创建nfs客户端撒授权\" class=\"headerlink\" title=\"创建nfs客户端撒授权\"></a>创建nfs客户端撒授权</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat nexus-nfs-client-sa.yaml</span></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nfs-client</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/<span class=\"number\">v1</span></span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nfs-client-runner</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;persistentvolumes&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;storage.k8s.io&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;storageclasses&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;events&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;update&quot;</span>,<span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\">  - apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    resources: [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">    verbs: [<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;delete&quot;</span>,<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;patch&quot;</span>,<span class=\"string\">&quot;update&quot;</span>]</span><br><span class=\"line\"> </span><br><span class=\"line\">---</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/<span class=\"number\">v1</span></span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: run-nfs-provisioner</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: nfs-client</span><br><span class=\"line\">    namespace: nexus</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: nfs-client-runner</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># kubectl apply -f nexus-nfs-client-sa.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"检查服务是否成功\"><a href=\"#检查服务是否成功\" class=\"headerlink\" title=\"检查服务是否成功\"></a>检查服务是否成功</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get ServiceAccount -n nexus -o wide</span><br><span class=\"line\"> </span><br><span class=\"line\">kubectl get ClusterRole -n nexus -o wide</span><br><span class=\"line\"> </span><br><span class=\"line\">kubectl get ClusterRoleBinding -n nexus -o wide</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建nfs-客户端\"><a href=\"#创建nfs-客户端\" class=\"headerlink\" title=\"创建nfs 客户端\"></a>创建nfs 客户端</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat nexus-nfs-client.yaml</span></span><br><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nfs-client</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: nfs-client</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: <span class=\"number\">1</span></span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    type: Recreate</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: nfs-client</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: nfs-client</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      serviceAccountName: nfs-client</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: nfs-client</span><br><span class=\"line\">          image: d3fk/nfs-client</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - name: nfs-client-root</span><br><span class=\"line\">              mountPath: <span class=\"regexp\">/persistentvolumes</span></span><br><span class=\"line\"><span class=\"regexp\">          env:</span></span><br><span class=\"line\"><span class=\"regexp\">            - name: PROVISIONER_NAME\t\t## 这个名字必须与storegeclass里面的名字一致</span></span><br><span class=\"line\"><span class=\"regexp\">              value:  my-nexus-nfs</span></span><br><span class=\"line\"><span class=\"regexp\">            - name: ENABLE_LEADER_ELECTION\t\t## 设置高可用允许选举，如果replicas参数等于1，可不用</span></span><br><span class=\"line\"><span class=\"regexp\">              value: &quot;True&quot;</span></span><br><span class=\"line\"><span class=\"regexp\">            - name: NFS_SERVER</span></span><br><span class=\"line\"><span class=\"regexp\">              value: 192.168.0.173\t\t#修改为自己的ip（部署nfs的机器ip）</span></span><br><span class=\"line\"><span class=\"regexp\">            - name: NFS_PATH</span></span><br><span class=\"line\"><span class=\"regexp\">              value: /</span>var/nfs/nexus\t\t<span class=\"comment\">#修改为自己的nfs安装目录</span></span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: nfs-client-root</span><br><span class=\"line\">          nfs:</span><br><span class=\"line\">            server: <span class=\"number\">192.168</span>.<span class=\"number\">0.173</span>\t\t<span class=\"comment\">#修改为自己的ip（部署nfs的机器ip）</span></span><br><span class=\"line\">            path: <span class=\"regexp\">/var/n</span>fs/nexus\t\t<span class=\"comment\">#修改为自己的nfs安装目录</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># kubectl apply -f nexus-nfs-client.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建storeclass\"><a href=\"#创建storeclass\" class=\"headerlink\" title=\"创建storeclass\"></a>创建storeclass</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># cat nexus-store-class.yaml</span></span><br><span class=\"line\">apiVersion: storage.k8s.io/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: StorageClass</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nexus-nfs-storage</span><br><span class=\"line\">  namespace: nexus</span><br><span class=\"line\">provisioner: <span class=\"keyword\">my</span>-nexus-nfs</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> nexus]<span class=\"comment\"># kubectl apply -f nexus-store-class.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"检查nfs客户端和storeclass创建是否成功\"><a href=\"#检查nfs客户端和storeclass创建是否成功\" class=\"headerlink\" title=\"检查nfs客户端和storeclass创建是否成功\"></a>检查nfs客户端和storeclass创建是否成功</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get StorageClass -n nexus -o wide</span><br><span class=\"line\"> </span><br><span class=\"line\">kubectl get pod -n nexus -o wide</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"部署禅道\"><a href=\"#部署禅道\" class=\"headerlink\" title=\"部署禅道\"></a>部署禅道</h2><h3 id=\"创建-pv-和-pvc\"><a href=\"#创建-pv-和-pvc\" class=\"headerlink\" title=\"创建 pv 和 pvc\"></a>创建 pv 和 pvc</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> zentao]<span class=\"comment\"># cat zentao-pv-pvc.yaml </span></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: PersistentVolume</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: zentao-pv</span><br><span class=\"line\">  namespace: work</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    pv: zentao-pv</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  capacity:</span><br><span class=\"line\">    storage: 3Gi</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  persistentVolumeReclaimPolicy: Recycle</span><br><span class=\"line\">  storageClassName: zentao-nfs</span><br><span class=\"line\">  nfs:</span><br><span class=\"line\">    path: <span class=\"regexp\">/data/</span>zentao</span><br><span class=\"line\">    server: <span class=\"number\">192.168</span>.<span class=\"number\">0.173</span></span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: zentao-pvc</span><br><span class=\"line\">  namespace: work</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteOnce</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 3Gi</span><br><span class=\"line\">  storageClassName: zentao-nfs</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      pv: zentao-pv</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> zentao]<span class=\"comment\"># kubectl apply -f zentao-pv-pvc.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建deployment\"><a href=\"#创建deployment\" class=\"headerlink\" title=\"创建deployment\"></a>创建deployment</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> zentao]<span class=\"comment\"># cat zentao-deployment.yaml </span></span><br><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: zentao</span><br><span class=\"line\">  namespace: work</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: zentao</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: zentao</span><br><span class=\"line\">  replicas: <span class=\"number\">1</span></span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: zentao</span><br><span class=\"line\">    spec:</span><br><span class=\"line\"><span class=\"comment\">#     tolerations:             # 添加的容忍污点，到下面300结束</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\"><span class=\"comment\">#        - key: &quot;node.kubernetes.io/unreachable&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          operator: &quot;Exists&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#          effect: &quot;NoExecute&quot; # 此处修改为 &#x27;NoExecute&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#          tolerationSeconds: 300</span></span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: zentao</span><br><span class=\"line\">        image: easysoft/zentao</span><br><span class=\"line\">        env:</span><br><span class=\"line\">        - name: ADMINER_USER</span><br><span class=\"line\">          value: <span class=\"string\">&#x27;root&#x27;</span></span><br><span class=\"line\">        - name: ADMINER_PASSWD</span><br><span class=\"line\">          value: <span class=\"string\">&#x27;Qingfeng@123&#x27;</span></span><br><span class=\"line\">        - name: BIND_ADDRESS</span><br><span class=\"line\">          value: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">        - name: SMTP_HOST</span><br><span class=\"line\">          value: <span class=\"string\">&#x27;192.168.0.211&#x27;</span></span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - name: zentao</span><br><span class=\"line\">          containerPort: <span class=\"number\">80</span></span><br><span class=\"line\">        - name: mysql</span><br><span class=\"line\">          containerPort: <span class=\"number\">3306</span></span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: zentao</span><br><span class=\"line\">          mountPath: <span class=\"regexp\">/opt/</span>zentao</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: zentao</span><br><span class=\"line\">          persistentVolumeClaim:</span><br><span class=\"line\">            claimName: zentao-pvc</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> zentao]<span class=\"comment\"># kubectl apply -f zentao-deployment.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建service\"><a href=\"#创建service\" class=\"headerlink\" title=\"创建service\"></a>创建service</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> zentao]<span class=\"comment\"># cat zentao-svc.yaml </span></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: zentao</span><br><span class=\"line\">  name: zentao</span><br><span class=\"line\">  namespace: work</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: zentao</span><br><span class=\"line\">    port: <span class=\"number\">80</span></span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: <span class=\"number\">80</span></span><br><span class=\"line\">    nodePort: <span class=\"number\">30061</span></span><br><span class=\"line\">  - name: mysql</span><br><span class=\"line\">    port: <span class=\"number\">3306</span></span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: <span class=\"number\">3306</span></span><br><span class=\"line\">    nodePort: <span class=\"number\">30056</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: zentao</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># 创建</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> zentao]<span class=\"comment\"># kubectl apply -f zentao-svc.yaml </span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"查看创建的zentao服务是否正常运行\"><a href=\"#查看创建的zentao服务是否正常运行\" class=\"headerlink\" title=\"查看创建的zentao服务是否正常运行\"></a>查看创建的zentao服务是否正常运行</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get all -n work -o wide</span><br><span class=\"line\">kubeclt get pv,pvc -n work</span><br><span class=\"line\">kubectl get svc -n work</span><br><span class=\"line\">kubectl get po -n work -o wide</span><br><span class=\"line\">kubectl get po zentao-55bcc7c689-g45wr -n work -o wide</span><br><span class=\"line\">kubectl describe po zentao-55bcc7c689-g45wr -n work -o wide</span><br><span class=\"line\">kubectl logs zentao-55bcc7c689-g45wr -n work</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"访问\"><a href=\"#访问\" class=\"headerlink\" title=\"访问\"></a>访问</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在哪个节点上就用哪个节点的IP地址，</span></span><br><span class=\"line\">浏览器访问：IP + 端口<span class=\"number\">30061</span>\t\t<span class=\"comment\"># 30061端口是在svc文件里自定义的</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 注：web上输入MySQL密码时，密码为123456</span></span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Kubernetes","Zentao"]},{"title":"K8s 公网部署（错误修改）","url":"/2025/11/06/K8s-%E5%85%AC%E7%BD%91%E9%83%A8%E7%BD%B2%EF%BC%88%E9%94%99%E8%AF%AF%E4%BF%AE%E6%94%B9%EF%BC%89/","content":"<h1 id=\"k8s公网部署\"><a href=\"#k8s公网部署\" class=\"headerlink\" title=\"k8s公网部署\"></a>k8s公网部署</h1><p><strong>翻新之前的文章</strong><br><a href=\"https://7boe.top/archives/187\">写的很乱的，多种安装方式</a></p>\n<blockquote>\n<p>本次实验使用三台机器在不同地区进行部署，实验环境使用到香港服务器和杭州阿里云服务器，公网环境部署网络稳定性不能得到保证，本文部署方式仅供参考。</p>\n</blockquote>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><p><strong>环境</strong></p>\n<table>\n<thead>\n<tr>\n<th>软件</th>\n<th>软件版本</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Docker</td>\n<td>20.0.1</td>\n</tr>\n<tr>\n<td>Kubernetes</td>\n<td>1.23.6</td>\n</tr>\n</tbody></table>\n<p><strong>服务器规划</strong></p>\n<table>\n<thead>\n<tr>\n<th>服务器主机名</th>\n<th>服务器公网IP</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>master</td>\n<td>149.104.23.134</td>\n</tr>\n<tr>\n<td>node1</td>\n<td>121.41.53.83</td>\n</tr>\n<tr>\n<td>node2</td>\n<td>116.62.32.149</td>\n</tr>\n</tbody></table>\n<hr>\n<p><strong>解析hosts</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &gt;&gt; /etc/hosts &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">149.104.23.134 master</span></span><br><span class=\"line\"><span class=\"string\">121.41.53.83 node1</span></span><br><span class=\"line\"><span class=\"string\">116.62.32.149 node2</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>执行初始化脚本</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSl https://git.7boe.top/root/Shell/-/raw/af8fc85f5d15181942fc791305dc64e94c32c36e/k8s.sh?inline=<span class=\"literal\">false</span>)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Docker安装\"><a href=\"#Docker安装\" class=\"headerlink\" title=\"Docker安装\"></a>Docker安装</h3><p><strong>安装软件导入docker官方源</strong></p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install -y yum-utils </span><br><span class=\"line\">yum-config-manager --<span class=\"keyword\">add</span>-repo http:<span class=\"comment\">//mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>使用docker20版本</strong></p>\n<figure class=\"highlight lua\"><table><tr><td class=\"code\"><pre><span class=\"line\">sudo yum install docker-ce<span class=\"number\">-20.10</span><span class=\"number\">.14</span><span class=\"number\">-3.</span>el7 docker-ce-cli<span class=\"number\">-20.10</span><span class=\"number\">.14</span><span class=\"number\">-3.</span>el7 containerd.<span class=\"built_in\">io</span> docker-compose-plugin</span><br></pre></td></tr></table></figure>\n\n<p><strong>其他版本有部分差异，可能会出奇怪问题。</strong><br><strong>换docker镜像源</strong></p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"code\"><pre><span class=\"line\">cat &lt;&lt;<span class=\"variable constant_\">EOF</span> &gt; <span class=\"regexp\">/etc/</span>docker/daemon.<span class=\"property\">json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;registry-mirrors&quot;</span>: [</span><br><span class=\"line\">        <span class=\"string\">&quot;http://hub-mirror.c.163.com&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;https://registry.docker-cn.com&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;exec-opts&quot;</span>: [<span class=\"string\">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable constant_\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>设置开机自启</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload &amp;&amp; systemctl restart docker &amp;&amp; systemctl <span class=\"built_in\">enable</span> docker &amp;&amp; systemctl status docker </span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>这里没有安装cri,因为k8s1.23版本还在提供docker作为容器运行</p>\n</blockquote>\n<p><strong>确认这里一定是systemd</strong></p>\n<blockquote>\n<p>因为k8s是默认systemd作为cgroup driver，如果Docker使用另外的驱动，则可能出现不稳定的情况。</p>\n</blockquote>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker info | <span class=\"keyword\">grep</span> <span class=\"string\">&quot;Cgroup Driver&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装k8s\"><a href=\"#安装k8s\" class=\"headerlink\" title=\"安装k8s\"></a>安装k8s</h3><p><strong>k8s导入源使用阿里云的源</strong></p>\n<figure class=\"highlight makefile\"><table><tr><td class=\"code\"><pre><span class=\"line\">cat &gt; /etc/yum.repos.d/kubernetes.repo &lt;&lt; EOF</span><br><span class=\"line\">[kubernetes]</span><br><span class=\"line\">name=Kubernetes</span><br><span class=\"line\">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">repo_gpgcheck=0</span><br><span class=\"line\">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<p><strong>安装k8s</strong></p>\n<figure class=\"highlight lua\"><table><tr><td class=\"code\"><pre><span class=\"line\">sudo yum install -y kubelet<span class=\"number\">-1.23</span><span class=\"number\">.6</span> kubeadm<span class=\"number\">-1.23</span><span class=\"number\">.6</span> kubectl<span class=\"number\">-1.23</span><span class=\"number\">.6</span> <span class=\"comment\">--disableexcludes=kubernetes</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>开机自启</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet &amp;&amp; systemctl start kubelet &amp;&amp; systemctl status kubelet</span><br></pre></td></tr></table></figure>\n\n<p><strong>拉取镜像</strong></p>\n<figure class=\"highlight lua\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubeadm <span class=\"built_in\">config</span> images pull <span class=\"comment\">--kubernetes-version=v1.23.6 --image-repository registry.aliyuncs.com/google_containers</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>也可以使用配置文件拉取</strong></p>\n<figure class=\"highlight lua\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim kubeadm-<span class=\"built_in\">config</span>-image.yaml</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight makefile\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">apiVersion: kubeadm.k8s.io/v1beta2</span></span><br><span class=\"line\"><span class=\"section\">kind: ClusterConfiguration</span></span><br><span class=\"line\"><span class=\"section\">imageRepository: registry.aliyuncs.com/google_containers </span></span><br></pre></td></tr></table></figure>\n\n<p><strong>拉取</strong></p>\n<figure class=\"highlight lua\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubeadm <span class=\"built_in\">config</span> images pull <span class=\"comment\">--config kubeadm-config-image.yaml</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h3><blockquote>\n<p>之前这里是最头疼的地方，如果是一个内网里面直接就好了，但是公网的话直接写公网ip他就一直报错，提示找不到这个ip，应为阿里云服务器网卡没有绑定公网ip，eth0写的是内网vpc专业网络内网ip，采用的自动对外映射公网方式。</p>\n</blockquote>\n<p><strong>这样初始化要变通一下</strong><br>先生成一个配置文件</p>\n<figure class=\"highlight lua\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubeadm <span class=\"built_in\">config</span> <span class=\"built_in\">print</span> init-defaults &gt; kubeadm-<span class=\"built_in\">config</span>.yaml</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>pod-network-cidr：pod资源的网段，需与pod网络插件的值设置一致。通常，Flannel网络插件的默认为10.244.0.0&#x2F;16，Calico插件的默认值为192.168.0.0&#x2F;16；</li>\n<li>api-server：使用Master作为api-server，所以就是master机器的IP地址。</li>\n<li>image-repository：拉取镜像的镜像仓库，默认是k8s.gcr.io。</li>\n<li>nodeRegistration.name：改成master</li>\n</ul>\n<p>更改配置文件</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kubeadm.k8s.io/v1beta3</span></span><br><span class=\"line\"><span class=\"attr\">bootstrapTokens:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">groups:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">system:bootstrappers:kubeadm:default-node-token</span></span><br><span class=\"line\">  <span class=\"attr\">token:</span> <span class=\"string\">abcdef.0123456789abcdef</span></span><br><span class=\"line\">  <span class=\"attr\">ttl:</span> <span class=\"string\">24h0m0s</span></span><br><span class=\"line\">  <span class=\"attr\">usages:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">signing</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">authentication</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">InitConfiguration</span></span><br><span class=\"line\"><span class=\"attr\">localAPIEndpoint:</span></span><br><span class=\"line\">  <span class=\"attr\">advertiseAddress:</span> <span class=\"number\">149.104</span><span class=\"number\">.23</span><span class=\"number\">.134</span> <span class=\"comment\">#这样改成master的公网ip</span></span><br><span class=\"line\">  <span class=\"attr\">bindPort:</span> <span class=\"number\">6443</span></span><br><span class=\"line\"><span class=\"attr\">nodeRegistration:</span></span><br><span class=\"line\">  <span class=\"attr\">criSocket:</span> <span class=\"string\">/var/run/dockershim.sock</span></span><br><span class=\"line\">  <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">master</span>  <span class=\"comment\">#这样要改成解析的主机名</span></span><br><span class=\"line\">  <span class=\"attr\">taints:</span> <span class=\"literal\">null</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiServer:</span></span><br><span class=\"line\">  <span class=\"attr\">timeoutForControlPlane:</span> <span class=\"string\">4m0s</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kubeadm.k8s.io/v1beta3</span></span><br><span class=\"line\"><span class=\"attr\">certificatesDir:</span> <span class=\"string\">/etc/kubernetes/pki</span></span><br><span class=\"line\"><span class=\"attr\">clusterName:</span> <span class=\"string\">kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">controllerManager:</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"attr\">dns:</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"attr\">etcd:</span></span><br><span class=\"line\">  <span class=\"attr\">local:</span></span><br><span class=\"line\">    <span class=\"attr\">dataDir:</span> <span class=\"string\">/var/lib/etcd</span></span><br><span class=\"line\"><span class=\"attr\">imageRepository:</span> <span class=\"string\">registry.aliyuncs.com/google_containers</span> <span class=\"comment\">#一定要改</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterConfiguration</span></span><br><span class=\"line\"><span class=\"attr\">kubernetesVersion:</span> <span class=\"number\">1.23</span><span class=\"number\">.6</span> <span class=\"comment\">#确认版本号</span></span><br><span class=\"line\"><span class=\"attr\">networking:</span></span><br><span class=\"line\">  <span class=\"attr\">dnsDomain:</span> <span class=\"string\">cluster.local</span></span><br><span class=\"line\">  <span class=\"attr\">serviceSubnet:</span> <span class=\"number\">10.96</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/12</span></span><br><span class=\"line\">  <span class=\"attr\">podSubnet:</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.0</span><span class=\"string\">/16</span>  <span class=\"comment\">#方便安装网络插件</span></span><br><span class=\"line\"><span class=\"attr\">scheduler:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>\n\n<p><strong>检查环境是否支持</strong></p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubeadm <span class=\"keyword\">init</span> phase preflight --config=kubeadm-config.yaml </span><br><span class=\"line\">kubeadm <span class=\"keyword\">init</span> --config=kubeadm-config.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>这里基本是初始化必失败的<br>到这里，会有2种结果：<br>如果是内网，上面的docker版本，kubeadm版本没错的话，会成功.<br>如果在云服务器（腾讯云，阿里云）上，一定会失败（原因和办法在这里）：</p>\n</blockquote>\n<h3 id=\"云服务器初始化失败\"><a href=\"#云服务器初始化失败\" class=\"headerlink\" title=\"云服务器初始化失败\"></a>云服务器初始化失败</h3><figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\">[kubelet<span class=\"operator\">-</span><span class=\"keyword\">check</span>] <span class=\"keyword\">Initial</span> timeout <span class=\"keyword\">of</span> <span class=\"number\">40</span>s passed.</span><br></pre></td></tr></table></figure>\n\n\n\n<blockquote>\n<p>卡在这里应为他找不到你设定的apiserver IP地址<br>但是你必须要初始化，目的是为了生成k8s的配置文件，否则下面的步骤中你会找不到etcd.yaml），失败后再执行下面的步骤！！</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /etc/kubernetes/manifests/etcd.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<p>更改以下配置，<a href=\"https://blog.51cto.com/u_15152259/2690063\">来源文章</a>。</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">- --<span class=\"keyword\">listen</span>-client-urls=https:<span class=\"regexp\">//</span><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>:<span class=\"number\">2379</span>,https:<span class=\"regexp\">//</span><span class=\"number\">101.34</span><span class=\"number\">.112</span><span class=\"number\">.190</span>:<span class=\"number\">2379</span></span><br><span class=\"line\">- --<span class=\"keyword\">listen</span>-peer-urls=https:<span class=\"regexp\">//</span><span class=\"number\">101.34</span><span class=\"number\">.112</span><span class=\"number\">.190</span>:<span class=\"number\">2380</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>改成</strong></p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">- --<span class=\"keyword\">listen</span>-client-urls=https:<span class=\"regexp\">//</span><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>:<span class=\"number\">2379</span></span><br><span class=\"line\">- --<span class=\"keyword\">listen</span>-peer-urls=https:<span class=\"regexp\">//</span><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>:<span class=\"number\">2380</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>因为上方的地址他监听不到，要改成本地</strong></p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop kubelet </span><br><span class=\"line\">netstat -anp |<span class=\"keyword\">grep</span> kube</span><br></pre></td></tr></table></figure>\n\n<blockquote>\n<p>请注意，不要执行 kubeadm reset，先 systemctl stop kubelet ，然后手动通过 netstat -anp |grep kube 来找pid，再通过 kill -9 pid 强杀。否则又会生成错误的etcd配置文件，这里非常关键！！！</p>\n</blockquote>\n<p><strong>重新初始化，但是跳过etcd文件已经存在的检查：</strong></p>\n<figure class=\"highlight csharp\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\"># 重新启动kubelet</span></span><br><span class=\"line\">systemctl start kubelet</span><br><span class=\"line\">重新初始化，跳过配置文件生成环节，不要etcd的修改要被覆盖掉</span><br><span class=\"line\">kubeadm <span class=\"keyword\">init</span> --config=kubeadm-config.yaml --skip-phases=preflight,certs,kubeconfig,kubelet-start,control-plane,etcd</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"成功初始化\"><a href=\"#成功初始化\" class=\"headerlink\" title=\"成功初始化\"></a>成功初始化</h3><p>如果所有配置都正常，很快会输出下面的信息（秒级别）代表了成功，否则大概率是失败（由于网络超时等）：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"></span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">Alternatively, <span class=\"keyword\">if</span> you are the root user, you can run:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run <span class=\"string\">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\">Then you can <span class=\"built_in\">join</span> any number of worker nodes by running the following on each as root:</span><br><span class=\"line\">加入k8s 命令</span><br></pre></td></tr></table></figure>\n\n<p><strong>后面命令要是没了用这个，生成一个新的</strong></p>\n<figure class=\"highlight lua\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubeadm token <span class=\"built_in\">create</span> <span class=\"comment\">--print-join-command</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>token忘记</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubeadm token list</span><br></pre></td></tr></table></figure>\n\n<p><strong>每一个节点都执行的话都可以操作kubectl,文件要scp过去</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装网络插件\"><a href=\"#安装网络插件\" class=\"headerlink\" title=\"安装网络插件\"></a>安装网络插件</h2><h3 id=\"calico\"><a href=\"#calico\" class=\"headerlink\" title=\"calico\"></a>calico</h3><p><strong>查看官网文档，看对应版本</strong></p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"symbol\">https:</span>/<span class=\"regexp\">/docs.tigera.io/calico</span><span class=\"regexp\">/3.25/getting</span>-started/kubernetes/<span class=\"variable language_\">self</span>-managed-onprem/onpremises</span><br></pre></td></tr></table></figure>\n\n<p><strong>3.25目前支持1.23的k8s</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">https://docs.tigera.io/calico/3.25/getting-started/kubernetes/requirements</span><br></pre></td></tr></table></figure>\n\n<p><strong>安装</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"flannel\"><a href=\"#flannel\" class=\"headerlink\" title=\"flannel\"></a>flannel</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">如果您使用自定义podCIDR（不是10.244.0.0/16），您首先需要下载上述清单并修改网络以匹配您的网络。</span><br><span class=\"line\">kubectl apply -f https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"允许master节点部署pod\"><a href=\"#允许master节点部署pod\" class=\"headerlink\" title=\"允许master节点部署pod\"></a>允许master节点部署pod</h2><p><strong>调度策略</strong></p>\n<ul>\n<li>NoSchedule: 一定不能被调度</li>\n<li>PreferNoSchedule: 尽量不要调度</li>\n<li>NoExecute: 不仅不会调度, 还会驱逐Node上已有的Pod</li>\n</ul>\n<p><strong>查看当前调度策略</strong></p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl describe node|<span class=\"keyword\">grep</span> -E <span class=\"string\">&quot;Name:|Taints:&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>更改master节点可被部署pod</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Kubernetes"]},{"title":"KVM 虚拟机部署","url":"/2025/11/06/KVM-%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%83%A8%E7%BD%B2/","content":"<h2 id=\"什么是虚拟化\"><a href=\"#什么是虚拟化\" class=\"headerlink\" title=\"什么是虚拟化:\"></a>什么是虚拟化:</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">vmm、Hypervisor 是提供真正虚拟机管理程序的，---创建，删除-开关机。</span><br><span class=\"line\"></span><br><span class=\"line\">Hypervisor是属于内核功能的，操作系统内核的一个模块。把和内核交互的工具称之为用户肽工具：比如：virsh命令行、virt-manager图形界面，</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"虚拟化产品分类\"><a href=\"#虚拟化产品分类\" class=\"headerlink\" title=\"虚拟化产品分类:\"></a>虚拟化产品分类:</h2><p><code>桌面级虚拟化</code><br><code>企业级虚拟机化</code></p>\n<h2 id=\"虚拟化产品分类：\"><a href=\"#虚拟化产品分类：\" class=\"headerlink\" title=\"虚拟化产品分类：\"></a>虚拟化产品分类：</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.Kvm（redhat-----企业级）</span><br><span class=\"line\">2.Vmware:</span><br><span class=\"line\">Vmware-workstation(windows和linux)----桌面级</span><br><span class=\"line\">Vmware-fusion(mac)</span><br><span class=\"line\">Vmware-esxi-----(企业级别)本身就是一个操作系统。</span><br><span class=\"line\">3.hyper-v(微软）</span><br><span class=\"line\">4.Ovm（oracle公司--Windows linux） virtulbox</span><br><span class=\"line\">5.Xen（rhel6之前所有版本默认用的虚拟化产品）</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h2><p><strong>第一步先在VMware上创建一个虚拟机（内存能多大就做多大）</strong></p>\n<p><code>虚拟机安装好，打开设置--处理器--虚拟化引擎--勾选第一个</code></p>\n<p><img src=\"/upload/kvm1.webp\" alt=\"kvm1.webp\"></p>\n<p><strong>打开虚拟机，查看cpu是否支持虚拟化</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># cat /proc/cpuinfo | grep -E &#x27;vmx|svm&#x27;</span></span><br><span class=\"line\">cmx|svm支持其中一个就可以</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"构建环境\"><a href=\"#构建环境\" class=\"headerlink\" title=\"构建环境\"></a>构建环境</h2><p><code>关闭防火墙和selinux</code></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">清理环境，卸载机器自带的kvm</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># yum -y remove `rpm -qa | egrep &#x27;qemu|virt|kvm&#x27;`</span></span><br><span class=\"line\"><span class=\"comment\">#删除储存虚拟机的介质、虚拟机配置文件</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># rm -rf /var/lib/libvirt  /etc/libvirt/</span></span><br><span class=\"line\"><span class=\"comment\">#升级所有包同时也升级软件和系统内核</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># yum upgrade -y</span></span><br><span class=\"line\"><span class=\"comment\">#安装软件</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># yum install *qemu*  *virt*  librbd1-devel -y</span></span><br><span class=\"line\">其实下载的是下面几款软件</span><br><span class=\"line\"><span class=\"comment\"># qemu-kvm libvirt virt-manager  librbd1-devel</span></span><br><span class=\"line\">qemu-kvm ： 主包</span><br><span class=\"line\">libvirt：api接口</span><br><span class=\"line\">virt-manager：图形化界面</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在所谓的kvm技术中，应用到的其实有2个东西：qemu+kvm</span></span><br><span class=\"line\">kvm负责cpu虚拟化+内存虚拟化，实现了cpu和内存的虚拟化，但kvm不能模拟其他设备；</span><br><span class=\"line\">qemu是模拟IO设备（网卡，磁盘），kvm加上qemu之后就能实现真正意义上服务器虚拟化。</span><br><span class=\"line\">因为用到了上面两个东西，所以一般都称之为qemu-kvm。</span><br><span class=\"line\">libvirt则是调用kvm虚拟化技术的接口用于管理的，用libvirt管理方便，直接用qemu-kvm的接口太繁琐。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动服务</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># systemctl start libvirtd</span></span><br><span class=\"line\"><span class=\"comment\">#查看kvm模块加载</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># lsmod | grep kvm</span></span><br><span class=\"line\">kvm_intel             188644  0 </span><br><span class=\"line\">kvm                   621480  1 kvm_intel</span><br><span class=\"line\">irqbypass              13503  1 kvm</span><br><span class=\"line\">如果看到有这两行，说明支持kvm模块</span><br></pre></td></tr></table></figure>\n\n<p><strong>下面就可以在VMware里面再安装虚拟机了</strong></p>\n<h2 id=\"图形添加虚拟机\"><a href=\"#图形添加虚拟机\" class=\"headerlink\" title=\"图形添加虚拟机\"></a>图形添加虚拟机</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">在终端输入virt-manager--点击电脑图标创建--本地安装介质--选择使用ISO映像，另外</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/kvm2.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm3.webp\" alt=\"kvm3.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm4.webp\" alt=\"kvm4.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm5.webp\" alt=\"kvm5.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm6.webp\" alt=\"kvm6.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm7.webp\" alt=\"kvm7.png\"></p>\n<h2 id=\"文本添加虚拟机\"><a href=\"#文本添加虚拟机\" class=\"headerlink\" title=\"文本添加虚拟机\"></a>文本添加虚拟机</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#安装ftp，并配置最后将镜像上传到ftp中</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># yum install -y vsftpd</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># mkdir /var/ftp/centos7u4</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># mount /root/CentOS-7-x86_64-DVD-1708.iso /var/ftp/centos7u4/</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virt-install --connect qemu:///system -n vm10 -r 2050 --disk path=/var/lib/libvirt/images/vm10.img,size=5  --os-type=linux --os-variant=centos7.0 --vcpus=1  --location=ftp://10.0.111.182/centos7u4 -x console=ttyS0 --nographics</span></span><br><span class=\"line\"></span><br><span class=\"line\">注意:</span><br><span class=\"line\">virt-install </span><br><span class=\"line\">bash: virt-install: 未找到命令...</span><br><span class=\"line\"><span class=\"comment\"># yum install libguestfs-tools -y</span></span><br><span class=\"line\"><span class=\"comment\"># yum install virt-install.noarch -y</span></span><br><span class=\"line\"></span><br><span class=\"line\">如果还是有问题没办法安装，需要vsftp匿名授权，添加以下内容</span><br><span class=\"line\">vim /etc/vsftpd/vsftpd.conf\t\t//配置文件</span><br><span class=\"line\"><span class=\"attr\">anonymous_enable</span>=<span class=\"literal\">YES</span> \t\t \t//开启匿名登录</span><br><span class=\"line\"><span class=\"attr\">anon_upload_enable</span>=<span class=\"literal\">YES</span> \t\t\t//匿名读</span><br><span class=\"line\"><span class=\"attr\">anon_mkdir_write_enable</span>=<span class=\"literal\">YES</span> \t//匿名写</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启下vsftp</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># systemctl restart vsftpd</span></span><br><span class=\"line\"></span><br><span class=\"line\">参数解释：</span><br><span class=\"line\">-n name</span><br><span class=\"line\">-r  以M为单位指定分配给虚拟机的内存大小</span><br><span class=\"line\">--disk 指定作为客户机存储的媒介 size以G为单位的存储</span><br><span class=\"line\">--os-type   系统类型</span><br><span class=\"line\">--os-variant 系统类型版本</span><br><span class=\"line\">--vcpus 指定核数，不能超过物理cpu</span><br><span class=\"line\">--location  客户虚拟机安装源下载，必须为镜像挂载在ftp目录下</span><br><span class=\"line\">-x <span class=\"attr\">console</span>=ttyS0 执行终端<span class=\"number\">0</span></span><br><span class=\"line\">--nographics 无图形，文本模式</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#以下就是进入命令安装</span></span><br><span class=\"line\">1、选2，进入use text mode</span><br><span class=\"line\">2、将所有的！进行编辑，编辑好的状态是×</span><br><span class=\"line\">3、更改时间选2 -- 1 set timezone-- 2 Asia -- 65 Shanghai</span><br><span class=\"line\">4、设置磁盘5 -- c to continue -- 2 Use All Space -- c to continue -- 3 LVM -- c to continue </span><br><span class=\"line\">5、设置密码8 -- 自己设定一个密码 -- yes</span><br><span class=\"line\">6、设置完成-- b</span><br><span class=\"line\">7、开始创建，大概20分钟左右</span><br><span class=\"line\">8、出现installation complete. press return to quit--按回车退出--下面的操作根据提示点点就可以了</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"模板镜像-配置文件-方式安装虚拟机—重点\"><a href=\"#模板镜像-配置文件-方式安装虚拟机—重点\" class=\"headerlink\" title=\"模板镜像+配置文件 方式安装虚拟机—重点\"></a>模板镜像+配置文件 方式安装虚拟机—重点</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.虚拟机配置文件</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ls /etc/libvirt/qemu</span></span><br><span class=\"line\">networks  vm2.xml</span><br><span class=\"line\">2.储存虚拟机的介质</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ls /var/lib/libvirt/images/</span></span><br><span class=\"line\"><span class=\"attr\">vm2.img</span></span><br><span class=\"line\">==============================</span><br><span class=\"line\">define方式创建好，不会启动</span><br><span class=\"line\">create方式创建好，会启动</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 拷贝模板镜像和配置文件</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># cp /etc/libvirt/qemu/vm2.xml /etc/libvirt/qemu/vm3.xml(自定义名字)</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># cp /var/lib/libvirt/images/vm2.img /var/lib/libvirt/images/vm3.img (自定义名字)</span></span><br><span class=\"line\"><span class=\"comment\"># 修改配置文件</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># vim /etc/libvirt/qemu/vm3.xml</span></span><br><span class=\"line\">domain <span class=\"attr\">type</span>=<span class=\"string\">&#x27;kvm&#x27;</span>&gt;</span><br><span class=\"line\">  &lt;name&gt;vm3&lt;/name&gt;  <span class=\"comment\">#名字不能一样需要修改</span></span><br><span class=\"line\">  &lt;uuid&gt;2e3fa6db-ff7f-41c3-bc8f-0428e81ebb57&lt;/uuid&gt; <span class=\"comment\">#uuid不能一样需要修改</span></span><br><span class=\"line\">  &lt;memory <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;<span class=\"number\">1024000</span>&lt;/memory&gt;  <span class=\"comment\">#内存，可选</span></span><br><span class=\"line\">  &lt;currentMemory <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;<span class=\"number\">1024000</span>&lt;/currentMemory&gt;  <span class=\"comment\">#当前内存与上面定义一样</span></span><br><span class=\"line\">  &lt;vcpu <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;<span class=\"number\">2</span>&lt;/vcpu&gt;  <span class=\"comment\">#cpu可选</span></span><br><span class=\"line\">  &lt;os&gt;</span><br><span class=\"line\">  。。。</span><br><span class=\"line\">  。。。</span><br><span class=\"line\">  。。。</span><br><span class=\"line\">    &lt;devices&gt;</span><br><span class=\"line\">    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</span><br><span class=\"line\">    &lt;disk <span class=\"attr\">type</span>=<span class=\"string\">&#x27;file&#x27;</span> device=<span class=\"string\">&#x27;disk&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;driver <span class=\"attr\">name</span>=<span class=\"string\">&#x27;qemu&#x27;</span> type=<span class=\"string\">&#x27;qcow2&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;source <span class=\"attr\">file</span>=<span class=\"string\">&#x27;/var/lib/libvirt/images/vm3.img&#x27;</span>/&gt;   <span class=\"comment\">#磁盘镜像需要修改</span></span><br><span class=\"line\">      &lt;target <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;vda&#x27;</span> bus=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> domain=<span class=\"string\">&#x27;0x0000&#x27;</span> bus=<span class=\"string\">&#x27;0x00&#x27;</span> slot=<span class=\"string\">&#x27;0x07&#x27;</span> function=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/disk&gt;</span><br><span class=\"line\"> 。。。</span><br><span class=\"line\"> 。。。</span><br><span class=\"line\"> 。。。</span><br><span class=\"line\">     &lt;/controller&gt;</span><br><span class=\"line\">    &lt;interface <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;mac <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:82:d6:3c&#x27;</span>/&gt;  <span class=\"comment\">#mac地址不能一样需要修改，只能修改后三段。</span></span><br><span class=\"line\">      &lt;source <span class=\"attr\">network</span>=<span class=\"string\">&#x27;default&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;model <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#必须修改name，uuid,mac地址,磁盘文件名字,其余可选</span></span><br><span class=\"line\"></span><br><span class=\"line\">用vim修改完之后需要define一下配置文件</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh define /etc/libvirt/qemu/vm3.xml</span></span><br><span class=\"line\">重启一下：</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># systemctl restart libvirtd</span></span><br><span class=\"line\">宿主机开启路由转发：</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># vim /etc/sysctl.conf </span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># sysctl -p</span></span><br><span class=\"line\"><span class=\"attr\">net.ipv4.ip_forward</span> = <span class=\"number\">1</span></span><br><span class=\"line\">查看虚拟机列表：</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh list --all</span></span><br><span class=\"line\"> Id    名称                         状态</span><br><span class=\"line\">----------------------------------------------------</span><br><span class=\"line\"> -     vm2                            关闭</span><br><span class=\"line\"> -     vm3                            关闭</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"KVM虚拟机管理\"><a href=\"#KVM虚拟机管理\" class=\"headerlink\" title=\"KVM虚拟机管理\"></a>KVM虚拟机管理</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh list  #列出在运行状态中的虚拟机</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh list --all  #列出所有虚拟机</span></span><br><span class=\"line\">查看kvm虚拟机配置文件：</span><br><span class=\"line\"><span class=\"comment\">#语法：virsh dumpxml vm_name</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh dumpxml vm3</span></span><br><span class=\"line\"></span><br><span class=\"line\">启动</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh start vm2</span></span><br><span class=\"line\">域 vm2 已开始</span><br><span class=\"line\"></span><br><span class=\"line\">暂停虚拟机：</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh suspend vm_name</span></span><br><span class=\"line\">域 vm2 被挂起</span><br><span class=\"line\"></span><br><span class=\"line\">恢复虚拟机：</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh resume vm_name</span></span><br><span class=\"line\">域 vm2 被重新恢复</span><br><span class=\"line\"></span><br><span class=\"line\">关闭：</span><br><span class=\"line\">方法1：</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh shutdown vm3</span></span><br><span class=\"line\">域 vm3 被关闭</span><br><span class=\"line\"></span><br><span class=\"line\">重启：</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh reboot vm3</span></span><br><span class=\"line\">域 vm3 正在被重新启动</span><br><span class=\"line\"></span><br><span class=\"line\">重置:</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh reset vm3</span></span><br><span class=\"line\">vm3   <span class=\"comment\">#断电重启。速度快</span></span><br><span class=\"line\">Domain vm3 was reset</span><br><span class=\"line\"></span><br><span class=\"line\">删除虚拟机:</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh undefine vm2</span></span><br><span class=\"line\">Domain vm2 has been undefined</span><br><span class=\"line\">注意:虚拟机在开启的情况下undefine是无法删除的只是将配置文件删除了，不能删除磁盘文件。需要手动rm，最好还是在virt-manager里面右击删除</span><br><span class=\"line\"></span><br><span class=\"line\">虚拟机开机自动启动:</span><br><span class=\"line\"><span class=\"comment\">#如果虚拟机开机自启，里面的服务应该设置的有开机自启，不然没有意义</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh autostart vm_name</span></span><br><span class=\"line\">域 vm3标记为自动开始</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ls /etc/libvirt/qemu/autostart/     //此目录默认不存在，在有开机启动的虚拟机时自动创建</span></span><br><span class=\"line\">vm3.xml</span><br><span class=\"line\"></span><br><span class=\"line\">关闭开机启动</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh autostart --disable vm_name</span></span><br><span class=\"line\">域 vm3取消标记为自动开始</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ls /etc/libvirt/qemu/autostart/</span></span><br><span class=\"line\"></span><br><span class=\"line\">如何查看已启动的虚拟机ip地址</span><br><span class=\"line\">假如vm3虚拟机已启动</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh domifaddr vm3</span></span><br><span class=\"line\"> 名称     MAC 地址           Protocol     Address</span><br><span class=\"line\">-------------------------------------------------------------------------------</span><br><span class=\"line\"> vnet0      52:54:00:82:d6:3c    ipv4         192.168.122.85/24</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"虚拟机添加设备\"><a href=\"#虚拟机添加设备\" class=\"headerlink\" title=\"虚拟机添加设备\"></a>虚拟机添加设备</h2><p>1、图像方式添加</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">输入virt-manager--右击点击你想要添加设备的虚拟机--查看--详情--左下角--添加硬件--安装需求添加就可以了</span><br></pre></td></tr></table></figure>\n\n<p>2、修改配置文件方式添加</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># qemu-img create -f qcow2 /var/lib/libvirt/images/vm4-1.qcow2 5G</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># cd /etc/libvirt/qemu/</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server qemu]</span><span class=\"comment\"># vim vm3.xml</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/kvm8.webp\" alt=\"kvm8.png\"></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">加好之后，启动虚拟机</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server qemu]</span><span class=\"comment\"># systemctl restart libvirtd</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server qemu]</span><span class=\"comment\"># virsh list --all</span></span><br><span class=\"line\"> Id    名称                         状态</span><br><span class=\"line\">----------------------------------------------------</span><br><span class=\"line\"> 6     centos7.0                      running</span><br><span class=\"line\"> -     vm3                            关闭</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server qemu]</span><span class=\"comment\"># virsh start vm3</span></span><br><span class=\"line\"></span><br><span class=\"line\">可以看到我们新添加的磁盘vdb</span><br><span class=\"line\"><span class=\"comment\">#然后可以正常分区，制作文件系统，进行挂载</span></span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"https://xbd666.cn/upload/kvm9.webp\" alt=\"kvm9.png\"></p>\n<h2 id=\"虚拟机克隆\"><a href=\"#虚拟机克隆\" class=\"headerlink\" title=\"虚拟机克隆\"></a>虚拟机克隆</h2><p>1.图形界面：Applications （左上角）—–&gt; System Tools ——&gt;Virtual Machine Manager<br>   <code>关闭要克隆的虚拟机，右键点击虚拟机选择Clone</code></p>\n<p><img src=\"https://xbd666.cn/upload/kvm10.webp\" alt=\"kvm10.png\"></p>\n<p>2.在终端执行命令克隆</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virt-clone -o vm2 -n vm5 --auto-clone</span></span><br><span class=\"line\">正在分配 &#x27;vm5.qcow2&#x27;                                    | 5.0 GB  00:00     </span><br><span class=\"line\">成功克隆 &#x27;vm5&#x27;。</span><br><span class=\"line\">-o      origin-原始</span><br><span class=\"line\">-n :指定新客户机的名字</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh list --all</span></span><br><span class=\"line\"> Id    名称                         状态</span><br><span class=\"line\">----------------------------------------------------</span><br><span class=\"line\"> -     vm2                            关闭</span><br><span class=\"line\"> -     vm5\t\t                      关闭</span><br></pre></td></tr></table></figure>\n<h2 id=\"kvm高级命令\"><a href=\"#kvm高级命令\" class=\"headerlink\" title=\"kvm高级命令\"></a>kvm高级命令</h2><p>磁盘镜像文件的格式：<code>raw  qcow2</code></p>\n<ul>\n<li>raw：立刻分配空间，不管你有没有用到那么多空间</li>\n<li>qcow2：只是承诺给你分配空间，但是只有当你需要用空间的时候，才会给你空间。最多只给你承诺空间的大小，避免空间浪费</li>\n</ul>\n<h2 id=\"建立qcow2格式磁盘文件\"><a href=\"#建立qcow2格式磁盘文件\" class=\"headerlink\" title=\"建立qcow2格式磁盘文件\"></a>建立qcow2格式磁盘文件</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># pwd</span></span><br><span class=\"line\">/var/lib/libvirt/images</span><br><span class=\"line\"><span class=\"comment\">#创建qcow2格式磁盘格式文件（vm1.qcow2是自定义的磁盘名字）</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># qemu-img create -f qcow2 vm1.qcow2 5G</span></span><br><span class=\"line\">Formatting &#x27;vm1.qcow2&#x27;, <span class=\"attr\">fmt</span>=qcow2 size=<span class=\"number\">5368709120</span> encryption=<span class=\"literal\">off</span> cluster_size=<span class=\"number\">65536</span> lazy_refcounts=<span class=\"literal\">off</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建raw格式磁盘格式文件（vm2.raw是自定义的磁盘名字）</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># qemu-img create -f raw vm2.raw 5G</span></span><br><span class=\"line\">Formatting &#x27;vm2.raw&#x27;, <span class=\"attr\">fmt</span>=raw size=<span class=\"number\">5368709120</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看已经创建的虚拟磁盘文件</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># qemu-img info vm1.qcow2</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># qemu-img info vm2.raw</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"挂载磁盘\"><a href=\"#挂载磁盘\" class=\"headerlink\" title=\"挂载磁盘\"></a>挂载磁盘</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将虚拟机先关闭</span></span><br><span class=\"line\">查看vm2磁盘镜像分区信息--（需要等一会会）</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># virt-df -h -d vm2</span></span><br><span class=\"line\">文件系统                                  大小      已用空间    可用空间     使用百分比%</span><br><span class=\"line\">vm2:/dev/sda1                            1014M        92M       922M         10%</span><br><span class=\"line\">vm2:/dev/centos/root                      3.5G       863M       2.6G         25%</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一个挂载目录</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># mkdir /test</span></span><br><span class=\"line\"><span class=\"comment\">#挂载虚拟机的根分区到test目录</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># guestmount -d vm2 -m /dev/centos/root --rw /test/</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ll /test</span></span><br><span class=\"line\">bin   dev  home  lib64  mnt  proc  run   srv  tmp  var</span><br><span class=\"line\">boot  etc  lib   media  opt  root  sbin  sys  usr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 取消挂载</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># guestunmount /test</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"KVM存储配置\"><a href=\"#KVM存储配置\" class=\"headerlink\" title=\"KVM存储配置\"></a>KVM存储配置</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#kvm默认存储池的位置：</span></span><br><span class=\"line\">    /var/lib/libvirt/images/    </span><br></pre></td></tr></table></figure>\n\n<p>1、图形方式创建存储池</p>\n<p><img src=\"https://xbd666.cn/upload/kvm11.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm12.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm13.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm14.webp\" alt=\"kvm2.png\"></p>\n<p>2、命令方式创建存储池</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.创建基于文件夹的存储池（目录，可自定义）</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># mkdir -p /data/vmfs</span></span><br><span class=\"line\"></span><br><span class=\"line\">2.定义存储池与其目录--（vm1是存储池名字，自己自定义）</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh pool-define-as vm1 --type dir --target /data/vmfs</span></span><br><span class=\"line\">Pool vm1 defined</span><br><span class=\"line\"></span><br><span class=\"line\">3.创建已定义的存储池</span><br><span class=\"line\">(1)构建已定义的存储池</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh pool-build vm1</span></span><br><span class=\"line\">Pool vm1 built</span><br><span class=\"line\"></span><br><span class=\"line\">(2)查看已定义的存储池，存储池不激活无法使用。</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh pool-list --all</span></span><br><span class=\"line\">Name                 State      Autostart </span><br><span class=\"line\">-------------------------------------------</span><br><span class=\"line\"> default             active       yes       </span><br><span class=\"line\"> ISO                 active       yes       </span><br><span class=\"line\"> vm1              inactive     no     </span><br><span class=\"line\"> </span><br><span class=\"line\">4.激活并自动启动已定义的存储池</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh pool-start vm1</span></span><br><span class=\"line\">Pool vm1 started</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh pool-autostart vm1</span></span><br><span class=\"line\">Pool vm1 marked as autostarted</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#此时查看都是在运行中，并且是开机自启</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh pool-list --all</span></span><br><span class=\"line\"> Name                 State      Autostart </span><br><span class=\"line\">-------------------------------------------</span><br><span class=\"line\"> default              active     yes       </span><br><span class=\"line\"> ISO                 active     yes       </span><br><span class=\"line\"> vm1               active     yes   </span><br><span class=\"line\">这里vm1存储池就已经创建好了，可以直接在这个存储池中创建虚拟磁盘文件了。</span><br><span class=\"line\"></span><br><span class=\"line\">5.在存储池中创建虚拟机存储卷--（vm1-1.qcow2是自定义存储卷的名字，2G是自定义的大小）</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh vol-create-as vm1 vm1-1.qcow2 2G --format qcow2 </span></span><br><span class=\"line\">Vol vm1-1.qcow2 created</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ll /data/vmfs/ -h</span></span><br><span class=\"line\">总用量 196K</span><br><span class=\"line\">-rw------- 1 root root 193K 10月 25 16:04 vm1-1.qcow2</span><br><span class=\"line\"></span><br><span class=\"line\">6.存储池相关管理命令</span><br><span class=\"line\">(1)在存储池中删除虚拟机存储卷</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh vol-delete --pool vm1 vm1-1.qcow2</span></span><br><span class=\"line\">Vol vm1-1.qcow2 deleted</span><br><span class=\"line\"></span><br><span class=\"line\">(2)取消激活存储池</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh pool-destroy vm1</span></span><br><span class=\"line\">Pool vm1 destroyed</span><br><span class=\"line\"></span><br><span class=\"line\">(3)删除存储池定义的目录/data/vmfs</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh pool-delete vm1</span></span><br><span class=\"line\">Pool vm1 deleted</span><br><span class=\"line\"></span><br><span class=\"line\">(4)取消定义存储池</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh pool-undefine vm1</span></span><br><span class=\"line\">Pool vm1 has been undefined</span><br><span class=\"line\"></span><br><span class=\"line\">到此kvm存储池配置与管理操作完毕。 </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"kvm快照\"><a href=\"#kvm快照\" class=\"headerlink\" title=\"kvm快照\"></a>kvm快照</h2><p>1、图形方式创建快照</p>\n<p><img src=\"https://xbd666.cn/upload/kvm15.webp\" alt=\"kvm2.png\"></p>\n<p>2、命令方式创建快照</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">为虚拟机vm2创建一个快照（磁盘格式必须为qcow2）</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh snapshot-create-as vm2 vm2.snap1</span></span><br><span class=\"line\"></span><br><span class=\"line\">注意：如果在创建快照的时候报错：</span><br><span class=\"line\">error: unsupported configuration: internal snapshot for disk vda unsupported for storage type raw</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#raw不支持snapshot--可以将raw格式转换成qcow2格式</span></span><br><span class=\"line\"></span><br><span class=\"line\">查看磁盘文件格式</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># qemu-img info /var/lib/libvirt/images/vm2.qcow2</span></span><br><span class=\"line\">image: /var/lib/libvirt/images/vm2.qcow2</span><br><span class=\"line\">file format: qcow2</span><br><span class=\"line\">virtual size: 5.0G (5368709120 bytes)</span><br><span class=\"line\">disk size: 5.0G</span><br><span class=\"line\">cluster_size: 65536</span><br><span class=\"line\">Format specific information:</span><br><span class=\"line\">    compat: 1.1</span><br><span class=\"line\">    lazy refcounts: true</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看某台虚拟机设备的快照</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh snapshot-list  vm2   </span></span><br><span class=\"line\"> Name                 Creation Time             State</span><br><span class=\"line\">------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建一块磁盘</span></span><br><span class=\"line\">创建--格式为raw，名字为vm2-1.raw，大小为2G的磁盘</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># qemu-img create -f raw /var/lib/libvirt/images/vm2-1.raw 2G</span></span><br><span class=\"line\">Formatting &#x27;/var/lib/libvirt/images/vm2-1.raw&#x27;, <span class=\"attr\">fmt</span>=raw size=<span class=\"number\">2147483648</span> </span><br><span class=\"line\"><span class=\"comment\"># 查看</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ll -h /var/lib/libvirt/images/vm2-1.raw</span></span><br><span class=\"line\">-rw-r--r-- 1 root root 2.0G 10月 25 16:25 /var/lib/libvirt/images/vm2-1.raw</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将其添加到vm2虚拟机上面</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># cd /etc/libvirt/qemu/</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server qemu]</span><span class=\"comment\"># vim vm2.xml </span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/kvm16.webp\" alt=\"kvm2.png\"></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 定义配置文件</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># virsh define /etc/libvirt/qemu/vm2.xml</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># virsh start vm2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证raw格式是不能拍快照的</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server qemu]</span><span class=\"comment\"># virsh snapshot-create-as vm2 vm2.snap1</span></span><br><span class=\"line\">错误：不支持的配置：存储类型 vdb 不支持磁盘 raw 的内部快照</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 磁盘格式的转换</span></span><br><span class=\"line\">由于raw的磁盘格式，不支持快照功能，我们需要将其转换为qcow2的格式</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server qemu]</span><span class=\"comment\"># qemu-img convert -O qcow2 /var/lib/libvirt/images/vm2-1.raw  /var/lib/libvirt/images/vm2-1.qcow2</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server qemu]</span><span class=\"comment\"># cd /var/lib/libvirt/images/</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># ll -h </span></span><br><span class=\"line\">总用量 21G</span><br><span class=\"line\">-rw------- 1 root root 5.1G 10月 24 18:59 centos7.0.qcow2</span><br><span class=\"line\">-rw-r--r-- 1 root root 193K 10月 25 16:44 vm2-1.qcow2</span><br><span class=\"line\">-rw-r--r-- 1 root root 2.0G 10月 25 16:25 vm2-1.raw</span><br><span class=\"line\">-rw------- 1 root root 5.1G 10月 25 16:13 vm2.qcow2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># qemu-img info /var/lib/libvirt/images/vm2-1.qcow2</span></span><br><span class=\"line\">image: /var/lib/libvirt/images/vm2-1.qcow2</span><br><span class=\"line\">file format: qcow2</span><br><span class=\"line\">virtual size: 2.0G (2147483648 bytes)</span><br><span class=\"line\">disk size: 196K</span><br><span class=\"line\">cluster_size: 65536</span><br><span class=\"line\">Format specific information:</span><br><span class=\"line\">    compat: 1.1</span><br><span class=\"line\">    lazy refcounts: false</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\"># 然后去修改vm2虚拟机的磁盘格式和名称</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># vim /etc/libvirt/qemu/vm2.xml</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/kvm17.webp\" alt=\"kvm2.png\"></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kvm-server images]</span><span class=\"comment\"># virsh define /etc/libvirt/qemu/vm2.xml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建快照</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server qemu]</span><span class=\"comment\"># virsh snapshot-create-as vm2 vm2.snap2</span></span><br><span class=\"line\">已生成域快照 vm2.snap2</span><br><span class=\"line\"><span class=\"comment\"># 此时raw格式转换成qcow2格式，并快照成功</span></span><br><span class=\"line\"></span><br><span class=\"line\">以下操作为回溯快照</span><br><span class=\"line\"><span class=\"comment\"># 开机并再次创建快照-- 选择一台虚拟机进行快照，此时处于关闭状态</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh snapshot-create-as vm3 vm3-snap1</span></span><br><span class=\"line\">已生成域快照 vm3-snap1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#此时开启vm3虚拟机，并进行快照</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh start vm3</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh snapshot-create-as vm3 vm3-snap2</span></span><br><span class=\"line\">已生成域快照 vm3-snap2</span><br><span class=\"line\"></span><br><span class=\"line\">查看快照</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh snapshot-list vm3 </span></span><br><span class=\"line\"> 名称               生成时间              状态</span><br><span class=\"line\">------------------------------------------------------------</span><br><span class=\"line\"> vm3-snap1            2019-10-30 15:27:15 +0800 running</span><br><span class=\"line\"> vm3-snap2            2019-10-30 15:29:37 +0800 shutoff</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 恢复到快照vm3-snap1，现在虚拟机处于开启状态</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh snapshot-revert vm3 vm3-snap1</span></span><br><span class=\"line\">此时你再看虚拟机状态，是处于关闭状态</span><br><span class=\"line\"></span><br><span class=\"line\">删除虚拟机快照操作：--需要先关闭虚拟机</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh shutdown vm3</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh snapshot-list vm3</span></span><br><span class=\"line\"> 名称               生成时间              状态</span><br><span class=\"line\">------------------------------------------------------------</span><br><span class=\"line\"> vm3-snap1            2019-10-30 15:27:15 +0800 running</span><br><span class=\"line\"> vm3-snap2            2019-10-30 15:29:37 +0800 shutoff</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除快照</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh snapshot-delete --snapshotname vm3-snap2 vm3</span></span><br><span class=\"line\">已删除域快照 vm2-snap3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看验证</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># virsh snapshot-list vm3</span></span><br><span class=\"line\"> 名称               生成时间              状态</span><br><span class=\"line\">------------------------------------------------------------</span><br><span class=\"line\"> vm3-snap1            2019-10-30 15:27:15 +0800 running</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"自动化脚本管理kvm\"><a href=\"#自动化脚本管理kvm\" class=\"headerlink\" title=\"自动化脚本管理kvm\"></a>自动化脚本管理kvm</h2><p><code>运行脚本需要先更改好配置文件内容</code></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#kvm batch create vm tool</span></span><br><span class=\"line\"><span class=\"comment\">#version:0.1</span></span><br><span class=\"line\"><span class=\"comment\">#time:2024-1-7</span></span><br><span class=\"line\"><span class=\"comment\">#author:清风</span></span><br><span class=\"line\"><span class=\"comment\">#需要事先准备模板镜像和配置文件模板</span></span><br><span class=\"line\"></span><br><span class=\"line\">batch_self_define() &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">kvmname</span>=`openssl rand -hex <span class=\"number\">5</span>`</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">sourceimage</span>=/var/lib/libvirt/images/vmmodel.img</span><br><span class=\"line\">        <span class=\"attr\">sourcexml</span>=/etc/libvirt/qemu/vmmodel.xml</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">newimg</span>=/var/lib/libvirt/images/<span class=\"variable\">$&#123;kvmname&#125;</span>.img</span><br><span class=\"line\">        <span class=\"attr\">newxml</span>=/etc/libvirt/qemu/<span class=\"variable\">$&#123;kvmname&#125;</span>.xml</span><br><span class=\"line\"></span><br><span class=\"line\">        cp $sourceimage  $newimg</span><br><span class=\"line\">        cp $sourcexml $newxml</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">kvmuuid</span>=`uuidgen`</span><br><span class=\"line\">        <span class=\"attr\">kvmmem</span>=<span class=\"variable\">$&#123;1&#125;</span><span class=\"number\">000000</span></span><br><span class=\"line\">        <span class=\"attr\">kvmcpu</span>=<span class=\"variable\">$2</span></span><br><span class=\"line\">        </span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"attr\">kvmimg</span>=<span class=\"variable\">$newimg</span></span><br><span class=\"line\">        <span class=\"attr\">kvmmac</span>=`openssl rand -hex <span class=\"number\">3</span> | sed -r <span class=\"string\">&#x27;s/..\\B/&amp;:/g&#x27;</span>`</span><br><span class=\"line\"></span><br><span class=\"line\">        sed -i &quot;s@kvmname@$kvmname@<span class=\"comment\">;s@kvmuuid@$kvmuuid@;s@kvmmem@$kvmmem@;s@kvmcpu@$kvmcpu@;s@kvmimg@$kvmimg@;s@kvmmac@$kvmmac@&quot; $newxml</span></span><br><span class=\"line\">        virsh define $newxml</span><br><span class=\"line\">        virsh list --all</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">self_define() &#123;</span><br><span class=\"line\">        read -p &quot;请输入新虚机名称:&quot; newname</span><br><span class=\"line\">        read -p &quot;请输入新虚机内存大小(G):&quot; newmem</span><br><span class=\"line\">        read -p &quot;请输入新虚机cpu个数:&quot; newcpu</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">sourceimage</span>=/var/lib/libvirt/images/vmmodel.img</span><br><span class=\"line\">        <span class=\"attr\">sourcexml</span>=/etc/libvirt/qemu/vmmodel.xml</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">newimg</span>=/var/lib/libvirt/images/<span class=\"variable\">$&#123;newname&#125;</span>.img</span><br><span class=\"line\">        <span class=\"attr\">newxml</span>=/etc/libvirt/qemu/<span class=\"variable\">$&#123;newname&#125;</span>.xml</span><br><span class=\"line\"></span><br><span class=\"line\">        cp $sourceimage  $newimg</span><br><span class=\"line\">        cp $sourcexml $newxml</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attr\">kvmname</span>=<span class=\"variable\">$newname</span></span><br><span class=\"line\">        <span class=\"attr\">kvmuuid</span>=`uuidgen`</span><br><span class=\"line\">        <span class=\"attr\">kvmmem</span>=<span class=\"variable\">$&#123;newmem&#125;</span><span class=\"number\">000000</span></span><br><span class=\"line\">        <span class=\"attr\">kvmcpu</span>=<span class=\"variable\">$newcpu</span></span><br><span class=\"line\">        <span class=\"attr\">kvmimg</span>=<span class=\"variable\">$newimg</span></span><br><span class=\"line\">        <span class=\"attr\">kvmmac</span>=`openssl rand -hex <span class=\"number\">3</span> | sed -r <span class=\"string\">&#x27;s/..\\B/&amp;:/g&#x27;</span>`</span><br><span class=\"line\"></span><br><span class=\"line\">        sed -i &quot;s@kvmname@$kvmname@<span class=\"comment\">;s@kvmuuid@$kvmuuid@;s@kvmmem@$kvmmem@;s@kvmcpu@$kvmcpu@;s@kvmimg@$kvmimg@;s@kvmmac@$kvmmac@&quot; $newxml</span></span><br><span class=\"line\">        virsh define $newxml</span><br><span class=\"line\">        virsh list --all</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">delete_kvm()&#123;</span><br><span class=\"line\">        virsh list</span><br><span class=\"line\">        while true<span class=\"comment\">;do</span></span><br><span class=\"line\">        read -p &quot;是否需要关闭lvm或退出（Y/N/T）&quot; ynt</span><br><span class=\"line\">        if <span class=\"section\">[ $ynt = y ]</span><span class=\"comment\">;then</span></span><br><span class=\"line\">                read -p &quot;请输入你要关闭的kvm：&quot; numb</span><br><span class=\"line\">                virsh shutdown $numb</span><br><span class=\"line\">        elif <span class=\"section\">[ $ynt = n ]</span><span class=\"comment\">;then</span></span><br><span class=\"line\">                virsh list --all</span><br><span class=\"line\">                read -p &quot;请输入你要删除的kvm：&quot; num</span><br><span class=\"line\">                virsh undefine $num</span><br><span class=\"line\">                <span class=\"comment\">#rm -rf /etc/libvirt/qemu/$num.xml</span></span><br><span class=\"line\">                rm -rf /var/lib/libvirt/images/$num*</span><br><span class=\"line\">                echo &quot;$num 虚拟机已被删除！&quot;</span><br><span class=\"line\">        else</span><br><span class=\"line\">                echo &quot;再见！&quot;</span><br><span class=\"line\">                break</span><br><span class=\"line\">        fi</span><br><span class=\"line\">        done</span><br><span class=\"line\">&#125;  </span><br><span class=\"line\"></span><br><span class=\"line\">exit_menu()&#123;</span><br><span class=\"line\">    green &quot;再见！！！&quot;</span><br><span class=\"line\">    break</span><br><span class=\"line\">&#125;     </span><br><span class=\"line\"></span><br><span class=\"line\">red()&#123;</span><br><span class=\"line\">    echo -e &quot;\\033<span class=\"section\">[31m\\033[01m$1\\033[0m&quot;</span></span><br><span class=\"line\"><span class=\"section\">&#125;</span></span><br><span class=\"line\"><span class=\"section\">green()&#123;</span></span><br><span class=\"line\"><span class=\"section\">    echo -e &quot;\\033[32m\\033[01m$1\\033[0m&quot;</span></span><br><span class=\"line\"><span class=\"section\">&#125;</span></span><br><span class=\"line\"><span class=\"section\">yellow()&#123;</span></span><br><span class=\"line\"><span class=\"section\">    echo -e &quot;\\033[33m\\033[01m$1\\033[0m&quot;</span></span><br><span class=\"line\"><span class=\"section\">&#125;</span></span><br><span class=\"line\"><span class=\"section\">blue()&#123;</span></span><br><span class=\"line\"><span class=\"section\">    echo -e &quot;\\033[34m\\033[01m$1\\033[0m&quot;</span></span><br><span class=\"line\"><span class=\"section\">&#125;</span></span><br><span class=\"line\"><span class=\"section\"></span></span><br><span class=\"line\"><span class=\"section\"># 主菜单选择</span></span><br><span class=\"line\"><span class=\"section\">main_menu() &#123;</span></span><br><span class=\"line\"><span class=\"section\">    while true; do</span></span><br><span class=\"line\"><span class=\"section\">red      &quot;===============================================&quot;</span></span><br><span class=\"line\"><span class=\"section\">green   &quot;||  ____    _____  _______  _________  _______||&quot;</span></span><br><span class=\"line\"><span class=\"section\">yellow  &quot;|| / __ \\  /  _/ |/ / ___/ / __/ __/ |/ / ___/||&quot;</span></span><br><span class=\"line\"><span class=\"section\">blue    &quot;||/ /_/ / _/ //    / (_ / / _// _//    / (_ / ||&quot;</span></span><br><span class=\"line\"><span class=\"section\">yellow  &quot;||\\___\\_\\/___/_/|_/\\___/ /_/ /___/_/|_/\\___/  ||&quot;</span></span><br><span class=\"line\"><span class=\"section\">green   &quot;||                                            ||&quot;</span></span><br><span class=\"line\"><span class=\"section\">red     &quot;===============================================&quot;</span></span><br><span class=\"line\"><span class=\"section\">blue    &quot;||            &gt;&gt;&gt;&gt;&gt; 清风徐来 &lt;&lt;&lt;&lt;&lt;            ||&quot;</span></span><br><span class=\"line\"><span class=\"section\">red     &quot;===============================================&quot;</span></span><br><span class=\"line\"><span class=\"section\">echo &quot;1.创建自定义配置单个虚拟机&quot;</span></span><br><span class=\"line\"><span class=\"section\">echo &quot;2.批量创建自定义配置虚拟机&quot;</span></span><br><span class=\"line\"><span class=\"section\">echo &quot;3.批量创建默认配置虚拟机&quot;</span></span><br><span class=\"line\"><span class=\"section\">echo &quot;4.删除虚拟机&quot;</span></span><br><span class=\"line\"><span class=\"section\">echo &quot;5.退出&quot;</span></span><br><span class=\"line\"><span class=\"section\">red &quot;===============================================&quot;</span></span><br><span class=\"line\"><span class=\"section\"></span></span><br><span class=\"line\"><span class=\"section\">read -p &quot;选取你的操作(1/2/3/4/5):&quot; op</span></span><br><span class=\"line\"><span class=\"section\"></span></span><br><span class=\"line\"><span class=\"section\">case $op in</span></span><br><span class=\"line\"><span class=\"section\">1)self_define;;</span></span><br><span class=\"line\"><span class=\"section\">2)</span></span><br><span class=\"line\"><span class=\"section\">        read -p &quot;请输入要创建的虚拟机的个数:&quot; num</span></span><br><span class=\"line\"><span class=\"section\">        read -p &quot;请输入新虚机内存大小(G):&quot; newmem</span></span><br><span class=\"line\"><span class=\"section\">        read -p &quot;请输入新虚机cpu个数:&quot; newcpu</span></span><br><span class=\"line\"><span class=\"section\"></span></span><br><span class=\"line\"><span class=\"section\">        for((i=1;i&lt;=$num;i++))</span></span><br><span class=\"line\"><span class=\"section\">        do</span></span><br><span class=\"line\"><span class=\"section\">                batch_self_define $newmem $newcpu</span></span><br><span class=\"line\"><span class=\"section\">        done;;</span></span><br><span class=\"line\"><span class=\"section\"></span></span><br><span class=\"line\"><span class=\"section\">3)</span></span><br><span class=\"line\"><span class=\"section\">        read -p &quot;请输入要创建的虚拟机的个数:&quot; num</span></span><br><span class=\"line\"><span class=\"section\"></span></span><br><span class=\"line\"><span class=\"section\">        for((i=1;i&lt;=$num;i++))</span></span><br><span class=\"line\"><span class=\"section\">        do</span></span><br><span class=\"line\"><span class=\"section\">                batch_self_define 1 1</span></span><br><span class=\"line\"><span class=\"section\">        done;;</span></span><br><span class=\"line\"><span class=\"section\">4)</span></span><br><span class=\"line\"><span class=\"section\">        delete_kvm</span></span><br><span class=\"line\"><span class=\"section\">        ;;</span></span><br><span class=\"line\"><span class=\"section\">5)      </span></span><br><span class=\"line\"><span class=\"section\">        exit_menu</span></span><br><span class=\"line\"><span class=\"section\">        ;;</span></span><br><span class=\"line\"><span class=\"section\">*)</span></span><br><span class=\"line\"><span class=\"section\">        echo &quot;输入错误，请重新执行脚本&quot;</span></span><br><span class=\"line\"><span class=\"section\">        exit</span></span><br><span class=\"line\"><span class=\"section\">        ;;</span></span><br><span class=\"line\"><span class=\"section\">esac</span></span><br><span class=\"line\"><span class=\"section\"></span></span><br><span class=\"line\"><span class=\"section\">red &quot;===============================================&quot;</span></span><br><span class=\"line\"><span class=\"section\">read -p &quot;按任意键返回主菜单&quot; any_key</span></span><br><span class=\"line\"><span class=\"section\">clear</span></span><br><span class=\"line\"><span class=\"section\">done</span></span><br><span class=\"line\"><span class=\"section\"></span></span><br><span class=\"line\"><span class=\"section\">&#125;</span></span><br><span class=\"line\"><span class=\"section\"></span></span><br><span class=\"line\"><span class=\"section\">#运行</span></span><br><span class=\"line\"><span class=\"section\">main_menu</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置文件模板\"><a href=\"#配置文件模板\" class=\"headerlink\" title=\"配置文件模板\"></a>配置文件模板</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /etc/libvirt/qemu/vmmodel.xml</span></span><br><span class=\"line\">&lt;domain <span class=\"attr\">type</span>=<span class=\"string\">&#x27;kvm&#x27;</span>&gt;</span><br><span class=\"line\">  &lt;name&gt;kvmname&lt;/name&gt;</span><br><span class=\"line\">  &lt;uuid&gt;kvmuuid&lt;/uuid&gt;</span><br><span class=\"line\">  &lt;memory <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;kvmmem&lt;/memory&gt;</span><br><span class=\"line\">  &lt;currentMemory <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;kvmmem&lt;/currentMemory&gt;</span><br><span class=\"line\">  &lt;vcpu <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;kvmcpu&lt;/vcpu&gt;</span><br><span class=\"line\">  &lt;os&gt;</span><br><span class=\"line\">    &lt;type <span class=\"attr\">arch</span>=<span class=\"string\">&#x27;x86_64&#x27;</span> machine=<span class=\"string\">&#x27;pc-i440fx-rhel7.0.0&#x27;</span>&gt;hvm&lt;/type&gt;</span><br><span class=\"line\">    &lt;boot <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;hd&#x27;</span>/&gt;</span><br><span class=\"line\">  &lt;/os&gt;</span><br><span class=\"line\">  &lt;features&gt;</span><br><span class=\"line\">    &lt;acpi/&gt;</span><br><span class=\"line\">    &lt;apic/&gt;</span><br><span class=\"line\">  &lt;/features&gt;</span><br><span class=\"line\">  &lt;cpu <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;custom&#x27;</span> match=<span class=\"string\">&#x27;exact&#x27;</span> check=<span class=\"string\">&#x27;partial&#x27;</span>&gt;</span><br><span class=\"line\">    &lt;model <span class=\"attr\">fallback</span>=<span class=\"string\">&#x27;allow&#x27;</span>&gt;Haswell-noTSX&lt;/model&gt;</span><br><span class=\"line\">  &lt;/cpu&gt;</span><br><span class=\"line\">  &lt;clock <span class=\"attr\">offset</span>=<span class=\"string\">&#x27;utc&#x27;</span>&gt;</span><br><span class=\"line\">    &lt;timer <span class=\"attr\">name</span>=<span class=\"string\">&#x27;rtc&#x27;</span> tickpolicy=<span class=\"string\">&#x27;catchup&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;timer <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pit&#x27;</span> tickpolicy=<span class=\"string\">&#x27;delay&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;timer <span class=\"attr\">name</span>=<span class=\"string\">&#x27;hpet&#x27;</span> present=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span><br><span class=\"line\">  &lt;/clock&gt;</span><br><span class=\"line\">  &lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;</span><br><span class=\"line\">  &lt;on_reboot&gt;restart&lt;/on_reboot&gt;</span><br><span class=\"line\">  &lt;on_crash&gt;destroy&lt;/on_crash&gt;</span><br><span class=\"line\">  &lt;pm&gt;</span><br><span class=\"line\">    &lt;suspend-to-mem <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;suspend-to-disk <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span><br><span class=\"line\">  &lt;/pm&gt;</span><br><span class=\"line\">  &lt;devices&gt;</span><br><span class=\"line\">    &lt;emulator&gt;/usr/libexec/qemu-kvm&lt;/emulator&gt;</span><br><span class=\"line\">    &lt;disk <span class=\"attr\">type</span>=<span class=\"string\">&#x27;file&#x27;</span> device=<span class=\"string\">&#x27;disk&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;driver <span class=\"attr\">name</span>=<span class=\"string\">&#x27;qemu&#x27;</span> type=<span class=\"string\">&#x27;qcow2&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;source <span class=\"attr\">file</span>=<span class=\"string\">&#x27;kvmimg&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;target <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;vda&#x27;</span> bus=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> domain=<span class=\"string\">&#x27;0x0000&#x27;</span> bus=<span class=\"string\">&#x27;0x00&#x27;</span> slot=<span class=\"string\">&#x27;0x06&#x27;</span> function=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/disk&gt;</span><br><span class=\"line\">    &lt;controller <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> index=<span class=\"string\">&#x27;0&#x27;</span> model=<span class=\"string\">&#x27;ich9-ehci1&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> domain=<span class=\"string\">&#x27;0x0000&#x27;</span> bus=<span class=\"string\">&#x27;0x00&#x27;</span> slot=<span class=\"string\">&#x27;0x04&#x27;</span> function=<span class=\"string\">&#x27;0x7&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/controller&gt;</span><br><span class=\"line\">    &lt;controller <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> index=<span class=\"string\">&#x27;0&#x27;</span> model=<span class=\"string\">&#x27;ich9-uhci1&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;master <span class=\"attr\">startport</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> domain=<span class=\"string\">&#x27;0x0000&#x27;</span> bus=<span class=\"string\">&#x27;0x00&#x27;</span> slot=<span class=\"string\">&#x27;0x04&#x27;</span> function=<span class=\"string\">&#x27;0x0&#x27;</span> multifunction=<span class=\"string\">&#x27;on&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/controller&gt;</span><br><span class=\"line\">    &lt;controller <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> index=<span class=\"string\">&#x27;0&#x27;</span> model=<span class=\"string\">&#x27;ich9-uhci2&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;master <span class=\"attr\">startport</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> domain=<span class=\"string\">&#x27;0x0000&#x27;</span> bus=<span class=\"string\">&#x27;0x00&#x27;</span> slot=<span class=\"string\">&#x27;0x04&#x27;</span> function=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/controller&gt;</span><br><span class=\"line\">    &lt;controller <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> index=<span class=\"string\">&#x27;0&#x27;</span> model=<span class=\"string\">&#x27;ich9-uhci3&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;master <span class=\"attr\">startport</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> domain=<span class=\"string\">&#x27;0x0000&#x27;</span> bus=<span class=\"string\">&#x27;0x00&#x27;</span> slot=<span class=\"string\">&#x27;0x04&#x27;</span> function=<span class=\"string\">&#x27;0x2&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/controller&gt;</span><br><span class=\"line\">    &lt;controller <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> index=<span class=\"string\">&#x27;0&#x27;</span> model=<span class=\"string\">&#x27;pci-root&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;controller <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> index=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> domain=<span class=\"string\">&#x27;0x0000&#x27;</span> bus=<span class=\"string\">&#x27;0x00&#x27;</span> slot=<span class=\"string\">&#x27;0x05&#x27;</span> function=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/controller&gt;</span><br><span class=\"line\">    &lt;interface <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;mac <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:kvmmac&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;source <span class=\"attr\">network</span>=<span class=\"string\">&#x27;default&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;model <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> domain=<span class=\"string\">&#x27;0x0000&#x27;</span> bus=<span class=\"string\">&#x27;0x00&#x27;</span> slot=<span class=\"string\">&#x27;0x03&#x27;</span> function=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/interface&gt;</span><br><span class=\"line\">    &lt;serial <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;target <span class=\"attr\">type</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span> port=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span><br><span class=\"line\">        &lt;model <span class=\"attr\">name</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;/target&gt;</span><br><span class=\"line\">    &lt;/serial&gt;</span><br><span class=\"line\">    &lt;console <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;target <span class=\"attr\">type</span>=<span class=\"string\">&#x27;serial&#x27;</span> port=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/console&gt;</span><br><span class=\"line\">    &lt;channel <span class=\"attr\">type</span>=<span class=\"string\">&#x27;unix&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;target <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span> name=<span class=\"string\">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> controller=<span class=\"string\">&#x27;0&#x27;</span> bus=<span class=\"string\">&#x27;0&#x27;</span> port=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/channel&gt;</span><br><span class=\"line\">    &lt;input <span class=\"attr\">type</span>=<span class=\"string\">&#x27;mouse&#x27;</span> bus=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;input <span class=\"attr\">type</span>=<span class=\"string\">&#x27;keyboard&#x27;</span> bus=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;memballoon <span class=\"attr\">model</span>=<span class=\"string\">&#x27;virtio&#x27;</span>&gt;</span><br><span class=\"line\">      &lt;address <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> domain=<span class=\"string\">&#x27;0x0000&#x27;</span> bus=<span class=\"string\">&#x27;0x00&#x27;</span> slot=<span class=\"string\">&#x27;0x07&#x27;</span> function=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span><br><span class=\"line\">    &lt;/memballoon&gt;</span><br><span class=\"line\">  &lt;/devices&gt;</span><br><span class=\"line\">&lt;/domain&gt;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"随机生成mac地址\"><a href=\"#随机生成mac地址\" class=\"headerlink\" title=\"随机生成mac地址\"></a>随机生成mac地址</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">B:字母数字与字母数字分割，非字母数字与非字母数字分割</span><br><span class=\"line\">&amp;:表示原来的内容</span><br><span class=\"line\"></span><br><span class=\"line\">其中方式如下：</span><br><span class=\"line\"><span class=\"comment\"># echo `openssl rand -hex 1`:`openssl rand -hex 1`:`openssl rand -hex 1`</span></span><br><span class=\"line\">99:6e:67</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># openssl rand -hex 3 | sed -r &#x27;s/(..)(..)(..)/\\1:\\2:\\3/g&#x27;</span></span><br><span class=\"line\">94:89:e3</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># openssl rand -hex 3 | sed -r &#x27;s/..\\B/&amp;:/g&#x27;</span></span><br><span class=\"line\">c5:66:90</span><br><span class=\"line\"></span><br><span class=\"line\">参数解释：</span><br><span class=\"line\">openssl rand -hex 5</span><br><span class=\"line\">openssl rand  <span class=\"comment\">#用来生成随机数的</span></span><br><span class=\"line\">-hex <span class=\"comment\">#表示为16进制的数</span></span><br><span class=\"line\">5  <span class=\"comment\">#表示长度</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"KVM网络配置\"><a href=\"#KVM网络配置\" class=\"headerlink\" title=\"KVM网络配置\"></a>KVM网络配置</h2><h2 id=\"四种网络\"><a href=\"#四种网络\" class=\"headerlink\" title=\"四种网络\"></a>四种网络</h2><p><code>1.NAT default方式：</code>支持主机与虚拟机互访，虚拟机访问外界网络，但不支持外界访问虚拟机。<br><code>2.isolated隔离，vmware--host-only：仅主机模式。</code>外网不能访问虚拟机，虚拟机也不能访问外网<br><code>3.bridge </code> —-桥接模式属于桥接口<br><code>4.路由模式</code></p>\n<p><strong>nat网络</strong></p>\n<p><img src=\"https://xbd666.cn/upload/kvm18.webp\" alt=\"kvm2.png\"></p>\n<p><strong>桥接网络</strong></p>\n<p><img src=\"https://xbd666.cn/upload/kvm19.webp\" alt=\"kvm2.png\"></p>\n<p><strong>隔离网络</strong></p>\n<p><img src=\"https://xbd666.cn/upload/kvm20.webp\" alt=\"kvm2.png\"></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#查看管理接口对应的网卡</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># brctl show </span></span><br><span class=\"line\">bridge name\tbridge id\t\tSTP enabled\tinterfaces</span><br><span class=\"line\">virbr0\t\t8000.525400831963\tyes\t\tvirbr0-nic</span><br><span class=\"line\">\t\t\t\t\t\t\t           vnet0</span><br><span class=\"line\">\t\t\t\t\t\t\t           vnet1</span><br><span class=\"line\"></span><br><span class=\"line\">注意：这里vnet网卡，是每台启动的虚拟机正在使用的网卡设备，每台虚拟机使用的不同\t\t\t     </span><br><span class=\"line\"><span class=\"comment\"># 从交换机上把vnet网卡删除：</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># brctl delif virbr0 vnet0</span></span><br><span class=\"line\"></span><br><span class=\"line\">来到vm2的虚拟机，ping不通百度</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ping baidu.com</span></span><br><span class=\"line\">ping:baidu.com:Name or service not known</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 添加vnet网卡添加到交换机上：</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># brctl addif virbr0 vnet0</span></span><br><span class=\"line\">\t</span><br><span class=\"line\">来到vm2的虚拟机，恢复正常</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ping baidu.com</span></span><br><span class=\"line\">PING www.a.shifen.com (61.135.169.125)56(84) bytes of data.</span><br><span class=\"line\">64  bytes from 61.135.169.125(61.135.169.125): <span class=\"attr\">icmp_seq</span>=<span class=\"number\">1</span> ttl=<span class=\"number\">55</span> time=<span class=\"number\">2.24</span> ms</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置文件方式配置桥接：在宿主机上\"><a href=\"#配置文件方式配置桥接：在宿主机上\" class=\"headerlink\" title=\"配置文件方式配置桥接：在宿主机上\"></a>配置文件方式配置<code>桥接</code>：在宿主机上</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置文件方式配置桥接：在宿主机上</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># ip a   #先找出宿主机用的哪个网卡设备，我的是enp0s25</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># cd /etc/sysconfig/network-scripts/</span></span><br><span class=\"line\">1.定义网卡配置文件</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server network-scripts]</span><span class=\"comment\"># vim ifcfg-br0    #创建该桥接网卡，默认没有此文件需要新建</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server network-scripts]</span><span class=\"comment\"># cat ifcfg-br0</span></span><br><span class=\"line\"><span class=\"attr\">TYPE</span>=Bridge  <span class=\"comment\">#定义类型</span></span><br><span class=\"line\"><span class=\"attr\">NAME</span>=br0  <span class=\"comment\">#设备的名字</span></span><br><span class=\"line\"><span class=\"attr\">DEVICE</span>=br0</span><br><span class=\"line\"><span class=\"attr\">ONBOOT</span>=<span class=\"string\">&quot;yes&quot;</span></span><br><span class=\"line\"><span class=\"attr\">BOOTPROTO</span>=static</span><br><span class=\"line\"><span class=\"attr\">IPADDR</span>=<span class=\"number\">10.31</span>.<span class=\"number\">162.90</span>   <span class=\"comment\">#要和宿主机在一个网络，这里我用的是宿主机的ip</span></span><br><span class=\"line\"><span class=\"attr\">GATEWAY</span>=<span class=\"number\">10.31</span>.<span class=\"number\">162.1</span>   <span class=\"comment\">#宿主的网关，nat的是.2,桥接是.1</span></span><br><span class=\"line\"><span class=\"attr\">NETMASK</span>=<span class=\"number\">255.255</span>.<span class=\"number\">255.0</span></span><br><span class=\"line\"><span class=\"attr\">DNS1</span>=<span class=\"number\">114.144</span>.<span class=\"number\">144.144</span></span><br><span class=\"line\"><span class=\"attr\">DNS2</span>=<span class=\"number\">8.8</span>.<span class=\"number\">8.8</span></span><br><span class=\"line\"></span><br><span class=\"line\">然后看清楚宿主机正在使用的网卡，修改配置文件,(将物理机网卡桥到桥接网卡)</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server network-scripts]</span><span class=\"comment\"># cp ifcfg-enp0s25 ifcfg-enp0s25.back</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server network-scripts]</span><span class=\"comment\"># vim ifcfg-enp0s25</span></span><br><span class=\"line\"><span class=\"attr\">NAME</span>=enp0s25   <span class=\"comment\">#定义网卡设备名称</span></span><br><span class=\"line\"><span class=\"attr\">DEVICE</span>=enp0s25   <span class=\"comment\">#宿主机正在使用的网卡设备</span></span><br><span class=\"line\"><span class=\"attr\">ONBOOT</span>=<span class=\"literal\">yes</span></span><br><span class=\"line\"><span class=\"attr\">BRIDGE</span>=br0     <span class=\"comment\">#和ifcfg-br0文件里面的设备对应，新添加</span></span><br><span class=\"line\">  </span><br><span class=\"line\">2.重启libvirtd服务</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server network-scripts]</span><span class=\"comment\"># systemctl restart libvirtd </span></span><br><span class=\"line\">3.重启network服务 </span><br><span class=\"line\"><span class=\"section\">[root@kvm-server network-scripts]</span><span class=\"comment\"># systemctl restart network     </span></span><br></pre></td></tr></table></figure>\n\n<p><strong>然后去查看有没有新设备生成</strong></p>\n<p><img src=\"https://xbd666.cn/upload/kvm21.webp\" alt=\"kvm2.png\"></p>\n<p><strong>可以看到，我们先添加的网卡设备</strong></p>\n<p><img src=\"https://xbd666.cn/upload/kvm22.webp\" alt=\"kvm2.png\"><br><code>添加完成后，运行虚拟机查看IP地址，就可以看到添加的桥接网卡了</code></p>\n<h2 id=\"移除桥接网卡操作\"><a href=\"#移除桥接网卡操作\" class=\"headerlink\" title=\"移除桥接网卡操作\"></a>移除<code>桥接网卡</code>操作</h2><p><img src=\"https://xbd666.cn/upload/kvm23.webp\" alt=\"kvm2.png\"></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">删除桥接网卡步骤：</span><br><span class=\"line\">1.删除br0的配置文件</span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># cd /etc/sysconfig/network-scripts/</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost network-scripts]</span><span class=\"comment\"># rm -rf ifcfg-br0 </span></span><br><span class=\"line\"><span class=\"section\">[root@localhost network-scripts]</span><span class=\"comment\"># rm -rf ifcfg-ens33</span></span><br><span class=\"line\"></span><br><span class=\"line\">2.修改正常网卡的配置文件</span><br><span class=\"line\"><span class=\"comment\"># 将之前备份的恢复</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost network-scripts]</span><span class=\"comment\"># cp ifcfg-ens33.bak ifcfg-ens33</span></span><br><span class=\"line\">3.重启系统</span><br><span class=\"line\"><span class=\"section\">[root@localhost network-scripts]</span><span class=\"comment\"># systemctl restart network</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost network-scripts]</span><span class=\"comment\"># systemctl restart libvirtd</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"通过配置文件方式创建nat网络：\"><a href=\"#通过配置文件方式创建nat网络：\" class=\"headerlink\" title=\"通过配置文件方式创建nat网络：\"></a>通过配置文件方式创建nat网络：</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置文件方式创建nat网络：</span><br><span class=\"line\">1.首先需要一个模板文件，通过这个模板文件创建自定义的nat网络。</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># cd /etc/libvirt/qemu/networks</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server networks]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">autostar default.xml</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server networks]</span><span class=\"comment\"># cp default.xml nat1.xml</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server networks]</span> <span class=\"comment\"># vim nat1.xml  </span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/kvm24.webp\" alt=\"kvm2.png\"></p>\n<p><strong>重启服务</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kvm-server netwoeks]</span><span class=\"comment\"># systemctl  restart libvirtd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#然后选择一个虚拟机进行添加</span></span><br><span class=\"line\">在某个（比如vm3）虚拟机去添加此设备测试</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/kvm25.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm26.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm27.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm28.webp\" alt=\"kvm2.png\"></p>\n<h2 id=\"创建isolated网络，隔离网络\"><a href=\"#创建isolated网络，隔离网络\" class=\"headerlink\" title=\"创建isolated网络，隔离网络\"></a>创建isolated网络，隔离网络</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置文件方式创建isolated网络隔离网络：</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server ~]</span><span class=\"comment\"># cd /etc/libvirt/qemu/networks</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server networks]</span><span class=\"comment\"># cp default.xml isolated200.xml</span></span><br><span class=\"line\"><span class=\"section\">[root@kvm-server networks]</span><span class=\"comment\"># vim isolated200.xml</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/kvm29.webp\" alt=\"kvm2.png\"></p>\n<p><strong>启动：</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kvm-server networks]</span><span class=\"comment\"># systemctl restart libvirtd</span></span><br><span class=\"line\">开机自启动:</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server networks]</span><span class=\"comment\"># virsh net-autostart  isolated200</span></span><br><span class=\"line\"></span><br><span class=\"line\">查看所有的网络：</span><br><span class=\"line\"><span class=\"section\">[root@kvm-server networks]</span><span class=\"comment\"># virsh net-list</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/kvm30.webp\" alt=\"kvm2.png\"></p>\n<h2 id=\"图文方式创建nat网络\"><a href=\"#图文方式创建nat网络\" class=\"headerlink\" title=\"图文方式创建nat网络\"></a>图文方式创建nat网络</h2><p><img src=\"https://xbd666.cn/upload/kvm31.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm32.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm33.webp\" alt=\"kvm2.png\"></p>\n<p><img src=\"https://xbd666.cn/upload/kvm34.webp\" alt=\"kvm2.png\"></p>\n","categories":["operations"],"tags":["Linux","KVM"]},{"title":"Markdown的基本语法","url":"/2025/11/06/Markdown%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/","content":"<p><a href=\"http://xbd666.cn/\">清风</a><br><code>Markdown是一种纯文本格式的标记语言。通过简单的标记语法，它可以使普通文本内容具有一定的格式。（文章内容引用网络）</code></p>\n<p><code>优点：</code></p>\n<ul>\n<li>1、因为是纯文本，所以只要支持Markdown的地方都能获得一样的编辑效果，可以让作者摆脱排版的困扰，专心写作。</li>\n<li>2、操作简单。比如:WYSIWYG编辑时标记个标题，先选中内容，再点击导航栏的标题按钮，选择几级标题。要三个步骤。而Markdown只需要在标题内容前加#即可</li>\n</ul>\n<p><code>缺点：</code></p>\n<ul>\n<li>1、需要记一些语法（当然，是很简单。五分钟学会）。</li>\n<li>2、有些平台不支持Markdown编辑模式。</li>\n</ul>\n<p>还好，简书是支持Markdown编辑模式的。</p>\n<h2 id=\"一、标题\"><a href=\"#一、标题\" class=\"headerlink\" title=\"一、标题\"></a>一、标题</h2><p>在想要设置为标题的文字前面加#来表示 <code>一个#</code>是一级标题，<code>二个#</code>是二级标题，<code>以此类推</code>。支持<code>六级标题</code>。</p>\n<p>注：标准语法一般在#后跟个空格再写文字，貌似简书不加空格也行。</p>\n<p>示例：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">这是一级标题</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># 这是二级标题</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">## 这是三级标题</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">### 这是四级标题</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">#### 这是五级标题</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">##### 这是六级标题</span></span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"二、字体\"><a href=\"#二、字体\" class=\"headerlink\" title=\"二、字体\"></a>二、字体</h2><p>加粗 <strong>要加粗的文字左右<code>分别用两个\\*号</code>包起来</strong></p>\n<p>斜体 <em>要倾斜的文字左右<code>分别用一个*号</code>包起来</em></p>\n<p>斜体加粗 <em><strong>要倾斜和加粗的文字左右<code>分别用三个\\*号</code>包起来</strong></em></p>\n<p>删除线 <del>要加删除线的文字左右&#96;分别用两个</del>号&#96;包起来~~</p>\n<h2 id=\"三、引用\"><a href=\"#三、引用\" class=\"headerlink\" title=\"三、引用\"></a>三、引用</h2><ul>\n<li>在引用的文字<code>前加&gt;即可</code>。引用也可以嵌套，如加两个&gt;&gt;三个&gt;&gt;&gt; n个… 貌似可以一直加下去，但没神马卵用</li>\n</ul>\n<p>示例：</p>\n<blockquote>\n<p>这是引用的内容</p>\n<blockquote>\n<p>这是引用的内容</p>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<blockquote>\n<p>这是引用的内容</p>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n</blockquote>\n<h2 id=\"四、分割线\"><a href=\"#四、分割线\" class=\"headerlink\" title=\"四、分割线\"></a>四、分割线</h2><p>三个或者三个以上的 &#96;- 或者 * 都可以。</p>\n<hr>\n<hr>\n<h2 id=\"五、图片\"><a href=\"#五、图片\" class=\"headerlink\" title=\"五、图片\"></a>五、图片</h2><p>语法</p>\n<figure class=\"highlight less\"><table><tr><td class=\"code\"><pre><span class=\"line\">!<span class=\"selector-attr\">[图片alt]</span>(图片地址 <span class=\"string\">&#x27;&#x27;</span>图片title<span class=\"string\">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>\n\n<p><strong>Less</strong></p>\n<p>图片alt就是显示在图片下面的文字，相当于对图片内容的解释。 图片title是图片的标题，当鼠标移到图片上时显示的内容。title可加可不加</p>\n<p>例</p>\n<p><img src=\"https://xbd666.cn/upload/%E6%B8%85%E9%A3%8E2-removebg-preview.png\" alt=\"高可用01.png\"></p>\n<h2 id=\"六、超链接\"><a href=\"#六、超链接\" class=\"headerlink\" title=\"六、超链接\"></a>六、超链接</h2><figure class=\"highlight less\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[超链接名]</span>(超链接地址 <span class=\"string\">&quot;超链接title&quot;</span>)</span><br><span class=\"line\"><span class=\"selector-tag\">title</span>可加可不加</span><br></pre></td></tr></table></figure>\n\n<p><strong>Less</strong></p>\n<p>例</p>\n<figure class=\"highlight less\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-attr\">[清风]</span>(<span class=\"attribute\">http</span>:<span class=\"comment\">//xbd666.cn)</span></span><br><span class=\"line\">[简书](<span class=\"attribute\">http</span>:<span class=\"comment\">//jianshu.com)</span></span><br><span class=\"line\">[百度](<span class=\"attribute\">http</span>:<span class=\"comment\">//baidu.com)</span></span><br></pre></td></tr></table></figure>\n<p>实例<br><a href=\"http://xbd666.cn/\">清风</a><br><a href=\"http://jianshu.com/\">简书</a><br><a href=\"http://baidu.com/\">百度</a><br><strong>Less</strong></p>\n<p>注：Markdown本身语法不支持链接在新页面中打开，貌似简书做了处理，是可以的。别的平台可能就不行了，如果想要在新页面中打开的话可以用html语言的a标签代替。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;超链接地址&quot;</span> <span class=\"attr\">target</span>=<span class=\"string\">&quot;_blank&quot;</span>&gt;</span>超链接名<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">示例</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;https://www.jianshu.com/u/1f5ac0cf6a8b&quot;</span> <span class=\"attr\">target</span>=<span class=\"string\">&quot;_blank&quot;</span>&gt;</span>简书<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>XML</strong></p>\n<h2 id=\"表格\"><a href=\"#表格\" class=\"headerlink\" title=\"表格\"></a>表格</h2><table>\n<thead>\n<tr>\n<th>name</th>\n<th>Wang</th>\n<th>Wei</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1111</td>\n<td>1111</td>\n<td>1111</td>\n</tr>\n</tbody></table>\n<p>例如</p>\n<figure class=\"highlight diff\"><table><tr><td class=\"code\"><pre><span class=\"line\">name|Wang|Wei</span><br><span class=\"line\"><span class=\"comment\">-----|----|------</span></span><br><span class=\"line\">1111|1111|1111</span><br></pre></td></tr></table></figure>\n\n<p><strong>Diff</strong></p>\n<blockquote>\n<p>常用的目前就这么多，我也不清楚哎(づ￣3￣)づ╭❤～</p>\n</blockquote>\n","categories":["operations"],"tags":["Linux","Markdown"]},{"title":"Minio存储部署","url":"/2025/11/05/Minio%E5%AD%98%E5%82%A8%E9%83%A8%E7%BD%B2/","content":"<h3 id=\"minio–单节点\"><a href=\"#minio–单节点\" class=\"headerlink\" title=\"minio–单节点\"></a>minio–单节点</h3><h4 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h4><p>MinIO 是一个高性能的对象存储服务器，兼容 Amazon S3 API。它主要用于存储海量的非结构化数据，如图片、视频、备份文件、日志文件等。MinIO 是开源的，并且设计为云原生应用，适用于私有云、公有云和混合云环境。</p>\n<ol>\n<li><p><strong>对象存储</strong>：</p>\n<ul>\n<li>MinIO 提供了对象存储服务，允许用户存储和检索任意数量的非结构化数据。</li>\n<li>数据以对象的形式存储，每个对象包含文件数据、元数据和唯一的对象标识符。</li>\n</ul>\n</li>\n<li><p><strong>兼容 S3 API</strong>：</p>\n<ul>\n<li>MinIO 兼容 Amazon S3 API，这意味着使用 S3 API 的应用可以无缝迁移到 MinIO。</li>\n<li>支持常用的 S3 操作，如创建桶（bucket）、上传&#x2F;下载对象、设置权限等。</li>\n</ul>\n</li>\n<li><p><strong>高性能</strong>：</p>\n<ul>\n<li>MinIO 设计为高性能对象存储，能够在标准硬件上提供极高的吞吐量和低延迟。</li>\n<li>适用于需要快速数据访问的场景，如实时数据分析、机器学习等。</li>\n</ul>\n</li>\n<li><p><strong>可扩展性</strong>：</p>\n<ul>\n<li>MinIO 支持水平扩展，通过增加节点可以扩展存储容量和处理能力。</li>\n<li>支持分布式部署，适用于大规模存储需求。</li>\n</ul>\n</li>\n<li><p><strong>高可用性</strong>：</p>\n<ul>\n<li>MinIO 提供数据冗余和自动故障恢复，确保数据的高可用性和可靠性。</li>\n<li>支持多副本存储和纠删码（Erasure Coding）技术，防止数据丢失。</li>\n</ul>\n</li>\n<li><p><strong>安全性</strong>：</p>\n<ul>\n<li>MinIO 支持数据加密、访问控制和审计日志，确保数据存储和传输的安全性。</li>\n<li>支持基于角色的访问控制（RBAC）和细粒度的权限管理。</li>\n</ul>\n</li>\n<li><p><strong>多云和混合云支持</strong>：</p>\n<ul>\n<li>MinIO 可以在私有云、公有云和混合云环境中部署，支持跨云的数据管理。</li>\n<li>提供统一的存储接口，简化多云环境中的数据管理。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"资源需求\"><a href=\"#资源需求\" class=\"headerlink\" title=\"资源需求\"></a>资源需求</h4><ul>\n<li><strong>CPU</strong>: 4 核 </li>\n<li><strong>内存</strong>:  8 GB </li>\n<li><strong>存储</strong>: 4T</li>\n<li><strong>节点</strong>：1</li>\n</ul>\n<h4 id=\"网络端口\"><a href=\"#网络端口\" class=\"headerlink\" title=\"网络端口\"></a>网络端口</h4><ol>\n<li><strong>默认服务端口</strong><ul>\n<li><strong>端口号</strong>: 9000</li>\n<li><strong>用途</strong>: MinIO API 服务端口，用于客户端与 MinIO 服务器的通信。</li>\n</ul>\n</li>\n<li><strong>控制台端口（Console）</strong><ul>\n<li><strong>端口号</strong>: 9001</li>\n<li><strong>用途</strong>: MinIO 控制台（管理界面）端口，用于管理和监控 MinIO。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h4><pre><code># 下载docker\n\n# 下载minio镜像\ndocker pull minio/minio:RELEASE.2024-05-27T19-17-46Z.fips\n# 创建目录\nmkdir -p /data/minio/data\n#启动\ndocker run -d \\\n   --net=host \\\n   --user $(id -u):$(id -g) \\\n   --name minio \\\n   -e &quot;MINIO_ROOT_USER=minioadmin&quot; \\\n   -e &quot;MINIO_ROOT_PASSWORD=minioadmin&quot; \\\n   -v /data/minio/data:/data \\\n   minio/minio:RELEASE.2024-05-27T19-17-46Z.fips server /data --console-address &quot;:9001&quot; --address &quot;:9000&quot;    \n# 访问：http://10.100.40.212:9001/login 用户名：密码  minioadmin：minioadmin\n</code></pre>\n","categories":["operations"],"tags":["Linux","Minio"]},{"title":"MongoDB部署","url":"/2025/11/06/MongoDB%E9%83%A8%E7%BD%B2/","content":"<h3 id=\"MongoDB\"><a href=\"#MongoDB\" class=\"headerlink\" title=\"MongoDB\"></a>MongoDB</h3><h4 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h4><p>MongoDB 是一种开源的文档型 NoSQL 数据库，采用 BSON（二进制 JSON）格式存储数据。以下是 MongoDB 的主要作用和用途：</p>\n<ol>\n<li><p><strong>灵活的数据模型</strong>:</p>\n<ul>\n<li>MongoDB 使用文档存储数据，文档之间可以有不同的结构。这种灵活性使得 MongoDB 非常适合处理不规则和变化频繁的数据。</li>\n</ul>\n</li>\n<li><p><strong>大数据和实时分析</strong>:</p>\n<ul>\n<li>MongoDB 的高性能和扩展性使其适合处理大数据和实时分析应用。它能够快速存储和查询大量数据，并支持实时数据处理。</li>\n</ul>\n</li>\n<li><p><strong>内容管理和目录服务</strong>:</p>\n<ul>\n<li>MongoDB 常用于内容管理系统（CMS）和目录服务，适合存储和管理大量的文档、图像、视频等非结构化数据。</li>\n</ul>\n</li>\n<li><p><strong>物联网（IoT）和传感器数据</strong>:</p>\n<ul>\n<li>由于 MongoDB 可以高效地存储和处理大量的时间序列数据，它非常适合物联网应用中的传感器数据存储和分析。</li>\n</ul>\n</li>\n<li><p><strong>移动应用和社交网络</strong>:</p>\n<ul>\n<li>MongoDB 的灵活性和高性能使其成为移动应用和社交网络的理想选择，能够处理用户生成的内容、用户个人资料、消息和活动流等数据。</li>\n</ul>\n</li>\n<li><p><strong>电子商务</strong>:</p>\n<ul>\n<li>在电子商务平台中，MongoDB 可以用于存储产品目录、用户数据、订单信息等，并支持复杂的查询和数据分析。</li>\n</ul>\n</li>\n<li><p><strong>日志和事件存储</strong>:</p>\n<ul>\n<li>MongoDB 可以用于存储和分析日志数据和事件数据，适用于日志管理、监控和审计等场景。</li>\n</ul>\n</li>\n<li><p><strong>地理空间数据</strong>:</p>\n<ul>\n<li>MongoDB 提供了强大的地理空间查询功能，可以存储和查询地理位置数据，适用于地图服务、定位服务等应用。</li>\n</ul>\n</li>\n<li><p><strong>分布式文件存储</strong>:</p>\n<ul>\n<li>MongoDB 的 GridFS 功能允许存储和检索大文件，如图像、视频和音频文件，适合作为分布式文件存储系统。</li>\n</ul>\n</li>\n<li><p><strong>高可用性和扩展性</strong>:</p>\n<ul>\n<li>MongoDB 支持复制集和分片机制，能够实现数据的高可用性和水平扩展，适合大规模分布式系统。</li>\n</ul>\n</li>\n<li><p><strong>快速开发和迭代</strong>:</p>\n<ul>\n<li>由于 MongoDB 的模式灵活性，开发人员可以快速进行数据模型的修改和应用程序的迭代，适合敏捷开发和快速原型设计。</li>\n</ul>\n</li>\n</ol>\n<p>MongoDB 的文档存储模型、灵活性、高性能和扩展性使其成为现代应用程序中处理多样化和大规模数据的理想选择。</p>\n<h4 id=\"资源需求\"><a href=\"#资源需求\" class=\"headerlink\" title=\"资源需求\"></a>资源需求</h4><ul>\n<li><strong>CPU</strong>:  4 核 </li>\n<li><strong>内存</strong>: 32GB </li>\n<li><strong>存储</strong>: 500G</li>\n<li><strong>节点</strong>：1</li>\n</ul>\n<h4 id=\"网络端口\"><a href=\"#网络端口\" class=\"headerlink\" title=\"网络端口\"></a>网络端口</h4><ul>\n<li><p><strong>默认端口</strong></p>\n<ul>\n<li><p><strong>端口号</strong>: 27017</p>\n</li>\n<li><p><strong>用途</strong>: MongoDB 默认的客户端连接端口，用于应用程序和用户连接到 MongoDB 数据库进行数据操作。</p>\n</li>\n</ul>\n</li>\n<li><p><strong>副本集成员之间的通信端口</strong></p>\n<ul>\n<li><strong>端口号</strong>: 27017（默认）</li>\n<li><strong>用途</strong>: 副本集成员之间通过该端口进行数据同步和心跳检测。</li>\n</ul>\n</li>\n<li><p><strong>分片集群配置服务器端口</strong></p>\n<ul>\n<li><strong>端口号</strong>: 27019</li>\n<li><strong>用途</strong>: 分片集群中的配置服务器使用的默认端口。</li>\n</ul>\n</li>\n<li><p><strong>分片服务器端口</strong></p>\n<ul>\n<li><strong>端口号</strong>: 27018</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 下载安装包</span><br><span class=\"line\">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.0.6.tgz</span><br><span class=\"line\">curl -O https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-3.4.24.tgz</span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost ~]# ls</span><br><span class=\"line\">anaconda-ks.cfg  mongodb-linux-x86_64-rhel70-4.0.6.tgz</span><br><span class=\"line\">[root@localhost ~]# systemctl stop friewalld</span><br><span class=\"line\">Failed to stop friewalld.service: Unit friewalld.service not loaded.</span><br><span class=\"line\">[root@localhost ~]# setenforce 0</span><br><span class=\"line\">[root@localhost ~]# systemctl disable firewalld</span><br><span class=\"line\">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class=\"line\">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost ~]# ulimit -n</span><br><span class=\"line\">1024</span><br><span class=\"line\">[root@localhost ~]# ulimit -n 65535</span><br><span class=\"line\">[root@localhost ~]# ulimit -n</span><br><span class=\"line\">65535</span><br><span class=\"line\">[root@localhost ~]# ulimit -u</span><br><span class=\"line\">63447</span><br><span class=\"line\">[root@localhost ~]# ulimit -u 65535</span><br><span class=\"line\">[root@localhost ~]# ulimit -u</span><br><span class=\"line\">65535</span><br><span class=\"line\">[root@localhost ~]# vim  /etc/rc.local </span><br><span class=\"line\">[root@localhost ~]# ls</span><br><span class=\"line\">anaconda-ks.cfg  mongodb-linux-x86_64-rhel70-4.0.6.tgz</span><br><span class=\"line\"></span><br><span class=\"line\">[root@worker02 ~]# mkdir /data/mongodb</span><br><span class=\"line\">[root@worker02 ~]# tar xzf mongodb-linux-x86_64-rhel70-4.0.6.tgz -C /data/mongodb/</span><br><span class=\"line\">[root@worker02 mongodb]# mv mongodb-linux-x86_64-rhel70-4.0.6/ mongodb</span><br><span class=\"line\"></span><br><span class=\"line\">[root@worker02 mongodb]# ln -s /data/mongodb/mongodb/bin/* /bin/</span><br><span class=\"line\"></span><br><span class=\"line\">[root@worker02 mongodb]# mkdir  data</span><br><span class=\"line\">[root@worker02 mongodb]# mkdir logs</span><br><span class=\"line\">[root@worker02 mongodb]# touch logs/mongodb.log</span><br><span class=\"line\"></span><br><span class=\"line\">[root@worker02 mongodb]# ls</span><br><span class=\"line\">data  logs  mongodb</span><br><span class=\"line\">[root@worker02 mongodb]# mkdir conf</span><br><span class=\"line\">[root@worker02 mongodb]# vim conf/mongodb.conf</span><br><span class=\"line\"># 添加以下内容</span><br><span class=\"line\">port=27017</span><br><span class=\"line\">dbpath=/data/mongodb/data</span><br><span class=\"line\">logpath=/data/mongodb/logs/mongodb.log</span><br><span class=\"line\">logappend=true</span><br><span class=\"line\">fork=true</span><br><span class=\"line\">maxConns=5000</span><br><span class=\"line\"># 将存储引擎切换为 WiredTiger</span><br><span class=\"line\">storageEngine=wiredTiger  </span><br><span class=\"line\"># 绑定到所有 IP 地址</span><br><span class=\"line\">bind_ip=0.0.0.0  </span><br><span class=\"line\"># 启用访问控制</span><br><span class=\"line\">auth=true</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动</span><br><span class=\"line\">[root@worker02 mongodb]# /data/mongodb/mongodb/bin/mongod -f /data/mongodb/conf/mongodb.conf </span><br><span class=\"line\">about to fork child process, waiting until server is ready for connections.</span><br><span class=\"line\">forked process: 1834</span><br><span class=\"line\">[root@localhost mongodb]#  netstat -lnpt | grep mongod</span><br><span class=\"line\">tcp        0      0 127.0.0.1:27017         0.0.0.0:*               LISTEN      1834/mongod</span><br><span class=\"line\">[root@localhost mongodb]# ps aux | grep mongod | grep -v grep</span><br><span class=\"line\">root      1834 24.7  0.5 1502384 96948 ?       Sl   5月27   1:41 /usr/local/mongodb/bin/mongod -f /usr/local/mongodb/conf/mongodb1.conf</span><br><span class=\"line\">设置开机自动启动</span><br><span class=\"line\">[root@mongodb mongodb]# vim /etc/rc.local</span><br><span class=\"line\">rm -f /data/mongodb1/mongod.lock</span><br><span class=\"line\">mongod -f /usr/local/mongodb/conf/mongodb1.conf</span><br><span class=\"line\">[root@localhost mongodb]# mongo</span><br><span class=\"line\">MongoDB shell version v4.0.6</span><br><span class=\"line\">connecting to: mongodb://127.0.0.1:27017/?gssapiServiceName=mongodb</span><br><span class=\"line\">Implicit session: session &#123; &quot;id&quot; : UUID(&quot;be032cef-e2b3-4856-927c-0a560a40d1fd&quot;) &#125;</span><br><span class=\"line\">MongoDB server version: 4.0.6</span><br><span class=\"line\">Welcome to the MongoDB shell.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&gt; show dbs</span><br><span class=\"line\">admin   0.078GB</span><br><span class=\"line\">config  0.078GB</span><br><span class=\"line\">local   0.078GB</span><br><span class=\"line\">&gt; exit</span><br></pre></td></tr></table></figure>\n<pre><code>报错处理：\ndmesg | grep -i watchdog\njournalctl -k | grep -i watchdog\nvim /etc/sysctl.conf\n添加以下内容\nkernel.watchdog_thresh = 60\n#使其生效\n sysctl -p\n#启动\n/data/mongodb/mongodb/bin/mongod -f /data/mongodb/conf/mongodb.conf \n\n# 可做可不做--作用是禁用透明大页\nvim /etc/default/grub\n添加以下内容\nGRUB_CMDLINE_LINUX=&quot;... transparent_hugepage=never&quot;\n</code></pre>\n","categories":["operations"],"tags":["Linux","MongoDB"]},{"title":"MySQL全量备份/增量备份脚本","url":"/2025/01/07/MySQL%E5%85%A8%E9%87%8F%E5%A4%87%E4%BB%BD-%E5%A2%9E%E9%87%8F%E5%A4%87%E4%BB%BD%E8%84%9A%E6%9C%AC/","content":"<p>#!&#x2F;bin&#x2F;bash</p>\n<h1 id=\"mysql物理备份脚本\"><a href=\"#mysql物理备份脚本\" class=\"headerlink\" title=\"mysql物理备份脚本\"></a>mysql物理备份脚本</h1><h1 id=\"每周日进行全量备份，周一到周六进行增量备份，7天为一个周期\"><a href=\"#每周日进行全量备份，周一到周六进行增量备份，7天为一个周期\" class=\"headerlink\" title=\"每周日进行全量备份，周一到周六进行增量备份，7天为一个周期\"></a>每周日进行全量备份，周一到周六进行增量备份，7天为一个周期</h1><h1 id=\"备份路径、日志路径\"><a href=\"#备份路径、日志路径\" class=\"headerlink\" title=\"备份路径、日志路径\"></a>备份路径、日志路径</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">backup_dir=&quot;/backup&quot;</span><br><span class=\"line\">log_dir=&quot;/backup/log&quot;</span><br><span class=\"line\">full_backup_dir=&quot;/backup/full&quot;</span><br><span class=\"line\">inc_backup_dir=&quot;/backup/inc&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">log_date=$(date &quot;+%F-%T&quot;)</span><br></pre></td></tr></table></figure>\n<h1 id=\"数据库用户、密码\"><a href=\"#数据库用户、密码\" class=\"headerlink\" title=\"数据库用户、密码\"></a>数据库用户、密码</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">MY_USER=root</span><br><span class=\"line\">MY_PASS=P@ssword1</span><br></pre></td></tr></table></figure>\n<h1 id=\"判断日志、备份路径是否存在\"><a href=\"#判断日志、备份路径是否存在\" class=\"headerlink\" title=\"判断日志、备份路径是否存在\"></a>判断日志、备份路径是否存在</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[ -d $backup_dir ] || mkdir $backup_dir</span><br><span class=\"line\">[ -d $log_dir ] || mkdir $log_dir</span><br><span class=\"line\">[ -d $full_backup_dir ] || mkdir $full_backup_dir</span><br><span class=\"line\">[ -d $inc_backup_dir ] || mkdir $inc_backup_dir</span><br></pre></td></tr></table></figure>\n<h1 id=\"全量备份函数\"><a href=\"#全量备份函数\" class=\"headerlink\" title=\"全量备份函数\"></a>全量备份函数</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">full_backup()&#123;</span><br><span class=\"line\">\t# 全量备份命令 </span><br><span class=\"line\">\tinnobackupex --user=$MY_USER --password=$MY_PASS $full_backup_dir</span><br><span class=\"line\">\tif [ $? -eq 0 ];then</span><br><span class=\"line\">\t\techo &quot;$&#123;log_date&#125; full backup!!!&quot; &gt;&gt; $log_dir/back.log</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\techo &quot;$&#123;log_date&#125; full failed!!&quot; &gt;&gt; $log_dir/err.log</span><br><span class=\"line\">\tfi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"获取上周日的时间-以-Y-m-d格式显示\"><a href=\"#获取上周日的时间-以-Y-m-d格式显示\" class=\"headerlink\" title=\"获取上周日的时间,以%Y-%m-%d格式显示\"></a>获取上周日的时间,以%Y-%m-%d格式显示</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">sunday=$(date -d &quot;last sunday&quot; +%F)</span><br></pre></td></tr></table></figure>\n<h1 id=\"获取前一天的时间-以-Y-m-d格式显示\"><a href=\"#获取前一天的时间-以-Y-m-d格式显示\" class=\"headerlink\" title=\"获取前一天的时间,以%Y-%m-%d格式显示\"></a>获取前一天的时间,以%Y-%m-%d格式显示</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yesterday=$(date -d &quot;yesterday&quot; +%F)</span><br></pre></td></tr></table></figure>\n<h1 id=\"增量备份函数\"><a href=\"#增量备份函数\" class=\"headerlink\" title=\"增量备份函数\"></a>增量备份函数</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">inc_backup()&#123;</span><br><span class=\"line\">\t# 判断当前时间是否为周一(周一需要去找全量备份，周二到周六找前一天的备份)</span><br><span class=\"line\">\tif [ $week_date -eq 1 ];then</span><br><span class=\"line\">\t\t# 查找全量备份的文件路径</span><br><span class=\"line\">\t\tlocal full_backup_dir=$(find $backup_dir -name $&#123;sunday&#125;*)</span><br><span class=\"line\">\t\tinnobackupex --user=$MY_USER --password=$MY_PASS --incremental $&#123;inc_backup_dir&#125; --incremental-basedir=$&#123;full_backup_dir&#125;</span><br><span class=\"line\">\t\t# 判断命令是否执行成功,写入日志文件</span><br><span class=\"line\">    \tif [ $? -eq 0 ];then</span><br><span class=\"line\">        \techo &quot;$&#123;log_date&#125; inc backup!!!&quot; &gt;&gt; $log_dir/back.log</span><br><span class=\"line\">    \telse</span><br><span class=\"line\">        \techo &quot;$&#123;log_date&#125; inc failed!!&quot; &gt;&gt; $log_dir/err.log</span><br><span class=\"line\">    \tfi</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\t# 查找前一天的文件路径</span><br><span class=\"line\">        local yesterday_backup_dir=$(find $backup_dir -name $&#123;yesterday&#125;*)</span><br><span class=\"line\">        innobackupex --user=$MY_USER --password=$MY_PASS --incremental $&#123;inc_backup_dir&#125; --incremental-basedir=$&#123;yesterday_backup_dir&#125;</span><br><span class=\"line\">\t\t# 判断命令是否执行成功,写入日志文件</span><br><span class=\"line\">    \tif [ $? -eq 0 ];then</span><br><span class=\"line\">        \techo &quot;$&#123;log_date&#125; inc backup!!!&quot; &gt;&gt; $log_dir/back.log</span><br><span class=\"line\">    \telse</span><br><span class=\"line\">        \techo &quot;$&#123;log_date&#125; inc failed!!&quot; &gt;&gt; $log_dir/err.log</span><br><span class=\"line\">    \tfi</span><br><span class=\"line\">\tfi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"查看当前是周几\"><a href=\"#查看当前是周几\" class=\"headerlink\" title=\"查看当前是周几\"></a>查看当前是周几</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">week_date=$(date +%u)</span><br></pre></td></tr></table></figure>\n<h1 id=\"判断当前是周几，周日则执行全量备份，周一到周六执行增量备份\"><a href=\"#判断当前是周几，周日则执行全量备份，周一到周六执行增量备份\" class=\"headerlink\" title=\"判断当前是周几，周日则执行全量备份，周一到周六执行增量备份\"></a>判断当前是周几，周日则执行全量备份，周一到周六执行增量备份</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">if [ $week_date -eq 7 ];then</span><br><span class=\"line\">\tfull_backup</span><br><span class=\"line\">else</span><br><span class=\"line\">\tinc_backup\t</span><br><span class=\"line\">fi</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Mysql"]},{"title":"Nacos集群部署","url":"/2025/11/06/Nacos%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","content":"<h3 id=\"Nacos–集群\"><a href=\"#Nacos–集群\" class=\"headerlink\" title=\"Nacos–集群\"></a>Nacos–集群</h3><h4 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h4><p>Nacos（Dynamic Naming and Configuration Service）是阿里巴巴开源的一个动态服务发现、配置管理和服务管理平台。它主要用于微服务架构中的服务注册与发现、分布式配置管理和动态 DNS 服务。Nacos 的核心功能和作用如下：</p>\n<ol>\n<li><strong>服务发现和注册</strong></li>\n</ol>\n<ul>\n<li><strong>服务注册</strong>：Nacos 允许服务实例在启动时向 Nacos 注册自己的信息（如 IP 地址、端口、服务名称等），从而使其他服务能够发现它们。</li>\n<li><strong>服务发现</strong>：服务消费者可以通过 Nacos 查询到所需服务的实例信息，从而实现服务间的调用。Nacos 支持多种服务发现机制，如 DNS 和 HTTP。</li>\n</ul>\n<ol start=\"2\">\n<li><strong>分布式配置管理</strong></li>\n</ol>\n<ul>\n<li><strong>配置管理</strong>：Nacos 提供了集中化的配置管理功能，允许开发者将应用配置存储在 Nacos 服务器上。配置的变更可以实时推送到各个服务实例，避免了因配置变更而重启服务的需求。</li>\n<li><strong>动态配置</strong>：通过 Nacos，配置可以在运行时动态更新，服务实例会自动感知配置的变化并做出相应调整。</li>\n</ul>\n<ol start=\"3\">\n<li><strong>动态 DNS 服务</strong></li>\n</ol>\n<ul>\n<li><strong>动态 DNS</strong>：Nacos 支持动态 DNS 服务，可以将服务名解析为服务实例的 IP 地址和端口，方便服务间的调用和负载均衡。</li>\n</ul>\n<ol start=\"4\">\n<li><strong>集群管理</strong></li>\n</ol>\n<ul>\n<li><strong>集群管理</strong>：Nacos 支持对服务实例进行健康检查和集群管理，确保服务的高可用性和可靠性。它可以自动剔除不健康的实例，并在实例恢复后重新加入到服务列表中。</li>\n</ul>\n<ol start=\"5\">\n<li><strong>多语言支持</strong></li>\n</ol>\n<ul>\n<li><strong>多语言支持</strong>：Nacos 提供了丰富的客户端 SDK，支持 Java、Go、C++ 等多种编程语言，方便开发者在不同语言的项目中集成 Nacos。</li>\n</ul>\n<ol start=\"6\">\n<li><strong>可视化管理界面</strong></li>\n</ol>\n<ul>\n<li><strong>可视化界面</strong>：Nacos 提供了友好的 Web 管理界面，方便开发者和运维人员对服务和配置进行管理和监控。</li>\n</ul>\n<ol start=\"7\">\n<li><strong>高可用和扩展性</strong></li>\n</ol>\n<ul>\n<li><strong>高可用</strong>：Nacos 支持集群部署，保证服务的高可用性和容错性。</li>\n<li><strong>扩展性</strong>：Nacos 设计灵活，支持插件机制，可以根据需要扩展功能。</li>\n</ul>\n<p><strong>典型应用场景</strong></p>\n<ol>\n<li><strong>微服务架构</strong>：在微服务架构中，Nacos 作为服务注册与发现的核心组件，简化了服务间的通信和管理。</li>\n<li><strong>分布式系统</strong>：在分布式系统中，Nacos 提供集中化的配置管理，简化了配置的管理和推送。</li>\n<li><strong>云原生应用</strong>：在云原生应用中，Nacos 提供动态 DNS 和服务发现功能，支持服务的弹性伸缩和动态管理。</li>\n</ol>\n<h4 id=\"资源需求\"><a href=\"#资源需求\" class=\"headerlink\" title=\"资源需求\"></a>资源需求</h4><ul>\n<li><strong>CPU</strong>: 4 核 </li>\n<li><strong>内存</strong>:  8 GB </li>\n<li><strong>存储</strong>: 300G</li>\n<li><strong>节点</strong>：2</li>\n</ul>\n<h4 id=\"网络端口\"><a href=\"#网络端口\" class=\"headerlink\" title=\"网络端口\"></a>网络端口</h4><ol>\n<li><strong>默认端口</strong><ul>\n<li><strong>端口号</strong>: 8848</li>\n<li><strong>用途</strong>: Nacos 的 HTTP API 端口，用于服务注册、配置管理和其他 API 调用。</li>\n</ul>\n</li>\n<li><strong>集群通信端口</strong><ul>\n<li><strong>端口号</strong>: 7848</li>\n<li><strong>用途</strong>: Nacos 集群节点之间的通信端口。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h4><pre><code># 安装jdk\nwget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/tomcat-jdk/jdk-8u271-linux-x64.tar.gz\njdk在/usr/local目录下，设置变量\n\n# 下载nacos安装包\nwget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/nacos/nacos-server-1.2.1.tar.gz\n\n#创建目录\nmkdir -p /data/nacos\n# 解压\ntar xzf nacos-server-2.3.2.tar.gz -C /data/nacos\ncd /data/nacos/nacos/conf\n# 编辑连数据库的 配置文件\nvim application.properties\n更改以下内容\nspring.datasource.platform=mysql      # 去除注释\n# spring.sql.init.platform=mysql\n\n### Count of DB:\ndb.num=1    # 去除注释\n\n### Connect URL of DB:\ndb.url.0=jdbc:mysql://10.100.40.171:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC    # 改MySQL机器的IP地址\ndb.user.0=root     # 改为root用户\ndb.password.0=Kunyue@123     # 改为MySQL的密码\nspring.data.dir=/data/nacos/data\t\t#定义数据存放目录\n\n#创建目录\nmkdir -p /data/nacos/data\nchmod -R 755 /data/nacos\n# 导入数据--并创建nacos数据库\nCREATE USER &#39;root&#39;@&#39;%&#39; IDENTIFIED BY &#39;123456&#39;;\nGRANT ALL PRIVILEGES ON *.* TO &#39;root&#39;@&#39;%&#39;;\nflush privileges;\n\n# 编辑集群配置文件--添加集群IP地址\ncp cluster.conf.example cluster.conf.example.bak\nmv cluster.conf.example cluster.conf\nvim cluster.conf\n添加nacos集群的IP地址\n10.100.40.170:8848\n10.100.40.171:8848\n10.100.40.172:8848\n\n# 启动\n./bin/startup.sh\n# 停止\n./bin/shutdown.sh\n\n# 登入、验证\nhttp://IP + 8848/nacos\n在web界面左侧栏--集群管理--节点管理   # 可以看到所有集群的状态\n           \n           \n           \n### 开启鉴权\n通过base64命令随机生成token\n[root@emqx01 conf]# echo -n &#39;ThisIsARandomlyGeneratedSecureKey32CharactersLong&#39; | base64\nVGhpc0lzQVJhbmRvbWx5R2VuZXJhdGVkU2VjdXJlS2V5MzJDaGFyYWN0ZXJzTG9uZw==\n\n#编辑配置\nvim /data/nacos/nacos/conf/application.properties\nnacos.core.auth.enabled=true\n\n### 关闭使用user-agent判断服务端请求并放行鉴权的功能\nnacos.core.auth.enable.userAgentAuthWhite=false\n\n### 配置自定义身份识别的key（不可为空）和value（不可为空）\nnacos.core.auth.server.identity.key=example\nnacos.core.auth.server.identity.value=example\n\nnacos.core.auth.plugin.nacos.token.secret.key=VGhpc0lzQVJhbmRvbWx5R2VuZXJhdGVkU2VjdXJlS2V5MzJDaGFyYWN0ZXJzTG9uZw==\n</code></pre>\n","categories":["operations"],"tags":["Linux","Nacos"]},{"title":"Nginx 会话保持","url":"/2025/11/06/Nginx-%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81/","content":"<h1 id=\"nginx-会话保持\"><a href=\"#nginx-会话保持\" class=\"headerlink\" title=\"nginx 会话保持\"></a>nginx 会话保持</h1><p>nginx会话保持主要有以下几种实现方式：</p>\n<p>1、ip_hash</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ip_hash使用源地址哈希算法，将同一客户端的请求总是发往同一个后端服务器，除非该服务器不可用。</span><br><span class=\"line\"></span><br><span class=\"line\">ip_hash简单易用，但有如下问题：</span><br><span class=\"line\">当后端服务器宕机后，session会丢失；</span><br><span class=\"line\">来自同一局域网的客户端会被转发到同一个后端服务器，可能导致负载失衡；</span><br></pre></td></tr></table></figure>\n\n<p>示例</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">upstream backend &#123;</span><br><span class=\"line\">    ip_hash;</span><br><span class=\"line\">    server backend1.example.com;</span><br><span class=\"line\">    server backend2.example.com;</span><br><span class=\"line\">    server backend3.example.com down;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>2、sticky_cookie_insert—而是基于cookie实现</p>\n<p>使用sticky_cookie_insert，这会让来自同一客户端的请求被传递到一组服务器的同一台服务器。与ip_hash不同之处在于，它不是基于IP来判断客户端的，而是基于cookie来判断。(需要引入第三方模块才能实现)—sticky模块。因此可以避免上述ip_hash中来自同一局域网的客户端和前段代理导致负载失衡的情况。</p>\n<p>在yum安装的nginx的环境下，编译安装sticky添加模块</p>\n<p>查看yum安装nginx路径，后面编译安装需要用</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">nginx -V\t\t//减大V，查看安装路径</span><br></pre></td></tr></table></figure>\n\n<p>删除原有nginx文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">rm -rf /etc/share/nginx/*\t//删除配置文件</span><br><span class=\"line\">rm -rf /var/log/nginx/*\t\t//删除日志文件</span><br></pre></td></tr></table></figure>\n\n<p>安装编译环境</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install -y pcre* openssl* gcc gcc-c++ make</span><br></pre></td></tr></table></figure>\n\n<p>下载sticky模块</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget  https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/get/08a395c66e42.zip</span><br></pre></td></tr></table></figure>\n\n<p>查看nginx版本</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">nginx -v\t//减小v，查看版本</span><br></pre></td></tr></table></figure>\n\n<p>下载yum安装nginx对应版本的源码包</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget  http://nginx.org/download/nginx-1.18.0.tar.gz</span><br></pre></td></tr></table></figure>\n\n<p>下载解压工具及解压</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install -y unzip\t//下载解压工具</span><br><span class=\"line\"></span><br><span class=\"line\">unzip 08a395c66e42.zip\t\t//解压</span><br></pre></td></tr></table></figure>\n\n<p>更改软件名字</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">mv nginx-goodies-nginx-sticky-module-ng-08a395c66e42/ nginx-sticky-module-ng/</span><br></pre></td></tr></table></figure>\n\n<p>解压nginx的源码包</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">tar xzvf nginx-1.18.0.tar.gz -C /usr/local/\t\t//指定路径，解压nginx</span><br></pre></td></tr></table></figure>\n\n<p>进入nginx目录里</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd /usr/local/nginx-1.18.0/</span><br></pre></td></tr></table></figure>\n\n<p>查看yum安装nginx所有模块</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">nginx -V</span><br></pre></td></tr></table></figure>\n\n<p>下载</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#x27; --with-ld-opt=&#x27;-Wl,-z,relro -Wl,-z,now -pie&#x27; --add-module=/root/nginx-sticky-module-ng</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">--add-module=/root/nginx-sticky-module-ng是添加的cookie模块</span></span><br></pre></td></tr></table></figure>\n\n<p>配置基于cookie会话保持</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在代理上写入</span></span><br><span class=\"line\">upstream qfedu &#123;</span><br><span class=\"line\">        server 192.168.198.143;</span><br><span class=\"line\">        server 192.168.198.145;</span><br><span class=\"line\">        sticky;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在宿柱机上写入</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">    #charset koi8-r;</span><br><span class=\"line\">    #access_log  /var/log/nginx/host.access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://qfedu;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">说明：</span><br><span class=\"line\">expires：设置浏览器中保持cookie的时间 </span><br><span class=\"line\">domain：定义cookie的域 </span><br><span class=\"line\">path：为cookie定义路径</span><br></pre></td></tr></table></figure>\n\n<p>查看nginx配置是不是正常，及启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">nginx -t\t//查看配置是不是正常 </span><br><span class=\"line\"></span><br><span class=\"line\">nginx -s reload\t\t//重启nginx</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 变量简介实验","url":"/2025/11/06/Nginx-%E5%8F%98%E9%87%8F%E7%AE%80%E4%BB%8B/","content":"<h1 id=\"Nginx-变量\"><a href=\"#Nginx-变量\" class=\"headerlink\" title=\"Nginx 变量\"></a>Nginx 变量</h1><p>nginx变量简介</p>\n<ul>\n<li><p>所有的 <code>Nginx</code>变量在<code>Nginx</code>配置文件中引用时都须带上 $ 前缀</p>\n</li>\n<li><p>在 <code>Nginx</code> 配置中，变量只能存放一种类型的值，而且也只存在一种类型，那就是字符串类型</p>\n</li>\n<li><p>所有的变量值都可以通过这种方式引用<code>$变量名</code></p>\n</li>\n</ul>\n<p>nginx中的变量分为两种，自定义变量与内置预定义变量</p>\n<ul>\n<li><p>自定义变量<code>set $变量名 变量值</code></p>\n</li>\n<li><p>内置预定义变量</p>\n</li>\n</ul>\n<p><code>$arg_PARAMETER</code>\t\tGET请求中变量名PARAMETER参数的值。  </p>\n<p><code>$args</code>\t\t这个变量等于GET请求中的参数。例如，foo&#x3D;123&amp;bar&#x3D;blahblah;这个变量只可以被修改</p>\n<p><code>$binary_remote_addr</code>\t\t二进制码形式的客户端地址</p>\n<p><code>$body_bytes_sent</code>\t\t传送页面的字节数  </p>\n<p><code>$content_length</code>\t\t请求头中的Content-length字段</p>\n<p><code>$content_type</code>\t\t请求头中的Content-Type字段</p>\n<p><code>$cookie_COOKIE</code>\t\tcookie COOKIE的值</p>\n<p><code>$document_root</code>\t\t当前请求在root指令中指定的值</p>\n<p><code>$host</code>\t\t请求中的主机头(Host)字段，如果请求中的主机头不可用或者空，则为处理请求的server名称(处理请求的server的server_name指令的值)。值为小写，不包含端口</p>\n<p><code>$hostname</code>\t\t机器名使用 gethostname系统调用的值</p>\n<p><code>$limit_rate</code>\t\t这个变量可以限制连接速率</p>\n<p><code>$nginx_version</code>\t\t当前运行的nginx版本号</p>\n<p><code>$remote_addr</code>\t\t客户端的IP地址</p>\n<p><code>$remote_port</code>\t\t客户端的端口</p>\n<p><code>$remote_user</code>\t\t已经经过Auth Basic Module验证的用户名</p>\n<p><code>$request_filename</code>\t\t当前连接请求的文件路径，由root或alias指令与URI请求生成</p>\n<p><code>$request_body</code>\t\t这个变量（0.7.58+）包含请求的主要信息。在使用proxy_pass或fastcgi_pass指令的location中比较有意义</p>\n<p><code>$request_body_file</code>\t\t客户端请求主体信息的临时文件名</p>\n<p><code>$request_completion</code>\t\t如果请求成功，设为”OK”；如果请求未完成或者不是一系列请求中最后一部分则设为空</p>\n<p><code>$request_method</code>\t\t这个变量是客户端请求的动作，通常为GET或POST。包括0.8.20及之前的版本中，这个变量总为main request中的动作，如果当前请求是一个子请求，并不使用这个当前请求的动作</p>\n<p><code>$server_addr</code>\t\t服务器地址，在完成一次系统调用后可以确定这个值，如果要绕开系统调用，则必须在listen中指定地址并且使用bind参数</p>\n<p><code>$server_name</code>\t\t服务器名称</p>\n<p><code>$server_port</code>\t\t请求到达服务器的端口号</p>\n<p><code>$server_protocol</code>\t\t请求使用的协议，通常是HTTP&#x2F;1.0或HTTP&#x2F;1.1</p>\n<p><code>$uri</code>\t\t请求中的当前URI(不带请求参数，参数位于args)，不同于浏览器传递的args)，不同于浏览器传递的args)，不同于浏览器传递的request_uri的值，它可以通过内部重定向，或者使用index指令进行修改。不包括协议和主机名，例如&#x2F;foo&#x2F;bar.html</p>\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 地址重写 rewrite实验","url":"/2025/11/06/Nginx-%E5%9C%B0%E5%9D%80%E9%87%8D%E5%86%99-rewrite/","content":"<h1 id=\"nginx-地址重写-rewrite\"><a href=\"#nginx-地址重写-rewrite\" class=\"headerlink\" title=\"nginx 地址重写 rewrite\"></a>nginx 地址重写 rewrite</h1><p><code>什么是Rewrite</code></p>\n<p>Rewrite对称URL Rewrite，即URL重写，就是把传入Web的请求重定向到其他URL的过程</p>\n<p><code>Rewrite 相关指令</code></p>\n<p>Nginx Rewrite 相关指令有 if、rewrite、set、return</p>\n<h1 id=\"rewrite指令最后跟一个flag标记，支持的flag标记有\"><a href=\"#rewrite指令最后跟一个flag标记，支持的flag标记有\" class=\"headerlink\" title=\"rewrite指令最后跟一个flag标记，支持的flag标记有\"></a>rewrite指令最后跟一个flag标记，支持的flag标记有</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">last \t\t\t    表示完成rewrite。默认为last。会第二次验证</span><br><span class=\"line\">break \t\t\t\t本条规则匹配完成后，终止匹配，不再匹配后面的规则</span><br><span class=\"line\">redirect \t\t\t返回302临时重定向，浏览器地址会显示跳转后的URL地址</span><br><span class=\"line\">permanent \t\t    返回301永久重定向，浏览器地址会显示跳转后URL地址</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"1、Rewrite匹配参考示例\"><a href=\"#1、Rewrite匹配参考示例\" class=\"headerlink\" title=\"1、Rewrite匹配参考示例\"></a>1、Rewrite匹配参考示例</h1><p>示例</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">例1：</span><br><span class=\"line\">本地解析host文件--wind</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">http://www.testpm.com/a/1.html ==&gt; http://www.testpm.com/b/2.html</span></span><br><span class=\"line\">    location /a &#123;</span><br><span class=\"line\">        root    /html;</span><br><span class=\"line\">        index   1.html index.htm;</span><br><span class=\"line\">        rewrite .* /b/2.html permanent;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    location /b &#123;</span><br><span class=\"line\">        root    /html;</span><br><span class=\"line\">        index   2.html index.htm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">IP地址后面需要跟后缀 `/a/1.html`</span></span><br><span class=\"line\"></span><br><span class=\"line\">例2：</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">http://www.testpm.com/2019/a/1.html ==&gt; http://www.testpm.com/2018/a/1.html</span></span><br><span class=\"line\">     location /2019/a &#123;</span><br><span class=\"line\">        root    /var/www/html;</span><br><span class=\"line\">        index   1.html index.hml;</span><br><span class=\"line\">        rewrite ^/2019/(.*)$ /2018/$1 permanent;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">     location /2018/a &#123;</span><br><span class=\"line\">        root    /var/www/html;</span><br><span class=\"line\">        index   1.html index.htl;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">IP地址后面需要跟后缀 `/2019/a/1.html`</span></span><br><span class=\"line\"></span><br><span class=\"line\">例3：</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">http://www.qf.com/a/1.html ==&gt; http://jd.com</span></span><br><span class=\"line\">location /a &#123;</span><br><span class=\"line\">        root    /html;</span><br><span class=\"line\">        if ($host ~* www.qf.com ) &#123;</span><br><span class=\"line\">        rewrite .* http://jd.com permanent;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">例4：</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">http://www.qf.com/a/1.html ==&gt; http://jd.com/a/1.html</span></span><br><span class=\"line\">location /a &#123;</span><br><span class=\"line\">        root /html;</span><br><span class=\"line\">        if ( $host ~* qf.com )&#123;</span><br><span class=\"line\">        rewrite .* http://jd.com$request_uri permanent;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">例5：</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">http://www.tianyun.com/login/tianyun.html ==&gt; http://www.tianyun.com/reg/login.html?user=tianyun</span></span><br><span class=\"line\">\tlocation /login &#123;</span><br><span class=\"line\">        root   /usr/share/nginx/html;</span><br><span class=\"line\">        rewrite ^/login/(.*)\\.html$ http://$host/reg/login.html?user=$1;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    location /reg &#123;</span><br><span class=\"line\">        root /usr/share/nginx/html;</span><br><span class=\"line\">        index login.html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">例6：</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">http://www.tianyun.com/qf/11-22-33/1.html  ==&gt;  http://www.tianyun.com/qf/11/22/33/1.html</span></span><br><span class=\"line\">location /qf &#123;</span><br><span class=\"line\">            rewrite ^/qf/([0-9]+)-([0-9]+)-([0-9]+)(.*)$ /qf/$1/$2/$3$4 permanent;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location /qf/11/22/33 &#123;</span><br><span class=\"line\">                root /html;</span><br><span class=\"line\">                index   1.html;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2、set-指令\"><a href=\"#2、set-指令\" class=\"headerlink\" title=\"2、set 指令\"></a>2、set 指令</h1><p>set 指令是用于定义一个变量，并且赋值</p>\n<p>示例</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">例8：</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">http://alice.testpm.com ==&gt; http://www.testpm.com/alice</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">http://jack.testpm.com ==&gt; http://www.testpm.com/jack</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@nginx-server conf.d]# cd /usr/share/nginx/html/</span><br><span class=\"line\">[root@nginx-server html]# mkdir jack alice</span><br><span class=\"line\">[root@nginx-server html]# echo &quot;jack..&quot; &gt;&gt; jack/index.html</span><br><span class=\"line\">[root@nginx-server html]# echo &quot;alice..&quot; &gt;&gt; alice/index.html</span><br><span class=\"line\"></span><br><span class=\"line\">本地解析域名host文件</span><br><span class=\"line\">10.0.105.202 www.testpm.com</span><br><span class=\"line\">10.0.105.202 alice.testpm.com</span><br><span class=\"line\">10.0.105.202 jack.testpm.com</span><br><span class=\"line\">编辑配置文件:</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  www.testpm.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">         root   /usr/share/nginx/html;</span><br><span class=\"line\">         index  index.html index.htm;</span><br><span class=\"line\">         if ( $host ~* ^www.testpm.com$) &#123;</span><br><span class=\"line\">                break;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">         if ( $host ~* &quot;^(.*)\\.testpm\\.com$&quot; ) &#123;</span><br><span class=\"line\">                set $user $1;</span><br><span class=\"line\">                rewrite .* http://www.testpm.com/$user permanent;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    location /jack &#123;</span><br><span class=\"line\">         root /usr/share/nginx/html;</span><br><span class=\"line\">         index  index.html index.hml;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    location /alice &#123;</span><br><span class=\"line\">         root /usr/share/nginx/html;</span><br><span class=\"line\">         index index.html index.hml;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"3、return-指令\"><a href=\"#3、return-指令\" class=\"headerlink\" title=\"3、return 指令\"></a>3、return 指令</h1><p>return 指令用于返回状态码给客户端</p>\n<p>示例</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">例9：如果访问的.sh结尾的文件则返回403操作拒绝错误</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  www.testpm.cn;</span><br><span class=\"line\">    #access_log  /var/log/nginx/http_access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        root   /usr/share/nginx/html;</span><br><span class=\"line\">        index  index.html index.htm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location ~* \\.sh$ &#123;</span><br><span class=\"line\">        return 403;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4、last-break详解\"><a href=\"#4、last-break详解\" class=\"headerlink\" title=\"4、last,break详解\"></a>4、last,break详解</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost test]# cat /etc/nginx/conf.d/last_break.conf </span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  localhost;</span><br><span class=\"line\">    access_log  /var/log/nginx/last.access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        root   /usr/share/nginx/html;</span><br><span class=\"line\">        index  index.html index.htm;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    location /break/ &#123;</span><br><span class=\"line\">        root /usr/share/nginx/html;</span><br><span class=\"line\">        rewrite .* /test/break.html break;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    location /last/ &#123;</span><br><span class=\"line\">        root /usr/share/nginx/html;</span><br><span class=\"line\">        rewrite .* /test/last.html last;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    location /test/ &#123;</span><br><span class=\"line\">        root /usr/share/nginx/html;</span><br><span class=\"line\">        rewrite .* /test/test.html break;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">[root@localhost conf.d]# cd /usr/share/nginx/html/</span><br><span class=\"line\">[root@localhost html]# mkdir test</span><br><span class=\"line\">[root@localhost html]# echo &quot;last&quot; &gt; test/last.html</span><br><span class=\"line\">[root@localhost html]# echo &quot;break&quot; &gt; test/break.html</span><br><span class=\"line\">[root@localhost html]# echo &quot;test&quot; &gt; test/test.html</span><br><span class=\"line\"></span><br><span class=\"line\">http://10.0.105.196/break/break.html</span><br><span class=\"line\">http://10.0.105.196/last/last.html</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 实现动静分离实验","url":"/2025/11/06/Nginx-%E5%AE%9E%E7%8E%B0%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB/","content":"<h1 id=\"nginx-实现动静分离\"><a href=\"#nginx-实现动静分离\" class=\"headerlink\" title=\"nginx 实现动静分离\"></a>nginx 实现动静分离</h1><p><code>准备环境</code></p>\n<p>准备3台机器，一个nginx代理 两个http 分别处理动态和静态</p>\n<p><code>expires</code>功能说明</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">当nginx设置了expires后，例如设置为：expires 10d; 那么用户在10天内请求的时候，都只会访问浏览器中的缓存，而不会去请求nginx。</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"1、静态资源配置\"><a href=\"#1、静态资源配置\" class=\"headerlink\" title=\"1、静态资源配置\"></a>1、静态资源配置</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 80;</span><br><span class=\"line\">        server_name     localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ~ \\.(html|jpg|png|js|css) &#123;</span><br><span class=\"line\">        root /home/www/nginx;</span><br><span class=\"line\">        expires      1d; #为客户端设置静态资源缓存时间</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><code>测试</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -I http://192.168.116.111/test.jpg</span><br><span class=\"line\">HTTP/1.1 200 OK\t\t//显示200，代表成功</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">也可以在网址访问：192.168.116.111/test.jpg</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2、动态资源配置\"><a href=\"#2、动态资源配置\" class=\"headerlink\" title=\"2、动态资源配置\"></a>2、动态资源配置</h1><p><code>yum 安装php7.1</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">下载epel源</span></span><br><span class=\"line\">rpm -Uvh https://mirror.webtatic.com/yum/el7/epel-release.rpm</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Webtatic存储库添加到您的系统中，并从该存储库安装或升级相关的软件包</span></span><br><span class=\"line\">rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class=\"line\"></span><br><span class=\"line\">-U 表示更新（如果软件包已经安装则进行升级）。</span><br><span class=\"line\">-v 表示显示详细的安装过程。</span><br><span class=\"line\">-h 表示在安装过程中显示进度条。</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">下载php依赖包及主包</span></span><br><span class=\"line\">`依赖包`</span><br><span class=\"line\">yum -y install php71w-xsl php71w php71w-ldap php71w-cli php71w-common php71w-devel php71w-gd php71w-pdo php71w-mysql php71w-mbstring php71w-bcmath php71w-mcrypt</span><br><span class=\"line\">`主包`</span><br><span class=\"line\">yum install -y php71w-fpm</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动php</span></span><br><span class=\"line\">systemctl start php-fpm</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"编辑nginx的配置文件\"><a href=\"#编辑nginx的配置文件\" class=\"headerlink\" title=\"编辑nginx的配置文件\"></a>编辑nginx的配置文件</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">erver &#123;</span><br><span class=\"line\">        listen      80;</span><br><span class=\"line\">        server_name     localhost;</span><br><span class=\"line\">        location ~ \\.php$ &#123;</span><br><span class=\"line\">            root           /home/nginx/html;  #指定网站目录</span><br><span class=\"line\">            fastcgi_pass   127.0.0.1:9000;    #开启fastcgi连接php地址</span><br><span class=\"line\">            fastcgi_index  index.php;\t\t#指定默认文件</span><br><span class=\"line\">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name; #站点根目录，取决于root配置项</span><br><span class=\"line\">            include        fastcgi_params;  #包含fastcgi使用的常量</span><br><span class=\"line\">        \t\t&#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"3、配置nginx反向代理upstream，并实现客户端缓存时间\"><a href=\"#3、配置nginx反向代理upstream，并实现客户端缓存时间\" class=\"headerlink\" title=\"3、配置nginx反向代理upstream，并实现客户端缓存时间\"></a>3、配置nginx反向代理upstream，并实现客户端缓存时间</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">upstream static &#123;</span><br><span class=\"line\">        server 10.0.105.196:80 weight=1 max_fails=1 fail_timeout=60s;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">upstream php &#123;</span><br><span class=\"line\">        server 10.0.105.200:80 weight=1 max_fails=1 fail_timeout=60s;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        server &#123;</span><br><span class=\"line\">        listen      80;</span><br><span class=\"line\">        server_name     localhost</span><br><span class=\"line\">        #动态资源加载</span><br><span class=\"line\">        location ~ \\.(php|jsp)$ &#123;</span><br><span class=\"line\">            proxy_pass http://php;</span><br><span class=\"line\">            proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        #静态资源加载</span><br><span class=\"line\">        location ~ .*\\.(html|jpg|png|css|js)$ &#123;</span><br><span class=\"line\">            proxy_pass http://static;</span><br><span class=\"line\">            proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><p><code>在网址上输入代理机的IP，后缀加上你要查看的（静态图片名字|动态图片名字）</code></p>\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 日志切割脚本实验","url":"/2025/11/06/Nginx-%E6%97%A5%E5%BF%97%E5%88%87%E5%89%B2%E8%84%9A%E6%9C%AC/","content":"<h1 id=\"nginx日志切割脚本\"><a href=\"#nginx日志切割脚本\" class=\"headerlink\" title=\"nginx日志切割脚本\"></a>nginx日志切割脚本</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@nginx-web script]# vim nginx_log.sh</span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">date=`date +%F -d -1day`</span><br><span class=\"line\">log_dir=/var/log/nginx/</span><br><span class=\"line\">log_name=access.log</span><br><span class=\"line\">[ -d $log_dir ] &amp;&amp; cd $log_dir || exit 1</span><br><span class=\"line\">[ -f $log_name ] || exit 1</span><br><span class=\"line\">/bin/mv $log_name $log_name.$&#123;date&#125;</span><br><span class=\"line\">/usr/sbin/nginx -s reload</span><br><span class=\"line\">tar czf $log_name.$&#123;date&#125;.tar.gz $log_name.$&#123;date&#125; &amp;&amp; rm -rf $log_name_$&#123;date&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#delete</span><br><span class=\"line\">cd $log_dir || exit 1</span><br><span class=\"line\">find ./ -mtime +7 -type f -name *.log | xargs rm -rf</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 流量控制实验","url":"/2025/11/06/Nginx-%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6/","content":"<h1 id=\"Nginx-流量控制\"><a href=\"#Nginx-流量控制\" class=\"headerlink\" title=\"Nginx 流量控制\"></a>Nginx 流量控制</h1><p>配置基本的限流–ngx_http_limit_req_module模块实现</p>\n<p>流量限制”配置两个主要的指令，<code>limit_req_zone</code>和<code>limit_req</code>，<code>limit_req_zone</code>指令设置流量限制和内存区域的参数，但实际上并不限制请求速率。所以需要通过添加<code>limit_req</code>指令启用流量限制,应用在特定的<code>location</code>或者<code>server</code>块</p>\n<p><code>limit_req_zone</code>指令通常在HTTP块中定义，它需要以下三个参数：</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">-Key - 定义应用限制的请求特性。示例中的 Nginx 变量$binary_remote_addr，保存客户端IP地址的二进制形式。</span><br><span class=\"line\">-Zone - 定义用于存储每个IP地址状态以及被限制请求URL访问频率的内存区域。通过<span class=\"attr\">zone</span>=keyword标识区域的名字(自定义)，以及冒号后面跟区域大小。<span class=\"number\">16000</span>个IP地址的状态信息，大约需要<span class=\"number\">1</span>MB。</span><br><span class=\"line\">-Rate - 连接请求。在示例中，速率不能超过每秒1个请求。</span><br></pre></td></tr></table></figure>\n\n<p>示例一</p>\n<p>这里需要两台机器，一台代理，一台宿主机</p>\n<p><code>代理机配置</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">limit_req_zone $binary_remote_addr zone=mylimit:10m rate=1r/s;</span><br><span class=\"line\">        upstream myweb &#123;</span><br><span class=\"line\">                server 10.0.105.196:80 weight=1 max_fails=1 fail_timeout=1;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        server &#123;</span><br><span class=\"line\">                listen 80;</span><br><span class=\"line\">                server_name localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">                location /login &#123;</span><br><span class=\"line\">                        limit_req zone=mylimit;</span><br><span class=\"line\">                        proxy_pass http://myweb;</span><br><span class=\"line\">                        proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">                        proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>宿主机配置</code></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">192.168.116.111配置:</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 80<span class=\"comment\">;</span></span><br><span class=\"line\">        server_name localhost<span class=\"comment\">;</span></span><br><span class=\"line\">        location /login &#123;</span><br><span class=\"line\">                root    /usr/share/nginx/html<span class=\"comment\">;</span></span><br><span class=\"line\">                index   index.html index.html<span class=\"comment\">;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>测试及查看日志</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">客户端安装压力测试工具</span><br><span class=\"line\"><span class=\"section\">[root@nginx-yum ~]</span><span class=\"comment\"># yum install httpd-tools</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-yum ~]</span><span class=\"comment\"># ab -n1000 -c2 http://10.0.105.196/</span></span><br><span class=\"line\">-n 请求数</span><br><span class=\"line\">-c 并发数</span><br><span class=\"line\">代理机器看错误日志：</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># tail -f /var/log/nginx/error.log </span></span><br><span class=\"line\">2019/09/10 07:32:09 <span class=\"section\">[error]</span> 1371<span class=\"comment\">#0: *1095 limiting requests, excess: 0.390 by zone &quot;mylimit&quot;, client: 10.0.105.196, server: localhost, request: &quot;GET / HTTP/1.0&quot;, host: &quot;10.0.105.196&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>示例二</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">limit_req_zone $binary_remote_addr <span class=\"attr\">zone</span>=mylimit:<span class=\"number\">10</span>m rate=<span class=\"number\">1</span>r/s<span class=\"comment\">;</span></span><br><span class=\"line\">        upstream myweb &#123;</span><br><span class=\"line\">                server 10.0.105.196:80 <span class=\"attr\">weight</span>=<span class=\"number\">1</span> max_fails=<span class=\"number\">1</span> fail_timeout=<span class=\"number\">1</span><span class=\"comment\">;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        server &#123;</span><br><span class=\"line\">                listen 80<span class=\"comment\">;</span></span><br><span class=\"line\">                server_name localhost<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">                location /login &#123;</span><br><span class=\"line\">                        <span class=\"comment\">#limit_req zone=mylimit;</span></span><br><span class=\"line\">\t\t\t\t\t\tlimit_req <span class=\"attr\">zone</span>=mylimit burst=<span class=\"number\">5</span><span class=\"comment\">;</span></span><br><span class=\"line\">\t\t\t\t\t\t<span class=\"comment\">#limit_req zone=mylimit burst=5 nodelay;</span></span><br><span class=\"line\">                        proxy_pass http://myweb<span class=\"comment\">;</span></span><br><span class=\"line\">                        proxy_set_header Host $host:$server_port<span class=\"comment\">;</span></span><br><span class=\"line\">                        proxy_set_header X-Real-IP $remote_addr<span class=\"comment\">;</span></span><br><span class=\"line\">                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class=\"comment\">;</span></span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"><span class=\"attr\">burst</span>=<span class=\"number\">5</span> 表示最大延迟请求数量不大于<span class=\"number\">5</span>。超出的请求返回<span class=\"number\">503</span>状态码。</span><br><span class=\"line\">客户端测试--burst</span><br><span class=\"line\"><span class=\"section\">[root@nginx-yum ~]</span><span class=\"comment\"># ab -n1000 -c50 http://10.0.105.195/</span></span><br><span class=\"line\">代理机器上面看日志</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># tail -f /var/log/nginx/access.log</span></span><br><span class=\"line\">10.0.105.196 - - <span class=\"section\">[10/Sep/2019:08:05:10 +0800]</span> &quot;GET / HTTP/1.0&quot; 503 197 &quot;-&quot; &quot;ApacheBench/2.3&quot; &quot;-&quot;</span><br><span class=\"line\">10.0.105.196 - - <span class=\"section\">[10/Sep/2019:08:05:11 +0800]</span> &quot;GET / HTTP/1.0&quot; 200 2 &quot;-&quot; &quot;ApacheBench/2.3&quot; &quot;-&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">nodelay：不延迟转发请求。速度变快</span><br><span class=\"line\">客户端测试--burst</span><br><span class=\"line\"><span class=\"section\">[root@nginx-yum ~]</span><span class=\"comment\"># ab -n1000 -c50 http://10.0.105.195/</span></span><br><span class=\"line\"></span><br><span class=\"line\">总结：</span><br><span class=\"line\">如果不加nodelay只有burst的时候只会延迟转发请求超过限制的请求出现503错误</span><br><span class=\"line\">如果nodelay和burst参数都有不会延迟转发请求并且超出规定的请求次数会返回503</span><br></pre></td></tr></table></figure>\n\n<p>日志字段介绍</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">- limiting requests - 表明日志条目记录的是被“流量限制”请求</span><br><span class=\"line\">- excess - 每毫秒超过对应“流量限制”配置的请求数量</span><br><span class=\"line\">- zone - 定义实施“流量限制”的区域</span><br><span class=\"line\">- client - 发起请求的客户端IP地址</span><br><span class=\"line\">- server - 服务器IP地址或主机名</span><br><span class=\"line\">- request - 客户端发起的实际HTTP请求</span><br><span class=\"line\">- host - HTTP报头中host的值</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 的localtion指令详解","url":"/2025/11/06/Nginx-%E7%9A%84localtion%E6%8C%87%E4%BB%A4%E8%AF%A6%E8%A7%A3/","content":"<h1 id=\"nginx的localtion指令详解\"><a href=\"#nginx的localtion指令详解\" class=\"headerlink\" title=\"nginx的localtion指令详解\"></a>nginx的localtion指令详解</h1><p><code>Nginx 的 HTTP 配置主要包括三个区块，结构如下：</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">http &#123; \t\t\t\t\t\t# 这个是协议级别</span><br><span class=\"line\">　　include mime.types;</span><br><span class=\"line\">　　default_type application/octet-stream;</span><br><span class=\"line\">　　keepalive_timeout 65;</span><br><span class=\"line\">　　gzip on;</span><br><span class=\"line\">　　　　server &#123;\t\t\t # 这个是服务器级别</span><br><span class=\"line\">　　　　　　listen 80;</span><br><span class=\"line\">　　　　　　server_name localhost;</span><br><span class=\"line\">　　　　　　　　location / &#123;  # 这个是请求级别</span><br><span class=\"line\">　　　　　　　　　　root html;</span><br><span class=\"line\">　　　　　　　　　　index index.html index.htm;</span><br><span class=\"line\">　　　　　　　　&#125;</span><br><span class=\"line\">　　　　　　&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>一个HTTP模块里可以有多个server模块</code> <code>一个server模块里可以有多个location模块</code></p>\n<h1 id=\"location-前缀含义\"><a href=\"#location-前缀含义\" class=\"headerlink\" title=\"location 前缀含义\"></a>location 前缀含义</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">=    表示精确匹配，优先级也是最高的 </span><br><span class=\"line\">^~   表示uri以某个常规字符串开头,理解为匹配url路径即可 </span><br><span class=\"line\">~    表示区分大小写的正则匹配  </span><br><span class=\"line\">~*   表示不区分大小写的正则匹配</span><br><span class=\"line\">!~   表示区分大小写不匹配的正则</span><br><span class=\"line\">!~*  表示不区分大小写不匹配的正则</span><br><span class=\"line\">/    通用匹配，任何请求都会匹配到</span><br><span class=\"line\">@    内部服务跳转</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查找顺序和优先级\"><a href=\"#查找顺序和优先级\" class=\"headerlink\" title=\"查找顺序和优先级\"></a>查找顺序和优先级</h1><p><code>= 大于 ^~  大于 ~|~*|!~|!~* 大于 /</code></p>\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 监控控制实验","url":"/2025/11/06/Nginx-%E7%9B%91%E6%8E%A7%E6%8E%A7%E5%88%B6/","content":"<h1 id=\"Nginx-监控\"><a href=\"#Nginx-监控\" class=\"headerlink\" title=\"Nginx 监控\"></a>Nginx 监控</h1><p><code>nginx 提供了 ngx_http_stub_status_module.这个模块提供了基本的监控功能</code></p>\n<h1 id=\"nginx的基础监控\"><a href=\"#nginx的基础监控\" class=\"headerlink\" title=\"nginx的基础监控\"></a>nginx的基础监控</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">- 进程监控</span><br><span class=\"line\">- 端口监控</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"监控的指标\"><a href=\"#监控的指标\" class=\"headerlink\" title=\"监控的指标\"></a>监控的指标</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">Accepts（接受）、Handled（已处理）、Requests（请求数）是一直在增加的计数器。Active（活跃）、Waiting（等待）、Reading（读）、Writing（写）随着请求量而增减</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"nginx-Stub-Status-监控模块安装\"><a href=\"#nginx-Stub-Status-监控模块安装\" class=\"headerlink\" title=\"nginx Stub Status 监控模块安装\"></a>nginx Stub Status 监控模块安装</h1><h1 id=\"先使用命令查看是否已经安装这个模块\"><a href=\"#先使用命令查看是否已经安装这个模块\" class=\"headerlink\" title=\"先使用命令查看是否已经安装这个模块\"></a>先使用命令查看是否已经安装这个模块</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -V大写会显示版本号和模块等信息、v小写仅显示版本信息</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># nginx -V</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"如果没有此模块，需要重新安装，编译命令如下\"><a href=\"#如果没有此模块，需要重新安装，编译命令如下\" class=\"headerlink\" title=\"如果没有此模块，需要重新安装，编译命令如下\"></a>如果没有此模块，需要重新安装，编译命令如下</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 添加--with-http_stub_status_module模块</span></span><br><span class=\"line\"></span><br><span class=\"line\">./configure <span class=\"attr\">--prefix</span>=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-compat --with-file-aio --with-threads --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-mail --with-mail_ssl_module --with-stream --with-stream_realip_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-cc-opt=<span class=\"string\">&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -m64 -mtune=generic -fPIC&#x27;</span> --with-ld-opt=<span class=\"string\">&#x27;-Wl,-z,relro -Wl,-z,now -pie&#x27;</span> --add-module=/root/nginx-sticky-module-ng --with-http_stub_status_module</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"在配置文件里添加\"><a href=\"#在配置文件里添加\" class=\"headerlink\" title=\"在配置文件里添加\"></a>在配置文件里添加</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># vim /etc/nginx/conf.d/status.conf </span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 80<span class=\"comment\">;</span></span><br><span class=\"line\">        server_name localhost<span class=\"comment\">;</span></span><br><span class=\"line\">        location /nginx-status &#123;</span><br><span class=\"line\">                stub_status     on<span class=\"comment\">;</span></span><br><span class=\"line\">                access_log      on<span class=\"comment\">;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"nginx-状态查看\"><a href=\"#nginx-状态查看\" class=\"headerlink\" title=\"nginx 状态查看\"></a>nginx 状态查看</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置完成后在浏览器中输入http://10.0.105.207/nginx-status 查看显示信息如下</span><br><span class=\"line\"></span><br><span class=\"line\">Active connections: 2 </span><br><span class=\"line\">server accepts handled requests</span><br><span class=\"line\"> 26 26 48 </span><br><span class=\"line\">Reading: 0 Writing: 1 Waiting: 1</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 访问控制实验","url":"/2025/11/06/Nginx-%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6/","content":"<h1 id=\"Nginx-访问控制\"><a href=\"#Nginx-访问控制\" class=\"headerlink\" title=\"Nginx 访问控制\"></a>Nginx 访问控制</h1><p>nginx 访问控制模块</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">（1）基于IP的访问控制：http_access_module</span><br><span class=\"line\">（2）基于用户的信任登录：http_auth_basic_module</span><br></pre></td></tr></table></figure>\n\n<p>1、基于IP的访问控制</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 语法</span></span><br><span class=\"line\">Syntax：allow address | all<span class=\"comment\">;</span></span><br><span class=\"line\">default：默认无</span><br><span class=\"line\">Context：http，server，location</span><br><span class=\"line\"></span><br><span class=\"line\">Syntax：deny address | all<span class=\"comment\">;</span></span><br><span class=\"line\">default：默认无</span><br><span class=\"line\"></span><br><span class=\"line\">Context：http，server，<span class=\"attr\">location</span></span><br><span class=\"line\">===================================================</span><br><span class=\"line\"></span><br><span class=\"line\">allow    允许     //ip或者网段</span><br><span class=\"line\">deny    拒绝     //ip或者网段</span><br></pre></td></tr></table></figure>\n\n<p>示例一</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 拒绝192.168.1.8登入，允许其他所有</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># vim /etc/nginx/conf.d/access_mod.conf</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 80<span class=\"comment\">;</span></span><br><span class=\"line\">        server_name localhost<span class=\"comment\">;</span></span><br><span class=\"line\">        location  / &#123;</span><br><span class=\"line\">                root /usr/share/nginx/html<span class=\"comment\">;</span></span><br><span class=\"line\">                index index.html index.hml<span class=\"comment\">;</span></span><br><span class=\"line\">                deny 192.168.1.8<span class=\"comment\">;</span></span><br><span class=\"line\">                allow all<span class=\"comment\">;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># nginx -t</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># nginx -s reload</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#需要注意:</span></span><br><span class=\"line\">1.按顺序匹配，已经被匹配的ip或者网段，后面不再被匹配。</span><br><span class=\"line\">2.如果先允许所有ip访问，在定义拒绝访问。那么拒绝访问不生效。</span><br><span class=\"line\">3.默认为allow all</span><br></pre></td></tr></table></figure>\n\n<p>示例二</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 拒绝所有请求登入</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># vim /etc/nginx/conf.d/access_mod.conf</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen 80<span class=\"comment\">;</span></span><br><span class=\"line\">        server_name localhost<span class=\"comment\">;</span></span><br><span class=\"line\">        location  / &#123;</span><br><span class=\"line\">                root /usr/share/nginx/html<span class=\"comment\">;</span></span><br><span class=\"line\">                index index.html index.hml<span class=\"comment\">;</span></span><br><span class=\"line\">                deny all<span class=\"comment\">;    #拒绝所有</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># nginx -t</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># nginx -s reload</span></span><br></pre></td></tr></table></figure>\n\n<p>2、基于用户的信任登录</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 语法</span></span><br><span class=\"line\">Syntax：auth_basic string | off<span class=\"comment\">;</span></span><br><span class=\"line\">default：auth_basic off<span class=\"comment\">;</span></span><br><span class=\"line\">Context：http，server，location</span><br><span class=\"line\"></span><br><span class=\"line\">Syntax：auth_basic_user_file file<span class=\"comment\">;</span></span><br><span class=\"line\">default：默认无</span><br><span class=\"line\">Context：http，server，location</span><br><span class=\"line\">file：存储用户名密码信息的文件。</span><br></pre></td></tr></table></figure>\n\n<p>示例一</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># vim /etc/nginx/conf.d/auth_mod.conf </span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">\tlisten 80<span class=\"comment\">;</span></span><br><span class=\"line\">\tserver_name localhost<span class=\"comment\">;</span></span><br><span class=\"line\">\tlocation ~ /admin &#123;</span><br><span class=\"line\">\t\troot /var/www/html<span class=\"comment\">;</span></span><br><span class=\"line\">\t\tindex index.html index.hml<span class=\"comment\">;</span></span><br><span class=\"line\">\t\tauth_basic &quot;Auth access test!&quot;<span class=\"comment\">;</span></span><br><span class=\"line\">\t\tauth_basic_user_file /etc/nginx/auth_conf<span class=\"comment\">;</span></span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># nginx -t</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># nginx -s reload</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># mkdir /var/www/html    #创建目录</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># vim /var/www/html/index.html    #创建文件</span></span><br></pre></td></tr></table></figure>\n\n<p><code>auth_basic</code>不为<code>off</code>，开启登录验证功能，</p>\n<p><code>auth_basic_user_file</code>加载账号密码文件。</p>\n<p>3、建立口令文件</p>\n<p><code>登入需要密码</code></p>\n<p>示例一</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># yum install -y httpd-tools #htpasswd 是开源 http 服务器 apache httpd 的一个命令工具，用于生成 http 基本认证的密码文件</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># htpasswd -cm /etc/nginx/auth_conf user10 # -c 创建解密文件，-m MD5加密</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># htpasswd -m /etc/nginx/auth_conf user20</span></span><br><span class=\"line\"><span class=\"section\">[root@192 ~]</span><span class=\"comment\"># cat /etc/nginx/auth_conf </span></span><br><span class=\"line\">user10:$apr1$MOa9UVqF$RlYRMk7eprViEpNtDV0n40</span><br><span class=\"line\">user20:$apr1$biHJhW03$xboNUJgHME6yDd17gkQNb0</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 负载均衡&反向代理","url":"/2025/11/06/Nginx-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86/","content":"<h1 id=\"负载均衡-反向代理\"><a href=\"#负载均衡-反向代理\" class=\"headerlink\" title=\"负载均衡&amp;反向代理\"></a>负载均衡&amp;反向代理</h1><p><strong>准备三台机器：版本为yum源安装</strong></p>\n<p><strong>这个配置是写代理的机器上</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 1.首先在主配置文件上http模块里添加</span><br><span class=\"line\"> [root@localhost ~]# vim /etc/nginx/nginx.conf</span><br><span class=\"line\"> http &#123;</span><br><span class=\"line\">     include       /etc/nginx/mime.types;</span><br><span class=\"line\">     default_type  application/octet-stream;</span><br><span class=\"line\"> # 以下模块添加到代理的机器上</span><br><span class=\"line\"> upstream testapp &#123;</span><br><span class=\"line\">       server 10.0.105.199:8081;</span><br><span class=\"line\">       server 10.0.105.202:8081;</span><br><span class=\"line\">    </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">     include /etc/nginx/conf.d/*.conf;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       80;</span><br><span class=\"line\">        server_name  www.test.com;</span><br><span class=\"line\">        charset utf-8;</span><br><span class=\"line\">        #access_log  logs/host.access.log  main;</span><br><span class=\"line\">        </span><br><span class=\"line\"> # 2.然后在子配置文件里server模块里免添加</span><br><span class=\"line\">         location / &#123;</span><br><span class=\"line\">                 proxy_pass http://testweb;</span><br><span class=\"line\">                 proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">                 proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">                 proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">         &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> # 此时代理机器上配置完成，刷新nginx服务</span><br><span class=\"line\"> systemctl restart nginx</span><br></pre></td></tr></table></figure>\n\n<p><strong>以下是在被代理的机器上写入</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"> # 在两台被代理的机器上分别写入以下location模块内容</span><br><span class=\"line\"> server &#123;</span><br><span class=\"line\">     listen       80;</span><br><span class=\"line\">     server_name  localhost;</span><br><span class=\"line\"> </span><br><span class=\"line\">   #  access_log  /var/log/nginx/host.access.log  main;</span><br><span class=\"line\"> # 写入以下模块</span><br><span class=\"line\">     location / &#123;</span><br><span class=\"line\">         root   /usr/share/nginx/html;</span><br><span class=\"line\">         index  index.html index.htm;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> # 此时被代理机器配置完成，重启服务</span><br><span class=\"line\"> systemctl restart nginx</span><br><span class=\"line\"></span><br><span class=\"line\"># 分别在两台宿主机上创建文件及内容</span><br><span class=\"line\">echo 111 &gt;&gt; /usr/share/nginx/html/index.html</span><br><span class=\"line\"></span><br><span class=\"line\"># 测试</span><br><span class=\"line\">在网站上输入代理机的IP地址，会分别出来两台宿主机的页面</span><br></pre></td></tr></table></figure>\n\n<p><strong>验证</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"> 打开网站，输入代理机器的ip或域名，刷新网站，此时会分别出现被代理机器的内容</span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx 配置健康检查模块","url":"/2025/11/06/Nginx-%E9%85%8D%E7%BD%AE%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E6%A8%A1%E5%9D%97/","content":"<h1 id=\"nginx配置健康检查模块\"><a href=\"#nginx配置健康检查模块\" class=\"headerlink\" title=\"nginx配置健康检查模块\"></a>nginx配置健康检查模块</h1><figure class=\"highlight basic\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>.nginx自带的针对后端节点健康检查的功能比较简单，通过默认自带的ngx_http_proxy_module 模块和ngx_http_upstream_module模块中的参数来完成，当后端节点出现故障时，自动切换到健康节点来提供访问。但是nginx不能事先知道后端节点状态是否健康，后端即使有不健康节点，负载均衡器依然会先把请求转发给该不健康节点，然后再转发给别的节点，这样就会浪费一次转发，而且自带模块无法做到预警。所以我们可以使用第三方模块 nginx_upstream_check_module模块</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span>.nginx_upstream_check_module模块由淘宝团队开发 淘宝自己的 tengine 上是自带了该模块的。我们使用原生Nginx，采用添加模块的方式</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"健康检查模块最高支持1-22及以下的nginx版本\"><a href=\"#健康检查模块最高支持1-22及以下的nginx版本\" class=\"headerlink\" title=\"健康检查模块最高支持1.22及以下的nginx版本\"></a>健康检查模块最高支持1.22及以下的nginx版本</h1><p>获取nginx_upstream_check_module模块，从github上面获取</p>\n<h1 id=\"下载模块\"><a href=\"#下载模块\" class=\"headerlink\" title=\"下载模块\"></a>下载模块</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://github.com/yaoweibin/nginx_upstream_check_module/archive/refs/heads/master.zip</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"下载解压软件包及解压\"><a href=\"#下载解压软件包及解压\" class=\"headerlink\" title=\"下载解压软件包及解压\"></a>下载解压软件包及解压</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install -y unzip</span><br><span class=\"line\"></span><br><span class=\"line\">unzip -d /usr/local/ master.zip\t\t//解压要指定目录</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"进入nginx的解压目录中\"><a href=\"#进入nginx的解压目录中\" class=\"headerlink\" title=\"进入nginx的解压目录中\"></a>进入nginx的解压目录中</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd /usr/local/nginx-1.22.1/</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"下载指定路径安装软件\"><a href=\"#下载指定路径安装软件\" class=\"headerlink\" title=\"下载指定路径安装软件\"></a>下载指定路径安装软件</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install -y patch\t//patch可以指定安装路径</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"打补丁\"><a href=\"#打补丁\" class=\"headerlink\" title=\"打补丁\"></a>打补丁</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">-p0，是“当前路径” -p1，是“上一级路径”</span></span><br><span class=\"line\">patch -p1 &lt; ../nginx_upstream_check_module-master/check_1.20.1+.patch</span><br></pre></td></tr></table></figure>\n\n<p>编译下载安装</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">./configure --prefix=/usr/local/nginx --group=nginx --user=nginx --sbin-path=/usr/local/nginx/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/tmp/nginx/client_body --http-proxy-temp-path=/tmp/nginx/proxy --http-fastcgi-temp-path=/tmp/nginx/fastcgi --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_realip_module --with-stream --add-module=../nginx_upstream_check_module-master/</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">--add-module=../nginx_upstream_check_module-master/\t//这个是添加的nginx_upstream_check_module模块</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"编译\"><a href=\"#编译\" class=\"headerlink\" title=\"编译\"></a>编译</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">make \t//如果是添加模块只需要make 第一次安装需要make install\t</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"将原来的nginx二进制命令备份\"><a href=\"#将原来的nginx二进制命令备份\" class=\"headerlink\" title=\"将原来的nginx二进制命令备份\"></a>将原来的nginx二进制命令备份</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"将新生成的命令cp到nginx的命令目录中\"><a href=\"#将新生成的命令cp到nginx的命令目录中\" class=\"headerlink\" title=\"将新生成的命令cp到nginx的命令目录中\"></a>将新生成的命令cp到nginx的命令目录中</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cp objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">http &#123;</span><br><span class=\"line\">upstream app &#123;</span><br><span class=\"line\">        server 192.168.209.128 weight=1;</span><br><span class=\"line\">        server 192.168.209.130 weight=1;</span><br><span class=\"line\">        check interval=5000 rise=2 fall=3 timeout=4000 type=http port=80;</span><br><span class=\"line\">        check_http_send &quot;HEAD / HTTP/1.0\\r\\n\\r\\n&quot;;</span><br><span class=\"line\">        check_http_expect_alive http_2xx http_3xx;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       80;</span><br><span class=\"line\">        server_name  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">                proxy_pass http://app;</span><br><span class=\"line\">                proxy_redirect default;</span><br><span class=\"line\">                proxy_set_header Host $http_host;</span><br><span class=\"line\">                proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">        location /status &#123;   #开启监控状态页面</span><br><span class=\"line\">                check_status;</span><br><span class=\"line\">                access_log   off;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">参数解释：</span><br><span class=\"line\">interval:表示每隔多少毫秒向后端发送健康检查包；</span><br><span class=\"line\">rise:表示如果连续成功次数达到2 服务器就被认为是up；</span><br><span class=\"line\">fail:表示如果连续失败次数达到3 服务器就被认为是down；</span><br><span class=\"line\">timeout:表示后端健康请求的超时时间是多少毫秒；</span><br><span class=\"line\">type:表示发送的健康检查包是什么类型的请求；</span><br><span class=\"line\">port: 表示发送检查到后端的服务的端口;</span><br><span class=\"line\">check_http_send:表示http健康检查包发送的请求内容。为了减少传输数据量，推荐采用“head”方法；</span><br><span class=\"line\">check_http_expect_alive:指定HTTP回复的成功状态，默认认为2XX和3XX的状态是健康的；</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看访问状态\"><a href=\"#查看访问状态\" class=\"headerlink\" title=\"查看访问状态\"></a>查看访问状态</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">192.168.116.111/status\t\t//查看状态，需要在IP地址后面加上status</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx优势及安装","url":"/2025/11/06/Nginx%E4%BC%98%E5%8A%BF%E5%8F%8A%E5%AE%89%E8%A3%85/","content":"<h1 id=\"Nginx优势及安装\"><a href=\"#Nginx优势及安装\" class=\"headerlink\" title=\"Nginx优势及安装\"></a>Nginx优势及安装</h1><h1 id=\"为什么选择-nginx\"><a href=\"#为什么选择-nginx\" class=\"headerlink\" title=\"为什么选择 nginx\"></a>为什么选择 nginx</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.高并发，高性能</span><br><span class=\"line\">2.高可靠--7*24小时不间断运行</span><br><span class=\"line\">3.可扩展性强--模块化设计，使得添加模块非常的平稳</span><br><span class=\"line\">4.热部署--可以在不停止服务器的情况下升级nginx</span><br><span class=\"line\">5.BSD许可证--nginx不止开源免费的我们还可以更具实际需求进行定制修改源代码</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">它是IO多路复用，通过记录跟踪每个I/O流的状态，来同时管理多个I/O流，另外通过epoll来监控处理有数据的代码</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">外加它是异步非阻塞</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"yum安装\"><a href=\"#yum安装\" class=\"headerlink\" title=\"yum安装\"></a>yum安装</h2><h1 id=\"1-配置yum源安装nginx\"><a href=\"#1-配置yum源安装nginx\" class=\"headerlink\" title=\"1.配置yum源安装nginx\"></a>1.配置yum源安装nginx</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">清理原有数据</span><br><span class=\"line\">yum -y install yum-utils</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置源码文件\"><a href=\"#配置源码文件\" class=\"headerlink\" title=\"配置源码文件\"></a>配置源码文件</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">/etc/yum.repo.d/nginx.repo &lt;&lt; EOF</span><br><span class=\"line\">[nginx-stable]</span><br><span class=\"line\">name=nginx stable repo</span><br><span class=\"line\">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"下载及启动服务\"><a href=\"#下载及启动服务\" class=\"headerlink\" title=\"下载及启动服务\"></a>下载及启动服务</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install nginx</span><br><span class=\"line\">systemctl start nginx</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2-yum源选择版本安装\"><a href=\"#2-yum源选择版本安装\" class=\"headerlink\" title=\"2.yum源选择版本安装\"></a>2.yum源选择版本安装</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置Yum源的官网：http://nginx.org/en/linux_packages.html</span><br><span class=\"line\"></span><br><span class=\"line\">配置Yum源1.22版本：https://nginx.org/download/nginx-1.22.1.tar.gz</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"3-编译安装\"><a href=\"#3-编译安装\" class=\"headerlink\" title=\"3.编译安装\"></a>3.编译安装</h1><h1 id=\"关闭防火墙\"><a href=\"#关闭防火墙\" class=\"headerlink\" title=\"关闭防火墙\"></a>关闭防火墙</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">setenforce 0</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"下载wget\"><a href=\"#下载wget\" class=\"headerlink\" title=\"下载wget\"></a>下载wget</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install wget</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装编译环境\"><a href=\"#安装编译环境\" class=\"headerlink\" title=\"安装编译环境\"></a>安装编译环境</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install gcc gcc-c++</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装依赖pcre软件包（使nginx支持http-rewrite模块）\"><a href=\"#安装依赖pcre软件包（使nginx支持http-rewrite模块）\" class=\"headerlink\" title=\"安装依赖pcre软件包（使nginx支持http rewrite模块）\"></a>安装依赖pcre软件包（使nginx支持http rewrite模块）</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install -y pcre pcre-devel gd-devel</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装依赖openssl-devel（使nginx支持ssl）\"><a href=\"#安装依赖openssl-devel（使nginx支持ssl）\" class=\"headerlink\" title=\"安装依赖openssl-devel（使nginx支持ssl）\"></a>安装依赖openssl-devel（使nginx支持ssl）</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install -y openssl openssl-devel</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装依赖zlib\"><a href=\"#安装依赖zlib\" class=\"headerlink\" title=\"安装依赖zlib\"></a>安装依赖zlib</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install -y zlib zlib-devel</span><br></pre></td></tr></table></figure>\n<h1 id=\"创建nginx用户，不允许登录\"><a href=\"#创建nginx用户，不允许登录\" class=\"headerlink\" title=\"创建nginx用户，不允许登录\"></a>创建nginx用户，不允许登录</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">useradd nginx -s /sbin/nologin</span><br></pre></td></tr></table></figure>\n<h1 id=\"下载官方nginx\"><a href=\"#下载官方nginx\" class=\"headerlink\" title=\"下载官方nginx\"></a>下载官方nginx</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://nginx.org/download/nginx-1.24.0.tar.gz\t\t//下载1.24版本</span><br><span class=\"line\">wget https://nginx.org/download/nginx-1.22.1.tar.gz\t\t//下载 1.22版本</span><br></pre></td></tr></table></figure>\n<h1 id=\"解压nginx包\"><a href=\"#解压nginx包\" class=\"headerlink\" title=\"解压nginx包\"></a>解压nginx包</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">tar zxvf nginx-1.24.0.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure>\n<h1 id=\"切换目录\"><a href=\"#切换目录\" class=\"headerlink\" title=\"切换目录\"></a>切换目录</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd /usr/local/nginx-1.24.0/</span><br></pre></td></tr></table></figure>\n<h1 id=\"配置安装参数\"><a href=\"#配置安装参数\" class=\"headerlink\" title=\"配置安装参数\"></a>配置安装参数</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">./configure --prefix=/usr/local/nginx --group=nginx --user=nginx --sbin-path=/usr/local/nginx/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/tmp/nginx/client_body --http-proxy-temp-path=/tmp/nginx/proxy --http-fastcgi-temp-path=/tmp/nginx/fastcgi --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx --with-http_stub_status_module --with-http_ssl_module --with-http_gzip_static_module --with-pcre --with-http_realip_module --with-stream</span><br></pre></td></tr></table></figure>\n<h1 id=\"过程当中如果出错，删除Makefile文件后重新配置\"><a href=\"#过程当中如果出错，删除Makefile文件后重新配置\" class=\"headerlink\" title=\"过程当中如果出错，删除Makefile文件后重新配置\"></a>过程当中如果出错，删除Makefile文件后重新配置</h1><h1 id=\"编译以及编译安装\"><a href=\"#编译以及编译安装\" class=\"headerlink\" title=\"编译以及编译安装\"></a>编译以及编译安装</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">make &amp;&amp; make install</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">检测nginx配置文件是否正确</span></span><br><span class=\"line\">/usr/local/nginx/sbin/nginx -t</span><br><span class=\"line\">mkdir -p /tmp/nginx/client_body</span><br></pre></td></tr></table></figure>\n<h1 id=\"启动nginx服务\"><a href=\"#启动nginx服务\" class=\"headerlink\" title=\"启动nginx服务\"></a>启动nginx服务</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">/usr/local/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>\n<h1 id=\"创建连接文件，可以直接用nginx命令\"><a href=\"#创建连接文件，可以直接用nginx命令\" class=\"headerlink\" title=\"创建连接文件，可以直接用nginx命令\"></a>创建连接文件，可以直接用nginx命令</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ln -s /usr/local/nginx/sbin/nginx /usr/bin/nginx</span><br></pre></td></tr></table></figure>\n<h1 id=\"连接文件创建成功后，nginx常用命令\"><a href=\"#连接文件创建成功后，nginx常用命令\" class=\"headerlink\" title=\"连接文件创建成功后，nginx常用命令\"></a>连接文件创建成功后，nginx常用命令</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">nginx -s reload\t\t\t# 修改配置后重新加载生效</span><br><span class=\"line\">nginx -s stop\t\t\t# 快速停止nginx</span><br><span class=\"line\">nginx -s quit\t\t\t# 正常停止nginx</span><br><span class=\"line\">nginx -t\t\t\t\t# 测试当前配置文件是否正确**</span><br><span class=\"line\">nginx\t\t\t\t\t#正常启动</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Nginx可视化分类部署","url":"/2025/11/06/Nginx%E5%8F%AF%E8%A7%86%E5%8C%96%E5%88%86%E7%B1%BB%E9%83%A8%E7%BD%B2/","content":"<h2 id=\"部署Nginx可视化界面\"><a href=\"#部署Nginx可视化界面\" class=\"headerlink\" title=\"部署Nginx可视化界面\"></a>部署Nginx可视化界面</h2><h3 id=\"1、长亭雷池SafeLine部署\"><a href=\"#1、长亭雷池SafeLine部署\" class=\"headerlink\" title=\"1、长亭雷池SafeLine部署\"></a>1、长亭雷池SafeLine部署</h3><h4 id=\"最低配置要求\"><a href=\"#最低配置要求\" class=\"headerlink\" title=\"最低配置要求\"></a>最低配置要求</h4><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">操作系统：Linux</span><br><span class=\"line\">指令架构：x86_64</span><br><span class=\"line\">软件依赖：Docker <span class=\"number\">20.10</span><span class=\"number\">.14</span> 版本以上</span><br><span class=\"line\">软件依赖：Docker Compose <span class=\"number\">2.0</span>.<span class=\"number\">0</span> 版本以上</span><br><span class=\"line\">最小化环境：<span class=\"number\">1</span> 核 CPU / <span class=\"number\">1</span> GB 内存 / <span class=\"number\">5</span> GB 磁盘</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"一键脚本安装\"><a href=\"#一键脚本安装\" class=\"headerlink\" title=\"一键脚本安装\"></a>一键脚本安装</h4><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash -c <span class=\"string\">&quot;<span class=\"variable\">$(</span>curl -fsSLk https://waf-ce.chaitin.cn/release/latest/setup.sh)&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 脚本地址</span></span><br><span class=\"line\">https:<span class=\"regexp\">//</span>waf-ce.chaitin.cn/docs/guide/install</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、nginxWebUI界面部署\"><a href=\"#2、nginxWebUI界面部署\" class=\"headerlink\" title=\"2、nginxWebUI界面部署\"></a>2、nginxWebUI界面部署</h3><h4 id=\"安装jdk、nginx\"><a href=\"#安装jdk、nginx\" class=\"headerlink\" title=\"安装jdk、nginx\"></a>安装jdk、nginx</h4><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https:<span class=\"regexp\">//gi</span>tee.com/xbd666/qingfeng/raw/master/toolbox.sh)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"下载nginxWebUI-jarbao\"><a href=\"#下载nginxWebUI-jarbao\" class=\"headerlink\" title=\"下载nginxWebUI.jarbao\"></a>下载nginxWebUI.jarbao</h4><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">mkdir</span> /opt/nginxWebUI/ </span><br><span class=\"line\">wget -O /opt/nginxWebUI/nginxWebUI.jar http:<span class=\"regexp\">//</span>file.nginxwebui.cn/nginxWebUI-<span class=\"number\">3.8</span>.<span class=\"number\">2</span>.jar</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"启动程序\"><a href=\"#启动程序\" class=\"headerlink\" title=\"启动程序\"></a>启动程序</h4><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">nohup java -jar -Dfile.encoding=UTF-<span class=\"number\">8</span> /opt/nginxWebUI/nginxWebUI.jar --server.port=<span class=\"number\">8080</span> --project.home=<span class=\"regexp\">/opt/nginx</span>WebUI/ &gt; <span class=\"regexp\">/dev/null</span> &amp;</span><br><span class=\"line\"><span class=\"comment\"># 端口可以自定义</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"登入访问页面\"><a href=\"#登入访问页面\" class=\"headerlink\" title=\"登入访问页面\"></a>登入访问页面</h4><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">http:<span class=\"regexp\">//ip</span>:<span class=\"number\">8080</span>   进入主页\t\t<span class=\"comment\"># 端口可以自定义</span></span><br><span class=\"line\"><span class=\"comment\"># 第一次登入需要设置用户名 和 用户密码</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在http参数配置中可以配置nginx的http项目，进行http转发，默认会给出几个常用配置，其他需要的配置可自由增删改查。可以勾选开启日志跟踪，生成日志文件</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在反向代理中可配置nginx的反向代理即server项功能，可开启ssl功能，可以直接从网页上上传pem文件和key文件，或者使用系统内申请的证书，可以直接开启http转跳https功能，也可开启http2协议</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在负载均衡中可配置nginx的负载均衡即upstream项功能，在反向代理管理中可选择代理目标为配置好的负载均衡</span></span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"Oracle数据库部署、监听、优化、备份恢复","url":"/2025/11/06/Oracle%E6%95%B0%E6%8D%AE%E5%BA%93%E9%83%A8%E7%BD%B2%E3%80%81%E7%9B%91%E5%90%AC%E3%80%81%E4%BC%98%E5%8C%96%E3%80%81%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/","content":"<h2 id=\"VM虚拟机安装oracle\"><a href=\"#VM虚拟机安装oracle\" class=\"headerlink\" title=\"VM虚拟机安装oracle\"></a>VM虚拟机安装oracle</h2><h1 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h1><h2 id=\"1-改操作系统核心参数\"><a href=\"#1-改操作系统核心参数\" class=\"headerlink\" title=\"1.改操作系统核心参数\"></a>1.改操作系统核心参数</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim /etc/security/limits.conf</span><br><span class=\"line\"></span><br><span class=\"line\">oracle soft nofile 65536</span><br><span class=\"line\">oracle hard nofile 65536</span><br><span class=\"line\">oracle soft nproc 16384</span><br><span class=\"line\">oracle hard nproc 16384</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim /etc/sysctl.conf</span><br><span class=\"line\"></span><br><span class=\"line\">kernel.shmmax = 2147483648</span><br><span class=\"line\">kernel.shmmni = 4096</span><br><span class=\"line\">kernel.shmall = 2097152</span><br><span class=\"line\">kernel.sem = 510 32000 100 128</span><br><span class=\"line\">fs.file-max ingfeng@123= 65536</span><br><span class=\"line\">net.ipv4.ip_local_port_range = 1024 65000</span><br><span class=\"line\">net.core.rmem_default = 4194304</span><br><span class=\"line\">net.core.rmem_max = 4194304</span><br><span class=\"line\">net.core.wmem_max = 16777216</span><br><span class=\"line\">net.core.wmem_default = 266960</span><br></pre></td></tr></table></figure>\n\n<p>使&#x2F;etc&#x2F;sysctl.conf更改立即生效</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# sysctl -p</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-创建相关用户和用户组\"><a href=\"#2-创建相关用户和用户组\" class=\"headerlink\" title=\"2.创建相关用户和用户组\"></a>2.创建相关用户和用户组</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# groupadd oinstall</span><br><span class=\"line\">[root@localhost ~]# groupadd dba</span><br><span class=\"line\">[root@localhost ~]# useradd -g dba -G oinstall -m oracle</span><br><span class=\"line\">[root@localhost ~]# passwd oracle</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-创建数据库软件目录和数据文件存放目录\"><a href=\"#3-创建数据库软件目录和数据文件存放目录\" class=\"headerlink\" title=\"3.创建数据库软件目录和数据文件存放目录\"></a>3.创建数据库软件目录和数据文件存放目录</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# mkdir -p /opt/oracle/</span><br><span class=\"line\">[root@localhost ~]# mkdir -p /opt/oracle/oracle/product</span><br><span class=\"line\">[root@localhost ~]# mkdir -p /opt/oracle/oradata/</span><br><span class=\"line\">[root@localhost ~]# mkdir -p /opt/oracle/oralnventory</span><br></pre></td></tr></table></figure>\n\n<p>更改oracle目录的own</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# chown -R oracle:dba /opt/oracle</span><br></pre></td></tr></table></figure>\n\n<p>改变&#x2F;home&#x2F;oracle目录的拥有者</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# chown -R oracle:dba /home/oracle</span><br></pre></td></tr></table></figure>\n\n<p>下载依赖</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# yum -y install libXp.i686 libXp-devel.i686 libXt.i686 libXt-devel.i686 libXtst.i686 libXtst-devel.i686 make.x86_64 gcc.x86_64 libaio.x86_64 glibc-devel.i686 libgcc.i686 glibc* gcc* make* compat-db* libstdc* libXp* libXtst* compat-libstdc++* libaio libaio-devel sysstat unixODBC unixODBC-devel</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-配置环境变量\"><a href=\"#4-配置环境变量\" class=\"headerlink\" title=\"4.配置环境变量\"></a>4.配置环境变量</h2><p>以root用户执行</p>\n<p>su - oracle切换为oracle用户<br><strong>修改$HOME&#x2F;.bash_profile文件</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[oracle@localhost ~]$ vim .bash_profile   #设置以下变量</span><br><span class=\"line\"></span><br><span class=\"line\">export ORACLE_BASE=/opt/oracle/</span><br><span class=\"line\">export ORACLE_HOME=/opt/oracle/oracle/product/11.2.0/dbhome_1</span><br><span class=\"line\">export ORACLE_SID=orcl</span><br><span class=\"line\">export PATH=$PATH:$HOME/bin:$ORACLE_HOME/bin</span><br><span class=\"line\">export LD_LIBRARY_PATH=$ORACLE_HOME/lib:/usr/lib</span><br><span class=\"line\"></span><br><span class=\"line\">[oracle@localhost ~]$ source .bash_profile</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install unzip   #如果没有unzip命令要先下载</span><br><span class=\"line\"></span><br><span class=\"line\">[oracle@localhost ~]$ unzip p13390677_112040_Linux-x86-64_1of7.zip</span><br><span class=\"line\">[oracle@localhost ~]$ unzip p13390677_112040_Linux-x86-64_2of7.zip</span><br><span class=\"line\">解压时会默认自动生成database目录</span><br><span class=\"line\">[oracle@localhost ~]$ ls</span><br><span class=\"line\">database                                p13390677_112040_Linux-x86-64_2of7.zip</span><br><span class=\"line\">p13390677_112040_Linux-x86-64_1of7.zip</span><br><span class=\"line\">[oracle@localhost ~]$ cd database/</span><br><span class=\"line\">[oracle@localhost database]$ ls</span><br><span class=\"line\">install  readme.html  response  rpm  runInstaller  sshsetup  stage  welcome.html</span><br></pre></td></tr></table></figure>\n\n<p>切换到root目录执行下列命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# export DISPLAY=:0.0</span><br><span class=\"line\">[root@localhost ~]# xhost +</span><br><span class=\"line\">access control disabled, clients can connect from any host</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-开始安装\"><a href=\"#5-开始安装\" class=\"headerlink\" title=\"5.开始安装\"></a>5.开始安装</h2><p>安装（oracle用户）进入到database目录</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[oracle@localhost database]$ export DISPLAY=:0.0</span><br><span class=\"line\">[oracle@localhost database]$ export DISPLAY</span><br><span class=\"line\">[oracle@localhost database]$ echo $SHELL</span><br><span class=\"line\">/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">当检查均通过，会出现oracle安装界面，如此时安装界面出现乱码，可能是系统语言为中文导致，需要临时修改系统语言</span><br><span class=\"line\">[oracle@localhost database]$ echo $LANG</span><br><span class=\"line\">[oracle@localhost database]$ export LANG=&#x27;en_US&#x27;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">不进行以上操作，启动会报错</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">验证环境变量是否生效，不然后续配置会出错</span></span><br><span class=\"line\">[oracle@localhost database]$ echo $ORACLE_HOME </span><br><span class=\"line\">/opt/oracle/oracle/product/11.2.0/dbhome_1</span><br><span class=\"line\">[oracle@localhost database]$ echo $LD_LIBRARY_PATH</span><br><span class=\"line\">/opt/oracle/oracle/product/11.2.0/dbhome_1/lib:/usr/lib</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">在database目录下启动</span></span><br><span class=\"line\">[oracle@localhost database]$ ./runInstaller</span><br><span class=\"line\">这时在vm上设置oracle</span><br></pre></td></tr></table></figure>\n\n<p>此时进入vm桌面进行操作</p>\n<figure class=\"highlight basic\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>、取消邮件的勾选，点yes，<span class=\"keyword\">Next</span></span><br><span class=\"line\"><span class=\"number\">2</span>、选Skip software updates跳过软件更新，下一步<span class=\"keyword\">Next</span></span><br><span class=\"line\"><span class=\"number\">3</span>、Create <span class=\"keyword\">and</span> configure a database创建和配置数据库，<span class=\"keyword\">Next</span></span><br><span class=\"line\"><span class=\"number\">4</span>、Desktop ClassO Desktop类，<span class=\"keyword\">Next</span></span><br><span class=\"line\"><span class=\"number\">5</span>、设置密码，<span class=\"keyword\">Next</span></span><br><span class=\"line\"><span class=\"number\">6</span>、选择dba，<span class=\"keyword\">Next</span>----这时候会出现报错，将路径(/opt/oracle/oralnventory)重新选择下就好,另外如果时重新安装，需要将oralnventory目录下清空才可以重新安装，点yes，<span class=\"keyword\">Next</span></span><br><span class=\"line\"><span class=\"number\">7</span>、Prerequis ite Checks前提条件检查,在root用户下执行（/tmp/CVU_11.<span class=\"number\">2.0</span>.<span class=\"number\">4.0</span>_oracle/runfixup.sh）脚本，做<span class=\"keyword\">swap</span>分区，安装需要安装的依赖包，然后再点检查，基本可以清空警告了---或者不重要的勾选Ignore All跳过，点yes，<span class=\"keyword\">Next</span></span><br><span class=\"line\">注：需要安装pdksh-<span class=\"number\">5.2</span>.<span class=\"number\">14</span>---先root用户下卸载rpm -e ksh-<span class=\"number\">20120801</span>-<span class=\"number\">144</span>.el7_9.x86_64---安装rpm -ivh pdksh-<span class=\"number\">5.2</span>.<span class=\"number\">14</span>-<span class=\"number\">37</span>.el5.x86_64.rpm</span><br><span class=\"line\"><span class=\"number\">8</span>、点install---安装到<span class=\"number\">70</span>%左右会报错，更改以下参数就可以了</span><br><span class=\"line\">[oracle@localhost database]$ vim $ORACLE_HOME/sysman/lib/ins_emagent.mk</span><br><span class=\"line\">将$(MK_EMAGENT_NMECTL)改为$(MK_EMAGENT_NMECTL) -lnnz11</span><br><span class=\"line\"><span class=\"number\">9</span>、按照步骤点OK</span><br></pre></td></tr></table></figure>\n\n<p>用root用户执行如下两个语句之后，点击OK</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# /opt/oracle/oralnventory/orainstRoot.sh</span><br><span class=\"line\">[root@localhost ~]# /opt/oracle/oracle/product/11.2.0/dbhome_1/root.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6、测试\"><a href=\"#6、测试\" class=\"headerlink\" title=\"6、测试\"></a>6、测试</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[oracle@localhost ~]$ sqlplus / as sysdba     登入数据库</span><br><span class=\"line\">create tablespace nk01 datafile &#x27;/home/oracle/app/oracle/oradata/meddate/nk01.dbf&#x27; size 200m autoextend on next 100m maxsize unlimited;\t\t创建一个空表</span><br><span class=\"line\">create user nk01 identified bu admin；</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">创建用户、授权、创建表空间</span></span><br><span class=\"line\">创建uk01用户</span><br><span class=\"line\">CREATE USER uk01 IDENTIFIED BY password;</span><br><span class=\"line\"></span><br><span class=\"line\">授予 nk01 用户对表 table_name 的查询权限</span><br><span class=\"line\">GRANT SELECT ON table_name TO nk01;</span><br><span class=\"line\">授予 nk01 用户创建表的权限</span><br><span class=\"line\">GRANT CREATE TABLE TO nk01;</span><br><span class=\"line\"></span><br><span class=\"line\">创建表空间</span><br><span class=\"line\">CREATE TABLESPACE tablespace_name</span><br><span class=\"line\">DATAFILE &#x27;file_path_and_name.dbf&#x27; SIZE size;</span><br><span class=\"line\"></span><br><span class=\"line\">授权表空间给用户uk01</span><br><span class=\"line\">ALTER USER uk01 DEFAULT TABLESPACE tablespace_name;</span><br></pre></td></tr></table></figure>\n\n<p>最后把防火墙的端口打开</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# firewall-cmd --add-port=1521/tcp</span><br><span class=\"line\">[root@localhost ~]# firewall-cmd --add-port=1521/tcp --permanent</span><br><span class=\"line\">[root@localhost ~]# firewall-cmd --add-port=1158/tcp</span><br><span class=\"line\">[root@localhost ~]# firewall-cmd --add-port=1158/tcp --permanent</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"监听\"><a href=\"#监听\" class=\"headerlink\" title=\"监听\"></a>监听</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">1、netca监听</span><br><span class=\"line\"><span class=\"section\">[oracle@oracle ~]</span>$ netca</span><br><span class=\"line\">在oracle用户下执行 netca 命令</span><br><span class=\"line\">选择 Listener configuration，点击 Next</span><br><span class=\"line\">选择 Add 添加，点击 Next</span><br><span class=\"line\">输入监听程序名-可以自定义，点击 Next</span><br><span class=\"line\">选择TCP协议，点击 Next</span><br><span class=\"line\">选择端口号1521，点击 Next</span><br><span class=\"line\">是否需要配置另外一个监听器，选择 No，点击 Next</span><br><span class=\"line\">点击 Next，最后点击完成</span><br><span class=\"line\"></span><br><span class=\"line\">示例：</span><br><span class=\"line\"><span class=\"section\">[oracle@oracle ~]</span>$ netca</span><br><span class=\"line\">Oracle Net Services Configuration:</span><br><span class=\"line\">Configuring Listener:LISTENER01</span><br><span class=\"line\">Listener configuration complete.</span><br><span class=\"line\">Configuring Listener:LISTENER02</span><br><span class=\"line\">Listener configuration complete.</span><br><span class=\"line\">Oracle Net Services configuration successful. The exit code is 0</span><br><span class=\"line\"></span><br><span class=\"line\">2、netmgr监听</span><br><span class=\"line\"><span class=\"section\">[oracle@oracle ~]</span>$ netmgr</span><br><span class=\"line\">选择listeners---点+号---起个监听器的名字--点OK</span><br><span class=\"line\">监听的位置：点 Add Address---协议tcp--host主机名（自定义）---端口</span><br><span class=\"line\">点file---选择save network configuration 保存</span><br><span class=\"line\"></span><br><span class=\"line\">3、修改配置文件方式监听</span><br><span class=\"line\">在/opt/oracle/oracle/product/11.2.0/dbhome_1/network/admin/listener.ora里修改</span><br><span class=\"line\">注：前面的路径为export定义的家目录</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"调优\"><a href=\"#调优\" class=\"headerlink\" title=\"调优\"></a>调优</h1><figure class=\"highlight basic\"><table><tr><td class=\"code\"><pre><span class=\"line\">增加<span class=\"keyword\">swap</span>分区</span><br><span class=\"line\">swapon -s</span><br><span class=\"line\">#创建<span class=\"keyword\">swap</span>文件 bs=<span class=\"number\">2300</span>的设置的值一般为内存的<span class=\"number\">1.5</span>倍以上 </span><br><span class=\"line\">dd <span class=\"keyword\">if</span>=/dev/zero of=/var/<span class=\"keyword\">swap</span> bs=<span class=\"number\">2500</span> count=<span class=\"number\">1000000</span></span><br><span class=\"line\">#需要更改<span class=\"keyword\">swap</span>文件的权限，确保只有root才可读</span><br><span class=\"line\">chmod <span class=\"number\">600</span> /var/<span class=\"keyword\">swap</span></span><br><span class=\"line\">#告知系统将该文件用于<span class=\"keyword\">swap</span></span><br><span class=\"line\">mkswap /var/<span class=\"keyword\">swap</span></span><br><span class=\"line\">#开始使用该<span class=\"keyword\">swap</span></span><br><span class=\"line\">swapon /var/<span class=\"keyword\">swap</span></span><br><span class=\"line\">#使<span class=\"keyword\">Swap</span>文件永久生效,/etc/fstab加入配置</span><br><span class=\"line\">echo <span class=\"string\">&quot;/var/swap   swap    swap    sw  0   0&quot;</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\">如果上面创建后发现，大小创建错误了。如何重置呢？</span><br><span class=\"line\">swapoff -a</span><br><span class=\"line\">rm /var/<span class=\"keyword\">swap</span></span><br><span class=\"line\">上面命令就可以删除了，然后重新创建合适的<span class=\"keyword\">swap</span>文件就行了。</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight basic\"><table><tr><td class=\"code\"><pre><span class=\"line\">调整aio-max-nr内核参数，你可以按照以下步骤进行操作：</span><br><span class=\"line\"><span class=\"number\">1</span>. sudo vi /etc/sysctl.conf</span><br><span class=\"line\"><span class=\"number\">2</span>. fs.aio-max-nr = <span class=\"number\">65536</span>  自己修改合适的参数例如<span class=\"number\">65536</span></span><br><span class=\"line\"><span class=\"number\">3</span>. 加载新的内核参数配置 sudo sysctl -p</span><br><span class=\"line\"><span class=\"number\">4</span>. 验证参数设置  sysctl fs.aio-max-nr</span><br><span class=\"line\"><span class=\"number\">5</span>. 重新运行预安装检查 确保aio-max-nr参数设置已满足要求</span><br><span class=\"line\">直到yes</span><br><span class=\"line\"></span><br><span class=\"line\">解决内核参数，调优</span><br><span class=\"line\">vim /etc/sysctl.conf</span><br><span class=\"line\"></span><br><span class=\"line\">kernel.shmmax = <span class=\"number\">2147483648</span></span><br><span class=\"line\">kernel.shmmni = <span class=\"number\">4096</span></span><br><span class=\"line\">kernel.shmall = <span class=\"number\">2097152</span></span><br><span class=\"line\">kernel.sem = <span class=\"number\">510</span> <span class=\"number\">32000</span> <span class=\"number\">100</span> <span class=\"number\">128</span></span><br><span class=\"line\">fs.file-max ingfeng@<span class=\"number\">123</span>= <span class=\"number\">65536</span></span><br><span class=\"line\">net.ipv4.ip_local_port_range = <span class=\"number\">1024</span> <span class=\"number\">65000</span></span><br><span class=\"line\">net.core.rmem_default = <span class=\"number\">4194304</span></span><br><span class=\"line\">net.core.rmem_max = <span class=\"number\">4194304</span></span><br><span class=\"line\">net.core.wmem_max = <span class=\"number\">16777216</span></span><br><span class=\"line\">net.core.wmem_default = <span class=\"number\">266960</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight basic\"><table><tr><td class=\"code\"><pre><span class=\"line\">调优：</span><br><span class=\"line\">优化 SQL 查询：</span><br><span class=\"line\">- 分析和优化关键 SQL 查询的执行计划</span><br><span class=\"line\">\t#查看 SQL 查询的执行计划</span><br><span class=\"line\">\tEXPLAIN PLAN <span class=\"keyword\">FOR</span> &lt;your_query&gt;;</span><br><span class=\"line\">\t#显示查询的执行计划</span><br><span class=\"line\">\tSELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);</span><br><span class=\"line\">- 确保适当的索引被使用，以避免全表扫描</span><br><span class=\"line\">\t#查看表的索引</span><br><span class=\"line\">\tSELECT index_name, column_name FROM user_ind_columns WHERE table_name = <span class=\"comment\">&#x27;&lt;table_name&gt;&#x27;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">合理配置数据库参数：</span><br><span class=\"line\">- 调整 SGA 大小需要根据系统的总内存和数据库负载情况来确定。一般建议将 SGA 大小设置为可用内存的 <span class=\"number\">50</span>% 到 <span class=\"number\">80</span>%</span><br><span class=\"line\">- 调整PGA，使用 PGA_AGGREGATE_TARGET 参数修改 PGA 大小</span><br><span class=\"line\">- 数据库缓存，调整 DB_CACHE_SIZE 参数来调整数据库缓冲区的大小</span><br><span class=\"line\">- 连接池用于管理数据库连接的分配和释放，PROCESSES 参数限制数据库的最大并发连接数，并通过设置 SESSIONS 参数限制连接数</span><br><span class=\"line\"></span><br><span class=\"line\">优化索引：</span><br><span class=\"line\">- 确保表上存在适当的索引，以加快查询速度</span><br><span class=\"line\">\tCREATE INDEX index_name <span class=\"keyword\">ON</span> table_name (column1, column2);</span><br><span class=\"line\">- 定期重建或重新组织索引，以减少索引碎片并提高查询性能</span><br><span class=\"line\">\tALTER INDEX index_name REBUILD;</span><br><span class=\"line\">\tALTER INDEX index_name REORGANIZE;</span><br><span class=\"line\">- 定期执行索引维护任务</span><br><span class=\"line\"></span><br><span class=\"line\">使用分区表和分区索引：</span><br><span class=\"line\">- 可以使用分区表和分区索引来提高查询性能</span><br><span class=\"line\">- 示例：</span><br><span class=\"line\">分区示例：</span><br><span class=\"line\">CREATE TABLE sales (</span><br><span class=\"line\">    sales_id NUMBER,</span><br><span class=\"line\">    sales_date DATE,</span><br><span class=\"line\">    amount NUMBER</span><br><span class=\"line\">)</span><br><span class=\"line\">PARTITION BY RANGE (sales_date)</span><br><span class=\"line\">(</span><br><span class=\"line\">    PARTITION sales_2019 VALUES LESS THAN (TO_DATE(<span class=\"comment\">&#x27;2020-01-01&#x27;, &#x27;YYYY-MM-DD&#x27;)),</span></span><br><span class=\"line\">    PARTITION sales_2020 VALUES LESS THAN (TO_DATE(<span class=\"comment\">&#x27;2021-01-01&#x27;, &#x27;YYYY-MM-DD&#x27;)),</span></span><br><span class=\"line\">    PARTITION sales_future VALUES LESS THAN (MAXVALUE)</span><br><span class=\"line\">);</span><br><span class=\"line\">分区索引示例：</span><br><span class=\"line\">CREATE INDEX idx_sales_date <span class=\"keyword\">ON</span> sales (sales_date)</span><br><span class=\"line\">LOCAL</span><br><span class=\"line\">(</span><br><span class=\"line\">    PARTITION sales_2019,</span><br><span class=\"line\">    PARTITION sales_2020,</span><br><span class=\"line\">    PARTITION sales_future</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">利用 Oracle 提供的 AWK 和 ASH 性能监控工具：</span><br><span class=\"line\">- awk：</span><br><span class=\"line\">\t#生成 AWR 报告（默认情况下，包含最近一小时的性能数据）</span><br><span class=\"line\">\tSELECT * FROM TABLE(DBMS_WORKLOAD_REPOSITORY.AWR_REPORT_HTML);</span><br><span class=\"line\">\t#生成 AWR 报告（默认情况下，包含最近一小时的性能数据）</span><br><span class=\"line\">\tSELECT * FROM TABLE(DBMS_WORKLOAD_REPOSITORY.AWR_REPORT_HTML);</span><br><span class=\"line\">-ASH</span><br><span class=\"line\">\t#查询当前活动会话信息</span><br><span class=\"line\">\tSELECT * FROM V$ACTIVE_SESSION_HISTORY;</span><br><span class=\"line\">\t#查询指定时间范围内的活动会话信息</span><br><span class=\"line\">\tSELECT * FROM V$ACTIVE_SESSION_HISTORY WHERE SAMPLE_TIME BETWEEN start_time <span class=\"keyword\">AND</span> end_time;</span><br><span class=\"line\">\t#查询特定会话 ID 的活动会话信息</span><br><span class=\"line\">#SELECT * FROM V$ACTIVE_SESSION_HISTORY WHERE SESSION_ID = session_id;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">定期执行数据库统计和优化任务：</span><br><span class=\"line\">- 收集指定表的统计信息</span><br><span class=\"line\">\tEXEC DBMS_STATS.GATHER_TABLE_STATS(<span class=\"comment\">&#x27;schema_name&#x27;, &#x27;table_name&#x27;);</span></span><br><span class=\"line\">- 收集指定索引的统计信息</span><br><span class=\"line\">\tEXEC DBMS_STATS.GATHER_INDEX_STATS(<span class=\"comment\">&#x27;schema_name&#x27;, &#x27;index_name&#x27;);</span></span><br><span class=\"line\">- 查询 SQL Tuning Advisor 的优化建议</span><br><span class=\"line\">\tSELECT dbms_sqltune.report_tuning_task(<span class=\"comment\">&#x27;task_name_here&#x27;) AS recommendations FROM dual;</span></span><br><span class=\"line\"></span><br><span class=\"line\">硬件和操作系统层面的优化：</span><br><span class=\"line\">- 确保数据库服务器具有足够的内存、CPU 和磁盘空间</span><br><span class=\"line\">- 使用 RAID 和 SSD 等高性能存储来提高磁盘 I/O 性能</span><br><span class=\"line\">- 调整操作系统参数，以优化数据库的整体性能</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"备份\"><a href=\"#备份\" class=\"headerlink\" title=\"备份\"></a>备份</h1><figure class=\"highlight basic\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>. 逻辑备份：</span><br><span class=\"line\">适用情况：逻辑备份通过导出数据库对象的逻辑结构来创建备份文件，适用于需要备份和恢复特定表、模式或数据库对象的情况。逻辑备份可以跨平台和跨版本使用。</span><br><span class=\"line\">操作时机：可以在数据库运行时或离线时执行逻辑备份。</span><br><span class=\"line\"><span class=\"number\">2</span>. 物理备份：</span><br><span class=\"line\">适用情况：物理备份是通过备份数据库文件（如数据文件、控制文件和日志文件）来创建备份文件，适用于整个数据库或大部分数据库的备份和恢复。物理备份可以更快速地恢复整个数据库。</span><br><span class=\"line\">操作时机：通常在数据库处于归档模式下时执行物理备份，以确保备份文件包含了所有的数据文件和日志文件。</span><br><span class=\"line\"><span class=\"number\">3</span>. 快照备份：</span><br><span class=\"line\">适用情况：快照备份是通过创建数据库的快照来创建备份文件，适用于需要在数据库处于运行状态下快速恢复到以前状态的情况。</span><br><span class=\"line\">操作时机：可以在数据库运行时创建快照备份。</span><br><span class=\"line\"><span class=\"number\">4</span>. 文件系统备份：</span><br><span class=\"line\">适用情况：文件系统备份是通过备份数据库文件所在的文件系统来创建备份文件，适用于需要完整备份数据库且数据库可以停机的情况。</span><br><span class=\"line\">操作时机：通常在数据库停机时执行文件系统备份。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span>、物理备份：</span><br><span class=\"line\">创建全量备份：RMAN&gt; BACKUP DATABASE;</span><br><span class=\"line\">创建增量备份：RMAN&gt; BACKUP INC<span class=\"comment\">REMENTAL LEVEL 1 DATABASE;</span></span><br><span class=\"line\">导出数据：<span class=\"keyword\">exp</span> username/password@db_name file=export_file.dmp</span><br><span class=\"line\">导入数据：<span class=\"keyword\">imp</span> username/password@db_name file=export_file.dmp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span>、逻辑备份：</span><br><span class=\"line\"><span class=\"number\">1</span>. 使用 <span class=\"keyword\">EXP</span> 和 <span class=\"keyword\">IMP</span> 工具进行逻辑备份和还原：</span><br><span class=\"line\">\t导出数据：<span class=\"keyword\">exp</span> username/password@db_name file=backup_file.dmp</span><br><span class=\"line\">\t导入数据：<span class=\"keyword\">imp</span> username/password@db_name file=export_file.dmp</span><br><span class=\"line\"><span class=\"number\">2</span>. 使用 EXPDP 和 IMPDP 工具进行逻辑备份和还原：</span><br><span class=\"line\">\t导出数据：expdp username/password@db_name dumpfile=export_file.dmp</span><br><span class=\"line\">\t导入数据：impdp username/password@db_name dumpfile=export_file.dmp</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span>、快照备份：</span><br><span class=\"line\">登录存储设备管理界面：</span><br><span class=\"line\">打开浏览器，输入存储设备的管理界面地址，输入用户名和密码登录，选择要备份的存储卷或 LUN</span><br><span class=\"line\">，在存储设备管理界面中，找到要备份的存储卷或 LUN，选择该存储卷或 LUN，并查看相关操作选项</span><br><span class=\"line\">创建快照：</span><br><span class=\"line\">在存储设备管理界面中，找到快照功能或选项，根据提示，在选择的存储卷或 LUN 上创建一个快照，在创建快照时，确保数据库处于一致性状态，可以选择使用数据库的快照功能来确保一致性</span><br><span class=\"line\">备份快照：</span><br><span class=\"line\">在存储设备管理界面中，找到备份或复制功能，选择要备份的快照，并指定备份的目标位置（可以是备份设备、备份服务器等），根据提示完成备份操作。有些存储设备支持将快照直接复制到备份设备上，而有些需要通过网络复制到备份服务器上</span><br><span class=\"line\">恢复备份：</span><br><span class=\"line\">如果需要恢复数据库，可以在存储设备管理界面中找到快照恢复或还原功能，选择要恢复的快照，并指定恢复的目标位置（通常是一个新的存储卷或 LUN），根据提示完成恢复操作</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span>、文件系统备份：</span><br><span class=\"line\">备份控制文件：SQL&gt; ALTER DATABASE BACKUP CONTROLFILE <span class=\"keyword\">TO</span> <span class=\"comment\">&#x27;&lt;目标路径&gt;&#x27;;</span></span><br><span class=\"line\">备份归档日志：SQL&gt; ALTER <span class=\"keyword\">SYSTEM</span> ARCHIVE <span class=\"keyword\">LOG</span> ALL;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"备份恢复\"><a href=\"#备份恢复\" class=\"headerlink\" title=\"备份恢复\"></a>备份恢复</h1><figure class=\"highlight basic\"><table><tr><td class=\"code\"><pre><span class=\"line\">备份恢复</span><br><span class=\"line\">完全恢复：将你的数据库恢复到宕机前最后一次提交状态</span><br><span class=\"line\">不完全恢复：将你的数据库恢复到你指定的某个时间点</span><br><span class=\"line\"></span><br><span class=\"line\">[oracle@localhost ~]$ rman target /</span><br><span class=\"line\"></span><br><span class=\"line\">RMAN&gt; backup database format <span class=\"comment\">&#x27;/opt/oracle/oradata/orcl&#x27;;</span></span><br><span class=\"line\"></span><br><span class=\"line\">#新开一个终端，进入oracle</span><br><span class=\"line\">[oracle@localhost orcl]$ sqlplus / as sysdba</span><br><span class=\"line\"></span><br><span class=\"line\">#查看有那些名称空间</span><br><span class=\"line\">SQL&gt; select tablespace_name from dba_tablespaces;</span><br><span class=\"line\">#查看有哪些文件</span><br><span class=\"line\">QL&gt; select <span class=\"keyword\">name</span> from v$datafile;</span><br><span class=\"line\"></span><br><span class=\"line\">#创建表</span><br><span class=\"line\">SQL&gt; create table bak(id number) tablespace TABLESPACE_NAME;</span><br><span class=\"line\">Table created.</span><br><span class=\"line\">#插入数据</span><br><span class=\"line\">SQL&gt; insert into bak values(<span class=\"number\">1</span>);</span><br><span class=\"line\"><span class=\"symbol\">1 </span>row created.</span><br><span class=\"line\">SQL&gt; insert into bak values(<span class=\"number\">2</span>);</span><br><span class=\"line\"><span class=\"symbol\">1 </span>row created.</span><br><span class=\"line\">SQL&gt; insert into bak values(<span class=\"number\">3</span>);</span><br><span class=\"line\"><span class=\"symbol\">1 </span>row created.</span><br><span class=\"line\">#commit提交</span><br><span class=\"line\">SQL&gt; commit;</span><br><span class=\"line\">#查看</span><br><span class=\"line\">SQL&gt; select * from bak;</span><br><span class=\"line\">        ID</span><br><span class=\"line\">----------</span><br><span class=\"line\">         <span class=\"number\">1</span></span><br><span class=\"line\">         <span class=\"number\">2</span></span><br><span class=\"line\">         <span class=\"number\">3</span></span><br><span class=\"line\">         </span><br><span class=\"line\">#删除的是文件类型，内容不会被删除，（！和host随便用哪个），！和host代表是调用操作系统命令</span><br><span class=\"line\">SQL&gt;!rm -rf /opt/oracle/oradata/orcl/NAMESPACE_NAME.pdf</span><br><span class=\"line\">此时你再root用户下查看目录文件已经被删除了</span><br><span class=\"line\"></span><br><span class=\"line\">#删除物理文件后，继续插入数据，不会报错</span><br><span class=\"line\">SQL&gt; insert into bak values(<span class=\"number\">4</span>);</span><br><span class=\"line\"><span class=\"symbol\">1 </span>row created.</span><br><span class=\"line\">#验证会出错</span><br><span class=\"line\">SQL&gt; startup force;    这时候会报错，如<span class=\"number\">106</span>的编号</span><br><span class=\"line\"></span><br><span class=\"line\">SQL&gt; select * from v$recover_file;   #会报编号为<span class=\"number\">106</span>号的错误</span><br><span class=\"line\">SQL&gt; desc v$datafile_header;</span><br><span class=\"line\">SQL&gt; select file#,CHECKPOINT_CHANGE# from v$datafile_header where con_id=<span class=\"number\">1</span>;   #查看ID是不一样的</span><br><span class=\"line\"></span><br><span class=\"line\">#在root用户下</span><br><span class=\"line\">rman target /       #进入恢复界面</span><br><span class=\"line\"></span><br><span class=\"line\">#数据恢复</span><br><span class=\"line\">RMAN&gt; <span class=\"keyword\">restore</span> datafile <span class=\"number\">106</span>;</span><br><span class=\"line\">RMAN&gt; recover datafile <span class=\"number\">106</span>;   #此时数据已经恢复</span><br><span class=\"line\"></span><br><span class=\"line\">#验证</span><br><span class=\"line\">SQL&gt; select * from v$recover_file;</span><br><span class=\"line\">SQL&gt; select file#,CHECKPOINT_CHANGE# from v$datafile_header where con_id=<span class=\"number\">1</span>;   #此时所有的ID都一样了</span><br><span class=\"line\">SQL&gt; alter database <span class=\"keyword\">open</span>;</span><br><span class=\"line\">注：如果ID不一致，无法打开数据库,<span class=\"keyword\">OPEN</span>后再打开查看ID是一致的</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Oracle"]},{"title":"RabbiMQ集群部署","url":"/2025/11/06/RabbiMQ%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","content":"<h3 id=\"普通集群准备环境\"><a href=\"#普通集群准备环境\" class=\"headerlink\" title=\"普通集群准备环境\"></a>普通集群准备环境</h3><p><strong>注意，这⾥三台服务器都关闭防火墙和selinux</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">192.168.50.138 \trabbitmq-1</span><br><span class=\"line\">192.168.50.139\trabbitmq-2</span><br><span class=\"line\">192.168.50.140\trabbitmq-3</span><br></pre></td></tr></table></figure>\n\n<p>三台机器都操作:</p>\n<h4 id=\"1、配置hosts⽂件\"><a href=\"#1、配置hosts⽂件\" class=\"headerlink\" title=\"1、配置hosts⽂件\"></a>1、配置hosts⽂件</h4><p>更改三台MQ节点的计算机名分别为rabbitmq-1、rabbitmq-2 和rabbitmq-3，然后修改hosts配置⽂件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@rabbitmq-1 ~]# vim /etc/hosts</span><br><span class=\"line\">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class=\"line\">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class=\"line\">192.168.50.138 rabbitmq-1</span><br><span class=\"line\">192.168.50.139 rabbitmq-2</span><br><span class=\"line\">192.168.50.140 rabbitmq-3</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">主机的名字也要改了，不然后面命令匹配不到</span></span><br><span class=\"line\">[root@rabbitmq-1 ~]#\t//磁盘节点</span><br><span class=\"line\">[root@rabbitmq-2 ~]#\t//内存节点</span><br><span class=\"line\">[root@rabbitmq-3 ~]#\t//内存节点</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2、三个节点配置安装rabbitmq软件\"><a href=\"#2、三个节点配置安装rabbitmq软件\" class=\"headerlink\" title=\"2、三个节点配置安装rabbitmq软件\"></a>2、三个节点配置安装rabbitmq软件</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">安装依赖</span><br><span class=\"line\">[root@rabbitmq-1 ~]# yum install -y *epel* gcc-c++ unixODBC unixODBC-devel openssl-devel ncurses-devel</span><br><span class=\"line\">yum安装erlang</span><br><span class=\"line\">[root@rabbitmq-1 ~]# curl -s https://packagecloud.io/install/repositories/rabbitmq/erlang/script.rpm.sh | sudo bash</span><br><span class=\"line\">[root@rabbitmq-1 ~]# yum install erlang-21.3.8.21-1.el7.x86_64</span><br><span class=\"line\">测试；</span><br><span class=\"line\">[root@rabbitmq-1 ~]# erl</span><br><span class=\"line\">Erlang/OTP 20 [erts-9.3] [source] [64-bit] [smp:1:1] [ds:1:1:10] [async-threads:10] [hipe] [kernel-poll:false]</span><br><span class=\"line\"></span><br><span class=\"line\">Eshell V9.3  (abort with ^G)</span><br><span class=\"line\"><span class=\"meta prompt_\">1&gt;</span><span class=\"language-bash\">\t\t//这里按两次ctrl+c</span></span><br><span class=\"line\"></span><br><span class=\"line\">安装rabbitmq</span><br><span class=\"line\">https://github.com/rabbitmq/rabbitmq-server/releases/tag/v3.7.10 ---选择版本</span><br><span class=\"line\">下载下来将其上传到服务器中，三台机器相同操作</span><br><span class=\"line\">https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.10/rabbitmq-server-3.7.10-1.el7.noarch.rpm\t//这个包在电脑笔记里有</span><br><span class=\"line\"></span><br><span class=\"line\">[root@rabbitmq-1 ~]# yum install -y rabbitmq-server-3.7.10-1.el7.noarch.rpm</span><br><span class=\"line\"></span><br><span class=\"line\">`注意：erlang 和 rabbitmq 两个版本配置要一样，不然不兼容`</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">erlang 版本选择</span></span><br><span class=\"line\">https://packagecloud.io/rabbitmq/erlang</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">rabbitmq 和erlang兼容版本</span></span><br><span class=\"line\">https://www.rabbitmq.com/which-erlang.html</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">需要下载的可以在以上两个网站分别下载，但要选好版本，保证要两个软件兼容</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">3.启动方式一：</span><br><span class=\"line\">[root@rabbitmq-1 ~]# systemctl daemon-reload</span><br><span class=\"line\">[root@rabbitmq-1 ~]# systemctl start rabbitmq-server</span><br><span class=\"line\">[root@rabbitmq-1 ~]# systemctl enable rabbitmq-server</span><br><span class=\"line\">启动方式二:</span><br><span class=\"line\">[root@rabbitmq-1 ~]# /sbin/service rabbitmq-server status  ---查看状态</span><br><span class=\"line\">[root@rabbitmq-1 ~]# /sbin/service rabbitmq-server start   ---启动</span><br><span class=\"line\">4、每台都操作开启rabbitmq的web访问界面：</span><br><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3、创建用户\"><a href=\"#3、创建用户\" class=\"headerlink\" title=\"3、创建用户\"></a>3、创建用户</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">注意:在一台机器操作</span><br><span class=\"line\">添加用户和密码</span><br><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmqctl add_user soho soso</span><br><span class=\"line\">Creating user &quot;soho&quot;</span><br><span class=\"line\">...done.</span><br><span class=\"line\">设置为管理员</span><br><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmqctl set_user_tags soho administrator</span><br><span class=\"line\">Setting tags for user &quot;soho&quot; to [administrator] ...</span><br><span class=\"line\">...done.</span><br><span class=\"line\">查看用户</span><br><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmqctl list_users</span><br><span class=\"line\">Listing users ...</span><br><span class=\"line\">guest\t[administrator]</span><br><span class=\"line\">soho\t[administrator]</span><br><span class=\"line\">...done.</span><br><span class=\"line\"></span><br><span class=\"line\">此处设置权限时注意&#x27;.*&#x27;之间需要有空格 三个&#x27;.*&#x27;分别代表了conf权限，read权限与write权限 例如：当没有给</span><br><span class=\"line\">soho设置这三个权限前是没有权限查询队列，在ui界面也看不见</span><br><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmqctl set_permissions -p &quot;/&quot; soho &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br><span class=\"line\">Setting permissions for user &quot;soho&quot; in vhost &quot;/&quot; ...</span><br><span class=\"line\">...done.</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4、所有机器都操作-开启用户远程登录\"><a href=\"#4、所有机器都操作-开启用户远程登录\" class=\"headerlink\" title=\"4、所有机器都操作:开启用户远程登录:\"></a>4、所有机器都操作:开启用户远程登录:</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@rabbitmq-1 ~]# cd /etc/rabbitmq/</span><br><span class=\"line\">[root@rabbitmq-1 rabbitmq]# cp /usr/share/doc/rabbitmq-server-3.7.5/rabbitmq.config.example /etc/rabbitmq/rabbitmq.config</span><br><span class=\"line\">[root@rabbitmq-1 rabbitmq]# ls</span><br><span class=\"line\">enabled_plugins  rabbitmq.config</span><br><span class=\"line\">[root@rabbitmq-1 rabbitmq]# vim rabbitmq.config</span><br><span class=\"line\">修改如下:</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># &#123;loopback_users, []&#125;，--&gt; &#123;loopback_users, []&#125;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">把前面的注释去了，另外把最后的逗号去了，保存重启服务</span></span><br><span class=\"line\"></span><br><span class=\"line\">三台机器都操作重启服务服务:</span><br><span class=\"line\">[root@rabbitmq-1 ~]# systemctl restart rabbitmq-server</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5、查看端口\"><a href=\"#5、查看端口\" class=\"headerlink\" title=\"5、查看端口\"></a>5、查看端口</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">4369 -- erlang端口</span><br><span class=\"line\">5672 --程序连接端口</span><br><span class=\"line\">15672 -- 管理界面ui端口</span><br><span class=\"line\">25672 -- server间内部通信口</span><br></pre></td></tr></table></figure>\n\n<p><strong>！注意如果是云服务器，切记添加安全组端口放行。</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">输入网址访问</span></span><br><span class=\"line\">访问:192.168.50.138:15672\t</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">用户名和密码</span></span><br><span class=\"line\">默认的是：guest\t密码：guest</span><br><span class=\"line\">新添加的用户为:soho 密码:soso</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"开始部署集群三台机器都操作\"><a href=\"#开始部署集群三台机器都操作\" class=\"headerlink\" title=\"开始部署集群三台机器都操作\"></a>开始部署集群三台机器都操作</h3><h4 id=\"1-首先创建好数据存放目录和日志存放目录\"><a href=\"#1-首先创建好数据存放目录和日志存放目录\" class=\"headerlink\" title=\"1.首先创建好数据存放目录和日志存放目录:\"></a>1.首先创建好数据存放目录和日志存放目录:</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@rabbitmq-1 ~]# mkdir -p /data/rabbitmq/data</span><br><span class=\"line\">[root@rabbitmq-1 ~]# mkdir -p /data/rabbitmq/logs</span><br><span class=\"line\">[root@rabbitmq-1 ~]# chmod 777 -R /data/rabbitmq</span><br><span class=\"line\">[root@rabbitmq-1 ~]# chown rabbitmq.rabbitmq /data/ -R</span><br><span class=\"line\">创建配置文件:</span><br><span class=\"line\">[root@rabbitmq-1 ~]# vim /etc/rabbitmq/rabbitmq-env.conf</span><br><span class=\"line\">[root@rabbitmq-1 ~]# cat /etc/rabbitmq/rabbitmq-env.conf</span><br><span class=\"line\">RABBITMQ_MNESIA_BASE=/data/rabbitmq/data</span><br><span class=\"line\">RABBITMQ_LOG_BASE=/data/rabbitmq/logs</span><br><span class=\"line\">重启服务</span><br><span class=\"line\">[root@rabbitmq-1 ~]# systemctl restart rabbitmq-server</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"2-拷⻉-erlang-cookie—-覆盖\"><a href=\"#2-拷⻉-erlang-cookie—-覆盖\" class=\"headerlink\" title=\"2.拷⻉.erlang.cookie—-覆盖\"></a>2.拷⻉.erlang.cookie—-覆盖</h4><p>Rabbitmq的集群是依附于erlang的集群来⼯作的,所以必须先构建起erlang的集群景象。Erlang的集群中</p>\n<p>各节点是经由⼀个cookie来实现的,这个cookie存放在&#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie中，⽂件是400的权限。所以必须保证各节点cookie⼀致,不然节点之间就⽆法通信.</p>\n<p>如果执行# rabbitmqctl stop_app 这条命令报错:需要执行</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">如果执行# rabbitmqctl stop_app 这条命令报错:需要执行</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"built_in\">chmod</span> 400 .erlang.cookie</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"built_in\">chown</span> rabbitmq.rabbitmq .erlang.cookie</span></span><br></pre></td></tr></table></figure>\n\n<p>(官方在介绍集群的文档中提到过.erlang.cookie 一般会存在这两个地址：第一个是home&#x2F;.erlang.cookie；第二个地方就是&#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie。如果我们使用解压缩方式安装部署的rabbitmq，那么这个文件会在{home}目录下，也就是$home&#x2F;.erlang.cookie。如果我们使用rpm等安装包方式进行安装的，那么这个文件会在&#x2F;var&#x2F;lib&#x2F;rabbitmq目录下。)</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">覆盖副节点的cookie</span></span><br><span class=\"line\">[root@rabbitmq-1 ~]# cat /var/lib/rabbitmq/.erlang.cookie</span><br><span class=\"line\">HOUCUGJDZYTFZDSWXTHJ</span><br><span class=\"line\">⽤scp的⽅式将rabbitmq-1节点的.erlang.cookie的值复制到其他两个节点中。</span><br><span class=\"line\">[root@rabbitmq-1 ~]# scp /var/lib/rabbitmq/.erlang.cookie root@192.168.50.139:/var/lib/rabbitmq/</span><br><span class=\"line\">[root@rabbitmq-1 ~]# scp /var/lib/rabbitmq/.erlang.cookie root@192.168.50.140:/var/lib/rabbitmq/</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3-将mq-2、mq-3作为内存节点加⼊mq-1节点集群中\"><a href=\"#3-将mq-2、mq-3作为内存节点加⼊mq-1节点集群中\" class=\"headerlink\" title=\"3.将mq-2、mq-3作为内存节点加⼊mq-1节点集群中\"></a>3.将mq-2、mq-3作为内存节点加⼊mq-1节点集群中</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">停止stop_app会报错,在则之前查看下进程，杀死进程，重新启动服务</span></span><br><span class=\"line\">ps -ef |grep rabbitmq\t//查看进程号</span><br><span class=\"line\">kill -9 [进程名]</span><br><span class=\"line\">systemctl start rabbitmq-server</span><br><span class=\"line\"></span><br><span class=\"line\">在mq-2、mq-3执⾏如下命令：</span><br><span class=\"line\">[root@rabbitmq-2 ~]# rabbitmqctl stop_app  #停止节点，切记不是停止服务---需要杀进程重新启动</span><br><span class=\"line\">[root@rabbitmq-2 ~]# rabbitmqctl reset   #如果有数据需要重置，没有则不用</span><br><span class=\"line\">[root@rabbitmq-2 ~]# rabbitmqctl join_cluster --ram rabbit@rabbitmq-1  #添加到磁盘节点</span><br><span class=\"line\">Clustering node &#x27;rabbit@rabbitmq-2&#x27; with &#x27;rabbit@rabbitmq-1&#x27; ...</span><br><span class=\"line\">[root@rabbitmq-2 ~]# rabbitmqctl start_app  #启动节点</span><br><span class=\"line\">Starting node &#x27;rabbit@rabbitmq-2&#x27; ...</span><br><span class=\"line\">======================================================================</span><br><span class=\"line\">[root@rabbitmq-3 ~]# rabbitmqctl stop_app</span><br><span class=\"line\">Stopping node &#x27;rabbit@rabbitmq-3&#x27; ...</span><br><span class=\"line\">[root@rabbitmq-3 ~]# rabbitmqctl reset</span><br><span class=\"line\">Resetting node &#x27;rabbit@rabbitmq-3&#x27; ...</span><br><span class=\"line\">[root@rabbitmq-3 ~]# rabbitmqctl join_cluster --ram rabbit@rabbitmq-1</span><br><span class=\"line\">Clustering node &#x27;rabbit@rabbitmq-3&#x27; with &#x27;rabbit@rabbitmq-1&#x27; ...</span><br><span class=\"line\">[root@rabbitmq-3 ~]# rabbitmqctl start_app</span><br><span class=\"line\">Starting node &#x27;rabbit@rabbitmq-3&#x27; ...</span><br><span class=\"line\"></span><br><span class=\"line\">（1）默认rabbitmq启动后是磁盘节点，在这个cluster命令下，mq-2和mq-3是内存节点，</span><br><span class=\"line\">mq-1是磁盘节点。</span><br><span class=\"line\">（2）如果要使mq-2、mq-3都是磁盘节点，去掉--ram参数即可。</span><br><span class=\"line\">（3）如果想要更改节点类型，可以使⽤命令rabbitmqctl change_cluster_node_type</span><br><span class=\"line\">disc(ram),前提是必须停掉rabbit应⽤</span><br><span class=\"line\">注:</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">如果有需要使用磁盘节点加入集群</span></span><br><span class=\"line\"> [root@rabbitmq-2 ~]# rabbitmqctl join_cluster  rabbit@rabbitmq-1</span><br><span class=\"line\"> [root@rabbitmq-3 ~]# rabbitmqctl join_cluster  rabbit@rabbitmq-1</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"4、查看集群状态\"><a href=\"#4、查看集群状态\" class=\"headerlink\" title=\"4、查看集群状态\"></a>4、查看集群状态</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">在 RabbitMQ 集群任意节点上执行 rabbitmqctl cluster_status来查看是否集群配置成功。</span><br><span class=\"line\">在mq-1磁盘节点上面查看</span><br><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmqctl cluster_status</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"5-登录rabbitmq-web管理控制台，创建新的队列\"><a href=\"#5-登录rabbitmq-web管理控制台，创建新的队列\" class=\"headerlink\" title=\"5.登录rabbitmq web管理控制台，创建新的队列\"></a>5.登录rabbitmq web管理控制台，创建新的队列</h4><p>打开浏览器输⼊<a href=\"http://192.168.50.138:15672/\">http://192.168.50.138:15672</a>, 输⼊默认的Username：guest，输⼊默认的</p>\n<p>Password:guest </p>\n<h3 id=\"RabbitMQ镜像集群配置\"><a href=\"#RabbitMQ镜像集群配置\" class=\"headerlink\" title=\"RabbitMQ镜像集群配置\"></a>RabbitMQ镜像集群配置</h3><p><strong>创建镜像集群</strong></p>\n<p>rabbitmq set_policy ：设置策略</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmqctl set_policy  ha-all &quot;^&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span><br><span class=\"line\">Setting policy &quot;ha-all&quot; for pattern &quot;^&quot; to &quot;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&quot; with priority &quot;0&quot; for vhost &quot;/&quot; ...</span><br><span class=\"line\"></span><br><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmqctl set_policy  ha-all(策略名) &quot;^(队列名)&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span><br><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmqctl set_policy  ha-all-1(策略名) &quot;^(队列名)&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span><br><span class=\"line\">[root@rabbitmq-1 ~]# rabbitmqctl set_policy -p xu ha-all-1(策略名) &quot;^(队列名)&quot; &#x27;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">set_policy\t指定策略</span><br><span class=\"line\">-p 指定虚拟主机名</span><br><span class=\"line\">ha-all\t策略名</span><br><span class=\"line\">^\t队列名</span><br></pre></td></tr></table></figure>\n\n<p><strong>“^”匹配所有的队列，策略名称为ha-all, ‘{“ha-mode”:”all”}’ 策略模式为 all 即复制到所有节点，包含新增节点。</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">设置策略介绍:</span><br><span class=\"line\">rabbitmqctl set_policy [-p Vhost] Name Pattern Definition</span><br><span class=\"line\">-p Vhost： 可选参数，针对指定vhost下的queue进行设置</span><br><span class=\"line\">Name: policy的名称，可以定义</span><br><span class=\"line\">Pattern: queue的匹配模式(正则表达式),也就是说会匹配一组。</span><br><span class=\"line\">Definition：镜像定义，包括ha-mode,ha-params,ha-sync-mode</span><br><span class=\"line\">    ha-mode:指明镜像队列的模式</span><br><span class=\"line\">        all：表示在集群中所有的节点上进行镜像</span><br><span class=\"line\">        exactly：表示在指定个数的节点上进行镜像，节点的个数由ha-params指定</span><br><span class=\"line\">    ha-sync-mode：进行队列中消息的同步方式，有效值为automatic和manual</span><br><span class=\"line\">    ha-params：ha-mode模式需要用到的参数</span><br><span class=\"line\">案例:</span><br><span class=\"line\">例如，对队列名称以hello开头的所有队列进行镜像，并在集群的两个节点上完成镜像，policy的设置命令为： </span><br><span class=\"line\">rabbitmqctl set_policy hello-ha “^hello” ‘&#123;“ha-mode”:”exactly”,”ha-params”:2,”ha-sync-mode”:”automatic”&#125;’</span><br></pre></td></tr></table></figure>\n\n<p>则此时镜像队列设置成功。已经部署完成</p>\n","categories":["operations"],"tags":["Linux","RabbiMQ"]},{"title":"RocketMQ消息队列","url":"/2025/11/05/RocketMQ%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/","content":"<h3 id=\"RocketMQ–集群\"><a href=\"#RocketMQ–集群\" class=\"headerlink\" title=\"RocketMQ–集群\"></a>RocketMQ–集群</h3><h4 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h4><p>Apache RocketMQ 是一个分布式消息中间件，主要用于消息的发布与订阅（Pub&#x2F;Sub）和消息队列（Message Queue）模式。它在高性能、高可靠性和高可扩展性方面有着显著的优势。以下是 RocketMQ 的主要作用和应用场景：</p>\n<ol>\n<li><strong>消息发布与订阅（Pub&#x2F;Sub）</strong>：<ul>\n<li>RocketMQ 支持发布&#x2F;订阅模式，允许消息生产者将消息发布到一个主题（Topic），然后多个消费者可以订阅这个主题以接收消息。这种模式适用于广播消息和事件通知。</li>\n</ul>\n</li>\n<li><strong>消息队列（Message Queue）</strong>：<ul>\n<li>在消息队列模式下，消息生产者将消息发送到队列，消费者从队列中读取并处理消息。消息队列模式适用于任务分发和负载均衡。</li>\n</ul>\n</li>\n<li><strong>异步通信</strong>：<ul>\n<li>RocketMQ 支持异步消息传递，允许系统组件之间进行松耦合的通信，从而提高系统的响应速度和处理能力。</li>\n</ul>\n</li>\n<li><strong>削峰填谷</strong>：<ul>\n<li>在高并发场景下，RocketMQ 可以通过消息队列的缓冲作用来平滑流量，防止系统在短时间内被大量请求压垮。</li>\n</ul>\n</li>\n<li><strong>事件驱动架构</strong>：<ul>\n<li>RocketMQ 支持事件驱动架构，系统可以通过事件通知机制来触发后续操作，实现松耦合的系统设计。</li>\n</ul>\n</li>\n<li><strong>数据同步</strong>：<ul>\n<li>RocketMQ 可以用于分布式系统中的数据同步，确保不同系统或组件之间的数据一致性。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"资源需求\"><a href=\"#资源需求\" class=\"headerlink\" title=\"资源需求\"></a>资源需求</h4><ul>\n<li><strong>CPU</strong>: 4 核 </li>\n<li><strong>内存</strong>:  8 GB </li>\n<li><strong>存储</strong>: 100G</li>\n<li><strong>节点</strong>：2</li>\n</ul>\n<h4 id=\"网络端口\"><a href=\"#网络端口\" class=\"headerlink\" title=\"网络端口\"></a>网络端口</h4><ol>\n<li><strong>Nameserver 端口</strong>：<ul>\n<li>默认端口：9876</li>\n<li>用于 Nameserver 服务，负责管理和发现 Broker。</li>\n</ul>\n</li>\n<li><strong>Broker 端口</strong>：<ul>\n<li>默认端口：10911</li>\n<li>用于 Broker 服务，负责消息存储和转发。</li>\n</ul>\n</li>\n<li><strong>Broker HA 端口</strong>：<ul>\n<li>默认端口：10912</li>\n<li>用于 Broker 高可用（HA）复制。</li>\n</ul>\n</li>\n<li><strong>Console 端口</strong>（可选）：<ul>\n<li>默认端口：8080</li>\n<li>用于 RocketMQ 控制台管理界面。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h4><pre><code class=\"服务器\">10.1.15.106\n10.1.11.103\n10.1.11.104\n\n3台机器都操作\n#下载安装包\nwget https://archive.apache.org/dist/rocketmq/4.8.0/rocketmq-all-4.8.0-bin-release.zip\njdk 1.8\n\n\nmkdir -p /data/rocketmq\nchmod -R 755 /data/rocketmq\n\n#添加环境变量\nJAVA_HOME=/usr/local/java\nJRE_HOME=/usr/local/java/jre\nexport CLASSPATH=.:\\$JAVA_HOME/jre/lib:\\$JAVA_HOME/lib:\\$JAVA_HOME/lib/tools.jar\nROCKETMQ_HOME=/data/rocketmq/rocketmq-4.8\nPATH=$PATH:$JAVA_HOME/bin:$JRE_HOME/bin:$ROCKETMQ_HOME/bin\nexport JAVA_HOME JRE_HOME CLASS_PATH PATH ROCKETMQ_HOME\n\n\n#环境生效\nsource /etc/porfile\n\ncd /data/rocketmq\n#解压\nupzip rocketmq-all-4.8.0-bin-release.zip\n#修改文件夹\nmv rocketmq-all-4.8.0-bin-release rocketmq-4.8\n#创建日志目录\nmkdir logs\n\n10.1.15.106--nameserver\n#编写脚本\n[root@minio rocketmq]# cat start.sh\n#!/bin/bash\n\nJAVA_HOME=/usr/local/java\nROCKETMQ_HOME=/data/rocketmq/rocketmq-4.8\nJAVA_OPT=&quot;-server -Xms4g -Xmx4g -Xmn2g -XX:+UseConcMarkSweepGC&quot;\n\n# 将 lib 目录中的所有 JAR 文件添加到 CLASSPATH 中\nCLASSPATH=$(find $&#123;ROCKETMQ_HOME&#125;/lib -name &#39;*.jar&#39; | tr &#39;\\n&#39; &#39;:&#39;)\n\nJAVA_OPT=&quot;$&#123;JAVA_OPT&#125; -classpath $&#123;CLASSPATH&#125;&quot;\njava $&#123;JAVA_OPT&#125; org.apache.rocketmq.namesrv.NamesrvStartup -n 10.1.15.106:9876\n\n\n#启动脚本\nchmod +x start.sh\nnohup ./start.sh &amp;\n\n\n\n10.1.11.103\n部署broker\n机器A配置\n#创建文件夹store,store-s（store-a：master数据存储文件夹，store-b-s:salve数据存储文件夹）\nmkdir /data/rocket/rocketmq-4.8/store-a\n\n#机器A上修改master的broker-a.properties配置文件\ncd /data/rocket/rocketmq-5.2/conf/2m-2s-async\n\nvim broker-a.properties\n配置内容如下面：\n# 集群名称,这里要master和slave保持一样\nbrokerClusterName=cjsCluster\n# broker名字\nbrokerName=broker-a\n#0 表示 Master，&gt;0 表示 Slave\nbrokerId=0\n#删除文件时间点，默认凌晨 4点\ndeleteWhen=04\n#文件保留时间，默认48小时，这里设置5天\nfileReservedTime=120\n#Broker 的角色 - ASYNC_MASTER 异步复制Master\nbrokerRole=ASYNC_MASTER\n#刷盘方式 - ASYNC_FLUSH 异步刷盘\nflushDiskType=ASYNC_FLUSH\n#开启账号密码连接，需要配置plain_acl.yml文件里面的账号密码用于连接\naclEnable=false\n \n# Broker 对外服务的监听端口\nlistenPort=10911\n# nameserver地址，分号分割\nnamesrvAddr=10.1.15.106:9876\n#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数\ndefaultTopicQueueNums=4\n#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭\nautoCreateTopicEnable=true\n#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭\nautoCreateSubscriptionGroup=true\n#本机IP\nbrokerIP1=10.1.11.103\nstorePathRootDir=/data/rocketmq/rocketmq-4.8/store-a\nstorePathCommitLog=/data/rocketmq/rocketmq-4.8/store-a/commitlog\n#消费队列存储路径存储路径\nstorePathConsumerQueue=/data/rocketmq/rocketmq-4.8/store-a/consumequeue\n#消息索引存储路径\nstorePathIndex=/data/rocketmq/rocketmq-4.8/store-a/index\n#checkpoint 文件存储路径\nstoreCheckpoint=/data/rocketmq/rocketmq-4.8/store-a/checkpoint\n#abort文件存储路径\nabortFile=/data/rocketmq/rocketmq-4.8/store-a/abort\n# commitLog每个文件的大小默认1G\nmapedFileSizeCommitLog=1073741824\n#ConsumeQueue每个文件默认存30W条，根据业务情况调整\nmapedFileSizeConsumeQueue=300000\n\n\n\n10.1.11.104\n机器B上修改slave的broker-a-slave.properties配置文件\nmkdir -p /data/rocketmq/rocketmq-4.8/store-a-s\n\ncd /data/rocket/rocketmq-4.8/conf/2m-2s-async\nvim broker-a-s.properties\n配置内容如下：\n# 集群名称\nbrokerClusterName=cjsCluster\n# broker名字\nbrokerName=broker-a\n#0 表示 Master，&gt;0 表示 Slave\nbrokerId=1\n#删除文件时间点，默认凌晨 4点\ndeleteWhen=04\n#文件保留时间，默认 48 小时，这里设置5天\nfileReservedTime=120\nbrokerRole=SLAVE\nflushDiskType=ASYNC_FLUSH\n#开启账号密码连接\naclEnable=false\n \n# Broker 对外服务的监听端口\nlistenPort=10922\n# nameserver地址，分号分割\nnamesrvAddr=10.1.15.106:9876\n#在发送消息时，自动创建服务器不存在的topic，默认创建的队列数\ndefaultTopicQueueNums=4\n#是否允许 Broker 自动创建Topic，建议线下开启，线上关闭\nautoCreateTopicEnable=true\n#是否允许 Broker 自动创建订阅组，建议线下开启，线上关闭\nautoCreateSubscriptionGroup=true\n#master的IP\nmasterAddress=10.1.11.103\nstorePathRootDir=/data/rocketmq/rocketmq-4.8/store-a-s\nstorePathCommitLog=/data/rocketmq/rocketmq-4.8/store-a-s/commitlog\n#消费队列存储路径存储路径\nstorePathConsumerQueue=/data/rocketmq/rocketmq-4.8/store-a-s/consumequeue\n#消息索引存储路径\nstorePathIndex=/data/rocketmq/rocketmq-4.8/store-a-s/index\n#checkpoint 文件存储路径\nstoreCheckpoint=/data/rocketmq/rocketmq-4.8/store-a-s/checkpoint\n#abort文件存储路径\nabortFile=/data/rocketmq/rocketmq-4.8/store-a-s/abort\n# commitLog每个文件的大小默认1G\nmapedFileSizeCommitLog=1073741824\n#ConsumeQueue每个文件默认存30W条，根据业务情况调整\nmapedFileSizeConsumeQueue=300000\n\n\n\n#机器A上编写启动文件  \n[root@rocketmq01 rocketmq]# cat mqbrokerStart-a.sh\n#!/bin/sh\n\ncd /data/rocketmq/rocketmq-4.8/bin\n\nnohup sh mqbroker -c /data/rocketmq/rocketmq-4.8/conf/2m-2s-async/broker-a.properties &gt; /data/rocketmq/logs/broker-a.log 2&gt;&amp;1 &amp;\n\n\n\n\n#slave启动文件mqbrokerStart-a-s.sh内容如下编写\nvim mqbrokerStart-a-s.sh\n#!/bin/sh\n \ncd /data/rocketmq/rocketmq-4.8/bin\n \nnohup sh mqbroker -c /data/rocketmq/rocketmq-4.8/conf/2m-2s-async/broker-a-s.properties &gt; /data/rocketmq/logs/broker-a-s.log 2&gt;&amp;1 &amp;\n \nexit\n\n\n#给与权限\nchmod +x mqbrokerStart-a.sh\nchmod +x mqbrokerStart-a-s.sh\n\n\n启动broker--按顺序启动\n机器A上启动master：broker-a\ncd /data/rocketmq\n./mqbrokerStart-a.sh\n\n\n机器B上启动slave：broker-a-s\ncd /data/rocketmq\n./mqbrokerStart-a-s.sh\n\n\n#验证机器信息\ncd /data/rocketmq/rocketmq-4.8/bin/\n./mqadmin clusterList -n 10.1.15.106:9876\n</code></pre>\n","categories":["operations"],"tags":["Linux","RockerMQ"]},{"title":"TDEngine时序数据库部署","url":"/2025/11/06/TDEngine%E6%97%B6%E5%BA%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E9%83%A8%E7%BD%B2/","content":"<h3 id=\"TDEngine–集群\"><a href=\"#TDEngine–集群\" class=\"headerlink\" title=\"TDEngine–集群\"></a>TDEngine–集群</h3><h4 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h4><p>TDEngine 是一种高性能、分布式、时间序列数据库（TSDB），专门为物联网（IoT）、工业互联网、车联网、金融、IT 运维监控等领域设计。它具有高效的数据写入和查询性能，适合处理大规模的时间序列数据。以下是 TDEngine 的主要作用和用途：</p>\n<ol>\n<li><p><strong>物联网（IoT）数据存储和分析</strong>:</p>\n<ul>\n<li>TDEngine 能够高效地存储和处理来自各种 IoT 设备和传感器的大量时间序列数据，支持实时数据写入和复杂查询。</li>\n</ul>\n</li>\n<li><p><strong>工业互联网</strong>:</p>\n<ul>\n<li>在工业互联网应用中，TDEngine 可以用于存储和分析工业设备的运行数据、传感器数据、生产线数据等，帮助进行设备监控、预测性维护和优化生产流程。</li>\n</ul>\n</li>\n<li><p><strong>车联网</strong>:</p>\n<ul>\n<li>TDEngine 能够存储和处理车辆的运行数据、位置数据、传感器数据等，支持实时数据分析和查询，适用于车联网应用中的数据管理和分析。</li>\n</ul>\n</li>\n<li><p><strong>金融数据分析</strong>:</p>\n<ul>\n<li>在金融领域，TDEngine 可以用于存储和分析股票、期货、外汇等金融市场的时间序列数据，支持高频交易数据的存储和实时查询分析。</li>\n</ul>\n</li>\n<li><p><strong>IT 运维监控</strong>:</p>\n<ul>\n<li>TDEngine 适用于 IT 运维监控场景，可以存储和分析服务器性能数据、应用程序日志、网络流量数据等，帮助运维人员进行系统监控和故障排除。</li>\n</ul>\n</li>\n<li><p><strong>高效的数据写入和查询</strong>:</p>\n<ul>\n<li>TDEngine 具有高效的数据写入和查询性能，能够处理每秒数百万条数据的写入和查询操作，适合大规模时间序列数据的存储和分析。</li>\n</ul>\n</li>\n<li><p><strong>分布式架构</strong>:</p>\n<ul>\n<li>TDEngine 采用分布式架构，支持数据的水平扩展和高可用性，能够处理海量数据并保证系统的稳定性和可靠性。</li>\n</ul>\n</li>\n<li><p><strong>内置计算能力</strong>:</p>\n<ul>\n<li>TDEngine 提供了丰富的内置计算能力，包括聚合计算、统计分析、数据过滤等，支持复杂的查询和数据分析操作。</li>\n</ul>\n</li>\n<li><p><strong>低存储成本</strong>:</p>\n<ul>\n<li>TDEngine 采用高效的数据压缩算法，能够显著降低存储成本，同时保证数据的高效查询和分析。</li>\n</ul>\n</li>\n<li><p><strong>支持多种数据接口</strong>:</p>\n<ul>\n<li>TDEngine 支持多种数据接口和协议，包括 SQL、RESTful API、MQTT 等，方便与各种应用和系统进行集成。</li>\n</ul>\n</li>\n<li><p><strong>实时流处理</strong>:</p>\n<ul>\n<li>TDEngine 支持实时流处理，可以对流数据进行实时计算和分析，适用于需要实时数据处理的应用场景。</li>\n</ul>\n</li>\n</ol>\n<p>综上所述，TDEngine 是一种专门为时间序列数据设计的高性能数据库，适合处理大规模、高频率的时间序列数据，广泛应用于物联网、工业互联网、车联网、金融、IT 运维监控等领域。</p>\n<h4 id=\"资源需求\"><a href=\"#资源需求\" class=\"headerlink\" title=\"资源需求\"></a>资源需求</h4><ul>\n<li><strong>CPU</strong>: 4 核 </li>\n<li><strong>内存</strong>:  8 GB </li>\n<li><strong>存储</strong>: 1T</li>\n<li><strong>节点</strong>：2</li>\n</ul>\n<h4 id=\"网络端口\"><a href=\"#网络端口\" class=\"headerlink\" title=\"网络端口\"></a>网络端口</h4><ul>\n<li><p><strong>客户端连接端口</strong></p>\n<ul>\n<li><p><strong>默认端口</strong>: 6030</p>\n</li>\n<li><p><strong>用途</strong>: 客户端（如应用程序、用户）通过该端口连接到 TDEngine 进行数据查询和写入操作。</p>\n</li>\n</ul>\n</li>\n<li><p><strong>管理端口</strong></p>\n<ul>\n<li><strong>默认端口</strong>: 6041</li>\n<li><strong>用途</strong>: 用于 TDEngine 管理工具（如 taos）连接到服务器进行管理操作。</li>\n</ul>\n</li>\n<li><p><strong>数据传输端口</strong></p>\n<ul>\n<li><strong>默认端口</strong>: 6042</li>\n<li><strong>用途</strong>: 用于集群内部节点之间的数据传输和同步。</li>\n</ul>\n</li>\n<li><p><strong>RESTful API 端口</strong></p>\n<ul>\n<li><strong>默认端口</strong>: 6043</li>\n<li><strong>用途</strong>: 提供 RESTful API 服务，允许通过 HTTP 协议进行数据操作。</li>\n</ul>\n</li>\n<li><p><strong>MQTT 端口</strong></p>\n<ul>\n<li><strong>默认端口</strong>: 6044</li>\n<li><strong>用途</strong>: 支持 MQTT 协议，用于物联网设备的数据接入。</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h4><pre><code>#下载地址\nhttps://docs.taosdata.com/get-started/package/#!\n从列表中下载获得 tar.gz 安装包；\nTDengine-server-3.1.1.0-Linux-x64.tar.gz (126.7 M)      # Linux客户端下载\n# 创建目录\nmkdir -p /data/tasosi\n# 解压到指定目录\ntar xzf TDengine-server-3.1.1.0-Linux-x64.tar.gz -C /data/tasosi/\n# 切换目录\ncd /data/tasosi/TDengine-server-3.1.1.0/\n# 启动\n./install.sh -e no\n# install.sh 安装脚本在执行过程中，会通过命令行交互界面询问一些配置信息。如果希望采取无交互安装方式，那么可以运行 ./install.sh -e no。运行 ./install.sh -h 指令可以查看所有参数的详细说明信息。\n# 安装是交互式操作\n1、提供机器的 IP 地址：#填写本机的IP\n2、当安装第一个节点时，出现 Enter FQDN: 提示的时候，不需要输入任何内容。只有当安装第二个或以后更多的节点时，才需要输入已有集群中任何一个可用节点的 FQDN，支持该新节点加入集群。当然也可以不输入，而是在新节点启动前，配置到新节点的配置文件中：#直接回车\n3、选择是否输入电子邮件地址，选择跳过： #直接回车\n\n# 先不要启动--添加好集群再启动-单节点直接启动\nvim  /etc/taos/taos.cfg    # 此文件下可以修改端口，增加节点，修改数据、日记的存储目录\n# firstEp     hostname:6030  改为  firstEp       10.100.40.171:6030\nfqdn          10.100.40.171  改为  写本机的IP地址\nlogDir                    /data/tasosi/log\ndataDir                   /data/tasosi/data\n\n#创建目录并赋予权限\nmkdir -p /data/tasosi/data\nmkdir -p /data/tasosi/log\nchown -R taos:taos /data/tasosi/data\nchown -R taos:taos /data/tasosi/log\nchmod -R 755 /data/tasosi/*\n# 复制原有数据--如果是有数据的前提下\n# cp -r /var/lib/taos /data/tasosi/data\n# 所有集群的配置文件都改好后-从节点一按顺序启动\nsystemctl start taosd\n# 所有的启动后在（主节点）上添加集群\ntaos\nshow dnodes;\ncreate dnode &quot;10.100.40.172&quot;;  #若有多个添加多次IP，从节点的IP \n# 验证\nshow dnodes;   # 此时就可以看到多台集群信息了\n\n# 删除节点\nDROP DNODE &quot;fqdn:port&quot;;\n或\nDROP DNODE dnodeId;\n\n扩展：\n# 启动命令分为\nsystemctl start taosd\nsystemctl start taosadapter\nsystemctl start taoskeeper\nsystemctl start taos-explorer\n\nsystemctl stop taosd\nsystemctl restart taosd\nsystemctl status taosd\n如果系统中不支持 systemd，也可以用手动运行 /usr/local/taos/bin/taosd 方式启动 TDengine 服务\n# 进入命令\ntaos\n# 在 TDengine CLI 中，用户可以通过 SQL 命令来创建/删除数据库、表等，并进行数据库（Database）插入查询操作。在终端中运行的 SQL 语句需要以分号（;）结束来运行。示例：\nCREATE DATABASE demo;\nUSE demo;\nCREATE TABLE t (ts TIMESTAMP, speed INT);\nINSERT INTO t VALUES (&#39;2019-07-15 00:00:00&#39;, 10);\nINSERT INTO t VALUES (&#39;2019-07-15 01:00:00&#39;, 20);\nSELECT * FROM t;\n           ts            |    speed    |\n========================================\n 2019-07-15 00:00:00.000 |          10 |\n 2019-07-15 01:00:00.000 |          20 |\nQuery OK, 2 row(s) in set (0.003128s)\n# 修改端口号\nvim /etc/taos/taos.cfg\n# 此文件下可以修改端口，增加节点，修改数据、日记的存储目录\n</code></pre>\n","categories":["operations"],"tags":["Linux","TDengine"]},{"title":"Redis 部署单机-主从-哨兵模式","url":"/2025/11/06/Redis-%E9%83%A8%E7%BD%B2%E5%8D%95%E6%9C%BA-%E4%B8%BB%E4%BB%8E-%E5%93%A8%E5%85%B5/","content":"<p><strong>Redis</strong></p>\n<p><strong>1、安装单机版redis</strong></p>\n<p><strong>官网下载redis</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">https://redis.io/</span><br></pre></td></tr></table></figure>\n\n<p><strong>点击download，往下拉，找到以下内容</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">List of all releases and hash digests</span><br><span class=\"line\">You can find a listing of all previous Redis releases on the releases page. SHA-256 digests for these downloads are available in the redis-hashes git repository.</span><br><span class=\"line\"></span><br><span class=\"line\"> listing of all previous Redis releases --&gt; 点击此内容--&gt;进入选取想要的版本（学习实验用的7.0.9版本）</span><br></pre></td></tr></table></figure>\n\n<p><strong>下载</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# wget https://download.redis.io/releases/redis-7.0.9.tar.gz\t\t//7.0.9版本的</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">指定解压路径</span></span><br><span class=\"line\">[root@localhost ~]# tar zxvf redis-7.0.9.tar.gz -C /usr/loval</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">cd</span>到/usr/loval/redis，改名</span></span><br><span class=\"line\">[root@localhost redis]# mv redis-7.0.9 redis</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">下载编译工具</span></span><br><span class=\"line\">[root@localhost redis]# yum -y install gcc make</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编译</span></span><br><span class=\"line\">[root@localhost redis]# make</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">注：如果报错请将刚才解压的安装包删除掉，再次重新解压并进行make安装即可</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">编辑配置文件，vim redis.conf</span></span><br><span class=\"line\">[root@localhost redis]# vim redis.conf</span><br><span class=\"line\">bind 192.168.246.202　　#只监听内网IP</span><br><span class=\"line\">daemonize yes　　　　　#开启后台模式将no改为yes</span><br><span class=\"line\">port 6379                      #端口号</span><br><span class=\"line\">dir /usr/local/redis/data　　#本地数据库存放持久化数据的目录该目录-----需要存在</span><br><span class=\"line\">protected-mode yes \t//开启密码，默认是yes，可以改no</span><br><span class=\"line\">requirepass 1122334 #设置密码</span><br><span class=\"line\">logfile &quot;/var/log/redis.log&quot;  #设置日志存放路径与日志名</span><br><span class=\"line\">创建存放数据的目录</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">创建持久化目录</span></span><br><span class=\"line\">[root@localhost redis]# mkdir data</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动redis</span></span><br><span class=\"line\">[root@localhost redis]# src/redis-server redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看端口</span></span><br><span class=\"line\">[root@localhost redis]# netstat -lnpt</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">登入redis</span></span><br><span class=\"line\">[root@localhost redis]# src/redis-cli -h 192.168.116.111 -p 6379</span><br><span class=\"line\">192.168.116.111:6379&gt; ping\t\t// ---测试redis是否可以用</span><br><span class=\"line\">PONG</span><br><span class=\"line\">192.168.116.111:6379&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># 单机版redsi已经部署完成。将ip和端口发给开发就可以了。</span></span></span><br></pre></td></tr></table></figure>\n\n<p><strong>2、数据持久化</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">关闭redis</span></span><br><span class=\"line\">[root@localhost redis]# pkill redis</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看端口</span></span><br><span class=\"line\">[root@localhost redis]# netstat -lnpt</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动</span></span><br><span class=\"line\">[root@localhost redis]# src/redis-server redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">登入</span></span><br><span class=\"line\">[root@localhost redis]# src/redis-cli -h 192.168.116.111 -p 6379</span><br><span class=\"line\">192.168.116.111:6379&gt; keys *</span><br><span class=\"line\">(empty array)</span><br><span class=\"line\">192.168.116.111:6379&gt; set name qingfeng</span><br><span class=\"line\">OK</span><br><span class=\"line\">192.168.116.111:6379&gt; set age 18</span><br><span class=\"line\">OK</span><br><span class=\"line\">192.168.116.111:6379&gt; keys *\t//查看所有</span><br><span class=\"line\">1) &quot;age&quot;</span><br><span class=\"line\">2) &quot;name&quot;</span><br><span class=\"line\">192.168.116.111:6379&gt; bgsave\t//数据持久化命令</span><br><span class=\"line\">Background saving started</span><br><span class=\"line\">192.168.116.111:6379&gt; exit</span><br><span class=\"line\">[root@localhost redis]# cd data</span><br><span class=\"line\">[root@localhost data]# ls\t\t//在data目录下会生成一个数据文件</span><br><span class=\"line\">dump.rdb</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">此时在另一台机器上下载号redis，把数据复制到另一台机器上</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">注意 redis下载好先不要启动，把数据复制过来在启动</span></span><br><span class=\"line\">scp dump.rdb 192.168.116.131:/usr/local/redis/data</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">此时启动，数据持久化完成了</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>3、主从配置</strong></p>\n<blockquote>\n<p>配置主从配置要保证所有机器的数据一样</p>\n<h5 id=\"设置主机名\"><a href=\"#设置主机名\" class=\"headerlink\" title=\"设置主机名\"></a>设置主机名</h5><p>redis-master—-192.168.116.111<br>redis-slave-1—–192.168.116.131<br>redis-slave-2—–192.168.116.132</p>\n</blockquote>\n<p><strong>设置配置文件</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">master</span><br><span class=\"line\">[root@redis-master ~]# cd /usr/local/redis/</span><br><span class=\"line\">[root@redis-master redis]# vim redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"built_in\">bind</span> 192.168.116.111注释了</span></span><br><span class=\"line\">bind 0.0.0.0</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">关闭，并重启服务</span></span><br><span class=\"line\">[root@redis-master redis]# pkill redis</span><br><span class=\"line\">[root@redis-master redis]# src/redis-server redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">登入，<span class=\"built_in\">bind</span>设置的0.0.0.0，所以命令不用跟IP和端口</span></span><br><span class=\"line\">[root@redis-master redis]# src/redis-cli</span><br><span class=\"line\">127.0.0.1:6379&gt; ping</span><br><span class=\"line\">PONG</span><br><span class=\"line\">127.0.0.1:6379&gt; set name qingfeng</span><br><span class=\"line\">OK</span><br><span class=\"line\">127.0.0.1:6379&gt; get name</span><br><span class=\"line\">&quot;qingfeng&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; info replication\t//查看复制状态，详细信息</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Replication</span></span><br><span class=\"line\">role:master</span><br><span class=\"line\">connected_slaves:2</span><br><span class=\"line\">slave0:ip=192.168.116.131,port=6379,state=online,offset=564,lag=1</span><br><span class=\"line\">slave1:ip=192.168.116.132,port=6379,state=online,offset=564,lag=1</span><br><span class=\"line\">master_failover_state:no-failover</span><br><span class=\"line\">master_replid:4111015d2d43dfe9b0553c0bb19389c95c7976c7</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:564</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:1</span><br><span class=\"line\">repl_backlog_histlen:564</span><br><span class=\"line\">127.0.0.1:6379&gt; exit</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">slave-1</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">拷贝</span></span><br><span class=\"line\">scp 192.168.116.111:/root/redis-7.0.9.tar.gz /root</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">指定解压路径</span></span><br><span class=\"line\">[root@localhost ~]# tar zxvf redis-7.0.9.tar.gz -C /usr/loval</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">cd</span>到/usr/loval/redis，改名</span></span><br><span class=\"line\">[root@localhost redis]# mv redis-7.0.9 redis</span><br><span class=\"line\">[root@localhost redis]# yum -y install gcc make</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编译</span></span><br><span class=\"line\">[root@localhost redis]# make</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编辑配置文件</span></span><br><span class=\"line\">[root@redis-master redis]# vim redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"built_in\">bind</span> 192.168.116.111注释了</span></span><br><span class=\"line\">bind 0.0.0.0</span><br><span class=\"line\">protected-mode no\t//yes改no，设置密码的</span><br><span class=\"line\">replicaof 192.168.116.111 \t//添加master的内网和端口</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动，如果已经启动过了，需要关闭redis重新启动</span></span><br><span class=\"line\">[root@redis-slave-1 redis]# src/redis-server redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">登入，<span class=\"built_in\">bind</span>设置的0.0.0.0，所以命令不用跟IP和端口</span></span><br><span class=\"line\">[root@redis-slave-1 redis]# src/redis-cli</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">此时输入命令可以看到master创建的数据了</span></span><br><span class=\"line\">127.0.0.1:6379&gt; get name</span><br><span class=\"line\">&quot;qingfeng&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; info replication</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Replication</span></span><br><span class=\"line\">role:slave</span><br><span class=\"line\">master_host:192.168.116.111</span><br><span class=\"line\">master_port:6379</span><br><span class=\"line\">master_link_status:up</span><br><span class=\"line\">master_last_io_seconds_ago:10</span><br><span class=\"line\">master_sync_in_progress:0</span><br><span class=\"line\">slave_read_repl_offset:802</span><br><span class=\"line\">slave_repl_offset:802</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">replica_announced:1</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_failover_state:no-failover</span><br><span class=\"line\">master_replid:4111015d2d43dfe9b0553c0bb19389c95c7976c7</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:802</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:15</span><br><span class=\"line\">repl_backlog_histlen:788</span><br><span class=\"line\">127.0.0.1:6379&gt; exit</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">slave-2</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">拷贝</span></span><br><span class=\"line\">scp 192.168.116.111:/root/redis-7.0.9.tar.gz /root</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">指定解压路径</span></span><br><span class=\"line\">[root@localhost ~]# tar zxvf redis-7.0.9.tar.gz -C /usr/loval</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">cd</span>到/usr/loval/redis，改名</span></span><br><span class=\"line\">[root@localhost redis]# mv redis-7.0.9 redis</span><br><span class=\"line\">[root@localhost redis]# yum -y install gcc make</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编译</span></span><br><span class=\"line\">[root@localhost redis]# make</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编辑配置文件</span></span><br><span class=\"line\">[root@redis-master redis]# vim redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"built_in\">bind</span> 192.168.116.111注释了</span></span><br><span class=\"line\">bind 0.0.0.0</span><br><span class=\"line\">protected-mode no\t//yes改no，设置密码的</span><br><span class=\"line\">replicaof 192.168.116.111 \t//添加master的内网和端口</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动，如果已经启动过了，需要关闭redis重新启动</span></span><br><span class=\"line\">[root@redis-slave-2 redis]# src/redis-server redis.conf</span><br><span class=\"line\">[root@redis-slave-2 redis]# src/redis-cli</span><br><span class=\"line\">127.0.0.1:6379&gt; get name</span><br><span class=\"line\">&quot;qingfeng&quot;</span><br><span class=\"line\">127.0.0.1:6379&gt; info replication</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Replication</span></span><br><span class=\"line\">role:slave</span><br><span class=\"line\">master_host:192.168.116.111</span><br><span class=\"line\">master_port:6379</span><br><span class=\"line\">master_link_status:up</span><br><span class=\"line\">master_last_io_seconds_ago:6</span><br><span class=\"line\">master_sync_in_progress:0</span><br><span class=\"line\">slave_read_repl_offset:816</span><br><span class=\"line\">slave_repl_offset:816</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">replica_announced:1</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_failover_state:no-failover</span><br><span class=\"line\">master_replid:4111015d2d43dfe9b0553c0bb19389c95c7976c7</span><br><span class=\"line\">master_replid2:0000000000000000000000000000000000000000</span><br><span class=\"line\">master_repl_offset:816</span><br><span class=\"line\">second_repl_offset:-1</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:295</span><br><span class=\"line\">repl_backlog_histlen:522</span><br><span class=\"line\">127.0.0.1:6379&gt; exit</span><br></pre></td></tr></table></figure>\n\n<p><code>此时主从同步部署完成</code></p>\n<p><strong>4、redis-sentinel—哨兵模式</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">每台机器上修改redis主配置文件redis.conf文件设置：<span class=\"built_in\">bind</span> 0.0.0.0</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改配置文件</span></span><br><span class=\"line\">[root@redis-master redis]# vim sentinel.conf</span><br><span class=\"line\">daemonize yes #设置哨兵放后台运行</span><br><span class=\"line\">logfile &quot;/var/log/sentinel.log&quot; #设置哨兵日志</span><br><span class=\"line\">sentinel monitor mymaster 10.0.0.137 6379 2 #当集群中有2个sentinel认为master死了时，才能真正认为该master已经不可用了。 (slave上面写的是master的ip，master写自己ip)</span><br><span class=\"line\">sentinel auth-pass mymaster 1122334 #如果设置了密码那就需要指定密码，否则不需要</span><br><span class=\"line\">sentinel down-after-milliseconds mymaster 3000   #单位毫秒</span><br><span class=\"line\">sentinel failover-timeout mymaster 10000   #若sentinel在该配置值内未能完成failover(故障转移)操作（即故障时master/slave自动切换），则认为本次failover失败。</span><br><span class=\"line\"></span><br><span class=\"line\">protected-mode no  #关闭加密模式--新添加到sentinel配置文件中  ----老版本中需需要添加</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动</span></span><br><span class=\"line\">[root@redis-master redis]# pkill redis</span><br><span class=\"line\">[root@redis-master redis]# src/redis-sentinel sentinel.conf</span><br><span class=\"line\">[root@redis-master redis]# src/redis-server redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">测试</span></span><br><span class=\"line\">[root@redis-slave-1 redis]# src/redis-cli</span><br><span class=\"line\">127.0.0.1:6379&gt; ping</span><br><span class=\"line\">PONG</span><br><span class=\"line\">127.0.0.1:6379&gt; info replication</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Replication</span></span><br><span class=\"line\">role:master</span><br><span class=\"line\">master_host:192.168.116.111</span><br><span class=\"line\">master_port:6379</span><br><span class=\"line\">master_link_status:up</span><br><span class=\"line\">master_last_io_seconds_ago:0</span><br><span class=\"line\">master_sync_in_progress:0</span><br><span class=\"line\">slave_read_repl_offset:25387</span><br><span class=\"line\">slave_repl_offset:25387</span><br><span class=\"line\">slave_priority:100</span><br><span class=\"line\">slave_read_only:1</span><br><span class=\"line\">replica_announced:1</span><br><span class=\"line\">connected_slaves:0</span><br><span class=\"line\">master_failover_state:no-failover</span><br><span class=\"line\">master_replid:d09a4de58ff9c3e7f5c4e9fe7c39f5a7f7b7861c</span><br><span class=\"line\">master_replid2:4111015d2d43dfe9b0553c0bb19389c95c7976c7</span><br><span class=\"line\">master_repl_offset:25387</span><br><span class=\"line\">second_repl_offset:4205</span><br><span class=\"line\">repl_backlog_active:1</span><br><span class=\"line\">repl_backlog_size:1048576</span><br><span class=\"line\">repl_backlog_first_byte_offset:15</span><br><span class=\"line\">repl_backlog_histlen:25373</span><br></pre></td></tr></table></figure>\n\n<p><code>此时哨兵模式部署完成</code></p>\n","categories":["operations"],"tags":["Linux","Redis"]},{"title":"Vercel部署Twikoo评论系统","url":"/2026/02/04/Vercel%E9%83%A8%E7%BD%B2Twikoo%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F/","content":"<h1 id=\"Twikoo简介\"><a href=\"#Twikoo简介\" class=\"headerlink\" title=\"Twikoo简介\"></a>Twikoo简介</h1><p><a href=\"https://twikoo.js.org/\">Twikoo</a>是一个简洁、安全、免费的静态网站评论系统。</p>\n<p>与waline相比：<br>优势：差不多；<br>不足：不支持IE，私有部署需要配置图床。</p>\n<h2 id=\"1-创建MongoDB-Cloud数据库\"><a href=\"#1-创建MongoDB-Cloud数据库\" class=\"headerlink\" title=\"1. 创建MongoDB Cloud数据库\"></a>1. 创建MongoDB Cloud数据库</h2><h3 id=\"1-添加User\"><a href=\"#1-添加User\" class=\"headerlink\" title=\"(1) 添加User\"></a>(1) 添加User</h3><p>登录<a href=\"https://account.mongodb.com/account/login?n=https://cloud.mongodb.com/v2/69829a875be2684295ac9a69&nextHash=%23overview&signedOut=true\">MongoDB Cloud官网地址</a>(没账号需要先注册)，在Database Access页面点击Add New Database User创建数据库用户，Authentication Method选Password，在Password Authentication下设置数据库用户名和密码，用户名和密码可包含数字和大小写字母，不能包含特殊符号。点击Database User Privileges下方的Add Built In Role，elect Role选择Atlas Admin，最后点击Add User</p>\n<p><img src=\"/img/article_image/W1.png\" alt=\"W1.png\"></p>\n<h3 id=\"2-添加Network-Access\"><a href=\"#2-添加Network-Access\" class=\"headerlink\" title=\"(2) 添加Network Access\"></a>(2) 添加Network Access</h3><p>在Network Access页面点击Add IP Address，Access List Entry输入0.0.0.0&#x2F;0(允许所有IP地址的连接)，点击Confirm<br><img src=\"/img/article_image/W2.png\" alt=\"W2.png\"></p>\n<h2 id=\"2-Vercel部署Twikoo\"><a href=\"#2-Vercel部署Twikoo\" class=\"headerlink\" title=\"2. Vercel部署Twikoo\"></a>2. Vercel部署Twikoo</h2><h3 id=\"1-一键部署\"><a href=\"#1-一键部署\" class=\"headerlink\" title=\"(1) 一键部署\"></a>(1) 一键部署</h3><p><a href=\"https://vercel.com/new/clone?repository-url=https://github.com/twikoojs/twikoo/tree/main/src/server/vercel-min&teamSlug=xubaodong0511s-projects\">点击一键部署 Twikoo 到 Vercel</a></p>\n<h3 id=\"2-配置环境变量\"><a href=\"#2-配置环境变量\" class=\"headerlink\" title=\"(2) 配置环境变量\"></a>(2) 配置环境变量</h3><p>选择新建的Twikoo项目，进入Settings -&gt; Environment Variables，添加环境变量MONGODB_URI，值为前面的MongoDB数据库连接字符串(注意替换<Password>)。</p>\n<p><img src=\"/img/article_image/W3.png\" alt=\"W3.png\"></p>\n<h3 id=\"3-redeploy\"><a href=\"#3-redeploy\" class=\"headerlink\" title=\"(3) redeploy\"></a>(3) redeploy</h3><p>进入Deployments，进行Redeploy</p>\n<p><img src=\"/img/article_image/W4.png\" alt=\"W4.png\"></p>\n<p>等待重新部署完成后，进入Project，查看Overview或者点击visit，可以看见“Twikoo 云函数运行正常”的提示，部署成功</p>\n<p><img src=\"/img/article_image/W5.png\" alt=\"W5.png\"></p>\n<h3 id=\"4-绑定域名\"><a href=\"#4-绑定域名\" class=\"headerlink\" title=\"(4) 绑定域名\"></a>(4) 绑定域名</h3><p>进入Settings -&gt; Domains，在此处填写要绑定的域名，并在域名服务商配置中添加cname类型解析记录，可参考Vercel部署Waline绑定域名过程</p>\n<h3 id=\"5-验证\"><a href=\"#5-验证\" class=\"headerlink\" title=\"(5) 验证\"></a>(5) 验证</h3><p>打开<a href=\"https://vercel.com/xubaodong0511s-projects/hexo_blog_twikoo_vercel/7sS5gqn5o4KjiduFMwqiLPEbbJFi\">项目地址</a>，查看status是不是ready状态。</p>\n<p><img src=\"/img/article_image/W6.png\" alt=\"W6.png\">)</p>\n<p><code>打开域名地址，页面出现以下内容代表成功</code><br>{“code”:100,”message”:”Twikoo 云函数运行正常，请参考 <a href=\"https://twikoo.js.org/frontend.html\">https://twikoo.js.org/frontend.html</a> 完成前端的配置”,”version”:”1.6.44”}</p>\n<h1 id=\"在themes中的主题-config-yml-中配置评论功能\"><a href=\"#在themes中的主题-config-yml-中配置评论功能\" class=\"headerlink\" title=\"在themes中的主题_config.yml_中配置评论功能\"></a>在themes中的主题_config.yml_中配置评论功能</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">comments:</span><br><span class=\"line\">  use: twikoo</span><br><span class=\"line\">  text: true</span><br><span class=\"line\">  lazyload: false</span><br><span class=\"line\">  card_post_count: false</span><br><span class=\"line\">  </span><br><span class=\"line\">......</span><br><span class=\"line\"></span><br><span class=\"line\">twikoo:</span><br><span class=\"line\">  envId: https://hexoblogtwikoovercel.vercel.app</span><br><span class=\"line\">  region:</span><br><span class=\"line\">  # Use Twikoo visitor count as the page view count</span><br><span class=\"line\">  visitor: false</span><br><span class=\"line\">  option:</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Zabbix"]},{"title":"ansible 配置jspgou商城上线（MySQL版）","url":"/2025/11/06/ansible-%E9%85%8D%E7%BD%AEjspgou%E5%95%86%E5%9F%8E%E4%B8%8A%E7%BA%BF%EF%BC%88MySQL%E7%89%88%EF%BC%89/","content":"<h2 id=\"准备实验环境，准备两台电脑\"><a href=\"#准备实验环境，准备两台电脑\" class=\"headerlink\" title=\"准备实验环境，准备两台电脑\"></a>准备实验环境，准备两台电脑</h2><p>10.31.162.24—-10.31.162.25</p>\n<p>关闭防火墙，关闭setenforce 0</p>\n<h2 id=\"hosts解析\"><a href=\"#hosts解析\" class=\"headerlink\" title=\"hosts解析\"></a>hosts解析</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@ansible-server ~]# vim /etc/hosts</span><br><span class=\"line\">10.31.162.24    ansible-server</span><br><span class=\"line\">10.31.162.25    ansible-web</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"更改主机名\"><a href=\"#更改主机名\" class=\"headerlink\" title=\"更改主机名\"></a>更改主机名</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">10.31.162.24</span><br><span class=\"line\">[root@ansible-server ~]# hostnamectl set-hostname ansible-server</span><br><span class=\"line\"></span><br><span class=\"line\">10.31.162.25</span><br><span class=\"line\">[root@ansible-web ~]# hostnamectl set-hostname ansible-web</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装ansible\"><a href=\"#安装ansible\" class=\"headerlink\" title=\"安装ansible\"></a>安装ansible</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">10.31.162.24</span><br><span class=\"line\">安装：控制节点</span><br><span class=\"line\"> 1. 配置EPEL网络yum源</span><br><span class=\"line\"> [root@ansible-server ~]# yum install -y epel*</span><br><span class=\"line\"> 2. 安装ansible</span><br><span class=\"line\"> [root@ansible-server ~]# yum install -y ansible</span><br><span class=\"line\"> 3.查看版本</span><br><span class=\"line\"> [root@ansiable-server ~]# ansible --version</span><br><span class=\"line\"> 4.查看配置文件：</span><br><span class=\"line\">[root@ansible-server ~]# rpm  -qc ansible</span><br><span class=\"line\">---1.主配置文件：/etc/ansible/ansible.cfg  #主要设置一些ansible初始化的信息，比如日志存放路径、模块、插件等配置信息</span><br><span class=\"line\">---2.主机清单文件:默认位置/etc/ansible/hosts</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装nginx\"><a href=\"#安装nginx\" class=\"headerlink\" title=\"安装nginx\"></a>安装nginx</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置nginx源</span></span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/yum.repos.d/nginx.repo</span><br><span class=\"line\">[nginx-stable]</span><br><span class=\"line\">name=nginx stable repo</span><br><span class=\"line\">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class=\"line\">module_hotfixes=true</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">下载nginx</span></span><br><span class=\"line\">[root@ansible-server ~]# yum install -y nginx</span><br><span class=\"line\">[root@ansible-server ~]# systemctl start nginx</span><br><span class=\"line\">[root@ansible-server ~]# systemctl enable nginx</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"上传jdk、tomcat、jspgou压缩包\"><a href=\"#上传jdk、tomcat、jspgou压缩包\" class=\"headerlink\" title=\"上传jdk、tomcat、jspgou压缩包\"></a>上传jdk、tomcat、jspgou压缩包</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">将下载好的jdk、tomcat、jspgou，上传到server机器上</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">也可以直接官网下载</span></span><br><span class=\"line\">apache-tomcat-9.0.83.tar.gz</span><br><span class=\"line\">jdk-8u321-linux-x64.tar.gz</span><br><span class=\"line\">jspgouV6.1-ROOT.zip</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">jspgou包是gz的包，需要解压重新压缩才可以用，只能用tar包</span></span><br><span class=\"line\">[root@ansible-server ~]# yum -y install unzip</span><br><span class=\"line\">[root@ansible-server ~]# unzip jspgouV6.1-ROOT.zip</span><br><span class=\"line\">[root@ansible-server ~]# ls</span><br><span class=\"line\">DB ROOT</span><br><span class=\"line\">[root@ansible-server ~]# tar zcvf jspgouv6.1.tar.gz DB ROOT</span><br><span class=\"line\">jspgouv6.1.tar.gz</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"添加主机\"><a href=\"#添加主机\" class=\"headerlink\" title=\"添加主机\"></a>添加主机</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">添加主机清单</span></span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/ansible/hosts</span><br><span class=\"line\">[jspgou]</span><br><span class=\"line\">ansible-web</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">其他语法</span></span><br><span class=\"line\">1.添加主机或者主机组：</span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/ansible/hosts  #在最后追加被管理端的机器</span><br><span class=\"line\">ansible-web1                      #单独指定主机，可以使用主机名称或IP地址</span><br><span class=\"line\">2.添加主机组：</span><br><span class=\"line\">[webservers]        #使用[]标签指定主机组 ----标签自定义</span><br><span class=\"line\">192.168.10.11        #如果未解析添加ip</span><br><span class=\"line\">ansible-web2      #解析添加主机名</span><br><span class=\"line\">3.组可以包含其他组：</span><br><span class=\"line\">[webservers1]     #组一</span><br><span class=\"line\">ansible-web1</span><br><span class=\"line\">[webservers2]     #组二</span><br><span class=\"line\">ansible-web2</span><br><span class=\"line\">[weball:children]      #caildren-照写 #weball包括两个子组</span><br><span class=\"line\">webservers1        #组一</span><br><span class=\"line\">webservers2        #组二</span><br><span class=\"line\">4.为一个组指定变量，组内每个主机都可以使用该变量：</span><br><span class=\"line\">[weball:vars]         #设置变量,vars--照写</span><br><span class=\"line\">ansible_ssh_port=22     </span><br><span class=\"line\">ansible_ssh_user=root   </span><br><span class=\"line\">ansible_ssh_private_key_file=/root/.ssh/id_rsa  </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">ansible_ssh_pass=1      <span class=\"comment\">#也可以定义密码，如果没有互传秘钥可以使用密码。</span></span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置ssh密钥\"><a href=\"#配置ssh密钥\" class=\"headerlink\" title=\"配置ssh密钥\"></a>配置ssh密钥</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置ssh公钥认证：控制节点需要发送ssh公钥给所有非被控制节点</span><br><span class=\"line\">[root@ansible-server ~]# ssh-keygen</span><br><span class=\"line\">[root@ansible-server ~]# ssh-copy-id -i 10.31.126.25  #所有机器</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置剧本\"><a href=\"#配置剧本\" class=\"headerlink\" title=\"配置剧本\"></a>配置剧本</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在vars目录里配置file.yml配置文件</span></span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/ansible/vars/file.yml</span><br><span class=\"line\">src_gou_path: /root/jspgouv6.1.tar.gz</span><br><span class=\"line\">src_jdk_path: /root/jdk-8u321-linux-x64.tar.gz</span><br><span class=\"line\">src_tomcat_path: /root/apache-tomcat-9.0.83.tar.gz</span><br><span class=\"line\">dest_gou_path: /root</span><br><span class=\"line\">dest_jdk_path: /root</span><br><span class=\"line\">dest_tomcat_path: /root</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">配置安装MySQL脚本</span></span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/ansible/jsp.sh</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span></span><br><span class=\"line\">PASS_WORD=&quot;Qianfeng@123&quot;</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">配置源</span></span><br><span class=\"line\">cat &gt;&gt; /etc/yum.repos.d/mysql.repo &lt;&lt;EOF</span><br><span class=\"line\">[mysql]</span><br><span class=\"line\">name=mysql</span><br><span class=\"line\">baseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-5.7-community-el7-x86_64/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgkey=https://mirrors.ustc.edu.cn/mysql-repo/RPM-GPG-KEY-mysql</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">下载mysql</span></span><br><span class=\"line\">yum repolist enabled | grep mysql</span><br><span class=\"line\">yum -y install mysql-community-server &amp;&gt; /dev/null</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">启动</span></span><br><span class=\"line\">systemctl start mysqld &amp;&amp; systemctl enable mysqld</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">获取密码</span></span><br><span class=\"line\">TEMP_PASSWORD=$(sudo grep &#x27;temporary password&#x27; /var/log/mysqld.log | awk &#x27;&#123;print $NF&#125;&#x27;)</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">修改密码</span></span><br><span class=\"line\">mysql -u root -p&quot;$&#123;TEMP_PASSWORD&#125;&quot; --connect-expired-password &lt;&lt;EOF</span><br><span class=\"line\">ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &quot;$PASS_WORD&quot;;</span><br><span class=\"line\">GRANT ALL PRIVILEGES ON *.* TO &#x27;root&#x27;@&#x27;localhost&#x27; WITH GRANT OPTION;</span><br><span class=\"line\">FLUSH PRIVILEGES;</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">重启mysql</span></span><br><span class=\"line\">systemctl restart mysqld</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">赋予jsp.sh权限</span></span><br><span class=\"line\">[root@ansible-server ~]# cd /etc/ansible/</span><br><span class=\"line\">[root@ansible-server ansible]# chmod o+x jsp.sh</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在ansible目录里配置jspgou.yml配置文件</span></span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/ansible/jspgou.yml</span><br><span class=\"line\">- hosts: jspgou</span><br><span class=\"line\">  user: root</span><br><span class=\"line\">  become: yes</span><br><span class=\"line\">  vars_files:</span><br><span class=\"line\">  - /etc/ansible/vars/file.yml</span><br><span class=\"line\">  </span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">  - name: configure jdk1</span><br><span class=\"line\">    copy: src=&#123;&#123; src_jdk_path &#125;&#125; dest=&#123;&#123; dest_jdk_path &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: unzip jdk</span><br><span class=\"line\">    unarchive: src=&#123;&#123; dest_jdk_path &#125;&#125;/jdk-8u321-linux-x64.tar.gz dest=/usr/local/ copy=no</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: rename java</span><br><span class=\"line\">    shell: mv /usr/local/jdk1.8.0_321 /usr/local/java</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: configure jdk envirement1</span><br><span class=\"line\">    shell: echo &quot;JAVA_HOME=/usr/local/java&quot; &gt;&gt; /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: configure jdk envirement2</span><br><span class=\"line\">    shell: echo &#x27;PATH=$JAVA_HOME/bin:$PATH&#x27; &gt;&gt; /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: copy tomcat</span><br><span class=\"line\">    copy: src=&#123;&#123; src_tomcat_path &#125;&#125; dest=&#123;&#123; dest_tomcat_path &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: unzip tomcat</span><br><span class=\"line\">    unarchive: src=&#123;&#123; dest_tomcat_path &#125;&#125;/apache-tomcat-9.0.83.tar.gz dest=/usr/local/ copy=no</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: rename tomcat</span><br><span class=\"line\">    shell: mv /usr/local/apache-tomcat-9.0.83 /usr/local/tomcat</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: rm -rf webapps</span><br><span class=\"line\">    shell: rm -rf /usr/local/tomcat/webapps/*</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: add /etc/profile</span><br><span class=\"line\">    shell: sed -i &quot;2i source /etc/profile&quot; /usr/local/tomcat/bin/startup.sh</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: add /etc/profile to shutdown.sh</span><br><span class=\"line\">    shell: sed -i &quot;2i source /etc/profile&quot; /usr/local/tomcat/bin/shutdown.sh</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: copy jspgou</span><br><span class=\"line\">    copy: src=&#123;&#123; src_gou_path &#125;&#125; dest=&#123;&#123; dest_gou_path &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: unzip jspgou</span><br><span class=\"line\">    unarchive: src=&#123;&#123; dest_gou_path &#125;&#125;/jspgouv6.1.tar.gz dest=/usr/local/tomcat/webapps copy=no</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: Modify MySQL user initial password</span><br><span class=\"line\">    script: /etc/ansible/jsp.sh removes=/etc/passwd</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: enter MySQL</span><br><span class=\"line\">    shell: mysql -uroot -p&#x27;Qianfeng@123&#x27; -e &quot;create database jspgou default charset=utf8;&quot;</span><br><span class=\"line\">    </span><br><span class=\"line\">  - name: edit mysqld</span><br><span class=\"line\">    shell: sed -i &#x27;s/jdbc.password=/jdbc.password=Qianfeng@123/&#x27; /usr/local/tomcat/webapps/ROOT/WEB-INF/config/jdbc.properties</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: append mysql</span><br><span class=\"line\">    shell: echo &quot;max_allowed_packet= 64m&quot; &gt;&gt; /etc/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: append mysql1</span><br><span class=\"line\">    shell: echo &quot;sql_mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUB&quot; &gt;&gt; /etc/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: append mysql2</span><br><span class=\"line\">    shell: echo &quot;explicit_defaults_for_timestamp=1&quot; &gt;&gt; /etc/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: restart mysqld1</span><br><span class=\"line\">    shell: systemctl restart mysqld</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: Import data</span><br><span class=\"line\">    shell: mysql -uroot -p&quot;Qianfeng@123&quot; -D jspgou &lt; /usr/local/tomcat/webapps/DB/jspgou.sql</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: restart mysql11</span><br><span class=\"line\">    shell: systemctl restart mysqld</span><br><span class=\"line\">    notify: start jspgou</span><br><span class=\"line\">  handlers:</span><br><span class=\"line\">  </span><br><span class=\"line\">  - name: start jspgou</span><br><span class=\"line\">    shell: nohup /usr/local/tomcat/bin/startup.sh &amp;</span><br></pre></td></tr></table></figure>\n<h1 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@ansible ansible]# ansible-playbook jspgou.yml</span><br></pre></td></tr></table></figure>\n<h1 id=\"配置nginx代理\"><a href=\"#配置nginx代理\" class=\"headerlink\" title=\"配置nginx代理\"></a>配置nginx代理</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">备份原有配置文件</span></span><br><span class=\"line\">[root@ansible-server ~]#  cp default.conf default.conf.bak</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">添加jspgou.conf配置文件</span></span><br><span class=\"line\">[root@ansible-server ~]#  vim /etc/nginx/conf.d/jspgou.conf </span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://10.31.162.25:8080;</span><br><span class=\"line\">        proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启nginx</span></span><br><span class=\"line\">[root@ansible-server ~]#  systemctl restart nginx</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">打开网址输入10.31.162.24----会出来jspgou商城界面</span><br></pre></td></tr></table></figure>\n<p><img src=\"https://xbd666.cn/upload/jspgou1.png\" alt=\"jspgou1.png\"></p>\n","categories":["operations"],"tags":["Linux","Mysql","Ansible"]},{"title":"ansible 配置jspgou商城上线（mariadb版）","url":"/2025/11/06/ansible-%E9%85%8D%E7%BD%AEjspgou%E5%95%86%E5%9F%8E%E4%B8%8A%E7%BA%BF%EF%BC%88mariadb%E7%89%88%EF%BC%89/","content":"<h2 id=\"准备实验环境，准备两台电脑\"><a href=\"#准备实验环境，准备两台电脑\" class=\"headerlink\" title=\"准备实验环境，准备两台电脑\"></a>准备实验环境，准备两台电脑</h2><p>10.31.162.24—-10.31.162.25<br>此实验配置的是—-mariadb</p>\n<p>关闭防火墙，关闭setenforce 0</p>\n<h2 id=\"hosts解析\"><a href=\"#hosts解析\" class=\"headerlink\" title=\"hosts解析\"></a>hosts解析</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@ansible-server ~]# vim /etc/hosts</span><br><span class=\"line\">10.31.162.24    ansible-server</span><br><span class=\"line\">10.31.162.25    ansible-web</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"更改主机名\"><a href=\"#更改主机名\" class=\"headerlink\" title=\"更改主机名\"></a>更改主机名</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">10.31.162.24</span><br><span class=\"line\">[root@ansible-server ~]# hostnamectl set-hostname ansible-server</span><br><span class=\"line\"></span><br><span class=\"line\">10.31.162.25</span><br><span class=\"line\">[root@ansible-web ~]# hostnamectl set-hostname ansible-web</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装ansible\"><a href=\"#安装ansible\" class=\"headerlink\" title=\"安装ansible\"></a>安装ansible</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">10.31.162.24</span><br><span class=\"line\">安装：控制节点</span><br><span class=\"line\"> 1. 配置EPEL网络yum源</span><br><span class=\"line\"> [root@ansible-server ~]# yum install -y epel*</span><br><span class=\"line\"> 2. 安装ansible</span><br><span class=\"line\"> [root@ansible-server ~]# yum install -y ansible</span><br><span class=\"line\"> 3.查看版本</span><br><span class=\"line\"> [root@ansiable-server ~]# ansible --version</span><br><span class=\"line\"> 4.查看配置文件：</span><br><span class=\"line\">[root@ansible-server ~]# rpm  -qc ansible</span><br><span class=\"line\">---1.主配置文件：/etc/ansible/ansible.cfg  #主要设置一些ansible初始化的信息，比如日志存放路径、模块、插件等配置信息</span><br><span class=\"line\">---2.主机清单文件:默认位置/etc/ansible/hosts</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装nginx\"><a href=\"#安装nginx\" class=\"headerlink\" title=\"安装nginx\"></a>安装nginx</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置nginx源</span></span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/yum.repos.d/nginx.repo</span><br><span class=\"line\">[nginx-stable]</span><br><span class=\"line\">name=nginx stable repo</span><br><span class=\"line\">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgkey=https://nginx.org/keys/nginx_signing.key</span><br><span class=\"line\">module_hotfixes=true</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">下载nginx</span></span><br><span class=\"line\">[root@ansible-server ~]# yum install -y nginx</span><br><span class=\"line\">[root@ansible-server ~]# systemctl start nginx</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"上传压缩包\"><a href=\"#上传压缩包\" class=\"headerlink\" title=\"上传压缩包\"></a>上传压缩包</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">将下载好的jdk、tomcat、jspgou，上传到server机器上</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">也可以直接官网下载</span></span><br><span class=\"line\">apache-tomcat-9.0.83.tar.gz</span><br><span class=\"line\">jdk-8u321-linux-x64.tar.gz</span><br><span class=\"line\">jspgouV6.1-ROOT.zip</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">jspgou包是gz的包，需要解压重新压缩才可以用，只能用tar包</span></span><br><span class=\"line\">[root@ansible-server ~]# yum -y install unzip</span><br><span class=\"line\">[root@ansible-server ~]# unzip jspgouV6.1-ROOT.zip</span><br><span class=\"line\">[root@ansible-server ~]# ls</span><br><span class=\"line\">DB ROOT</span><br><span class=\"line\">[root@ansible-server ~]# tar zcvf jspgouv6.1.tar.gz DB ROOT</span><br><span class=\"line\">jspgouv6.1.tar.gz</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"添加主机\"><a href=\"#添加主机\" class=\"headerlink\" title=\"添加主机\"></a>添加主机</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">添加主机清单</span></span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/ansible/hosts</span><br><span class=\"line\">[jspgou]</span><br><span class=\"line\">ansible-web</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">其他语法</span></span><br><span class=\"line\">1.添加主机或者主机组：</span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/ansible/hosts  #在最后追加被管理端的机器</span><br><span class=\"line\">ansible-web1                      #单独指定主机，可以使用主机名称或IP地址</span><br><span class=\"line\">2.添加主机组：</span><br><span class=\"line\">[webservers]        #使用[]标签指定主机组 ----标签自定义</span><br><span class=\"line\">192.168.10.11        #如果未解析添加ip</span><br><span class=\"line\">ansible-web2      #解析添加主机名</span><br><span class=\"line\">3.组可以包含其他组：</span><br><span class=\"line\">[webservers1]     #组一</span><br><span class=\"line\">ansible-web1</span><br><span class=\"line\">[webservers2]     #组二</span><br><span class=\"line\">ansible-web2</span><br><span class=\"line\">[weball:children]      #caildren-照写 #weball包括两个子组</span><br><span class=\"line\">webservers1        #组一</span><br><span class=\"line\">webservers2        #组二</span><br><span class=\"line\">4.为一个组指定变量，组内每个主机都可以使用该变量：</span><br><span class=\"line\">[weball:vars]         #设置变量,vars--照写</span><br><span class=\"line\">ansible_ssh_port=22     </span><br><span class=\"line\">ansible_ssh_user=root   </span><br><span class=\"line\">ansible_ssh_private_key_file=/root/.ssh/id_rsa  </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">ansible_ssh_pass=1      <span class=\"comment\">#也可以定义密码，如果没有互传秘钥可以使用密码。</span></span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置ssh密钥\"><a href=\"#配置ssh密钥\" class=\"headerlink\" title=\"配置ssh密钥\"></a>配置ssh密钥</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置ssh公钥认证：控制节点需要发送ssh公钥给所有非被控制节点</span><br><span class=\"line\">[root@ansible-server ~]# ssh-keygen</span><br><span class=\"line\">[root@ansible-server ~]# ssh-copy-id -i 10.31.126.25  #所有机器</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置ansible剧本\"><a href=\"#配置ansible剧本\" class=\"headerlink\" title=\"配置ansible剧本\"></a>配置ansible剧本</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在vars目录里配置file.yml配置文件</span></span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/ansible/vars/file.yml</span><br><span class=\"line\">src_gou_path: /root/jspgouv6.1.tar.gz</span><br><span class=\"line\">src_jdk_path: /root/jdk-8u321-linux-x64.tar.gz</span><br><span class=\"line\">src_tomcat_path: /root/apache-tomcat-9.0.83.tar.gz</span><br><span class=\"line\">dest_gou_path: /root</span><br><span class=\"line\">dest_jdk_path: /root</span><br><span class=\"line\">dest_tomcat_path: /root</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在ansible目录里配置jspgou.yml配置文件</span></span><br><span class=\"line\">[root@ansible-server ~]# vim /etc/ansible/jspgou.yml</span><br><span class=\"line\">- hosts: jspgou</span><br><span class=\"line\">  user: root</span><br><span class=\"line\">  vars_files:</span><br><span class=\"line\">  - /etc/ansible/vars/file.yml</span><br><span class=\"line\">  </span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">  - name: configure jdk1</span><br><span class=\"line\">    copy: src=&#123;&#123; src_jdk_path &#125;&#125; dest=&#123;&#123; dest_jdk_path &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: unzip jdk</span><br><span class=\"line\">    unarchive: src=&#123;&#123; dest_jdk_path &#125;&#125;/jdk-8u321-linux-x64.tar.gz dest=/usr/local/ copy=no</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: rename java</span><br><span class=\"line\">    shell: mv /usr/local/jdk1.8.0_321 /usr/local/java</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: configure jdk envirement1</span><br><span class=\"line\">    shell: echo &quot;JAVA_HOME=/usr/local/java&quot; &gt;&gt; /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: configure jdk envirement2</span><br><span class=\"line\">    shell: echo &#x27;PATH=$JAVA_HOME/bin:$PATH&#x27; &gt;&gt; /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: copy tomcat</span><br><span class=\"line\">    copy: src=&#123;&#123; src_tomcat_path &#125;&#125; dest=&#123;&#123; dest_tomcat_path &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: unzip tomcat</span><br><span class=\"line\">    unarchive: src=&#123;&#123; dest_tomcat_path &#125;&#125;/apache-tomcat-9.0.83.tar.gz dest=/usr/local/ copy=no</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: rename tomcat</span><br><span class=\"line\">    shell: mv /usr/local/apache-tomcat-9.0.83 /usr/local/tomcat</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: rm -rf webapps</span><br><span class=\"line\">    shell: rm -rf /usr/local/tomcat/webapps/*</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: add /etc/profile</span><br><span class=\"line\">    shell: sed -i &quot;2i source /etc/profile&quot; /usr/local/tomcat/bin/startup.sh</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: add /etc/profile to shutdown.sh</span><br><span class=\"line\">    shell: sed -i &quot;2i source /etc/profile&quot; /usr/local/tomcat/bin/shutdown.sh</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: copy jspgou</span><br><span class=\"line\">    copy: src=&#123;&#123; src_gou_path &#125;&#125; dest=&#123;&#123; dest_gou_path &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: unzip jspgou</span><br><span class=\"line\">    unarchive: src=&#123;&#123; dest_gou_path &#125;&#125;/jspgouv6.1.tar.gz dest=/usr/local/tomcat/webapps copy=no</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: install mariadb</span><br><span class=\"line\">    shell: yum -y install mariadb mariadb-server</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: start mariadb</span><br><span class=\"line\">    shell: systemctl start mariadb &amp;&amp; systemctl enable mariadb</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: start mysql1</span><br><span class=\"line\">    shell: mysqladmin -uroot password &quot;666888&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: enter mariadb</span><br><span class=\"line\">    shell: mysql -uroot -p&#x27;666888&#x27; -e &quot;create database jspgou default charset=utf8;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: edit mysqld</span><br><span class=\"line\">    shell: sed -i &#x27;s/jdbc.password=/jdbc.password=666888/&#x27; /usr/local/tomcat/webapps/ROOT/WEB-INF/config/jdbc.properties</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: append mysql</span><br><span class=\"line\">    shell: echo &quot;max_allowed_packet= 64m&quot; &gt;&gt; /etc/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: append mysql1</span><br><span class=\"line\">    shell: echo &quot;sql_mode=STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUB&quot; &gt;&gt; /etc/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: append mysql2</span><br><span class=\"line\">    shell: echo &quot;explicit_defaults_for_timestamp=1&quot; &gt;&gt; /etc/my.cnf</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: restart mariadb</span><br><span class=\"line\">    shell: systemctl restart mariadb</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: Import data</span><br><span class=\"line\">    shell: mysql -uroot -p&quot;666888&quot; -D jspgou &lt; /usr/local/tomcat/webapps/DB/jspgou.sql</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: restart mysql</span><br><span class=\"line\">    shell: systemctl restart mariadb</span><br><span class=\"line\">    notify: start jspgou</span><br><span class=\"line\">  handlers:</span><br><span class=\"line\"></span><br><span class=\"line\">  - name: start jspgou</span><br><span class=\"line\">    shell: nohup /usr/local/tomcat/bin/startup.sh &amp;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@ansible ansible]# ansible-playbook jspgou.yml</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置nginx代理\"><a href=\"#配置nginx代理\" class=\"headerlink\" title=\"配置nginx代理\"></a>配置nginx代理</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">备份原有配置文件</span></span><br><span class=\"line\">[root@ansible-server ~]#  cp default.conf default.conf.bak</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">添加jspgou.conf配置文件</span></span><br><span class=\"line\">[root@ansible-server ~]#  vim /etc/nginx/conf.d/jspgou.conf </span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80;</span><br><span class=\"line\">    server_name  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://10.31.162.25:8080;</span><br><span class=\"line\">        proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启nginx</span></span><br><span class=\"line\">[root@ansible-server ~]#  systemctl restart nginx</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">打开网址输入10.31.162.24----会出来jspgou商城界面</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/jspgou1.png\" alt=\"jspgou1.png\"></p>\n","categories":["operations"],"tags":["Linux","Ansible","mariadb"]},{"title":"deban12初始化问题、用法","url":"/2025/11/06/deban12%E5%88%9D%E5%A7%8B%E5%8C%96%E9%97%AE%E9%A2%98%E3%80%81%E7%94%A8%E6%B3%95/","content":"<h1 id=\"debian和ubuntu本身的vi编辑器是不支持用退格键删除和用上下左右键的\"><a href=\"#debian和ubuntu本身的vi编辑器是不支持用退格键删除和用上下左右键的\" class=\"headerlink\" title=\"debian和ubuntu本身的vi编辑器是不支持用退格键删除和用上下左右键的\"></a>debian和ubuntu本身的vi编辑器是不支持用退格键删除和用上下左右键的</h1><p>所以要</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">vi /etc/vim/vimrc.tiny</span><br><span class=\"line\"></span><br><span class=\"line\">把 set compatible</span><br><span class=\"line\"></span><br><span class=\"line\">修改改为：set nocompatible</span><br><span class=\"line\"></span><br><span class=\"line\">加入一句：set backspace=2</span><br></pre></td></tr></table></figure>\n<h1 id=\"还有debian和ubuntu用不了ll命令\"><a href=\"#还有debian和ubuntu用不了ll命令\" class=\"headerlink\" title=\"还有debian和ubuntu用不了ll命令\"></a>还有debian和ubuntu用不了ll命令</h1><p>直接分别到普通用户的家目录和root用户的家目录</p>\n<p>有个隐藏文件<code>.bashrc</code>在他们的家目录下，root和用户的都要改，因为root和每个普通用户的家目录下都有一个 <code>.bashrc</code>的文件你改那个用户就生效那个</p>\n<p><code>vim  ~/.bashrc </code></p>\n<p>在打开的文件里面加入(你想让什么命令变成什么命令就像这样写就行，而为这里的root用户本身是文件夹不显示颜色的，容易一定要加下面那个让文件夹显示颜色的命令。要添加的命令最好是想要转化成的命令的本身是这个系统没有的;</p>\n<p>比如:debian本身没有ll这个命令的简写那就可以像这样添加)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">alias ll=&#x27;ls -l&#x27;</span><br><span class=\"line\">alias tailf=&#x27;tail -f&#x27;</span><br><span class=\"line\">alias dir=&#x27;dir --color=auto&#x27;（让文件夹显示颜色，这个在linux也可以用你但是这个命令其实是 Windows 系统下的命令别名设置，将 `dir` 命令设置为带颜色输出的别名。但是在 Linux 和 Unix 系统中，也可以使用这个别名命令，因为 Linux 和 Unix 系统的 Bash Shell 也支持 Windows 下的一些命令）</span><br><span class=\"line\">alias ls=&#x27;ls --color=auto&#x27;   （让ls命令直接变成 ls --color命令,也是让文件夹显示颜色，但是linux下最好用这个）</span><br></pre></td></tr></table></figure>\n\n<p>！！！但是有个很重要的问题是改完一定要记得用命令 <code>source  ~/.bashrc</code>来重新加载<code>.bashrc</code>这个文件！！！</p>\n<h1 id=\"时间问题\"><a href=\"#时间问题\" class=\"headerlink\" title=\"时间问题\"></a>时间问题</h1><p>当发现桌面时间是对的时候，但是终端里文件时间不对，说明终端时间和系统默认时间不同，需要修改终端时间</p>\n<p>那么 先 输命令  <code>timedatectl</code>  查看当前终端的时间和时区对不对</p>\n<h1 id=\"如何取消vim选中文本自动进入可视化模式\"><a href=\"#如何取消vim选中文本自动进入可视化模式\" class=\"headerlink\" title=\"如何取消vim选中文本自动进入可视化模式\"></a>如何取消vim选中文本自动进入可视化模式</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd  /usr/share/vim/vim90   进入此目录</span><br><span class=\"line\"></span><br><span class=\"line\">vim defaults.vim   /mouse 查找此单词</span><br><span class=\"line\"></span><br><span class=\"line\">修改set mouse-=a</span><br></pre></td></tr></table></figure>\n<h1 id=\"查看版本及内核\"><a href=\"#查看版本及内核\" class=\"headerlink\" title=\"查看版本及内核\"></a>查看版本及内核</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cat /etc/os-release </span><br><span class=\"line\">或 uname -a</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看apt的源\"><a href=\"#查看apt的源\" class=\"headerlink\" title=\"查看apt的源\"></a>查看apt的源</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /etc/apt/sources.list</span><br><span class=\"line\">或 vim /etc/apt/sources.list.d/</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"apt下载源的指令\"><a href=\"#apt下载源的指令\" class=\"headerlink\" title=\"apt下载源的指令\"></a>apt下载源的指令</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://dev.mysql.com/get/mysql-apt-config_0.8.29-1_all.deb</span><br><span class=\"line\">#下载dpkg的依赖</span><br><span class=\"line\">apt install gnupg</span><br><span class=\"line\">#需要用dpkg指令下载源</span><br><span class=\"line\">dpkg -i mysql-apt-config_0.8.29-1_all.deb </span><br><span class=\"line\">#下载好源需要用update指令更新西</span><br><span class=\"line\">apt update</span><br><span class=\"line\">#更新好后源就自动生效了，此时可以下载服务了</span><br><span class=\"line\">apt install -y mysql-server</span><br><span class=\"line\">#debian系统服务下安装后不需要启动，会自动启动，直接查看状态即可</span><br><span class=\"line\">systemctl status mysql</span><br></pre></td></tr></table></figure>\n<h1 id=\"centos系统直接更改为debian系统\"><a href=\"#centos系统直接更改为debian系统\" class=\"headerlink\" title=\"centos系统直接更改为debian系统\"></a>centos系统直接更改为debian系统</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 下载的github网地址</span><br><span class=\"line\">https://github.com/leitbogioro/Tools</span><br><span class=\"line\"># 下载</span><br><span class=\"line\">wget --no-check-certificate -qO InstallNET.sh &#x27;https://gitee.com/mb9e8j2/Tools/raw/master/Linux_reinstall/InstallNET.sh&#x27; &amp;&amp; chmod a+x InstallNET.sh</span><br><span class=\"line\"># 指定版本、指定登入密码</span><br><span class=\"line\">bash InstallNET.sh -debian 12 -passwd &quot;12345&quot;</span><br><span class=\"line\"># 默认密码</span><br><span class=\"line\">默认密码</span><br><span class=\"line\">对于 Linux：LeitboGi0ro</span><br><span class=\"line\">对于 Windows：Teddysun.com</span><br><span class=\"line\">也可等直接进入系统后更改密码：passwd 用户名</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Deban"]},{"title":"ansible部署mysql主从","url":"/2025/11/05/ansible%E9%83%A8%E7%BD%B2mysql%E4%B8%BB%E4%BB%8E/","content":"<h3 id=\"MySQL主从\"><a href=\"#MySQL主从\" class=\"headerlink\" title=\"MySQL主从\"></a>MySQL主从</h3><h4 id=\"作用：\"><a href=\"#作用：\" class=\"headerlink\" title=\"作用：\"></a>作用：</h4><p>MySQL 是一种开源的关系数据库管理系统（RDBMS），广泛用于各种应用场景。以下是 MySQL 的主要作用和用途：</p>\n<ol>\n<li><p><strong>数据存储和管理</strong>:</p>\n<ul>\n<li>MySQL 用于存储和管理大量结构化数据。它支持多种数据类型和复杂的查询操作，适合处理各种业务数据。</li>\n</ul>\n</li>\n<li><p><strong>Web 应用程序</strong>:</p>\n<ul>\n<li>MySQL 是许多 Web 应用程序的后端数据库，尤其是与 PHP 结合使用。常见的内容管理系统（CMS）如 WordPress、Joomla 和 Drupal 都依赖 MySQL。</li>\n</ul>\n</li>\n<li><p><strong>电子商务</strong>:</p>\n<ul>\n<li>电子商务平台如 Magento、WooCommerce 和 Shopify 使用 MySQL 来管理产品信息、订单、客户数据等。</li>\n</ul>\n</li>\n<li><p><strong>数据分析</strong>:</p>\n<ul>\n<li>MySQL 可以用于数据分析和商业智能（BI），通过与工具如 Tableau、Power BI 和 Excel 集成，帮助企业做出数据驱动的决策。</li>\n</ul>\n</li>\n<li><p><strong>企业应用</strong>:</p>\n<ul>\n<li>企业资源计划（ERP）、客户关系管理（CRM）和其他企业级应用程序常常使用 MySQL 作为其数据库后端。</li>\n</ul>\n</li>\n<li><p><strong>高可用性和扩展性</strong>:</p>\n<ul>\n<li>MySQL 支持复制和集群功能，可以实现高可用性和扩展性，满足大规模应用的需求。</li>\n</ul>\n</li>\n<li><p><strong>开发和测试</strong>:</p>\n<ul>\n<li>开发人员使用 MySQL 进行应用程序开发和测试，得益于其易用性和广泛的社区支持。</li>\n</ul>\n</li>\n<li><p><strong>数据备份和恢复</strong>:</p>\n<ul>\n<li>MySQL 提供多种数据备份和恢复工具，确保数据安全和完整性。</li>\n</ul>\n</li>\n<li><p><strong>支持多种编程语言</strong>:</p>\n<ul>\n<li>MySQL 支持多种编程语言，如 Java、Python、PHP、C++ 等，方便开发者集成和使用。</li>\n</ul>\n</li>\n<li><p><strong>开源和社区支持</strong>:</p>\n<ul>\n<li>作为开源软件，MySQL 拥有庞大的用户社区，提供丰富的资源、插件和扩展，用户可以根据需要进行定制和优化。</li>\n</ul>\n</li>\n</ol>\n<p>MySQL 的广泛应用和灵活性使其成为许多企业和开发者的首选数据库管理系统。</p>\n<h4 id=\"资源需求：\"><a href=\"#资源需求：\" class=\"headerlink\" title=\"资源需求：\"></a>资源需求：</h4><ul>\n<li><strong>CPU</strong>: 4核 </li>\n<li><strong>内存</strong>:  8GB </li>\n<li><strong>存储</strong>: 1T</li>\n<li><strong>节点</strong>：2</li>\n</ul>\n<h4 id=\"网络端口\"><a href=\"#网络端口\" class=\"headerlink\" title=\"网络端口:\"></a>网络端口:</h4><p><strong>默认端口</strong></p>\n<ul>\n<li><strong>MySQL 端口</strong>：3306</li>\n<li><strong>用途：</strong><ul>\n<li><strong>客户端连接</strong>：<ul>\n<li>MySQL 客户端（如 <code>mysql</code> 命令行工具、MySQL Workbench、各种编程语言的 MySQL 驱动等）使用端口 3306 连接到 MySQL 服务器进行数据库操作，如查询、插入、更新和删除数据。</li>\n</ul>\n</li>\n<li><strong>应用程序连接</strong>：<ul>\n<li>各种应用程序（如 Web 应用、企业应用、数据分析工具等）通过端口 3306 连接到 MySQL 服务器，以访问和操作存储在数据库中的数据。</li>\n</ul>\n</li>\n<li><strong>数据库管理工具</strong>：<ul>\n<li>数据库管理工具（如 phpMyAdmin、Adminer、HeidiSQL 等）通过端口 3306 连接到 MySQL 服务器，提供图形化的数据库管理界面，方便用户进行数据库管理和维护。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h4><h5 id=\"定义主机组\"><a href=\"#定义主机组\" class=\"headerlink\" title=\"定义主机组\"></a>定义主机组</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim inventory.ini </span><br><span class=\"line\">[mysql_master]</span><br><span class=\"line\">master ansible_host=10.100.40.251</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[mysql_slave]</span><br><span class=\"line\">slave ansible_host=10.100.40.252</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"设置主机组\"><a href=\"#设置主机组\" class=\"headerlink\" title=\"设置主机组\"></a>设置主机组</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim ansible.cfg </span><br><span class=\"line\">[defaults]</span><br><span class=\"line\">inventory = ./inventory.ini</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"编写剧本\"><a href=\"#编写剧本\" class=\"headerlink\" title=\"编写剧本\"></a>编写剧本</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim mysql_cluster.yaml </span><br><span class=\"line\">---</span><br><span class=\"line\">- name: Install and configure MySQL master-slave replication</span><br><span class=\"line\">  hosts: all</span><br><span class=\"line\">  become: true</span><br><span class=\"line\">  gather_facts: false</span><br><span class=\"line\">  vars:</span><br><span class=\"line\">    mysql_pass: &quot;Kunyue@123&quot;</span><br><span class=\"line\">    repl_password: &quot;Kunyue@123&quot;</span><br><span class=\"line\">    master_ip: &quot;10.100.40.251&quot;</span><br><span class=\"line\">    mysql_repo_url: &quot;https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-5.7-community-el7-x86_64/&quot;</span><br><span class=\"line\">    mysql_gpg_key_url: &quot;https://mirrors.ustc.edu.cn/mysql-repo/RPM-GPG-KEY-mysql&quot;</span><br><span class=\"line\">    is_master: &quot;&#123;&#123; inventory_hostname == &#x27;master&#x27; &#125;&#125;&quot;</span><br><span class=\"line\">    temp_password: &quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: Ensure Python 2 is installed</span><br><span class=\"line\">      yum:</span><br><span class=\"line\">        name: python2</span><br><span class=\"line\">        state: present</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Ensure pip for Python 2 is installed</span><br><span class=\"line\">      get_url:</span><br><span class=\"line\">        url: https://bootstrap.pypa.io/pip/2.7/get-pip.py</span><br><span class=\"line\">        dest: /tmp/get-pip.py</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Install pip for Python 2</span><br><span class=\"line\">      command: python2 /tmp/get-pip.py</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Install MySQL repository</span><br><span class=\"line\">      yum_repository:</span><br><span class=\"line\">        name: mysql</span><br><span class=\"line\">        description: MySQL Community Edition</span><br><span class=\"line\">        baseurl: &quot;&#123;&#123; mysql_repo_url &#125;&#125;&quot;</span><br><span class=\"line\">        gpgcheck: no</span><br><span class=\"line\">        enabled: yes</span><br><span class=\"line\">        gpgkey: &quot;&#123;&#123; mysql_gpg_key_url &#125;&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Install MySQL packages</span><br><span class=\"line\">      yum:</span><br><span class=\"line\">        name: mysql-community-server</span><br><span class=\"line\">        state: present</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Install setuptools for Python 2</span><br><span class=\"line\">      yum:</span><br><span class=\"line\">        name: python-setuptools</span><br><span class=\"line\">        state: present</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Install PyMySQL using pip for Python 2</span><br><span class=\"line\">      pip:</span><br><span class=\"line\">        name: PyMySQL</span><br><span class=\"line\">        executable: pip2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Start MySQL service</span><br><span class=\"line\">      service:</span><br><span class=\"line\">        name: mysqld</span><br><span class=\"line\">        state: started</span><br><span class=\"line\">        enabled: yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Get temporary MySQL root password</span><br><span class=\"line\">      shell: grep &#x27;temporary password&#x27; /var/log/mysqld.log | awk &#x27;&#123;print $NF&#125;&#x27;</span><br><span class=\"line\">      register: temp_password</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Reset MySQL root password and handle expired password</span><br><span class=\"line\">      command: &gt;</span><br><span class=\"line\">        mysql --connect-expired-password -uroot -p&#123;&#123; temp_password.stdout &#125;&#125; -e &quot;ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &#x27;&#123;&#123; mysql_pass &#125;&#125;&#x27;;&quot;</span><br><span class=\"line\">      ignore_errors: yes</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Restart MySQL service</span><br><span class=\"line\">      service:</span><br><span class=\"line\">        name: mysqld</span><br><span class=\"line\">        state: restarted</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Configure MySQL master</span><br><span class=\"line\">      when: is_master</span><br><span class=\"line\">      block:</span><br><span class=\"line\">        - name: Add MySQL configuration for master</span><br><span class=\"line\">          lineinfile:</span><br><span class=\"line\">            path: /etc/my.cnf</span><br><span class=\"line\">            regexp: &#x27;^log-bin&#x27;</span><br><span class=\"line\">            line: |</span><br><span class=\"line\">              log-bin=/var/lib/mysql/master</span><br><span class=\"line\">              server-id=1</span><br><span class=\"line\">              gtid_mode=ON</span><br><span class=\"line\">              enforce_gtid_consistency=1</span><br><span class=\"line\">          notify: restart mysql</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        - name: Create replication user on master</span><br><span class=\"line\">          mysql_user:</span><br><span class=\"line\">            login_user: root</span><br><span class=\"line\">            login_password: &quot;&#123;&#123; mysql_pass &#125;&#125;&quot;</span><br><span class=\"line\">            name: slave</span><br><span class=\"line\">            password: &quot;&#123;&#123; repl_password &#125;&#125;&quot;</span><br><span class=\"line\">            priv: &quot;*.*:REPLICATION SLAVE,SUPER,RELOAD&quot;</span><br><span class=\"line\">            host: &quot;%&quot;</span><br><span class=\"line\">          environment:</span><br><span class=\"line\">            MYSQL_PWD: &quot;&#123;&#123; mysql_pass &#125;&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Configure MySQL slave</span><br><span class=\"line\">      when: not is_master</span><br><span class=\"line\">      block:</span><br><span class=\"line\">        - name: Add MySQL configuration for slave</span><br><span class=\"line\">          lineinfile:</span><br><span class=\"line\">            path: /etc/my.cnf</span><br><span class=\"line\">            regexp: &#x27;^log-bin&#x27;</span><br><span class=\"line\">            line: |</span><br><span class=\"line\">              log-bin=/var/lib/mysql/slave</span><br><span class=\"line\">              server-id=2</span><br><span class=\"line\">              gtid_mode=ON</span><br><span class=\"line\">              enforce_gtid_consistency=1</span><br><span class=\"line\">          notify: restart mysql</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        - name: Restart MySQL service</span><br><span class=\"line\">          service:</span><br><span class=\"line\">            name: mysqld</span><br><span class=\"line\">            state: restarted</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">        - name: Set master info and start replication on slave</span><br><span class=\"line\">          mysql_replication:</span><br><span class=\"line\">            login_user: root</span><br><span class=\"line\">            login_password: &quot;&#123;&#123; mysql_pass &#125;&#125;&quot;</span><br><span class=\"line\">            mode: changemaster</span><br><span class=\"line\">            master_host: &quot;&#123;&#123; master_ip &#125;&#125;&quot;</span><br><span class=\"line\">            master_user: slave</span><br><span class=\"line\">            master_password: &quot;&#123;&#123; repl_password &#125;&#125;&quot;</span><br><span class=\"line\">            master_auto_position: yes</span><br><span class=\"line\">          environment:</span><br><span class=\"line\">            MYSQL_PWD: &quot;&#123;&#123; mysql_pass &#125;&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  handlers:</span><br><span class=\"line\">    - name: restart mysql</span><br><span class=\"line\">      service:</span><br><span class=\"line\">        name: mysqld</span><br><span class=\"line\">        state: restarted</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"执行剧本\"><a href=\"#执行剧本\" class=\"headerlink\" title=\"执行剧本\"></a>执行剧本</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# ansible-playbook -i inventory.ini mysql_cluster.yaml</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"验证\"><a href=\"#验证\" class=\"headerlink\" title=\"验证\"></a>验证</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql -uroot -p&#x27;密码&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">show slave status \\G</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"更改存储目录\"><a href=\"#更改存储目录\" class=\"headerlink\" title=\"更改存储目录\"></a>更改存储目录</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 停止MySQL</span><br><span class=\"line\">systemctl stop mysqld</span><br><span class=\"line\">mkdir -p /data/mysql/data</span><br><span class=\"line\">chown -R mysql:mysql /data/mysql</span><br><span class=\"line\">chmod -R  755 /data/mysql</span><br><span class=\"line\"></span><br><span class=\"line\">vim /etc/my.cnf</span><br><span class=\"line\">datadir=/data/mysql/data\t\t#更改位置</span><br><span class=\"line\">#启动</span><br><span class=\"line\">systemctl start mysqld</span><br><span class=\"line\">#更改密码</span><br><span class=\"line\">cat /var/log/mysqld.log |grep password</span><br><span class=\"line\"></span><br><span class=\"line\">#验证目录位置</span><br><span class=\"line\">SHOW VARIABLES LIKE &#x27;datadir&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置主从</span><br><span class=\"line\">&#x27;先对时间&#x27;</span><br><span class=\"line\">firewalld \tselinux \t//关闭</span><br><span class=\"line\">vim /etc/hosts\t\t\t//hosts解析 可选项</span><br><span class=\"line\">\t192.168.116.111\tmaster</span><br><span class=\"line\">\t192.168.116.124\tslave</span><br><span class=\"line\"></span><br><span class=\"line\">完全备份,保持两台mysql数据一样</span><br><span class=\"line\">scp -r /xtrabackup/full/2023-11-10_14-18-09/ root@192.168.116.124:/</span><br><span class=\"line\"></span><br><span class=\"line\">ping一下网络连接： ping master</span><br><span class=\"line\">\t\t\t\t ping slave</span><br><span class=\"line\">实验示例：</span><br><span class=\"line\">&#x27;主&#x27;：</span><br><span class=\"line\">vim /etc/my.cnf</span><br><span class=\"line\">log-bin=/var/lib/mysql/master</span><br><span class=\"line\">server-id=1 \t\t//ID号需要跟从的配置不一样</span><br><span class=\"line\">gtid_mode=ON</span><br><span class=\"line\">enforce_gtid_consistency=1</span><br><span class=\"line\"></span><br><span class=\"line\"># 进入MySQL里面</span><br><span class=\"line\">grant replication slave,super,reload on *.* to slave@&#x27;%&#x27; identified by &#x27;Qingfeng123!&#x27;;</span><br><span class=\"line\">flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;从&#x27;：</span><br><span class=\"line\">vim /etc/my.cnf</span><br><span class=\"line\">log-bin=/var/lib/mysql/slave</span><br><span class=\"line\">server-id=2 \t\t//ID号需要跟主的配置不一样</span><br><span class=\"line\">gtid_mode=ON</span><br><span class=\"line\">enforce_gtid_consistency=1</span><br><span class=\"line\"></span><br><span class=\"line\"># master_host=&#x27;master&#x27;</span><br><span class=\"line\"># 如果没有hosts没有解析，解析ip，已经解析了就写master</span><br><span class=\"line\">change master to master_host=&#x27;master&#x27;,master_user=&#x27;slave&#x27;,master_password=&#x27;Qingfeng@123&#x27;,master_auto_position=1;</span><br><span class=\"line\">start slave;</span><br><span class=\"line\">show slave status\\G</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;互为主从&#x27;</span><br><span class=\"line\">从：grant replication slave,super,reload on *.* to slave@&#x27;%&#x27; identified by &#x27;Qingfeng123!&#x27;;</span><br><span class=\"line\">flush privileges;</span><br><span class=\"line\">主:change master to master_host=&#x27;slave&#x27;,master_user=&#x27;slave&#x27;,master_password=&#x27;Qingfeng@123&#x27;,master_auto_position=1;</span><br><span class=\"line\">start slave;</span><br><span class=\"line\">show slave status\\G</span><br><span class=\"line\">验证：</span><br><span class=\"line\">主上写数据</span><br><span class=\"line\">从上面读数据</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"设置主从\"><a href=\"#设置主从\" class=\"headerlink\" title=\"设置主从\"></a>设置主从</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 主节点</span><br><span class=\"line\">grant replication slave,super,reload on *.* to slave@&#x27;%&#x27; identified by &#x27;123456&#x27;;</span><br><span class=\"line\">flush privileges;</span><br><span class=\"line\"></span><br><span class=\"line\">#从节点</span><br><span class=\"line\">change master to master_host=&#x27;10.100.40.171&#x27;,master_user=&#x27;slave&#x27;,master_password=&#x27;123456&#x27;,master_auto_position=1;</span><br><span class=\"line\">start slave;</span><br><span class=\"line\">show slave status\\G</span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Mysql","Ansible"]},{"title":"docker--harbor私有仓库部署","url":"/2025/11/06/docker-harbor%E7%A7%81%E6%9C%89%E4%BB%93%E5%BA%93%E9%83%A8%E7%BD%B2/","content":"<h2 id=\"部署harbor–方式一\"><a href=\"#部署harbor–方式一\" class=\"headerlink\" title=\"部署harbor–方式一\"></a>部署harbor–方式一</h2><p><code>部署环境  关闭防火墙</code></p>\n<h2 id=\"下载harbor包\"><a href=\"#下载harbor包\" class=\"headerlink\" title=\"下载harbor包\"></a>下载harbor包</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/docker/harbor-online-installer-v2.10.0.tgz</span><br></pre></td></tr></table></figure>\n<h2 id=\"下载docker-compose\"><a href=\"#下载docker-compose\" class=\"headerlink\" title=\"下载docker-compose\"></a>下载docker-compose</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br></pre></td></tr></table></figure>\n<h2 id=\"授权\"><a href=\"#授权\" class=\"headerlink\" title=\"授权\"></a>授权</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@iZ8vb3lp570ckxi53yb66gZ ~]</span><span class=\"comment\"># chmod +x /usr/local/bin/docker-compose</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"解压\"><a href=\"#解压\" class=\"headerlink\" title=\"解压\"></a>解压</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kub-k8s-master ~]</span><span class=\"comment\"># tar xf harbor-offline-installer-v1.8.0.tgz</span></span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master ~]</span><span class=\"comment\"># cd harbor</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"http访问方式的配置：\"><a href=\"#http访问方式的配置：\" class=\"headerlink\" title=\"http访问方式的配置：\"></a>http访问方式的配置：</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kub-k8s-master harbor]</span><span class=\"comment\"># cp harbor.yml.tmpl  harbor.yml</span></span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master harbor]</span><span class=\"comment\"># vim harbor.yml #使用IP地址,需要修改的内容如下</span></span><br><span class=\"line\">hostname: 192.168.246.166  <span class=\"comment\">#改成自己的ip</span></span><br><span class=\"line\">注释443的模块</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master harbor]</span><span class=\"comment\"># ./prepare  #需要等待下载镜像</span></span><br><span class=\"line\">\t\t\t\t\t\t或   ./install.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"docker-compose-使用\"><a href=\"#docker-compose-使用\" class=\"headerlink\" title=\"docker-compose 使用\"></a>docker-compose 使用</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@kub-k8s-master harbor]</span><span class=\"comment\"># docker-compose up -d  #放后台</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master harbor]</span><span class=\"comment\"># docker-compose down #停止服务</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"浏览器访问测试：\"><a href=\"#浏览器访问测试：\" class=\"headerlink\" title=\"浏览器访问测试：\"></a>浏览器访问测试：</h2><p><code>http://10.31.162.25</code><br><code>账号admin  密码Harbor12345</code></p>\n<h2 id=\"设置域名\"><a href=\"#设置域名\" class=\"headerlink\" title=\"设置域名\"></a>设置域名</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置域名，并通过反向代理docker客户端</span><br><span class=\"line\">1、网站--创建网站--定义域名</span><br><span class=\"line\">2、网站--证书--申请证书</span><br><span class=\"line\">3、网站--创建好的网站--HTTPS--启用 HTTPS</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"上传镜像\"><a href=\"#上传镜像\" class=\"headerlink\" title=\"上传镜像\"></a>上传镜像</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在终端上登入</span></span><br><span class=\"line\">docker login IP地址</span><br><span class=\"line\"></span><br><span class=\"line\">推送</span><br><span class=\"line\"><span class=\"comment\">#在项目中标记镜像：</span></span><br><span class=\"line\">现在终端上给要上传的镜像打标记tag</span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\">#docker tag mysql：5.7 har.xbd666.cn/qingfeng/mysql：5.7</span></span><br><span class=\"line\"><span class=\"comment\">#推送到仓库</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\">#docker push 120.27.128.132:81/qingfeng/REPOSITORY[:TAG]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 备注</span></span><br><span class=\"line\">如果出现413</span><br><span class=\"line\">error parsing HTTP 413 response body: invalid character &#x27;&lt;&#x27; looking for beginning of value</span><br><span class=\"line\">回到1panel上做设置</span><br><span class=\"line\">1panel网址--网站--设置--性能调优--client_max_body_size（这里改成0）</span><br><span class=\"line\">或者 在nginx配置文件里更改最大上传文件大小值</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"下载镜像\"><a href=\"#下载镜像\" class=\"headerlink\" title=\"下载镜像\"></a>下载镜像</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# docker push har.xbd666.cn/qingfeng/mysql：5.7</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"https://xbd666.cn/upload/harbor1.webp\" alt=\"harbor1.webp\"></p>\n<h2 id=\"部署harbor–方式二\"><a href=\"#部署harbor–方式二\" class=\"headerlink\" title=\"部署harbor–方式二\"></a>部署harbor–方式二</h2><h2 id=\"构建环境\"><a href=\"#构建环境\" class=\"headerlink\" title=\"构建环境\"></a>构建环境</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">setenforce 0</span><br><span class=\"line\">yum -y install vim wget net-tools lrzsz </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"下载docker\"><a href=\"#下载docker\" class=\"headerlink\" title=\"下载docker\"></a>下载docker</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#删除已安装的Docker</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># yum remove docker \\</span></span><br><span class=\"line\">docker-client \\</span><br><span class=\"line\">docker-client-latest \\</span><br><span class=\"line\">docker-common \\</span><br><span class=\"line\">docker-latest \\</span><br><span class=\"line\">docker-latest-logrotate \\</span><br><span class=\"line\">docker-logrotate \\</span><br><span class=\"line\">docker-selinux \\</span><br><span class=\"line\">docker-engine-selinux \\</span><br><span class=\"line\">docker-engine</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置阿里云Docker Yum源</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看docker版本</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># yum list docker-ce --showduplicates</span></span><br><span class=\"line\">或</span><br><span class=\"line\">docker -v  或  dockers version</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装Docker新版本或指定版本号</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># yum install -y docker-ce</span></span><br><span class=\"line\">或 </span><br><span class=\"line\">yum install docker-ce-18.03.0.ce  -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动Docker服务：</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置Docker-加速器\"><a href=\"#配置Docker-加速器\" class=\"headerlink\" title=\"配置Docker 加速器\"></a>配置Docker 加速器</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># vim /etc/docker/daemon.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&quot;registry-mirrors&quot;: <span class=\"section\">[&quot;https://br003st4.mirror.aliyuncs.com&quot;]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"部署私有仓库–harbor\"><a href=\"#部署私有仓库–harbor\" class=\"headerlink\" title=\"部署私有仓库–harbor\"></a>部署私有仓库–harbor</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">cwget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/docker/harbor-offline-installer-v1.8.0.tgz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#下载docker-compose</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># curl -L https://github.7boe.top/https://github.com/docker/compose/releases/download/1.22.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 给予执行权限</span></span><br><span class=\"line\"><span class=\"comment\">#[root@localhost ~]# mv docker-compose-Linux-x86_64 docker-compose</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># chmod +x /usr/local/bin/docker-compose</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 解压harbor仓库</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># tar xf harbor-offline-installer-v1.8.0.tgz</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># cd harbor</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># http访问方式的配置：</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost harbor]</span><span class=\"comment\"># vim harbor.yml\t\t#使用IP地址,需要修改的内容如下</span></span><br><span class=\"line\">hostname: 10.31.162.39  <span class=\"comment\">#改成自己的ip</span></span><br><span class=\"line\"><span class=\"comment\">#注释443的模块</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@localhost harbor]</span><span class=\"comment\"># ./install.sh  #需要等待下载镜像</span></span><br><span class=\"line\">\t\t\t\t\t\t\t或  ./prepare </span><br><span class=\"line\">\t\t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"comment\"># docker-compose 使用</span></span><br><span class=\"line\"><span class=\"comment\">#[root@localhost harbor]#docker-compose up -d  #放后台</span></span><br><span class=\"line\"><span class=\"comment\">#[root@localhost harbor]#docker-compose down #停止服务</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"浏览器访问测试：-1\"><a href=\"#浏览器访问测试：-1\" class=\"headerlink\" title=\"浏览器访问测试：\"></a>浏览器访问测试：</h2><p><code>http://10.31.162.39</code></p>\n<p>然后在web界面新建项目，自定义名字</p>\n<h2 id=\"客户端配置连接仓库地址\"><a href=\"#客户端配置连接仓库地址\" class=\"headerlink\" title=\"客户端配置连接仓库地址\"></a>客户端配置连接仓库地址</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># vim /etc/docker/daemon.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&quot;insecure-registries&quot;: <span class=\"section\">[&quot;39.98.169.219&quot;]</span>  <span class=\"comment\">#仓库的ip地址 </span></span><br><span class=\"line\">&#125;\t<span class=\"comment\">#在镜像加速器下面添加时，要做镜像加速器代码后面添加逗号（,）作为分割</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># systemctl restart docker</span></span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># docker-compose up -d #启动harbor仓库</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"终端登入仓库\"><a href=\"#终端登入仓库\" class=\"headerlink\" title=\"终端登入仓库\"></a>终端登入仓库</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># docker login 10.31.162.39</span></span><br><span class=\"line\">Username: admin</span><br><span class=\"line\">Password: Hardor12345</span><br><span class=\"line\">Login Succeeded  \t<span class=\"comment\">#代表登入成功</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 将生成的jspgou镜像上传到仓库中</span></span><br><span class=\"line\">先打标签</span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># docker tag nginx:latest 10.31.162.39/qingfeng/nginx:1.1</span></span><br><span class=\"line\">上传镜像</span><br><span class=\"line\"><span class=\"section\">[root@localhost ~]</span><span class=\"comment\"># docker push 10.31.162.39/qingfeng/nginx:1.1</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/upload/harbor2.webp\" alt=\"harbor2.webp\"></p>\n","categories":["operations"],"tags":["Linux","Docker"]},{"title":"docker 下载及配置镜像加速器","url":"/2025/11/06/docker-%E4%B8%8B%E8%BD%BD%E5%8F%8A%E9%85%8D%E7%BD%AE%E9%95%9C%E5%83%8F%E5%8A%A0%E9%80%9F%E5%99%A8/","content":"<h2 id=\"docker下载安装\"><a href=\"#docker下载安装\" class=\"headerlink\" title=\"docker下载安装\"></a>docker下载安装</h2><h3 id=\"卸载旧版本\"><a href=\"#卸载旧版本\" class=\"headerlink\" title=\"卸载旧版本\"></a>卸载旧版本</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum remove docker \\</span><br><span class=\"line\">                  docker-client \\</span><br><span class=\"line\">                  docker-client-latest \\</span><br><span class=\"line\">                  docker-common \\</span><br><span class=\"line\">                  docker-latest \\</span><br><span class=\"line\">                  docker-latest-logrotate \\</span><br><span class=\"line\">                  docker-logrotate \\</span><br><span class=\"line\">                  docker-engine</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装依赖包\"><a href=\"#安装依赖包\" class=\"headerlink\" title=\"安装依赖包\"></a>安装依赖包</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">sudo yum install -y yum-utils</span><br></pre></td></tr></table></figure>\n<h3 id=\"设置镜像仓库\"><a href=\"#设置镜像仓库\" class=\"headerlink\" title=\"设置镜像仓库\"></a>设置镜像仓库</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 1）官方镜像源</span><br><span class=\"line\">sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class=\"line\"># 2）阿里云镜像源</span><br><span class=\"line\">sudo yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n<h3 id=\"更新-yum-软件包索引\"><a href=\"#更新-yum-软件包索引\" class=\"headerlink\" title=\"更新 yum 软件包索引\"></a>更新 yum 软件包索引</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum makecache fast</span><br></pre></td></tr></table></figure>\n<h3 id=\"下载-docker-依赖包\"><a href=\"#下载-docker-依赖包\" class=\"headerlink\" title=\"下载 docker 依赖包\"></a>下载 docker 依赖包</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>\n<h3 id=\"启动-docker\"><a href=\"#启动-docker\" class=\"headerlink\" title=\"启动 docker\"></a>启动 docker</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl start docker</span><br></pre></td></tr></table></figure>\n<h3 id=\"查看版本号\"><a href=\"#查看版本号\" class=\"headerlink\" title=\"查看版本号\"></a>查看版本号</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker version</span><br></pre></td></tr></table></figure>\n<h3 id=\"测试-hello-world\"><a href=\"#测试-hello-world\" class=\"headerlink\" title=\"测试 hello-world\"></a>测试 hello-world</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker run hello-world</span><br></pre></td></tr></table></figure>\n<h3 id=\"查看-hello-world-镜像\"><a href=\"#查看-hello-world-镜像\" class=\"headerlink\" title=\"查看 hello-world 镜像\"></a>查看 hello-world 镜像</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@iZbp1guc0wov85gocdqeaiZ ~]# docker images</span><br><span class=\"line\">REPOSITORY    TAG       IMAGE ID       CREATED        SIZE</span><br><span class=\"line\">hello-world   latest    9c7a54a9a43c   6 months ago   13.3kB</span><br></pre></td></tr></table></figure>\n<h3 id=\"卸载-docker（共3步）\"><a href=\"#卸载-docker（共3步）\" class=\"headerlink\" title=\"卸载 docker（共3步）\"></a>卸载 docker（共3步）</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum remove docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin docker-ce-rootless-extras   //卸载依赖包</span><br><span class=\"line\">rm -rf /var/lib/docker\t//docker默认工作路径</span><br><span class=\"line\">rm -rf /var/lib/containerd</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置镜像加速器\"><a href=\"#配置镜像加速器\" class=\"headerlink\" title=\"配置镜像加速器\"></a>配置镜像加速器</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">登入aliyun，找到容器镜像加速器</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">您可以通过修改daemon配置文件/etc/docker/daemon.json来使用加速器</span></span><br><span class=\"line\">mkdir -p /etc/docker</span><br><span class=\"line\">tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;registry-mirrors&quot;: [&quot;https://8zc4xpn2.mirror.aliyuncs.com&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h3 id=\"重启-docker-服务\"><a href=\"#重启-docker-服务\" class=\"headerlink\" title=\"重启 docker 服务\"></a>重启 docker 服务</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload\t\t//重启镜像</span><br><span class=\"line\">systemctl restart docker\t//重启docker</span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Docker"]},{"title":"docker-偌依 项目部署","url":"/2025/11/06/docker-%E5%81%8C%E4%BE%9D-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/","content":"<h1 id=\"配置环境\"><a href=\"#配置环境\" class=\"headerlink\" title=\"配置环境\"></a>配置环境</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置jenkins与前端服务器与git连接</span><br><span class=\"line\"></span><br><span class=\"line\">10.31.162.25\tnginx-server</span><br><span class=\"line\">10.31.162.32\tjava-server</span><br><span class=\"line\">10.31.162.35\tjenkinx-server</span><br><span class=\"line\">10.31.162.39\tmysql-redis-server</span><br><span class=\"line\">10.31.162.124\thaobor-server</span><br><span class=\"line\">10.31.162.125\tgit-server</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装前端服务器\"><a href=\"#安装前端服务器\" class=\"headerlink\" title=\"安装前端服务器\"></a>安装前端服务器</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">10.31.162.25\tnginx-server</span><br><span class=\"line\">安装docker</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2 git</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># yum install -y docker-ce</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># mkdir /application/nginx/&#123;logs,html&#125; -p #创建工作目录</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># docker pull daocloud.io/library/nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\">先运行一次容器（为了拷贝配置文件）：</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># docker run -itd --name nginx-1 -p 80:80 daocloud.io/library/nginx</span></span><br><span class=\"line\">将容器内nginx的配置文件拷贝到宿主机上面</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># docker  cp web-nginx:/etc/nginx /application/nginx/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cd /application/nginx/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server nginx]</span><span class=\"comment\"># ll</span></span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxr-xr-x 2 root root   6 May 14 00:37 html</span><br><span class=\"line\">drwxr-xr-x 2 root root   6 May 14 00:37 logs</span><br><span class=\"line\">drwxr-xr-x 3 root root 177 Feb  9  2021 nginx</span><br><span class=\"line\"><span class=\"comment\"># 改名</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server nginx]</span><span class=\"comment\"># mv nginx/ conf </span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server nginx]</span><span class=\"comment\"># ll</span></span><br><span class=\"line\">total 0</span><br><span class=\"line\">drwxr-xr-x 3 root root 177 Feb  9  2021 conf</span><br><span class=\"line\">drwxr-xr-x 2 root root   6 May 14 00:37 html</span><br><span class=\"line\">drwxr-xr-x 2 root root   6 May 14 00:37 logs</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server nginx]</span><span class=\"comment\"># cd conf/conf.d/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server conf.d]</span><span class=\"comment\"># cp default.conf default.conf.bak</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server conf.d]</span><span class=\"comment\"># mv default.conf app.conf</span></span><br><span class=\"line\"><span class=\"comment\"># 配置负载均衡</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server conf.d]</span><span class=\"comment\"># cat upstream.conf </span></span><br><span class=\"line\">upstream java-web &#123;</span><br><span class=\"line\">\tserver 10.31.162.32:8080<span class=\"comment\">;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server conf.d]</span><span class=\"comment\"># cat app.conf </span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80<span class=\"comment\">;</span></span><br><span class=\"line\">    listen  <span class=\"section\">[::]</span>:80<span class=\"comment\">;</span></span><br><span class=\"line\">    server_name  localhost<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">#charset koi8-r;</span></span><br><span class=\"line\">    <span class=\"comment\">#access_log  /var/log/nginx/host.access.log  main;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        root   /usr/share/nginx/html<span class=\"comment\">;</span></span><br><span class=\"line\">\ttry_files $uri $uri/ /index.html<span class=\"comment\">;</span></span><br><span class=\"line\">        index  index.html index.htm<span class=\"comment\">;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location /prod-api/&#123;</span><br><span class=\"line\">      proxy_pass http://java-web/<span class=\"comment\">;</span></span><br><span class=\"line\">      proxy_set_header Host $http_host<span class=\"comment\">;</span></span><br><span class=\"line\">      proxy_set_header X-Real-IP $remote_addr<span class=\"comment\">;</span></span><br><span class=\"line\">      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class=\"comment\">;</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">停止并删除容器</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># docker stop web-nginx </span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\">#docker rm web-nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\">创建启动脚本</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># mkdir /opt/script</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cat /opt/script/updata-nginx.sh </span></span><br><span class=\"line\">nginx.sh </span><br><span class=\"line\"><span class=\"comment\">#!/usr/bin/bash</span></span><br><span class=\"line\"><span class=\"attr\">up_path</span>=/root/upload/</span><br><span class=\"line\"><span class=\"attr\">code</span>=*.tar.gz</span><br><span class=\"line\"><span class=\"attr\">src</span>=/application/nginx/html</span><br><span class=\"line\"><span class=\"attr\">docker_name</span>=web-nginx</span><br><span class=\"line\"></span><br><span class=\"line\">docker login -uadmin -p&#x27;Harbor12345&#x27; 10.31.162.124</span><br><span class=\"line\">cd $up_path</span><br><span class=\"line\">tar xzf $code -C $src</span><br><span class=\"line\">cd $src &amp;&amp; chmod 777 * -R</span><br><span class=\"line\">if <span class=\"section\">[ $? -eq 0 ]</span><span class=\"comment\">;then</span></span><br><span class=\"line\">\tdocker run -itd <span class=\"attr\">--restart</span>=always --name web-nginx -p <span class=\"number\">80</span>:<span class=\"number\">80</span> -v /application/nginx/html/:/usr/share/nginx/html -v /application/nginx/logs/:/var/log/nginx/ -v /application/nginx/conf:/etc/nginx <span class=\"number\">10.31</span>.<span class=\"number\">162.124</span>/nginx/mynginx:v1.<span class=\"number\">0</span></span><br><span class=\"line\">\tsleep 1</span><br><span class=\"line\">\tif <span class=\"section\">[ $? -eq 0 ]</span><span class=\"comment\">;then</span></span><br><span class=\"line\">\t\techo &quot;nginx is started&quot;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\techo &quot;启动失败,请手动处理&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\">else</span><br><span class=\"line\">\techo &quot;解压失败&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\">chmod 777 $src/ -R</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 赋予权限</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># chmod +x /opt/script/updata-nginx.sh</span></span><br><span class=\"line\">配置连接harbor仓库地址</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># vim /etc/docker/daemon.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&quot;insecure-registries&quot;: <span class=\"section\">[&quot;192.168.209.166&quot;]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># systemctl restart docker</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装mysql与redis\"><a href=\"#安装mysql与redis\" class=\"headerlink\" title=\"安装mysql与redis\"></a>安装mysql与redis</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">10.31.162.39\tmysql-redis-server</span><br><span class=\"line\">1.安装redis</span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># wget https://download.redis.io/releases/redis-7.0.9.tar.gz</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># tar xzvf redis-7.0.9.tar.gz -C /usr/local/</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># mv /usr/local/redis-7.0.9/ /usr/local/redis</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># cd /usr/local/redis/</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis redis]</span><span class=\"comment\"># yum install -y gcc make</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis redis]</span><span class=\"comment\"># make</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis redis]</span><span class=\"comment\"># vim redis.conf</span></span><br><span class=\"line\">bind 10.31.162.39　　<span class=\"comment\">#只监听内网IP</span></span><br><span class=\"line\">daemonize yes　　　　　<span class=\"comment\">#开启后台模式将on改为yes</span></span><br><span class=\"line\">port 6379                      <span class=\"comment\">#端口号</span></span><br><span class=\"line\">protected-mode no    <span class=\"comment\">#将加密保护模式关闭</span></span><br><span class=\"line\"></span><br><span class=\"line\">启动redis</span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis redis]</span><span class=\"comment\"># src/redis-server redis.conf &amp;</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis redis]</span><span class=\"comment\"># netstat -lntp | grep 6379</span></span><br><span class=\"line\">tcp        0      0 192.168.209.159:6379    0.0.0.0:*               LISTEN      5770/src/redis-serv</span><br><span class=\"line\"></span><br><span class=\"line\">2.安装mysql</span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># wget https://dev.mysql.com/get/mysql80-community-release-el7-7.noarch.rpm</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># rpm -ivh mysql80-community-release-el7-7.noarch.rpm</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># vim /etc/yum.repos.d/mysql-community.repo</span></span><br><span class=\"line\">将8.0关闭，将5.7开启</span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># yum install -y mysql-community-server</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># systemctl start mysqld</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># systemctl enable mysqld</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># grep pass /var/log/mysqld.log </span></span><br><span class=\"line\">2023-05-09T12:37:58.805419Z 1 <span class=\"section\">[Note]</span> A temporary password is generated for root@localhost: :h,=.RRr28kt</span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># mysqladmin -uroot -p&#x27;:h,=.RRr28kt&#x27; password &#x27;QianFeng@123!&#x27;</span></span><br><span class=\"line\"><span class=\"section\">[root@mysql-redis ~]</span><span class=\"comment\"># mysql -uroot -p&#x27;QianFeng@123!&#x27;</span></span><br><span class=\"line\">mysql: <span class=\"section\">[Warning]</span> Using a password on the command line interface can be insecure.</span><br><span class=\"line\">Welcome to the MySQL monitor.  Commands end with <span class=\"comment\">; or \\g.</span></span><br><span class=\"line\">Your MySQL connection id is 3</span><br><span class=\"line\">Server version: 5.7.31 MySQL Community Server (GPL)</span><br><span class=\"line\">...</span><br><span class=\"line\">创建数据库ry</span><br><span class=\"line\">mysql&gt; create database ry character set utf8 collate  utf8_general_ci<span class=\"comment\">;</span></span><br><span class=\"line\">Query OK, 1 row affected (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">设置root允许远程登录</span><br><span class=\"line\">mysql&gt; update mysql.user set <span class=\"attr\">host</span> = <span class=\"string\">&#x27;%&#x27;</span> where user = <span class=\"string\">&#x27;root&#x27;</span><span class=\"comment\">;</span></span><br><span class=\"line\">Query OK, 1 row affected (0.10 sec)</span><br><span class=\"line\">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; flush privileges<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; \\q</span><br><span class=\"line\">Bye</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"git-server获取代码\"><a href=\"#git-server获取代码\" class=\"headerlink\" title=\"git-server获取代码\"></a>git-server获取代码</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">10.31.162.125\tgit-server</span><br><span class=\"line\"><span class=\"comment\"># 配置git</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># git config --global user.email &quot;soho@163.com&quot;</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># git config --global user.name &quot;soho&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#[root@git-server ~]# git clone https://gitee.com/y_project/RuoYi-Vue.git</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/RuoYi-Vue-master.zip</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># mv RuoYi-Vue-master/\tRuoYi-Vue</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># cd RuoYi-Vue/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server RuoYi-Vue]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">bin      pom.xml      ruoyi-common     ruoyi-quartz  ry.bat</span><br><span class=\"line\">doc      README.md    ruoyi-framework  ruoyi-system  ry.sh</span><br><span class=\"line\">LICENSE  ruoyi-admin  ruoyi-generator  ruoyi-ui      sql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 进行后端数据库与redis的配置</span></span><br><span class=\"line\">1.先配置连接redis服务</span><br><span class=\"line\"><span class=\"section\">[root@git-server RuoYi-Vue]</span><span class=\"comment\"># cd ruoyi-admin/src/main/resources/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server resources]</span><span class=\"comment\"># vim application.yml</span></span><br><span class=\"line\"><span class=\"comment\"># redis 配置</span></span><br><span class=\"line\">  redis:</span><br><span class=\"line\">    <span class=\"comment\"># 地址--MySQL的IP地址</span></span><br><span class=\"line\">    host: 10.31.162.39</span><br><span class=\"line\">    <span class=\"comment\"># 端口，默认为6379</span></span><br><span class=\"line\">    port: 6379</span><br><span class=\"line\">    <span class=\"comment\"># 密码</span></span><br><span class=\"line\">    password:</span><br><span class=\"line\">    </span><br><span class=\"line\">2.修改mysql</span><br><span class=\"line\"><span class=\"section\">[root@git-server resources]</span><span class=\"comment\"># vim application-druid.yml</span></span><br><span class=\"line\"><span class=\"comment\"># 数据源配置</span></span><br><span class=\"line\">spring:</span><br><span class=\"line\">    datasource:</span><br><span class=\"line\">        type: com.alibaba.druid.pool.DruidDataSource</span><br><span class=\"line\">        driverClassName: com.mysql.cj.jdbc.Driver</span><br><span class=\"line\">        druid:</span><br><span class=\"line\">            <span class=\"comment\"># 主库数据源</span></span><br><span class=\"line\">            master:</span><br><span class=\"line\">                url: jdbc:mysql://10.31.162.39:3306/ry?<span class=\"attr\">useUnicode</span>=<span class=\"literal\">true</span>&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull&amp;useSSL=<span class=\"literal\">true</span>&amp;serverTimezone=GMT%<span class=\"number\">2</span>B8</span><br><span class=\"line\">                username: root</span><br><span class=\"line\">                password: QianFeng@123!</span><br><span class=\"line\">                </span><br><span class=\"line\">同时注意数据库连接这里是否启动加密连接，如果启用了加密连接有可能会造成代码与数据库连接不上。修改为:</span><br><span class=\"line\">&amp;<span class=\"attr\">useSSL</span>=<span class=\"literal\">false</span>&amp;</span><br><span class=\"line\"></span><br><span class=\"line\">配置完成</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#导入数据给创建的数据库里面</span></span><br><span class=\"line\">安装mysql客户端</span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># yum install -y mysql</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># cd RuoYi-Vue/sql/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server sql]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">quartz.sql  ry_20230223.sql</span><br><span class=\"line\"><span class=\"section\">[root@git-server sql]</span><span class=\"comment\"># mysql -uroot -p&#x27;Qianfeng@123&#x27; -h 10.31.162.39 -D ry &lt; quartz.sql </span></span><br><span class=\"line\"><span class=\"section\">[root@git-server sql]</span><span class=\"comment\"># mysql -uroot -p&#x27;Qianfeng@123&#x27; -h 10.31.162.39 -D  ry &lt; ry_20230223.sql</span></span><br><span class=\"line\"></span><br><span class=\"line\">开始创建版本库</span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># mkdir /git-server</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># useradd git</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># passwd git</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># cd /git-server/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server git-server]</span><span class=\"comment\"># git init --bare ryvue</span></span><br><span class=\"line\">Initialized empty Git repository in /git-server/ryvue/</span><br><span class=\"line\"><span class=\"section\">[root@git-server git-server]</span><span class=\"comment\"># git init --bare ryjava</span></span><br><span class=\"line\">Initialized empty Git repository in /git-server/ryjava/</span><br><span class=\"line\"><span class=\"section\">[root@git-server git-server]</span><span class=\"comment\"># chown git.git /git-server/ -R</span></span><br><span class=\"line\"></span><br><span class=\"line\">在本机将两个仓库克隆下来进行代码提交：</span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># ssh-keygen</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># ssh-copy-id git@10.31.162.125  与自己的git用户配置免密</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># git clone git@10.31.162.125:/git-server/ryvue/</span></span><br><span class=\"line\">Cloning into &#x27;ryvue&#x27;...</span><br><span class=\"line\">warning: You appear to have cloned an empty repository.</span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># git clone git@10.31.162.125:/git-server/ryjava</span></span><br><span class=\"line\">Cloning into &#x27;ryjava&#x27;...</span><br><span class=\"line\">warning: You appear to have cloned an empty repository.</span><br><span class=\"line\"></span><br><span class=\"line\">将代码提交到相应的代码库中</span><br><span class=\"line\">注:在这里没有办法区分前端和后端打包时需要的依赖，顾将所有代码都拷贝到两个版本库中。</span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># cd ryvue/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryvue]</span><span class=\"comment\"># cp -r /root/RuoYi-Vue/ruoyi-ui/* .</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryvue]</span><span class=\"comment\"># cd ../ryjava/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryjava]</span><span class=\"comment\"># cp -r /root/RuoYi-Vue/* .</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryjava]</span><span class=\"comment\"># git add -A</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryjava]</span><span class=\"comment\"># git commit -m &quot;add 1&quot;</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryjava]</span><span class=\"comment\"># git push origin master</span></span><br><span class=\"line\"></span><br><span class=\"line\">在编写后端的Dockerfile</span><br><span class=\"line\"><span class=\"section\">[root@git-server ryjava]</span><span class=\"comment\"># cat Dockerfile </span></span><br><span class=\"line\">FROM 10.31.162.124/myjdk/my-jdk:v1.0</span><br><span class=\"line\"></span><br><span class=\"line\">WORKDIR /application/app</span><br><span class=\"line\"></span><br><span class=\"line\">ADD ruoyi-admin/target/*.jar /application/app</span><br><span class=\"line\"></span><br><span class=\"line\">EXPOSE 8080</span><br><span class=\"line\"></span><br><span class=\"line\">ENTRYPOINT <span class=\"section\">[&quot;java&quot;,&quot;-jar&quot;,&quot;ruoyi-admin.jar&quot;]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryjava]</span><span class=\"comment\"># git add Dockerfile </span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryjava]</span><span class=\"comment\"># git commit -m &quot;docker 1&quot;</span></span><br><span class=\"line\"><span class=\"section\">[master 76f71f4]</span> docker 1</span><br><span class=\"line\"> 1 file changed, 1 insertion(+), 1 deletion(-)</span><br><span class=\"line\"><span class=\"section\">[root@git-server ryjava]</span><span class=\"comment\"># git push origin master</span></span><br><span class=\"line\">Counting objects: 5, done.</span><br><span class=\"line\">Compressing objects: 100% (3/3), done.</span><br><span class=\"line\">Writing objects: 100% (3/3), 294 bytes | 0 bytes/s, done.</span><br><span class=\"line\">Total 3 (delta 2), reused 0 (delta 0)</span><br><span class=\"line\">To git@192.168.209.160:/git-server/ryjava/</span><br><span class=\"line\">   2b539ad..76f71f4  master -&gt; master</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryjava]</span><span class=\"comment\"># cd ../ryvue/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryvue]</span><span class=\"comment\"># git add -A</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryvue]</span><span class=\"comment\"># git commit -m &quot;add 2&quot;</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ryvue]</span><span class=\"comment\"># git push origin master</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装harbor仓库\"><a href=\"#安装harbor仓库\" class=\"headerlink\" title=\"安装harbor仓库\"></a>安装harbor仓库</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">10.31.162.124\thaobor-server</span><br><span class=\"line\">安装docker</span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2</span></span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># yum install -y docker-ce</span></span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># wget https://storage.googleapis.com/harbor-releases/release-1.8.0/harbor-offline-installer-v1.8.0.tgz</span></span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># yum -y install  lrzsz</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># curl -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># chmod +x /usr/local/bin/docker-compose</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># tar xf harbor-offline-installer-v1.8.0.tgz</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@harbor ~]</span><span class=\"comment\"># cd harbor</span></span><br><span class=\"line\"></span><br><span class=\"line\">http访问方式的配置：</span><br><span class=\"line\"><span class=\"section\">[root@harbor harbor]</span><span class=\"comment\"># vim harbor.yml #主机名要可以解析(需要部署dns服务器，用/etc/hosts文件没有用)，如果不可以解析，可以使用IP地址,需要修改的内容如下</span></span><br><span class=\"line\">hostname: 10.31.162.124</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@harbor harbor]</span><span class=\"comment\"># ./install.sh  #需要等待下载镜像</span></span><br><span class=\"line\"><span class=\"section\">[root@harbor-server harbor]</span><span class=\"comment\"># docker-compose up -d</span></span><br><span class=\"line\">浏览器访问测试：</span><br><span class=\"line\">http://10.31.162.124</span><br><span class=\"line\">用户名admin 密码:Harbor12345</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@harbor harbor]</span><span class=\"comment\"># docker login -uadmin -p&#x27;Harbor12345&#x27; 10.31.162.124</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建项目仓库\"><a href=\"#创建项目仓库\" class=\"headerlink\" title=\"创建项目仓库\"></a>创建项目仓库</h1><p><img src=\"/upload/docker-ruoyi1.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<h1 id=\"jenkins服务器\"><a href=\"#jenkins服务器\" class=\"headerlink\" title=\"jenkins服务器\"></a>jenkins服务器</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">10.31.162.35\tjenkinx-server</span><br><span class=\"line\">1.安装jenkins 略</span><br><span class=\"line\">2.配置jenkins免密连接git、nginx、java服务器--略</span><br><span class=\"line\"></span><br><span class=\"line\">安装git命令</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># yum install git -y</span></span><br><span class=\"line\">安装java打包命令</span><br><span class=\"line\">安装maven打包命令--可以安装在java目录里</span><br><span class=\"line\">设置java、maven变量--/etc/profile</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\"><span class=\"comment\"># 查看版本，验证变量是否变量</span></span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># mvn -v</span></span><br><span class=\"line\">Apache Maven 3.5.4 (1edded0938998edf8bf061f1ceb3cfdeccf443fe<span class=\"comment\">; 2018-06-</span></span><br><span class=\"line\"></span><br><span class=\"line\">安装node.js前端打包工具命令npm</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/node-v14.15.3-linux-x64.tar.gz</span></span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># tar xf node-v14.15.3-linux-x64.tar.gz -C /usr/local/</span></span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># cd /usr/local/</span></span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server local]</span><span class=\"comment\"># mv node-v14.15.3-linux-x64/ node</span></span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># vim /etc/profile</span></span><br><span class=\"line\"><span class=\"attr\">NODE_HOME</span>=/usr/local/node</span><br><span class=\"line\"><span class=\"attr\">PATH</span>=<span class=\"variable\">$NODE_HOME</span>/bin:<span class=\"variable\">$PATH</span></span><br><span class=\"line\">export NODE_HOME PATH</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># node -v</span></span><br><span class=\"line\">v12.18.4</span><br><span class=\"line\"></span><br><span class=\"line\">安装docker</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2 git</span></span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># yum install -y docker-ce</span></span><br><span class=\"line\">启动并设置开机启动</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br><span class=\"line\"></span><br><span class=\"line\">配置jenkins连接harbor仓库</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># vim /etc/docker/daemon.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&quot;insecure-registries&quot;: <span class=\"section\">[&quot;10.31.162.124&quot;]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># systemctl restart docker </span></span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># docker login 10.31.162.124 -uadmin</span></span><br><span class=\"line\">Password: Harbor12345</span><br><span class=\"line\">Login Succeeded</span><br><span class=\"line\"></span><br><span class=\"line\">创建带有java环境的基础镜像</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server ~]</span><span class=\"comment\"># mkdir java</span></span><br><span class=\"line\">将对应版本的jdk包上传到该目录中</span><br><span class=\"line\"><span class=\"section\">[root@jenkins-server java]</span><span class=\"comment\"># cat Dockerfile </span></span><br><span class=\"line\">FROM daocloud.io/library/centos:7</span><br><span class=\"line\"><span class=\"comment\"># 更新软件</span></span><br><span class=\"line\">RUN yum -y upgrade</span><br><span class=\"line\"><span class=\"comment\"># 安装中文包</span></span><br><span class=\"line\">RUN yum install -y kde-l10n-Chinese</span><br><span class=\"line\"><span class=\"comment\"># 重新安装glibc-common</span></span><br><span class=\"line\">RUN yum -y reinstall glibc-common</span><br><span class=\"line\"><span class=\"comment\"># 编译生成语言库</span></span><br><span class=\"line\">RUN localedef -c -f UTF-8 -i zh_CN zh_CN.utf8</span><br><span class=\"line\"><span class=\"comment\"># 设置语言默认值为中文，时区改为东八区</span></span><br><span class=\"line\">RUN echo &#x27;<span class=\"attr\">LANG</span>=<span class=\"string\">&quot;zh_CN.UTF-8&quot;</span><span class=\"string\">&#x27; &gt; /etc/locale.conf</span></span><br><span class=\"line\"><span class=\"string\">RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class=\"line\"><span class=\"string\">ENV LANG zh_CN.UTF-8</span></span><br><span class=\"line\"><span class=\"string\">ENV LC_ALL zh_CN.UTF-8</span></span><br><span class=\"line\"><span class=\"string\"># jdk1.8.0_321和自己下载的版本一致</span></span><br><span class=\"line\"><span class=\"string\">ENV JAVA_HOME /usr/local/jdk1.8.0_321</span></span><br><span class=\"line\"><span class=\"string\">ENV PATH=$JAVA_HOME/bin:$JAVA_HOME/jre/bin:$PATH</span></span><br><span class=\"line\"><span class=\"string\">ENV CLASSPATH=.:$JAVA_HOME/lib:$JAVA_HOME/jre/lib:$JAVA_HOME/lib/tools.jar</span></span><br><span class=\"line\"><span class=\"string\"># jdk-8u321-linux-x64.tar.gz和自己下载的版本一致</span></span><br><span class=\"line\"><span class=\"string\">ADD jdk-8u321-linux-x64.tar.gz /usr/local/</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">构建镜像</span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server java]# docker build -t my-jdk:v1.0 .</span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server java]# docker images</span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server java]# docker images</span></span><br><span class=\"line\"><span class=\"string\">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</span></span><br><span class=\"line\"><span class=\"string\">my-jdk                       v1.0                617a86a455e1        2 minutes ago  </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server java]# docker tag my-jdk:v1.0 10.31.162.124/myjdk/my-jdk:v1.0</span></span><br><span class=\"line\"><span class=\"string\">将基础镜像上传到harbor仓库</span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server java]# docker push 10.31.162.124/myjdk/my-jdk:v1.0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">制作nginx基础镜像</span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server nginx]# cat nginx.repo </span></span><br><span class=\"line\"><span class=\"string\">[nginx-stable]</span></span><br><span class=\"line\"><span class=\"string\">name=nginx stable repo</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=https://nginx.org/keys/nginx_signing.key</span></span><br><span class=\"line\"><span class=\"string\">module_hotfixes=true</span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server nginx]# cat Dockerfile </span></span><br><span class=\"line\"><span class=\"string\">FROM daocloud.io/library/centos:7</span></span><br><span class=\"line\"><span class=\"string\"># 更新软件</span></span><br><span class=\"line\"><span class=\"string\">RUN yum -y upgrade</span></span><br><span class=\"line\"><span class=\"string\"># 安装中文包</span></span><br><span class=\"line\"><span class=\"string\">RUN yum install -y kde-l10n-Chinese</span></span><br><span class=\"line\"><span class=\"string\"># 重新安装glibc-common</span></span><br><span class=\"line\"><span class=\"string\">RUN yum -y reinstall glibc-common</span></span><br><span class=\"line\"><span class=\"string\"># 编译生成语言库</span></span><br><span class=\"line\"><span class=\"string\">RUN localedef -c -f UTF-8 -i zh_CN zh_CN.utf8</span></span><br><span class=\"line\"><span class=\"string\"># 设置语言默认值为中文，时区改为东八区</span></span><br><span class=\"line\"><span class=\"string\">RUN echo &#x27;</span>LANG=<span class=\"string\">&quot;zh_CN.UTF-8&quot;</span><span class=\"string\">&#x27; &gt; /etc/locale.conf</span></span><br><span class=\"line\"><span class=\"string\">RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span></span><br><span class=\"line\"><span class=\"string\">ENV LANG zh_CN.UTF-8</span></span><br><span class=\"line\"><span class=\"string\">ENV LC_ALL zh_CN.UTF-8</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">ADD nginx.repo /etc/yum.repos.d/</span></span><br><span class=\"line\"><span class=\"string\">RUN yum install -y nginx</span></span><br><span class=\"line\"><span class=\"string\">EXPOSE 80</span></span><br><span class=\"line\"><span class=\"string\">CMD [&quot;nginx&quot;, &quot;-g&quot;, &quot;daemon off;&quot;]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server nginx]# docker build -t myningx:v1.0 .</span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server nginx]# docker tag myningx:v1.0 10.31.162.124/nginx/mynginx:v1.0</span></span><br><span class=\"line\"><span class=\"string\">[root@jenkins-server nginx]# docker push 10.31.162.124/nginx/mynginx:v1.0</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置ssh连接前端服务器\"><a href=\"#配置ssh连接前端服务器\" class=\"headerlink\" title=\"配置ssh连接前端服务器\"></a>配置ssh连接前端服务器</h1><h2 id=\"配置前端服务器\"><a href=\"#配置前端服务器\" class=\"headerlink\" title=\"配置前端服务器\"></a>配置前端服务器</h2><p><code>访问10.31.162.35:8080/jenkins</code></p>\n<p><img src=\"/upload/docker-ruoyi2.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<p><img src=\"/upload/docker-ruoyi3.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<h1 id=\"创建后端构建任务\"><a href=\"#创建后端构建任务\" class=\"headerlink\" title=\"创建后端构建任务\"></a>创建后端构建任务</h1><p><img src=\"/upload/docker-ruoyi4.webp\" alt=\"docker-ruoyi1.webp\">)</p>\n<p><img src=\"/upload/docker-ruoyi5.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<p><img src=\"/upload/docker-ruoyi6.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<p><img src=\"/upload/docker-ruoyi7.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<p><img src=\"/upload/docker-ruoyi8.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<p><img src=\"/upload/docker-ruoyi9.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">脚本内容提供：</span><br><span class=\"line\">docker build -t java-server:v1.0 .</span><br><span class=\"line\">docker tag java-server:v1.0  10.31.162.124/java-server/java-server:v1.0</span><br><span class=\"line\">docker login -u admin -p Harbor12345 192.168.209.166</span><br><span class=\"line\">docker push 192.168.209.166/java-server/java-server:v1.0 &amp;&amp; docker rmi 10.31.162.124/java-server/java-server:v1.0</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/upload/docker-ruoyi10.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<h1 id=\"创建前端构建任务\"><a href=\"#创建前端构建任务\" class=\"headerlink\" title=\"创建前端构建任务\"></a>创建前端构建任务</h1><p><img src=\"/upload/docker-ruoyi11.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<p><img src=\"/upload/docker-ruoyi12.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<p><img src=\"/upload/docker-ruoyi13.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">前端脚本</span><br><span class=\"line\"><span class=\"comment\">#环境变量</span></span><br><span class=\"line\">echo $PATH</span><br><span class=\"line\"><span class=\"comment\">#进入jenkins workspace的项目目录</span></span><br><span class=\"line\">cd $&#123;WORKSPACE&#125;</span><br><span class=\"line\"><span class=\"comment\">#镜像选择淘宝的镜像</span></span><br><span class=\"line\">npm install --unsafe-perm <span class=\"attr\">--registry</span>=https://registry.npm.taobao.org</span><br><span class=\"line\"><span class=\"comment\">#开始打包</span></span><br><span class=\"line\">npm run build:prod</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#进入到打包目录</span></span><br><span class=\"line\">cd dist/</span><br><span class=\"line\"><span class=\"comment\">#删除上次打包生成的压缩文件</span></span><br><span class=\"line\">rm -rf *.tar.gz</span><br><span class=\"line\"><span class=\"comment\">#把生成的项目打包成压缩包方便传输到远程服务器</span></span><br><span class=\"line\">tar -zcvf `date +%F`.tar.gz *</span><br><span class=\"line\"><span class=\"comment\">#回到上层工作目录</span></span><br><span class=\"line\">cd ../</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置构建后操作\"><a href=\"#配置构建后操作\" class=\"headerlink\" title=\"配置构建后操作\"></a>配置构建后操作</h1><p><img src=\"/upload/docker-ruoyi14.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<p><img src=\"/upload/docker-ruoyi15.webp\" alt=\"docker-ruoyi1.webp\"></p>\n<p><code>保存返回面板，开始构建</code></p>\n<h1 id=\"部署后端java服务\"><a href=\"#部署后端java服务\" class=\"headerlink\" title=\"部署后端java服务\"></a>部署后端java服务</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">下载jocker</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># yum install -y docker-ce</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br><span class=\"line\"></span><br><span class=\"line\">配置连接harbor仓库地址</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># vim /etc/docker/daemon.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">&quot;insecure-registries&quot;: <span class=\"section\">[&quot;10.31.162.124&quot;]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># systemctl restart docker</span></span><br><span class=\"line\"></span><br><span class=\"line\">登陆仓库</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># docker login -u admin -p Harbor12345 10.31.162.124</span></span><br><span class=\"line\">下载镜像</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># docker pull 10.31.162.124/java-server/java-server:v1.0</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># docker images</span></span><br><span class=\"line\">REPOSITORY                                TAG       IMAGE ID       CREATED                  SIZE</span><br><span class=\"line\">192.168.209.166/java-server/java-server   v1.0      23d4017d23fc   Less than a second ago   725MB</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># docker run -itd --name java-server --restart=always --net host 10.31.162.124/java-server/java-server:v1.0</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看nginx服务器端口有没有起来\"><a href=\"#查看nginx服务器端口有没有起来\" class=\"headerlink\" title=\"查看nginx服务器端口有没有起来\"></a>查看nginx服务器端口有没有起来</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># ss -lnpt\t\t#查看80端口有没有起来</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"登入web测试\"><a href=\"#登入web测试\" class=\"headerlink\" title=\"登入web测试\"></a>登入web测试</h1><p><code>访问 10.31.162.25</code>会出来偌依的界面</p>\n","categories":["operations"],"tags":["Linux","Docker","Ruoyi"]},{"title":"docker 创建halo博客","url":"/2025/11/06/docker-%E5%88%9B%E5%BB%BAhalo%E5%8D%9A%E5%AE%A2/","content":"<p>本文介绍如何使用 Docker 快速创建 halo 博客，包括配置文件编写、环境准备和启动流程。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"docker博客创建\"><a href=\"#docker博客创建\" class=\"headerlink\" title=\"docker博客创建\"></a>docker博客创建</h2><h3 id=\"编辑配置文件\"><a href=\"#编辑配置文件\" class=\"headerlink\" title=\"编辑配置文件\"></a>编辑配置文件</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /halo/docker-compose.yaml</span><br><span class=\"line\">version: &quot;3&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">services:</span><br><span class=\"line\">  halo</span><br><span class=\"line\">    image: halohub/halo:2.11</span><br><span class=\"line\">    container_name: halo</span><br><span class=\"line\">    restart: on-failure:3</span><br><span class=\"line\">    depends_on:</span><br><span class=\"line\">      halodb:</span><br><span class=\"line\">        condition: service_healthy</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      halo_network:</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\"></span><br><span class=\"line\">   - ./halo2:/root/.halo2</span><br><span class=\"line\">     rts:</span><br><span class=\"line\">        - &quot;8090:8090&quot;</span><br><span class=\"line\">          althcheck:</span><br><span class=\"line\">                test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost:8090/actuator/health/readiness&quot;]</span><br><span class=\"line\">                interval: 30s</span><br><span class=\"line\">                timeout: 5s</span><br><span class=\"line\">                retries: 5</span><br><span class=\"line\">                start_period: 30s          </span><br><span class=\"line\">              command:</span><br><span class=\"line\">             - --spring.r2dbc.url=r2dbc:pool:postgresql://halodb/halo</span><br><span class=\"line\">               --spring.r2dbc.username=halo</span><br><span class=\"line\"></span><br><span class=\"line\">      # PostgreSQL 的密码，请保证与下方 POSTGRES_PASSWORD 的变量值一致。</span><br><span class=\"line\"></span><br><span class=\"line\">   - --spring.r2dbc.password=openpostgresql</span><br><span class=\"line\">     --spring.sql.init.platform=postgresql</span><br><span class=\"line\"></span><br><span class=\"line\">      # 外部访问地址，请根据实际需要修改</span><br><span class=\"line\"></span><br><span class=\"line\">   - --halo.external-url=http://localhost:8090/</span><br><span class=\"line\">     halodb:</span><br><span class=\"line\">         image: postgres:15.4</span><br><span class=\"line\">         container_name: halodb</span><br><span class=\"line\">         restart: on-failure:3</span><br><span class=\"line\">         networks:</span><br><span class=\"line\">           halo_network:</span><br><span class=\"line\">         volumes:</span><br><span class=\"line\">        - ./db:/var/lib/postgresql/data</span><br><span class=\"line\">          rts:</span><br><span class=\"line\">             - &quot;5432:5432&quot;</span><br><span class=\"line\">               althcheck:</span><br><span class=\"line\">                     test: [ &quot;CMD&quot;, &quot;pg_isready&quot; ]</span><br><span class=\"line\">                     interval: 10s</span><br><span class=\"line\">                     timeout: 5s</span><br><span class=\"line\">                     retries: 5</span><br><span class=\"line\">                   environment:</span><br><span class=\"line\">                  - POSTGRES_PASSWORD=openpostgresql</span><br><span class=\"line\">                    POSTGRES_USER=halo</span><br><span class=\"line\">                       - POSTGRES_DB=halo</span><br><span class=\"line\">                         PGUSER=halo</span><br><span class=\"line\"></span><br><span class=\"line\">networks:</span><br><span class=\"line\">  halo_network:</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"创建目录\"><a href=\"#创建目录\" class=\"headerlink\" title=\"创建目录\"></a>创建目录</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir -pv /halo</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"重新指定文件目录\"><a href=\"#重新指定文件目录\" class=\"headerlink\" title=\"重新指定文件目录\"></a>重新指定文件目录</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mv docker-compose.yaml /halo</span><br><span class=\"line\">cd /halo</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"卸载所有冲突的包\"><a href=\"#卸载所有冲突的包\" class=\"headerlink\" title=\"卸载所有冲突的包\"></a>卸载所有冲突的包</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do sudo apt-get remove $pkg; done</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"设置-Docker-的-apt-存储库\"><a href=\"#设置-Docker-的-apt-存储库\" class=\"headerlink\" title=\"设置 Docker 的 apt 存储库\"></a>设置 Docker 的 apt 存储库</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Add Docker&#x27;s official GPG key:</span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get install ca-certificates curl gnupg</span><br><span class=\"line\">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class=\"line\">curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class=\"line\">sudo chmod a+r /etc/apt/keyrings/docker.gpg</span><br><span class=\"line\"></span><br><span class=\"line\"># Add the repository to Apt sources:</span><br><span class=\"line\">echo \\</span><br><span class=\"line\">  &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \\</span><br><span class=\"line\">  $(. /etc/os-release &amp;&amp; echo &quot;$VERSION_CODENAME&quot;) stable&quot; | \\</span><br><span class=\"line\">  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class=\"line\">sudo apt-get update</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"运行安装脚本\"><a href=\"#运行安装脚本\" class=\"headerlink\" title=\"运行安装脚本\"></a>运行安装脚本</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://linuxmirrors.cn/docker.sh)    //脚本运行</span><br><span class=\"line\">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin    //新版docker版本脚本</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装-docker-compose\"><a href=\"#安装-docker-compose\" class=\"headerlink\" title=\"安装 docker-compose\"></a>安装 docker-compose</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">apt-get install -y docker-compose</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"验证版本号\"><a href=\"#验证版本号\" class=\"headerlink\" title=\"验证版本号\"></a>验证版本号</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker-compose --version</span><br><span class=\"line\">docker --version</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装并运行\"><a href=\"#安装并运行\" class=\"headerlink\" title=\"安装并运行\"></a>安装并运行</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker-compose up -d</span><br><span class=\"line\">systemctl status docker</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p><code>输入IP地址+端口8090</code>进入注册页面</p>\n","categories":["operations"],"tags":["Linux","Docker","halo"]},{"title":"docker部署halo博客","url":"/2025/01/06/docker%E9%83%A8%E7%BD%B2halo%E5%8D%9A%E5%AE%A2/","content":"<h1 id=\"docker博客创建\"><a href=\"#docker博客创建\" class=\"headerlink\" title=\"docker博客创建\"></a>docker博客创建</h1><h2 id=\"编辑配置文件\"><a href=\"#编辑配置文件\" class=\"headerlink\" title=\"编辑配置文件\"></a>编辑配置文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /halo/docker-compose.yaml</span><br><span class=\"line\">version: <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">services:</span><br><span class=\"line\">  halo</span><br><span class=\"line\">    image: halohub/halo:2.11</span><br><span class=\"line\">    container_name: halo</span><br><span class=\"line\">    restart: on-failure:3</span><br><span class=\"line\">    depends_on:</span><br><span class=\"line\">      halodb:</span><br><span class=\"line\">        condition: service_healthy</span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      halo_network:</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\"></span><br><span class=\"line\">   - ./halo2:/root/.halo2</span><br><span class=\"line\">     rts:</span><br><span class=\"line\">        - <span class=\"string\">&quot;8090:8090&quot;</span></span><br><span class=\"line\">          althcheck:</span><br><span class=\"line\">                <span class=\"built_in\">test</span>: [<span class=\"string\">&quot;CMD&quot;</span>, <span class=\"string\">&quot;curl&quot;</span>, <span class=\"string\">&quot;-f&quot;</span>, <span class=\"string\">&quot;http://localhost:8090/actuator/health/readiness&quot;</span>]</span><br><span class=\"line\">                interval: 30s</span><br><span class=\"line\">                <span class=\"built_in\">timeout</span>: 5s</span><br><span class=\"line\">                retries: 5</span><br><span class=\"line\">                start_period: 30s          </span><br><span class=\"line\">              <span class=\"built_in\">command</span>:</span><br><span class=\"line\">             - --spring.r2dbc.url=r2dbc:pool:postgresql://halodb/halo</span><br><span class=\"line\">               --spring.r2dbc.username=halo</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># PostgreSQL 的密码，请保证与下方 POSTGRES_PASSWORD 的变量值一致。</span></span><br><span class=\"line\"></span><br><span class=\"line\">   - --spring.r2dbc.password=openpostgresql</span><br><span class=\"line\">     --spring.sql.init.platform=postgresql</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"comment\"># 外部访问地址，请根据实际需要修改</span></span><br><span class=\"line\"></span><br><span class=\"line\">   - --halo.external-url=http://localhost:8090/</span><br><span class=\"line\">     halodb:</span><br><span class=\"line\">         image: postgres:15.4</span><br><span class=\"line\">         container_name: halodb</span><br><span class=\"line\">         restart: on-failure:3</span><br><span class=\"line\">         networks:</span><br><span class=\"line\">           halo_network:</span><br><span class=\"line\">         volumes:</span><br><span class=\"line\">        - ./db:/var/lib/postgresql/data</span><br><span class=\"line\">          rts:</span><br><span class=\"line\">             - <span class=\"string\">&quot;5432:5432&quot;</span></span><br><span class=\"line\">               althcheck:</span><br><span class=\"line\">                     <span class=\"built_in\">test</span>: [ <span class=\"string\">&quot;CMD&quot;</span>, <span class=\"string\">&quot;pg_isready&quot;</span> ]</span><br><span class=\"line\">                     interval: 10s</span><br><span class=\"line\">                     <span class=\"built_in\">timeout</span>: 5s</span><br><span class=\"line\">                     retries: 5</span><br><span class=\"line\">                   environment:</span><br><span class=\"line\">                  - POSTGRES_PASSWORD=openpostgresql</span><br><span class=\"line\">                    POSTGRES_USER=halo</span><br><span class=\"line\">                       - POSTGRES_DB=halo</span><br><span class=\"line\">                         PGUSER=halo</span><br><span class=\"line\"></span><br><span class=\"line\">networks:</span><br><span class=\"line\">  halo_network:</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"创建目录\"><a href=\"#创建目录\" class=\"headerlink\" title=\"创建目录\"></a>创建目录</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir -pv /halo</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"重新指定文件目录\"><a href=\"#重新指定文件目录\" class=\"headerlink\" title=\"重新指定文件目录\"></a>重新指定文件目录</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mv docker-compose.yaml /halo</span><br><span class=\"line\">cd /halo</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"运行以下命令卸载所有冲突的包\"><a href=\"#运行以下命令卸载所有冲突的包\" class=\"headerlink\" title=\"运行以下命令卸载所有冲突的包\"></a>运行以下命令卸载所有冲突的包</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">for pkg in docker.io docker-doc docker-compose podman-docker containerd runc; do sudo apt-get remove $pkg; done</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"设置-Docker-的apt存储库\"><a href=\"#设置-Docker-的apt存储库\" class=\"headerlink\" title=\"设置 Docker 的apt存储库\"></a>设置 Docker 的apt存储库</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># Add Docker&#x27;s official GPG key:</span><br><span class=\"line\">sudo apt-get update</span><br><span class=\"line\">sudo apt-get install ca-certificates curl gnupg</span><br><span class=\"line\">sudo install -m 0755 -d /etc/apt/keyrings</span><br><span class=\"line\">curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg</span><br><span class=\"line\">sudo chmod a+r /etc/apt/keyrings/docker.gpg</span><br><span class=\"line\"></span><br><span class=\"line\"># Add the repository to Apt sources:</span><br><span class=\"line\">echo \\</span><br><span class=\"line\">  &quot;deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \\</span><br><span class=\"line\">  $(. /etc/os-release &amp;&amp; echo &quot;$VERSION_CODENAME&quot;) stable&quot; | \\</span><br><span class=\"line\">  sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br><span class=\"line\">sudo apt-get update</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"运行安装脚本\"><a href=\"#运行安装脚本\" class=\"headerlink\" title=\"运行安装脚本\"></a>运行安装脚本</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://linuxmirrors.cn/docker.sh)    //脚本运行</span><br><span class=\"line\">sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin    //新版docker版本脚本</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">apt-get install -y docker-compose</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"验证版本号\"><a href=\"#验证版本号\" class=\"headerlink\" title=\"验证版本号\"></a>验证版本号</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker-compose --version</span><br><span class=\"line\">docker --version</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装运行\"><a href=\"#安装运行\" class=\"headerlink\" title=\"安装运行\"></a>安装运行</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker-compose up -d</span><br><span class=\"line\">systemctl status docker</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p><code>输入IP地址+端口8090</code>进入注册页面</p>\n","categories":["operations"],"tags":["Linux","Docker"]},{"title":"gitee 仓库创建及上传文件","url":"/2025/11/06/gitee-%E4%BB%93%E5%BA%93%E5%88%9B%E5%BB%BA%E5%8F%8A%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/","content":"<h2 id=\"首先由个gitee的账号\"><a href=\"#首先由个gitee的账号\" class=\"headerlink\" title=\"首先由个gitee的账号\"></a>首先由个gitee的账号</h2><h2 id=\"git-全局设置\"><a href=\"#git-全局设置\" class=\"headerlink\" title=\"git 全局设置\"></a>git 全局设置</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git config --global user.name&quot;名字&quot;</span><br><span class=\"line\">git config --global user.email &quot;邮箱&quot;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"创建git仓库\"><a href=\"#创建git仓库\" class=\"headerlink\" title=\"创建git仓库\"></a>创建git仓库</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir qingfeng</span><br><span class=\"line\">cd qingfeng</span><br><span class=\"line\">git init</span><br><span class=\"line\">touch README.md</span><br><span class=\"line\">git add README.md</span><br><span class=\"line\">git commit -m &quot;first commit&quot;</span><br><span class=\"line\">git remote add origin https://gitee.com/xbd666/qingfeng.git</span><br><span class=\"line\">git push -u origin &quot;master&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>备注：也可以在搜索栏那里直接拉取，就不需要终端命令设置了</strong></p>\n<h2 id=\"已有仓库的\"><a href=\"#已有仓库的\" class=\"headerlink\" title=\"已有仓库的\"></a>已有仓库的</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd existing_git_repo</span><br><span class=\"line\">git remote add origin https://gitee.com/xbd666/qingfeng.git</span><br><span class=\"line\">git push -u origin &quot;master&quot;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"拉取\"><a href=\"#拉取\" class=\"headerlink\" title=\"拉取\"></a>拉取</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git pull origin master</span><br></pre></td></tr></table></figure>\n<h2 id=\"上传到仓库\"><a href=\"#上传到仓库\" class=\"headerlink\" title=\"上传到仓库\"></a>上传到仓库</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git add .</span><br></pre></td></tr></table></figure>\n<h2 id=\"备注描述\"><a href=\"#备注描述\" class=\"headerlink\" title=\"备注描述\"></a>备注描述</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git commit -m &#x27;描述信息&#x27;</span><br></pre></td></tr></table></figure>\n<h2 id=\"上传\"><a href=\"#上传\" class=\"headerlink\" title=\"上传\"></a>上传</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">git push orign master</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">令牌：30acd398455f085b72e9d05343177631</span><br><span class=\"line\"></span><br><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/system_tool.sh)</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Git"]},{"title":"gitee 部署及操作步骤","url":"/2025/11/06/gitee-%E9%83%A8%E7%BD%B2%E5%8F%8A%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4/","content":"<p><strong>gitee 部署及操作步骤</strong></p>\n<h2 id=\"配置密钥\"><a href=\"#配置密钥\" class=\"headerlink\" title=\"配置密钥\"></a>配置密钥</h2><h2 id=\"客户端\"><a href=\"#客户端\" class=\"headerlink\" title=\"客户端\"></a>客户端</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 获取密钥</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client ~]</span><span class=\"comment\">#ssh-keygen</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置gitee密钥\"><a href=\"#配置gitee密钥\" class=\"headerlink\" title=\"配置gitee密钥\"></a>配置gitee密钥</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置gitee密钥</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client ~]</span><span class=\"comment\">#cat .ssh/id_rsa.pub</span></span><br><span class=\"line\">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDMKR4f2AfwFMbd7YtOHPzOHcIuMY5OjQbt5jnx8BRm8xDAdFDG5XHNW39APOrXxc5AAD6YOoAvIxxw+lLxDrvbR6KKKllZb6Y7XJn1Y7G4r8+beBkz0jQpK1haG39pJwCAcZenwRhwy0xa9Z7PzKmTPBblf9kmR7PTuT6ndxuWx8ekIqLil0eT1BbXc3sO7zRTyIJPiLsWn4VlLdgZkU6UDw4R0iMlSdpEL3f9NfxztWNjp/8vdG6tq5DXmEKcIjI0grl9KNRcRc+PdfaUXaUPjf1MS5zCmuECg0T+1dcKS1q8KQUOIYaG3vyFZ4GqZKxn2OcuWYanr4mChvtu3Esh root@git-client</span><br><span class=\"line\"><span class=\"comment\"># 将密钥复制粘贴到gitee上面</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 步骤</span></span><br><span class=\"line\">右上角头像--设置--左侧SSH公钥--复制粘贴密钥保存即可</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"获取gitee的ssh克隆路径\"><a href=\"#获取gitee的ssh克隆路径\" class=\"headerlink\" title=\"获取gitee的ssh克隆路径\"></a>获取gitee的ssh克隆路径</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">在gitee个人仓库页面--点击克隆/下载--复制里面的ssh路径</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"终端操作\"><a href=\"#终端操作\" class=\"headerlink\" title=\"终端操作\"></a>终端操作</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建gitee目录</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client ~]</span><span class=\"comment\"># mkdir gitee</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 进入目录</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client ~]</span><span class=\"comment\"># cd gitee</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 克隆gitee仓库</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client gitee]</span><span class=\"comment\"># git clone git@gitee.com:xbd666/qingfeng.git</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 验证是否克隆成功</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client gitee]</span><span class=\"comment\"># ll</span></span><br><span class=\"line\">总用量 0</span><br><span class=\"line\">drwxr-xr-x 3 root root 92 12月 25 19:54 qingfeng</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"终端操作上传\"><a href=\"#终端操作上传\" class=\"headerlink\" title=\"终端操作上传\"></a>终端操作上传</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 进入仓库目录</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client gitee]</span><span class=\"comment\"># cd qingfeng/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client qingfeng]</span><span class=\"comment\"># ll</span></span><br><span class=\"line\">-rw-rw-rw- 1 root root 2170 11月 23 15:23 beifen.sh</span><br><span class=\"line\"><span class=\"section\">[root@git-client qingfeng]</span><span class=\"comment\"># pwd</span></span><br><span class=\"line\">/root/gitee/qingfeng</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 保存到存储区</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client qingfeng]</span><span class=\"comment\"># git add .</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client qingfeng]</span><span class=\"comment\"># git commit -m &quot;beifeng1&quot;</span></span><br><span class=\"line\"><span class=\"section\">[master 5c2679a]</span> beifeng1</span><br><span class=\"line\"> 1 file changed, 69 insertions(+)</span><br><span class=\"line\"> create mode 100644 beifen.sh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 上传到gitee仓库里</span></span><br><span class=\"line\"><span class=\"section\">[root@git-client qingfeng]</span><span class=\"comment\"># git push origin master</span></span><br><span class=\"line\">Counting objects: 4, done.</span><br><span class=\"line\">Delta compression using up to 2 threads.</span><br><span class=\"line\">Compressing objects: 100% (3/3), done.</span><br><span class=\"line\">Writing objects: 100% (3/3), 1.10 KiB | 0 bytes/s, done.</span><br><span class=\"line\">Total 3 (delta 1), reused 0 (delta 0)</span><br><span class=\"line\">remote: Powered by GITEE.COM <span class=\"section\">[GNK-6.4]</span></span><br><span class=\"line\">To git@gitee.com:xbd666/qingfeng.git</span><br><span class=\"line\">   8881a7f..5c2679a  master -&gt; master</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Git"]},{"title":"gitlab 仓库创建及使用","url":"/2025/11/06/gitlab-%E4%BB%93%E5%BA%93%E5%88%9B%E5%BB%BA%E5%8F%8A%E4%BD%BF%E7%94%A8/","content":"<p><strong>git的工作环境</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">工作区</span><br><span class=\"line\">暂存区\tgit add *</span><br><span class=\"line\">版本库\tgit commit -m “版本描述信息” </span><br><span class=\"line\">HEAD</span><br><span class=\"line\">版本号</span><br><span class=\"line\">版本日志</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">git clone git@IP地址:/自建的目录/自建的库/     <span class=\"comment\">#克隆到本地</span></span><br><span class=\"line\">git add .    <span class=\"comment\">#存储到暂存区</span></span><br><span class=\"line\">git commit -m &quot;描述信息&quot;    <span class=\"comment\">#更新版本</span></span><br><span class=\"line\">git push origin master    <span class=\"comment\">#上传到gitlab</span></span><br></pre></td></tr></table></figure>\n\n<p><code>每个版本都会有一个id号，也就是commit id</code></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@vm20 ~]</span><span class=\"comment\"># git log</span></span><br><span class=\"line\"></span><br><span class=\"line\">commit fbecfa3d04ae5038aa11bf55942e46c840077ace  <span class=\"comment\">#id号</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>部署git</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">环境：</span><br><span class=\"line\">    git-server    192.168.246.214  充当服务器</span><br><span class=\"line\">    client        192.168.246.213</span><br><span class=\"line\"></span><br><span class=\"line\">安装：所有机器都安装</span><br><span class=\"line\">   <span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># yum install -y git</span></span><br><span class=\"line\">   <span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># git --version </span></span><br><span class=\"line\">   git version 1.8.3.1</span><br><span class=\"line\">   </span><br><span class=\"line\">`所有的机器都添加，只要邮箱和用户不一样就可以`   </span><br><span class=\"line\">    <span class=\"comment\"># git config --global user.email &quot;soho@163.com&quot;     ----设置邮箱</span></span><br><span class=\"line\">    <span class=\"comment\"># git config --global user.name &quot;soho&quot;              ----加添用户</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>1、git使用</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.创建一个空目录：在中心服务器上创建</span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># mkdir /git-test</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># useradd git   #创建一个git用户用来运行git</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># passwd git  #给用户设置密码</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># cd /git-test/</span></span><br><span class=\"line\"></span><br><span class=\"line\">2.通过git init命令把这个目录变成Git可以管理的仓库：</span><br><span class=\"line\"> 第1种情况：可以改代码，还能上传到别人的机器，别人也能从你这里下载但是别人不能上传代码到你的机器上。</span><br><span class=\"line\"> 第2种情况：只是为了上传代码用，别人从这台机器上下载代码也可以上传代码到这台机器上，经常用于核心代码库。</span><br></pre></td></tr></table></figure>\n\n<p><strong>创建—-裸库：</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">`语法：git init --bare  库名字</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在server服务端</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server git-test]</span><span class=\"comment\"># git init --bare testgit</span></span><br><span class=\"line\">Initialized empty Git repository in /git-test/testgit/</span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># chown git.git /git-test -R  #修改权限</span></span><br><span class=\"line\">2.仓库创建完成后查看库目录：</span><br><span class=\"line\"><span class=\"section\">[root@git-server git-test]</span><span class=\"comment\"># cd testgit/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server testgit]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">branches  config  description  HEAD  hooks  info  objects  refs</span><br></pre></td></tr></table></figure>\n\n<p><strong>客户端</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.配置免密登录</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># ssh-keygen    #生成秘钥</span></span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># ssh-copy-id -i git@192.168.246.214   #将秘钥传输到git服务器中的git用户</span></span><br><span class=\"line\">2.克隆git仓库</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># git clone git@192.168.246.214:/git-test/testgit/</span></span><br><span class=\"line\">Cloning into &#x27;testgit&#x27;...</span><br><span class=\"line\">warning: You appear to have cloned an empty repository.</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># ls  #查看仓库已经克隆下来了</span></span><br><span class=\"line\">anaconda-ks.cfg    testgit </span><br></pre></td></tr></table></figure>\n\n<p><strong>创建文件模拟代码提交到仓库</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.在testgit目录下创建一个测试文件test.txt</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># cd testgit/</span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># vi test.txt   #随便写点东西</span></span><br><span class=\"line\">2.把文件添加到暂存区：使用 &quot;git add&quot; 建立跟踪</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git add test.txt</span></span><br><span class=\"line\">注: 这里可以使用 git add * 或者 git add -A</span><br><span class=\"line\">3.提交文件到本地仓库分支：</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git commit -m &quot;test1&quot;</span></span><br><span class=\"line\"><span class=\"section\">[master (root-commit) 2b51ff9]</span> test1</span><br><span class=\"line\"> 1 file changed, 2 insertions(+)</span><br><span class=\"line\"> create mode 100644 test.txt</span><br><span class=\"line\"> -m:描述</span><br><span class=\"line\"> 4.查看git状态：</span><br><span class=\"line\"> <span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git status </span></span><br><span class=\"line\"><span class=\"comment\"># On branch master   #分支位于master</span></span><br><span class=\"line\">5.修改文件后再此查看状态：</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># echo &#x27;1122334&#x27; &gt;&gt; test.txt</span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git status</span></span><br><span class=\"line\"><span class=\"comment\"># 位于分支 master</span></span><br><span class=\"line\"><span class=\"comment\"># 尚未暂存以备提交的变更：</span></span><br><span class=\"line\"><span class=\"comment\">#   （使用 &quot;git add &lt;file&gt;...&quot; 更新要提交的内容）</span></span><br><span class=\"line\"><span class=\"comment\">#   （使用 &quot;git checkout -- &lt;file&gt;...&quot; 丢弃工作区的改动）</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#\t修改：      readme.txt</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\">修改尚未加入提交（使用 &quot;git add&quot; 和/或 &quot;git commit &quot;</span><br><span class=\"line\">6.先add</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git add -A</span></span><br><span class=\"line\">8.再次提交commit：</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git commit  -m &quot;add2&quot; test.txt </span></span><br><span class=\"line\"><span class=\"section\">[master 73bf688]</span> add2</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> <span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git status </span></span><br><span class=\"line\"><span class=\"comment\"># On branch master</span></span><br><span class=\"line\">nothing to commit, working directory clean</span><br></pre></td></tr></table></figure>\n\n<p><strong>版本回退</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">查看现在的版本</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git log</span></span><br><span class=\"line\"></span><br><span class=\"line\">回到上一个版本</span><br><span class=\"line\"><span class=\"comment\">#一个^代表回退一次，2个^代表回退2此，依此类推……</span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git reset --hard HEAD^ </span></span><br><span class=\"line\">HEAD is now at 0126755 test1</span><br><span class=\"line\">2.回到指定的版本(根据版本号): </span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git reset --hard dd66ff</span></span><br><span class=\"line\">HEAD is now at dd66ff9 <span class=\"attr\">add2</span></span><br><span class=\"line\"></span><br><span class=\"line\">==========================================================</span><br><span class=\"line\">注：消失的ID号：可以查看之前的所有的版本</span><br><span class=\"line\"><span class=\"section\">[root@vm20 gittest]</span><span class=\"comment\"># git reflog</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>删除文件</strong></p>\n<p>从工作区删除test.txt，并且从版本库一起删除</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">从工作区删除</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># rm -rf test.txt </span></span><br><span class=\"line\">从版本库删除：</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git rm test.txt </span></span><br><span class=\"line\">rm &#x27;test.txt&#x27;</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git commit -m &quot;删除文件test.txt&quot;</span></span><br><span class=\"line\"><span class=\"section\">[master cebc081]</span> 删除文件test.txt</span><br><span class=\"line\"> 1 file changed, 3 deletions(-)</span><br><span class=\"line\"> delete mode 100644 test.txt</span><br></pre></td></tr></table></figure>\n\n<p><strong>将代码上传到仓库的master分支</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># vi a.txt   #创建一个新文件</span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git add a.txt </span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git commit -m &quot;add&quot;</span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git push origin master   #上传到远程仓库master分支</span></span><br><span class=\"line\">Counting objects: 11, done.</span><br><span class=\"line\">Compressing objects: 100% (4/4), done.</span><br><span class=\"line\">Writing objects: 100% (11/11), 828 bytes | 0 bytes/s, done.</span><br><span class=\"line\">Total 11 (delta 0), reused 0 (delta 0)</span><br><span class=\"line\">To git@192.168.246.214:/git-test/testgit/</span><br><span class=\"line\"> * <span class=\"section\">[new branch]</span>      master -&gt; master</span><br></pre></td></tr></table></figure>\n\n<p><strong>测试:</strong></p>\n<p>在客户端将仓库删除掉然后在克隆下来查看仓库中是否有文件</p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@git-client ~]</span><span class=\"comment\"># rm -rf testgit/</span></span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># git clone git@192.168.246.214:/git-test/testgit/</span></span><br><span class=\"line\">Cloning into &#x27;testgit&#x27;...</span><br><span class=\"line\">remote: Counting objects: 11, done.</span><br><span class=\"line\">remote: Compressing objects: 100% (4/4), done.</span><br><span class=\"line\">remote: Total 11 (delta 0), reused 0 (delta 0)</span><br><span class=\"line\">Receiving objects: 100% (11/11), done.</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># cd testgit/</span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">a.txt</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># cat a.txt </span></span><br><span class=\"line\">hello world</span><br></pre></td></tr></table></figure>\n\n<p><strong>创建分支并合并分支</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># ls在客户端操作：</span></span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># git clone git@192.168.246.214:/git-test/testgit/</span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git status </span></span><br><span class=\"line\"><span class=\"comment\"># On branch master   #当前所在为master分支</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># Initial commit</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\">nothing to commit (create/copy files and use &quot;git add&quot; to track)</span><br><span class=\"line\"></span><br><span class=\"line\">创建分支:</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git branch dev   #创建分支。</span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git branch    #查看分支。*在哪里就表示当前是哪个分支</span></span><br><span class=\"line\">  dev</span><br><span class=\"line\">* master</span><br><span class=\"line\">切换分支:</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git checkout dev</span></span><br><span class=\"line\">Switched to branch &#x27;dev&#x27;</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git branch </span></span><br><span class=\"line\">* dev</span><br><span class=\"line\">  master</span><br><span class=\"line\">在dev分支创建一个文件；</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># vi test.txt</span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git add test.txt </span></span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git commit -m &quot;add dev&quot;</span></span><br><span class=\"line\"><span class=\"section\">[dev f855bdf]</span> add dev</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> create mode 100644 test.txt</span><br><span class=\"line\">现在，dev分支的工作完成，我们就可以切换回master分支：</span><br><span class=\"line\"> <span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git checkout master</span></span><br><span class=\"line\">Switched to branch &#x27;master&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">切换回`master`分支后，再查看一个`test.txt`文件，刚才添加的内容不见了！因为那个提交是在`dev`分支上，而`master`分支此刻的提交点并没有变：</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">a.txt</span><br><span class=\"line\"></span><br><span class=\"line\">现在，我们把`dev`分支的工作成果合并到`master`分支上：</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git merge dev</span></span><br><span class=\"line\">Updating 40833e0..f855bdf</span><br><span class=\"line\">Fast-forward</span><br><span class=\"line\"> test.txt | 1 +</span><br><span class=\"line\"> 1 file changed, 1 insertion(+)</span><br><span class=\"line\"> create mode 100644 test.txt</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">a.txt  test.txt</span><br><span class=\"line\">现在已经将dev分支的内容合并到master上。确认没有问题上传到远程仓库:</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git push origin master</span></span><br><span class=\"line\"></span><br><span class=\"line\">合并完成后，就可以放心地删除`dev`分支了：</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git branch -d dev</span></span><br><span class=\"line\">Deleted branch dev (was f855bdf).</span><br><span class=\"line\"></span><br><span class=\"line\">删除后，查看`branch`，就只剩下`master`分支了：</span><br><span class=\"line\"><span class=\"section\">[root@client testgit]</span><span class=\"comment\"># git branch </span></span><br><span class=\"line\">* master</span><br></pre></td></tr></table></figure>\n\n<p><strong>2、部署gitlab服务</strong></p>\n<p><strong>官网下载gitlab地址</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">百度搜索gitlab--点击https://gitlab.com/users/sign_in</span><br><span class=\"line\">拉到最下面--点击 关于 GitLab</span><br><span class=\"line\">再拉到最下面--有个Resources--点击Install--往下拉点击有个cenos 7版本的下载--安装命令步骤操作即可</span><br></pre></td></tr></table></figure>\n\n<p><strong>配置yum源</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># cd /etc/yum.repos.d/</span></span><br><span class=\"line\"><span class=\"comment\">#配置yum源</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server yum.repos.d]</span><span class=\"comment\"># vi gitlab-ce.repo</span></span><br><span class=\"line\"><span class=\"section\">[gitlab-ce]</span></span><br><span class=\"line\"><span class=\"attr\">name</span>=Gitlab CE Repository</span><br><span class=\"line\"><span class=\"attr\">baseurl</span>=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el<span class=\"variable\">$releasever</span></span><br><span class=\"line\"><span class=\"attr\">gpgcheck</span>=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">enabled</span>=<span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装相关依赖</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server yum.repos.d]</span><span class=\"comment\"># yum install -y curl policycoreutils-python openssh-server</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server yum.repos.d]</span><span class=\"comment\"># systemctl enable sshd</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server yum.repos.d]</span><span class=\"comment\"># systemctl start sshd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装postfix</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server yum.repos.d]</span><span class=\"comment\"># yum install postfix  #安装邮箱</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server yum.repos.d]</span><span class=\"comment\"># systemctl enable postfix</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server yum.repos.d]</span><span class=\"comment\"># systemctl start postfix</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装的版本，下面那条命令是安装最新版，可能存在不兼容的风险</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server yum.repos.d]</span><span class=\"comment\"># yum install -y gitlab-ce-13.1.1-ce.0.el7.x86_64  #安装的版本</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server yum.repos.d]</span><span class=\"comment\"># yum install -y gitlab-ce  #将会安装gitlab最新版本</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>配置gitlab</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># vim /etc/gitlab/gitlab.rb</span></span><br><span class=\"line\">1.<span class=\"comment\"># 添加对外的域名（gitlab.papamk.com请添加A记录指向本服务器的公网IP）：将原来的修改为</span></span><br><span class=\"line\">external_url &#x27;http://192.168.246.214&#x27;</span><br><span class=\"line\">2.设置地区</span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;time_zone&#x27;]</span> = &#x27;Asia/Shanghai&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">将数据路径的注释去掉，可以更改</span><br><span class=\"line\"><span class=\"comment\">#第501-505行，去除注释</span></span><br><span class=\"line\">git_data_dirs(&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;default&quot;</span> =&gt; &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;path&quot;</span> =&gt; <span class=\"string\">&quot;/mnt/nfs-01/git-data&quot;</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">开启ssh服务:</span><br><span class=\"line\"><span class=\"comment\">#第519行，去除注释</span></span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;gitlab_shell_ssh_port&#x27;]</span> = 22</span><br><span class=\"line\"></span><br><span class=\"line\">开启邮箱服务</span><br><span class=\"line\"><span class=\"comment\">#直接在637行开始添加以下内容</span></span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_enable&#x27;]</span> = true  <span class=\"comment\">#开启smtp服务</span></span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_address&#x27;]</span> = &quot;smtp.163.com&quot; <span class=\"comment\">#指定smtp地址</span></span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_port&#x27;]</span> = 465</span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_user_name&#x27;]</span> = &quot;xxxx@163.com&quot;  <span class=\"comment\">#指定邮箱</span></span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_password&#x27;]</span> = &quot;邮箱授权密码&quot;</span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_domain&#x27;]</span> = &quot;163.com&quot;  <span class=\"comment\">#邮箱地址的域</span></span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_authentication&#x27;]</span> = &quot;login&quot; </span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_enable_starttls_auto&#x27;]</span> = true</span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_tls&#x27;]</span> = true</span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;smtp_openssl_verify_mode&#x27;]</span> = &#x27;none&#x27;</span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;gitlab_email_from&#x27;]</span> = &#x27;xxxx@163.com&#x27; <span class=\"comment\">#指定发件邮箱</span></span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;gitlab_email_display_name&#x27;]</span> = &#x27;Admin&#x27; <span class=\"comment\">#指定发件人</span></span><br><span class=\"line\"><span class=\"comment\">#user[&quot;git_user_email&quot;] = &quot;xxxx@163.com&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>重置并启动GitLab执行:</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># gitlab-ctl reconfigure   #重新加载，需要等很长时间</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>启动</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># gitlab-ctl restart  #启动</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>邮箱测试</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@git-server ~]</span> <span class=\"comment\"># gitlab-rails console\t#进入终端</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#开始测试</span></span><br><span class=\"line\">irb(main):001:0&gt; Notify.test_email(&#x27;xxxx@qq.com&#x27;, &#x27;Message Subject&#x27;, &#x27;Message Body&#x27;).deliver_now <span class=\"comment\">#测试发送邮件是否成功</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>测试web页面访问</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">输入IP地址，直接访问，会出来一个界面，它默认用户是root，直接输入密码就可以（设置密码）</span><br></pre></td></tr></table></figure>\n\n<p><strong>在服务器通过在git客户端</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># git clone git@192.168.246.214:root/testapp.git</span></span><br><span class=\"line\">Cloning into &#x27;testapp&#x27;...</span><br><span class=\"line\">remote: Enumerating objects: 6, done.</span><br><span class=\"line\">remote: Counting objects: 100% (6/6), done.</span><br><span class=\"line\">remote: Compressing objects: 100% (4/4), done.</span><br><span class=\"line\">remote: Total 6 (delta 0), reused 0 (delta 0)</span><br><span class=\"line\">Receiving objects: 100% (6/6), done.</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">testapp</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># cd testapp/</span></span><br><span class=\"line\"><span class=\"section\">[root@client testapp]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">test.txt  同步时间.txt</span><br><span class=\"line\"><span class=\"section\">[root@client testapp]</span><span class=\"comment\">#</span></span><br><span class=\"line\"></span><br><span class=\"line\">注意:如果克隆不下来可以重新使用命令生成私钥</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># ssh-keygen -t rsa #然后将公钥添加到gitlab中。</span></span><br><span class=\"line\"></span><br><span class=\"line\">使用http的</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># rm -rf testgit/</span></span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># git clone http://192.168.246.214/root/testapp.git</span></span><br><span class=\"line\">Cloning into &#x27;testapp&#x27;...</span><br><span class=\"line\">Username for &#x27;http://192.168.246.214&#x27;: root</span><br><span class=\"line\">Password for &#x27;http://root@192.168.246.214&#x27;:12345678  <span class=\"comment\">#为自己设置的密码</span></span><br><span class=\"line\">remote: Enumerating objects: 6, done.</span><br><span class=\"line\">remote: Counting objects: 100% (6/6), done.</span><br><span class=\"line\">remote: Compressing objects: 100% (4/4), done.</span><br><span class=\"line\">remote: Total 6 (delta 0), reused 0 (delta 0)</span><br><span class=\"line\">Unpacking objects: 100% (6/6), done.</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">testapp</span><br><span class=\"line\"></span><br><span class=\"line\">提交到远程gitlab仓库</span><br><span class=\"line\"><span class=\"section\">[root@client ~]</span><span class=\"comment\"># cd testapp/</span></span><br><span class=\"line\"><span class=\"section\">[root@client testapp]</span><span class=\"comment\"># vi update.txt</span></span><br><span class=\"line\">1000phone</span><br><span class=\"line\"><span class=\"section\">[root@client testapp]</span><span class=\"comment\"># git add .</span></span><br><span class=\"line\"><span class=\"section\">[root@client testapp]</span><span class=\"comment\"># git commit -m &#x27;updata-test&#x27;</span></span><br><span class=\"line\"><span class=\"section\">[root@client testapp]</span><span class=\"comment\"># git push origin master</span></span><br><span class=\"line\">Counting objects: 4, done.</span><br><span class=\"line\">Compressing objects: 100% (2/2), done.</span><br><span class=\"line\">Writing objects: 100% (3/3), 266 bytes | 0 bytes/s, done.</span><br><span class=\"line\">Total 3 (delta 1), reused 0 (delta 0)</span><br><span class=\"line\">To git@192.168.153.156:root/testapp.git</span><br><span class=\"line\">   4f35d4b..a0067ea  master -&gt; master</span><br></pre></td></tr></table></figure>\n\n<p><strong>Gitlab 备份与恢复</strong></p>\n<p><strong>1、查看系统版本和软件版本</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># cat /etc/redhat-release </span></span><br><span class=\"line\">CentOS Linux release 7.4.1708 (Core)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># cat /opt/gitlab/embedded/service/gitlab-rails/VERSION</span></span><br><span class=\"line\">13.1.1</span><br></pre></td></tr></table></figure>\n\n<p><strong>2、数据备份</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">打开/etc/gitlab/gitlab.rb配置文件，查看一个和备份相关的配置项：</span><br><span class=\"line\">vim /etc/gitlab/gitlab.rb</span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;backup_path&#x27;]</span> = &quot;/var/opt/gitlab/backups&quot;\t<span class=\"comment\">#备份的路径</span></span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;backup_archive_permissions&#x27;]</span> = 0644\t\t<span class=\"comment\">#备份文件的默认权限</span></span><br><span class=\"line\">gitlab_rails<span class=\"section\">[&#x27;backup_keep_time&#x27;]</span> = 604800\t\t\t\t<span class=\"comment\">#保留时长，秒为单位</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重启</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># gitlab-ctl reconfigure</span></span><br><span class=\"line\">或者</span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># gitlab-ctl  restart</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行备份命令进行备份</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># /opt/gitlab/bin/gitlab-rake gitlab:backup:create</span></span><br><span class=\"line\"></span><br><span class=\"line\">也可以添加到 crontab -e 中定时执行：</span><br><span class=\"line\">0 2 * * * /opt/gitlab/bin/gitlab-rake gitlab:backup:create </span><br><span class=\"line\"></span><br><span class=\"line\">备份完成，会在备份目录中生成一个当天日期的tar包。</span><br><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># ls /var/opt/gitlab/backups/</span></span><br><span class=\"line\">1588774133_2020_05_06_12.10.3_gitlab_backup.tar</span><br></pre></td></tr></table></figure>\n\n<p><strong>数据恢复</strong></p>\n<p><strong>特别注意：</strong></p>\n<p><code>备份目录和gitlab.rb中定义的备份目录必须一致</code><br><code>GitLab的版本和备份文件中的版本必须一致，否则还原时会报错</code></p>\n<p><strong>在恢复之前，可以删除一个文件，以便查看效果</strong></p>\n<p><strong>执行恢复操作：</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@git-server ~]</span><span class=\"comment\"># cd /var/opt/gitlab/backups/</span></span><br><span class=\"line\"><span class=\"section\">[root@git-server backups]</span><span class=\"comment\"># gitlab-rake gitlab:backup:restore BACKUP=1588774133_2020_05_06_12.10.3</span></span><br><span class=\"line\">注意恢复文件的名称</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 中途会输入2次yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">恢复完成后，或者重启服务，再打开浏览器进行访问，发现数据和之前的一致：</span><br><span class=\"line\"><span class=\"section\">[root@git-server backups]</span><span class=\"comment\"># gitlab-ctl  restart</span></span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Gitlab"]},{"title":"hexo博客部署","url":"/2025/01/17/hexo%E5%8D%9A%E5%AE%A2%E9%83%A8%E7%BD%B2/","content":"<p>博客搭建教程视频地址：<a href=\"https://www.bilibili.com/video/BV1nY6xYmEw7?buvid=YD44F3D7CA9FF4654EA985A08644F4A38FB0&from_spmid=tm.recommend.0.0&is_story_h5=false&mid=QY8SLP3aFxWc3ZZhivkAwX8FTQ/SZMtL1rElX6M3iMo=&plat_id=116&share_from=ugc&share_medium=iphone&share_plat=ios&share_session_id=977D55C6-F8AF-4D06-88FF-5BF8DBEDBED8&share_source=COPY&share_tag=s_i&spmid=united.player-video-detail.0.0&timestamp=1735960479&unique_k=MFZ2A8W&up_id=258944527&vd_source=2faa5edeffeb71a8abb2307ca70fa880\">https://www.bilibili.com/video/BV1nY6xYmEw7?buvid=YD44F3D7CA9FF4654EA985A08644F4A38FB0&amp;from_spmid=tm.recommend.0.0&amp;is_story_h5=false&amp;mid=QY8SLP3aFxWc3ZZhivkAwX8FTQ%2FSZMtL1rElX6M3iMo%3D&amp;plat_id=116&amp;share_from=ugc&amp;share_medium=iphone&amp;share_plat=ios&amp;share_session_id=977D55C6-F8AF-4D06-88FF-5BF8DBEDBED8&amp;share_source=COPY&amp;share_tag=s_i&amp;spmid=united.player-video-detail.0.0&amp;timestamp=1735960479&amp;unique_k=MFZ2A8W&amp;up_id=258944527&amp;vd_source=2faa5edeffeb71a8abb2307ca70fa880</a><br>1、环境准备</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">nodejs-18以上，git</span><br><span class=\"line\"><span class=\"comment\"># 验证</span></span><br><span class=\"line\">node -v</span><br><span class=\"line\">npm -v</span><br></pre></td></tr></table></figure>\n\n<p>2、安装hexo客户端</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo是一个静态的博客框架，托管与gitee</span><br><span class=\"line\"># 更换为国内的npm源</span><br><span class=\"line\">npm config set registry https://registry.npmmirror.com</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装hexo客户端\"><a href=\"#安装hexo客户端\" class=\"headerlink\" title=\"安装hexo客户端\"></a>安装hexo客户端</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">npm install -g hexo-cli</span><br></pre></td></tr></table></figure>\n<h1 id=\"使用hexo初始化一个文件夹，名字可以自定义，用于存放博客文章的文件夹\"><a href=\"#使用hexo初始化一个文件夹，名字可以自定义，用于存放博客文章的文件夹\" class=\"headerlink\" title=\"使用hexo初始化一个文件夹，名字可以自定义，用于存放博客文章的文件夹\"></a>使用hexo初始化一个文件夹，名字可以自定义，用于存放博客文章的文件夹</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo init my-blog</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装依赖包\"><a href=\"#安装依赖包\" class=\"headerlink\" title=\"安装依赖包\"></a>安装依赖包</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd my-blog</span><br><span class=\"line\">npm install </span><br></pre></td></tr></table></figure>\n<h1 id=\"前期准备完成，install完后会生成以下文件\"><a href=\"#前期准备完成，install完后会生成以下文件\" class=\"headerlink\" title=\"前期准备完成，install完后会生成以下文件\"></a>前期准备完成，install完后会生成以下文件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost my-blog]# ls</span><br><span class=\"line\">_config.fluid.yml      _config.yml  node_modules  package-lock.json  README.en.md  scaffolds  themes</span><br><span class=\"line\">_config.landscape.yml  db.json      package.json  public             README.md     source</span><br></pre></td></tr></table></figure>\n\n<p>3、配置文件简介</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">_config.yaml：主文件夹，有博客名，作者等信息</span><br><span class=\"line\">source/_posts：用于存放我们文章的目录</span><br><span class=\"line\">themes：目录下存放的的博客的主题配置文件</span><br></pre></td></tr></table></figure>\n<p>4、启动hexo</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 启动预览博客页面</span><br><span class=\"line\">hexo generate &amp;&amp; hexo server</span><br></pre></td></tr></table></figure>\n<h1 id=\"会生成个登入地址，用于在页面访问\"><a href=\"#会生成个登入地址，用于在页面访问\" class=\"headerlink\" title=\"会生成个登入地址，用于在页面访问\"></a>会生成个登入地址，用于在页面访问</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">http://localhost:4000/ </span><br></pre></td></tr></table></figure>\n<p>5、创建gitee&#x2F;githup仓库</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># gitee创建blog仓库</span><br><span class=\"line\"></span><br><span class=\"line\"># 初始化</span><br><span class=\"line\">git init</span><br><span class=\"line\"># 设置远程仓库</span><br><span class=\"line\">git remote add origin git@github.com:xubaodong0511/xubaodong0511.github.io.git</span><br><span class=\"line\"># 更换远程仓库的命令</span><br><span class=\"line\">git remote set-url origin git@github.com:xubaodong0511/blog.io.git</span><br><span class=\"line\"># 验证在哪个远程仓库</span><br><span class=\"line\">git remote -v</span><br><span class=\"line\"></span><br><span class=\"line\"># github上配置ssh密钥的时候需要在服务器上创建config文件，将以下内容添加到config文件中并保存</span><br><span class=\"line\">Host github.com</span><br><span class=\"line\">  Hostname ssh.github.com</span><br><span class=\"line\">  Port 443</span><br><span class=\"line\"># 拉取、推送文件</span><br><span class=\"line\">git clone git@github.com:xubaodong0511/blog.io.git</span><br><span class=\"line\">git push -u origin main --force</span><br></pre></td></tr></table></figure>\n<p>6、修改配置文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 修改_config.yml文件，在末尾添加</span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  type: &#x27;&#x27;</span><br><span class=\"line\">  # 添加以下两行，git@gitee.com:gitee用户名/仓库名.git，branch指定分支</span><br><span class=\"line\">  repository: git@github.com:xubaodong0511/xubaodong0511.github.io.git</span><br><span class=\"line\">  branch: main</span><br><span class=\"line\">                   </span><br><span class=\"line\">注释：使用cursor运行hexo时会有管理员权限问题</span><br><span class=\"line\">解决：退出重新以管理员身份运行，并执行`Set-ExecutionPolicy RemoteSigned`，如果有选择输入Y</span><br></pre></td></tr></table></figure>\n<p>7、创建、及发布文章</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 创建名为第一篇博客名的文章</span><br><span class=\"line\">[root@localhost my-blog]# hexo new post 我的第一篇博客</span><br><span class=\"line\">INFO  Validating config</span><br><span class=\"line\">INFO  Created: ~/my-blog/source/_posts/我的第一篇博客.md</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装hexo-git插件\"><a href=\"#安装hexo-git插件\" class=\"headerlink\" title=\"安装hexo-git插件\"></a>安装hexo-git插件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure>\n<h1 id=\"发布文章\"><a href=\"#发布文章\" class=\"headerlink\" title=\"发布文章\"></a>发布文章</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</span><br><span class=\"line\">或</span><br><span class=\"line\">hexo c &amp;&amp; hexo g &amp;&amp; hexo d</span><br></pre></td></tr></table></figure>\n<p>8、cloudflare托管网站，域名代理</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 点击worker和pages</span><br><span class=\"line\"># 选择pages</span><br><span class=\"line\"># 点击连接到git</span><br><span class=\"line\"># 选择githup或gitee</span><br><span class=\"line\"># 选第二个，only select repositories(选择仓库)</span><br><span class=\"line\"># 授权</span><br><span class=\"line\"># 确认仓库，开始设置</span><br><span class=\"line\"># 确认分支，保存设置开始部署</span><br><span class=\"line\"># 继续处理项目</span><br><span class=\"line\"># 自定义域</span><br></pre></td></tr></table></figure>\n<p>9、设置主题</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">githup上搜索hexo-theme-fluid</span><br><span class=\"line\">或直接打开以下地址</span><br><span class=\"line\">https://github.com/fluid-dev/hexo-theme-fluid?tab=readme-ov-file</span><br><span class=\"line\"></span><br><span class=\"line\">方式一：</span><br><span class=\"line\"># Hexo 5.0.0 版本以上，推荐通过 npm 直接安装，进入博客目录执行命令：</span><br><span class=\"line\">npm install --save hexo-theme-fluid</span><br><span class=\"line\">然后在博客目录下创建 _config.fluid.yml，将主题的 _config.yml 内容复制进去。</span><br><span class=\"line\">方式二：</span><br><span class=\"line\"># 修改 Hexo 博客目录中的 _config.yml：</span><br><span class=\"line\">theme: fluid  # 指定主题</span><br><span class=\"line\">language: zh-CN  # 指定语言，会影响主题显示的语言，按需修改</span><br></pre></td></tr></table></figure>\n<h1 id=\"主题配置\"><a href=\"#主题配置\" class=\"headerlink\" title=\"主题配置\"></a>主题配置</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 创建「关于页」，首次使用主题的「关于页」需要手动创建：</span><br><span class=\"line\">hexo new page about</span><br><span class=\"line\">创建成功后，编辑博客目录下 /source/about/index.md，添加 layout 属性。</span><br><span class=\"line\">修改后的文件示例如下：</span><br><span class=\"line\">---</span><br><span class=\"line\">title: about</span><br><span class=\"line\">layout: about</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n<h1 id=\"重新启动hexo\"><a href=\"#重新启动hexo\" class=\"headerlink\" title=\"重新启动hexo\"></a>重新启动hexo</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">hexo clean &amp;&amp; hexo generate &amp;&amp; hexo deploy</span><br></pre></td></tr></table></figure>\n<p>10、设置文章的标签</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 在文字的开头添加以下内容</span><br><span class=\"line\">---</span><br><span class=\"line\">title: gicc升级</span><br><span class=\"line\">date: 2025-01-05</span><br><span class=\"line\">tags: [Linux运维，系统]</span><br><span class=\"line\">---</span><br></pre></td></tr></table></figure>\n<p>11、增加评论功能</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 插件地址</span><br><span class=\"line\">https://github.com/apps/utterances</span><br><span class=\"line\"></span><br><span class=\"line\"># 点击install安装</span><br><span class=\"line\"></span><br><span class=\"line\"># 选第二个，only select repositories(选择仓库)</span><br><span class=\"line\"></span><br><span class=\"line\"># 在githup的blog仓库点settings设置</span><br><span class=\"line\"># 在下面找到Features下的Discussion的选项，选择打勾</span><br><span class=\"line\"># 修改_config.fluid.yml 文件，在最下发添加以下内容</span><br><span class=\"line\"># discuss</span><br><span class=\"line\">post:</span><br><span class=\"line\">  comments:</span><br><span class=\"line\">    enable: true</span><br><span class=\"line\">    type: utterances</span><br><span class=\"line\"></span><br><span class=\"line\">utterances:</span><br><span class=\"line\">  repo: xubaodong0511/xubaodong0511.github.io</span><br><span class=\"line\">  issue_term: pathname</span><br><span class=\"line\">  label: utterances</span><br><span class=\"line\">  theme: github-light</span><br><span class=\"line\">  theme_dark: github-dark</span><br><span class=\"line\">  crossorigin: anonymous</span><br></pre></td></tr></table></figure>\n<p>12、重启hexo</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 启动hexo</span><br><span class=\"line\">hexo clean &amp;&amp; hexo generate &amp;&amp; hexo server</span><br><span class=\"line\">或</span><br><span class=\"line\">nohup hexo clean &amp;&amp; hexo generate &amp;&amp; hexo server &amp;</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Hexo"]},{"title":"jenkins流水线发布项目到K8S集群实现CI/CD","url":"/2025/11/06/jenkins%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%8F%91%E5%B8%83%E9%A1%B9%E7%9B%AE%E5%88%B0K8S%E9%9B%86%E7%BE%A4%E5%AE%9E%E7%8E%B0CI-CD/","content":"<p>jenkins流水线发布项目到K8S集群实现CI&#x2F;CD</p>\n<h1 id=\"准备环境\"><a href=\"#准备环境\" class=\"headerlink\" title=\"准备环境\"></a>准备环境</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld  &amp;&amp; setenforce <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">10.31</span><span class=\"number\">.162</span><span class=\"number\">.133</span>\tmaster</span><br><span class=\"line\"><span class=\"number\">10.31</span><span class=\"number\">.162</span><span class=\"number\">.134</span>\tnode-<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"number\">10.31</span><span class=\"number\">.162</span><span class=\"number\">.135</span>\tnode2</span><br><span class=\"line\"><span class=\"number\">10.31</span><span class=\"number\">.162</span><span class=\"number\">.124</span>\tharbor</span><br><span class=\"line\"><span class=\"number\">10.31</span><span class=\"number\">.162</span><span class=\"number\">.35</span>\t  jenkins/git\t\t------&gt;充当开发角色模拟提交代码到gitlab</span><br><span class=\"line\">git仓库我们这里使用gitee代替gitlab</span><br></pre></td></tr></table></figure>\n<h1 id=\"配置jenkins服务器\"><a href=\"#配置jenkins服务器\" class=\"headerlink\" title=\"配置jenkins服务器\"></a>配置jenkins服务器</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>.安装git客户端与docker</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># yum install -y git</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2 git</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># yum install -y docker</span></span><br><span class=\"line\">启动并设置开机启动</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span>.安装jenkins---略</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span>.jenkins页面上额外安装插件</span><br><span class=\"line\">docker 和pipeline 插件</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"登入10-31-162-35-8080-jenkins安装插件\"><a href=\"#登入10-31-162-35-8080-jenkins安装插件\" class=\"headerlink\" title=\"登入10.31.162.35:8080&#x2F;jenkins安装插件\"></a>登入10.31.162.35:8080&#x2F;jenkins安装插件</h1><p><img src=\"/upload/K8S-CICD1.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"指定docker环境\"><a href=\"#指定docker环境\" class=\"headerlink\" title=\"指定docker环境\"></a>指定docker环境</h1><p><img src=\"/upload/K8S-CICD2.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"由于jenkins最后要将生成的镜像上传到harbor仓库，需要在jenkins上面配置登陆harbor仓库\"><a href=\"#由于jenkins最后要将生成的镜像上传到harbor仓库，需要在jenkins上面配置登陆harbor仓库\" class=\"headerlink\" title=\"由于jenkins最后要将生成的镜像上传到harbor仓库，需要在jenkins上面配置登陆harbor仓库\"></a>由于jenkins最后要将生成的镜像上传到harbor仓库，需要在jenkins上面配置登陆harbor仓库</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># cat /etc/docker/daemon.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"string\">&quot;exec-opts&quot;</span>:[<span class=\"string\">&quot;native.cgroupdriver=systemd&quot;</span>],</span><br><span class=\"line\"><span class=\"string\">&quot;insecure-registries&quot;</span>: [<span class=\"string\">&quot;10.31.162.124&quot;</span>]\t\t<span class=\"comment\">#添加hatbor仓库</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># systemctl restart docker </span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># docker login -u admin -p Harbor12345 10.31.162.124  #测试</span></span><br><span class=\"line\">Login Succeeded</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"登陆harbor创建相应项目的仓库\"><a href=\"#登陆harbor创建相应项目的仓库\" class=\"headerlink\" title=\"登陆harbor创建相应项目的仓库\"></a>登陆harbor创建相应项目的仓库</h1><p><img src=\"/upload/K8S-CICD3.webp\" alt=\"K8S-CICD1.webp\"></p>\n<p><img src=\"/upload/K8S-CICD4.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"更新代码仓库\"><a href=\"#更新代码仓库\" class=\"headerlink\" title=\"更新代码仓库\"></a>更新代码仓库</h1><p><img src=\"/upload/K8S-CICD5.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"在git服务器上面创建公钥和私钥，将公钥上传到gitee\"><a href=\"#在git服务器上面创建公钥和私钥，将公钥上传到gitee\" class=\"headerlink\" title=\"在git服务器上面创建公钥和私钥，将公钥上传到gitee\"></a>在git服务器上面创建公钥和私钥，将公钥上传到gitee</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># ssh-keygen</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># cd .ssh/</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server .ssh]<span class=\"comment\"># ls</span></span><br><span class=\"line\">id_rsa  id_rsa.pub  known_hosts</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server .ssh]<span class=\"comment\"># cat id_rsa.pub </span></span><br><span class=\"line\">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6rVm2pdguGz+Y72JRBk/lpbh3jfqriNWqv3QlP6iVP+tUTRZiGB5pcjCC8cHg6w64XPj4xRpQcj+Aviq7ORSuPGSk5hCMz9O7/wUMJsP4uVIvm5P/rwQBppdS3+qGE6COkhHdEY+GcjpLFVG2mW+ksQe3W2bvBKe7msNpqgUtQs+z99UXf9LlnGUCrRF/oddPSgq3tJDXZoYzdEb3a7bZDf3j72XOYubX0fcygS1fG615+xnJP9knfoKkr4YSZkxj25TwPEO5JToPtr4tcOpJRqBA7KrookicuiWeIe7J91mRVH1tx9GWnPMMyXqsy0LcyV2rUUhG4c71W0mEfLzn root<span class=\"variable\">@jenkins</span>-server</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/upload/K8S-CICD6.webp\" alt=\"K8S-CICD1.webp\"></p>\n<p><img src=\"/upload/K8S-CICD7.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"将创建好的仓库克隆到本地\"><a href=\"#将创建好的仓库克隆到本地\" class=\"headerlink\" title=\"将创建好的仓库克隆到本地\"></a>将创建好的仓库克隆到本地</h1><p><img src=\"/upload/K8S-CICD8.webp\" alt=\"K8S-CICD1.webp\"></p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># git clone git@gitee.com:testpm/javaweb.git</span></span><br><span class=\"line\">Cloning into <span class=\"string\">&#x27;javaweb&#x27;</span>...</span><br><span class=\"line\">warning: You appear to have cloned an empty repository.</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># ls</span></span><br><span class=\"line\">javaweb</span><br><span class=\"line\"></span><br><span class=\"line\">克隆测试代码，将测试代码上传到gitlab</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># git clone https://github.com/bingyue/easy-springmvc-maven</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># cd easy-springmvc-maven/</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server easy-springmvc-maven]<span class=\"comment\"># ls</span></span><br><span class=\"line\">pom.xml  README.md  src</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server easy-springmvc-maven]<span class=\"comment\"># cp -r * /root/javaweb/</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server easy-springmvc-maven]<span class=\"comment\"># ls /root/javaweb/</span></span><br><span class=\"line\">pom.xml  README.md  src</span><br><span class=\"line\"></span><br><span class=\"line\">将代码上传到公司的远程仓库</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server easy-springmvc-maven]<span class=\"comment\"># cd /root/javaweb/</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server javaweb]<span class=\"comment\"># git add .</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server javaweb]<span class=\"comment\"># git commit -m &quot;1.0&quot;</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server javaweb]<span class=\"comment\"># git push origin master</span></span><br></pre></td></tr></table></figure>\n\n\n<p><img src=\"/upload/K8S-CICD9.webp\" alt=\"K8S-CICD9.webp\"></p>\n<h1 id=\"编写dockerfile上传仓库\"><a href=\"#编写dockerfile上传仓库\" class=\"headerlink\" title=\"编写dockerfile上传仓库\"></a>编写dockerfile上传仓库</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">编写dockerfile用于生成镜像</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server javaweb]<span class=\"comment\"># cat Dockerfile </span></span><br><span class=\"line\">From daocloud.io/library/tomcat:<span class=\"number\">8.0</span><span class=\"number\">.45</span></span><br><span class=\"line\">RUN rm -rf /usr/<span class=\"keyword\">local</span>/tomcat/webapps/*</span><br><span class=\"line\">ADD ./target/easy-springmvc-maven.war /usr/<span class=\"keyword\">local</span>/tomcat/webapps/</span><br><span class=\"line\">EXPOSE <span class=\"number\">8080</span></span><br><span class=\"line\">ENTRYPOINT [<span class=\"string\">&quot;/usr/local/tomcat/bin/catalina.sh&quot;</span>,<span class=\"string\">&quot;run&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">重新上传到远程仓库</span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server javaweb]<span class=\"comment\"># git add -A </span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server javaweb]<span class=\"comment\"># git commit -m &quot;v2.0&quot;</span></span><br><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server javaweb]<span class=\"comment\"># git push origin master</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/upload/K8S-CICD10.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"配置jenkins流水线进行打包编译生成镜像并推送到公司的harbor仓库\"><a href=\"#配置jenkins流水线进行打包编译生成镜像并推送到公司的harbor仓库\" class=\"headerlink\" title=\"配置jenkins流水线进行打包编译生成镜像并推送到公司的harbor仓库\"></a>配置jenkins流水线进行打包编译生成镜像并推送到公司的harbor仓库</h1><p><img src=\"/upload/K8S-CICD11.webp\" alt=\"K8S-CICD1.webp\"></p>\n<p><img src=\"/upload/K8S-CICD12.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"基本配置略，开始编写pipeline脚本\"><a href=\"#基本配置略，开始编写pipeline脚本\" class=\"headerlink\" title=\"基本配置略，开始编写pipeline脚本\"></a>基本配置略，开始编写pipeline脚本</h1><p><img src=\"/upload/K8S-CICD13.webp\" alt=\"K8S-CICD1.webp\"></p>\n<p><img src=\"/upload/K8S-CICD14.webp\" alt=\"K8S-CICD1.webp\"></p>\n<p><img src=\"/upload/K8S-CICD15.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"复制私钥，创建用户\"><a href=\"#复制私钥，创建用户\" class=\"headerlink\" title=\"复制私钥，创建用户\"></a>复制私钥，创建用户</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@jenkins</span>-server ~]<span class=\"comment\"># cat /root/.ssh/id_rsa</span></span><br><span class=\"line\"></span><br><span class=\"line\">复制私钥，生成用户</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/upload/K8S-CICD16.webp\" alt=\"K8S-CICD1.webp\"></p>\n<p><img src=\"/upload/K8S-CICD17.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"流水线完整脚本内容\"><a href=\"#流水线完整脚本内容\" class=\"headerlink\" title=\"流水线完整脚本内容:\"></a>流水线完整脚本内容:</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\"></span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;pull code&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                checkout([<span class=\"variable\">$class</span>: <span class=\"string\">&#x27;GitSCM&#x27;</span>, branches: [[name: <span class=\"string\">&#x27;*/master&#x27;</span>]], extensions: [], userRemoteConfigs: [[credentialsId: <span class=\"string\">&#x27;da64354c-fffc-4fbf-9865-bf9c74e25b95&#x27;</span>, url: <span class=\"string\">&#x27;git@gitee.com:testpm/javaweb.git&#x27;</span>]]])\t\t<span class=\"comment\">#将生成的流水线脚本复制到到这里</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;build code&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh <span class=\"string\">&#x27;cd /root/.jenkins/workspace/test-web1&#x27;</span></span><br><span class=\"line\">                sh <span class=\"string\">&#x27;mvn clean package&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;build image&#x27;</span>)&#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh <span class=\"string\">&#x27;docker build -t 10.31.162.124/javapm/javaweb:v2.0 .&#x27;</span>\t<span class=\"comment\">#改成自己的仓库地址</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;push image to harbor&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh <span class=\"string\">&#x27;docker login -u admin -p Harbor12345 10.31.162.124&#x27;</span></span><br><span class=\"line\">                sh <span class=\"string\">&#x27;docker push 10.31.162.124/javapm/javaweb:v2.0 &amp;&amp; docker rmi 10.31.162.124/javapm/javaweb:v2.0&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/upload/K8S-CICD18.webp\" alt=\"K8S-CICD1.webp\"></p>\n<p><img src=\"/upload/K8S-CICD19.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"登陆harbor仓库查看镜像是否上传成功\"><a href=\"#登陆harbor仓库查看镜像是否上传成功\" class=\"headerlink\" title=\"登陆harbor仓库查看镜像是否上传成功\"></a>登陆harbor仓库查看镜像是否上传成功</h1><p><img src=\"/upload/K8S-CICD20.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"K8S集群上部署Harbor仓库\"><a href=\"#K8S集群上部署Harbor仓库\" class=\"headerlink\" title=\"K8S集群上部署Harbor仓库\"></a>K8S集群上部署Harbor仓库</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">所有机器上都操作，创建secret需要，不然创建不成功</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> ~]<span class=\"comment\"># vim /etc/docker/daemon.json   #编辑文件</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"string\">&quot;insecure-registries&quot;</span>: [<span class=\"string\">&quot;10.31.162.133&quot;</span>]   <span class=\"comment\">#该ip为部署仓库机器的ip</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> ~]<span class=\"comment\"># # systemctl restart docker</span></span><br><span class=\"line\"></span><br><span class=\"line\">验证是否可以登入</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> ~]<span class=\"comment\"># docker login -u admin -p Harbor 10.31.162.133</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"发布项目到k8s集群，编写deployment进行发布\"><a href=\"#发布项目到k8s集群，编写deployment进行发布\" class=\"headerlink\" title=\"发布项目到k8s集群，编写deployment进行发布\"></a>发布项目到k8s集群，编写deployment进行发布</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">查看master上面认证的密钥文件</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># cat /root/.docker/config.json | base64 -w 0</span></span><br><span class=\"line\">ewoJImF1dGhzIjogewoJCSIxMC4zMS4xNjIuMTI0IjogewoJCQkiYXV0aCI6ICJZV1J0YVc0NlNHRnlZbTl5TVRJek5EVT0iCgkJfQoJfQp9</span><br><span class=\"line\"></span><br><span class=\"line\">创建登入harbor仓库的secret</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># cat secret.yaml </span></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Secret</span><br><span class=\"line\">metadata:</span><br><span class=\"line\"> name: harbor-login</span><br><span class=\"line\"> labels:</span><br><span class=\"line\">  app: harbor</span><br><span class=\"line\">type: kubernetes.io/dockerconfigjson</span><br><span class=\"line\">data:</span><br><span class=\"line\"> .dockerconfigjson: ewoJImF1dGhzIjogewoJCSIxMC4zMS4xNjIuMTI0IjogewoJCQkiYXV0aCI6ICJZV1J0YVc0NlNHRnlZbTl5TVRJek5EVT0iCgkJfQoJfQp9      <span class=\"comment\">#将上面生成的密钥复制到这里</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># systemctl apply -f secret.yaml</span></span><br><span class=\"line\">secret/harbor-login created</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># cat java-dep.yaml </span></span><br><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\"> name: tomcat-dep</span><br><span class=\"line\">spec:</span><br><span class=\"line\"> selector:</span><br><span class=\"line\">  matchLabels:</span><br><span class=\"line\">   app: java</span><br><span class=\"line\"> replicas: <span class=\"number\">2</span></span><br><span class=\"line\"> template:</span><br><span class=\"line\">  metadata:</span><br><span class=\"line\">   labels:</span><br><span class=\"line\">    app: java</span><br><span class=\"line\">  spec:</span><br><span class=\"line\">   volumes:</span><br><span class=\"line\">   - name: <span class=\"keyword\">log</span>-vol</span><br><span class=\"line\">     hostPath:</span><br><span class=\"line\">      path: <span class=\"regexp\">/var/</span>javaweb/<span class=\"keyword\">log</span></span><br><span class=\"line\">   containers:</span><br><span class=\"line\">   - name: tomcat</span><br><span class=\"line\">     image: <span class=\"number\">10.31</span><span class=\"number\">.162</span><span class=\"number\">.124</span>/javapm/javaweb:<span class=\"number\">v2.0</span></span><br><span class=\"line\">     ports:</span><br><span class=\"line\">     - containerPort: <span class=\"number\">8080</span></span><br><span class=\"line\">     volumeMounts:</span><br><span class=\"line\">     - mountPath: <span class=\"string\">&quot;/usr/local/tomcat/logs&quot;</span></span><br><span class=\"line\">       name: <span class=\"keyword\">log</span>-vol</span><br><span class=\"line\">   imagePullSecrets:</span><br><span class=\"line\">   - name: harbor-login</span><br><span class=\"line\">   </span><br><span class=\"line\">创建depolyment</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># kubectl apply -f java-dep.yaml</span></span><br><span class=\"line\">deployment.apps/tomcat-dep created</span><br><span class=\"line\"></span><br><span class=\"line\">查看pod有没有运行起来</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># kubectl get po</span></span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">tomcat-dep-7bd9fb7df9-4fz6x   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          26s</span><br><span class=\"line\">tomcat-dep-7bd9fb7df9-wsbth   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          26s</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置Ingress实现访问\"><a href=\"#配置Ingress实现访问\" class=\"headerlink\" title=\"配置Ingress实现访问\"></a>配置Ingress实现访问</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">下载ingress配置文件: 如果下载不下来记得添加解析</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> ~]<span class=\"comment\"># cat /etc/hosts</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class=\"line\">::<span class=\"number\">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.116</span><span class=\"number\">.138</span> master</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.116</span><span class=\"number\">.130</span> node1</span><br><span class=\"line\"><span class=\"number\">192.168</span><span class=\"number\">.116</span><span class=\"number\">.131</span> node2</span><br><span class=\"line\"><span class=\"number\">199.232</span><span class=\"number\">.28</span><span class=\"number\">.133</span> raw.githubusercontent.com  <span class=\"comment\">#解析github的地址</span></span><br><span class=\"line\"></span><br><span class=\"line\">可以直接进行这一步进行下载</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># cd /mnt/</span></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.0/deploy/static/provider/cloud/deploy.yaml</span></span><br><span class=\"line\">修改配置文件</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># vim deploy.yaml</span></span><br><span class=\"line\">找到已下apiserver的版本：</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: DaemonSet  <span class=\"comment\">#将原来的Deployment修改为DaemonSet</span></span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/component: controller</span><br><span class=\"line\">    app.kubernetes.io/instance: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/part-of: ingress-nginx</span><br><span class=\"line\">    app.kubernetes.io/version: <span class=\"number\">1.3</span>.<span class=\"number\">0</span></span><br><span class=\"line\">  name: ingress-nginx-controller</span><br><span class=\"line\">  namespace: ingress-nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  minReadySeconds: <span class=\"number\">0</span></span><br><span class=\"line\">  revisionHistoryLimit: <span class=\"number\">10</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app.kubernetes.io/component: controller</span><br><span class=\"line\">      app.kubernetes.io/instance: ingress-nginx</span><br><span class=\"line\">      app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app.kubernetes.io/component: controller</span><br><span class=\"line\">        app.kubernetes.io/instance: ingress-nginx</span><br><span class=\"line\">        app.kubernetes.io/name: ingress-nginx</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      hostNetwork: true  <span class=\"comment\">#添加共享到主机网络</span></span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - args:</span><br><span class=\"line\">        - <span class=\"regexp\">/nginx-ingress-controller</span></span><br><span class=\"line\"><span class=\"regexp\">        - --publish-service=$(POD_NAMESPACE)/ingr</span>ess-nginx-controller</span><br><span class=\"line\">        - --election-id=ingress-controller-leader</span><br><span class=\"line\">        - --controller-<span class=\"class\"><span class=\"keyword\">class</span>=<span class=\"title\">k8s</span>.<span class=\"title\">io</span>/<span class=\"title\">ingress</span>-<span class=\"title\">nginx</span></span></span><br><span class=\"line\"><span class=\"class\">        - --<span class=\"title\">ingress</span>-<span class=\"title\">class</span>=<span class=\"title\">nginx</span></span></span><br><span class=\"line\"><span class=\"class\">        - --<span class=\"title\">configmap</span>=$(<span class=\"title\">POD_NAMESPACE</span>)/<span class=\"title\">ingress</span>-<span class=\"title\">nginx</span>-<span class=\"title\">controller</span></span></span><br><span class=\"line\"><span class=\"class\">        - --<span class=\"title\">validating</span>-<span class=\"title\">webhook</span>=:<span class=\"number\">8443</span></span></span><br><span class=\"line\"><span class=\"class\">        - --<span class=\"title\">validating</span>-<span class=\"title\">webhook</span>-<span class=\"title\">certificate</span>=/<span class=\"title\">usr</span>/<span class=\"title\">local</span>/<span class=\"title\">certificates</span>/<span class=\"title\">cert</span></span></span><br><span class=\"line\"><span class=\"class\">        - --<span class=\"title\">validating</span>-<span class=\"title\">webhook</span>-<span class=\"title\">key</span>=/<span class=\"title\">usr</span>/<span class=\"title\">local</span>/<span class=\"title\">certificates</span>/<span class=\"title\">key</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">env</span>:</span></span><br><span class=\"line\"><span class=\"class\">        - <span class=\"title\">name</span>: <span class=\"title\">POD_NAME</span></span></span><br><span class=\"line\"><span class=\"class\">          <span class=\"title\">valueFrom</span>:</span></span><br><span class=\"line\"><span class=\"class\">            <span class=\"title\">fieldRef</span>:</span></span><br><span class=\"line\"><span class=\"class\">              <span class=\"title\">fieldPath</span>: <span class=\"title\">metadata</span>.<span class=\"title\">name</span></span></span><br><span class=\"line\"><span class=\"class\">        - <span class=\"title\">name</span>: <span class=\"title\">POD_NAMESPACE</span></span></span><br><span class=\"line\"><span class=\"class\">          <span class=\"title\">valueFrom</span>:</span></span><br><span class=\"line\"><span class=\"class\">            <span class=\"title\">fieldRef</span>:</span></span><br><span class=\"line\"><span class=\"class\">              <span class=\"title\">fieldPath</span>: <span class=\"title\">metadata</span>.<span class=\"title\">namespace</span></span></span><br><span class=\"line\"><span class=\"class\">        - <span class=\"title\">name</span>: <span class=\"title\">LD_PRELOAD</span></span></span><br><span class=\"line\"><span class=\"class\">          <span class=\"title\">value</span>: /<span class=\"title\">usr</span>/<span class=\"title\">local</span>/<span class=\"title\">lib</span>/<span class=\"title\">libmimalloc</span>.<span class=\"title\">so</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">image</span>: <span class=\"title\">registry</span>.<span class=\"title\">cn</span>-<span class=\"title\">hangzhou</span>.<span class=\"title\">aliyuncs</span>.<span class=\"title\">com</span>/<span class=\"title\">google_containers</span>/<span class=\"title\">nginx</span>-<span class=\"title\">ingress</span>-<span class=\"title\">controller</span>:<span class=\"title\">v1</span>.<span class=\"number\">3.0</span>@<span class=\"title\">sha256</span>:<span class=\"title\">d1707ca76d3b044ab8a28277a2466a02100ee9f58a86af1535a3edf9323ea1b5</span> \t\t\t#将原来的镜像替换成阿里云仓库的镜像</span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">imagePullPolicy</span>: <span class=\"title\">IfNotPresent</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">lifecycle</span>:</span></span><br><span class=\"line\"><span class=\"class\">          <span class=\"title\">preStop</span>:</span></span><br><span class=\"line\"><span class=\"class\">            <span class=\"title\">exec</span>:</span></span><br><span class=\"line\"><span class=\"class\">              <span class=\"title\">command</span>:</span></span><br><span class=\"line\"><span class=\"class\">              - /<span class=\"title\">wait</span>-<span class=\"title\">shutdown</span></span></span><br><span class=\"line\"><span class=\"class\">   。。。</span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">volumeMounts</span>:</span></span><br><span class=\"line\"><span class=\"class\">        - <span class=\"title\">mountPath</span>: /<span class=\"title\">usr</span>/<span class=\"title\">local</span>/<span class=\"title\">certificates</span>/</span></span><br><span class=\"line\"><span class=\"class\">          <span class=\"title\">name</span>: <span class=\"title\">webhook</span>-<span class=\"title\">cert</span></span></span><br><span class=\"line\"><span class=\"class\">          <span class=\"title\">readOnly</span>: <span class=\"title\">true</span></span></span><br><span class=\"line\"><span class=\"class\">      <span class=\"title\">dnsPolicy</span>: <span class=\"title\">ClusterFirst</span></span></span><br><span class=\"line\"><span class=\"class\">      <span class=\"title\">nodeSelector</span>:</span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">custom</span>/<span class=\"title\">ingress</span>-<span class=\"title\">controller</span>-<span class=\"title\">ready</span>: &quot;<span class=\"title\">true</span>&quot;  #指定运行<span class=\"title\">ingress</span>的<span class=\"title\">node</span>标签</span></span><br><span class=\"line\"><span class=\"class\">      <span class=\"title\">serviceAccountName</span>: <span class=\"title\">ingress</span>-<span class=\"title\">nginx</span></span></span><br><span class=\"line\"><span class=\"class\">      <span class=\"title\">terminationGracePeriodSeconds</span>: <span class=\"number\">300</span></span></span><br><span class=\"line\"><span class=\"class\">      <span class=\"title\">volumes</span>:</span></span><br><span class=\"line\"><span class=\"class\">      - <span class=\"title\">name</span>: <span class=\"title\">webhook</span>-<span class=\"title\">cert</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">secret</span>:</span></span><br><span class=\"line\"><span class=\"class\">          <span class=\"title\">secretName</span>: <span class=\"title\">ingress</span>-<span class=\"title\">nginx</span>-<span class=\"title\">admission</span></span></span><br><span class=\"line\"><span class=\"class\">---</span></span><br><span class=\"line\"><span class=\"class\"></span></span><br><span class=\"line\"><span class=\"class\">#注意:一共有两个镜像需要替换成阿里云仓库的镜像:</span></span><br><span class=\"line\"><span class=\"class\">[<span class=\"title\">root</span>@<span class=\"title\">master</span> ~]# <span class=\"title\">cat</span> <span class=\"title\">deploy</span>.<span class=\"title\">yaml</span> | <span class=\"title\">grep</span> <span class=\"title\">image</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">image</span>: <span class=\"title\">registry</span>.<span class=\"title\">cn</span>-<span class=\"title\">hangzhou</span>.<span class=\"title\">aliyuncs</span>.<span class=\"title\">com</span>/<span class=\"title\">google_containers</span>/<span class=\"title\">nginx</span>-<span class=\"title\">ingress</span>-<span class=\"title\">controller</span>:<span class=\"title\">v1</span>.<span class=\"number\">3.0</span>@<span class=\"title\">sha256</span>:<span class=\"title\">d1707ca76d3b044ab8a28277a2466a02100ee9f58a86af1535a3edf9323ea1b5</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">imagePullPolicy</span>: <span class=\"title\">IfNotPresent</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">image</span>: <span class=\"title\">registry</span>.<span class=\"title\">cn</span>-<span class=\"title\">hangzhou</span>.<span class=\"title\">aliyuncs</span>.<span class=\"title\">com</span>/<span class=\"title\">google_containers</span>/<span class=\"title\">kube</span>-<span class=\"title\">webhook</span>-<span class=\"title\">certgen</span>:<span class=\"title\">v1</span>.<span class=\"number\">1.1</span>@<span class=\"title\">sha256</span>:64<span class=\"title\">d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">imagePullPolicy</span>: <span class=\"title\">IfNotPresent</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">image</span>: <span class=\"title\">registry</span>.<span class=\"title\">cn</span>-<span class=\"title\">hangzhou</span>.<span class=\"title\">aliyuncs</span>.<span class=\"title\">com</span>/<span class=\"title\">google_containers</span>/<span class=\"title\">kube</span>-<span class=\"title\">webhook</span>-<span class=\"title\">certgen</span>:<span class=\"title\">v1</span>.<span class=\"number\">1.1</span>@<span class=\"title\">sha256</span>:64<span class=\"title\">d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660</span></span></span><br><span class=\"line\"><span class=\"class\">        <span class=\"title\">imagePullPolicy</span>: <span class=\"title\">IfNotPresent</span></span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"给两个node节点设置lable\"><a href=\"#给两个node节点设置lable\" class=\"headerlink\" title=\"给两个node节点设置lable\"></a>给两个node节点设置lable</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> ~]<span class=\"comment\"># kubectl label nodes node-1 custom/ingress-controller-ready=true</span></span><br><span class=\"line\">node/node1 labeled</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> ~]<span class=\"comment\"># kubectl label nodes node-2 custom/ingress-controller-ready=true</span></span><br><span class=\"line\">node/node2 labeled</span><br><span class=\"line\"></span><br><span class=\"line\">同时在两个node节点下载镜像</span><br><span class=\"line\">[root<span class=\"variable\">@node1</span> ~]<span class=\"comment\"># docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.3.0</span></span><br><span class=\"line\">[root<span class=\"variable\">@node1</span> ~]<span class=\"comment\"># docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v1.1.1</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建ingress-controller\"><a href=\"#创建ingress-controller\" class=\"headerlink\" title=\"创建ingress-controller\"></a>创建ingress-controller</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">创建deploy</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># kubectl apply -f deploy.yaml </span></span><br><span class=\"line\">namespace/ingress-nginx created</span><br><span class=\"line\">serviceaccount/ingress-nginx created</span><br><span class=\"line\">。。。</span><br><span class=\"line\">ingressclass.networking.k8s.io/nginx created</span><br><span class=\"line\">validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created</span><br><span class=\"line\"></span><br><span class=\"line\">查看ingress-controller资源</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># kubectl get po -n ingress-nginx</span></span><br><span class=\"line\">NAME                                      READY   STATUS      RESTARTS   AGE</span><br><span class=\"line\">ingress-nginx-admission-create--<span class=\"number\">1</span>-vc8xc   <span class=\"number\">0</span>/<span class=\"number\">1</span>     Completed   <span class=\"number\">0</span>          30s</span><br><span class=\"line\">ingress-nginx-admission-patch--<span class=\"number\">1</span>-5crsl    <span class=\"number\">0</span>/<span class=\"number\">1</span>     Completed   <span class=\"number\">1</span>          30s</span><br><span class=\"line\">ingress-nginx-controller-z4nzd            <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running     <span class=\"number\">0</span>          30s</span><br><span class=\"line\">ingress-nginx-controller-zmkpc            <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running     <span class=\"number\">0</span>          30s</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># ls</span></span><br><span class=\"line\">deploy.yaml  java-dep.yaml  secret.yaml</span><br></pre></td></tr></table></figure>\n\n<p>测试ingress</p>\n<h1 id=\"创建service\"><a href=\"#创建service\" class=\"headerlink\" title=\"创建service\"></a>创建service</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># cat java-service.yaml </span></span><br><span class=\"line\">apiVersion: <span class=\"number\">v1</span></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\"> name: <span class=\"keyword\">my</span>-java</span><br><span class=\"line\"> labels:</span><br><span class=\"line\">  run: <span class=\"keyword\">my</span>-java</span><br><span class=\"line\">spec:</span><br><span class=\"line\"> ports:</span><br><span class=\"line\"> - port: <span class=\"number\">80</span></span><br><span class=\"line\">   targetPort: <span class=\"number\">8080</span></span><br><span class=\"line\"> selector:</span><br><span class=\"line\">  app: java</span><br><span class=\"line\">  </span><br><span class=\"line\">创建service</span><br><span class=\"line\">root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># kubectl apply -f java-service.yaml </span></span><br><span class=\"line\">service/<span class=\"keyword\">my</span>-tomcat created</span><br><span class=\"line\"></span><br><span class=\"line\">查看资源</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># kubectl get po</span></span><br><span class=\"line\">NAME                          READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">tomcat-dep-7bd9fb7df9-4fz6x   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          18m</span><br><span class=\"line\">tomcat-dep-7bd9fb7df9-wsbth   <span class=\"number\">1</span>/<span class=\"number\">1</span>     Running   <span class=\"number\">0</span>          18m</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># kubectl get svc</span></span><br><span class=\"line\">NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE</span><br><span class=\"line\">kubernetes   ClusterIP   <span class=\"number\">10.96</span>.<span class=\"number\">0</span>.<span class=\"number\">1</span>        &lt;none&gt;        <span class=\"number\">443</span>/TCP   2d1h</span><br><span class=\"line\"><span class=\"keyword\">my</span>-java      ClusterIP   <span class=\"number\">10.104</span><span class=\"number\">.150</span><span class=\"number\">.165</span>   &lt;none&gt;        <span class=\"number\">80</span>/TCP    27s</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置ingress转发文件\"><a href=\"#配置ingress转发文件\" class=\"headerlink\" title=\"配置ingress转发文件\"></a>配置ingress转发文件</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># cat ingress-test.yaml </span></span><br><span class=\"line\">apiVersion: networking.k8s.io/<span class=\"number\">v1</span></span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\"> name: test-ingress</span><br><span class=\"line\"> namespace: default</span><br><span class=\"line\"> annotations:</span><br><span class=\"line\">  nginx.ingress.kubernetes.io/rewrite-target: <span class=\"regexp\">/easy-springmvc-maven/</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\"> ingressClassName: nginx\t<span class=\"comment\">#指定ingress的类型</span></span><br><span class=\"line\"> rules:\t\t<span class=\"comment\">#定义转发规则</span></span><br><span class=\"line\"> - host: test.tomcat.com\t<span class=\"comment\">#指定域名方式</span></span><br><span class=\"line\">   http:</span><br><span class=\"line\">    paths:</span><br><span class=\"line\">    - path:  <span class=\"regexp\">/easy-springmvc-maven/</span>\t\t<span class=\"comment\">#指定访问的路径</span></span><br><span class=\"line\">      pathType: Prefix\t\t <span class=\"comment\">#定义路径的类型</span></span><br><span class=\"line\">      backend:\t\t<span class=\"comment\">#定义转发后端的服务</span></span><br><span class=\"line\">       service:\t\t<span class=\"comment\">#定义转发的service</span></span><br><span class=\"line\">        name: <span class=\"keyword\">my</span>-java\t\t<span class=\"comment\">#这个定义的名字要和service的名字一样</span></span><br><span class=\"line\">        port:</span><br><span class=\"line\">         number: <span class=\"number\">80</span></span><br><span class=\"line\">         </span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># kubectl apply -f ingress-test.yaml </span></span><br><span class=\"line\">ingress.networking.k8s.io/test-ingress created</span><br><span class=\"line\">[root<span class=\"variable\">@master</span> k8s]<span class=\"comment\"># kubectl get ingress</span></span><br><span class=\"line\">NAME           CLASS   HOSTS             ADDRESS   PORTS   AGE</span><br><span class=\"line\">test-ingress   nginx   test.tomcat.com             <span class=\"number\">80</span>      13s</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"在wind电脑设置本机解析\"><a href=\"#在wind电脑设置本机解析\" class=\"headerlink\" title=\"在wind电脑设置本机解析\"></a>在wind电脑设置本机解析</h1><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">在C:\\Windows\\System32\\drivers\\etc找到hosts文件里添加</span><br><span class=\"line\"><span class=\"number\">10.31</span><span class=\"number\">.162</span><span class=\"number\">.135</span>\ttest.tomcat.com\t\t<span class=\"comment\">#这个IP地址是选取的一个node节点IP</span></span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/upload/K8S-CICD21.webp\" alt=\"K8S-CICD1.webp\"></p>\n<h1 id=\"测试访问\"><a href=\"#测试访问\" class=\"headerlink\" title=\"测试访问\"></a>测试访问</h1><p><img src=\"/upload/K8S-CICD22.webp\" alt=\"K8S-CICD1.webp\"></p>\n","categories":["operations"],"tags":["Linux","Jenkins"]},{"title":"jenkins版本8部署","url":"/2025/11/06/jenkins%E7%89%88%E6%9C%AC8%E9%83%A8%E7%BD%B2/","content":"<h2 id=\"1-8版jenkins安装–适应java-8-环境\"><a href=\"#1-8版jenkins安装–适应java-8-环境\" class=\"headerlink\" title=\"1.8版jenkins安装–适应java 8 环境\"></a>1.8版jenkins安装–适应java 8 环境</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">dev-jenkins访问地址：<span class=\"number\">106.15</span><span class=\"number\">.94</span><span class=\"number\">.146</span>:<span class=\"number\">8181</span></span><br><span class=\"line\"><span class=\"comment\"># 用户 / 密码 / 邮箱</span></span><br><span class=\"line\">zijian / h8G*p%4d<span class=\"variable\">%vqN</span>*wbJ  / <span class=\"number\">13921808706</span><span class=\"variable\">@163</span>.com</span><br><span class=\"line\">dev-network-jenkins访问地址：<span class=\"number\">106.15</span><span class=\"number\">.94</span><span class=\"number\">.146</span>:<span class=\"number\">8182</span></span><br><span class=\"line\"><span class=\"comment\"># 用户 / 密码 / 邮箱</span></span><br><span class=\"line\">zijian / h8G*p%4d<span class=\"variable\">%vqN</span>*wbJ  / <span class=\"number\">13921808706</span><span class=\"variable\">@163</span>.com</span><br><span class=\"line\"></span><br><span class=\"line\">博客地址：https:<span class=\"regexp\">//</span>blog.csdn.net/DrakHP/article/details/<span class=\"number\">136065639</span></span><br><span class=\"line\"></span><br><span class=\"line\">wget https:<span class=\"regexp\">//a</span>.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/tomcat-jdk/jdk-8u271-linux-x64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">wget https:<span class=\"regexp\">//a</span>.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/maven-nodejs/apache-maven-<span class=\"number\">3.9</span>.<span class=\"number\">3</span>-bin.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> ~]<span class=\"comment\"># ls</span></span><br><span class=\"line\">anaconda-ks.cfg  apache-maven-<span class=\"number\">3.9</span>.<span class=\"number\">3</span>-bin.tar.gz  jdk-8u271-linux-x64.tar.gz</span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> ~]<span class=\"comment\"># tar xzf apache-maven-3.9.3-bin.tar.gz  -C /usr/local/</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> ~]<span class=\"comment\"># tar xzf jdk-8u271-linux-x64.tar.gz  -C /usr/local/</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> ~]<span class=\"comment\"># cd /usr/local/</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> <span class=\"keyword\">local</span>]<span class=\"comment\"># ls</span></span><br><span class=\"line\">apache-maven-<span class=\"number\">3.9</span>.<span class=\"number\">3</span>  bin  etc  games  include  jdk1.<span class=\"number\">8.0_271</span>  lib  lib64  libexec  sbin  share  src</span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> <span class=\"keyword\">local</span>]<span class=\"comment\"># mv apache-maven-3.9.3/ maven</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> <span class=\"keyword\">local</span>]<span class=\"comment\"># mv jdk1.8.0_271/ java</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> <span class=\"keyword\">local</span>]<span class=\"comment\"># ls</span></span><br><span class=\"line\">bin  etc  games  include  java  lib  lib64  libexec  maven  sbin  share  src</span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> <span class=\"keyword\">local</span>]<span class=\"comment\"># mkdir jenkins</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> <span class=\"keyword\">local</span>]<span class=\"comment\"># cd jenkins/</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># ls</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\">#  wget https://repo.huaweicloud.com/jenkins/redhat-stable/jenkins-2.346.3-1.1.noarch.rpm</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># ls</span></span><br><span class=\"line\">jenkins-<span class=\"number\">2.346</span>.<span class=\"number\">3</span>-<span class=\"number\">1.1</span>.noarch.rpm</span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># rpm -ivh jenkins-2.346.3-1.1.noarch.rpm</span></span><br><span class=\"line\">警告：jenkins-<span class=\"number\">2.346</span>.<span class=\"number\">3</span>-<span class=\"number\">1.1</span>.noarch.rpm: 头V4 RSA/SHA512 Signature, 密钥 ID 45f2c3d5: NOKEY</span><br><span class=\"line\">准备中...                          <span class=\"comment\">################################# [100%]</span></span><br><span class=\"line\"><span class=\"keyword\">stat</span>: 无法获取<span class=\"string\">&quot;/var/cache/jenkins&quot;</span> 的文件状态(<span class=\"keyword\">stat</span>): 没有那个文件或目录</span><br><span class=\"line\"><span class=\"keyword\">stat</span>: 无法获取<span class=\"string\">&quot;/var/log/jenkins&quot;</span> 的文件状态(<span class=\"keyword\">stat</span>): 没有那个文件或目录</span><br><span class=\"line\"><span class=\"keyword\">stat</span>: 无法获取<span class=\"string\">&quot;/var/lib/jenkins&quot;</span> 的文件状态(<span class=\"keyword\">stat</span>): 没有那个文件或目录</span><br><span class=\"line\">错误：<span class=\"variable\">%pre</span>(jenkins-<span class=\"number\">2.346</span>.<span class=\"number\">3</span>-<span class=\"number\">1.1</span>.noarch) 脚本执行失败，退出状态码为 <span class=\"number\">1</span></span><br><span class=\"line\">错误：jenkins-<span class=\"number\">2.346</span>.<span class=\"number\">3</span>-<span class=\"number\">1.1</span>.noarch: 安裝 已失败</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># mkdir -p /var/cache/jenkins</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># mkdir -p /var/log/jenkins</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># mkdir -p /var/lib/jenkins</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># rpm -ivh jenkins-2.346.3-1.1.noarch.rpm</span></span><br><span class=\"line\">警告：jenkins-<span class=\"number\">2.346</span>.<span class=\"number\">3</span>-<span class=\"number\">1.1</span>.noarch.rpm: 头V4 RSA/SHA512 Signature, 密钥 ID 45f2c3d5: NOKEY</span><br><span class=\"line\">准备中...                          <span class=\"comment\">################################# [100%]</span></span><br><span class=\"line\">正在升级/安装...</span><br><span class=\"line\">   <span class=\"number\">1</span>:jenkins-<span class=\"number\">2.346</span>.<span class=\"number\">3</span>-<span class=\"number\">1.1</span>              <span class=\"comment\">################################# [100%]</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># vim /etc/profile</span></span><br><span class=\"line\"></span><br><span class=\"line\">JAVA_HOME=<span class=\"regexp\">/usr/l</span>ocal/java</span><br><span class=\"line\">MAVEN_HOME=<span class=\"regexp\">/usr/l</span>ocal/maven</span><br><span class=\"line\">PATH=<span class=\"variable\">$PATH</span>:<span class=\"variable\">$JAVA_HOME</span>/bin:<span class=\"variable\">$MAVEN_HOME</span>/bin</span><br><span class=\"line\">export JAVA_HOME MAVEN_HOME PATH</span><br><span class=\"line\">export JENKINS_HOME=<span class=\"regexp\">/usr/l</span>ocal/jenkins\t\t<span class=\"comment\">#添加到最后一行,并添加环境变量</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># vim /etc/sysconfig/jenkins</span></span><br><span class=\"line\"></span><br><span class=\"line\">JENKINS_HOME=<span class=\"string\">&quot;/var/lib/jenkins&quot;</span>\t改为\tJENKINS_HOME=<span class=\"string\">&quot;/usr/local/jenkins&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">JENKINS_USER=<span class=\"string\">&quot;jenkins&quot;</span>\t改为\tJENKINS_USER=<span class=\"string\">&quot;root&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">JENKINS_PORT=<span class=\"string\">&quot;8080&quot;</span>\t端口改为\tJENKINS_PORT=<span class=\"string\">&quot;8181&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># which java</span></span><br><span class=\"line\">/usr/<span class=\"keyword\">local</span>/java/bin/java</span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># vim /etc/init.d/jenkins </span></span><br><span class=\"line\"></span><br><span class=\"line\">往下滑，找到 candidates=</span><br><span class=\"line\"></span><br><span class=\"line\">将“”中的最后一行改为我们刚刚得到的jdk路径  /usr/<span class=\"keyword\">local</span>/java/bin/java</span><br><span class=\"line\"></span><br><span class=\"line\">candidates=<span class=\"string\">&quot;</span></span><br><span class=\"line\"><span class=\"string\">/etc/alternatives/java</span></span><br><span class=\"line\"><span class=\"string\">/usr/lib/jvm/java-1.8.0/bin/java</span></span><br><span class=\"line\"><span class=\"string\">/usr/lib/jvm/jre-1.8.0/bin/java</span></span><br><span class=\"line\"><span class=\"string\">/usr/lib/jvm/java-11.0/bin/java</span></span><br><span class=\"line\"><span class=\"string\">/usr/lib/jvm/jre-11.0/bin/java</span></span><br><span class=\"line\"><span class=\"string\">/usr/lib/jvm/java-11-openjdk-amd64</span></span><br><span class=\"line\"><span class=\"string\">/usr/bin/java</span></span><br><span class=\"line\"><span class=\"string\">/usr/local/java/bin/java\t\t#直接添加我们刚刚得到的JDK路径</span></span><br><span class=\"line\"><span class=\"string\">&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># systemctl stop firewalld</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> jenkins]<span class=\"comment\"># cd /etc/init.d/</span></span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> init.d]<span class=\"comment\"># ls</span></span><br><span class=\"line\">functions  jenkins  netconsole  network  README</span><br><span class=\"line\">[root<span class=\"variable\">@localhost</span> init.d]<span class=\"comment\"># ./jenkins start</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#访问网址：139.224.245.121:8181</span></span><br><span class=\"line\"></span><br><span class=\"line\">接下来，先别安装插件，此时重新输入网址，ip+端口号/pluginManager/advanced</span><br><span class=\"line\"></span><br><span class=\"line\">例如：<span class=\"number\">139.224</span><span class=\"number\">.245</span><span class=\"number\">.121</span>:<span class=\"number\">8181</span>/pluginManager/advanced</span><br><span class=\"line\"></span><br><span class=\"line\">进入界面后，往下滑，找到Update Site，修改URL</span><br><span class=\"line\"></span><br><span class=\"line\">https:<span class=\"regexp\">//mirr</span>or.tuna.tsinghua.edu.cn/jenkins/updates/dynamic-stable-<span class=\"number\">2.346</span>.<span class=\"number\">1</span>/update-center.json\t<span class=\"comment\"># 将原有的更改为这个URL</span></span><br><span class=\"line\"></span><br><span class=\"line\">然后点击上方的Availabale  后  点击Check now</span><br><span class=\"line\"></span><br><span class=\"line\">然后需要重新启动jenkins，更新配置</span><br><span class=\"line\"></span><br><span class=\"line\">输入网址：<span class=\"number\">172.16</span><span class=\"number\">.11</span><span class=\"number\">.31</span>:<span class=\"number\">8181</span>/restart</span><br><span class=\"line\"></span><br><span class=\"line\">会提示我们是否要重启，点击Yes，等待重启成功</span><br><span class=\"line\"></span><br><span class=\"line\">然后需要再重复一次输入管理面密码的操作，进入finalshell中，输入cat 得到的密码进行访问</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#访问网址：139.224.245.121:8181</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在网关的机器上配置Nginx代理</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        <span class=\"keyword\">listen</span>  <span class=\"number\">9966</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">                proxy_pass http:<span class=\"regexp\">//</span><span class=\"number\">172.16</span><span class=\"number\">.174</span><span class=\"number\">.124</span>:<span class=\"number\">8181</span>/;</span><br><span class=\"line\">                proxy_set_header Host <span class=\"variable\">$host</span>:<span class=\"variable\">$server_port</span>;</span><br><span class=\"line\">                proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">                proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 访问网址：http://106.15.94.146:9966/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 用户 / 密码 / 邮箱</span></span><br><span class=\"line\">zijian / h8G*p%4d<span class=\"variable\">%vqN</span>*wbJ  / <span class=\"number\">13921808706</span><span class=\"variable\">@163</span>.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># git安装--脚本安装</span></span><br><span class=\"line\">密码：Zj123456</span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Jenkins"]},{"title":"k8s--web平台部署","url":"/2025/11/06/k8s-web%E5%B9%B3%E5%8F%B0%E9%83%A8%E7%BD%B2/","content":"<h1 id=\"查看集群有没有启动正常\"><a href=\"#查看集群有没有启动正常\" class=\"headerlink\" title=\"查看集群有没有启动正常\"></a>查看集群有没有启动正常</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl get node</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl get pod -A</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"创建目录\"><a href=\"#创建目录\" class=\"headerlink\" title=\"创建目录\"></a>创建目录</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir k8s &amp;&amp;  cd k8s</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"下载官方yaml文件\"><a href=\"#下载官方yaml文件\" class=\"headerlink\" title=\"下载官方yaml文件\"></a>下载官方yaml文件</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"查看并创建\"><a href=\"#查看并创建\" class=\"headerlink\" title=\"查看并创建\"></a>查看并创建</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">recommended.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># vim recommended.yaml    </span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Namespace</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  type: NodePort             <span class=\"comment\">#在原文件添加这一行</span></span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: 443</span><br><span class=\"line\">      targetPort: 8443</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Secret</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard-certs</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">type: Opaque</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Secret</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard-csrf</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">type: Opaque</span><br><span class=\"line\">data:</span><br><span class=\"line\">  csrf: &quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Secret</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard-key-holder</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">type: Opaque</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard-settings</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">kind: Role</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  <span class=\"comment\"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span></span><br><span class=\"line\">  - apiGroups: <span class=\"section\">[&quot;&quot;]</span></span><br><span class=\"line\">    resources: <span class=\"section\">[&quot;secrets&quot;]</span></span><br><span class=\"line\">    resourceNames: <span class=\"section\">[&quot;kubernetes-dashboard-key-holder&quot;, &quot;kubernetes-dashboard-certs&quot;, &quot;kubernetes-dashboard-csrf&quot;]</span></span><br><span class=\"line\">    verbs: <span class=\"section\">[&quot;get&quot;, &quot;update&quot;, &quot;delete&quot;]</span></span><br><span class=\"line\">    <span class=\"comment\"># Allow Dashboard to get and update &#x27;kubernetes-dashboard-settings&#x27; config map.</span></span><br><span class=\"line\">  - apiGroups: <span class=\"section\">[&quot;&quot;]</span></span><br><span class=\"line\">    resources: <span class=\"section\">[&quot;configmaps&quot;]</span></span><br><span class=\"line\">    resourceNames: <span class=\"section\">[&quot;kubernetes-dashboard-settings&quot;]</span></span><br><span class=\"line\">    verbs: <span class=\"section\">[&quot;get&quot;, &quot;update&quot;]</span></span><br><span class=\"line\">    <span class=\"comment\"># Allow Dashboard to get metrics.</span></span><br><span class=\"line\">  - apiGroups: <span class=\"section\">[&quot;&quot;]</span></span><br><span class=\"line\">    resources: <span class=\"section\">[&quot;services&quot;]</span></span><br><span class=\"line\">    resourceNames: <span class=\"section\">[&quot;heapster&quot;, &quot;dashboard-metrics-scraper&quot;]</span></span><br><span class=\"line\">    verbs: <span class=\"section\">[&quot;proxy&quot;]</span></span><br><span class=\"line\">  - apiGroups: <span class=\"section\">[&quot;&quot;]</span></span><br><span class=\"line\">    resources: <span class=\"section\">[&quot;services/proxy&quot;]</span></span><br><span class=\"line\">    resourceNames: <span class=\"section\">[&quot;heapster&quot;, &quot;http:heapster:&quot;, &quot;https:heapster:&quot;, &quot;dashboard-metrics-scraper&quot;, &quot;http:dashboard-metrics-scraper&quot;]</span></span><br><span class=\"line\">    verbs: <span class=\"section\">[&quot;get&quot;]</span></span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\">rules:</span><br><span class=\"line\">  <span class=\"comment\"># Allow Metrics Scraper to get metrics from the Metrics server</span></span><br><span class=\"line\">  - apiGroups: <span class=\"section\">[&quot;metrics.k8s.io&quot;]</span></span><br><span class=\"line\">    resources: <span class=\"section\">[&quot;pods&quot;, &quot;nodes&quot;]</span></span><br><span class=\"line\">    verbs: <span class=\"section\">[&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span></span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: RoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: Role</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: kubernetes-dashboard</span><br><span class=\"line\">    namespace: kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: kubernetes-dashboard</span><br><span class=\"line\">    namespace: kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: kubernetes-dashboard</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  revisionHistoryLimit: 10</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        k8s-app: kubernetes-dashboard</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      securityContext:</span><br><span class=\"line\">        seccompProfile:</span><br><span class=\"line\">          type: RuntimeDefault</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: kubernetes-dashboard</span><br><span class=\"line\">          image: kubernetesui/dashboard:v2.7.0</span><br><span class=\"line\">          imagePullPolicy: Always</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 8443</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          args:</span><br><span class=\"line\">            - --auto-generate-certificates</span><br><span class=\"line\">            - <span class=\"attr\">--namespace</span>=kubernetes-dashboard</span><br><span class=\"line\">            <span class=\"comment\"># Uncomment the following line to manually specify Kubernetes API server Host</span></span><br><span class=\"line\">            <span class=\"comment\"># If not specified, Dashboard will attempt to auto discover the API server and connect</span></span><br><span class=\"line\">            <span class=\"comment\"># to it. Uncomment only if the default does not work.</span></span><br><span class=\"line\">            <span class=\"comment\"># - --apiserver-host=http://my-address:port</span></span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - name: kubernetes-dashboard-certs</span><br><span class=\"line\">              mountPath: /certs</span><br><span class=\"line\">              <span class=\"comment\"># Create on-disk volume to store exec logs</span></span><br><span class=\"line\">            - mountPath: /tmp</span><br><span class=\"line\">              name: tmp-volume</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              scheme: HTTPS</span><br><span class=\"line\">              path: /</span><br><span class=\"line\">              port: 8443</span><br><span class=\"line\">            initialDelaySeconds: 30</span><br><span class=\"line\">            timeoutSeconds: 30</span><br><span class=\"line\">          securityContext:</span><br><span class=\"line\">            allowPrivilegeEscalation: false</span><br><span class=\"line\">            readOnlyRootFilesystem: true</span><br><span class=\"line\">            runAsUser: 1001</span><br><span class=\"line\">            runAsGroup: 2001</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: kubernetes-dashboard-certs</span><br><span class=\"line\">          secret:</span><br><span class=\"line\">            secretName: kubernetes-dashboard-certs</span><br><span class=\"line\">        - name: tmp-volume</span><br><span class=\"line\">          emptyDir: &#123;&#125;</span><br><span class=\"line\">      serviceAccountName: kubernetes-dashboard</span><br><span class=\"line\">      nodeSelector:</span><br><span class=\"line\">        &quot;kubernetes.io/os&quot;: linux</span><br><span class=\"line\">      <span class=\"comment\"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">        - key: node-role.kubernetes.io/master</span><br><span class=\"line\">          effect: NoSchedule</span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: dashboard-metrics-scraper</span><br><span class=\"line\">  name: dashboard-metrics-scraper</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - port: 8000</span><br><span class=\"line\">      targetPort: 8000</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: dashboard-metrics-scraper</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: dashboard-metrics-scraper</span><br><span class=\"line\">  name: dashboard-metrics-scraper</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  revisionHistoryLimit: 10</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      k8s-app: dashboard-metrics-scraper</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        k8s-app: dashboard-metrics-scraper</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      securityContext:</span><br><span class=\"line\">        seccompProfile:</span><br><span class=\"line\">          type: RuntimeDefault</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - name: dashboard-metrics-scraper</span><br><span class=\"line\">          image: kubernetesui/metrics-scraper:v1.0.8</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 8000</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          livenessProbe:</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              scheme: HTTP</span><br><span class=\"line\">              path: /</span><br><span class=\"line\">              port: 8000</span><br><span class=\"line\">            initialDelaySeconds: 30</span><br><span class=\"line\">            timeoutSeconds: 30</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">          - mountPath: /tmp</span><br><span class=\"line\">            name: tmp-volume</span><br><span class=\"line\">          securityContext:</span><br><span class=\"line\">            allowPrivilegeEscalation: false</span><br><span class=\"line\">            readOnlyRootFilesystem: true</span><br><span class=\"line\">            runAsUser: 1001</span><br><span class=\"line\">            runAsGroup: 2001</span><br><span class=\"line\">      serviceAccountName: kubernetes-dashboard</span><br><span class=\"line\">      nodeSelector:</span><br><span class=\"line\">        &quot;kubernetes.io/os&quot;: linux</span><br><span class=\"line\">      <span class=\"comment\"># Comment the following tolerations if Dashboard must not be deployed on master</span></span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">        - key: node-role.kubernetes.io/master</span><br><span class=\"line\">          effect: NoSchedule</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - name: tmp-volume</span><br><span class=\"line\">          emptyDir: &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl apply -f recommended.yaml </span></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"验证有没有起来\"><a href=\"#验证有没有起来\" class=\"headerlink\" title=\"验证有没有起来\"></a>验证有没有起来</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl get po -n kubernetes-dashboard</span></span><br><span class=\"line\">NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">dashboard-metrics-scraper-7c857855d9-wl4md   1/1     Running   0          41s</span><br><span class=\"line\">kubernetes-dashboard-658b66597c-n7dq6        1/1     Running   0          41s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl get svc -n kubernetes-dashboard</span></span><br><span class=\"line\">NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class=\"line\">dashboard-metrics-scraper   ClusterIP   10.105.21.218    &lt;none&gt;        8000/TCP        69s</span><br><span class=\"line\">kubernetes-dashboard        NodePort    10.105.252.141   &lt;none&gt;        443:32129/TCP   69s</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"此时可以登入web查看了\"><a href=\"#此时可以登入web查看了\" class=\"headerlink\" title=\"此时可以登入web查看了\"></a>此时可以登入web查看了</h1><p><code>IP地址 + 32129</code>\t\t</p>\n<p><code>这里的32129端口是体统映射的，具体是多少用get svc验证查看</code></p>\n<h1 id=\"创建admin的key，登入web用\"><a href=\"#创建admin的key，登入web用\" class=\"headerlink\" title=\"创建admin的key，登入web用\"></a>创建admin的key，登入web用</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># cat dashoard-admin.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kubernetes-dashboard</span><br><span class=\"line\">  name: dashboard-admin</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dashboard-admin-cluster-role</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: cluster-admin</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">  - kind: ServiceAccount</span><br><span class=\"line\">    name: dashboard-admin</span><br><span class=\"line\">    namespace: kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl apply -f dashoard-admin.yaml </span></span><br><span class=\"line\">serviceaccount/dashboard-admin unchanged</span><br><span class=\"line\">clusterrolebinding.rbac.authorization.k8s.io/dashboard-admin-cluster-role created</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl get sa -n kubernetes-dashboard</span></span><br><span class=\"line\">NAME                   SECRETS   AGE</span><br><span class=\"line\">dashboard-admin        1         112s</span><br><span class=\"line\">default                1         14m</span><br><span class=\"line\">kubernetes-dashboard   1         14m</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl describe sa dashboard-admin -n kubernetes-dashboard</span></span><br><span class=\"line\">Name:                dashboard-admin</span><br><span class=\"line\">Namespace:           kubernetes-dashboard</span><br><span class=\"line\">Labels:              <span class=\"attr\">k8s-app</span>=kubernetes-dashboard</span><br><span class=\"line\">Annotations:         &lt;none&gt;</span><br><span class=\"line\">Image pull secrets:  &lt;none&gt;</span><br><span class=\"line\">Mountable secrets:   dashboard-admin-token-7k482\t<span class=\"comment\">#这个就是token</span></span><br><span class=\"line\">Tokens:              dashboard-admin-token-7k482</span><br><span class=\"line\">Events:              &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl get secrets  -n kubernetes-dashboard</span></span><br><span class=\"line\">NAME                               TYPE                                  DATA   AGE</span><br><span class=\"line\">dashboard-admin-token-7k482        kubernetes.io/service-account-token   3      3m12s</span><br><span class=\"line\">default-token-gwp54                kubernetes.io/service-account-token   3      15m</span><br><span class=\"line\">kubernetes-dashboard-certs         Opaque                                0      15m</span><br><span class=\"line\">kubernetes-dashboard-csrf          Opaque                                1      15m</span><br><span class=\"line\">kubernetes-dashboard-key-holder    Opaque                                2      15m</span><br><span class=\"line\">kubernetes-dashboard-token-28xhj   kubernetes.io/service-account-token   3      15m</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看token</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-1 k8s]</span><span class=\"comment\"># kubectl describe secrets dashboard-admin-token-7k482 -n kubernetes-dashboard</span></span><br><span class=\"line\">Name:         dashboard-admin-token-7k482</span><br><span class=\"line\">Namespace:    kubernetes-dashboard</span><br><span class=\"line\">Labels:       &lt;none&gt;</span><br><span class=\"line\">Annotations:  kubernetes.io/service-account.name: dashboard-admin</span><br><span class=\"line\">              kubernetes.io/service-account.uid: 04eda024-fc6c-4ae9-b949-7eb4f54b97f5</span><br><span class=\"line\"></span><br><span class=\"line\">Type:  kubernetes.io/service-account-token</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">Data</span></span><br><span class=\"line\">====</span><br><span class=\"line\">ca.crt:     1099 bytes</span><br><span class=\"line\">namespace:  20 bytes</span><br><span class=\"line\">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6ImRiWndwem04N2RmUXVOeFRjQ0ktSzI1azAzVUtwVXdRVkJGc0d1eVptRUUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJkYXNoYm9hcmQtYWRtaW4tdG9rZW4tN2s0ODIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGFzaGJvYXJkLWFkbWluIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQudWlkIjoiMDRlZGEwMjQtZmM2Yy00YWU5LWI5NDktN2ViNGY1NGI5N2Y1Iiwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50Omt1YmVybmV0ZXMtZGFzaGJvYXJkOmRhc2hib2FyZC1hZG1pbiJ9.eYnDkdG-VnshjgvBM5oiDEhQH2J3nKKc4Qud7hGpmt_bbcQUeaytpkvLWQY-kXu_kTaMXgZqhqTVHy0LaBsSURvTrJWL51d38EZE_5XOVj5JqlnWrmQaK9c7bJ9GmQ6BvCKHanIQNHizHQR6vHyDuJ9BkvuL2ZrXY-_OqgVwPUoN8c41BdF5iDqdYNLgILeTRi11nde4cnVgJIdzfpZZ7sPsYaNwnrgcSeQxQJPuPMrtn-TcXubyzVRdfFLWynf3_5ItJGqL8JS7oUc4Sv41Lmu90ofiehcyS-4KZ1jP16s_LdoY_7_j2Slg7urP34Vv3JmnyIryoPYNdx-1Nubq4Q</span><br><span class=\"line\"><span class=\"comment\"># 复制token到web界面登入就可以进入页面了</span></span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Kubernetes"]},{"title":"k8s 常用命令","url":"/2025/11/06/k8s-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/","content":"<h1 id=\"k8s常用命令\"><a href=\"#k8s常用命令\" class=\"headerlink\" title=\"k8s常用命令\"></a>k8s常用命令</h1><h1 id=\"查看ststem命名空间中pod的信息\"><a href=\"#查看ststem命名空间中pod的信息\" class=\"headerlink\" title=\"查看ststem命名空间中pod的信息\"></a>查看ststem命名空间中pod的信息</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pods --namespace kube-system</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get pods -n kube-system</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看k8s中的服务信息\"><a href=\"#查看k8s中的服务信息\" class=\"headerlink\" title=\"查看k8s中的服务信息\"></a>查看k8s中的服务信息</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get service</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看k8s中kube-dns的服务信息\"><a href=\"#查看k8s中kube-dns的服务信息\" class=\"headerlink\" title=\"查看k8s中kube-dns的服务信息\"></a>查看k8s中kube-dns的服务信息</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get svc --namespace kube-system</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看所有节点\"><a href=\"#查看所有节点\" class=\"headerlink\" title=\"查看所有节点\"></a>查看所有节点</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get nodes</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看node节点详细信息\"><a href=\"#查看node节点详细信息\" class=\"headerlink\" title=\"查看node节点详细信息\"></a>查看node节点详细信息</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl describe node node-1</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看所有名称空间内的资源\"><a href=\"#查看所有名称空间内的资源\" class=\"headerlink\" title=\"查看所有名称空间内的资源\"></a>查看所有名称空间内的资源</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"同时查看多种资源信息\"><a href=\"#同时查看多种资源信息\" class=\"headerlink\" title=\"同时查看多种资源信息\"></a>同时查看多种资源信息</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pod,svc -n kube-system</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看apiserver信息\"><a href=\"#查看apiserver信息\" class=\"headerlink\" title=\"查看apiserver信息\"></a>查看apiserver信息</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl cluster-info</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"api查询\"><a href=\"#api查询\" class=\"headerlink\" title=\"api查询\"></a>api查询</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl api-versions</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建yml文件时用来查看帮助的命令\"><a href=\"#创建yml文件时用来查看帮助的命令\" class=\"headerlink\" title=\"创建yml文件时用来查看帮助的命令\"></a>创建yml文件时用来查看帮助的命令</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl explain 类型名</span><br><span class=\"line\">例如：kubectl explain namespace.spec</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建yml文件资源的命令\"><a href=\"#创建yml文件资源的命令\" class=\"headerlink\" title=\"创建yml文件资源的命令\"></a>创建yml文件资源的命令</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f  yml文件名字</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看某一个namespace\"><a href=\"#查看某一个namespace\" class=\"headerlink\" title=\"查看某一个namespace\"></a>查看某一个namespace</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get namespace 名称空间的名字</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看某个namespace的详细信息\"><a href=\"#查看某个namespace的详细信息\" class=\"headerlink\" title=\"查看某个namespace的详细信息\"></a>查看某个namespace的详细信息</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl describe namespace 名称空间的名字</span><br></pre></td></tr></table></figure>\n<h1 id=\"查看在哪个node节点\"><a href=\"#查看在哪个node节点\" class=\"headerlink\" title=\"查看在哪个node节点\"></a>查看在哪个node节点</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get po -n qingfeng -o wide</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建名称空间\"><a href=\"#创建名称空间\" class=\"headerlink\" title=\"创建名称空间\"></a>创建名称空间</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create namespace qingfeng</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看默认命名空间信息\"><a href=\"#查看默认命名空间信息\" class=\"headerlink\" title=\"查看默认命名空间信息\"></a>查看默认命名空间信息</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl describe namespaces default </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"删除默认空间资源限制\"><a href=\"#删除默认空间资源限制\" class=\"headerlink\" title=\"删除默认空间资源限制\"></a>删除默认空间资源限制</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl delete resourcequotas limit-qianfeng </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看所有命名空间\"><a href=\"#查看所有命名空间\" class=\"headerlink\" title=\"查看所有命名空间\"></a>查看所有命名空间</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get pod -A</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看pod详细信息\"><a href=\"#查看pod详细信息\" class=\"headerlink\" title=\"查看pod详细信息\"></a>查看pod详细信息</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl describe pod pod-1</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"在-master机器上进入容器\"><a href=\"#在-master机器上进入容器\" class=\"headerlink\" title=\"在 master机器上进入容器\"></a>在 master机器上进入容器</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl exec -it 元数据名字 -c 容器名字 -- bash</span><br><span class=\"line\">kubectl exec -it pod-1 -c centos -- bash</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"删除定义的容器\"><a href=\"#删除定义的容器\" class=\"headerlink\" title=\"删除定义的容器\"></a>删除定义的容器</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl delete -f yml名字 </span><br><span class=\"line\">kubectl delete -f app.yml </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"删除节点\"><a href=\"#删除节点\" class=\"headerlink\" title=\"删除节点\"></a>删除节点</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl delete node 节点名</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"重置节点\"><a href=\"#重置节点\" class=\"headerlink\" title=\"重置节点\"></a>重置节点</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubeadm reset</span><br><span class=\"line\"></span><br><span class=\"line\">注2：master上在reset之后需要删除如下文件</span><br><span class=\"line\"><span class=\"comment\"># rm -rf /var/lib/cni/ $HOME/.kube/config</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"命令补全\"><a href=\"#命令补全\" class=\"headerlink\" title=\"命令补全\"></a>命令补全</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install bash-completion</span><br><span class=\"line\">source /usr/share/bash-completion/bash_completion</span><br><span class=\"line\">source &lt;(kubectl completion bash)</span><br><span class=\"line\">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"重新生成token\"><a href=\"#重新生成token\" class=\"headerlink\" title=\"重新生成token\"></a>重新生成token</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">重新生成方法：</span><br><span class=\"line\">1. 重新生成新的token:</span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master]</span><span class=\"comment\"># kubeadm  token create</span></span><br><span class=\"line\">kiyfhw.xiacqbch8o8fa8qj</span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master]</span><span class=\"comment\"># kubeadm  token list</span></span><br><span class=\"line\">TOKEN                     TTL         EXPIRES                     USAGES                   DESCRIPTION   EXTRA GROUPS</span><br><span class=\"line\">gvvqwk.hn56nlsgsv11mik6   &lt;invalid&gt;   2018-10-25T14:16:06+08:00   authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token</span><br><span class=\"line\">kiyfhw.xiacqbch8o8fa8qj   23h         2018-10-27T06:39:24+08:00   authentication,signing   &lt;none&gt;        system:bootstrappers:kubeadm:default-node-token</span><br><span class=\"line\"></span><br><span class=\"line\">2. 获取ca证书sha256编码hash值:</span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master]</span><span class=\"comment\"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed &#x27;s/^.* //&#x27;</span></span><br><span class=\"line\">5417eb1b68bd4e7a4c82aded83abc55ec91bd601e45734d6aba85de8b1ebb057</span><br><span class=\"line\"></span><br><span class=\"line\">3. 节点加入集群:</span><br><span class=\"line\">  kubeadm join 18.16.202.35:6443 --token kiyfhw.xiacqbch8o8fa8qj --discovery-token-ca-cert-hash sha256:5417eb1b68bd4e7a4c82aded83abc55ec91bd601e45734d6aba85de8b1ebb057</span><br><span class=\"line\">几秒钟后，您应该注意到kubectl get nodes在主服务器上运行时输出中的此节点。</span><br><span class=\"line\"></span><br><span class=\"line\">上面的方法比较繁琐，一步到位：</span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master ~]</span><span class=\"comment\"># kubeadm token create --print-join-command</span></span><br><span class=\"line\"></span><br><span class=\"line\">第二种方法：</span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master ~]</span><span class=\"comment\"># token=$(kubeadm token generate)</span></span><br><span class=\"line\">kubeadm token create $token --print-join-command <span class=\"attr\">--ttl</span>=<span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\">然后在node节点执行</span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-node1 ~]</span><span class=\"comment\"># kubeadm reset</span></span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-node1 ~]</span><span class=\"comment\"># 执行生成得token</span></span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Kubernetes"]},{"title":"k8s部署prometheus","url":"/2025/11/05/k8s%E9%83%A8%E7%BD%B2prometheus/","content":"<h1 id=\"k8s部署prometheus\"><a href=\"#k8s部署prometheus\" class=\"headerlink\" title=\"k8s部署prometheus\"></a>k8s部署prometheus</h1><h1 id=\"终端创建\"><a href=\"#终端创建\" class=\"headerlink\" title=\"终端创建\"></a>终端创建</h1><h2 id=\"创建namespace\"><a href=\"#创建namespace\" class=\"headerlink\" title=\"创建namespace\"></a>创建namespace</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /home/k8s/monitoring/&#123;node-exporter,k8s,kube-state-metrics,blackbox-exporter,dingtalk,alertmanager,prometheus,grafana&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /home/k8s/monitoring</span><br><span class=\"line\"></span><br><span class=\"line\">vim namespace.yaml</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Namespace</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitoring</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"node-exporter\"><a href=\"#node-exporter\" class=\"headerlink\" title=\"node-exporter\"></a>node-exporter</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim node-exporter/node-exporter.yaml</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: node-exporter</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: node-exporter</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: node-exporter</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: node-exporter</span><br><span class=\"line\">    port: 9100</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 9100</span><br><span class=\"line\">  clusterIP: None</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: DaemonSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: node-exporter</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: node-exporter</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: node-exporter</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      name: node-exporter</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: node-exporter</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: node-exporter</span><br><span class=\"line\">        image: prom/node-exporter:latest</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9100</span><br><span class=\"line\">          hostPort: 9100</span><br><span class=\"line\">      hostNetwork: <span class=\"literal\">true</span></span><br><span class=\"line\">      hostPID: <span class=\"literal\">true</span></span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - key: node-role.kubernetes.io/master</span><br><span class=\"line\">        operator: Exists</span><br><span class=\"line\">        effect: NoSchedule</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"k8s组件\"><a href=\"#k8s组件\" class=\"headerlink\" title=\"k8s组件\"></a>k8s组件</h2><h2 id=\"controller-manager\"><a href=\"#controller-manager\" class=\"headerlink\" title=\"controller-manager\"></a>controller-manager</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim k8s/kube-controller-manager-prometheus-discovery.yaml</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-controller-manager-prometheus-discovery</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    component: kube-controller-manager</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    component: kube-controller-manager</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: http-metrics</span><br><span class=\"line\">    port: 10252</span><br><span class=\"line\">    targetPort: 10252</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">  clusterIP: None</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"kube-scheduler\"><a href=\"#kube-scheduler\" class=\"headerlink\" title=\"kube-scheduler\"></a>kube-scheduler</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim k8s/kube-scheduler-prometheus-discovery.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-scheduler-prometheus-discovery</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    component: kube-scheduler</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    component: kube-scheduler</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: http-metrics</span><br><span class=\"line\">    port: 10251</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 10251</span><br><span class=\"line\">  clusterIP: None</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"kube-proxy\"><a href=\"#kube-proxy\" class=\"headerlink\" title=\"kube-proxy\"></a>kube-proxy</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim k8s/kube-proxy-prometheus-discovery.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-proxy-prometheus-discovery</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    k8s-app: kube-proxy</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: kube-proxy</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: http-metrics</span><br><span class=\"line\">    port: 10249</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 10249</span><br><span class=\"line\">  clusterIP: None</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"kube-state-metrics\"><a href=\"#kube-state-metrics\" class=\"headerlink\" title=\"kube-state-metrics\"></a>kube-state-metrics</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim kube-state-metrics/rbac.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\"> </span><br><span class=\"line\">--- </span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">rules:</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - configmaps</span><br><span class=\"line\">  - secrets</span><br><span class=\"line\">  - nodes</span><br><span class=\"line\">  - pods</span><br><span class=\"line\">  - services</span><br><span class=\"line\">  - resourcequotas</span><br><span class=\"line\">  - replicationcontrollers</span><br><span class=\"line\">  - limitranges</span><br><span class=\"line\">  - persistentvolumeclaims</span><br><span class=\"line\">  - persistentvolumes</span><br><span class=\"line\">  - namespaces</span><br><span class=\"line\">  - endpoints</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - extensions</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - daemonsets</span><br><span class=\"line\">  - deployments</span><br><span class=\"line\">  - replicasets</span><br><span class=\"line\">  - ingresses</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - apps</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - statefulsets</span><br><span class=\"line\">  - daemonsets</span><br><span class=\"line\">  - deployments</span><br><span class=\"line\">  - replicasets</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - batch</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - cronjobs</span><br><span class=\"line\">  - <span class=\"built_in\">jobs</span></span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - autoscaling</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - horizontalpodautoscalers</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - authentication.k8s.io</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - tokenreviews</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - create</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - authorization.k8s.io</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - subjectaccessreviews</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - create</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - policy</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - poddisruptionbudgets</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - certificates.k8s.io</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - certificatesigningrequests</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - storage.k8s.io</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - storageclasses</span><br><span class=\"line\">  - volumeattachments</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - admissionregistration.k8s.io</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - mutatingwebhookconfigurations</span><br><span class=\"line\">  - validatingwebhookconfigurations</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - networking.k8s.io</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - networkpolicies</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">- apiGroups:</span><br><span class=\"line\">  - coordination.k8s.io</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - leases</span><br><span class=\"line\">  verbs:</span><br><span class=\"line\">  - list</span><br><span class=\"line\">  - watch</span><br><span class=\"line\">  </span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim kube-state-metrics/kube-state-metrics.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">    prometheus.io/http-probe: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">    prometheus.io/http-probe-path: <span class=\"string\">&#x27;/healthz&#x27;</span></span><br><span class=\"line\">    prometheus.io/http-probe-port: <span class=\"string\">&#x27;8080&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: kube-state-metrics</span><br><span class=\"line\">    port: 8080</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 8080</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: kube-state-metrics</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: kube-state-metrics</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      serviceAccountName: kube-state-metrics</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: kube-state-metrics</span><br><span class=\"line\">        image: quay.io/coreos/kube-state-metrics:v1.8.0 </span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 8080</span><br><span class=\"line\">      <span class=\"comment\"># Remove nodeSelector and tolerations for random scheduling</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"blackbox-exporter\"><a href=\"#blackbox-exporter\" class=\"headerlink\" title=\"blackbox-exporter\"></a>blackbox-exporter</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim blackbox-exporter/config.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: blackbox-exporter</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: blackbox-exporter</span><br><span class=\"line\">data:</span><br><span class=\"line\">  blackbox.yml: |-</span><br><span class=\"line\">    modules:</span><br><span class=\"line\">      http_2xx:</span><br><span class=\"line\">        prober: http</span><br><span class=\"line\">        <span class=\"built_in\">timeout</span>: 10s</span><br><span class=\"line\">        http:</span><br><span class=\"line\">          valid_http_versions: [<span class=\"string\">&quot;HTTP/1.1&quot;</span>, <span class=\"string\">&quot;HTTP/2&quot;</span>]</span><br><span class=\"line\">          valid_status_codes: []</span><br><span class=\"line\">          method: GET</span><br><span class=\"line\">          preferred_ip_protocol: <span class=\"string\">&quot;ip4&quot;</span></span><br><span class=\"line\">      http_post_2xx:</span><br><span class=\"line\">        prober: http</span><br><span class=\"line\">        <span class=\"built_in\">timeout</span>: 10s</span><br><span class=\"line\">        http:</span><br><span class=\"line\">          valid_http_versions: [<span class=\"string\">&quot;HTTP/1.1&quot;</span>, <span class=\"string\">&quot;HTTP/2&quot;</span>]</span><br><span class=\"line\">          method: POST</span><br><span class=\"line\">          preferred_ip_protocol: <span class=\"string\">&quot;ip4&quot;</span></span><br><span class=\"line\">      tcp_connect:</span><br><span class=\"line\">        prober: tcp</span><br><span class=\"line\">        <span class=\"built_in\">timeout</span>: 10s</span><br><span class=\"line\">      icmp:</span><br><span class=\"line\">        prober: icmp</span><br><span class=\"line\">        <span class=\"built_in\">timeout</span>: 10s</span><br><span class=\"line\">        icmp:</span><br><span class=\"line\">          preferred_ip_protocol: <span class=\"string\">&quot;ip4&quot;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim blackbox-exporter/blackbox-exporter.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: blackbox-exporter</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: blackbox-exporter</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: blackbox-exporter</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: blackbox</span><br><span class=\"line\">    port: 9115</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 9115</span><br><span class=\"line\">    nodePort: 30115</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort</span><br><span class=\"line\">  </span><br><span class=\"line\">---  </span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: blackbox-exporter</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: blackbox-exporter</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: blackbox-exporter</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: blackbox-exporter</span><br><span class=\"line\">        image: prom/blackbox-exporter:latest</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9115</span><br><span class=\"line\">        readinessProbe:</span><br><span class=\"line\">          tcpSocket:</span><br><span class=\"line\">            port: 9115</span><br><span class=\"line\">          initialDelaySeconds: 10</span><br><span class=\"line\">          timeoutSeconds: 5</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            memory: 50Mi</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            memory: 60Mi</span><br><span class=\"line\">            cpu: 200m</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: config</span><br><span class=\"line\">          mountPath: /etc/blackbox_exporter</span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - <span class=\"string\">&#x27;--config.file=/etc/blackbox_exporter/blackbox.yml&#x27;</span></span><br><span class=\"line\">        - <span class=\"string\">&#x27;--web.listen-address=:9115&#x27;</span></span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: config</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: blackbox-exporter</span><br><span class=\"line\">      nodeSelector:</span><br><span class=\"line\">        node-role.kubernetes.io/master: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - key: node-role.kubernetes.io/master</span><br><span class=\"line\">        operator: Exists</span><br><span class=\"line\">        effect: NoSchedule</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"dingtalk\"><a href=\"#dingtalk\" class=\"headerlink\" title=\"dingtalk\"></a>dingtalk</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim dingtalk/config.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dingtalk-config</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">data:</span><br><span class=\"line\">  config.yml: |-</span><br><span class=\"line\">    targets:</span><br><span class=\"line\">      webhook:</span><br><span class=\"line\">        url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx             <span class=\"comment\">#修改为钉钉机器人的webhook</span></span><br><span class=\"line\">        mention:</span><br><span class=\"line\">          all: <span class=\"literal\">true</span>             <span class=\"comment\">#@所有人</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim dingtalk/dingtalk.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dingtalk</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: dingtalk</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;false&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: dingtalk</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: dingtalk</span><br><span class=\"line\">    port: 8060</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 8060</span><br><span class=\"line\">  </span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: dingtalk</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: dingtalk</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      name: dingtalk</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: dingtalk</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: dingtalk</span><br><span class=\"line\">        image: timonwong/prometheus-webhook-dingtalk:latest</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 8060</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: config</span><br><span class=\"line\">          mountPath: /etc/prometheus-webhook-dingtalk</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: config</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: dingtalk-config</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"alertmanager\"><a href=\"#alertmanager\" class=\"headerlink\" title=\"alertmanager\"></a>alertmanager</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim alertmanager/templates.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: alertmanager-templates</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">data:</span><br><span class=\"line\">  default.tmpl: |</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;__alertmanager&quot;</span> &#125;&#125;AlertManager&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;__alertmanagerURL&quot;</span> &#125;&#125;&#123;&#123; .ExternalURL &#125;&#125;/#/alerts?receiver=&#123;&#123; .Receiver &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;__subject&quot;</span> &#125;&#125;[&#123;&#123; .Status | toUpper &#125;&#125;&#123;&#123; <span class=\"keyword\">if</span> eq .Status <span class=\"string\">&quot;firing&quot;</span> &#125;&#125;:&#123;&#123; .Alerts.Firing | len &#125;&#125;&#123;&#123; end &#125;&#125;] &#123;&#123; .GroupLabels.SortedPairs.Values | <span class=\"built_in\">join</span> <span class=\"string\">&quot; &quot;</span> &#125;&#125; &#123;&#123; <span class=\"keyword\">if</span> gt (len .CommonLabels) (len .GroupLabels) &#125;&#125;(&#123;&#123; with .CommonLabels.Remove .GroupLabels.Names &#125;&#125;&#123;&#123; .Values | <span class=\"built_in\">join</span> <span class=\"string\">&quot; &quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;)&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;__description&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;__text_alert_list&quot;</span> &#125;&#125;&#123;&#123; range . &#125;&#125;Labels:</span><br><span class=\"line\">    &#123;&#123; range .Labels.SortedPairs &#125;&#125; - &#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; end &#125;&#125;Annotations:</span><br><span class=\"line\">    &#123;&#123; range .Annotations.SortedPairs &#125;&#125; - &#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; end &#125;&#125;Source: &#123;&#123; .GeneratorURL &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;slack.default.title&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;slack.default.username&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__alertmanager&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;slack.default.fallback&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;slack.default.title&quot;</span> . &#125;&#125; | &#123;&#123; template <span class=\"string\">&quot;slack.default.titlelink&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;slack.default.pretext&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;slack.default.titlelink&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;slack.default.iconemoji&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;slack.default.iconurl&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;slack.default.text&quot;</span> &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;hipchat.default.from&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__alertmanager&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;hipchat.default.message&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;pagerduty.default.description&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;pagerduty.default.client&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__alertmanager&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;pagerduty.default.clientURL&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;pagerduty.default.instances&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__text_alert_list&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;opsgenie.default.message&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;opsgenie.default.description&quot;</span> &#125;&#125;&#123;&#123; .CommonAnnotations.SortedPairs.Values | <span class=\"built_in\">join</span> <span class=\"string\">&quot; &quot;</span> &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; <span class=\"keyword\">if</span> gt (len .Alerts.Firing) 0 -&#125;&#125;</span><br><span class=\"line\">    Alerts Firing:</span><br><span class=\"line\">    &#123;&#123; template <span class=\"string\">&quot;__text_alert_list&quot;</span> .Alerts.Firing &#125;&#125;</span><br><span class=\"line\">    &#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; <span class=\"keyword\">if</span> gt (len .Alerts.Resolved) 0 -&#125;&#125;</span><br><span class=\"line\">    Alerts Resolved:</span><br><span class=\"line\">    &#123;&#123; template <span class=\"string\">&quot;__text_alert_list&quot;</span> .Alerts.Resolved &#125;&#125;</span><br><span class=\"line\">    &#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123;- end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;opsgenie.default.source&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;victorops.default.message&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__subject&quot;</span> . &#125;&#125; | &#123;&#123; template <span class=\"string\">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;victorops.default.from&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__alertmanager&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;email.default.subject&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;email.default.html&quot;</span> &#125;&#125;</span><br><span class=\"line\">    &lt;!DOCTYPE html PUBLIC <span class=\"string\">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span> <span class=\"string\">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span>&gt;</span><br><span class=\"line\">    &lt;!--</span><br><span class=\"line\">    Style and HTML derived from https://github.com/mailgun/transactional-email-templates</span><br><span class=\"line\">    The MIT License (MIT)</span><br><span class=\"line\">    Copyright (c) 2014 Mailgun</span><br><span class=\"line\">    Permission is hereby granted, free of charge, to any person obtaining a copy</span><br><span class=\"line\">    of this software and associated documentation files (the <span class=\"string\">&quot;Software&quot;</span>), to deal</span><br><span class=\"line\">    <span class=\"keyword\">in</span> the Software without restriction, including without limitation the rights</span><br><span class=\"line\">    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span><br><span class=\"line\">    copies of the Software, and to permit persons to whom the Software is</span><br><span class=\"line\">    furnished to <span class=\"keyword\">do</span> so, subject to the following conditions:</span><br><span class=\"line\">    The above copyright notice and this permission notice shall be included <span class=\"keyword\">in</span> all</span><br><span class=\"line\">    copies or substantial portions of the Software.</span><br><span class=\"line\">    THE SOFTWARE IS PROVIDED <span class=\"string\">&quot;AS IS&quot;</span>, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span><br><span class=\"line\">    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span><br><span class=\"line\">    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span><br><span class=\"line\">    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span><br><span class=\"line\">    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span><br><span class=\"line\">    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span><br><span class=\"line\">    SOFTWARE.</span><br><span class=\"line\">    --&gt;</span><br><span class=\"line\">    &lt;html xmlns=<span class=\"string\">&quot;http://www.w3.org/1999/xhtml&quot;</span> xmlns=<span class=\"string\">&quot;http://www.w3.org/1999/xhtml&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">    &lt;<span class=\"built_in\">head</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">    &lt;meta name=<span class=\"string\">&quot;viewport&quot;</span> content=<span class=\"string\">&quot;width=device-width&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;</span><br><span class=\"line\">    &lt;meta http-equiv=<span class=\"string\">&quot;Content-Type&quot;</span> content=<span class=\"string\">&quot;text/html; charset=UTF-8&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;</span><br><span class=\"line\">    &lt;title style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;&#123;&#123; template <span class=\"string\">&quot;__subject&quot;</span> . &#125;&#125;&lt;/title&gt;</span><br><span class=\"line\">    &lt;/head&gt;</span><br><span class=\"line\">    &lt;body itemscope=<span class=\"string\">&quot;&quot;</span> itemtype=<span class=\"string\">&quot;http://schema.org/EmailMessage&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; -webkit-font-smoothing: antialiased; -webkit-text-size-adjust: none; height: 100%; line-height: 1.6em; width: 100% !important; background-color: #f6f6f6; margin: 0; padding: 0;&quot;</span> bgcolor=<span class=\"string\">&quot;#f6f6f6&quot;</span>&gt;</span><br><span class=\"line\">    &lt;table style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; width: 100%; background-color: #f6f6f6; margin: 0;&quot;</span> bgcolor=<span class=\"string\">&quot;#f6f6f6&quot;</span>&gt;</span><br><span class=\"line\">      &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">        &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;&lt;/td&gt;</span><br><span class=\"line\">        &lt;td width=<span class=\"string\">&quot;600&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; display: block !important; max-width: 600px !important; clear: both !important; width: 100% !important; margin: 0 auto; padding: 0;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;</span><br><span class=\"line\">          &lt;div style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; max-width: 600px; display: block; margin: 0 auto; padding: 0;&quot;</span>&gt;</span><br><span class=\"line\">            &lt;table width=<span class=\"string\">&quot;100%&quot;</span> cellpadding=<span class=\"string\">&quot;0&quot;</span> cellspacing=<span class=\"string\">&quot;0&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; border-radius: 3px; background-color: #fff; margin: 0; border: 1px solid #e9e9e9;&quot;</span> bgcolor=<span class=\"string\">&quot;#fff&quot;</span>&gt;</span><br><span class=\"line\">              &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 16px; vertical-align: top; color: #fff; font-weight: 500; text-align: center; border-radius: 3px 3px 0 0; background-color: #E6522C; margin: 0; padding: 20px;&quot;</span> align=<span class=\"string\">&quot;center&quot;</span> bgcolor=<span class=\"string\">&quot;#E6522C&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;</span><br><span class=\"line\">                  &#123;&#123; .Alerts | len &#125;&#125; alert&#123;&#123; <span class=\"keyword\">if</span> gt (len .Alerts) 1 &#125;&#125;s&#123;&#123; end &#125;&#125; <span class=\"keyword\">for</span> &#123;&#123; range .GroupLabels.SortedPairs &#125;&#125;</span><br><span class=\"line\">                    &#123;&#123; .Name &#125;&#125;=&#123;&#123; .Value &#125;&#125;</span><br><span class=\"line\">                  &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                &lt;/td&gt;</span><br><span class=\"line\">              &lt;/tr&gt;</span><br><span class=\"line\">              &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 10px;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;</span><br><span class=\"line\">                  &lt;table width=<span class=\"string\">&quot;100%&quot;</span> cellpadding=<span class=\"string\">&quot;0&quot;</span> cellspacing=<span class=\"string\">&quot;0&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                    &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                      &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;</span><br><span class=\"line\">                        &lt;a href=<span class=\"string\">&quot;&#123;&#123; template &quot;</span>__alertmanagerURL<span class=\"string\">&quot; . &#125;&#125;&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #FFF; text-decoration: none; line-height: 2em; font-weight: bold; text-align: center; cursor: pointer; display: inline-block; border-radius: 5px; text-transform: capitalize; background-color: #348eda; margin: 0; border-color: #348eda; border-style: solid; border-width: 10px 20px;&quot;</span>&gt;View <span class=\"keyword\">in</span> &#123;&#123; template <span class=\"string\">&quot;__alertmanager&quot;</span> . &#125;&#125;&lt;/a&gt;</span><br><span class=\"line\">                      &lt;/td&gt;</span><br><span class=\"line\">                    &lt;/tr&gt;</span><br><span class=\"line\">                    &#123;&#123; <span class=\"keyword\">if</span> gt (len .Alerts.Firing) 0 &#125;&#125;</span><br><span class=\"line\">                    &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                      &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;</span><br><span class=\"line\">                        &lt;strong style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;[&#123;&#123; .Alerts.Firing | len &#125;&#125;] Firing&lt;/strong&gt;</span><br><span class=\"line\">                      &lt;/td&gt;</span><br><span class=\"line\">                    &lt;/tr&gt;</span><br><span class=\"line\">                    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                    &#123;&#123; range .Alerts.Firing &#125;&#125;</span><br><span class=\"line\">                    &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                      &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;</span><br><span class=\"line\">                        &lt;strong style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;Labels&lt;/strong&gt;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;</span><br><span class=\"line\">                        &#123;&#123; range .Labels.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                        &#123;&#123; <span class=\"keyword\">if</span> gt (len .Annotations) 0 &#125;&#125;&lt;strong style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;Annotations&lt;/strong&gt;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                        &#123;&#123; range .Annotations.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                        &lt;a href=<span class=\"string\">&quot;&#123;&#123; .GeneratorURL &#125;&#125;&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #348eda; text-decoration: underline; margin: 0;&quot;</span>&gt;Source&lt;/a&gt;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;</span><br><span class=\"line\">                      &lt;/td&gt;</span><br><span class=\"line\">                    &lt;/tr&gt;</span><br><span class=\"line\">                    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                    &#123;&#123; <span class=\"keyword\">if</span> gt (len .Alerts.Resolved) 0 &#125;&#125;</span><br><span class=\"line\">                      &#123;&#123; <span class=\"keyword\">if</span> gt (len .Alerts.Firing) 0 &#125;&#125;</span><br><span class=\"line\">                    &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                      &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;</span><br><span class=\"line\">                        &lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;</span><br><span class=\"line\">                        &lt;hr style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;</span><br><span class=\"line\">                        &lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;</span><br><span class=\"line\">                      &lt;/td&gt;</span><br><span class=\"line\">                    &lt;/tr&gt;</span><br><span class=\"line\">                      &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                    &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                      &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;</span><br><span class=\"line\">                        &lt;strong style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;[&#123;&#123; .Alerts.Resolved | len &#125;&#125;] Resolved&lt;/strong&gt;</span><br><span class=\"line\">                      &lt;/td&gt;</span><br><span class=\"line\">                    &lt;/tr&gt;</span><br><span class=\"line\">                    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                    &#123;&#123; range .Alerts.Resolved &#125;&#125;</span><br><span class=\"line\">                    &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                      &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0; padding: 0 0 20px;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;</span><br><span class=\"line\">                        &lt;strong style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;Labels&lt;/strong&gt;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;</span><br><span class=\"line\">                        &#123;&#123; range .Labels.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                        &#123;&#123; <span class=\"keyword\">if</span> gt (len .Annotations) 0 &#125;&#125;&lt;strong style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;Annotations&lt;/strong&gt;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                        &#123;&#123; range .Annotations.SortedPairs &#125;&#125;&#123;&#123; .Name &#125;&#125; = &#123;&#123; .Value &#125;&#125;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                        &lt;a href=<span class=\"string\">&quot;&#123;&#123; .GeneratorURL &#125;&#125;&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; color: #348eda; text-decoration: underline; margin: 0;&quot;</span>&gt;Source&lt;/a&gt;&lt;br style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span> /&gt;</span><br><span class=\"line\">                      &lt;/td&gt;</span><br><span class=\"line\">                    &lt;/tr&gt;</span><br><span class=\"line\">                    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">                  &lt;/table&gt;</span><br><span class=\"line\">                &lt;/td&gt;</span><br><span class=\"line\">              &lt;/tr&gt;</span><br><span class=\"line\">            &lt;/table&gt;</span><br><span class=\"line\">            &lt;div style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; width: 100%; clear: both; color: #999; margin: 0; padding: 20px;&quot;</span>&gt;</span><br><span class=\"line\">              &lt;table width=<span class=\"string\">&quot;100%&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                &lt;<span class=\"built_in\">tr</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; margin: 0;&quot;</span>&gt;</span><br><span class=\"line\">                  &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 12px; vertical-align: top; text-align: center; color: #999; margin: 0; padding: 0 0 20px;&quot;</span> align=<span class=\"string\">&quot;center&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;&lt;a href=<span class=\"string\">&quot;&#123;&#123; .ExternalURL &#125;&#125;&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 12px; color: #999; text-decoration: underline; margin: 0;&quot;</span>&gt;Sent by &#123;&#123; template <span class=\"string\">&quot;__alertmanager&quot;</span> . &#125;&#125;&lt;/a&gt;&lt;/td&gt;</span><br><span class=\"line\">                &lt;/tr&gt;</span><br><span class=\"line\">              &lt;/table&gt;</span><br><span class=\"line\">            &lt;/div&gt;&lt;/div&gt;</span><br><span class=\"line\">        &lt;/td&gt;</span><br><span class=\"line\">        &lt;td style=<span class=\"string\">&quot;font-family: &#x27;Helvetica Neue&#x27;, Helvetica, Arial, sans-serif; box-sizing: border-box; font-size: 14px; vertical-align: top; margin: 0;&quot;</span> valign=<span class=\"string\">&quot;top&quot;</span>&gt;&lt;/td&gt;</span><br><span class=\"line\">      &lt;/tr&gt;</span><br><span class=\"line\">    &lt;/table&gt;</span><br><span class=\"line\">    &lt;/body&gt;</span><br><span class=\"line\">    &lt;/html&gt;</span><br><span class=\"line\">    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;pushover.default.title&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__subject&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;pushover.default.message&quot;</span> &#125;&#125;&#123;&#123; .CommonAnnotations.SortedPairs.Values | <span class=\"built_in\">join</span> <span class=\"string\">&quot; &quot;</span> &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; <span class=\"keyword\">if</span> gt (len .Alerts.Firing) 0 &#125;&#125;</span><br><span class=\"line\">    Alerts Firing:</span><br><span class=\"line\">    &#123;&#123; template <span class=\"string\">&quot;__text_alert_list&quot;</span> .Alerts.Firing &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; <span class=\"keyword\">if</span> gt (len .Alerts.Resolved) 0 &#125;&#125;</span><br><span class=\"line\">    Alerts Resolved:</span><br><span class=\"line\">    &#123;&#123; template <span class=\"string\">&quot;__text_alert_list&quot;</span> .Alerts.Resolved &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;pushover.default.url&quot;</span> &#125;&#125;&#123;&#123; template <span class=\"string\">&quot;__alertmanagerURL&quot;</span> . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">  slack.tmpl: |</span><br><span class=\"line\">    &#123;&#123; define <span class=\"string\">&quot;slack.devops.text&quot;</span> &#125;&#125;</span><br><span class=\"line\">    &#123;&#123;range .Alerts&#125;&#125;&#123;&#123;.Annotations.DESCRIPTION&#125;&#125;</span><br><span class=\"line\">    &#123;&#123;end&#125;&#125;</span><br><span class=\"line\">    &#123;&#123; end &#125;&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim alertmanager/config.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: alertmanager-config</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">data:</span><br><span class=\"line\">  config.yml: |-</span><br><span class=\"line\">    global:</span><br><span class=\"line\">      resolve_timeout: 5m</span><br><span class=\"line\">      smtp_smarthost: <span class=\"string\">&#x27;smtp.163.com:465&#x27;</span>                <span class=\"comment\">#邮箱smtp服务器代理，启用SSL发信, 端口一般是465</span></span><br><span class=\"line\">      smtp_from: <span class=\"string\">&#x27;alert@163.com&#x27;</span>                <span class=\"comment\">#发送邮箱名称</span></span><br><span class=\"line\">      smtp_auth_username: <span class=\"string\">&#x27;alert@163.com&#x27;</span>               <span class=\"comment\">#邮箱名称</span></span><br><span class=\"line\">      smtp_auth_password: <span class=\"string\">&#x27;password&#x27;</span>                <span class=\"comment\">#邮箱密码或授权码</span></span><br><span class=\"line\">      smtp_require_tls: <span class=\"literal\">false</span></span><br><span class=\"line\">    templates:</span><br><span class=\"line\">    - <span class=\"string\">&#x27;/etc/templates/*.tmpl&#x27;</span></span><br><span class=\"line\">    route:</span><br><span class=\"line\">      receiver: <span class=\"string\">&#x27;default&#x27;</span></span><br><span class=\"line\">      group_wait: 10s</span><br><span class=\"line\">      group_interval: 1m</span><br><span class=\"line\">      repeat_interval: 1h</span><br><span class=\"line\">      group_by: [<span class=\"string\">&#x27;alertname&#x27;</span>, <span class=\"string\">&#x27;instance&#x27;</span>, <span class=\"string\">&#x27;cluster&#x27;</span>, <span class=\"string\">&#x27;service&#x27;</span>]</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - receiver: <span class=\"string\">&#x27;default&#x27;</span></span><br><span class=\"line\">        match:</span><br><span class=\"line\">          severity: <span class=\"string\">&#x27;warning&#x27;</span></span><br><span class=\"line\">      - receiver: <span class=\"string\">&#x27;dingtalk&#x27;</span></span><br><span class=\"line\">        match:</span><br><span class=\"line\">          severity: <span class=\"string\">&#x27;critical&#x27;</span></span><br><span class=\"line\">    inhibit_rules:</span><br><span class=\"line\">    - source_match:</span><br><span class=\"line\">        severity: <span class=\"string\">&#x27;critical&#x27;</span></span><br><span class=\"line\">      target_match:</span><br><span class=\"line\">        severity: <span class=\"string\">&#x27;warning&#x27;</span></span><br><span class=\"line\">      equal: [<span class=\"string\">&#x27;alertname&#x27;</span>, <span class=\"string\">&#x27;instance&#x27;</span>, <span class=\"string\">&#x27;cluster&#x27;</span>, <span class=\"string\">&#x27;service&#x27;</span>]</span><br><span class=\"line\">    receivers:</span><br><span class=\"line\">    - name: <span class=\"string\">&#x27;default&#x27;</span></span><br><span class=\"line\">      email_configs:</span><br><span class=\"line\">      - to: <span class=\"string\">&#x27;receiver@163.com&#x27;</span></span><br><span class=\"line\">        send_resolved: <span class=\"literal\">true</span></span><br><span class=\"line\">    - name: <span class=\"string\">&#x27;dingtalk&#x27;</span></span><br><span class=\"line\">      webhook_configs:</span><br><span class=\"line\">      - url: <span class=\"string\">&#x27;http://dingtalk:8060/dingtalk/webhook/send&#x27;</span></span><br><span class=\"line\">        send_resolved: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim alertmanager/alertmanager.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: alertmanager</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">  - host: 10.100.30.70</span><br><span class=\"line\">    http:</span><br><span class=\"line\">      paths:</span><br><span class=\"line\">      - path: /</span><br><span class=\"line\">        backend:</span><br><span class=\"line\">          serviceName: alertmanager</span><br><span class=\"line\">          servicePort: 9093</span><br><span class=\"line\">          </span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: alertmanager</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: alertmanager</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: alertmanager</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: alertmanager</span><br><span class=\"line\">    port: 9093</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 9093</span><br><span class=\"line\">    </span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: alertmanager</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: alertmanager</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      name: alertmanager</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: alertmanager</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: alertmanager</span><br><span class=\"line\">        image: prom/alertmanager:latest</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9093</span><br><span class=\"line\">        <span class=\"built_in\">env</span>:</span><br><span class=\"line\">        - name: POD_IP</span><br><span class=\"line\">          valueFrom:</span><br><span class=\"line\">            fieldRef:</span><br><span class=\"line\">              apiVersion: v1</span><br><span class=\"line\">              fieldPath: status.podIP</span><br><span class=\"line\">        args:</span><br><span class=\"line\">          - <span class=\"string\">&quot;--config.file=/etc/alertmanager/config.yml&quot;</span></span><br><span class=\"line\">          - <span class=\"string\">&quot;--storage.path=/alertmanager&quot;</span></span><br><span class=\"line\">          - <span class=\"string\">&quot;--cluster.advertise-address=<span class=\"subst\">$(POD_IP)</span>:6783&quot;</span>                <span class=\"comment\">#没有该参数会报错：Failed to get final advertise address</span></span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: config</span><br><span class=\"line\">          mountPath: /etc/alertmanager</span><br><span class=\"line\">        - name: templates</span><br><span class=\"line\">          mountPath: /etc/templates</span><br><span class=\"line\">        - name: alertmanager</span><br><span class=\"line\">          mountPath: /alertmanager</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: config</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: alertmanager-config</span><br><span class=\"line\">      - name: templates</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: alertmanager-templates</span><br><span class=\"line\">      - name: alertmanager</span><br><span class=\"line\">        emptyDir: &#123;&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"prometheus\"><a href=\"#prometheus\" class=\"headerlink\" title=\"prometheus\"></a>prometheus</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim prometheus/rbac.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">rules:</span><br><span class=\"line\">- apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - nodes</span><br><span class=\"line\">  - nodes/proxy</span><br><span class=\"line\">  - services</span><br><span class=\"line\">  - endpoints</span><br><span class=\"line\">  - pods</span><br><span class=\"line\">  verbs: [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">- apiGroups: [<span class=\"string\">&quot;networking.k8s.io&quot;</span>]</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - ingresses</span><br><span class=\"line\">  verbs: [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">- apiGroups: [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">  - configmaps</span><br><span class=\"line\">  verbs: [<span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\">- nonResourceURLs: [<span class=\"string\">&quot;/metrics&quot;</span>]</span><br><span class=\"line\">  verbs: [<span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim prometheus/config.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus-config</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">data:</span><br><span class=\"line\">  prometheus.yml: |</span><br><span class=\"line\">    global:</span><br><span class=\"line\">      scrape_interval: 10s</span><br><span class=\"line\">      scrape_timeout: 10s</span><br><span class=\"line\">      evaluation_interval: 10s</span><br><span class=\"line\">    alerting:</span><br><span class=\"line\">      alertmanagers:</span><br><span class=\"line\">      - static_configs:</span><br><span class=\"line\">        - targets:</span><br><span class=\"line\">          - alertmanager:9093</span><br><span class=\"line\">    rule_files:</span><br><span class=\"line\">      - <span class=\"string\">&quot;/etc/prometheus-rules/*.rules&quot;</span></span><br><span class=\"line\">    scrape_configs:</span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;node-exporter&#x27;</span>                <span class=\"comment\">#node节点性能指标数据</span></span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: endpoints</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_endpoint_port_name]</span><br><span class=\"line\">          regex: <span class=\"literal\">true</span>;node-exporter</span><br><span class=\"line\">          action: keep</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: __scheme__</span><br><span class=\"line\">          regex: (https?)</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: __metrics_path__</span><br><span class=\"line\">          regex: (.+)</span><br><span class=\"line\">        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: __address__</span><br><span class=\"line\">          regex: (.+)(?::\\d+);(\\d+)</span><br><span class=\"line\">          replacement: <span class=\"variable\">$1</span>:<span class=\"variable\">$2</span></span><br><span class=\"line\">        - action: labelmap</span><br><span class=\"line\">          regex: __meta_kubernetes_service_label_(.+)</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_namespace]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: kubernetes_namespace</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_name]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: kubernetes_name</span><br><span class=\"line\">          </span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kube-apiservers&#x27;</span></span><br><span class=\"line\">        scheme: https</span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: endpoints</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class=\"line\">          regex: default;kubernetes;https</span><br><span class=\"line\">          action: keep</span><br><span class=\"line\">        </span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kube-controller-manager&#x27;</span></span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: endpoints</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]</span><br><span class=\"line\">          regex: <span class=\"literal\">true</span>;kube-system;kube-controller-manager-prometheus-discovery</span><br><span class=\"line\">          action: keep</span><br><span class=\"line\">          </span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kube-scheduler&#x27;</span></span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: endpoints</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]</span><br><span class=\"line\">          regex: <span class=\"literal\">true</span>;kube-system;kube-scheduler-prometheus-discovery</span><br><span class=\"line\">          action: keep</span><br><span class=\"line\">          </span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kubelet&#x27;</span></span><br><span class=\"line\">        scheme: https</span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: node</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - action: labelmap</span><br><span class=\"line\">          regex: __meta_kubernetes_node_label_(.+)</span><br><span class=\"line\">        - target_label: __address__</span><br><span class=\"line\">          replacement: 192.168.30.188:6443</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_node_name]</span><br><span class=\"line\">          regex: (.+)</span><br><span class=\"line\">          target_label: __metrics_path__</span><br><span class=\"line\">          replacement: /api/v1/nodes/<span class=\"variable\">$&#123;1&#125;</span>/proxy/metrics</span><br><span class=\"line\"></span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kube-proxy&#x27;</span></span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: endpoints</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_namespace, __meta_kubernetes_service_name]</span><br><span class=\"line\">          regex: <span class=\"literal\">true</span>;kube-system;kube-proxy-prometheus-discovery</span><br><span class=\"line\">          action: keep</span><br><span class=\"line\"></span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kubernetes-cadvisor&#x27;</span>                <span class=\"comment\">#容器、Pod相关的性能指标数据</span></span><br><span class=\"line\">        scheme: https</span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: node</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - action: labelmap</span><br><span class=\"line\">          regex: __meta_kubernetes_node_label_(.+)</span><br><span class=\"line\">        - target_label: __address__</span><br><span class=\"line\">          replacement: 192.168.30.188:6443</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_node_name]</span><br><span class=\"line\">          regex: (.+)</span><br><span class=\"line\">          target_label: __metrics_path__</span><br><span class=\"line\">          replacement: /api/v1/nodes/<span class=\"variable\">$&#123;1&#125;</span>/proxy/metrics/cadvisor</span><br><span class=\"line\">        metric_relabel_configs:</span><br><span class=\"line\">        - source_labels: [<span class=\"built_in\">id</span>]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          regex: <span class=\"string\">&#x27;^/machine\\.slice/machine-rkt\\\\x2d([^\\\\]+)\\\\.+/([^/]+)\\.service$&#x27;</span></span><br><span class=\"line\">          target_label: rkt_container_name</span><br><span class=\"line\">          replacement: <span class=\"string\">&#x27;$&#123;2&#125;-$&#123;1&#125;&#x27;</span></span><br><span class=\"line\">        - source_labels: [<span class=\"built_in\">id</span>]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          regex: <span class=\"string\">&#x27;^/system\\.slice/(.+)\\.service$&#x27;</span></span><br><span class=\"line\">          target_label: systemd_service_name</span><br><span class=\"line\">          replacement: <span class=\"string\">&#x27;$&#123;1&#125;&#x27;</span></span><br><span class=\"line\">          </span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kube-state-metrics&#x27;</span>              <span class=\"comment\">#资源对象(Deployment、Pod等)的状态</span></span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: endpoints</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_endpoint_port_name]</span><br><span class=\"line\">          regex: <span class=\"literal\">true</span>;kube-state-metrics</span><br><span class=\"line\">          action: keep</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: __scheme__</span><br><span class=\"line\">          regex: (https?)</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: __metrics_path__</span><br><span class=\"line\">          regex: (.+)</span><br><span class=\"line\">        - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: __address__</span><br><span class=\"line\">          regex: (.+)(?::\\d+);(\\d+)</span><br><span class=\"line\">          replacement: <span class=\"variable\">$1</span>:<span class=\"variable\">$2</span></span><br><span class=\"line\">        - action: labelmap</span><br><span class=\"line\">          regex: __meta_kubernetes_service_label_(.+)</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_namespace]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: kubernetes_namespace</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_name]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: kubernetes_name</span><br><span class=\"line\">          </span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kubernetes-service-http-probe&#x27;</span>               <span class=\"comment\">#通过http方式探测Service状态</span></span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: service</span><br><span class=\"line\">        metrics_path: /probe</span><br><span class=\"line\">        params:</span><br><span class=\"line\">          module: [http_2xx]</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_http_probe]</span><br><span class=\"line\">          regex: <span class=\"literal\">true</span>;<span class=\"literal\">true</span></span><br><span class=\"line\">          action: keep</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_http_probe_port, __meta_kubernetes_service_annotation_prometheus_io_http_probe_path]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: __param_target</span><br><span class=\"line\">          regex: (.+);(.+);(.+);(.+)</span><br><span class=\"line\">          replacement: <span class=\"variable\">$1</span>.<span class=\"variable\">$2</span>:$3<span class=\"variable\">$4</span></span><br><span class=\"line\">        - target_label: __address__</span><br><span class=\"line\">          replacement: 192.168.30.128:30115</span><br><span class=\"line\">        - source_labels: [__param_target]</span><br><span class=\"line\">          target_label: instance</span><br><span class=\"line\">        - action: labelmap</span><br><span class=\"line\">          regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)</span><br><span class=\"line\"></span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kubernetes-service-tcp-probe&#x27;</span>                <span class=\"comment\">#通过tcp方式探测Service状态</span></span><br><span class=\"line\">        tls_config:</span><br><span class=\"line\">          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class=\"line\">        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: service</span><br><span class=\"line\">        metrics_path: /probe</span><br><span class=\"line\">        params:</span><br><span class=\"line\">          module: [tcp_connect]</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe]</span><br><span class=\"line\">          regex: <span class=\"literal\">true</span>;<span class=\"literal\">true</span></span><br><span class=\"line\">          action: keep</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_service_name, __meta_kubernetes_namespace, __meta_kubernetes_service_annotation_prometheus_io_tcp_probe_port]</span><br><span class=\"line\">          action: replace</span><br><span class=\"line\">          target_label: __param_target</span><br><span class=\"line\">          regex: (.+);(.+);(.+)</span><br><span class=\"line\">          replacement: <span class=\"variable\">$1</span>.<span class=\"variable\">$2</span>:<span class=\"variable\">$3</span></span><br><span class=\"line\">        - target_label: __address__</span><br><span class=\"line\">          replacement: 192.168.30.128:30115</span><br><span class=\"line\">        - source_labels: [__param_target]</span><br><span class=\"line\">          target_label: instance</span><br><span class=\"line\">        - action: labelmap</span><br><span class=\"line\">          regex: __meta_kubernetes_service_annotation_prometheus_io_app_info_(.+)</span><br><span class=\"line\">          </span><br><span class=\"line\">      - job_name: <span class=\"string\">&#x27;kubernetes-ingresses&#x27;</span>              <span class=\"comment\">#通过http方式探测ingresses状态</span></span><br><span class=\"line\">        kubernetes_sd_configs:</span><br><span class=\"line\">        - role: ingress</span><br><span class=\"line\">        metrics_path: /probe</span><br><span class=\"line\">        params:</span><br><span class=\"line\">          module: [http_2xx]</span><br><span class=\"line\">        relabel_configs:</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_ingress_scheme, __address__, __meta_kubernetes_ingress_path]</span><br><span class=\"line\">          regex: (.+);(.+);(.+)</span><br><span class=\"line\">          replacement: <span class=\"variable\">$&#123;1&#125;</span>://<span class=\"variable\">$&#123;2&#125;</span><span class=\"variable\">$&#123;3&#125;</span></span><br><span class=\"line\">          target_label: __param_target</span><br><span class=\"line\">        - target_label: __address__</span><br><span class=\"line\">          replacement: 192.168.30.128:30115</span><br><span class=\"line\">        - source_labels: [__param_target]</span><br><span class=\"line\">          target_label: instance</span><br><span class=\"line\">        - action: labelmap</span><br><span class=\"line\">          regex: __meta_kubernetes_ingress_label_(.+)</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_namespace]</span><br><span class=\"line\">          target_label: kubernetes_namespace</span><br><span class=\"line\">        - source_labels: [__meta_kubernetes_ingress_name]</span><br><span class=\"line\">          target_label: kubernetes_name</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim prometheus/rules.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus-rules</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">data:</span><br><span class=\"line\">  node.rules: |</span><br><span class=\"line\">    <span class=\"built_in\">groups</span>:</span><br><span class=\"line\">    - name: node</span><br><span class=\"line\">      rules:</span><br><span class=\"line\">      - alert: NodeDown</span><br><span class=\"line\">        <span class=\"built_in\">expr</span>: up == 0</span><br><span class=\"line\">        <span class=\"keyword\">for</span>: 3m</span><br><span class=\"line\">        labels:</span><br><span class=\"line\">          severity: critical</span><br><span class=\"line\">        annotations:</span><br><span class=\"line\">          summary: <span class=\"string\">&quot;&#123;&#123; <span class=\"variable\">$labels</span>.instance &#125;&#125;: down&quot;</span></span><br><span class=\"line\">          description: <span class=\"string\">&quot;&#123;&#123; <span class=\"variable\">$labels</span>.instance &#125;&#125; has been down for more than 3m&quot;</span></span><br><span class=\"line\">          value: <span class=\"string\">&quot;&#123;&#123; <span class=\"variable\">$value</span> &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      - alert: NodeCPUHigh</span><br><span class=\"line\">        <span class=\"built_in\">expr</span>: (1 - avg by (instance) (irate(node_cpu_seconds_total&#123;mode=<span class=\"string\">&quot;idle&quot;</span>&#125;[5m]))) * 100 &gt; 75</span><br><span class=\"line\">        <span class=\"keyword\">for</span>: 5m</span><br><span class=\"line\">        labels:</span><br><span class=\"line\">          severity: warning</span><br><span class=\"line\">        annotations:</span><br><span class=\"line\">          summary: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: High CPU usage&quot;</span></span><br><span class=\"line\">          description: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: CPU usage is above 75%&quot;</span></span><br><span class=\"line\">          value: <span class=\"string\">&quot;&#123;&#123; <span class=\"variable\">$value</span> &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      - alert: NodeCPUIowaitHigh</span><br><span class=\"line\">        <span class=\"built_in\">expr</span>: avg by (instance) (irate(node_cpu_seconds_total&#123;mode=<span class=\"string\">&quot;iowait&quot;</span>&#125;[5m])) * 100 &gt; 50</span><br><span class=\"line\">        <span class=\"keyword\">for</span>: 5m</span><br><span class=\"line\">        labels:</span><br><span class=\"line\">          severity: warning</span><br><span class=\"line\">        annotations:</span><br><span class=\"line\">          summary: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: High CPU iowait usage&quot;</span></span><br><span class=\"line\">          description: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: CPU iowait usage is above 50%&quot;</span></span><br><span class=\"line\">          value: <span class=\"string\">&quot;&#123;&#123; <span class=\"variable\">$value</span> &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      - alert: NodeMemoryUsageHigh</span><br><span class=\"line\">        <span class=\"built_in\">expr</span>: (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 &gt; 90</span><br><span class=\"line\">        <span class=\"keyword\">for</span>: 5m</span><br><span class=\"line\">        labels:</span><br><span class=\"line\">          severity: warning</span><br><span class=\"line\">        annotations:</span><br><span class=\"line\">          summary: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: High memory usage&quot;</span></span><br><span class=\"line\">          description: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: Memory usage is above 90%&quot;</span></span><br><span class=\"line\">          value: <span class=\"string\">&quot;&#123;&#123; <span class=\"variable\">$value</span> &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      - alert: NodeDiskRootLow</span><br><span class=\"line\">        <span class=\"built_in\">expr</span>: (1 - node_filesystem_avail_bytes&#123;fstype=~<span class=\"string\">&quot;ext.*|xfs&quot;</span>,mountpoint =<span class=\"string\">&quot;/&quot;</span>&#125; / node_filesystem_size_bytes&#123;fstype=~<span class=\"string\">&quot;ext.*|xfs&quot;</span>,mountpoint =<span class=\"string\">&quot;/&quot;</span>&#125;) * 100 &gt; 80</span><br><span class=\"line\">        <span class=\"keyword\">for</span>: 10m</span><br><span class=\"line\">        labels:</span><br><span class=\"line\">          severity: warning</span><br><span class=\"line\">        annotations:</span><br><span class=\"line\">          summary: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: Low disk(the / partition) space&quot;</span></span><br><span class=\"line\">          description: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: Disk(the / partition) usage is above 80%&quot;</span></span><br><span class=\"line\">          value: <span class=\"string\">&quot;&#123;&#123; <span class=\"variable\">$value</span> &#125;&#125;&quot;</span></span><br><span class=\"line\">        </span><br><span class=\"line\">      - alert: NodeDiskBootLow</span><br><span class=\"line\">        <span class=\"built_in\">expr</span>: (1 - node_filesystem_avail_bytes&#123;fstype=~<span class=\"string\">&quot;ext.*|xfs&quot;</span>,mountpoint =<span class=\"string\">&quot;/boot&quot;</span>&#125; / node_filesystem_size_bytes&#123;fstype=~<span class=\"string\">&quot;ext.*|xfs&quot;</span>,mountpoint =<span class=\"string\">&quot;/boot&quot;</span>&#125;) * 100 &gt; 80</span><br><span class=\"line\">        <span class=\"keyword\">for</span>: 10m</span><br><span class=\"line\">        labels:</span><br><span class=\"line\">          severity: warning</span><br><span class=\"line\">        annotations:</span><br><span class=\"line\">          summary: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: Low disk(the /boot partition) space&quot;</span></span><br><span class=\"line\">          description: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: Disk(the /boot partition) usage is above 80%&quot;</span></span><br><span class=\"line\">          value: <span class=\"string\">&quot;&#123;&#123; <span class=\"variable\">$value</span> &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      - alert: NodeLoad5High</span><br><span class=\"line\">        <span class=\"built_in\">expr</span>: (node_load5) &gt; (count by (instance) (node_cpu_seconds_total&#123;mode=<span class=\"string\">&#x27;system&#x27;</span>&#125;) * 2)</span><br><span class=\"line\">        <span class=\"keyword\">for</span>: 5m</span><br><span class=\"line\">        labels:</span><br><span class=\"line\">          severity: warning</span><br><span class=\"line\">        annotations:</span><br><span class=\"line\">          summary: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: Load(5m) High&quot;</span></span><br><span class=\"line\">          description: <span class=\"string\">&quot;&#123;&#123;<span class=\"variable\">$labels</span>.instance&#125;&#125;: Load(5m) is 2 times the number of CPU cores&quot;</span></span><br><span class=\"line\">          value: <span class=\"string\">&quot;&#123;&#123; <span class=\"variable\">$value</span> &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim prometheus/prometheus.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">  - host: prometheus.lzxlinux.cn</span><br><span class=\"line\">    http:</span><br><span class=\"line\">      paths:</span><br><span class=\"line\">      - path: /</span><br><span class=\"line\">        pathType: Prefix</span><br><span class=\"line\">        backend:</span><br><span class=\"line\">          service:</span><br><span class=\"line\">            name: prometheus</span><br><span class=\"line\">            port:</span><br><span class=\"line\">              number: 9090</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: prometheus</span><br><span class=\"line\">    port: 9090</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 9090</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: prometheus</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: prometheus</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      serviceAccountName: prometheus</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: prometheus</span><br><span class=\"line\">        image: prom/prometheus:latest</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        args:</span><br><span class=\"line\">          - <span class=\"string\">&#x27;--storage.tsdb.path=/prometheus&#x27;</span></span><br><span class=\"line\">          - <span class=\"string\">&#x27;--storage.tsdb.retention.time=30d&#x27;</span></span><br><span class=\"line\">          - <span class=\"string\">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 9090</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 500m</span><br><span class=\"line\">            memory: 500M</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 500m</span><br><span class=\"line\">            memory: 500M</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: config</span><br><span class=\"line\">          mountPath: /etc/prometheus</span><br><span class=\"line\">        - name: rules</span><br><span class=\"line\">          mountPath: /etc/prometheus-rules</span><br><span class=\"line\">        - name: prometheus</span><br><span class=\"line\">          mountPath: /prometheus</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: config</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: prometheus-config</span><br><span class=\"line\">      - name: rules</span><br><span class=\"line\">        configMap:</span><br><span class=\"line\">          name: prometheus-rules</span><br><span class=\"line\">      - name: prometheus</span><br><span class=\"line\">        emptyDir: &#123;&#125;</span><br><span class=\"line\">      nodeSelector:</span><br><span class=\"line\">        node-role.kubernetes.io/master: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        kubernetes.io/hostname: <span class=\"string\">&quot;master2&quot;</span></span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - key: node-role.kubernetes.io/master</span><br><span class=\"line\">        operator: Exists</span><br><span class=\"line\">        effect: NoSchedule</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"grafana\"><a href=\"#grafana\" class=\"headerlink\" title=\"grafana\"></a>grafana</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim grafana/secret.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Secret</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">data:</span><br><span class=\"line\">  admin-password: YWRtaW4=              <span class=\"comment\"># base64 加解密</span></span><br><span class=\"line\">  admin-username: YWRtaW4=</span><br><span class=\"line\"><span class=\"built_in\">type</span>: Opaque</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim grafana/grafana.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">    prometheus.io/path: <span class=\"string\">&#x27;/metrics&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: grafana</span><br><span class=\"line\">    port: 3000</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 3000</span><br><span class=\"line\">    nodePort: 32000  <span class=\"comment\"># 确保这个端口在你的范围内</span></span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: grafana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: grafana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: grafana</span><br><span class=\"line\">        image: grafana/grafana:latest</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 3000</span><br><span class=\"line\">          name: grafana</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 100Mi</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">            memory: 100Mi</span><br><span class=\"line\">        <span class=\"built_in\">env</span>:</span><br><span class=\"line\">          - name: GF_AUTH_BASIC_ENABLED</span><br><span class=\"line\">            value: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">          - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class=\"line\">            value: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">          - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class=\"line\">            value: Admin</span><br><span class=\"line\">          - name: GF_DASHBOARDS_JSON_ENABLED</span><br><span class=\"line\">            value: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">          - name: GF_INSTALL_PLUGINS</span><br><span class=\"line\">            value: grafana-kubernetes-app</span><br><span class=\"line\">          - name: GF_SECURITY_ADMIN_USER</span><br><span class=\"line\">            valueFrom:</span><br><span class=\"line\">              secretKeyRef:</span><br><span class=\"line\">                name: grafana</span><br><span class=\"line\">                key: admin-username</span><br><span class=\"line\">          - name: GF_SECURITY_ADMIN_PASSWORD</span><br><span class=\"line\">            valueFrom:</span><br><span class=\"line\">              secretKeyRef:</span><br><span class=\"line\">                name: grafana</span><br><span class=\"line\">                key: admin-password</span><br><span class=\"line\">        readinessProbe:</span><br><span class=\"line\">          httpGet:</span><br><span class=\"line\">            path: /login</span><br><span class=\"line\">            port: 3000</span><br><span class=\"line\">          initialDelaySeconds: 10</span><br><span class=\"line\">          timeoutSeconds: 5</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - name: grafana-storage</span><br><span class=\"line\">          mountPath: /var/lib/grafana</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: grafana-storage</span><br><span class=\"line\">        emptyDir: &#123;&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f namespace.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f node-exporter/</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f k8s/</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f kube-state-metrics/</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f blackbox-exporter/</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f dingtalk/</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f alertmanager/</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f prometheus/</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f grafana/</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"查看\"><a href=\"#查看\" class=\"headerlink\" title=\"查看\"></a>查看</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl get all -n monitoring</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                      READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">pod/alertmanager-9c4bf8565-z9mp9          1/1     Running   0          2m54s</span><br><span class=\"line\">pod/blackbox-exporter-57d847fc4c-mq8mx    1/1     Running   0          2m58s</span><br><span class=\"line\">pod/dingtalk-957f5896-9bd9b               1/1     Running   0          2m56s</span><br><span class=\"line\">pod/grafana-76779dc8cf-2fk4x              1/1     Running   0          2m46s</span><br><span class=\"line\">pod/kube-state-metrics-5d5f7cd774-tw4sw   1/1     Running   0          2m58s</span><br><span class=\"line\">pod/node-exporter-29bkg                   1/1     Running   0          3m5s</span><br><span class=\"line\">pod/node-exporter-45k2d                   1/1     Running   0          3m5s</span><br><span class=\"line\">pod/node-exporter-8dbts                   1/1     Running   0          3m5s</span><br><span class=\"line\">pod/node-exporter-9kwwt                   1/1     Running   0          3m5s</span><br><span class=\"line\">pod/node-exporter-bxhcf                   1/1     Running   0          3m5s</span><br><span class=\"line\">pod/prometheus-65848cf9b4-m5kcf           1/1     Running   0          2m49s</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)          AGE</span><br><span class=\"line\">service/alertmanager         ClusterIP   10.98.52.72      &lt;none&gt;        9093/TCP         2m55s</span><br><span class=\"line\">service/blackbox-exporter    NodePort    10.106.73.127    &lt;none&gt;        9115:30115/TCP   2m58s</span><br><span class=\"line\">service/dingtalk             ClusterIP   10.103.205.136   &lt;none&gt;        8060/TCP         2m57s</span><br><span class=\"line\">service/grafana              ClusterIP   10.103.12.113    &lt;none&gt;        3000/TCP         2m47s</span><br><span class=\"line\">service/kube-state-metrics   ClusterIP   10.98.99.215     &lt;none&gt;        8080/TCP         3m1s</span><br><span class=\"line\">service/node-exporter        ClusterIP   None             &lt;none&gt;        9100/TCP         3m6s</span><br><span class=\"line\">service/prometheus           ClusterIP   10.99.50.109     &lt;none&gt;        9090/TCP         2m51s</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE</span><br><span class=\"line\">daemonset.apps/node-exporter   5         5         5       5            5           &lt;none&gt;          3m5s</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                 READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">deployment.apps/alertmanager         1/1     1            1           2m55s</span><br><span class=\"line\">deployment.apps/blackbox-exporter    1/1     1            1           2m58s</span><br><span class=\"line\">deployment.apps/dingtalk             1/1     1            1           2m57s</span><br><span class=\"line\">deployment.apps/grafana              1/1     1            1           2m46s</span><br><span class=\"line\">deployment.apps/kube-state-metrics   1/1     1            1           3m</span><br><span class=\"line\">deployment.apps/prometheus           1/1     1            1           2m51s</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                            DESIRED   CURRENT   READY   AGE</span><br><span class=\"line\">replicaset.apps/alertmanager-9c4bf8565          1         1         1       2m55s</span><br><span class=\"line\">replicaset.apps/blackbox-exporter-57d847fc4c    1         1         1       2m58s</span><br><span class=\"line\">replicaset.apps/dingtalk-957f5896               1         1         1       2m56s</span><br><span class=\"line\">replicaset.apps/grafana-76779dc8cf              1         1         1       2m46s</span><br><span class=\"line\">replicaset.apps/kube-state-metrics-5d5f7cd774   1         1         1       3m</span><br><span class=\"line\">replicaset.apps/prometheus-65848cf9b4           1         1         1       2m51s</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"grafana模板\"><a href=\"#grafana模板\" class=\"headerlink\" title=\"grafana模板\"></a>grafana模板</h2><p><code>8919</code></p>\n<h2 id=\"grafana配置kubernetes数据源\"><a href=\"#grafana配置kubernetes数据源\" class=\"headerlink\" title=\"grafana配置kubernetes数据源\"></a>grafana配置kubernetes数据源</h2><p><code>启动插件：plugins--kubeernetes--enable</code>，然后配置集群访问地址及访问证书</p>\n<p><code>如果是通过kubeadm方式搭建的k8s集群，会有一个/etc/kubernetes/admin.conf文件，里面包含了客户端的证书和密码base64编码</code></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> /etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">clusters:</span><br><span class=\"line\">- cluster:</span><br><span class=\"line\">    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUN5RENDQWJDZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwcmRXSmwKY201bGRHVnpNQjRYRFRJd01EVXhNakV3TURBek1Gb1hEVE13TURVeE1ERXdNREF6TUZvd0ZURVRNQkVHQTFVRQpBeE1LYTNWaVpYSnVaWFJsY3pDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTDVpCmYxTGcxUUlqN0VlWlZ0cVFmS3dGZjg4V3NVbVVialZldll5NDZTUittMWpwRWdvM2wxWEIvZHBFNzRWOGtqTGQKZkdGdmVWZkVxNy8rMzdyamNGMXRpSm1BbThLZnMrMW9QdEpLOE0yZjNTSm5FZVVIQUlBeFl2cUE4ZFNsbThTQwpmSkJWU2J3K1pROTBTelpKNzdQUzFuZTBmYnRod0Y2VHE0Uy9FV3h3cUZZMzF5cENub05lVUNtcElsSjVnYWdtCnJ2QmhkTmFNb2oyQlRrMWNDVjh3dkRVS3RlbXFVYVE4R2ZCalZLeHhkdWtwcjJ3S3RPbXZkem1vMEdLSE11MFcKWmQ1TVd0dStIQVZrTXhzcE95Yk41NkFkNnloUkN5YkFJbTN2ZWJlTFV5cjBEY2JhNzJXNVlPRHRCY3ZBOEJxOAoxR1JQc1EwaXBUdGtYbDVCZEhzQ0F3RUFBYU1qTUNFd0RnWURWUjBQQVFIL0JBUURBZ0trTUE4R0ExVWRFd0VCCi93UUZNQU1CQWY4d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFJS0lIb25wVllFWWpwR3JrN2wraGJyeGlxZXkKeGFQT1M3UW5TZEVZMC94TWtiUWxKcy9rUFcxU2lVemdoUk4wQWJxMnFtTXVuNHhlZ0pLdGVPNXhYRGJZNEhZbgpVVCtPWG0rQ1hBQjd3S3pYcDlmUTZBUDk3cmY0L2FRaXlGZEtsZUJ6Y3JNUkErZHZWTjk3NGlHUW94aFh3T1FNCmZXeGNrMDNhU0Qvc2s5UnJrcFhlL1g2NHQrV3BkUlFGRjE2YVFlSHVxNnJQRWZTR2VPUWVpcVIrQVgvdWpIOHoKZzJZY2JKWE85U3ZheXcyb3oxSlozTUx6K0FpeE5RTHFNYU00Tm43TklvMExxUHFqNzZoU3d1Qk1nREE0VnFtZAowZHRtS211OVZjTGZHcW9ITnZnajlTYlVlZ1crL3VEbzcwVXdvb2NGTmlnSnRnOVVSZWpEUXJJSm4rUT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class=\"line\">    server: https://192.168.30.188:6443</span><br><span class=\"line\">  name: kubernetes</span><br><span class=\"line\">contexts:</span><br><span class=\"line\">- context:</span><br><span class=\"line\">    cluster: kubernetes</span><br><span class=\"line\">    user: kubernetes-admin</span><br><span class=\"line\">  name: kubernetes-admin@kubernetes</span><br><span class=\"line\">current-context: kubernetes-admin@kubernetes</span><br><span class=\"line\">kind: Config</span><br><span class=\"line\">preferences: &#123;&#125;</span><br><span class=\"line\"><span class=\"built_in\">users</span>:</span><br><span class=\"line\">- name: kubernetes-admin</span><br><span class=\"line\">  user:</span><br><span class=\"line\">    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM4akNDQWRxZ0F3SUJBZ0lJZWtMYS9Fc1ZDSGd3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TURBMU1USXhNREF3TXpCYUZ3MHlNVEExTVRJeE1EQXdNekphTURReApGekFWQmdOVkJBb1REbk41YzNSbGJUcHRZWE4wWlhKek1Sa3dGd1lEVlFRREV4QnJkV0psY201bGRHVnpMV0ZrCmJXbHVNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXJ2a084MUg0ZW9zak5kM3oKSy9UUEhHcGtCR1FvZm1hbm9ldjRlWXNmUTlPZW0wYzBvVUJ3cXoxM2JabmJUbmJweFFqbmdZMkc4bHF4UmkwaQpCdlA2ZmtmS0ZFQlZzUTd4dGlqZXBrdnByWEdPL08wUUE1U0k4NHJzTjVHOVhOa2pQbWdzYTBlblZxNUVvRTBGClRaNXpRRjlwUlkxWUZZZXYrTDE1bU5FaXlScUg4UDJRY3BoUmxWK09IUXVHaVdLNEhIRVB2QWw2QUpJeWN6d3MKWWMrdk1IdHlZbmF5NUMwUldVWHhyUmc0ZytKMksrY1h1YlF0elhXdjdxaTNhNjFDekpaZi9TZkNOd0Jyam9zRwp0b215WEJWNVZTVGJUYVk1OFZrLzFPK1NSc3BybjF3TDc0djdXUXVEaE9ydXhBRXpuYmRXWWxOMEZBMm5MTjlZCmwxWkVKUUlEQVFBQm95Y3dKVEFPQmdOVkhROEJBZjhFQkFNQ0JhQXdFd1lEVlIwbEJBd3dDZ1lJS3dZQkJRVUgKQXdJd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFHazlIRDAxRmRRUnd4THhGUi8yRjdPM2ZpdGRFV3pDTC9UawpsZUxZaGlQaVh3NjNwOGtWU0VabEIyNEYzNEd2WlB3YS9LWnNUQnZXM0Mwek9uNGpHQ2hueHEvaVdqTWFnVEdBCktPUFV2bUI2VzhvVzhlb0lrSStOOEs0NFhSRnZzeGIwNUtqaCtwd0VZZzJUQXpBNEFlQzlnSjZYaTBzbHpnVnIKcWRzbXZtV0QzNEdXYzJOcVIzSDA3cW43RlJwRHIrTjlrTHE4Ukt4L0YwMWNCV1I3VVRZcnJTLzJEQ2t1N3lsWgptdTcwcXZicndYWnF6TkI5b05hQk82SHJsZXpuU2JQbnFKZUo0Q1czc2NMNmJ1N3A3bEppV1VQb0VHT0xic3YvCnFjT0xqdnZSRFF6eC9Xak5DWFZLNFhxbzJjVERGYitXeFJ1U2xGaUlQclk1QjlkQlFJWT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=</span><br><span class=\"line\">    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb2dJQkFBS0NBUUVBcnZrTzgxSDRlb3NqTmQzeksvVFBIR3BrQkdRb2ZtYW5vZXY0ZVlzZlE5T2VtMGMwCm9VQndxejEzYlpuYlRuYnB4UWpuZ1kyRzhscXhSaTBpQnZQNmZrZktGRUJWc1E3eHRpamVwa3ZwclhHTy9PMFEKQTVTSTg0cnNONUc5WE5ralBtZ3NhMGVuVnE1RW9FMEZUWjV6UUY5cFJZMVlGWWV2K0wxNW1ORWl5UnFIOFAyUQpjcGhSbFYrT0hRdUdpV0s0SEhFUHZBbDZBSkl5Y3p3c1ljK3ZNSHR5WW5heTVDMFJXVVh4clJnNGcrSjJLK2NYCnViUXR6WFd2N3FpM2E2MUN6SlpmL1NmQ053QnJqb3NHdG9teVhCVjVWU1RiVGFZNThWay8xTytTUnNwcm4xd0wKNzR2N1dRdURoT3J1eEFFem5iZFdZbE4wRkEybkxOOVlsMVpFSlFJREFRQUJBb0lCQUI4OHI0S1krN2RFNThCUwpJM3VSZFBncHRqbGllQ2c0dzJ5UTZBY3E0eVlFdmFnVENqNVBkczNiWjFyVndPVTlMWGJUcENEbzExS2xCa2owCi9jSW9CR3hPL0xDbzI2T0VlM3A5eVdIKzQzVG5kUk9LYnZWMHF3NXZtc1JBN0lHSzhsUE4zVUE1eHBJZkFubHIKeHFxWXd4S1c5Z0JJdjVUNGFGNEwxWTJHcUtNbUlhenVjLzVleU5rZjk3bnRyOFJncXQxcDJyaWJIVS9nRzFlYgpIWktyNm01UWx2MWJpYTFIYms2SWI2b1pYTVFIWWJSckpVemJSaWp6eE1RVkRmZ2tpalhSR3pSRjdZeVFZbTk5CmwwUzI1bDYzY1dIT3J6czM5R21xRmQ4Z0JJc0M3SkxuUThUY01nb1Axb0M5WXUzMGRrSDBvUi95M2lOTnFxRW8KZVJ2d0w0RUNnWUVBeG1tY2JDZXRlRDI5VWZDTE1kKzByTU14aVV4bHI3TTdrYUJOeWxPK2lOZWxKbUk5UHRXcwpkUzQzS2hkeElnSVNIQVRTdWxpR3VKMStEekxTWWNGZ2FkSmQxd25NNHppOUc2cW9NOXZTTVN2ZGtvK28ydXRqCmNscVBZcnVRbC9nK252dkE2N1ZyZzAyUXF0NFlqcmkrYmxQL1RNaDZGS3NGa0VQeXZPTHUxOTBDZ1lFQTRjSFgKUm43WUl2TWtMNGQrR3dkUmRwcXl5YStxVC9nbUtKTnNwb3VLUVZlaUd3aW9vR21BR0E0MEJBR2hyN24vMXB6Rwo5VkVQb201VDdPRnVmVWxGaUNURmJBblN2RWU5RTREUHJ3SDNhazlXR0JzcWxYcUZwMjdwWWFyZ3NSS2JDWU9UCm9Nc1FJR0wxelN4NEpkdFArMUxDQ1BuRnowMTNkajhRbmc4TVBPa0NnWUFwczF5cTVwUHc1NWo0dGNPcmtjYloKWUpUeXRGblMyYXExYXFtdTBuY0RMNytJRjdHam1Ta0wzOUM4U2Z6L0ZzeFRremZ1N2xneVNQZUxualRWVXQwKwpvSFlVa2Z5NzdOcmlDN1lhWUNNSExwNzlCTENLZ2xwK1dFWTJqQkZSdjF6NThST1U5cVpJREc5UldpaHpKcVR2CmJ6d0RHVWQvUElxSXpaOGd6OWsvQ1FLQmdIbEFRaDVEdkZReElNdENTM0c2NFg4QklXdC9wTXFrcmVIM0pGRGkKKzFPUy9LYm1aS01iWnNnRXdOMHgveVJCa3U0eWNBMk1Cd2lubHYzUUtpYXlOdDBqV3NGbkdUODBqSkd3Q2x1bApnN3dlZGxBbUx4M3ZtMTlOQzU0QVNBUHl5VUEzNGc5bllQYjBENjZ0NXEzMmQ2TzFWQys3N3dralF6bElMK1drCmtWOFpBb0dBVk01R1lLbnpNVjUzVzNXT3I0dFdLSm5XUHFiaHVlUEt5SXMzbTNkUzhGUE56SDU2UHhNKzRUM24Ka2NzT1VsZTlkQkFENXRXT3E5eHFmNWF4MXpaU2s1SzFhdUphSzRaa3RzNkdMRUgrU09WckdoK1JXQWtRcUFVbgo0Qmk4ZVA4MmR5M3N2RmV1UkNvTWFXRVQ0QlFHaGRQaFFCd1NNdlYrSWI2R3U0VldwN289Ci0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p><code>其中属性certificate-authority-data、client-certificate-data、client-key-data对应CA证书、client证书、、client私钥，文件里面的内容是base64编码过后的，分别执行echo &quot;&lt;base64 code&gt;&quot; | base64 -d 就能还原成证书源文件。</code></p>\n<h1 id=\"yaml文件创建\"><a href=\"#yaml文件创建\" class=\"headerlink\" title=\"yaml文件创建\"></a>yaml文件创建</h1><p><code>先创建monitoring的名称空间：kubectl create namespace monitoring </code></p>\n<h2 id=\"alertmanager的yaml文件\"><a href=\"#alertmanager的yaml文件\" class=\"headerlink\" title=\"alertmanager的yaml文件\"></a>alertmanager的yaml文件</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">  labels: &#123;&#125;</span><br><span class=\"line\">  name: alertmanager</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;28485&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  progressDeadlineSeconds: 600</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  revisionHistoryLimit: 10</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: alertmanager</span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    rollingUpdate:</span><br><span class=\"line\">      maxSurge: 25%</span><br><span class=\"line\">      maxUnavailable: 25%</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: RollingUpdate</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      creationTimestamp: null</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: alertmanager</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - args:</span><br><span class=\"line\">            - <span class=\"string\">&#x27;--config.file=/etc/alertmanager/config.yml&#x27;</span></span><br><span class=\"line\">            - <span class=\"string\">&#x27;--storage.path=/alertmanager&#x27;</span></span><br><span class=\"line\">            - <span class=\"string\">&#x27;--cluster.advertise-address=$(POD_IP):6783&#x27;</span></span><br><span class=\"line\">          <span class=\"built_in\">env</span>:</span><br><span class=\"line\">            - name: POD_IP</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                fieldRef:</span><br><span class=\"line\">                  apiVersion: v1</span><br><span class=\"line\">                  fieldPath: status.podIP</span><br><span class=\"line\">          image: <span class=\"string\">&#x27;prom/alertmanager:latest&#x27;</span></span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          name: alertmanager</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 9093</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          resources: &#123;&#125;</span><br><span class=\"line\">          terminationMessagePath: /dev/termination-log</span><br><span class=\"line\">          terminationMessagePolicy: File</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - mountPath: /etc/alertmanager</span><br><span class=\"line\">              name: config</span><br><span class=\"line\">            - mountPath: /etc/templates</span><br><span class=\"line\">              name: templates</span><br><span class=\"line\">            - mountPath: /alertmanager</span><br><span class=\"line\">              name: alertmanager</span><br><span class=\"line\">      dnsPolicy: ClusterFirst</span><br><span class=\"line\">      restartPolicy: Always</span><br><span class=\"line\">      schedulerName: default-scheduler</span><br><span class=\"line\">      securityContext: &#123;&#125;</span><br><span class=\"line\">      terminationGracePeriodSeconds: 30</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - configMap:</span><br><span class=\"line\">            defaultMode: 420</span><br><span class=\"line\">            name: alertmanager-config</span><br><span class=\"line\">          name: config</span><br><span class=\"line\">        - configMap:</span><br><span class=\"line\">            defaultMode: 420</span><br><span class=\"line\">            name: alertmanager-templates</span><br><span class=\"line\">          name: templates</span><br><span class=\"line\">        - emptyDir: &#123;&#125;</span><br><span class=\"line\">          name: alertmanager</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    name: alertmanager</span><br><span class=\"line\">  name: alertmanager</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;28635&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  clusterIP: 10.233.20.249</span><br><span class=\"line\">  clusterIPs:</span><br><span class=\"line\">    - 10.233.20.249</span><br><span class=\"line\">  externalTrafficPolicy: Cluster</span><br><span class=\"line\">  internalTrafficPolicy: Cluster</span><br><span class=\"line\">  ipFamilies:</span><br><span class=\"line\">    - IPv4</span><br><span class=\"line\">  ipFamilyPolicy: SingleStack</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: alertmanager</span><br><span class=\"line\">      nodePort: 30093</span><br><span class=\"line\">      port: 9093</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      targetPort: 9093</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: alertmanager</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"blackbox-exporter-1\"><a href=\"#blackbox-exporter-1\" class=\"headerlink\" title=\"blackbox-exporter\"></a>blackbox-exporter</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">  labels: &#123;&#125;</span><br><span class=\"line\">  name: blackbox-exporter</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;37640&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  progressDeadlineSeconds: 600</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  revisionHistoryLimit: 10</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: blackbox-exporter</span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    rollingUpdate:</span><br><span class=\"line\">      maxSurge: 25%</span><br><span class=\"line\">      maxUnavailable: 25%</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: RollingUpdate</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      creationTimestamp: null</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: blackbox-exporter</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - args:</span><br><span class=\"line\">            - <span class=\"string\">&#x27;--config.file=/etc/blackbox_exporter/blackbox.yml&#x27;</span></span><br><span class=\"line\">            - <span class=\"string\">&#x27;--web.listen-address=:9115&#x27;</span></span><br><span class=\"line\">          image: <span class=\"string\">&#x27;prom/blackbox-exporter:latest&#x27;</span></span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          name: blackbox-exporter</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 9115</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          readinessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            initialDelaySeconds: 10</span><br><span class=\"line\">            periodSeconds: 10</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            tcpSocket:</span><br><span class=\"line\">              port: 9115</span><br><span class=\"line\">            timeoutSeconds: 5</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            limits:</span><br><span class=\"line\">              cpu: 200m</span><br><span class=\"line\">              memory: 60Mi</span><br><span class=\"line\">            requests:</span><br><span class=\"line\">              cpu: 100m</span><br><span class=\"line\">              memory: 50Mi</span><br><span class=\"line\">          terminationMessagePath: /dev/termination-log</span><br><span class=\"line\">          terminationMessagePolicy: File</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - mountPath: /etc/blackbox_exporter</span><br><span class=\"line\">              name: config</span><br><span class=\"line\">      dnsPolicy: ClusterFirst</span><br><span class=\"line\">      restartPolicy: Always</span><br><span class=\"line\">      schedulerName: default-scheduler</span><br><span class=\"line\">      securityContext: &#123;&#125;</span><br><span class=\"line\">      terminationGracePeriodSeconds: 30</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">        - effect: NoSchedule</span><br><span class=\"line\">          key: node-role.kubernetes.io/master</span><br><span class=\"line\">          operator: Exists</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - configMap:</span><br><span class=\"line\">            defaultMode: 420</span><br><span class=\"line\">            name: blackbox-exporter</span><br><span class=\"line\">          name: config</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: blackbox-exporter</span><br><span class=\"line\">  name: blackbox-exporter</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;27344&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  clusterIP: 10.233.60.92</span><br><span class=\"line\">  clusterIPs:</span><br><span class=\"line\">    - 10.233.60.92</span><br><span class=\"line\">  externalTrafficPolicy: Cluster</span><br><span class=\"line\">  internalTrafficPolicy: Cluster</span><br><span class=\"line\">  ipFamilies:</span><br><span class=\"line\">    - IPv4</span><br><span class=\"line\">  ipFamilyPolicy: SingleStack</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: blackbox</span><br><span class=\"line\">      nodePort: 30115</span><br><span class=\"line\">      port: 9115</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      targetPort: 9115</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: blackbox-exporter</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"dingtalk-1\"><a href=\"#dingtalk-1\" class=\"headerlink\" title=\"dingtalk\"></a>dingtalk</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;39074&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  progressDeadlineSeconds: 600</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  revisionHistoryLimit: 10</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: grafana</span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    rollingUpdate:</span><br><span class=\"line\">      maxSurge: 25%</span><br><span class=\"line\">      maxUnavailable: 25%</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: RollingUpdate</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      creationTimestamp: null</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: grafana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - <span class=\"built_in\">env</span>:</span><br><span class=\"line\">            - name: GF_AUTH_BASIC_ENABLED</span><br><span class=\"line\">              value: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">            - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class=\"line\">              value: <span class=\"string\">&#x27;false&#x27;</span></span><br><span class=\"line\">            - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class=\"line\">              value: Admin</span><br><span class=\"line\">            - name: GF_DASHBOARDS_JSON_ENABLED</span><br><span class=\"line\">              value: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">            - name: GF_INSTALL_PLUGINS</span><br><span class=\"line\">              value: grafana-kubernetes-app</span><br><span class=\"line\">            - name: GF_SECURITY_ADMIN_USER</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                secretKeyRef:</span><br><span class=\"line\">                  key: admin-username</span><br><span class=\"line\">                  name: grafana</span><br><span class=\"line\">            - name: GF_SECURITY_ADMIN_PASSWORD</span><br><span class=\"line\">              valueFrom:</span><br><span class=\"line\">                secretKeyRef:</span><br><span class=\"line\">                  key: admin-password</span><br><span class=\"line\">                  name: grafana</span><br><span class=\"line\">          image: <span class=\"string\">&#x27;grafana/grafana:latest&#x27;</span></span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          name: grafana</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 3000</span><br><span class=\"line\">              name: grafana</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          readinessProbe:</span><br><span class=\"line\">            failureThreshold: 3</span><br><span class=\"line\">            httpGet:</span><br><span class=\"line\">              path: /login</span><br><span class=\"line\">              port: 3000</span><br><span class=\"line\">              scheme: HTTP</span><br><span class=\"line\">            initialDelaySeconds: 30</span><br><span class=\"line\">            periodSeconds: 10</span><br><span class=\"line\">            successThreshold: 1</span><br><span class=\"line\">            timeoutSeconds: 5</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            limits:</span><br><span class=\"line\">              cpu: 100m</span><br><span class=\"line\">              memory: 100Mi</span><br><span class=\"line\">            requests:</span><br><span class=\"line\">              cpu: 100m</span><br><span class=\"line\">              memory: 100Mi</span><br><span class=\"line\">          terminationMessagePath: /dev/termination-log</span><br><span class=\"line\">          terminationMessagePolicy: File</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - mountPath: /var/lib/grafana</span><br><span class=\"line\">              name: grafana-storage</span><br><span class=\"line\">      dnsPolicy: ClusterFirst</span><br><span class=\"line\">      restartPolicy: Always</span><br><span class=\"line\">      schedulerName: default-scheduler</span><br><span class=\"line\">      securityContext: &#123;&#125;</span><br><span class=\"line\">      terminationGracePeriodSeconds: 30</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - emptyDir: &#123;&#125;</span><br><span class=\"line\">          name: grafana-storage</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;33834&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  clusterIP: 10.233.48.176</span><br><span class=\"line\">  clusterIPs:</span><br><span class=\"line\">    - 10.233.48.176</span><br><span class=\"line\">  externalTrafficPolicy: Cluster</span><br><span class=\"line\">  internalTrafficPolicy: Cluster</span><br><span class=\"line\">  ipFamilies:</span><br><span class=\"line\">    - IPv4</span><br><span class=\"line\">  ipFamilyPolicy: SingleStack</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: grafana</span><br><span class=\"line\">      nodePort: 32000</span><br><span class=\"line\">      port: 3000</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      targetPort: 3000</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: grafana</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">  name: grafana</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;33841&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">    - host: grafana.lzxlinux.cn</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">          - backend:</span><br><span class=\"line\">              service:</span><br><span class=\"line\">                name: grafana</span><br><span class=\"line\">                port:</span><br><span class=\"line\">                  number: 3000</span><br><span class=\"line\">            path: /</span><br><span class=\"line\">            pathType: Prefix</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"kube-state-metrics-1\"><a href=\"#kube-state-metrics-1\" class=\"headerlink\" title=\"kube-state-metrics\"></a>kube-state-metrics</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;38566&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  progressDeadlineSeconds: 600</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  revisionHistoryLimit: 10</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: kube-state-metrics</span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    rollingUpdate:</span><br><span class=\"line\">      maxSurge: 25%</span><br><span class=\"line\">      maxUnavailable: 25%</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: RollingUpdate</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      creationTimestamp: null</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: kube-state-metrics</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - image: <span class=\"string\">&#x27;quay.io/coreos/kube-state-metrics:v1.8.0&#x27;</span></span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          name: kube-state-metrics</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 8080</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          resources: &#123;&#125;</span><br><span class=\"line\">          terminationMessagePath: /dev/termination-log</span><br><span class=\"line\">          terminationMessagePolicy: File</span><br><span class=\"line\">      dnsPolicy: ClusterFirst</span><br><span class=\"line\">      restartPolicy: Always</span><br><span class=\"line\">      schedulerName: default-scheduler</span><br><span class=\"line\">      securityContext: &#123;&#125;</span><br><span class=\"line\">      serviceAccount: kube-state-metrics</span><br><span class=\"line\">      serviceAccountName: kube-state-metrics</span><br><span class=\"line\">      terminationGracePeriodSeconds: 30</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/http-probe: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">    prometheus.io/http-probe-path: /healthz</span><br><span class=\"line\">    prometheus.io/http-probe-port: <span class=\"string\">&#x27;8080&#x27;</span></span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;38207&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  clusterIP: 10.233.21.4</span><br><span class=\"line\">  clusterIPs:</span><br><span class=\"line\">    - 10.233.21.4</span><br><span class=\"line\">  internalTrafficPolicy: Cluster</span><br><span class=\"line\">  ipFamilies:</span><br><span class=\"line\">    - IPv4</span><br><span class=\"line\">  ipFamilyPolicy: SingleStack</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: kube-state-metrics</span><br><span class=\"line\">      port: 8080</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      targetPort: 8080</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: ClusterIP</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"node-exporter-1\"><a href=\"#node-exporter-1\" class=\"headerlink\" title=\"node-exporter\"></a>node-exporter</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: DaemonSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    deprecated.daemonset.template.generation: <span class=\"string\">&#x27;1&#x27;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: node-exporter</span><br><span class=\"line\">  name: node-exporter</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;27437&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  revisionHistoryLimit: 10</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: node-exporter</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      creationTimestamp: null</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: node-exporter</span><br><span class=\"line\">      name: node-exporter</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - image: <span class=\"string\">&#x27;prom/node-exporter:latest&#x27;</span></span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          name: node-exporter</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 9100</span><br><span class=\"line\">              hostPort: 9100</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          resources: &#123;&#125;</span><br><span class=\"line\">          terminationMessagePath: /dev/termination-log</span><br><span class=\"line\">          terminationMessagePolicy: File</span><br><span class=\"line\">      dnsPolicy: ClusterFirst</span><br><span class=\"line\">      hostNetwork: <span class=\"literal\">true</span></span><br><span class=\"line\">      hostPID: <span class=\"literal\">true</span></span><br><span class=\"line\">      restartPolicy: Always</span><br><span class=\"line\">      schedulerName: default-scheduler</span><br><span class=\"line\">      securityContext: &#123;&#125;</span><br><span class=\"line\">      terminationGracePeriodSeconds: 30</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">        - effect: NoSchedule</span><br><span class=\"line\">          key: node-role.kubernetes.io/master</span><br><span class=\"line\">          operator: Exists</span><br><span class=\"line\">  updateStrategy:</span><br><span class=\"line\">    rollingUpdate:</span><br><span class=\"line\">      maxSurge: 0</span><br><span class=\"line\">      maxUnavailable: 1</span><br><span class=\"line\">    <span class=\"built_in\">type</span>: RollingUpdate</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: node-exporter</span><br><span class=\"line\">  name: node-exporter</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&#x27;27267&#x27;</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  clusterIP: None</span><br><span class=\"line\">  clusterIPs:</span><br><span class=\"line\">    - None</span><br><span class=\"line\">  internalTrafficPolicy: Cluster</span><br><span class=\"line\">  ipFamilies:</span><br><span class=\"line\">    - IPv4</span><br><span class=\"line\">  ipFamilyPolicy: SingleStack</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: node-exporter</span><br><span class=\"line\">      port: 9100</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      targetPort: 9100</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: node-exporter</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: ClusterIP</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"promethues\"><a href=\"#promethues\" class=\"headerlink\" title=\"promethues\"></a>promethues</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">    k8s.kuboard.cn/name: prometheus</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: &#x27;33415&#x27;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  progressDeadlineSeconds: 600</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  revisionHistoryLimit: 10</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: prometheus</span><br><span class=\"line\">  strategy:</span><br><span class=\"line\">    rollingUpdate:</span><br><span class=\"line\">      maxSurge: 25%</span><br><span class=\"line\">      maxUnavailable: 25%</span><br><span class=\"line\">    type: RollingUpdate</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      creationTimestamp: null</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: prometheus</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">        - args:</span><br><span class=\"line\">            - &#x27;--storage.tsdb.path=/prometheus&#x27;</span><br><span class=\"line\">            - &#x27;--storage.tsdb.retention.time=30d&#x27;</span><br><span class=\"line\">            - &#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span><br><span class=\"line\">          image: &#x27;prom/prometheus:latest&#x27;</span><br><span class=\"line\">          imagePullPolicy: IfNotPresent</span><br><span class=\"line\">          name: prometheus</span><br><span class=\"line\">          ports:</span><br><span class=\"line\">            - containerPort: 9090</span><br><span class=\"line\">              protocol: TCP</span><br><span class=\"line\">          resources:</span><br><span class=\"line\">            limits:</span><br><span class=\"line\">              cpu: 500m</span><br><span class=\"line\">              memory: 500M</span><br><span class=\"line\">            requests:</span><br><span class=\"line\">              cpu: 500m</span><br><span class=\"line\">              memory: 500M</span><br><span class=\"line\">          terminationMessagePath: /dev/termination-log</span><br><span class=\"line\">          terminationMessagePolicy: File</span><br><span class=\"line\">          volumeMounts:</span><br><span class=\"line\">            - mountPath: /etc/prometheus</span><br><span class=\"line\">              name: config</span><br><span class=\"line\">            - mountPath: /etc/prometheus-rules</span><br><span class=\"line\">              name: rules</span><br><span class=\"line\">            - mountPath: /prometheus</span><br><span class=\"line\">              name: prometheus</span><br><span class=\"line\">      dnsPolicy: ClusterFirst</span><br><span class=\"line\">      restartPolicy: Always</span><br><span class=\"line\">      schedulerName: default-scheduler</span><br><span class=\"line\">      securityContext: &#123;&#125;</span><br><span class=\"line\">      serviceAccount: prometheus</span><br><span class=\"line\">      serviceAccountName: prometheus</span><br><span class=\"line\">      terminationGracePeriodSeconds: 30</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">        - effect: NoSchedule</span><br><span class=\"line\">          key: node-role.kubernetes.io/control-plane</span><br><span class=\"line\">          operator: Exists</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">        - configMap:</span><br><span class=\"line\">            defaultMode: 420</span><br><span class=\"line\">            name: prometheus-config</span><br><span class=\"line\">          name: config</span><br><span class=\"line\">        - configMap:</span><br><span class=\"line\">            defaultMode: 420</span><br><span class=\"line\">            name: prometheus-rules</span><br><span class=\"line\">          name: rules</span><br><span class=\"line\">        - emptyDir: &#123;&#125;</span><br><span class=\"line\">          name: prometheus</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: &#x27;true&#x27;</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: &#x27;33519&#x27;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  clusterIP: 10.233.51.128</span><br><span class=\"line\">  clusterIPs:</span><br><span class=\"line\">    - 10.233.51.128</span><br><span class=\"line\">  externalTrafficPolicy: Cluster</span><br><span class=\"line\">  internalTrafficPolicy: Cluster</span><br><span class=\"line\">  ipFamilies:</span><br><span class=\"line\">    - IPv4</span><br><span class=\"line\">  ipFamilyPolicy: SingleStack</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">    - name: prometheus</span><br><span class=\"line\">      nodePort: 30090</span><br><span class=\"line\">      port: 9090</span><br><span class=\"line\">      protocol: TCP</span><br><span class=\"line\">      targetPort: 9090</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: prometheus</span><br><span class=\"line\">  sessionAffinity: None</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: networking.k8s.io/v1</span><br><span class=\"line\">kind: Ingress</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations: &#123;&#125;</span><br><span class=\"line\">  name: prometheus</span><br><span class=\"line\">  namespace: monitoring</span><br><span class=\"line\">  resourceVersion: &#x27;33391&#x27;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">    - host: prometheus.lzxlinux.cn</span><br><span class=\"line\">      http:</span><br><span class=\"line\">        paths:</span><br><span class=\"line\">          - backend:</span><br><span class=\"line\">              service:</span><br><span class=\"line\">                name: prometheus</span><br><span class=\"line\">                port:</span><br><span class=\"line\">                  number: 9090</span><br><span class=\"line\">            path: /</span><br><span class=\"line\">            pathType: Prefix</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Prometheus","Kubernetes"]},{"title":"kkFileview文件预览","url":"/2025/11/05/kkFileview%E6%96%87%E4%BB%B6%E9%A2%84%E8%A7%88/","content":"<h3 id=\"kkfileview–单节点\"><a href=\"#kkfileview–单节点\" class=\"headerlink\" title=\"kkfileview–单节点\"></a>kkfileview–单节点</h3><h4 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h4><ol>\n<li><strong>文档预览</strong>：<ul>\n<li>支持预览多种文档格式，如 Word（.doc、.docx）、Excel（.xls、.xlsx）、PowerPoint（.ppt、.pptx）、PDF、TXT、图片（.jpg、.png、.gif）等。</li>\n<li>用户无需下载文件即可在浏览器中查看文档内容。</li>\n</ul>\n</li>\n<li><strong>跨平台支持</strong>：<ul>\n<li>兼容多种操作系统和浏览器，用户可以在不同设备上进行文档预览。</li>\n</ul>\n</li>\n<li><strong>集成简单</strong>：<ul>\n<li>提供 RESTful API，方便与其他系统集成，如文件管理系统、内容管理系统（CMS）、企业内部系统等。</li>\n<li>通过简单的 HTTP 请求即可实现文档预览功能。</li>\n</ul>\n</li>\n<li><strong>高性能</strong>：<ul>\n<li>采用高效的文档转换和渲染技术，确保文档预览的速度和质量。</li>\n<li>支持缓存机制，提高文档预览的响应速度。</li>\n</ul>\n</li>\n<li><strong>安全性</strong>：<ul>\n<li>提供多种安全配置选项，如访问控制、数据加密等，确保文档预览过程中的数据安全。</li>\n<li>支持配置白名单，限制只有特定 IP 地址可以访问预览服务。</li>\n</ul>\n</li>\n<li><strong>扩展性</strong>：<ul>\n<li>支持插件机制，用户可以根据需求扩展支持的文档格式和功能。</li>\n<li>提供详细的文档和示例，方便用户进行二次开发和定制。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"资源需求\"><a href=\"#资源需求\" class=\"headerlink\" title=\"资源需求\"></a>资源需求</h4><ul>\n<li><strong>CPU</strong>: 4 核 </li>\n<li><strong>内存</strong>:  8 GB </li>\n<li><strong>存储</strong>: 4T</li>\n<li><strong>节点</strong>：1</li>\n</ul>\n<h4 id=\"网络端口\"><a href=\"#网络端口\" class=\"headerlink\" title=\"网络端口\"></a>网络端口</h4><ul>\n<li><strong>端口号</strong>: 8012</li>\n<li><strong>用途</strong>: <ul>\n<li><strong>服务监听端口</strong>：<ul>\n<li>KKFileView 作为一个文档预览服务，会在指定的端口上监听 HTTP 请求。默认情况下，许多服务会使用 8080 端口，但为了避免冲突或出于其他配置需求，可以将其设置为 8012。</li>\n</ul>\n</li>\n<li><strong>客户端请求</strong>：<ul>\n<li>客户端（例如浏览器或其他应用程序）需要通过这个端口访问 KKFileView 提供的文档预览服务。例如，用户在浏览器中访问 <code>http://&lt;server-ip&gt;:8012/</code> 来查看文档。</li>\n</ul>\n</li>\n<li><strong>负载均衡和代理</strong>：<ul>\n<li>在一些复杂的部署环境中，8012 端口可能会被配置在负载均衡器或反向代理服务器（如 Nginx 或 Apache）后面，这些服务器会将请求转发到 KKFileView 服务。</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h4><h5 id=\"上传安装包\"><a href=\"#上传安装包\" class=\"headerlink\" title=\"上传安装包\"></a>上传安装包</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget  https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/kkFileView/LibreOffice_7.1.4_Linux_x86-64_rpm.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">wget  https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/kkFileView/kkFileView-4.0.0.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">wget  https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/JDK/jdk-11.0.20_linux-x64_bin.tar.gz</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"定义主机组\"><a href=\"#定义主机组\" class=\"headerlink\" title=\"定义主机组\"></a>定义主机组</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim kkfile</span><br><span class=\"line\">[kkfile]</span><br><span class=\"line\">10.100.40.254</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"编辑脚本\"><a href=\"#编辑脚本\" class=\"headerlink\" title=\"编辑脚本\"></a>编辑脚本</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim kkfile.sh</span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 设置变量</span><br><span class=\"line\">KKFILEVIEW_DIR=/data/kkFileView</span><br><span class=\"line\">LIBREOFFICE_ARCHIVE=/root/LibreOffice_7.1.4_Linux_x86-64_rpm.tar.gz</span><br><span class=\"line\">JDK_ARCHIVE=/root/jdk-11.0.20_linux-x64_bin.tar.gz</span><br><span class=\"line\">KKFILEVIEW_ARCHIVE=/root/kkFileView-4.0.0.tar.gz</span><br><span class=\"line\">JAVA_HOME_DIR=/usr/local/java</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 创建目录</span><br><span class=\"line\">mkdir -p $KKFILEVIEW_DIR</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 解压 LibreOffice</span><br><span class=\"line\">tar xzf $LIBREOFFICE_ARCHIVE -C $KKFILEVIEW_DIR</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 解压 JDK</span><br><span class=\"line\">tar xzf $JDK_ARCHIVE -C /usr/local</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 更名</span><br><span class=\"line\">mv /usr/local/jdk-11.0.20 $JAVA_HOME_DIR</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 配置环境变量</span><br><span class=\"line\">cat &gt;&gt; /etc/profile &lt;&lt;EOF</span><br><span class=\"line\">JAVA_HOME=$JAVA_HOME_DIR</span><br><span class=\"line\">PATH=&quot;\\$JAVA_HOME/bin:\\$PATH&quot;</span><br><span class=\"line\">export JAVA_HOME PATH</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 变量生效</span><br><span class=\"line\">source /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 安装 LibreOffice 依赖包</span><br><span class=\"line\">yum install -y $KKFILEVIEW_DIR/LibreOffice_7.1.4.2_Linux_x86-64_rpm/RPMS/*.rpm</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 安装其他依赖库</span><br><span class=\"line\">yum -y install cairo</span><br><span class=\"line\">yum -y install cups-libs</span><br><span class=\"line\">yum -y install libSM</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 验证库文件</span><br><span class=\"line\">if [ ! -f /usr/lib64/libcairo.so.2 ] || [ ! -f /usr/lib64/libcups.so.2 ] || [ ! -f /usr/lib64/libSM.so.6 ]; then</span><br><span class=\"line\">    echo &quot;One or more library files are missing. Exiting...&quot;</span><br><span class=\"line\">    exit 1</span><br><span class=\"line\">fi</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 更新库缓存</span><br><span class=\"line\">ldconfig</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 查看 LibreOffice 版本</span><br><span class=\"line\">/opt/libreoffice7.1/program/soffice --version</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 解压 kkFileView</span><br><span class=\"line\">tar xzf $KKFILEVIEW_ARCHIVE -C $KKFILEVIEW_DIR</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 修改配置文件</span><br><span class=\"line\">sed -i &#x27;s|office.home=.*|office.home=/opt/libreoffice7.1|g&#x27; $KKFILEVIEW_DIR/kkFileView-4.0.0/config/application.properties</span><br><span class=\"line\">sed -i &#x27;s|office.plugin.server.ports=.*|office.plugin.server.ports=2001,2002|g&#x27; $KKFILEVIEW_DIR/kkFileView-4.0.0/config/application.properties</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 查出所有 office 进程并杀掉</span><br><span class=\"line\">pkill -f office</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sleep 5</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 启动 kkFileView</span><br><span class=\"line\">$KKFILEVIEW_DIR/kkFileView-4.0.0/bin/startup.sh</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"拷贝至目标主机\"><a href=\"#拷贝至目标主机\" class=\"headerlink\" title=\"拷贝至目标主机\"></a>拷贝至目标主机</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim kkfile.yaml</span><br><span class=\"line\">---</span><br><span class=\"line\">- name: Deploy kkfileview cluster</span><br><span class=\"line\">  hosts: kkfile</span><br><span class=\"line\">  become: yes</span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: Copy kkfileview tarball to target hosts</span><br><span class=\"line\">      copy:</span><br><span class=\"line\">        src: /root/LibreOffice_7.1.4_Linux_x86-64_rpm.tar.gz</span><br><span class=\"line\">        dest: /root/LibreOffice_7.1.4_Linux_x86-64_rpm.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Copy kkfileview tarball to target hosts</span><br><span class=\"line\">      copy:</span><br><span class=\"line\">        src: /root/jdk-11.0.20_linux-x64_bin.tar.gz</span><br><span class=\"line\">        dest: /root/jdk-11.0.20_linux-x64_bin.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Copy kkfileview tarball to target hosts</span><br><span class=\"line\">      copy:</span><br><span class=\"line\">        src: /root/kkFileView-4.0.0.tar.gz</span><br><span class=\"line\">        dest: /root/kkFileView-4.0.0.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Copy kkfileview tarball to target hosts</span><br><span class=\"line\">      copy:</span><br><span class=\"line\">        src: /root/kkfile.sh</span><br><span class=\"line\">        dest: /root/kkfile.sh</span><br><span class=\"line\">        mode: &#x27;0755&#x27;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h5 id=\"执行传输\"><a href=\"#执行传输\" class=\"headerlink\" title=\"执行传输\"></a>执行传输</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# ansible-playbook -i /root/kkfile  kkfile.yaml</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"执行脚本\"><a href=\"#执行脚本\" class=\"headerlink\" title=\"执行脚本\"></a>执行脚本</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# ansible -i /root/kkfile kkfile -m shell -a &#x27;/root/kkfile.sh&#x27;</span><br></pre></td></tr></table></figure>\n\n<h5 id=\"验证\"><a href=\"#验证\" class=\"headerlink\" title=\"验证\"></a>验证</h5><pre><code>http:// IP + 8012\n</code></pre>\n","categories":["operations"],"tags":["Linux","kkFileview"]},{"title":"kubeadm方式部署k8s集群","url":"/2025/11/06/kubeadm%E6%96%B9%E5%BC%8F%E9%83%A8%E7%BD%B2k8s%E9%9B%86%E7%BE%A4/","content":"<p>k8s集群部署</p>\n<h1 id=\"下载k8s谷歌镜像\"><a href=\"#下载k8s谷歌镜像\" class=\"headerlink\" title=\"下载k8s谷歌镜像\"></a>下载k8s谷歌镜像</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker pull k8s.gcr.io/kube-apiserver:v1.16.1</span><br><span class=\"line\">docker pull k8s.gcr.io/kube-proxy:v1.16.1</span><br><span class=\"line\">docker pull k8s.gcr.io/kube-controller-manager:v1.16.1</span><br><span class=\"line\">docker pull k8s.gcr.io/kube-scheduler:v1.16.1</span><br><span class=\"line\">docker pull k8s.gcr.io/etcd:3.3.15</span><br><span class=\"line\">docker pull k8s.gcr.io/pause:3.1</span><br><span class=\"line\">docker pull k8s.gcr.io/coredns:1.6.2</span><br><span class=\"line\"></span><br><span class=\"line\">谷歌的k8s镜像库下载不下来</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"特别说明\"><a href=\"#特别说明\" class=\"headerlink\" title=\"特别说明\"></a>特别说明</h1><ul>\n<li>所有机器都必须有镜像</li>\n<li>每次部署都会有版本更新，具体版本要求，运行初始化过程失败会有版本提示</li>\n<li>kubeadm的版本和镜像的版本必须是对应的</li>\n</ul>\n<h1 id=\"准备环境\"><a href=\"#准备环境\" class=\"headerlink\" title=\"准备环境\"></a>准备环境</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">本地解析</span><br><span class=\"line\"><span class=\"section\">[root@master ~]</span><span class=\"comment\"># vim /etc/hosts</span></span><br><span class=\"line\">10.31.162.133\tkub-k8s-master</span><br><span class=\"line\">10.31.162.134\tkub-k8s-node1</span><br><span class=\"line\">10.31.162.135\tkub-k8s-node2</span><br><span class=\"line\"></span><br><span class=\"line\">1.关闭防火墙：</span><br><span class=\"line\"><span class=\"comment\"># systemctl stop firewalld</span></span><br><span class=\"line\"><span class=\"comment\"># systemctl disable firewalld</span></span><br><span class=\"line\">2.禁用SELinux：</span><br><span class=\"line\"><span class=\"comment\"># setenforce 0</span></span><br><span class=\"line\">3.编辑文件/etc/selinux/config，将SELINUX修改为disabled，如下：</span><br><span class=\"line\"><span class=\"comment\"># sed -i &#x27;s/SELINUX=permissive/SELINUX=disabled/&#x27; /etc/sysconfig/selinux</span></span><br><span class=\"line\"><span class=\"attr\">SELINUX</span>=disabled </span><br><span class=\"line\"></span><br><span class=\"line\">k8s集群需要关闭swap分区</span><br><span class=\"line\"><span class=\"section\">[root@master ~]</span><span class=\"comment\"># swapoff -a</span></span><br><span class=\"line\">修改/etc/fstab文件，注释掉SWAP的自动挂载，使用free -m确认swap已经关闭。</span><br><span class=\"line\">2.注释掉swap分区：</span><br><span class=\"line\"><span class=\"section\">[root@master ~]</span><span class=\"comment\"># sed -i &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span></span><br><span class=\"line\"><span class=\"comment\"># free -m</span></span><br><span class=\"line\">              total        used        free      shared  buff/cache   available</span><br><span class=\"line\">Mem:           3935         144        3415           8         375        3518</span><br><span class=\"line\">Swap:             0           0           0</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装docker–三台机器都操作\"><a href=\"#安装docker–三台机器都操作\" class=\"headerlink\" title=\"安装docker–三台机器都操作\"></a>安装docker–三台机器都操作</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">清理环境</span><br><span class=\"line\"><span class=\"section\">[root@master ~]</span><span class=\"comment\"># yum remove docker \\</span></span><br><span class=\"line\">docker-client \\</span><br><span class=\"line\">docker-client-latest \\</span><br><span class=\"line\">docker-common \\</span><br><span class=\"line\">docker-latest \\</span><br><span class=\"line\">docker-latest-logrotate \\</span><br><span class=\"line\">docker-logrotate \\</span><br><span class=\"line\">docker-selinux \\</span><br><span class=\"line\">docker-engine-selinux \\</span><br><span class=\"line\">docker-engine</span><br><span class=\"line\">下载docker</span><br><span class=\"line\"><span class=\"section\">[root@master ~]</span><span class=\"comment\"># yum install -y yum-utils device-mapper-persistent-data lvm2 git</span></span><br><span class=\"line\">更换阿里的源</span><br><span class=\"line\"><span class=\"section\">[root@master ~]</span><span class=\"comment\"># yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class=\"line\">下载dockers客户端</span><br><span class=\"line\"><span class=\"section\">[root@master ~]</span><span class=\"comment\"># yum install docker-ce -y</span></span><br><span class=\"line\"><span class=\"section\">[root@master ~]</span><span class=\"comment\"># systemctl start docker &amp;&amp; systemctl enable docker</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#注:在目前k8s版本1.20以后将原来的cgroupfs驱动程序修改成了systemd来为容器做资源限制，故此需要将docker的驱动程序修改为systemd。(所有节点)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@master ~]</span><span class=\"comment\"># cat /etc/docker/daemon.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> &quot;exec-opts&quot;:<span class=\"section\">[&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">重启docker</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"阿里仓库下载\"><a href=\"#阿里仓库下载\" class=\"headerlink\" title=\"阿里仓库下载\"></a>阿里仓库下载</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">下载镜像</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># vim pull.sh </span></span><br><span class=\"line\"><span class=\"comment\">#!/usr/bin/bash</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.2</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.2</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.2</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.2</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.8.4</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0</span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5</span><br><span class=\"line\"></span><br><span class=\"line\">下载完了之后需要将aliyun下载下来的所有镜像打成k8s.gcr.io/kube-controller-manager:v1.22.2这样的tag</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># vim tag.sh </span></span><br><span class=\"line\"><span class=\"comment\">#!/usr/bin/bash</span></span><br><span class=\"line\">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.22.2 k8s.gcr.io/kube-controller-manager:v1.22.2</span><br><span class=\"line\">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.22.2 k8s.gcr.io/kube-proxy:v1.22.2</span><br><span class=\"line\">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.22.2 k8s.gcr.io/kube-apiserver:v1.22.2</span><br><span class=\"line\">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.22.2 k8s.gcr.io/kube-scheduler:v1.22.2</span><br><span class=\"line\">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.8.4 k8s.gcr.io/coredns/coredns:v1.8.4</span><br><span class=\"line\">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.0-0 k8s.gcr.io/etcd:3.5.0-0</span><br><span class=\"line\">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.5 k8s.gcr.io/pause:3.5</span><br><span class=\"line\">版本号不用变</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"使用kubeadm部署Kubernetes\"><a href=\"#使用kubeadm部署Kubernetes\" class=\"headerlink\" title=\"使用kubeadm部署Kubernetes\"></a>使用kubeadm部署Kubernetes</h1><p><strong>所有节点安装kubeadm和kubelet</strong></p>\n<figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置源</span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-master ~]</span><span class=\"comment\"># cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class=\"line\"><span class=\"section\">[kubernetes]</span></span><br><span class=\"line\"><span class=\"attr\">name</span>=Kubernetes</span><br><span class=\"line\"><span class=\"attr\">baseurl</span>=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x<span class=\"number\">86_64</span></span><br><span class=\"line\"><span class=\"attr\">enabled</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">gpgcheck</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">repo_gpgcheck</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">gpgkey</span>=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">安装对应版本</span><br><span class=\"line\">1.安装最新版本</span><br><span class=\"line\"><span class=\"comment\"># yum makecache fast</span></span><br><span class=\"line\"><span class=\"comment\"># yum install -y kubelet kubeadm kubectl ipvsadm</span></span><br><span class=\"line\">=========================================</span><br><span class=\"line\">2.安装对应版本</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># yum install -y kubelet-1.22.2-0.x86_64 kubeadm-1.22.2-0.x86_64 kubectl-1.22.2-0.x86_64 ipvsadm</span></span><br><span class=\"line\"></span><br><span class=\"line\">加载ipvs相关内核模块</span><br><span class=\"line\"><span class=\"comment\">#如果重新开机，需要重新加载（可以写在 /etc/rc.local 中开机自动加载）</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># vim /etc/rc.local </span></span><br><span class=\"line\">modprobe ip_vs</span><br><span class=\"line\">modprobe ip_vs_rr</span><br><span class=\"line\">modprobe ip_vs_wrr</span><br><span class=\"line\">modprobe ip_vs_sh</span><br><span class=\"line\">modprobe nf_conntrack_ipv4</span><br><span class=\"line\"></span><br><span class=\"line\">给与执行权限</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># chmod +x /etc/rc.local</span></span><br><span class=\"line\">重启服务器</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># init 6</span></span><br><span class=\"line\"></span><br><span class=\"line\">配置转发相关参数，否则可能会出错</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># cat &lt;&lt;EOF &gt;  /etc/sysctl.d/k8s.conf</span></span><br><span class=\"line\"><span class=\"attr\">net.bridge.bridge-nf-call-ip6tables</span> = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">net.bridge.bridge-nf-call-iptables</span> = <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">vm.swappiness</span>=<span class=\"number\">0</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">使配置生效</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># sysctl --system</span></span><br><span class=\"line\"></span><br><span class=\"line\">如果net.bridge.bridge-nf-call-iptables报错，加载br_netfilter模块</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># modprobe br_netfilter</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># sysctl -p /etc/sysctl.d/k8s.conf</span></span><br><span class=\"line\"></span><br><span class=\"line\">查看是否加载成功</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># lsmod | grep ip_vs</span></span><br><span class=\"line\">ip_vs_sh               12688  0 </span><br><span class=\"line\">ip_vs_wrr              12697  0 </span><br><span class=\"line\">ip_vs_rr               12600  0 </span><br><span class=\"line\">ip_vs                 141092  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span><br><span class=\"line\">nf_conntrack          133387  2 ip_vs,nf_conntrack_ipv4</span><br><span class=\"line\">libcrc32c              12644  3 xfs,ip_vs,nf_conntrack</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置启动kubelet（所有节点）\"><a href=\"#配置启动kubelet（所有节点）\" class=\"headerlink\" title=\"配置启动kubelet（所有节点）\"></a>配置启动kubelet（所有节点）</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置变量：</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># DOCKER_CGROUPS=`docker info |grep &#x27;Cgroup&#x27; | awk &#x27; NR==1 &#123;print $3&#125;&#x27;`</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># echo $DOCKER_CGROUPS</span></span><br><span class=\"line\">cgroupfs 1</span><br><span class=\"line\"></span><br><span class=\"line\">配置kubelet的cgroups</span><br><span class=\"line\"><span class=\"comment\"># cat &gt;/etc/sysconfig/kubelet&lt;&lt;EOF</span></span><br><span class=\"line\"><span class=\"attr\">KUBELET_EXTRA_ARGS</span>=<span class=\"string\">&quot;--cgroup-driver=$DOCKER_CGROUPS --pod-infra-container-image=k8s.gcr.io/pause:3.5&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">启动</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># systemctl enable kubelet &amp;&amp; systemctl restart kubelet</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置master节点\"><a href=\"#配置master节点\" class=\"headerlink\" title=\"配置master节点\"></a>配置master节点</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># kubeadm init --kubernetes-version=v1.22.2 --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address=10.31.162.133 --ignore-preflight-errors=Swap</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm join 192.168.246.166:6443 --token 93erio.hbn2ti6z50he0lqs \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:3bc60f06a19bd09f38f3e05e5cff4299011b7110ca3281796668f4edb29a56d9  <span class=\"comment\">#需要记住，要保存好，配置node节点需要用到</span></span><br><span class=\"line\">注：</span><br><span class=\"line\"><span class=\"attr\">apiserver-advertise-address</span>=<span class=\"number\">192.168</span>.<span class=\"number\">246.166</span>    ---master的ip地址。</span><br><span class=\"line\"><span class=\"attr\">--kubernetes-version</span>=v1.<span class=\"number\">16.1</span>   --更具具体版本进行修改</span><br><span class=\"line\">注意在检查一下swap分区是否关闭</span><br><span class=\"line\"></span><br><span class=\"line\">如下操作在master节点操作</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># mkdir -p $HOME/.kube</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># chown $(id -u):$(id -g) $HOME/.kube/config</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置使用网络插件\"><a href=\"#配置使用网络插件\" class=\"headerlink\" title=\"配置使用网络插件\"></a>配置使用网络插件</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">在master节点操作</span><br><span class=\"line\">下载配置</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master ~]</span><span class=\"comment\"># cd ~ &amp;&amp; mkdir flannel &amp;&amp; cd flannel</span></span><br><span class=\"line\"></span><br><span class=\"line\">下载flannel文件由于网站被墙了，需要如下操作：</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master flannel]</span><span class=\"comment\"># curl -O https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\">修改配置文件kube-flannel.yml:</span><br><span class=\"line\">此处的ip配置要与上面kubeadm的pod-network一致，本来就一致，不用改</span><br><span class=\"line\">  net-conf.json: |</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      &quot;Network&quot;: &quot;10.244.0.0/16&quot;,</span><br><span class=\"line\">      &quot;Backend&quot;: &#123;</span><br><span class=\"line\">        &quot;Type&quot;: &quot;vxlan&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"comment\"># 如果Node有多个网卡的话，参考https://github.com/kubernetes/kubernetes/issues/39701</span></span><br><span class=\"line\"><span class=\"comment\"># 目前需要在kube-flannel.yml中使用--iface参数指定集群主机内网网卡的名称，否则可能会出现dns无法解析。容器无法通信的情况。</span></span><br><span class=\"line\"><span class=\"comment\">#需要将kube-flannel.yml下载到本地，</span></span><br><span class=\"line\"><span class=\"comment\"># flanneld启动参数加上--iface=&lt;iface-name&gt;</span></span><br><span class=\"line\">    containers:</span><br><span class=\"line\">      - name: kube-flannel</span><br><span class=\"line\">        image: quay.io/coreos/flannel:v0.12.0-amd64</span><br><span class=\"line\">        command:</span><br><span class=\"line\">        - /opt/bin/flanneld</span><br><span class=\"line\">        args:</span><br><span class=\"line\">        - --ip-masq</span><br><span class=\"line\">        - --kube-subnet-mgr</span><br><span class=\"line\">        - <span class=\"attr\">--iface</span>=ens33\t\t<span class=\"comment\">#如果一个，就添加这一个就行</span></span><br><span class=\"line\">        - <span class=\"attr\">--iface</span>=eth0</span><br><span class=\"line\"><span class=\"comment\"># 如果有多个网卡可以多个添加，没有多个就添加一个ens33就可以</span></span><br><span class=\"line\">⚠️⚠️⚠️<span class=\"attr\">--iface</span>=ens33 的值，是你当前的网卡,或者可以指定多网卡</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1.12版本的kubeadm额外给node1节点设置了一个污点(Taint)：node.kubernetes.io/not-ready:NoSchedule，</span></span><br><span class=\"line\"><span class=\"comment\"># 很容易理解，即如果节点还没有ready之前，是不接受调度的。可是如果Kubernetes的网络插件还没有部署的话，节点是不会进入ready状态的。</span></span><br><span class=\"line\"><span class=\"comment\"># 因此修改以下kube-flannel.yaml的内容，加入对node.kubernetes.io/not-ready:NoSchedule这个污点的容忍：</span></span><br><span class=\"line\">    - key: beta.kubernetes.io/arch</span><br><span class=\"line\">                    operator: In</span><br><span class=\"line\">                    values:</span><br><span class=\"line\">                      - arm64</span><br><span class=\"line\">      hostNetwork: true</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - operator: Exists</span><br><span class=\"line\">        effect: NoSchedule</span><br><span class=\"line\">      - key: node.kubernetes.io/not-ready  <span class=\"comment\">#添加如下三行---在165行左右</span></span><br><span class=\"line\">        operator: Exists</span><br><span class=\"line\">        effect: NoSchedule</span><br><span class=\"line\">      serviceAccountName: flannel</span><br><span class=\"line\"></span><br><span class=\"line\">启动：</span><br><span class=\"line\"><span class=\"section\">[root@k8s-master flannel]</span><span class=\"comment\"># kubectl apply -f ~/flannel/kube-flannel.yml  #启动完成之后需要等待一会</span></span><br><span class=\"line\"></span><br><span class=\"line\">查看、验证：</span><br><span class=\"line\"><span class=\"comment\"># 查看kube-system命名空间中的pod信息</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-master flannel]</span><span class=\"comment\"># kubectl get pods --namespace kube-system</span></span><br><span class=\"line\"><span class=\"comment\"># 查看 Kubernetes 集群中的服务信息</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-master flannel]</span><span class=\"comment\"># kubectl get service</span></span><br><span class=\"line\"><span class=\"comment\"># 查看 Kubernetes 集群中 kube-dns 服务的详细信息</span></span><br><span class=\"line\"><span class=\"section\">[root@k8s-master flannel]</span><span class=\"comment\"># kubectl get svc --namespace kube-system</span></span><br><span class=\"line\">只有网络插件也安装配置完成之后，才能会显示为ready状态</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"所有node节点操作\"><a href=\"#所有node节点操作\" class=\"headerlink\" title=\"所有node节点操作\"></a>所有node节点操作</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置node节点加入集群：</span><br><span class=\"line\">如果报错开启ip转发：</span><br><span class=\"line\"><span class=\"comment\"># sysctl -w net.ipv4.ip_forward=1</span></span><br><span class=\"line\"></span><br><span class=\"line\">在所有node节点操作，此命令为初始化master成功后返回的结果</span><br><span class=\"line\"><span class=\"section\">[root@kub-k8s-node1 ~]</span><span class=\"comment\"># kubeadm join 10.31.162.133:6443 --token 4pynt1.te3qf0zf7os3juf8 \\</span></span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:90142b9ae11196be81844225273cf64f74cc31b5f9250a81fdc2347dc55d2890 </span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Kubernetes"]},{"title":"linux网卡配置","url":"/2025/01/08/linux%E7%BD%91%E5%8D%A1%E9%85%8D%E7%BD%AE/","content":"<p><strong>永久设置网卡</strong></p>\n<blockquote>\n<p><code>另外也可以在终端上输入nmtui，进入网卡设置界面</code></p>\n</blockquote>\n<p><strong>1、Centos 7 配置</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">Centos 7</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">vim\t/etc/sysconfig/network-scripts/ifcfg-ens33 \t\t//网卡配置文件的路径</span></span><br><span class=\"line\">TYPE=Ethernet\t\t\t//网卡类型</span><br><span class=\"line\">BOOTPROTO=dhcp \t\t\t//网卡模式</span><br><span class=\"line\">     --&gt;  dhcp \t\t\t//自动获取</span><br><span class=\"line\">     --&gt;  static \t\t//手动获取</span><br><span class=\"line\">     --&gt;  none \t\t\t//手动获取</span><br><span class=\"line\">NAME=ens33 \t\t\t\t//网卡名称（可以修改的）</span><br><span class=\"line\">DEVICE=ens33 \t\t\t//设备名称</span><br><span class=\"line\">ONBOOT=yes \t\t\t\t//网卡开关</span><br><span class=\"line\">IPADDR=192.168.10.104\t//IP地址</span><br><span class=\"line\">PREFIX=24\t\t\t\t//子网掩码</span><br><span class=\"line\">NETMASK=255.255.255.0 \t//子网掩码</span><br><span class=\"line\">GATEWAY=192.168.10.2 \t//网关</span><br><span class=\"line\">DNS1=192.168.10.2 \t\t//DNS</span><br></pre></td></tr></table></figure>\n<p><strong>重启</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl restart network \t\t//重启网卡生效配置</span><br></pre></td></tr></table></figure>\n\n<p><strong>2、Centos 9 配置</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">Centos9</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">vim /etc/NetworkManager/system-connections/ens33.nmconnection  //修改如下选项即可</span></span><br><span class=\"line\">address=192.168.10.120/24,192.168.26.2 \t //ip地址，子网掩码，网关</span><br><span class=\"line\">dns=192.168.10.2       //DNS</span><br><span class=\"line\">method=manual \t\t\t\t\t\t</span><br><span class=\"line\"><span class=\"meta prompt_\">   --&gt; </span><span class=\"language-bash\">manual          //手动</span></span><br><span class=\"line\"><span class=\"meta prompt_\">   --&gt; </span><span class=\"language-bash\">auto            //自动</span></span><br></pre></td></tr></table></figure>\n<p><strong>重启</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">nmcli c reload      //重启网络服务 </span><br><span class=\"line\">nmcli c down ens33  //开启网络 </span><br><span class=\"line\">nmcli c up ens33    //关闭网络</span><br></pre></td></tr></table></figure>\n\n<p><strong>3、当network和networkmanager 网卡冲突</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop NetworkManager </span><br><span class=\"line\"></span><br><span class=\"line\">systemctl disabled NetworkManager   //将NetworkManger停止</span><br><span class=\"line\"></span><br><span class=\"line\">ifup ens33          //输入此命令即可查看ens33网卡</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl restart network          //重启网卡服务</span><br><span class=\"line\"></span><br><span class=\"line\"># 此时应该就可以看到ens33的IP地址了</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Network"]},{"title":"Nginx部署zabbix--告警飞书","url":"/2025/11/06/nginx%E9%83%A8%E7%BD%B2zabbix-%E5%91%8A%E8%AD%A6%E9%A3%9E%E4%B9%A6/","content":"<h3 id=\"nginx部署zabbix\"><a href=\"#nginx部署zabbix\" class=\"headerlink\" title=\"nginx部署zabbix\"></a>nginx部署zabbix</h3><h1 id=\"关闭防火墙\"><a href=\"#关闭防火墙\" class=\"headerlink\" title=\"关闭防火墙\"></a>关闭防火墙</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">setenforce 0</span><br><span class=\"line\">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装Zabbix存储库\"><a href=\"#安装Zabbix存储库\" class=\"headerlink\" title=\"安装Zabbix存储库\"></a>安装Zabbix存储库</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm</span><br><span class=\"line\">yum clean all</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装-Zabbix-server-and-agent\"><a href=\"#安装-Zabbix-server-and-agent\" class=\"headerlink\" title=\"安装 Zabbix server and agent\"></a>安装 Zabbix server and agent</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum install zabbix-server-mysql zabbix-agent -y</span><br><span class=\"line\">yum install centos-release-scl -y</span><br></pre></td></tr></table></figure>\n<h1 id=\"编辑配置文件-etc-yum-repos-d-zabbix-repo-并启用zabbix前端存储库\"><a href=\"#编辑配置文件-etc-yum-repos-d-zabbix-repo-并启用zabbix前端存储库\" class=\"headerlink\" title=\"编辑配置文件 &#x2F;etc&#x2F;yum.repos.d&#x2F;zabbix.repo 并启用zabbix前端存储库\"></a>编辑配置文件 &#x2F;etc&#x2F;yum.repos.d&#x2F;zabbix.repo 并启用zabbix前端存储库</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">sed -i &quot;11s/enabled=0/enabled=1/&quot; /etc/yum.repos.d/zabbix.repo</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装Zabbix前端软件包\"><a href=\"#安装Zabbix前端软件包\" class=\"headerlink\" title=\"安装Zabbix前端软件包\"></a>安装Zabbix前端软件包</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install zabbix-web-mysql-scl zabbix-nginx-conf-scl</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装数据库并设置开机自启\"><a href=\"#安装数据库并设置开机自启\" class=\"headerlink\" title=\"安装数据库并设置开机自启\"></a>安装数据库并设置开机自启</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install mariadb-server</span><br><span class=\"line\">systemctl start mariadb &amp;&amp; systemctl enable mariadb</span><br></pre></td></tr></table></figure>\n<h1 id=\"初始化数据库\"><a href=\"#初始化数据库\" class=\"headerlink\" title=\"初始化数据库\"></a>初始化数据库</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# mysql_secure_installation</span><br><span class=\"line\"></span><br><span class=\"line\">回车</span><br><span class=\"line\"></span><br><span class=\"line\">出现Set root password? [Y/n] 提示:输出Y,并设置密码</span><br><span class=\"line\"></span><br><span class=\"line\">Remove anonymous users? [Y/n] Y</span><br><span class=\"line\"></span><br><span class=\"line\">Disallow root login remotely? [Y/n] n</span><br><span class=\"line\"></span><br><span class=\"line\">Remove test database and access to it? [Y/n] Y</span><br><span class=\"line\"></span><br><span class=\"line\">Reload privilege tables now? [Y/n] Y</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建数据库，用户，允许用户远程登录\"><a href=\"#创建数据库，用户，允许用户远程登录\" class=\"headerlink\" title=\"创建数据库，用户，允许用户远程登录\"></a>创建数据库，用户，允许用户远程登录</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql -uroot -p&#x27;密码&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">create database zabbix character set utf8 collate utf8_bin;</span><br><span class=\"line\">create user zabbix@localhost identified by &#x27;123456&#x27;;</span><br><span class=\"line\">grant all privileges on zabbix.* to zabbix@&#x27;%&#x27;;</span><br><span class=\"line\">flush privileges;</span><br><span class=\"line\">\\q;</span><br></pre></td></tr></table></figure>\n<h1 id=\"导入初始架构和数据，系统将提示您输入新创建的密码\"><a href=\"#导入初始架构和数据，系统将提示您输入新创建的密码\" class=\"headerlink\" title=\"导入初始架构和数据，系统将提示您输入新创建的密码\"></a>导入初始架构和数据，系统将提示您输入新创建的密码</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p&#x27;123456&#x27; zabbix</span><br></pre></td></tr></table></figure>\n<h1 id=\"为Zabbix-server配置数据库，编辑配置文件-etc-zabbix-zabbix-server-conf\"><a href=\"#为Zabbix-server配置数据库，编辑配置文件-etc-zabbix-zabbix-server-conf\" class=\"headerlink\" title=\"为Zabbix server配置数据库，编辑配置文件 &#x2F;etc&#x2F;zabbix&#x2F;zabbix_server.conf\"></a>为Zabbix server配置数据库，编辑配置文件 &#x2F;etc&#x2F;zabbix&#x2F;zabbix_server.conf</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">sed -i &quot;s/# DBPassword=.*/DBPassword=123456/&quot; /etc/zabbix/zabbix_server.conf</span><br></pre></td></tr></table></figure>\n<h1 id=\"编辑配置文件-etc-opt-rh-rh-php72-php-fpm-d-zabbix-conf-添加nginx进行监听-然后取消注释并设置正确的时区\"><a href=\"#编辑配置文件-etc-opt-rh-rh-php72-php-fpm-d-zabbix-conf-添加nginx进行监听-然后取消注释并设置正确的时区\" class=\"headerlink\" title=\"编辑配置文件 &#x2F;etc&#x2F;opt&#x2F;rh&#x2F;rh-php72&#x2F;php-fpm.d&#x2F;zabbix.conf, 添加nginx进行监听,然后取消注释并设置正确的时区\"></a>编辑配置文件 &#x2F;etc&#x2F;opt&#x2F;rh&#x2F;rh-php72&#x2F;php-fpm.d&#x2F;zabbix.conf, 添加nginx进行监听,然后取消注释并设置正确的时区</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">sed -i &quot;s/listen.acl_users = apache/listen.acl_users = apache,nginx/&quot; /etc/opt/rh/rh-php72/php-fpm.d/zabbix.conf</span><br><span class=\"line\">echo &#x27;php_value[date.timezone] = Asia/Shanghai&#x27; &gt;&gt; /etc/opt/rh/rh-php72/php-fpm.d/zabbix.conf</span><br></pre></td></tr></table></figure>\n<h1 id=\"启动Zabbix-server和agent进程，并为它们设置开机自启\"><a href=\"#启动Zabbix-server和agent进程，并为它们设置开机自启\" class=\"headerlink\" title=\"启动Zabbix server和agent进程，并为它们设置开机自启\"></a>启动Zabbix server和agent进程，并为它们设置开机自启</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl restart zabbix-server zabbix-agent rh-nginx116-nginx rh-php72-php-fpm</span><br><span class=\"line\">systemctl enable zabbix-server zabbix-agent rh-nginx116-nginx rh-php72-php-fpm</span><br></pre></td></tr></table></figure>\n<h1 id=\"停止rh-nginx116-nginx\"><a href=\"#停止rh-nginx116-nginx\" class=\"headerlink\" title=\"停止rh-nginx116-nginx\"></a>停止rh-nginx116-nginx</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop rh-nginx116-nginx </span><br></pre></td></tr></table></figure>\n<h1 id=\"验证80端口还在不在，如果不在就可以安装nginx了\"><a href=\"#验证80端口还在不在，如果不在就可以安装nginx了\" class=\"headerlink\" title=\"验证80端口还在不在，如果不在就可以安装nginx了\"></a>验证80端口还在不在，如果不在就可以安装nginx了</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">netstat -lnpt |grep 80</span><br><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/dev/new-toolbox.sh)\t\t#下载nginx</span><br></pre></td></tr></table></figure>\n<h1 id=\"将-etc-opt-rh-rh-nginx116-nginx-conf-d-zabbix-conf目录下的配置文件复制到nginx-conf-d目录下，创建代理文件\"><a href=\"#将-etc-opt-rh-rh-nginx116-nginx-conf-d-zabbix-conf目录下的配置文件复制到nginx-conf-d目录下，创建代理文件\" class=\"headerlink\" title=\"将 &#x2F;etc&#x2F;opt&#x2F;rh&#x2F;rh-nginx116&#x2F;nginx&#x2F;conf.d&#x2F;zabbix.conf目录下的配置文件复制到nginx&#x2F;conf.d目录下，创建代理文件\"></a>将 &#x2F;etc&#x2F;opt&#x2F;rh&#x2F;rh-nginx116&#x2F;nginx&#x2F;conf.d&#x2F;zabbix.conf目录下的配置文件复制到nginx&#x2F;conf.d目录下，创建代理文件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cp /etc/opt/rh/rh-nginx116/nginx/conf.d/zabbix.conf  /etc/nginx/conf.d/zabbix.conf</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim zabbix.conf\t\t\t\t# 修改2处位置</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen          80;\t\t\t\t# 定义要监听的端口，可以自定义，尽量别用80，容易冲突</span><br><span class=\"line\">        server_name     192.168.0.253;\t\t# 更改为本机的IP地址</span><br><span class=\"line\"></span><br><span class=\"line\">        root    /usr/share/zabbix;</span><br><span class=\"line\"></span><br><span class=\"line\">        index   index.php;</span><br><span class=\"line\"></span><br><span class=\"line\">        location = /favicon.ico &#123;</span><br><span class=\"line\">                log_not_found   off;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">                try_files       $uri $uri/ =404;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location /assets &#123;</span><br><span class=\"line\">                access_log      off;</span><br><span class=\"line\">                expires         10d;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ~ /\\.ht &#123;</span><br><span class=\"line\">                deny            all;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ~ /(api\\/|conf[^\\.]|include|locale|vendor) &#123;</span><br><span class=\"line\">                deny            all;</span><br><span class=\"line\">                return          404;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ~ [^/]\\.php(/|$) &#123;</span><br><span class=\"line\">                fastcgi_pass    unix:/var/opt/rh/rh-php72/run/php-fpm/zabbix.sock;</span><br><span class=\"line\">#                fastcgi_pass    unix:/var/opt/rh/rh-php73/run/php-fpm/zabbix.sock;</span><br><span class=\"line\">                fastcgi_split_path_info ^(.+\\.php)(/.+)$;</span><br><span class=\"line\">                fastcgi_index   index.php;</span><br><span class=\"line\"></span><br><span class=\"line\">                fastcgi_param   DOCUMENT_ROOT   /usr/share/zabbix;</span><br><span class=\"line\">                fastcgi_param   SCRIPT_FILENAME /usr/share/zabbix$fastcgi_script_name;</span><br><span class=\"line\">                fastcgi_param   PATH_TRANSLATED /usr/share/zabbix$fastcgi_script_name;</span><br><span class=\"line\"></span><br><span class=\"line\">                include fastcgi_params;</span><br><span class=\"line\">                fastcgi_param   QUERY_STRING    $query_string;</span><br><span class=\"line\">                fastcgi_param   REQUEST_METHOD  $request_method;</span><br><span class=\"line\">                fastcgi_param   CONTENT_TYPE    $content_type;</span><br><span class=\"line\">                fastcgi_param   CONTENT_LENGTH  $content_length;</span><br><span class=\"line\"></span><br><span class=\"line\">                fastcgi_intercept_errors        on;</span><br><span class=\"line\">                fastcgi_ignore_client_abort     off;</span><br><span class=\"line\">                fastcgi_connect_timeout         60;</span><br><span class=\"line\">                fastcgi_send_timeout            180;</span><br><span class=\"line\">                fastcgi_read_timeout            180;</span><br><span class=\"line\">                fastcgi_buffer_size             128k;</span><br><span class=\"line\">                fastcgi_buffers                 4 256k;</span><br><span class=\"line\">                fastcgi_busy_buffers_size       256k;</span><br><span class=\"line\">                fastcgi_temp_file_write_size    256k;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"重启服务\"><a href=\"#重启服务\" class=\"headerlink\" title=\"重启服务\"></a>重启服务</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl restart nginx</span><br><span class=\"line\">systemctl restart zabbix-server zabbix-agent rh-php72-php-fpm</span><br></pre></td></tr></table></figure>\n<h1 id=\"访问地址\"><a href=\"#访问地址\" class=\"headerlink\" title=\"访问地址\"></a>访问地址</h1><p><code>本机的IP+端口</code><br><code>默认 用户： Admin\t密码：zabbix</code></p>\n<h1 id=\"agent端配置\"><a href=\"#agent端配置\" class=\"headerlink\" title=\"agent端配置\"></a>agent端配置</h1><h1 id=\"关闭防火墙-1\"><a href=\"#关闭防火墙-1\" class=\"headerlink\" title=\"关闭防火墙\"></a>关闭防火墙</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">setenforce 0</span><br><span class=\"line\">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/&#x27; /etc/selinux/config</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装zabbix–agent端\"><a href=\"#安装zabbix–agent端\" class=\"headerlink\" title=\"安装zabbix–agent端\"></a>安装zabbix–agent端</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm</span><br><span class=\"line\">yum install zabbix-agent zabbix-sender -y</span><br><span class=\"line\">cp /etc/zabbix/zabbix_agentd.conf /etc/zabbix/zabbix_agentd.conf.bak</span><br></pre></td></tr></table></figure>\n<h1 id=\"定义配置文件\"><a href=\"#定义配置文件\" class=\"headerlink\" title=\"定义配置文件\"></a>定义配置文件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /etc/zabbix/zabbix_agentd.conf</span><br><span class=\"line\">server=127.0.0.1\t\t\t# 写server端的IP</span><br><span class=\"line\">ServerActive=127.0.0.1\t\t# 写server端的IP</span><br><span class=\"line\">Hostname=test\t\t# 定义被监控端的名字</span><br><span class=\"line\">UnsafeUserParameters=0\t\t# 改为UnsafeUserParameters=1</span><br></pre></td></tr></table></figure>\n<h1 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl start zabbix-agent &amp;&amp; systemctl enable zabbix-agent</span><br></pre></td></tr></table></figure>\n<p><code>此时可以去web页面去配置了</code></p>\n<h1 id=\"zabbix报警飞书机器人\"><a href=\"#zabbix报警飞书机器人\" class=\"headerlink\" title=\"zabbix报警飞书机器人\"></a>zabbix报警飞书机器人</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">飞书PC端==&gt;&gt;创建群组</span><br><span class=\"line\">打开群组设置==&gt;&gt;添加“自定义机器人”</span><br><span class=\"line\">设置机器人名称、描述，复制保存生成的webhook地址</span><br></pre></td></tr></table></figure>\n<h1 id=\"创建飞书脚本文件\"><a href=\"#创建飞书脚本文件\" class=\"headerlink\" title=\"创建飞书脚本文件\"></a>创建飞书脚本文件</h1><p>登录zabbix服务器，进入到&#x2F;usr&#x2F;lib&#x2F;zabbix&#x2F;alertscripts&#x2F;目录，新建feishu.py文件。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">vi /usr/lib/zabbix/alertscripts/feishu.py</span><br><span class=\"line\">添加以下内容：</span><br><span class=\"line\">#!/usr/bin/python3</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import json</span><br><span class=\"line\">import sys</span><br><span class=\"line\">import os</span><br><span class=\"line\">import datetime</span><br><span class=\"line\"></span><br><span class=\"line\">url = &quot;webhook地址&quot; #你复制的webhook地址粘贴进url内</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def send_message(message):</span><br><span class=\"line\">    payload_message = &#123;</span><br><span class=\"line\">        &quot;msg_type&quot;: &quot;text&quot;,</span><br><span class=\"line\">        &quot;content&quot;: &#123;</span><br><span class=\"line\">            &quot;text&quot;: message</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    headers = &#123;</span><br><span class=\"line\">        &#x27;Content-Type&#x27;: &#x27;application/json&#x27;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    response = requests.request(&quot;POST&quot;, url, headers=headers, data=json.dumps(payload_message))</span><br><span class=\"line\">    return response</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &#x27;__main__&#x27;:</span><br><span class=\"line\">    text = sys.argv[1]</span><br><span class=\"line\">    send_message(text)</span><br></pre></td></tr></table></figure>\n<h1 id=\"添加执行权限\"><a href=\"#添加执行权限\" class=\"headerlink\" title=\"添加执行权限\"></a>添加执行权限</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">chmod +x /usr/lib/zabbix/alertscripts/feishu.py</span><br></pre></td></tr></table></figure>\n<h1 id=\"添加zabbix报警媒介\"><a href=\"#添加zabbix报警媒介\" class=\"headerlink\" title=\"添加zabbix报警媒介\"></a>添加zabbix报警媒介</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">创建报警媒介类型，参数添加：&#123;ALERT.MESSAGE&#125;</span><br><span class=\"line\">用户内添加报警媒介</span><br><span class=\"line\">根据需求配置需要告警的级别</span><br><span class=\"line\">添加完成后点击更新</span><br><span class=\"line\"></span><br><span class=\"line\">名称：feishu                   #名称任意</span><br><span class=\"line\">类型：脚本</span><br><span class=\"line\">脚本名称：feishu.py      </span><br><span class=\"line\">脚本参数： &#123;ALERT.MESSAGE&#125;     #一定要写，否则可能发送不成功</span><br></pre></td></tr></table></figure>\n<h1 id=\"创建动作并配置\"><a href=\"#创建动作并配置\" class=\"headerlink\" title=\"创建动作并配置\"></a>创建动作并配置</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置--创建动作--操作（设置通知用户，触发的脚本名称，消息内容）·</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">报警脚本：</span><br><span class=\"line\"></span><br><span class=\"line\">异常通知: &#123;EVENT.NAME&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">告警主机:&#123;HOSTNAME1&#125;</span><br><span class=\"line\">告警时间:&#123;EVENT.TIME&#125;</span><br><span class=\"line\">告警等级:&#123;TRIGGER.SEVERITY&#125; </span><br><span class=\"line\">告警信息:&#123;EVENT.NAME&#125; </span><br><span class=\"line\">告警项目:&#123;TRIGGER.KEY1&#125; </span><br><span class=\"line\">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125; </span><br><span class=\"line\">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125; </span><br><span class=\"line\">事件ID:&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">恢复操作脚本：</span><br><span class=\"line\"></span><br><span class=\"line\">恢复通知: &#123;EVENT.NAME&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">告警主机:&#123;HOSTNAME1&#125;</span><br><span class=\"line\">告警时间:&#123;EVENT.TIME&#125;</span><br><span class=\"line\">告警等级:&#123;TRIGGER.SEVERITY&#125; </span><br><span class=\"line\">告警信息:&#123;EVENT.NAME&#125; </span><br><span class=\"line\">告警项目:&#123;TRIGGER.KEY1&#125; </span><br><span class=\"line\">问题详情:&#123;ITEM.NAME&#125;:&#123;ITEM.VALUE&#125; </span><br><span class=\"line\">当前状态:&#123;TRIGGER.STATUS&#125;:&#123;ITEM.VALUE1&#125; </span><br><span class=\"line\">事件ID:&#123;EVENT.ID&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">点击保存即可</span><br></pre></td></tr></table></figure>\n<h1 id=\"告警媒介测试，及常见错误处理\"><a href=\"#告警媒介测试，及常见错误处理\" class=\"headerlink\" title=\"告警媒介测试，及常见错误处理\"></a>告警媒介测试，及常见错误处理</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">测试告警媒介</span><br></pre></td></tr></table></figure>\n<h1 id=\"没问题就可以在-配置–主机–-触发器里配置了\"><a href=\"#没问题就可以在-配置–主机–-触发器里配置了\" class=\"headerlink\" title=\"没问题就可以在  配置–主机– 触发器里配置了\"></a>没问题就可以在  配置–主机– 触发器里配置了</h1><h1 id=\"常见错误：\"><a href=\"#常见错误：\" class=\"headerlink\" title=\"常见错误：\"></a>常见错误：</h1><p>1.python3路径错误</p>\n<p>feishu.py脚本的第一句配置的python3路径不对需要手动重新手动指定</p>\n<p>找到当前系统python3的路径替换feishu.py脚本中的第一行#!&#x2F;usr&#x2F;bin&#x2F;python3</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@Zabbix alertscripts]# whereis python3</span><br><span class=\"line\">python3: /usr/local/bin/python3.8 /usr/local/bin/python3.8-config /usr/local/bin/python3 /usr/local/lib/python3.8</span><br></pre></td></tr></table></figure>\n<p>2.python3环境没有安装requests模块,使用pip3安装requests模块</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@Zabbix alertscripts]# pip3 install requests</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"redis-cluster 集群部署","url":"/2025/11/06/redis-cluster-%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2/","content":"<p><strong>redis-cluster集群</strong></p>\n<p>准备环境</p>\n<p><strong>准备3台机器，关闭防火墙和selinux</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">注:规划架构两种方案，一种是单机多实例，这里我们采用多机器部署:</span></span><br><span class=\"line\">三台机器，每台机器上面两个redis实例，一个master一个slave，第一列做主库，第二列做备库</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">记得选出控制节点</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost ~]# vim /etc/hosts</span><br><span class=\"line\">redis-cluster1 192.168.116.111 7000 7001</span><br><span class=\"line\">redis-cluster2 192.168.116.131 7002 7003</span><br><span class=\"line\">redis-cluster3 192.168.116.132 7004 7005</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改主机名</span></span><br><span class=\"line\">[root@localhost ~]# hostnamectl set-hostname redis-cluster1</span><br><span class=\"line\">[root@localhost ~]# hostnamectl set-hostname redis-cluster2</span><br><span class=\"line\">[root@localhost ~]# hostnamectl set-hostname redis-cluster3</span><br></pre></td></tr></table></figure>\n\n<p><strong>三台机器相同的操作</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装redis依赖环境</span></span><br><span class=\"line\">[root@redis-cluster1 ~]# yum -y install gcc automake autoconf libtool make</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">官方下载redis，这里用的是6.2的版本</span></span><br><span class=\"line\">[root@redis-cluster1 ~]# wget https://download.redis.io/releases/redis-6.2.0.tar.gz</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">创建目录、并指定路径解压软件包</span></span><br><span class=\"line\">[root@redis-cluster1 ~]# mkdir /data</span><br><span class=\"line\">[root@redis-cluster1 ~]# tar xzvf redis-6.2.0.tar.gz -C /data/</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">切换目录</span></span><br><span class=\"line\">[root@redis-cluster1 ~]# cd /data/</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改目录名</span></span><br><span class=\"line\">[root@redis-cluster1 data]# mv redis-6.2.0/ redis</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">进入redis目录</span></span><br><span class=\"line\">[root@redis-cluster1 data]# cd redis/</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编译</span></span><br><span class=\"line\">[root@redis-cluster1 redis]# make</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">创建存放数据的目录</span></span><br><span class=\"line\">[root@redis-cluster1 redis]# mkdir /data/redis/data </span><br></pre></td></tr></table></figure>\n\n<p><strong>创建节点目录</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">创建节点目录:按照规划在每台redis节点的安装目录中创建对应的目录（以端口号命名）</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">redis-cluster1</span></span><br><span class=\"line\">[root@redis-cluster1 redis]# pwd</span><br><span class=\"line\">/data/redis</span><br><span class=\"line\">[root@redis-cluster1 redis]# mkdir cluster #创建集群目录</span><br><span class=\"line\">[root@redis-cluster1 redis]# cd cluster/</span><br><span class=\"line\">[root@redis-cluster1 cluster]# mkdir 7000 7001 #创建节点目录</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">redis-cluster2</span></span><br><span class=\"line\">[root@redis-cluster2 redis]# mkdir cluster</span><br><span class=\"line\">[root@redis-cluster2 redis]# cd cluster/</span><br><span class=\"line\">[root@redis-cluster2 cluster]# mkdir 7002 7003</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">redis-cluster3</span></span><br><span class=\"line\">[root@redis-cluster3 redis]# mkdir cluster</span><br><span class=\"line\">[root@redis-cluster3 redis]# cd cluster/</span><br><span class=\"line\">[root@redis-cluster3 cluster]# mkdir 7004 7005</span><br></pre></td></tr></table></figure>\n\n<p><strong>修改集群每个redis配置文件</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">redis-cluster1</span></span><br><span class=\"line\">[root@redis-cluster1 cluster]# cp /data/reids/redis.conf ./7000</span><br><span class=\"line\">[root@redis-cluster1 cluster]# ls</span><br><span class=\"line\">7000  7001</span><br><span class=\"line\">[root@redis-cluster1 cluster]# vim ./7000/redis.conf</span><br><span class=\"line\">[root@redis-cluster1 cluster]# cp ./7000/redis.conf ./7001/</span><br><span class=\"line\">[root@redis-cluster1 cluster]# vim ./7001/redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改内容如下</span></span><br><span class=\"line\">bind 192.168.116.172  #每个实例的配置文件修改为对应节点的ip地址</span><br><span class=\"line\">protected-mode no\t#关闭密码服务</span><br><span class=\"line\">port 7000   #监听端口，运行多个实例时，需要指定规划的每个实例不同的端口号</span><br><span class=\"line\">daemonize yes #redis后台运行</span><br><span class=\"line\">pidfile /var/run/redis_7000.pid #pid文件，运行多个实例时，需要指定不同的pid文件</span><br><span class=\"line\">logfile /var/log/redis_7000.log #日志文件位置，运行多实例时，需要将文件修改的不同。</span><br><span class=\"line\">dir /data/redis/data #存放数据的目录</span><br><span class=\"line\">appendonly yes #开启AOF持久化，redis会把所接收到的每一次写操作请求都追加到appendonly.aof文件中，当redis重新启动时，会从该文件恢复出之前的状态。</span><br><span class=\"line\">appendfilename &quot;appendonly.aof&quot;  #AOF文件名称</span><br><span class=\"line\">appendfsync everysec #表示对写操作进行累积，每秒同步一次</span><br><span class=\"line\">以下为打开注释并修改</span><br><span class=\"line\">cluster-enabled yes #启用集群</span><br><span class=\"line\">cluster-config-file nodes-7000.conf #集群配置文件，由redis自动更新，不需要手动配置，运行多实例时请注修改为对应端口</span><br><span class=\"line\">cluster-node-timeout 5000 #单位毫秒。集群节点超时时间，即集群中主从节点断开连接时间阈值，超过该值则认为主节点不可以，从节点将有可能转为master</span><br><span class=\"line\">cluster-replica-validity-factor 10 #在进行故障转移的时候全部slave都会请求申请为master，但是有些slave可能与master断开连接一段时间了导致数据过于陈旧，不应该被提升为master。该参数就是用来判断slave节点与master断线的时间是否过长。</span><br><span class=\"line\">cluster-migration-barrier 1 #一个主机将保持连接的最小数量的从机，以便另一个从机迁移到不再被任何从机覆盖的主机</span><br><span class=\"line\">cluster-require-full-coverage yes #集群中的所有slot（16384个）全部覆盖，才能提供服务</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">注：</span></span><br><span class=\"line\">所有节点配置文件全部修改切记需要修改的ip、端口、pid文件...避免冲突。确保所有机器都修改。</span><br></pre></td></tr></table></figure>\n\n<p><strong>redis-cluster2—-redis-cluster3</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis-cluster2----redis-cluster3</span><br><span class=\"line\">重复redis-cluster1步骤操作</span><br></pre></td></tr></table></figure>\n\n<p><strong>启动三台机器上面的每个节点(三台机器相同操作)</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@redis-cluster1 ~]# cd /data/redis/src/</span><br><span class=\"line\">[root@redis-cluster1 src]# ./redis-server ../cluster/7000/redis.conf </span><br><span class=\"line\">[root@redis-cluster1 src]# ./redis-server ../cluster/7001/redis.conf</span><br><span class=\"line\"></span><br><span class=\"line\">[root@redis-cluster2 7003]# cd /data/redis/src/</span><br><span class=\"line\">[root@redis-cluster2 src]# ./redis-server ../cluster/7002/redis.conf </span><br><span class=\"line\">[root@redis-cluster2 src]# ./redis-server ../cluster/7003/redis.conf</span><br><span class=\"line\"></span><br><span class=\"line\">[root@redis-cluster3 7005]# cd /data/redis/src/</span><br><span class=\"line\">[root@redis-cluster3 src]# ./redis-server ../cluster/7004/redis.conf </span><br><span class=\"line\">[root@redis-cluster3 src]# ./redis-server ../cluster/7005/redis.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">注意 如果没有报错，但是就是启动不了，看不到端口，把配置文件里的<span class=\"built_in\">dir</span>路径写相对路径</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>查看端口</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">每个机器上都可以看下端口有没有起来</span></span><br><span class=\"line\">[root@redis-cluster1 reids]# netstat -lnpt</span><br><span class=\"line\">Active Internet connections (only servers)</span><br><span class=\"line\">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class=\"line\">tcp        0      0 192.168.116.111:7000    0.0.0.0:*               LISTEN      16191/src/redis-ser</span><br><span class=\"line\">tcp        0      0 192.168.116.111:7001    0.0.0.0:*               LISTEN      16197/src/redis-ser</span><br><span class=\"line\">tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1137/master</span><br><span class=\"line\">tcp        0      0 192.168.116.111:17000   0.0.0.0:*               LISTEN      16191/src/redis-ser</span><br><span class=\"line\">tcp        0      0 192.168.116.111:17001   0.0.0.0:*               LISTEN      16197/src/redis-ser</span><br></pre></td></tr></table></figure>\n\n<p><strong>创建集群：在其中一个节点操作就可以</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">redis节点搭建起来后，需要完成redis cluster集群搭建，搭建集群过程中，需要保证6个redis实例都是运行状态。</span><br><span class=\"line\">Redis是根据IP和Port的顺序，确定master和slave的，所以要排好序，再执行。</span><br><span class=\"line\"></span><br><span class=\"line\">参数:</span><br><span class=\"line\">--cluster-replicas 1:表示为集群中的每个主节点创建一个从节点.书写流程:主节点ip+port 对应一个从节点ip+port（正常是前面三个节点为主节点，后面的为从节点）</span><br><span class=\"line\"></span><br><span class=\"line\">[root@redis-cluster1 src]# cd /data/redis/src/</span><br><span class=\"line\">[root@redis-cluster1 src]# ./redis-cli --cluster create --cluster-replicas 1 192.168.116.111:7000 192.168.116.111:7001 192.168.116.131:7002 192.168.116.131:7003 192.168.116.132:7004 192.168.116.132:7005</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Can I <span class=\"built_in\">set</span> the above configuration? (<span class=\"built_in\">type</span> <span class=\"string\">&#x27;yes&#x27;</span> to accept): <span class=\"built_in\">yes</span>  <span class=\"comment\">#写yes同意</span></span></span><br></pre></td></tr></table></figure>\n\n<p><strong>查看集群状态可连接集群中的任一节点</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">此处连接了集群中的节点--192.168.116.111</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">登录集群客户端，-c标识以集群方式登录</span></span><br><span class=\"line\">[root@redis-cluster1 src]# ./redis-cli -h 192.168.116.172 -c -p 7000</span><br><span class=\"line\">192.168.116.172:7000&gt; ping</span><br><span class=\"line\">PONG</span><br><span class=\"line\">192.168.116.173:7002&gt; cluster info  #查看集群信息</span><br><span class=\"line\">cluster_state:ok  #集群状态</span><br><span class=\"line\">cluster_slots_assigned:16384 #分配的槽</span><br><span class=\"line\">cluster_slots_ok:16384</span><br><span class=\"line\">cluster_slots_pfail:0</span><br><span class=\"line\">cluster_slots_fail:0</span><br><span class=\"line\">cluster_known_nodes:6 #集群实例数</span><br><span class=\"line\">......</span><br><span class=\"line\"></span><br><span class=\"line\">192.168.116.172:7000&gt; cluster nodes  #查看集群实例</span><br><span class=\"line\"></span><br><span class=\"line\">参数解释：</span><br><span class=\"line\">runid: 该行描述的节点的id。</span><br><span class=\"line\">ip:prot: 该行描述的节点的ip和port</span><br><span class=\"line\">flags: 分隔的标记位，可能的值有：</span><br><span class=\"line\">1.master: 该行描述的节点是master</span><br><span class=\"line\">2.slave: 该行描述的节点是slave</span><br><span class=\"line\">3.fail?:该行描述的节点可能不可用</span><br><span class=\"line\">4.fail:该行描述的节点不可用（故障）</span><br><span class=\"line\">master_runid: 该行描述的节点的master的id,如果本身是master则显示-</span><br><span class=\"line\">ping-sent: 最近一次发送ping的Unix时间戳，0表示未发送过</span><br><span class=\"line\">pong-recv：最近一次收到pong的Unix时间戳，0表示未收到过</span><br><span class=\"line\">config-epoch: 主从切换的次数</span><br><span class=\"line\">link-state: 连接状态，connnected 和 disconnected</span><br><span class=\"line\">hash slot: 该行描述的master中存储的key的hash的范围</span><br></pre></td></tr></table></figure>\n\n<p><strong>查看redis-cluster1，和连通性</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@redis-cluster1 src]# ./redis-cli -h 192.168.116.132 -c -p 7004</span><br><span class=\"line\">192.168.116.132:7004&gt; ping</span><br><span class=\"line\">PONG</span><br><span class=\"line\">192.168.116.132:7004&gt; cluster info</span><br><span class=\"line\">cluster_state:ok</span><br><span class=\"line\">cluster_slots_assigned:16384</span><br><span class=\"line\">cluster_slots_ok:16384</span><br><span class=\"line\">cluster_slots_pfail:0</span><br><span class=\"line\">cluster_slots_fail:0</span><br><span class=\"line\">cluster_known_nodes:6</span><br><span class=\"line\">cluster_size:3</span><br><span class=\"line\">cluster_current_epoch:6</span><br><span class=\"line\">cluster_my_epoch:5</span><br><span class=\"line\">cluster_stats_messages_ping_sent:837</span><br><span class=\"line\">cluster_stats_messages_pong_sent:962</span><br><span class=\"line\">cluster_stats_messages_meet_sent:1</span><br><span class=\"line\">cluster_stats_messages_sent:1800</span><br><span class=\"line\">cluster_stats_messages_ping_received:962</span><br><span class=\"line\">cluster_stats_messages_pong_received:838</span><br><span class=\"line\">cluster_stats_messages_received:1800</span><br><span class=\"line\">192.168.116.132:7004&gt; cluster nodes</span><br><span class=\"line\">e1784e05bc7220db5155e80787b4cc6af12ab0c5 192.168.116.131:7003@17003 slave 462577d2fbc035e6584f9ce7177d9e0df72e3c16 0 1702369829000 1 connected</span><br><span class=\"line\">bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 192.168.116.132:7004@17004 myself,master - 0 1702369827000 5 connected 10923-16383</span><br><span class=\"line\">c81d083a6b36882c955e76ed026b3d90c5ac61eb 192.168.116.131:7002@17002 master - 0 1702369830266 3 connected 5461-10922</span><br><span class=\"line\">462577d2fbc035e6584f9ce7177d9e0df72e3c16 192.168.116.111:7000@17000 master - 0 1702369829262 1 connected 0-5460</span><br><span class=\"line\">4cbe431c64d21483dd004b18207f647145e0c6fb 192.168.116.132:7005@17005 slave c81d083a6b36882c955e76ed026b3d90c5ac61eb 0 1702369830000 3 connected</span><br><span class=\"line\">9c5e3e52773043d74a01b8ebbe7f2b63f56dd8b0 192.168.116.111:7001@17001 slave bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 0 1702369829000 5 connected</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">验证--查看</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">可以数据联通--属于集群操作</span></span><br><span class=\"line\">redis-cluster1</span><br><span class=\"line\">192.168.116.132:7004&gt; set name qingfeng</span><br><span class=\"line\"><span class=\"meta prompt_\">-&gt; </span><span class=\"language-bash\">Redirected to slot [5798] located at 192.168.116.131:7002</span></span><br><span class=\"line\">OK</span><br><span class=\"line\">192.168.116.131:7002&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">redis-cluster3</span><br><span class=\"line\">192.168.116.111:7000&gt; get name</span><br><span class=\"line\"><span class=\"meta prompt_\">-&gt; </span><span class=\"language-bash\">Redirected to slot [5798] located at 192.168.116.131:7002</span></span><br><span class=\"line\">&quot;qingfeng&quot;</span><br><span class=\"line\">192.168.116.131:7002&gt;</span><br></pre></td></tr></table></figure>\n\n<p><strong>主从切换</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">测试：</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1.将节点cluster1的主节点7000端口的redis关掉</span></span><br><span class=\"line\">[root@redis-cluster1 src]# ./redis-cli -h 192.168.116.132 -c -p 7004</span><br><span class=\"line\">192.168.116.132:7004&gt; cluster nodes\t\t#此时查看7000在线</span><br><span class=\"line\">e1784e05bc7220db5155e80787b4cc6af12ab0c5 192.168.116.131:7003@17003 slave 462577d2fb</span><br><span class=\"line\">bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 192.168.116.132:7004@17004 myself,master -</span><br><span class=\"line\">c81d083a6b36882c955e76ed026b3d90c5ac61eb 192.168.116.131:7002@17002 master - 0 17023</span><br><span class=\"line\">462577d2fbc035e6584f9ce7177d9e0df72e3c16 192.168.116.111:7000@17000 master - 0 17023</span><br><span class=\"line\">4cbe431c64d21483dd004b18207f647145e0c6fb 192.168.116.132:7005@17005 slave c81d083a6b</span><br><span class=\"line\">9c5e3e52773043d74a01b8ebbe7f2b63f56dd8b0 192.168.116.111:7001@17001 slave bcbfcc14d0</span><br><span class=\"line\">192.168.116.132:7004&gt; exit</span><br><span class=\"line\">[root@redis-cluster1 src]# ps -ef |grep redis</span><br><span class=\"line\">root      16191      1  0 15:50 ?        00:00:07 src/redis-server 192.168.116.111:7</span><br><span class=\"line\">root      16197      1  0 15:50 ?        00:00:07 src/redis-server 192.168.116.111:7</span><br><span class=\"line\">root      16246   1538  0 16:39 pts/0    00:00:00 grep --color=auto redis</span><br><span class=\"line\">[root@redis-cluster1 src]# kill -9 16191</span><br><span class=\"line\">[root@redis-cluster1 src]# ps -ef |grep redis</span><br><span class=\"line\">root      16197      1  0 15:50 ?        00:00:07 src/redis-server 192.168.116.111:7</span><br><span class=\"line\">root      16248   1538  0 16:39 pts/0    00:00:00 grep --color=auto redis</span><br><span class=\"line\">[root@redis-cluster1 src]# netstat -lnpt\t\t#7000的端口关闭了，看不到</span><br><span class=\"line\">Active Internet connections (only servers)</span><br><span class=\"line\">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class=\"line\">tcp        0      0 192.168.116.111:7001    0.0.0.0:*               LISTEN      16197/src/redis-ser</span><br><span class=\"line\">tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1137/master</span><br><span class=\"line\">tcp        0      0 192.168.116.111:17001   0.0.0.0:*               LISTEN      16197/src/redis-ser</span><br><span class=\"line\">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      938/sshd</span><br><span class=\"line\">tcp6       0      0 ::1:25                  :::*                    LISTEN      1137/master</span><br><span class=\"line\">tcp6       0      0 :::22                   :::*                    LISTEN      938/sshd</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看集群信息：--在132的机器上输入命令查看</span></span><br><span class=\"line\">192.168.116.131:7002&gt; cluster nodes  #此时查看7000显示fail，下线了</span><br><span class=\"line\">c81d083a6b36882c955e76ed026b3d90c5ac61eb 192.168.116.131:7002@17002 myself,master - 0 1702370394000 3 connected 5461-10922</span><br><span class=\"line\">462577d2fbc035e6584f9ce7177d9e0df72e3c16 192.168.116.111:7000@17000 master,fail - 1702370373573 1702370371564 1 disconnected\t\t#显示fail，下线了</span><br><span class=\"line\">e1784e05bc7220db5155e80787b4cc6af12ab0c5 192.168.116.131:7003@17003 master - 0 1702370394653 7 connected 0-5460</span><br><span class=\"line\">4cbe431c64d21483dd004b18207f647145e0c6fb 192.168.116.132:7005@17005 slave c81d083a6b36882c955e76ed026b3d90c5ac61eb 0 1702370395055 3 connected</span><br><span class=\"line\">bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 192.168.116.132:7004@17004 master - 0 1702370395657 5 connected 10923-16383</span><br><span class=\"line\">9c5e3e52773043d74a01b8ebbe7f2b63f56dd8b0 192.168.116.111:7001@17001 slave bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 0 1702370395156 5 connected</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2.将该节点的7000端口redis启动在查看</span></span><br><span class=\"line\">[root@redis-cluster1 src]# cd ..</span><br><span class=\"line\">[root@redis-cluster1 reids]# src/redis-server cluster/7000/redis.conf</span><br><span class=\"line\">[root@redis-cluster1 reids]# netstat -lnpt\t\t#此时7000的端口正常运行</span><br><span class=\"line\">Active Internet connections (only servers)</span><br><span class=\"line\">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class=\"line\">tcp        0      0 192.168.116.111:7000    0.0.0.0:*               LISTEN      16257/src/redis-ser</span><br><span class=\"line\">tcp        0      0 192.168.116.111:7001    0.0.0.0:*               LISTEN      16197/src/redis-ser</span><br><span class=\"line\">tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      1137/master</span><br><span class=\"line\">tcp        0      0 192.168.116.111:17000   0.0.0.0:*               LISTEN      16257/src/redis-ser</span><br><span class=\"line\">tcp        0      0 192.168.116.111:17001   0.0.0.0:*               LISTEN      16197/src/redis-ser</span><br><span class=\"line\">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      938/sshd</span><br><span class=\"line\">tcp6       0      0 ::1:25                  :::*                    LISTEN      1137/master</span><br><span class=\"line\">tcp6       0      0 :::22                   :::*                    LISTEN      938/sshd</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看节点信息：-- 用132的机器查看，此时7000的状态恢复正常，但是变成了从节点</span></span><br><span class=\"line\">192.168.116.131:7002&gt; cluster nodes</span><br><span class=\"line\">c81d083a6b36882c955e76ed026b3d90c5ac61eb 192.168.116.131:7002@17002 myself,master - 0 1702370727000 3 connected 5461-10922</span><br><span class=\"line\">462577d2fbc035e6584f9ce7177d9e0df72e3c16 192.168.116.111:7000@17000 slave e1784e05bc7220db5155e80787b4cc6af12ab0c5 0 1702370728000 7 connected</span><br><span class=\"line\">e1784e05bc7220db5155e80787b4cc6af12ab0c5 192.168.116.131:7003@17003 master - 0 1702370728580 7 connected 0-5460</span><br><span class=\"line\">4cbe431c64d21483dd004b18207f647145e0c6fb 192.168.116.132:7005@17005 slave c81d083a6b36882c955e76ed026b3d90c5ac61eb 0 1702370728000 3 connected</span><br><span class=\"line\">bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 192.168.116.132:7004@17004 master - 0 1702370727000 5 connected 10923-16383</span><br><span class=\"line\">9c5e3e52773043d74a01b8ebbe7f2b63f56dd8b0 192.168.116.111:7001@17001 slave bcbfcc14d0cad0d5d00738cd403a4aee52b446f9 0 1702370728581 5 connected</span><br></pre></td></tr></table></figure>\n\n<p>到此–主从切换完成<br><img src=\"https://xbd666.cn/upload/redis-cluster1.png\" alt=\"image-20231212171231961\"><br><img src=\"https://xbd666.cn/upload/redis-cluster2.png\" alt=\"image-20231212171504750\"></p>\n","categories":["operations"],"tags":["Linux","Redis"]},{"title":"rustdesk远程控制 部署","url":"/2025/11/06/rustdesk%E8%BF%9C%E7%A8%8B%E6%8E%A7%E5%88%B6-%E9%83%A8%E7%BD%B2/","content":"<p><a href=\"https://rustdesk.com/\">rustdesk官网</a></p>\n<h1 id=\"配置rustdesk配置yaml文件\"><a href=\"#配置rustdesk配置yaml文件\" class=\"headerlink\" title=\"配置rustdesk配置yaml文件\"></a>配置rustdesk配置yaml文件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir rustdesk &amp;&amp; cd rustdesk</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim docker-compose.yaml</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">version: &#x27;3&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">services:</span><br><span class=\"line\">  hbbs:</span><br><span class=\"line\">    container_name: hbbs</span><br><span class=\"line\">    image: rustdesk/rustdesk-server:1.0</span><br><span class=\"line\">    command: hbbs</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - ./data:/root</span><br><span class=\"line\">    network_mode: &quot;host&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">    depends_on:</span><br><span class=\"line\">      - hbbr</span><br><span class=\"line\">    restart: unless-stopped</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  hbbr:</span><br><span class=\"line\">    container_name: hbbr</span><br><span class=\"line\">    image: rustdesk/rustdesk-server:1.0</span><br><span class=\"line\">    command: hbbr</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - ./data:/root</span><br><span class=\"line\">    network_mode: &quot;host&quot;</span><br><span class=\"line\">    restart: unless-stopped</span><br></pre></td></tr></table></figure>\n<h1 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker-compose up -d</span><br></pre></td></tr></table></figure>\n<h1 id=\"查看容器有没有起来\"><a href=\"#查看容器有没有起来\" class=\"headerlink\" title=\"查看容器有没有起来\"></a>查看容器有没有起来</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker ps</span><br></pre></td></tr></table></figure>\n<h1 id=\"在官网下载客户端\"><a href=\"#在官网下载客户端\" class=\"headerlink\" title=\"在官网下载客户端\"></a>在官网下载客户端</h1><p><a href=\"https://rustdesk.com/\">rustdesk官网</a></p>\n<h1 id=\"app设置\"><a href=\"#app设置\" class=\"headerlink\" title=\"app设置\"></a>app设置</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">点击左侧3个点---&gt; 点击网络---&gt; 配置ID服务器---&gt; 配置中继服务器</span><br><span class=\"line\"></span><br><span class=\"line\"># 注：ID服务器/中继服务器是你 服务器的IP</span><br></pre></td></tr></table></figure>\n<h1 id=\"连接\"><a href=\"#连接\" class=\"headerlink\" title=\"连接\"></a>连接</h1><p><code>用另一台手机/电脑，就可以连接了</code></p>\n","categories":["operations"],"tags":["Linux","Rustesk"]},{"title":"shell添加用户，计算，vsftp","url":"/2025/11/06/shell%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%EF%BC%8C%E8%AE%A1%E7%AE%97%EF%BC%8Cvsftp/","content":"<p><strong>vim user.sh（添加用户）</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">该脚本为添加用户zhangsan，并给他设置密码</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"built_in\">date</span>：2023-11-14</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">author：xubaodong</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">创建用户</span></span><br><span class=\"line\">useradd zhangsan</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">变量</span></span><br><span class=\"line\">name=zhangsan</span><br><span class=\"line\">echo &quot;qianfeng@123&quot; | passwd --stdin $name &amp;&amp; echo &quot;密码设置完成&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>vim compute.sh（计算）</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">该脚本用于计算</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"built_in\">date</span>：2023-11-14</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">author：xubaodong</span></span><br><span class=\"line\">read -p &quot;请输入第一个数字&quot; num1</span><br><span class=\"line\">read -p &quot;请输入第二个数字&quot; num2</span><br><span class=\"line\">echo $[num1 + num2] &amp;&amp; echo $[num1 - num2] &amp;&amp; echo $[num1 * num2] &amp;&amp; echo $[num1 / num2]</span><br></pre></td></tr></table></figure>\n<p><strong>vsftp_client.sh（客户端）</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">该脚本用于ftp客户端</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"built_in\">date</span>：2023-11-14</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">author：xubaodong</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">关闭防火墙，文件防火墙</span></span><br><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">systemctl disable firewalld</span><br><span class=\"line\">setenforce 0</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">下载vsftp，lftp</span></span><br><span class=\"line\">yum -y install vsftpd</span><br><span class=\"line\">yum -y install lftp</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">给pub满权限</span></span><br><span class=\"line\">chmod 777 /var/ftp/pub</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">启动服务</span></span><br><span class=\"line\">systemctl start vsftpd</span><br><span class=\"line\">systemctl restart vsftpd</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">连接服务端</span></span><br><span class=\"line\">lftp 10.21.162.172</span><br><span class=\"line\">cd /var/ftp/pub</span><br><span class=\"line\">put aaa</span><br></pre></td></tr></table></figure>\n\n\n<p><strong>vsftp_server.sh（服务端）</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">该脚本用于ftp服务端</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"built_in\">date</span>：2023-11-14</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">author：xubaodong</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">关闭防火墙，文件防火墙</span></span><br><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">systemctl disable firewalld</span><br><span class=\"line\">setenforce 0</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">下载vsftp,lftp</span></span><br><span class=\"line\">yum -y install vsftpd</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">下载vsftp，lftp</span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">读写权限追加到配置文件</span></span><br><span class=\"line\">cat &gt;&gt; /etc/vsftpd/vsftpd.conf &lt;&lt; EOF</span><br><span class=\"line\">anon_upload_enable=YES</span><br><span class=\"line\">anon_mkdir_write_enable=YES</span><br><span class=\"line\">EOF</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">给pub满权限</span></span><br><span class=\"line\">chmod 777 /var/ftp/pub</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">启动服务</span></span><br><span class=\"line\">systemctl start vsftpd</span><br><span class=\"line\">systemctl restart vsftpd`</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Shell"]},{"title":"syncTV远程共享视频网站部署","url":"/2025/11/06/syncTV%E8%BF%9C%E7%A8%8B%E5%85%B1%E4%BA%AB%E8%A7%86%E9%A2%91%E7%BD%91%E7%AB%99%E9%83%A8%E7%BD%B2/","content":"<h1 id=\"syncTV远程同步观看web部署\"><a href=\"#syncTV远程同步观看web部署\" class=\"headerlink\" title=\"syncTV远程同步观看web部署\"></a>syncTV远程同步观看web部署</h1><p><a href=\"https://synctv.wiki/#/quickstart?id=docker\">官网地址点这里</a></p>\n<h1 id=\"一、docker安装\"><a href=\"#一、docker安装\" class=\"headerlink\" title=\"一、docker安装\"></a>一、docker安装</h1><p><a href=\"https://docs.docker.com/engine/install/centos/https://docs.docker.com/engine/install/centos/\">docker官网点这里</a></p>\n<h1 id=\"docker一键脚本安装\"><a href=\"#docker一键脚本安装\" class=\"headerlink\" title=\"docker一键脚本安装\"></a>docker一键脚本安装</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/toolbox.sh)</span><br></pre></td></tr></table></figure>\n<h1 id=\"二、可以直接用命令运行synctv，但是建议用下面yaml文件方式运行synctv\"><a href=\"#二、可以直接用命令运行synctv，但是建议用下面yaml文件方式运行synctv\" class=\"headerlink\" title=\"二、可以直接用命令运行synctv，但是建议用下面yaml文件方式运行synctv\"></a>二、可以直接用命令运行synctv，但是建议用下面yaml文件方式运行synctv</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker run --name synctv -d -p 8080:8080 synctvorg/synctv:latest</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"三、创建docker-compose-yaml文件\"><a href=\"#三、创建docker-compose-yaml文件\" class=\"headerlink\" title=\"三、创建docker-compose.yaml文件\"></a>三、创建docker-compose.yaml文件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir synctv &amp;&amp; cd synctv      #创建一个目录，并进入此目录</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim docker-compose.yaml</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">version: &quot;3.3&quot;    #这是docker-compose文件版本的声明</span><br><span class=\"line\">services:</span><br><span class=\"line\"> synctv:       #服务的别名，可以自定义</span><br><span class=\"line\">  container_name: synctv     #容器名，可以自定义</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - &#x27;8080:8080&#x27;   #端口，左侧的8080可以自定义，映射到容器内部，右侧是容器内部端口</span><br><span class=\"line\">  environment:</span><br><span class=\"line\">  - PUID=0    # 用户ID，在终端输入id可以查看到当前用户的id</span><br><span class=\"line\">  - PGID=0    # 组ID同上</span><br><span class=\"line\">  - TZ=Asia/Shanghai   # 时区，可以自定义</span><br><span class=\"line\">  restart: always      # 开启自启动其他选项看以下备注</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - &#x27;./data:/root/.synctv&#x27;   # 数据持久目录映射</span><br><span class=\"line\">  image: synctvorg/synctv    # 镜像名，一般都是使用的哪个镜像就写哪个镜像</span><br></pre></td></tr></table></figure>\n<h1 id=\"查看容器有没有起来\"><a href=\"#查看容器有没有起来\" class=\"headerlink\" title=\"查看容器有没有起来\"></a>查看容器有没有起来</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">docker ps</span><br><span class=\"line\">或</span><br><span class=\"line\">docker-compose ps</span><br></pre></td></tr></table></figure>\n<h1 id=\"默认账户密码\"><a href=\"#默认账户密码\" class=\"headerlink\" title=\"默认账户密码\"></a>默认账户密码</h1><p><code>账户：root 密码：root</code></p>\n<h1 id=\"四、网站更新\"><a href=\"#四、网站更新\" class=\"headerlink\" title=\"四、网站更新\"></a>四、网站更新</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd synctv    # 进入目录</span><br><span class=\"line\">docker-compose down     # 停止容器</span><br><span class=\"line\">docker-compose pull     # 拉取最新镜像</span><br><span class=\"line\">docekr-compose up -d    # 重新启动容器</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","SyncTV"]},{"title":"zabbix-proxy配置及邮件配置","url":"/2025/11/06/zabbix-proxy%E9%85%8D%E7%BD%AE%E5%8F%8A%E9%82%AE%E4%BB%B6%E9%85%8D%E7%BD%AE/","content":"<h1 id=\"一、下载配置server，agent端\"><a href=\"#一、下载配置server，agent端\" class=\"headerlink\" title=\"一、下载配置server，agent端\"></a>一、下载配置server，agent端</h1><h1 id=\"下载zabbix-server，server客户端\"><a href=\"#下载zabbix-server，server客户端\" class=\"headerlink\" title=\"下载zabbix-server，server客户端\"></a>下载zabbix-server，server客户端</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">备注：zabbix源不能和epel源同时存在，要给epel源注释了</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">更新下载zabbix源</span></span><br><span class=\"line\">[root@zabbix-server ~]# rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">更新yum仓库</span></span><br><span class=\"line\">[root@zabbix-server ~]# yum clean all</span><br><span class=\"line\">[root@zabbix-server ~]# yum repolist</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装</span></span><br><span class=\"line\">安装 zabbix rpm 源,鉴于国内网络情况，使用阿里云 zabbix 源</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">更换源</span></span><br><span class=\"line\">[root@zabbix-server ~]# sed -i &#x27;s#http://repo.zabbix.com#https://mirrors.aliyun.com/zabbix#&#x27; /etc/yum.repos.d/zabbix.repo</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">下载软件包--用的时5.0版本的</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">如果有冲突用  yum -y remove `rpm -qa zabbix6.0*`</span> </span><br><span class=\"line\">[root@zabbix-server ~]# yum install zabbix-server-mysql zabbix-web-mysql zabbix-agent -y</span><br><span class=\"line\">[root@zabbix-server ~]# yum install -y zabbix-get.x86_64  #安装zabbix命令工具</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装数据库\"><a href=\"#安装数据库\" class=\"headerlink\" title=\"安装数据库\"></a>安装数据库</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1、安装数据库</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装 mariadb.repo</span></span><br><span class=\"line\">[root@zabbix-server ~]# yum install -y mariadb mariadb-server</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2、启动数据库</span></span><br><span class=\"line\">[root@zabbix-server ~]# systemctl restart mariadb</span><br><span class=\"line\">[root@zabbix-server ~]# systemctl enable mariadb</span><br><span class=\"line\">[root@zabbix-server ~]# mysqladmin -u root password &#x27;zabbix&#x27;    #设置root密码</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3、创建数据库并授权账号</span></span><br><span class=\"line\">[root@zabbix-server ~]# mysql -uroot -p&#x27;zabbix&#x27;</span><br><span class=\"line\">MariaDB [(none)]&gt; create database zabbix character set utf8 collate utf8_bin;  # 创建zabbix数据库</span><br><span class=\"line\">MriaDB [(none)]&gt; grant all privileges on zabbix.* to &#x27;zabbix&#x27;@&#x27;localhost&#x27; identified by &#x27;zabbix&#x27;;\t\t\t\t\t\t\t\t\t\t# 注意授权网段</span><br><span class=\"line\">MariaDB [(none)]&gt; flush privileges;           # 刷新授权</span><br><span class=\"line\">MariaDB [(none)]&gt; \\q   #退出</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">4、导入数据</span></span><br><span class=\"line\">[root@zabbix-server ~]# zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uzabbix -p zabbix</span><br><span class=\"line\">Enter password:                   #输入密码</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置-server-端\"><a href=\"#配置-server-端\" class=\"headerlink\" title=\"配置 server 端\"></a>配置 server 端</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@zabbix-server ~]# cd /etc/zabbix/</span><br><span class=\"line\">[root@zabbix-server zabbix]# ls</span><br><span class=\"line\">web  zabbix_agentd.conf  zabbix_agentd.d  zabbix_server.conf</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">为了方便我们以后恢复，我们把配置文件备份一下</span></span><br><span class=\"line\">[root@zabbix-server zabbix]# cp zabbix_server.conf zabbix_server.conf.bak</span><br><span class=\"line\">[root@zabbix-server zabbix]# vim zabbix_server.conf</span><br><span class=\"line\"> DBHost=localhost            #数据库对外的主机</span><br><span class=\"line\"> DBName=zabbix               #数据库名称</span><br><span class=\"line\"> DBUser=zabbix               #数据库用户</span><br><span class=\"line\"> DBPassword=zabbix           #数据库密码</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"> # </span><span class=\"language-bash\">启动zabbix-server</span></span><br><span class=\"line\"> [root@zabbix-server zabbix]# systemctl start zabbix-server</span><br><span class=\"line\">[root@zabbix-server zabbix]# systemctl enable zabbix-server</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">验证10051端口有没有起来</span></span><br><span class=\"line\">[root@zabbix-server zabbix]# netstat -lntp | grep 10051</span><br><span class=\"line\">tcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN      1574/zabbix_server  </span><br><span class=\"line\">tcp6       0      0 :::10051                :::*                    LISTEN      1574/zabbix_server</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置 web GUI</span></span><br><span class=\"line\">1.启用zabbix前端源，修改vim /etc/yum.repos.d/zabbix.repo，将[zabbix-frontend]下的 enabled 改为 1</span><br><span class=\"line\">[root@zabbix-server zabbix]# vim /etc/yum.repos.d/zabbix.repo</span><br><span class=\"line\">[zabbix-frontend]     #修改第二个【frontend】</span><br><span class=\"line\">...</span><br><span class=\"line\">enabled=1    #改为1</span><br><span class=\"line\">gpgcheck=0   #改为0</span><br><span class=\"line\">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-ZABBIX-A14FE591</span><br><span class=\"line\">...</span><br><span class=\"line\">gpg--》都改成0</span><br><span class=\"line\"></span><br><span class=\"line\">2.安装 Software Collections，便于后续安装高版本的 php，默认 yum 安装的 php 版本为 5.4 过低</span><br><span class=\"line\">[root@zabbix-server zabbix]# yum install centos-release-scl -y</span><br><span class=\"line\">3.安装 zabbix 前端和相关环境</span><br><span class=\"line\">[root@zabbix-server zabbix]# yum install zabbix-web-mysql-scl zabbix-apache-conf-scl -y</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">为Zabbix前端配置PHP</span></span><br><span class=\"line\">[root@zabbix-server ~]# vim /etc/opt/rh/rh-php72/php-fpm.d/zabbix.conf   #设置时区</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">里面基本不用动。只需要添加一行时区即可</span></span><br><span class=\"line\">php_value[date.timezone] = Asia/Shanghai       ---添加如下</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动`httpd`服务</span></span><br><span class=\"line\">[root@zabbix-server ~]# systemctl restart zabbix-server zabbix-agent httpd rh-php72-php-fpm</span><br><span class=\"line\">[root@zabbix-server ~]# systemctl enable zabbix-server zabbix-agent httpd rh-php72-php-fpm</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"验证：打开游览器访问\"><a href=\"#验证：打开游览器访问\" class=\"headerlink\" title=\"验证：打开游览器访问\"></a>验证：打开游览器访问</h1><p><code>192.168.246.228/zabbix</code>，第一次访问时需要进行一些初始化的设置</p>\n<h1 id=\"初始账户及密码\"><a href=\"#初始账户及密码\" class=\"headerlink\" title=\"初始账户及密码\"></a>初始账户及密码</h1><p><code>user=Admin</code><br><code>password=zabbix</code></p>\n<h1 id=\"配置agent端\"><a href=\"#配置agent端\" class=\"headerlink\" title=\"配置agent端\"></a>配置agent端</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">agent端可以是多台</span></span><br><span class=\"line\">[root@zabbix-node1 ~]# rpm -Uvh https://repo.zabbix.com/zabbix/5.0/rhel/7/x86_64/zabbix-release-5.0-1.el7.noarch.rpm</span><br><span class=\"line\">[root@zabbix-node1 ~]# yum install zabbix-agent zabbix-sender -y</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">备份配置文件</span></span><br><span class=\"line\">[root@zabbix-node1 ~]# cd /etc/zabbix/</span><br><span class=\"line\">[root@zabbix-node1 zabbix]# ls</span><br><span class=\"line\">zabbix_agentd.conf  zabbix_agentd.d</span><br><span class=\"line\">[root@zabbix-node1 zabbix]# cp zabbix_agentd.conf&#123;,.bak&#125;</span><br><span class=\"line\">[root@zabbix-node1 zabbix]# ls</span><br><span class=\"line\">zabbix_agentd.conf  zabbix_agentd.conf.bak  zabbix_agentd.d</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改配置文件</span></span><br><span class=\"line\">[root@zabbix-node1 zabbix]# vim zabbix_agentd.conf   ----修改如下</span><br><span class=\"line\">Server=192.168.246.228 zabbix服务器的地址 </span><br><span class=\"line\">ServerActive=192.168.246.228 主动模式 zabbix-server-ip </span><br><span class=\"line\">Hostname=zabbix-node1 </span><br><span class=\"line\">UnsafeUserParameters=1 是否限制用户自定义 keys 使用特殊字符 1是可以启用特殊字符 0是不可以启用特殊字符，是否允许别人执行远程操作命令，默认是禁用的，打开的话会有安全风险.</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动agent服务</span></span><br><span class=\"line\">[root@zabbix-node1 zabbix]# systemctl start zabbix-agent</span><br><span class=\"line\">[root@zabbix-node1 zabbix]# systemctl enable zabbix-agent</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">验证10050端口有没有起来</span></span><br><span class=\"line\">[root@zabbix-node1 zabbix]# netstat -lntp | grep 10050</span><br><span class=\"line\">tcp        0      0 0.0.0.0:10050           0.0.0.0:*               LISTEN      9000/zabbix_agentd  </span><br><span class=\"line\">tcp6       0      0 :::10050                :::*                    LISTEN      9000/zabbix_agentd</span><br></pre></td></tr></table></figure>\n\n<p><code>配置完成，此时可以在网址上做配置设置了</code></p>\n<h1 id=\"修改语言–中文版\"><a href=\"#修改语言–中文版\" class=\"headerlink\" title=\"修改语言–中文版\"></a>修改语言–中文版</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">点开Administration--&gt;Users--&gt;Admin--&gt;Language(选择chinese)</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">现在界面是中文版的了</span></span><br></pre></td></tr></table></figure>\n<h1 id=\"修改监控项字体\"><a href=\"#修改监控项字体\" class=\"headerlink\" title=\"修改监控项字体\"></a>修改监控项字体</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@zabbix-server ~]# cd /usr/share/zabbix/assets/fonts/</span><br><span class=\"line\">[root@zabbix-server fonts]# ls</span><br><span class=\"line\">graphfont.ttf</span><br><span class=\"line\">[root@zabbix-server fonts]# mv graphfont.ttf graphfont.ttf.bak</span><br><span class=\"line\">将本机上的simkai.ttf下载好，传到linunx</span><br><span class=\"line\">[root@zabbix-server fonts]# ls</span><br><span class=\"line\">graphfont.ttf.bak  simkai.ttf</span><br><span class=\"line\">[root@zabbix-server fonts]# mv simkai.ttf graphfont.ttf</span><br><span class=\"line\">[root@zabbix-server fonts]# ls</span><br><span class=\"line\">graphfont.ttf  graphfont.ttf.bak</span><br><span class=\"line\">这个时候监控项里面的字体就已经改好了</span><br></pre></td></tr></table></figure>\n<h1 id=\"界面创建流程\"><a href=\"#界面创建流程\" class=\"headerlink\" title=\"界面创建流程\"></a>界面创建流程</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">监控方面，先创建一个主机（host），在创建一个监控项(item)用于采集数据。告警方面，在监控项里创建触发器（trigger），通过触发器（trigger）来触发告警动作（action）</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"二、自定义key\"><a href=\"#二、自定义key\" class=\"headerlink\" title=\"二、自定义key\"></a>二、自定义key</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改配置文件，把查找参数的命令设为用户参数</span></span><br><span class=\"line\">[root@zabbix-node1 ~]# cd /etc/zabbix/zabbix_agentd.d/</span><br><span class=\"line\">[root@zabbix-node1 zabbix_agentd.d]# vim memory_usage.conf</span><br><span class=\"line\">UserParameter=memory.used,free | awk &#x27;/^Mem/&#123;print $3&#125;&#x27;</span><br><span class=\"line\">UserParameter=定义的key，查看的命令语句</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启agent服务</span></span><br><span class=\"line\">[root@zabbix-node1 zabbix_agentd.d]# systemctl restart zabbix-agent.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在zabbix-server 端，查询验证</span></span><br><span class=\"line\">[root@zabbix-server fonts]# zabbix_get -s 192.168.246.226 -p 10050 -k &quot;memory.used&quot;</span><br><span class=\"line\">如果可以验证到结果，就可以到web界面去设置参数，启动监控了</span><br></pre></td></tr></table></figure>\n<p><code>web界面先在设置里创建主机组--模板--创建主机----配置应用集--监控项--设置自定义监控项</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">也可以指定参数--传参</span></span><br><span class=\"line\">[root@zabbix-node1 ~]# cd /etc/zabbix/zabbix_agentd.d/</span><br><span class=\"line\">[root@zabbix-node1 zabbix_agentd.d]# vim memory_usage.conf</span><br><span class=\"line\">UserParameter=memory.stats[*],cat /proc/meminfo | awk &#x27;/^$1/&#123;print $$2&#125;&#x27;     --添加到文件中注意去掉反斜杠</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启agent服务</span></span><br><span class=\"line\">[root@zabbix-node1 zabbix_agentd.d]# systemctl restart zabbix-agent.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在zabbix-server 端，查询使用这个用户参数的key</span></span><br><span class=\"line\">传参:</span><br><span class=\"line\">[root@zabbix-server fonts]# zabbix_get -s 192.168.246.226 -p 10050 -k &quot;memory.stats[MemTotal]&quot;</span><br><span class=\"line\">999696</span><br><span class=\"line\">[root@zabbix-server fonts]# zabbix_get -s 192.168.246.226 -p 10050 -k &quot;memory.stats[Cache]&quot;</span><br><span class=\"line\">243832</span><br><span class=\"line\">[root@zabbix-server fonts]# zabbix_get -s 192.168.246.226 -p 10050 -k &quot;memory.stats[Buffer]&quot;</span><br><span class=\"line\">2108</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"三、网络发现-自动发现\"><a href=\"#三、网络发现-自动发现\" class=\"headerlink\" title=\"三、网络发现(自动发现)\"></a>三、网络发现(自动发现)</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装agent 段的包</span></span><br><span class=\"line\">[root@zabbix-node2 ~]# yum -y install zabbix-agent zabbix-sender</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">设置agent 配置，可以把之前设置好的node1的配置传过来</span></span><br><span class=\"line\">[root@zabbix-node2 ~]# vim /etc/zabbix/zabbix_agentd.conf</span><br><span class=\"line\">Hostname=zabbix-node2 #只需修改hostname</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">visudo赋予权限</span></span><br><span class=\"line\">[root@zabbix-node2 ~]# visudo       #修改sudo的配置,添加如下信息</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Defaults !visiblepw</span></span><br><span class=\"line\"></span><br><span class=\"line\">93 zabbix ALL=(ALL) NOPASSWD: ALL</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动服务</span></span><br><span class=\"line\">[root@zabbix-node2 ~]# systemctl start zabbix-agent</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在server端验证</span></span><br><span class=\"line\">[root@zabbix-server ~]# zabbix_get -s 192.168.246.227 -p 10050 -k &quot;system.hostname&quot;</span><br><span class=\"line\">zabbix-agent-none2</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">到web网址界面操作</span></span><br><span class=\"line\">配置--自动发现--自动发现规则--。。。</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"四、zabbix-proxy分布式监控\"><a href=\"#四、zabbix-proxy分布式监控\" class=\"headerlink\" title=\"四、zabbix-proxy分布式监控\"></a>四、zabbix-proxy分布式监控</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">需要对时，保证两台机器的时间一致</span></span><br><span class=\"line\">- ntpdate 192.168.198.156 制作时间服务器</span><br><span class=\"line\">[root@zabbix-server ~]# yum install -y ntp</span><br><span class=\"line\">[root@zabbix-server ~]# vim /etc/ntp.conf  #有4行server的位置，把那4行server行注释掉，填写以下两行</span><br><span class=\"line\">server 127.127.1.0 # local clock</span><br><span class=\"line\">fudge  127.127.1.0 stratum 10</span><br><span class=\"line\">[root@zabbix-server ~]#  systemctl start ntpd</span><br><span class=\"line\">[root@zabbix-server ~]#  systemctl enable ntpd</span><br><span class=\"line\">同步时间</span><br><span class=\"line\">[root@zabbix-proxy ~]# yum install -y ntpdate</span><br><span class=\"line\">[root@zabbix-proxy ~]# ntpdate 192.168.198.156</span><br><span class=\"line\"></span><br><span class=\"line\">[root@zabbix-node2 ~]# yum install -y ntpdate</span><br><span class=\"line\">[root@zabbix-node2 ~]# ntpdate 192.168.198.156</span><br><span class=\"line\"></span><br><span class=\"line\">- 关闭防火墙，selinux</span><br><span class=\"line\">- 设置主机名 hostnamectl set-hostname zabbix-proxy</span><br><span class=\"line\">[root@localhost ~]# hostnamectl set-hostname zabbix-proxy</span><br><span class=\"line\"></span><br><span class=\"line\">- vim /etc/hosts 每个机器都设置hosts，以解析主机名；</span><br><span class=\"line\">监控端</span><br><span class=\"line\">[root@zabbix-server ~]# cat /etc/hosts</span><br><span class=\"line\">192.168.198.156 zabbix-server</span><br><span class=\"line\">192.168.198.158 zabbix-node2</span><br><span class=\"line\">192.168.198.159 zabbix-proxy</span><br><span class=\"line\"></span><br><span class=\"line\">代理端</span><br><span class=\"line\">[root@zabbix-proxy ~]# cat /etc/hosts</span><br><span class=\"line\">192.168.198.156 zabbix-server</span><br><span class=\"line\">192.168.198.158 zabbix-node2</span><br><span class=\"line\">192.168.198.159 zabbix-proxy</span><br><span class=\"line\"></span><br><span class=\"line\">被监控端</span><br><span class=\"line\">[root@zabbix-node2 ~]# cat /etc/hosts</span><br><span class=\"line\">192.168.198.156 zabbix-server</span><br><span class=\"line\">192.168.198.158 zabbix-node2</span><br><span class=\"line\">192.168.198.159 zabbix-proxy</span><br><span class=\"line\"></span><br><span class=\"line\">| 机器名称      | IP配置          | 服务角色  |</span><br><span class=\"line\">| ------------- | --------------- | --------- |</span><br><span class=\"line\">| zabbix-server | 192.168.198.156 | 监控      |</span><br><span class=\"line\">| zabbix-node1  | 192.168.198.157 | 被监控端  |</span><br><span class=\"line\">| zabbix-node2  | 192.168.198.158 | 被监控端  |</span><br><span class=\"line\">| zabbix-proxy  | 192.168.198.159 | 代理proxy |</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在 zabbix-proxy 上配置 mysql</span></span><br><span class=\"line\">[root@zabbix-proxy ~]# yum install -y mariadb mariadb-server</span><br><span class=\"line\">[root@zabbix-proxy ~]# systemctl start mariadb</span><br><span class=\"line\">[root@zabbix-proxy ~]# mysqladmin -uroot password &#x27;zabbix&#x27;</span><br><span class=\"line\">[root@zabbix-proxy ~]# mysql -uroot -p&#x27;zabbix&#x27;</span><br><span class=\"line\">MariaDB [(none)]&gt; create database proxydb character set &#x27;utf8&#x27;;</span><br><span class=\"line\">MariaDB [(none)]&gt; grant all on proxydb.* to &#x27;proxy&#x27;@&#x27;localhost&#x27; identified by &#x27;zabbix&#x27;;</span><br><span class=\"line\">MariaDB [(none)]&gt; flush privileges;</span><br><span class=\"line\">MariaDB [(none)]&gt; \\q</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在 zabbix-proxy上下载zabbix 相关的包，主要是代理proxy的包</span></span><br><span class=\"line\">[root@zabbix-server ~]# scp /etc/yum.repos.d/zabbix.repo 192.168.198.159:/etc/yum.repos.d/</span><br><span class=\"line\">编辑zabbix.repo源将里面的gpgcheck关闭</span><br><span class=\"line\">[root@zabbix-proxy ~]# yum -y install zabbix-proxy-mysql zabbix-get zabbix-agent zabbix-sender</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">将zabbix-proxy-mysql包里面的数据导入数据库中</span></span><br><span class=\"line\">[root@zabbix-proxy ~]# cp /usr/share/doc/zabbix-proxy-mysql-5.0.3（版本号）/schema.sql.gz ./</span><br><span class=\"line\">[root@zabbix-proxy ~]# ls</span><br><span class=\"line\">anaconda-ks.cfg  schema.sql.gz</span><br><span class=\"line\">[root@zabbix-proxy ~]# gzip -d schema.sql.gz </span><br><span class=\"line\">[root@zabbix-proxy ~]# ls</span><br><span class=\"line\">anaconda-ks.cfg  schema.sql</span><br><span class=\"line\">[root@zabbix-proxy ~]# mysql -uroot -p proxydb &lt; schema.sql </span><br><span class=\"line\">Enter password:</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置proxy端</span></span><br><span class=\"line\">[root@zabbix-proxy ~]# vim /etc/zabbix/zabbix_proxy.conf</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">proxyMode=0  <span class=\"comment\">#默认是主动模式（0是主动模式，1是被动模式）</span></span></span><br><span class=\"line\">Server=192.168.198.156        # server端 的IP</span><br><span class=\"line\">ServerPort=10051             # server端 的端口</span><br><span class=\"line\"></span><br><span class=\"line\">Hostname=zabbix-proxy        # 主机名</span><br><span class=\"line\">ListenPort=10051             # proxy自己的监听端口</span><br><span class=\"line\">EnableRemoteCommands=1       # 允许远程命令</span><br><span class=\"line\">LogRemoteCommands=1          # 记录远程命令的日志</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">数据的配置</span></span><br><span class=\"line\">DBHost=localhost</span><br><span class=\"line\">DBName=proxydb</span><br><span class=\"line\">DBUser=proxy</span><br><span class=\"line\">DBPassword=zabbix</span><br><span class=\"line\"></span><br><span class=\"line\">ConfigFrequency=30      # 多长时间，去服务端拖一次有自己监控的操作配置；为了实验更快的生效，这里设置30秒，默认3600s</span><br><span class=\"line\">DataSenderFrequency=1   # 每一秒向server 端发一次数据，发送频度</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">启动proxy服务</span></span><br><span class=\"line\">[root@zabbix-proxy ~]# systemctl start zabbix-proxy</span><br><span class=\"line\"></span><br><span class=\"line\">[root@zabbix-proxy ~]# netstat -lntp | grep 10051</span><br><span class=\"line\">tcp        0      0 0.0.0.0:10051           0.0.0.0:*               LISTEN      15798/zabbix_proxy  </span><br><span class=\"line\">tcp6       0      0 :::10051                :::*                    LISTEN      15798/zabbix_proxy</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置agent端允许proxy代理监控</span></span><br><span class=\"line\">[root@zabbix-agent ~]#  vim /etc/zabbix/zabbix_agentd.conf---添加proxy的ip地址</span><br><span class=\"line\">Server=192.168.198.156,192.168.198.159</span><br><span class=\"line\">ServerActive=192.168.198.156,192.168.198.159</span><br><span class=\"line\">Hostname=zabbix-node2</span><br><span class=\"line\">[root@zabbix-agent ~]#  systemctl restart zabbix-agent #启动服务</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在web网址上配置</span></span><br><span class=\"line\">管理--agent代理程序--agent代理程序（要与配置文件中应以的一样）--添加--配置--主机--选好主机名称--已启用那里打开zabbix proxy</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"五、配置发送邮件\"><a href=\"#五、配置发送邮件\" class=\"headerlink\" title=\"五、配置发送邮件\"></a>五、配置发送邮件</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\">#server服务器端</span></span></span><br><span class=\"line\">安装MUA软件：mailx</span><br><span class=\"line\">[root@zabbix-server ~]#  yum install mailx -y</span><br><span class=\"line\">[root@zabbix-server ~]# mailx -V </span><br><span class=\"line\">12.5 7/5/10</span><br><span class=\"line\">注：使用新的方式--利用公网邮件服务器发送报警，需要关闭postfix服务</span><br><span class=\"line\">[root@zabbix-server ~]# systemctl stop postfix</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置公网邮箱信息：</span></span><br><span class=\"line\">[root@zabbix-server ~]# vim /etc/mail.rc  ---在最后添加如下：</span><br><span class=\"line\">set from=12345678@163.com（邮箱地址） </span><br><span class=\"line\"> set smtp=smtp.163.com（smtp服务器） </span><br><span class=\"line\"> set smtp-auth-user=12345678@163.com(用户名) </span><br><span class=\"line\"> set smtp-auth-password=qf123456（这里是邮箱的授权密码） </span><br><span class=\"line\"> set smtp-auth=login</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\"> # </span><span class=\"language-bash\">阿里云服务器--需要配置证书</span></span><br><span class=\"line\"><span class=\"meta prompt_\"> # </span><span class=\"language-bash\">一、请求数字证书</span></span><br><span class=\"line\">mkdir -p /root/.certs/ ####创建目录，用来存放证书</span><br><span class=\"line\">echo -n | openssl s_client -connect smtp.163.com:465 | sed -ne &#x27;/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p&#x27; &gt; ~/.certs/163.crt ####向163请求证书</span><br><span class=\"line\">certutil -A -n &quot;GeoTrust SSL CA&quot; -t &quot;C,,&quot; -d ~/.certs -i ~/.certs/163.crt ####添加一个SSL证书到证书数据库中</span><br><span class=\"line\">certutil -A -n &quot;GeoTrust Global CA&quot; -t &quot;C,,&quot; -d ~/.certs -i ~/.certs/163.crt ####添加一个Global 证书到证书数据库中</span><br><span class=\"line\">certutil -L -d /root/.certs ####列出目录下证书</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">二、配置发件人</span></span><br><span class=\"line\">[root@zabbix-server ~]# vim /etc/mail.rc  ---在最后添加如下：</span><br><span class=\"line\">set bsdcompat</span><br><span class=\"line\">set from=xxxxxx@163.com</span><br><span class=\"line\">set smtp=smtps://smtp.163.com:465</span><br><span class=\"line\">set smtp-auth-user=xxxxxx@163.com</span><br><span class=\"line\">set smtp-auth-password=xxxxxxx #此密码为第三方登录密码</span><br><span class=\"line\">set smtp-auth=login</span><br><span class=\"line\">set ssl-verify=ignore</span><br><span class=\"line\">set nss-config-dir=/root/.certs</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">三、测试</span></span><br><span class=\"line\">echo “test” | mail -s “zabbix” xxxxxxx@qq.com</span><br><span class=\"line\">登陆收件人邮箱查看</span><br><span class=\"line\">看似成功但是linux中报错：证书不被信任</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">四、解决最后一个问题-----证书不被信任</span></span><br><span class=\"line\">cd /root/.certs/</span><br><span class=\"line\">certutil -A -n &quot;GeoTrust SSL CA - G3&quot; -t &quot;Pu,Pu,Pu&quot; -d ./ -i 163.crt</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">成功标志：</span></span><br><span class=\"line\">Notice: Trust flag u is set automatically if the private key is present.</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># 发送邮箱方式</span></span></span><br><span class=\"line\">方式1：echo &quot;正文内容&quot; | mailx -s &quot;邮件标题&quot; 收件箱Email</span><br><span class=\"line\">方式2：mailx -s &quot;邮件标题&quot; 收件箱Email，回车按CTRL+D发送</span><br><span class=\"line\">参数：</span><br><span class=\"line\">-v ：显示发送的详细信息</span><br><span class=\"line\"></span><br><span class=\"line\">手动发送邮件测试：</span><br><span class=\"line\">[root@zabbix-server ~]# mailx -v -s &#x27;hello&#x27; &#x27;zhangsan@163.com&#x27;</span><br><span class=\"line\">手写邮件内容 （回车，然后ctrl+D正常结束)</span><br><span class=\"line\">[root@zabbix-server ~]# mailx -v -s &#x27;hello&#x27; &#x27;zhangsan@163.com&#x27;</span><br><span class=\"line\">nihao</span><br><span class=\"line\">EOT</span><br><span class=\"line\">Resolving host smtp.163.com . . . done.</span><br><span class=\"line\">Connecting to 123.126.97.2:smtp . . . connected.</span><br><span class=\"line\">220 163.com Anti-spam GT for Coremail System (163com[20141201])</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">&gt;&gt; EHLO zabbix-server</span></span><br><span class=\"line\">250-mail</span><br><span class=\"line\">250-PIPELINING</span><br><span class=\"line\">250-AUTH LOGIN PLAIN </span><br><span class=\"line\">250-AUTH=LOGIN PLAIN</span><br><span class=\"line\">250-coremail 1Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2UFeF38eUCa0xDrUUUUj</span><br><span class=\"line\">250-STARTTLS</span><br><span class=\"line\">250 8BITMIME</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">&gt;&gt; AUTH LOGIN</span></span><br><span class=\"line\">334 dXNlcm5hbWU6</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">&gt;&gt; bHd4MTgzNjYwMTkzNTZAMTYzLmNvbQ==</span></span><br><span class=\"line\">334 UGFzc3dvcmQ6</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">&gt;&gt; bHd4MTgzNjYwMTkzNTY=</span></span><br><span class=\"line\">235 Authentication successful</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">&gt;&gt; MAIL FROM:&lt;lwx18366019356@163.com&gt;</span></span><br><span class=\"line\">250 Mail OK</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">&gt;&gt; RCPT TO:&lt;lwx18366019356@163.com&gt;</span></span><br><span class=\"line\">250 Mail OK</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">&gt;&gt; DATA</span></span><br><span class=\"line\">354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">&gt;&gt; .</span></span><br><span class=\"line\">250 Mail OK queued as smtp2,GtxpCgDXkqTEFERdskSAAA--.825S2 1564742867</span><br><span class=\"line\"><span class=\"meta prompt_\">&gt;</span><span class=\"language-bash\">&gt;&gt; QUIT</span></span><br><span class=\"line\">221 Bye</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">此时终端配置完成，在web网址上操作</span></span><br><span class=\"line\">配置 zabbix 的邮件报警功能需要以下三个角色的参与</span><br><span class=\"line\">注：脚本名称任意，存放于/usr/lib/zabbix/alertscripts ----路径可以改</span><br><span class=\"line\"></span><br><span class=\"line\">名称：sendmail                   //名称任意</span><br><span class=\"line\">类型：脚本</span><br><span class=\"line\">脚本名称：sendmail.sh      </span><br><span class=\"line\">脚本参数：                          //一定要写，否则可能发送不成功</span><br><span class=\"line\">    &#123;ALERT.SENDTO&#125;              //照填，收件人变量</span><br><span class=\"line\">    &#123;ALERT.SUBJECT&#125;             //照填，邮件主题变量，变量值来源于‘动作’中的‘默认接收人’</span><br><span class=\"line\">    &#123;ALERT.MESSAGE&#125;           //照填，邮件正文变量，变量值来源于‘动作’中的‘默认信息’</span><br><span class=\"line\"></span><br><span class=\"line\">配置完成后,不要忘记点击存档,保存你的配置。       </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">步骤</span></span><br><span class=\"line\">管理--报警媒介类型--名称（邮件报警）--类型（脚本）--脚本名字（要和终端上脚本名称的一致）--脚本参数（3个，上面模板）--添加</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改zabbix服务端配置文件＆编写脚本：指定脚本的存储路径:</span></span><br><span class=\"line\">[root@zabbix-server ~]# vim /etc/zabbix/zabbix_server.conf</span><br><span class=\"line\">AlertScriptsPath=/usr/lib/zabbix/alertscripts  #打开注释，核对路径，也可以修改路径</span><br><span class=\"line\"></span><br><span class=\"line\">`编写邮件脚本:`</span><br><span class=\"line\">[root@zabbix-server ~]# cd /usr/lib/zabbix/alertscripts/</span><br><span class=\"line\">[root@zabbix-server alertscripts]# vim sendmail.sh   </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/sh</span> </span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">export.UTF-8</span></span><br><span class=\"line\">echo &quot;$3&quot; | sed s/&#x27;\\r&#x27;//g | mailx -s &quot;$2&quot; $1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">$</span><span class=\"language-bash\">1:接受者的邮箱地址：sendto</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$</span><span class=\"language-bash\">2:邮件的主题：subject</span></span><br><span class=\"line\"><span class=\"meta prompt_\">$</span><span class=\"language-bash\">3:邮件内容：message</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改权限 及更用户和组：</span></span><br><span class=\"line\">[root@zabbix-server alertscripts]# chmod u+x sendmail.sh &amp;&amp; chown zabbix.zabbix sendmail.sh</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">返回web界面操作</span></span><br><span class=\"line\">管理--用户--Admin--报警媒介--添加类型（邮件报警）--填写收件人--点击更新------触发器（填写名称，严重性，表达式）--点添加------动作--点触发动作--填写名称--触发条件（触发器）--点操作--选择时间--标题及内容（填写西面的模板）</span><br><span class=\"line\"></span><br><span class=\"line\">默认信息：邮件的主题</span><br><span class=\"line\"></span><br><span class=\"line\">Problem:&#123;TRIGGER.NAME&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">故障恢复: &#123;TRIGGER.NAME&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">主机: &#123;HOST.NAME1&#125;</span><br><span class=\"line\">时间: &#123;EVENT.DATE&#125; &#123;EVENT.TIME&#125;</span><br><span class=\"line\">级别: &#123;TRIGGER.SEVERITY&#125;</span><br><span class=\"line\">触发: &#123;TRIGGER.NAME&#125;</span><br><span class=\"line\">详情: &#123;ITEM.NAME1&#125;:&#123;ITEM.KEY1&#125;:&#123;ITEM.VALUE1&#125;</span><br><span class=\"line\">状态: &#123;TRIGGER.STATUS&#125;</span><br><span class=\"line\">项目：&#123;TRIGGER.KEY1&#125; </span><br><span class=\"line\">事件ID：&#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"六、配置钉钉报警\"><a href=\"#六、配置钉钉报警\" class=\"headerlink\" title=\"六、配置钉钉报警\"></a>六、配置钉钉报警</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">钉钉需要创建公司名称，建团队群</span></span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Zabbix"]},{"title":"zipkin日志收集部署","url":"/2025/11/06/zipkin%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E9%83%A8%E7%BD%B2/","content":"<h2 id=\"zipkin日志收集部署\"><a href=\"#zipkin日志收集部署\" class=\"headerlink\" title=\"zipkin日志收集部署\"></a>zipkin日志收集部署</h2><h3 id=\"jar包部署\"><a href=\"#jar包部署\" class=\"headerlink\" title=\"jar包部署\"></a>jar包部署</h3><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装jdk8</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/tomcat-jdk/jdk-8u271-linux-x64.tar.gz</span></span><br><span class=\"line\"><span class=\"comment\"># 变量</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># vim /etc/profile</span></span><br><span class=\"line\">JAVA_HOME=<span class=\"regexp\">/usr/l</span>ocal/java</span><br><span class=\"line\">MAVEN_HOME=<span class=\"regexp\">/usr/l</span>ocal/maven</span><br><span class=\"line\">PATH=<span class=\"variable\">$PATH</span>:<span class=\"variable\">$JAVA_HOME</span>/bin:<span class=\"variable\">$MAVEN_HOME</span>/bin</span><br><span class=\"line\">export JAVA_HOME MAVEN_HOME PATH</span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># npm环境安装</span></span><br><span class=\"line\">这个国内目前知道的只有淘宝有。</span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># alias npm=&quot;npm --registry=https://registry.npm.taobao.org --disturl=https://npm.taobao.org/mirrors/node&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># node环境安装（版本：V5.5.0）</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># yum install npm -y</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># git clone https://github.com/creationix/nvm.git /usr/local/nvm</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># source /usr/local/nvm/install.sh</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># nvm --version</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># nvm install v5.5.0\t#会报错</span></span><br><span class=\"line\"><span class=\"comment\"># 解决办法：--在当前用户家目录的.bash_profile文件中添加如下内容</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># cat /root/.bash_profile</span></span><br><span class=\"line\">.....</span><br><span class=\"line\">export NVM_DIR=<span class=\"string\">&quot;/usr/local/nvm&quot;</span></span><br><span class=\"line\">[ -s <span class=\"string\">&quot;<span class=\"variable\">$NVM_DIR</span>/nvm.sh&quot;</span> ] &amp;&amp; . <span class=\"string\">&quot;<span class=\"variable\">$NVM_DIR</span>/nvm.sh&quot;</span>  <span class=\"comment\"># This loads nvm</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># source /root/.bash_profile</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># nvm install v5.5.0\t\t# 再次执行就 OK 了</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Zipkin安装部署</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># wget -O zipkin.jar &#x27;https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec&#x27;</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># ls</span></span><br><span class=\"line\">nohup.out  zipkin.jar</span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\"># nohup java -jar zipkin.jar &amp;               //回车，放到后台去执行</span></span><br><span class=\"line\">[root<span class=\"variable\">@dev</span> ~]<span class=\"comment\">#  lsof -i:9411</span></span><br><span class=\"line\">COMMAND  PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class=\"line\">java    <span class=\"number\">8440</span> root   33u  IPv6  <span class=\"number\">64454</span>      0t0  TCP *:<span class=\"number\">9411</span> (LISTEN)</span><br><span class=\"line\"><span class=\"comment\"># 访问</span></span><br><span class=\"line\">浏览器输入： IP + <span class=\"number\">9411</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"dockers部署zipkin\"><a href=\"#dockers部署zipkin\" class=\"headerlink\" title=\"dockers部署zipkin\"></a>dockers部署zipkin</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 搜索</span><br><span class=\"line\">docker search zipkin</span><br><span class=\"line\"># 下载</span><br><span class=\"line\">docker pull openzipkin/zipkin</span><br><span class=\"line\"># 运行</span><br><span class=\"line\">docker run -d -p 9411:9411 openzipkin/zipkin</span><br><span class=\"line\"># 访问</span><br><span class=\"line\">浏览器输入： IP + 9411</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Zipkin"]},{"title":"偌依 项目部署及上线步骤","url":"/2025/11/06/%E5%81%8C%E4%BE%9D-%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2%E5%8F%8A%E4%B8%8A%E7%BA%BF%E6%AD%A5%E9%AA%A4/","content":"<h2 id=\"准备实验环境，准备3台机器\"><a href=\"#准备实验环境，准备3台机器\" class=\"headerlink\" title=\"准备实验环境，准备3台机器\"></a>准备实验环境，准备3台机器</h2><ul>\n<li><p>1.作为前端服务器，mysql,redis服务器–同时临时作为代码打包服务器<br>192.168.2.65\tnginx-server</p>\n</li>\n<li><p>2.作为后端服务器<br>192.168.2.66\tjava-server-1<br>192.168.2.67\tjava-server-2</p>\n</li>\n</ul>\n<p><code>关闭防火墙，selinux</code></p>\n<h2 id=\"环境一键脚本\"><a href=\"#环境一键脚本\" class=\"headerlink\" title=\"环境一键脚本\"></a>环境一键脚本</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/toolbox.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装nginx-mysql\"><a href=\"#安装nginx-mysql\" class=\"headerlink\" title=\"安装nginx&#x2F;mysql\"></a>安装nginx&#x2F;mysql</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#安装nginx</span></span><br><span class=\"line\"><span class=\"section\">[root@web-nginx ~]</span><span class=\"comment\"># vim /etc/yum.repos.d/nginx.repo</span></span><br><span class=\"line\"><span class=\"section\">[nginx-stable]</span></span><br><span class=\"line\"><span class=\"attr\">name</span>=nginx stable repo</span><br><span class=\"line\"><span class=\"attr\">baseurl</span>=http://nginx.org/packages/centos/<span class=\"variable\">$releasever</span>/<span class=\"variable\">$basearch</span>/</span><br><span class=\"line\"><span class=\"attr\">gpgcheck</span>=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"attr\">enabled</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"section\">[root@web-nginx ~]</span><span class=\"comment\"># yum install -y nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装mysql5.7</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># rpm -ivh mysql80-community-release-el7-3.noarch.rpm </span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># vim /etc/yum.repos.d/mysql-community.repo </span></span><br><span class=\"line\">将mysql8.0关闭将mysql5.7开启</span><br><span class=\"line\"><span class=\"attr\">enabled</span>=<span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"attr\">gpgcheck</span>=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># yum install -y mysql-community-server</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># systemctl start mysqld</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># grep pass /var/log/mysqld.log </span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># mysqladmin -uroot -p&#x27;HdV&gt;.f&gt;Ir8;h&#x27; password &#x27;QingFeng@123!&#x27;</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># mysql -uroot -p&#x27;QingFeng@123!&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#创建数据库ry</span></span><br><span class=\"line\">mysql&gt; create database ry character set utf8 collate  utf8_general_ci<span class=\"comment\">;</span></span><br><span class=\"line\">Query OK, 1 row affected (0.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#设置root允许远程登录</span></span><br><span class=\"line\">mysql&gt; update mysql.user set <span class=\"attr\">host</span> = <span class=\"string\">&#x27;%&#x27;</span> where user = <span class=\"string\">&#x27;root&#x27;</span><span class=\"comment\">;</span></span><br><span class=\"line\">Query OK, 1 row affected (0.10 sec)</span><br><span class=\"line\">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class=\"line\"><span class=\"comment\">#刷新权限</span></span><br><span class=\"line\">mysql&gt; flush privileges<span class=\"comment\">;</span></span><br><span class=\"line\"><span class=\"comment\">#退出</span></span><br><span class=\"line\">mysql&gt; \\q</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装redis\"><a href=\"#安装redis\" class=\"headerlink\" title=\"安装redis\"></a>安装redis</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/redis-4.0.9.tar.gz</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># tar xzvf redis-4.0.9.tar.gz -C /usr/local/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># mv /usr/local/redis-4.0.9 /usr/local/redis</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># yum install -y gcc make</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cd /usr/local/redis</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server redis]</span><span class=\"comment\"># make</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server redis]</span><span class=\"comment\"># cp /usr/local/redis/redis.conf /usr/local/redis/redis.conf.bak</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server redis]</span><span class=\"comment\"># vim redis.conf </span></span><br><span class=\"line\">bind 192.168.198.160　　<span class=\"comment\">#只监听内网IP</span></span><br><span class=\"line\">daemonize yes　　　　　<span class=\"comment\">#开启后台模式将on改为yes</span></span><br><span class=\"line\">port 6379                      <span class=\"comment\">#端口号</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动redis, 放后台运行</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server redis]</span><span class=\"comment\"># src/redis-server redis.conf &amp;</span></span><br><span class=\"line\"><span class=\"comment\">#查看端口有没有起来</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server redis]</span><span class=\"comment\"># netstat -lntp | egrep &#x27;3306|6379&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"前后端打包环境并打包\"><a href=\"#前后端打包环境并打包\" class=\"headerlink\" title=\"前后端打包环境并打包\"></a>前后端打包环境并打包</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">安装后端打包工具</span><br><span class=\"line\"><span class=\"comment\">#安装jdk</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/jdk-8u271-linux-x64.tar.gz</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># tar zxvf jdk-11.0.20_linux-x64_bin.tar.gz -C /usr/local</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># mv /usr/local/jdk-11.0.20 /usr/local/java</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># vim /etc/profile</span></span><br><span class=\"line\"><span class=\"attr\">JAVA_HOME</span>=/usr/local/java</span><br><span class=\"line\"><span class=\"attr\">PATH</span>=<span class=\"variable\">$JAVA_HOME</span>/bin:<span class=\"variable\">$PATH</span></span><br><span class=\"line\">export JAVA_HOME PATH</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># java -version</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#下载maven包</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/apache-maven-3.9.6-bin.tar.gz</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># tar zxvf apache-maven-3.9.6-bin.tar.gz -C /usr/local</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># mv /usr/local/apache-maven-3.9.6 /usr/local/maven</span></span><br><span class=\"line\"><span class=\"comment\">#设置环境变量</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># vim /etc/profile</span></span><br><span class=\"line\"><span class=\"attr\">MAVEN_HOME</span>=/usr/local/maven</span><br><span class=\"line\"><span class=\"attr\">PATH</span>=<span class=\"variable\">$PATH</span>:<span class=\"variable\">$MAVEN_HOME</span>/bin</span><br><span class=\"line\">export MAVEN_HOME PATH</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\"><span class=\"comment\">#检测maven是否安装成功</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># mvn -version</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#安装node.js前端打包工具命令npm</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># wget https://nodejs.org/dist/v12.18.4/node-v12.18.4-linux-x64.tar.xz</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># tar xf node-v12.18.4-linux-x64.tar.xz -C /usr/local/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># mv /usr/local/node-v12.18.4-linux-x64 /usr/local/node</span></span><br><span class=\"line\"><span class=\"comment\">#设置变量</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># vim /etc/profile</span></span><br><span class=\"line\"><span class=\"attr\">NODE_HOME</span>=/usr/local/node</span><br><span class=\"line\"><span class=\"attr\">PATH</span>=<span class=\"variable\">$NODE_HOME</span>/bin:<span class=\"variable\">$PATH</span></span><br><span class=\"line\">export NODE_HOME PATH</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\"><span class=\"comment\">#查看版本</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># node --version</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#下载偌依代码包，也可以下载git仓库拉取代码包</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/RuoYi-Vue-master.zip</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># yum -y install unzip</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># unzip RuoYi-Vue-master.zip</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cd RuoYi-Vue-master/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server RuoYi-Vue-master]</span><span class=\"comment\"># cd RuoYi-Vue</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server RuoYi-Vue]</span><span class=\"comment\"># cd ruoyi-admin/src/main/resources/</span></span><br><span class=\"line\">编辑代码配置文件修改数据库与redis连接地址</span><br><span class=\"line\">1.修改redis</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server resources]</span><span class=\"comment\"># vim application.yml</span></span><br><span class=\"line\"><span class=\"comment\"># redis 配置</span></span><br><span class=\"line\">  redis:</span><br><span class=\"line\">    <span class=\"comment\"># 地址</span></span><br><span class=\"line\">    host: 192.168.2.65\t<span class=\"comment\">#需修改</span></span><br><span class=\"line\">    <span class=\"comment\"># 端口，默认为6379</span></span><br><span class=\"line\">    port: 6379</span><br><span class=\"line\">    <span class=\"comment\"># 密码</span></span><br><span class=\"line\">    password:</span><br><span class=\"line\">2.修改mysql</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server resources]</span><span class=\"comment\"># vim application-druid.yml</span></span><br><span class=\"line\"><span class=\"comment\"># 数据源配置</span></span><br><span class=\"line\">spring:</span><br><span class=\"line\">    datasource:</span><br><span class=\"line\">        type: com.alibaba.druid.pool.DruidDataSource</span><br><span class=\"line\">        driverClassName: com.mysql.cj.jdbc.Driver</span><br><span class=\"line\">        druid:</span><br><span class=\"line\">            <span class=\"comment\"># 主库数据源</span></span><br><span class=\"line\">            master:</span><br><span class=\"line\">                url: jdbc:mysql://192.168.2.65:3306/（ry）?<span class=\"attr\">useUnicode</span>=<span class=\"literal\">true</span>&amp;characterEncoding=utf8&amp;zeroDateTimeBehavior=convertToNull（&amp;useSSL=<span class=\"literal\">false</span>&amp;）serverTimezone=GMT%<span class=\"number\">2</span>B8</span><br><span class=\"line\">                username: root</span><br><span class=\"line\">                password: QianFeng@123!</span><br><span class=\"line\"><span class=\"comment\">#另外打括号的地方是需修改的地方</span></span><br><span class=\"line\">`ry 是数据库的名字，需要和数据库名字一致`</span><br><span class=\"line\">&amp;<span class=\"attr\">useSSL</span>=<span class=\"literal\">false</span>&amp; 改成取消加密</span><br><span class=\"line\">同时注意数据库连接这里是否启动加密连接，如果启用了加密连接有可能会造成代码与数据库连接不上。修改为:</span><br><span class=\"line\">&amp;<span class=\"attr\">useSSL</span>=<span class=\"literal\">false</span>&amp;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"打包前端代码\"><a href=\"#打包前端代码\" class=\"headerlink\" title=\"打包前端代码\"></a>打包前端代码</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cd RuoYi-Vue-master/ruoyi-ui/</span></span><br><span class=\"line\"><span class=\"comment\">#替换为国内淘宝镜像源</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ruoyi-ui]</span><span class=\"comment\"># npm install --unsafe-perm --registry=https://registry.npm.taobao.org</span></span><br><span class=\"line\"><span class=\"comment\">#正式环境打包前端代码</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ruoyi-ui]</span><span class=\"comment\"># npm run build:prod</span></span><br><span class=\"line\"></span><br><span class=\"line\">构建打包成功之后，会在根目录生成 dist 文件夹，里面就是构建打包好的文件，通常是 xxx.js 、xxx.css、index.html 等静态文件。</span><br><span class=\"line\"></span><br><span class=\"line\">通常情况下 dist 文件夹的静态文件发布到你的 nginx 或者静态服务器即可，其中的 index.html 是后台服务的入口页面。</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ruoyi-ui]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">babel.config.js  build  node_modules  package-lock.json  README.md  vue.config.js</span><br><span class=\"line\">bin              dist   package.json  public             src</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ruoyi-ui]</span><span class=\"comment\"># cd dist/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server dist]</span><span class=\"comment\"># ls   ----前端代码完成</span></span><br><span class=\"line\">favicon.ico  index.html  robots.txt  static</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"打包后端代码\"><a href=\"#打包后端代码\" class=\"headerlink\" title=\"打包后端代码\"></a>打包后端代码</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cd RuoYi-Vue-master/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server RuoYi-Vue-master]</span><span class=\"comment\"># cd sql/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server sql]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">quartz.sql  ry_20200920.sql</span><br><span class=\"line\"><span class=\"comment\">#导入数据给创建的数据库里面</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server sql]</span><span class=\"comment\"># mysql -uroot -p&#x27;QianFeng@123!&#x27; ry &lt; quartz.sql </span></span><br><span class=\"line\">mysql: <span class=\"section\">[Warning]</span> Using a password on the command line interface can be insecure.</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server sql]</span><span class=\"comment\"># mysql -uroot -p&#x27;QianFeng@123!&#x27; ry &lt; ry_20200920.sql</span></span><br><span class=\"line\">mysql: <span class=\"section\">[Warning]</span> Using a password on the command line interface can be insecure.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#开始后端打包jar包</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cd RuoYi-Vue-master/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server RuoYi-Vue-master]</span><span class=\"comment\"># mvn package  ---后端打包命令 ----时间较长</span></span><br><span class=\"line\"><span class=\"comment\">#然后会在项目下生成 target文件夹包含 war 或jar （多模块生成在ruoyi-admin）</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server RuoYi-Vue-master]</span><span class=\"comment\"># cd ruoyi-admin/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ruoyi-admin]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">pom.xml  src  target</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server target]</span><span class=\"comment\"># ls</span></span><br><span class=\"line\">classes  generated-sources  maven-archiver  maven-status  ruoyi-admin.jar  ruoyi-admin.jar.original</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"准备后端java服务\"><a href=\"#准备后端java服务\" class=\"headerlink\" title=\"准备后端java服务\"></a>准备后端java服务</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">两台机器修改主机名</span><br><span class=\"line\"><span class=\"comment\"># hostnamectl set-hostname java-server</span></span><br><span class=\"line\">关闭防火墙和selinux</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># systemctl stop firewalld</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># setenforce 0</span></span><br><span class=\"line\">两台机器上传idk</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># wget https://a.xbd666.cn/d/Aliyun/Cloud_computing/Software_package/jdk-8u271-linux-x64.tar.gz</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># tar zxvf jdk-8u271-linux-x64.tar.gz -C /usr/local</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># mv /usr/local/jdk1.8.0_271 /usr/local/java</span></span><br><span class=\"line\"><span class=\"comment\">#设置环境变量</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># vim /etc/profile</span></span><br><span class=\"line\"><span class=\"attr\">JAVA_HOME</span>=/usr/local/java</span><br><span class=\"line\"><span class=\"attr\">PATH</span>=<span class=\"variable\">$JAVA_HOME</span>/bin:<span class=\"variable\">$PATH</span></span><br><span class=\"line\">export JAVA_HOME PATH</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># source /etc/profile</span></span><br><span class=\"line\">查看版本信息</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># java -version</span></span><br><span class=\"line\"></span><br><span class=\"line\">后端机器上都创建</span><br><span class=\"line\"><span class=\"comment\">#创建工作目录以及代码上线目录</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># mkdir /application/java-server -p</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"开始上线服务\"><a href=\"#开始上线服务\" class=\"headerlink\" title=\"开始上线服务\"></a>开始上线服务</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">1.将前端代码放到nginx网站发布目录并启动</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cd /usr/share/nginx/html/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server html]</span><span class=\"comment\"># rm -rf *</span></span><br><span class=\"line\"><span class=\"comment\">#拷贝dist目录下所有文件到到当前目录</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server html]</span><span class=\"comment\"># cp -r /mnt/ruoyi-ui/dist/* .</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server html]</span><span class=\"comment\"># ls #将所有前端代码放到nginx的网站发布目录中</span></span><br><span class=\"line\">favicon.ico  index.html  robots.txt  static</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server html]</span><span class=\"comment\"># systemctl start nginx</span></span><br></pre></td></tr></table></figure>\n\n<p><code>浏览器访问</code></p>\n<h2 id=\"后端服务上线\"><a href=\"#后端服务上线\" class=\"headerlink\" title=\"后端服务上线\"></a>后端服务上线</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#后端机器都操作</span></span><br><span class=\"line\">1.将打包好的后端jar包上传到两台后端服务器中</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cd RuoYi-Vue-master/ruoyi-admin/target/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server target]</span><span class=\"comment\"># scp ruoyi-admin.jar 192.168.2.66:/root/</span></span><br><span class=\"line\">2.开始上线后端--两台机器相同操作</span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># cp ruoyi-admin.jar /application/java-server/</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server ~]</span><span class=\"comment\"># cd /application/java-server/</span></span><br><span class=\"line\"><span class=\"section\">[root@java-server java-server]</span><span class=\"comment\"># nohup java -jar -server -Xmx1024m -Xms1024m ruoyi-admin.jar &amp;</span></span><br><span class=\"line\"><span class=\"section\">[1]</span> 1212</span><br><span class=\"line\"><span class=\"section\">[root@java-server java-server]</span><span class=\"comment\"># tail -f nohup.out   查看日志</span></span><br><span class=\"line\">查看服务端口</span><br><span class=\"line\"><span class=\"section\">[root@java-server java-server]</span><span class=\"comment\"># netstat -lntp </span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"配置反向代理\"><a href=\"#配置反向代理\" class=\"headerlink\" title=\"配置反向代理\"></a>配置反向代理</h2><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">配置nginx路径转发与负载均衡</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server ~]</span><span class=\"comment\"># cd /etc/nginx/conf.d/</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server conf.d]</span><span class=\"comment\"># mv default.conf nginx.conf</span></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server conf.d]</span><span class=\"comment\"># vim upstream.conf</span></span><br><span class=\"line\">upstream java-web &#123;</span><br><span class=\"line\">        server 192.168.198.162:8080 <span class=\"attr\">weight</span>=<span class=\"number\">1</span> max_fails=<span class=\"number\">2</span> fail_timeout=<span class=\"number\">5</span>s<span class=\"comment\">;</span></span><br><span class=\"line\">        server 192.168.198.163:8080 <span class=\"attr\">weight</span>=<span class=\"number\">1</span> max_fails=<span class=\"number\">2</span> fail_timeout=<span class=\"number\">5</span>s<span class=\"comment\">;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server conf.d]</span><span class=\"comment\"># vim app.conf</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen       80<span class=\"comment\">;</span></span><br><span class=\"line\">    server_name  localhost<span class=\"comment\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">#charset koi8-r;</span></span><br><span class=\"line\">    <span class=\"comment\">#access_log  /var/log/nginx/host.access.log  main;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        root   /usr/share/nginx/html<span class=\"comment\">;</span></span><br><span class=\"line\">        try_files $uri $uri/ /index.html<span class=\"comment\">;</span></span><br><span class=\"line\">        index  index.html index.htm<span class=\"comment\">;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location /prod-api/&#123;</span><br><span class=\"line\">      proxy_pass http://java-web/<span class=\"comment\">;</span></span><br><span class=\"line\">      proxy_set_header Host $http_host<span class=\"comment\">;</span></span><br><span class=\"line\">      proxy_set_header X-Real-IP $remote_addr<span class=\"comment\">;</span></span><br><span class=\"line\">      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class=\"comment\">;</span></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">[root@nginx-server conf.d]</span><span class=\"comment\"># nginx -t </span></span><br><span class=\"line\">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class=\"line\">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class=\"line\"><span class=\"section\">[root@nginx-server conf.d]</span><span class=\"comment\"># nginx -s reload</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#解释：</span></span><br><span class=\"line\">try_files指令：可以实现自动检测网站根下是否存在用户在浏览器输入的名为URI文件和名为URI的目录，</span><br><span class=\"line\">当用户请求 http://localhost/example 时，这里的 $uri 就是 /example。 </span><br><span class=\"line\">try_file 会到硬盘里尝试找这个文件。如果存在名为 /$root/example（其中 $root 是项目代码安装目录）的文件，就直接把这个文件的内容发送给用户。 </span><br><span class=\"line\">如果目录中没有叫 example 的文件。然后就看 $uri/，增加了一个 /，也就是看有没有名为/$root/example/ 的目录。 </span><br><span class=\"line\">若不存在则会跳转至最后一个参数，这以上例子中最后一个参数是根下的/index.html，也就是相当于 nginx 发起一个 HTTP 请求到 http://localhost/index.html</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"浏览器访问\"><a href=\"#浏览器访问\" class=\"headerlink\" title=\"浏览器访问\"></a>浏览器访问</h2><p><code>默认账户 admin/admin123</code></p>\n","categories":["operations"],"tags":["Linux","Docker","Ruoyi"]},{"title":"域名配置","url":"/2025/01/09/%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE/","content":"<h1 id=\"一、使用子域名（方案一）\"><a href=\"#一、使用子域名（方案一）\" class=\"headerlink\" title=\"一、使用子域名（方案一）\"></a>一、使用子域名（方案一）</h1><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name service1.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://localhost:3000;</span><br><span class=\"line\">        proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">        proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name service2.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://localhost:4000;</span><br><span class=\"line\">        proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">        proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"二、使用同一个域名-方案二\"><a href=\"#二、使用同一个域名-方案二\" class=\"headerlink\" title=\"二、使用同一个域名(方案二)\"></a>二、使用同一个域名(方案二)</h1><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    location /service1 &#123;</span><br><span class=\"line\">        proxy_pass http://localhost:3000;</span><br><span class=\"line\">        proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">        proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    location /service2 &#123;</span><br><span class=\"line\">        proxy_pass http://localhost:4000;</span><br><span class=\"line\">        proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">        proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置ssl证书\"><a href=\"#配置ssl证书\" class=\"headerlink\" title=\"配置ssl证书\"></a>配置ssl证书</h1><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、安装Certbot，Certbot是一个自动化工具，可以帮助你获取和安装SSL证书</span></span><br><span class=\"line\"><span class=\"comment\"># 对于Ubuntu/Debian</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt update</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> apt install certbot python3-certbot-nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 对于CentOS/RHEL</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> yum install epel-release</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> yum install certbot python3-certbot-nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. 获取SSL证书，使用Certbot为每个子域名获取SSL证书：</span></span><br><span class=\"line\"><span class=\"built_in\">sudo</span> certbot --nginx -d service1.example.com -d service2.example.com</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置nginx\"><a href=\"#配置nginx\" class=\"headerlink\" title=\"配置nginx\"></a>配置nginx</h1><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name service1.example.com;</span><br><span class=\"line\">    <span class=\"built_in\">return</span> 301 https://$host<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 443 ssl;</span><br><span class=\"line\">    server_name service1.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_certificate /etc/letsencrypt/live/service1.example.com/fullchain.pem;</span><br><span class=\"line\">    ssl_certificate_key /etc/letsencrypt/live/service1.example.com/privkey.pem;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://localhost:3000;</span><br><span class=\"line\">        proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">        proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 80;</span><br><span class=\"line\">    server_name service2.example.com;</span><br><span class=\"line\">    <span class=\"built_in\">return</span> 301 https://$host<span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen 443 ssl;</span><br><span class=\"line\">    server_name service2.example.com;</span><br><span class=\"line\"></span><br><span class=\"line\">    ssl_certificate /etc/letsencrypt/live/service2.example.com/fullchain.pem;</span><br><span class=\"line\">    ssl_certificate_key /etc/letsencrypt/live/service2.example.com/privkey.pem;</span><br><span class=\"line\"></span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://localhost:4000;</span><br><span class=\"line\">        proxy_set_header Host <span class=\"variable\">$host</span>;</span><br><span class=\"line\">        proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-Proto <span class=\"variable\">$scheme</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<h1 id=\"自动续费\"><a href=\"#自动续费\" class=\"headerlink\" title=\"自动续费\"></a>自动续费</h1><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Let<span class=\"string\">&#x27;s Encrypt的证书有效期为90天。Certbot会自动设置一个cron任务来续期证书。你可以手动测试续期</span></span><br><span class=\"line\"><span class=\"string\">sudo certbot renew --dry-run</span></span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","SSL","域名"]},{"title":"安装MySQL","url":"/2025/01/09/%E5%AE%89%E8%A3%85MySQL/","content":"<h1 id=\"1、yum安装MySQL\"><a href=\"#1、yum安装MySQL\" class=\"headerlink\" title=\"1、yum安装MySQL\"></a>1、yum安装MySQL</h1><p>#关闭防火墙</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">setenforce 0</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"清理环境\"><a href=\"#清理环境\" class=\"headerlink\" title=\"清理环境\"></a>清理环境</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum erase mariadb mariadb-server mariadb-libs mariadb-devel -y</span><br><span class=\"line\">userdel -r mysql</span><br><span class=\"line\">rm -rf /etc/my*         //配置文件</span><br><span class=\"line\">rm -rf /var/lib/mysql   //初始化生成密码的路径目录</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"编辑yum文件\"><a href=\"#编辑yum文件\" class=\"headerlink\" title=\"编辑yum文件\"></a>编辑yum文件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost yum.repos.d]# vim mysql.repo</span><br><span class=\"line\">[mysql]</span><br><span class=\"line\">name=mysql</span><br><span class=\"line\">baseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql-5.7-community-el7-x86_64/</span><br><span class=\"line\">gpgcheck=1</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgkey=https://mirrors.ustc.edu.cn/mysql-repo/RPM-GPG-KEY-mysql</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装软件\"><a href=\"#安装软件\" class=\"headerlink\" title=\"安装软件\"></a>安装软件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># yum repolist enabled | grep mysql</span><br><span class=\"line\"># yum -y install mysql-community-server</span><br><span class=\"line\"># systemctl start mysqld                        //第一次启动会自动始化数据库</span><br><span class=\"line\"># systemctl enable   mysqld</span><br><span class=\"line\"># grep password /var/log/mysqld.log</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"修改密码\"><a href=\"#修改密码\" class=\"headerlink\" title=\"修改密码\"></a><strong>修改密码</strong></h1><p>5.7默认有临时密码，需要修改，两种方式：<br>第一种</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># mysql -uroot -p&#x27;uopCBgXBu8,k&#x27;</span><br><span class=\"line\">mysql&gt; alter user &#x27;root&#x27;@&#x27;localhost&#x27; identified by &#x27;Qianfeng123!@&#x27;;</span><br></pre></td></tr></table></figure>\n\n<p>第二种</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># mysqladmin -u root -p&#x27;uopCBgXBu8,k&#x27; password &#x27;Qianfeng123!@&#x27;</span><br></pre></td></tr></table></figure>\n\n<p><strong>关闭弱密码限制</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">rpm安装的5.7如下方式修改</span><br><span class=\"line\"># vim /etc/my.cnf</span><br><span class=\"line\">validate_password=off</span><br><span class=\"line\"></span><br><span class=\"line\">编译安装的5.7如下方式修改</span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">basedir=/usr/local/mysql</span><br><span class=\"line\">datadir=/usr/local/mysql/data</span><br><span class=\"line\"></span><br><span class=\"line\">[mysqld_safe]</span><br><span class=\"line\">validate_password=off</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2、编译安装MySQL\"><a href=\"#2、编译安装MySQL\" class=\"headerlink\" title=\"2、编译安装MySQL\"></a>2、编译安装MySQL</h1><p>#关闭防火墙</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">setenforce 0</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"清理环境-1\"><a href=\"#清理环境-1\" class=\"headerlink\" title=\"清理环境\"></a>清理环境</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum erase mariadb mariadb-server mariadb-libs mariadb-devel -y</span><br><span class=\"line\">userdel -r mysql</span><br><span class=\"line\">rm -rf /etc/my*</span><br><span class=\"line\">rm -rf /var/lib/mysql</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建MySQL用户\"><a href=\"#创建MySQL用户\" class=\"headerlink\" title=\"创建MySQL用户\"></a>创建MySQL用户</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">useradd -r mysql -M -s /sbin/nologin</span><br><span class=\"line\"># -M指定不安装家目录</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装编译工具，以及依赖软件\"><a href=\"#安装编译工具，以及依赖软件\" class=\"headerlink\" title=\"安装编译工具，以及依赖软件\"></a>安装编译工具，以及依赖软件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install ncurses ncurses-devel openssl-devel bison gcc gcc-c++ make cmake</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"创建mysql目录\"><a href=\"#创建mysql目录\" class=\"headerlink\" title=\"创建mysql目录\"></a>创建mysql目录</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir -p /usr/local/&#123;data,mysql,log&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"官方下载MySQL的boost包\"><a href=\"#官方下载MySQL的boost包\" class=\"headerlink\" title=\"官方下载MySQL的boost包\"></a>官方下载MySQL的boost包</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://mirrors.aliyun.com/mysql/MySQL-5.7/mysql-boost-5.7.36.tar.gz?spm=a2c6h.25603864.0.0.b21f63aftvppVw</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"更改包名\"><a href=\"#更改包名\" class=\"headerlink\" title=\"更改包名\"></a>更改包名</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mv mysql-boost-5.7.36.tar.gz?spm=a2c6h.25603864.0.0.b21f63aftvppVw mysql-boost-5.7.36.tar.gz</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"解压下载的软件包\"><a href=\"#解压下载的软件包\" class=\"headerlink\" title=\"解压下载的软件包\"></a>解压下载的软件包</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">tar zxvf mysql-boost-5.7.36.tar.gz -C /usr/local/</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"切换目录\"><a href=\"#切换目录\" class=\"headerlink\" title=\"切换目录\"></a>切换目录</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd /usr/local/mysql-5.7.36/</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"编译安装\"><a href=\"#编译安装\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cmake . \\</span><br><span class=\"line\">-DWITH_BOOST=boost/boost_1_59_0/ \\</span><br><span class=\"line\">-DCMAKE_INSTALL_PREFIX=/usr/local/mysql \\</span><br><span class=\"line\">-DSYSCONFDIR=/etc \\</span><br><span class=\"line\">-DMYSQL_DATADIR=/usr/local/mysql/data \\</span><br><span class=\"line\">-DINSTALL_MANDIR=/usr/share/man \\</span><br><span class=\"line\">-DMYSQL_TCP_PORT=3306 \\</span><br><span class=\"line\">-DMYSQL_UNIX_ADDR=/tmp/mysql.sock \\</span><br><span class=\"line\">-DDEFAULT_CHARSET=utf8 \\</span><br><span class=\"line\">-DEXTRA_CHARSETS=all \\</span><br><span class=\"line\">-DDEFAULT_COLLATION=utf8_general_ci \\</span><br><span class=\"line\">-DWITH_READLINE=1 \\</span><br><span class=\"line\">-DWITH_SSL=system \\</span><br><span class=\"line\">-DWITH_EMBEDDED_SERVER=1 \\</span><br><span class=\"line\">-DENABLED_LOCAL_INFILE=1 \\</span><br><span class=\"line\">-DWITH_INNOBASE_STORAGE_ENGINE=1</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"编译安装-1\"><a href=\"#编译安装-1\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">make -j2 &amp;&amp; make -j2 install</span><br><span class=\"line\"># -j2是指定2核</span><br></pre></td></tr></table></figure>\n\n<p>#如果安装出错，想重新安装：不用重新解压，只需要删除安装目录中的缓存文件</p>\n<h1 id=\"配置文件添加命令路径\"><a href=\"#配置文件添加命令路径\" class=\"headerlink\" title=\"配置文件添加命令路径\"></a>配置文件添加命令路径</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt; /etc/profile &lt;&lt;EOF</span><br><span class=\"line\">mysql=/user/local/mysql/bin/</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"重启profile文件\"><a href=\"#重启profile文件\" class=\"headerlink\" title=\"重启profile文件\"></a>重启profile文件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">source /etc/profile</span><br></pre></td></tr></table></figure>\n\n<p>#找到安装目录，拷贝mysql.service脚本文件到&#x2F;etc&#x2F;init.d&#x2F;目录下，添加开机启动</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cp /usr/local/mysql/support-files/mysql.service /etc/init.d/mysqld</span><br><span class=\"line\">chmod a+x /etc/init.d/mysqld</span><br><span class=\"line\"># chkconfig: 2346 63 80</span><br><span class=\"line\">chkconfig--add mysqld</span><br><span class=\"line\">systemctl daemon-reload</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"进入安装目录修改权限\"><a href=\"#进入安装目录修改权限\" class=\"headerlink\" title=\"进入安装目录修改权限\"></a>进入安装目录修改权限</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">chown -R mysql.mysql .</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"初始化\"><a href=\"#初始化\" class=\"headerlink\" title=\"初始化\"></a>初始化</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">./bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</span><br></pre></td></tr></table></figure>\n<h1 id=\"初始化-只需要初始化一次，初始化完成之后，一定要记住提示最后的密码用于登陆或者修改密码\"><a href=\"#初始化-只需要初始化一次，初始化完成之后，一定要记住提示最后的密码用于登陆或者修改密码\" class=\"headerlink\" title=\"初始化,只需要初始化一次，初始化完成之后，一定要记住提示最后的密码用于登陆或者修改密码\"></a>初始化,只需要初始化一次，初始化完成之后，一定要记住提示最后的密码用于登陆或者修改密码</h1><h1 id=\"添加配置文件-删除旧配置文件之后，再添加如下内容\"><a href=\"#添加配置文件-删除旧配置文件之后，再添加如下内容\" class=\"headerlink\" title=\"添加配置文件,删除旧配置文件之后，再添加如下内容\"></a>添加配置文件,删除旧配置文件之后，再添加如下内容</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt; /etc/my.cnf &lt;&lt; EOF</span><br><span class=\"line\">[mysqld]</span><br><span class=\"line\">basedir=/usr/local/mysql       #指定安装目录</span><br><span class=\"line\">datadir=/usr/local/mysql/data  #指定数据存放目录</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n<h1 id=\"杀死原进程\"><a href=\"#杀死原进程\" class=\"headerlink\" title=\"杀死原进程\"></a>杀死原进程</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">pkill mysqld</span><br></pre></td></tr></table></figure>\n<h1 id=\"重启MySQL服务\"><a href=\"#重启MySQL服务\" class=\"headerlink\" title=\"重启MySQL服务\"></a>重启MySQL服务</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl start mysqld \t前提关闭之前的进程，再用start启动MySQL</span><br><span class=\"line\">#systemctl status mysqld</span><br><span class=\"line\">#systemctl stop mysqld</span><br><span class=\"line\">#sh mysqld restart</span><br></pre></td></tr></table></figure>\n<h1 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd /usr/local/mysql</span><br><span class=\"line\">./bin/mysqld_safe --user=mysql &amp;</span><br></pre></td></tr></table></figure>\n<h1 id=\"获取密码\"><a href=\"#获取密码\" class=\"headerlink\" title=\"获取密码\"></a>获取密码</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">#temp_password=$(sudo cat bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data | grep &#x27;temporary localhost&#x27; | awk &#x27;&#123;print $NF&#125;&#x27;)</span><br><span class=\"line\">#mysql -uroot -p&quot;$&#123;temp_password&#125;&quot; --connect-expired-password &lt;&lt;EOF</span><br><span class=\"line\">#ALTER USER &#x27;root&#x27;@&#x27;localhost&#x27; IDENTIFIED BY &quot;$&#123;Mysql_Pass&#125;&quot;;</span><br><span class=\"line\">#FLUSH PRIVILEGES;</span><br><span class=\"line\">#EOF</span><br></pre></td></tr></table></figure>\n<h1 id=\"登录测试\"><a href=\"#登录测试\" class=\"headerlink\" title=\"登录测试\"></a>登录测试</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># /usr/local/mysql/bin/mysql -uroot -p&#x27;ZrSw)Ns_*9iR&#x27;</span><br></pre></td></tr></table></figure>\n<p>#如果需要重新初始化…</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># killall mysqld</span><br><span class=\"line\"># rm -rf /usr/local/mysql/data</span><br><span class=\"line\"># bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/usr/local/mysql/data</span><br></pre></td></tr></table></figure>\n<pre><code>\n</code></pre>\n","categories":["operations"],"tags":["Linux","Mysql"]},{"title":"安装Tomcat、JDK（java）实验","url":"/2025/11/06/%E5%AE%89%E8%A3%85Tomcat%E3%80%81JDK%EF%BC%88java%EF%BC%89/","content":"<h3 id=\"1、安装JDK\"><a href=\"#1、安装JDK\" class=\"headerlink\" title=\"1、安装JDK\"></a>1、安装JDK</h3><p>上传jdk1.8到服务器，安装jdk</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@java-tomcat1 ~]# tar xzf jdk-8u191-linux-x64.tar.gz -C /usr/local/</span><br><span class=\"line\">[root@java-tomcat1 ~]# cd /usr/local/</span><br><span class=\"line\">[root@java-tomcat1 local]# mv jdk1.8.0_191/ java</span><br></pre></td></tr></table></figure>\n<p>设置环境变量:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@java-tomcat1 local]# vim /etc/profile</span><br><span class=\"line\">JAVA_HOME=/usr/local/java #指定java安装目录</span><br><span class=\"line\">PATH=$JAVA_HOME/bin:$PATH #用于指定java系统查找命令的路径</span><br><span class=\"line\">export JAVA_HOME PATH #类的路径，在编译运行java程序时，如果有调用到其他类的时候，在classpath中寻找需要的类。</span><br></pre></td></tr></table></figure>\n<p>检测JDK是否安装成功:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@java-tomcat1 local]# source /etc/profile</span><br><span class=\"line\">[root@java-tomcat1 local]# java -version </span><br><span class=\"line\">java version &quot;1.8.0_191&quot;</span><br><span class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_191-b12)</span><br><span class=\"line\">Java HotSpot(TM) 64-Bit Server VM (build 25.191-b12, mixed mode)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"安装Tomcat\"><a href=\"#安装Tomcat\" class=\"headerlink\" title=\"安装Tomcat\"></a>安装Tomcat</h4><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">[root@java-tomcat1 ~]</span><span class=\"comment\"># mkdir /data/application -p</span></span><br><span class=\"line\"><span class=\"section\">[root@java-tomcat1 ~]</span><span class=\"comment\"># cd /usr/src/</span></span><br><span class=\"line\"><span class=\"section\">[root@java-tomcat1 src]</span><span class=\"comment\"># wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.42/bin/apache-tomcat-8.5.42.tar.gz</span></span><br><span class=\"line\"><span class=\"section\">[root@java-tomcat1 src]</span><span class=\"comment\"># tar xzf apache-tomcat-8.5.42.tar.gz -C /data/application/</span></span><br><span class=\"line\"><span class=\"section\">[root@java-tomcat1 src]</span><span class=\"comment\"># cd /data/application/</span></span><br><span class=\"line\"><span class=\"section\">[root@java-tomcat1 application]</span><span class=\"comment\"># mv apache-tomcat-8.5.42/ tomcat</span></span><br></pre></td></tr></table></figure>\n<p>设置环境变量:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@java-tomcat1 application]# vim /etc/profile</span><br><span class=\"line\">export TOMCAT_HOME=/data/application/tomcat   #指定tomcat的安装目录</span><br><span class=\"line\">[root@java-tomcat1 application]# source  /etc/profile</span><br></pre></td></tr></table></figure>\n<p>查看tomcat是否安装成功:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@java-tomcat1 tomcat]# /data/application/tomcat/bin/startup.sh或 /data/application/tomcat/bin/version.sh</span><br><span class=\"line\">Using CATALINA_BASE:   /data/application/tomcat</span><br><span class=\"line\">Using CATALINA_HOME:   /data/application/tomcat</span><br><span class=\"line\">Using CATALINA_TMPDIR: /data/application/tomcat/temp</span><br><span class=\"line\">Using JRE_HOME:        /usr/local/java</span><br><span class=\"line\">Using CLASSPATH:       /data/application/tomcat/bin/bootstrap.jar:/data/application/tomcat/bin/tomcat-juli.jar</span><br><span class=\"line\">Server version: Apache Tomcat/8.5.42</span><br><span class=\"line\">Server built:   Jun 4 2019 20:29:04 UTC</span><br><span class=\"line\">Server number:  8.5.42.0</span><br><span class=\"line\">OS Name:        Linux</span><br><span class=\"line\">OS Version:     3.10.0-693.el7.x86_64</span><br><span class=\"line\">Architecture:   amd64</span><br><span class=\"line\">JVM Version:    1.8.0_191-b12</span><br><span class=\"line\">JVM Vendor:     Oracle Corporation</span><br></pre></td></tr></table></figure>\n<p>测试<br><code>游览器输入IP地址，出现Tomcat测试页面代表完成</code></p>\n","categories":["operations"],"tags":["Linux","Tomcat","JDK"]},{"title":"常用的linux命令","url":"/2025/11/06/%E5%B8%B8%E7%94%A8%E7%9A%84linux%E5%91%BD%E4%BB%A4/","content":"<h2 id=\"清理linux系统中的缓存-生产环境慎用\"><a href=\"#清理linux系统中的缓存-生产环境慎用\" class=\"headerlink\" title=\"清理linux系统中的缓存(生产环境慎用!)\"></a>清理linux系统中的缓存(生产环境慎用!)</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">echo 3 &gt; /proc/sys/vm/drop_caches</span><br></pre></td></tr></table></figure>\n<p><code>drop_caches 文件允许三个不同的值： 1: 只清空页面缓存。 2: 只清空目录项和inode。 3: 清空页面缓存、目录项和inode。</code></p>\n<h2 id=\"比较文件内容差异\"><a href=\"#比较文件内容差异\" class=\"headerlink\" title=\"比较文件内容差异\"></a>比较文件内容差异</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">diff a.txt b.txt     #正常比较</span><br><span class=\"line\">diff -c a.txt b.txt    #以上下文方式比较</span><br><span class=\"line\">diff -u a.txt b.txt    #联合方式比较</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"查看操作系统版本信息\"><a href=\"#查看操作系统版本信息\" class=\"headerlink\" title=\"查看操作系统版本信息\"></a>查看操作系统版本信息</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cat /etc/redhat-release</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"统计出现相同行的次数\"><a href=\"#统计出现相同行的次数\" class=\"headerlink\" title=\"统计出现相同行的次数\"></a>统计出现相同行的次数</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">uniq -c</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"标准错误重定向到标准输出的位置\"><a href=\"#标准错误重定向到标准输出的位置\" class=\"headerlink\" title=\"标准错误重定向到标准输出的位置\"></a>标准错误重定向到标准输出的位置</h2><p><code>2 是标准错误的文件描述符，1 是标准输出的文件描述符。而 &gt;&amp; 表示将一个文件描述符重定向到另一个文件描述符，1 表示标准输出。因此，2&gt;&amp;1 就表示将标准错误重定向到标准输出的位置</code></p>\n<h2 id=\"要在Linux系统中添加一个HTTP代理，可以按照以下步骤进行操作：\"><a href=\"#要在Linux系统中添加一个HTTP代理，可以按照以下步骤进行操作：\" class=\"headerlink\" title=\"要在Linux系统中添加一个HTTP代理，可以按照以下步骤进行操作：\"></a>要在Linux系统中添加一个HTTP代理，可以按照以下步骤进行操作：</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">#代理</span><br><span class=\"line\">先在Clash上开启Allow LAN,并设置代理端口8888</span><br><span class=\"line\"># 在终端上输入，代表代理</span><br><span class=\"line\">export http_proxy=http://10.31.162.98:8888</span><br><span class=\"line\"># -x将IP地址+端口添加在前面就可以在github链接上下载了</span><br><span class=\"line\">curl -x http://10.31.162.98:8888 -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><span class=\"line\">#取消代理</span><br><span class=\"line\">unset http_proxy </span><br><span class=\"line\">#重启</span><br><span class=\"line\">取消代理后如果不能ping就重启下，reboot</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Toolbox"]},{"title":"常用脚本","url":"/2025/11/06/%E5%B8%B8%E7%94%A8%E8%84%9A%E6%9C%AC/","content":"<h2 id=\"IP质量检测\"><a href=\"#IP质量检测\" class=\"headerlink\" title=\"IP质量检测\"></a>IP质量检测</h2><figure class=\"highlight scss\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -Ls IP.Check.Place)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"融合怪\"><a href=\"#融合怪\" class=\"headerlink\" title=\"融合怪\"></a>融合怪</h2><figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -L https:<span class=\"regexp\">//gi</span>tlab.com/spiritysdx/za/-<span class=\"regexp\">/raw/main</span>/ecs.sh -o ecs.sh &amp;&amp; <span class=\"keyword\">chmod</span> +<span class=\"keyword\">x</span> ecs.sh &amp;&amp; bash ecs.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"线路测试\"><a href=\"#线路测试\" class=\"headerlink\" title=\"线路测试\"></a>线路测试</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl https://raw.githubusercontent.com/zhucaidan/mtr_trace/main/mtr_trace.sh|bash  <span class=\"comment\"># 检测回程脚本</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"综合工具箱\"><a href=\"#综合工具箱\" class=\"headerlink\" title=\"综合工具箱\"></a>综合工具箱</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -O box.sh https://raw.githubusercontent.com/BlueSkyXN/SKY-BOX/main/box.sh &amp;&amp; <span class=\"built_in\">chmod</span> +x box.sh &amp;&amp; clear &amp;&amp; ./box.sh++</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"VPS工具箱\"><a href=\"#VPS工具箱\" class=\"headerlink\" title=\"VPS工具箱\"></a>VPS工具箱</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -fsSL https://raw.githubusercontent.com/eooce/ssh_tool/main/ssh_tool.sh -o ssh_tool.sh &amp;&amp; <span class=\"built_in\">chmod</span> +x ssh_tool.sh &amp;&amp; ./ssh_tool.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"最全脚本\"><a href=\"#最全脚本\" class=\"headerlink\" title=\"最全脚本\"></a>最全脚本</h2><p><strong>kejilin</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -sS -O https://github.7boe.top/https://raw.githubusercontent.com/kejilion/sh/main/kejilion.sh &amp;&amp; <span class=\"built_in\">chmod</span> +x kejilion.sh &amp;&amp; ./kejilion.sh</span><br></pre></td></tr></table></figure>\n\n<p><strong>ednova脚本</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -P /root -N https://cdn.jsdelivr.net/gh/ednovas/vpstoolbox@main/ednovastool.sh &amp;&amp; <span class=\"built_in\">chmod</span> +x ednovastool.sh &amp;&amp; ./ednovastool.sh</span><br></pre></td></tr></table></figure>\n\n<p><strong>jcnf 常用脚本工具包</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -O jcnfbox.sh https://raw.githubusercontent.com/Netflixxp/jcnf-box/main/jcnfbox.sh &amp;&amp; <span class=\"built_in\">chmod</span> +x jcnfbox.sh &amp;&amp; clear &amp;&amp; ./jcnfbox.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"bbr内核加速最全脚本\"><a href=\"#bbr内核加速最全脚本\" class=\"headerlink\" title=\"bbr内核加速最全脚本\"></a>bbr内核加速最全脚本</h2><p><strong>不卸载内核</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget --no-check-certificate -O tcpx.sh https://raw.githubusercontent.com/ylx2016/Linux-NetSpeed/master/tcpx.sh</span><br></pre></td></tr></table></figure>\n\n<p><strong>卸载内核</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -O tcp.sh <span class=\"string\">&quot;https://github.com/ylx2016/Linux-NetSpeed/raw/master/tcp.sh&quot;</span> &amp;&amp; <span class=\"built_in\">chmod</span> +x tcp.sh &amp;&amp; ./tcp.sh </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"一键分区挂载\"><a href=\"#一键分区挂载\" class=\"headerlink\" title=\"一键分区挂载\"></a>一键分区挂载</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(wget --no-check-certificate -qO- https://download.bt.cn/tools/auto_disk.sh) /website      <span class=\"comment\">#/后面是你要挂载到的位置</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"一键DD脚本\"><a href=\"#一键DD脚本\" class=\"headerlink\" title=\"一键DD脚本\"></a>一键DD脚本</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -N --no-check-certificate https://down.vpsaff.net/linux/dd/network-reinstall-os.sh &amp;&amp; \\</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x network-reinstall-os.sh &amp;&amp; ./network-reinstall-os.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"换源\"><a href=\"#换源\" class=\"headerlink\" title=\"换源\"></a>换源</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://linuxmirrors.cn/main.sh)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装docker\"><a href=\"#安装docker\" class=\"headerlink\" title=\"安装docker\"></a>安装docker</h2><h3 id=\"官方Docker\"><a href=\"#官方Docker\" class=\"headerlink\" title=\"官方Docker\"></a>官方Docker</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -sSL https://get.docker.com/ | sh</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"一键docker脚本\"><a href=\"#一键docker脚本\" class=\"headerlink\" title=\"一键docker脚本\"></a>一键docker脚本</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/SuperManito/LinuxMirrors/raw/main/DockerInstallation.sh)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"流控脚本\"><a href=\"#流控脚本\" class=\"headerlink\" title=\"流控脚本\"></a>流控脚本</h2><figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -O fast.<span class=\"built_in\">bin</span> <span class=\"string\">&quot;https://daloradius.coding.net/p/fast/git/raw/master/fast-3.0.bin&quot;</span> &amp;&amp; chmod +x fast.<span class=\"built_in\">bin</span> &amp;&amp; ./fast.<span class=\"built_in\">bin</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>Python</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -LO klutztech.com/k &amp;&amp; bash k</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"测试速度\"><a href=\"#测试速度\" class=\"headerlink\" title=\"测试速度\"></a>测试速度</h2><p><strong>三网测速</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sL res.yserver.ink/taier.sh)</span><br></pre></td></tr></table></figure>\n\n<p><strong>三网</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -Lso- https://git.io/superspeed_uxh)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"海外\"><a href=\"#海外\" class=\"headerlink\" title=\"海外\"></a>海外</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -qO- git.io/superbench.sh | bash</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"网络测速\"><a href=\"#网络测速\" class=\"headerlink\" title=\"网络测速\"></a>网络测速</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -N --no-check-certificate https://raw.githubusercontent.com/FunctionClub/ZBench/master/ZBench-CN.sh &amp;&amp; bash ZBench-CN.sh</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"单线程测试\"><a href=\"#单线程测试\" class=\"headerlink\" title=\"单线程测试\"></a>单线程测试</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -Lso- https://bench.im/hyperspeed)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"SPEEDTEST官方脚本\"><a href=\"#SPEEDTEST官方脚本\" class=\"headerlink\" title=\"SPEEDTEST官方脚本\"></a>SPEEDTEST官方脚本</h3><figure class=\"highlight ruby\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -s <span class=\"symbol\">https:</span>/<span class=\"regexp\">/packagecloud.io/install</span><span class=\"regexp\">/repositories/ookla</span><span class=\"regexp\">/speedtest-cli/script</span>.deb.sh |<span class=\"params\"> sudo bash</span></span><br><span class=\"line\"><span class=\"params\"></span></span><br><span class=\"line\"><span class=\"params\">apt-get install speedtest</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"全速测试\"><a href=\"#全速测试\" class=\"headerlink\" title=\"全速测试\"></a>全速测试</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -fsL https://ilemonra.in/LemonBenchIntl | bash -s fast</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"四网测试\"><a href=\"#四网测试\" class=\"headerlink\" title=\"四网测试\"></a>四网测试</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -O jcnf.sh https://raw.githubusercontent.com/Netflixxp/jcnfbesttrace/main/jcnf.sh</span><br><span class=\"line\"></span><br><span class=\"line\">bash jcnf.sh</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"三网测速脚本\"><a href=\"#三网测速脚本\" class=\"headerlink\" title=\"三网测速脚本\"></a>三网测速脚本</h3><p><strong>线路测试</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl https://raw.githubusercontent.com/zhanghanyun/backtrace/main/install.sh -sSf | sh</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"科学上网\"><a href=\"#科学上网\" class=\"headerlink\" title=\"科学上网\"></a>科学上网</h1><p><strong>Argo</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(wget -qO- https://raw.githubusercontent.com/fscarmen/argox/main/argox.sh)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"最全脚本-1\"><a href=\"#最全脚本-1\" class=\"headerlink\" title=\"最全脚本\"></a>最全脚本</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash -c <span class=\"string\">&quot;<span class=\"subst\">$(curl -fsSL https://raw.githubusercontent.com/JeannieStudio/all_install/master/SixForOne_install.sh)</span>&quot;</span>  //8合一脚本</span><br></pre></td></tr></table></figure>\n\n<p><strong>BBR加速</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /usr/src &amp;&amp; wget -N --no-check-certificate <span class=\"string\">&quot;https://raw.githubusercontent.com/chiakge/Linux-NetSpeed/master/tcp.sh&quot;</span> &amp;&amp; <span class=\"built_in\">chmod</span> +x tcp.sh &amp;&amp; ./tcp.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"hysteria2\"><a href=\"#hysteria2\" class=\"headerlink\" title=\"hysteria2\"></a>hysteria2</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -fsSL https://github.com/liuoqu444/sing-box-reality-hysteria2/raw/main/reality_hy2_ws.sh)</span><br></pre></td></tr></table></figure>\n\n<p><strong>Bash</strong></p>\n<p><strong>二次元</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -N --no-check-certificate https://raw.githubusercontent.com/Misaka-blog/hysteria-install/main/hy2/hysteria.sh &amp;&amp; bash hysteria.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"SSR安装\"><a href=\"#SSR安装\" class=\"headerlink\" title=\"SSR安装\"></a>SSR安装</h2><p><strong>逗比大神(ToyoDAdoubi)</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -N --no-check-certificate https://raw.githubusercontent.com/ToyoDAdoubi/doubi/master/ssr.sh &amp;&amp; <span class=\"built_in\">chmod</span> +x ssr.sh &amp;&amp; bash ssr.sh</span><br></pre></td></tr></table></figure>\n\n<p><strong>M3chD09大佬的“Shadowsocks+WS+TLS+CDN”一键搭建脚本</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -O ubuntu-ss-install.sh https://github.com/M3chD09/shadowsocks-with-v2ray-plugin-install/raw/master/ubuntu-ss-install.sh</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x ubuntu-ss-install.sh</span><br><span class=\"line\">./ubuntu-ss-install.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"v2ray安装\"><a href=\"#v2ray安装\" class=\"headerlink\" title=\"v2ray安装\"></a>v2ray安装</h2><p><strong>官方</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -s -L https://git.io/v2ray.sh)</span><br></pre></td></tr></table></figure>\n\n<p><strong>multi-v2ray多用户管理脚本</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> &lt;(curl -sL https://multi.netlify.app/v2ray.sh) --zh</span><br></pre></td></tr></table></figure>\n\n<p><strong>v2ray+nginx+ws+tls</strong></p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -N --<span class=\"keyword\">no</span>-check-certificate -<span class=\"keyword\">q</span> -O install.sh <span class=\"string\">&quot;https://raw.githubusercontent.com/wulabing/V2Ray_ws-tls_bash_onekey/master/install.sh&quot;</span> &amp;&amp; <span class=\"keyword\">chmod</span> +<span class=\"keyword\">x</span> install.sh &amp;&amp; bash install.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"TROJAN系列安装\"><a href=\"#TROJAN系列安装\" class=\"headerlink\" title=\"TROJAN系列安装\"></a>TROJAN系列安装</h2><p><strong>Trojan-Go</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash -c <span class=\"string\">&quot;<span class=\"subst\">$(curl -fsSL https://raw.githubusercontent.com/JeannieStudio/all_install/master/trojan-go_install.sh)</span>&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p><strong>官方一键</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> &lt;(curl -sL https://git.io/trojan-install)</span><br></pre></td></tr></table></figure>\n\n<p><strong>二合一脚本</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -O https://raw.githubusercontent.com/jinwyp/one_click_script/master/trojan_v2ray_install.sh &amp;&amp; <span class=\"built_in\">chmod</span> +x ./trojan_v2ray_install.sh &amp;&amp; ./trojan_v2ray_install.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"x-ui安装\"><a href=\"#x-ui安装\" class=\"headerlink\" title=\"x-ui安装\"></a><strong>x-ui安装</strong></h2><p><strong>官网</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -Ls https://raw.githubusercontent.com/vaxilu/x-ui/master/install.sh)</span><br></pre></td></tr></table></figure>\n\n<p><strong>魔改 英文-3xui</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -Ls https://raw.githubusercontent.com/mhsanaei/3x-ui/master/install.sh)</span><br></pre></td></tr></table></figure>\n\n<p><strong>FranzKafkaYu</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -Ls https://raw.githubusercontent.com/FranzKafkaYu/x-ui/956bf85bbac978d56c0e319c5fac2d6db7df9564/install.sh)</span><br></pre></td></tr></table></figure>\n\n<p><strong>美化 xui</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -Ls https://raw.githubusercontent.com/diditra/x-ui/master/install.sh)</span><br></pre></td></tr></table></figure>\n\n<p><strong>魔改版</strong></p>\n<figure class=\"highlight ruby\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -<span class=\"title class_\">Ls</span> <span class=\"symbol\">https:</span>/<span class=\"regexp\">/gitlab.com/rwkgyg</span><span class=\"regexp\">/x-ui-yg/raw</span><span class=\"regexp\">/main/install</span>.sh)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"跑分\"><a href=\"#跑分\" class=\"headerlink\" title=\"跑分\"></a>跑分</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://s3.amazonaws.com/cloudbench/software/UnixBench5.1.3.tgz</span><br><span class=\"line\">tar -xf UnixBench5.1.3.tgz</span><br><span class=\"line\"><span class=\"built_in\">cd</span> UnixBench/</span><br><span class=\"line\">make all</span><br><span class=\"line\">./Run</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"流媒体测试\"><a href=\"#流媒体测试\" class=\"headerlink\" title=\"流媒体测试\"></a>流媒体测试</h2><h3 id=\"全媒体测试\"><a href=\"#全媒体测试\" class=\"headerlink\" title=\"全媒体测试\"></a>全媒体测试</h3><figure class=\"highlight scss\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -L -s check.unlock.media)</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"奈飞\"><a href=\"#奈飞\" class=\"headerlink\" title=\"奈飞\"></a>奈飞</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget -O nf https://github.com/sjlleo/netflix-verify/releases/download/2.5/nf_2.5_linux_amd64 &amp;&amp; <span class=\"built_in\">chmod</span> +x nf &amp;&amp; clear &amp;&amp; ./nf</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"抓取节点脚本\"><a href=\"#抓取节点脚本\" class=\"headerlink\" title=\"抓取节点脚本\"></a>抓取节点脚本</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://raw.githubusercontent.com/slobys/proxypool/master/onekey_install.sh &amp;&amp; <span class=\"built_in\">chmod</span> +x onekey_install.sh &amp;&amp; ./onekey_install.sh</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"DD-系统\"><a href=\"#DD-系统\" class=\"headerlink\" title=\"DD 系统\"></a>DD 系统</h2><h3 id=\"Windows-DD-Linux\"><a href=\"#Windows-DD-Linux\" class=\"headerlink\" title=\"Windows DD Linux\"></a>Windows DD Linux</h3><p>开启tls1.2</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Ssl3 -bor [Net.SecurityProtocolType]::Tls -bor [Net.SecurityProtocolType]::Tls11 -bor [Net.SecurityProtocolType]::Tls12</span><br></pre></td></tr></table></figure>\n\n<p>下载命令</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Invoke-WebRequest -Uri https://raw.githubusercontent.com/bin456789/reinstall/main/reinstall.bat -OutFile reinstall.bat</span><br></pre></td></tr></table></figure>\n\n<p>开始dd</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">reinstall.bat debian-11</span><br></pre></td></tr></table></figure>\n\n<p>重启</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">shutdown /r /t 0</span><br></pre></td></tr></table></figure>\n\n<p>root<br>密码是123@@</p>\n<h2 id=\"转发面板\"><a href=\"#转发面板\" class=\"headerlink\" title=\"转发面板\"></a>转发面板</h2><p><strong>极光面板</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -fsSL https://raw.githubusercontent.com/Aurora-Admin-Panel/deploy/main/install.sh)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Windows激活\"><a href=\"#Windows激活\" class=\"headerlink\" title=\"Windows激活\"></a>Windows激活</h2><p><strong>一键脚本</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">irm https://massgrave.dev/get | iex</span><br></pre></td></tr></table></figure>\n\n<p><strong>搭建KMS</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget --no-check-certificate https://raw.githubusercontent.com/Mr-xn/kms-server-deploy/master/kms-server-deploy.sh &amp;&amp; bash kms-server-deploy.sh</span><br></pre></td></tr></table></figure>\n\n<p><strong>数字认证</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">irm http://d.cmdpe.com/h|iex</span><br></pre></td></tr></table></figure>\n\n<p><strong>KMS激活</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">irm http://d.cmdpe.com/k|iex</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Toolbox","Script"]},{"title":"日常工作（更新中）","url":"/2025/11/06/%E6%97%A5%E5%B8%B8%E5%B7%A5%E4%BD%9C%EF%BC%88%E6%9B%B4%E6%96%B0%E4%B8%AD%EF%BC%89/","content":"<p>日常工作中常用的磁盘、内存清理命令和数据备份脚本整理如下。</p>\n<h2 id=\"磁盘-内存-清理\"><a href=\"#磁盘-内存-清理\" class=\"headerlink\" title=\"磁盘&#x2F;内存 清理\"></a>磁盘&#x2F;内存 清理</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看磁盘大小</span></span><br><span class=\"line\"><span class=\"built_in\">df</span> -Th</span><br><span class=\"line\"><span class=\"comment\"># 查看每个目录下的文件大小</span></span><br><span class=\"line\"><span class=\"built_in\">du</span> -sh /*</span><br><span class=\"line\"><span class=\"built_in\">du</span> -sh /*/*</span><br><span class=\"line\"><span class=\"comment\"># 查看目录文件大小</span></span><br><span class=\"line\"><span class=\"built_in\">du</span> -h</span><br><span class=\"line\"><span class=\"comment\"># 数字化服务器占磁盘大的目录</span></span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf /docker/zentao/www/zentaopms/tmp</span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf /usr/tmp</span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf /var/log</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看内存使用率</span></span><br><span class=\"line\">free -m</span><br><span class=\"line\"><span class=\"comment\"># 清理缓存</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># maven仓库地址</span></span><br><span class=\"line\">/usr/local/repository/maven_repo/com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看java服务内存</span></span><br><span class=\"line\">jps -l</span><br><span class=\"line\">jmap -heap PID号</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># top里的RES: 进程使用的物理内存量 (Resident Memory)</span></span><br><span class=\"line\"><span class=\"comment\"># RES的数值 / 1024 得出的结果就是服务使用的内存</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"数据备份\"><a href=\"#数据备份\" class=\"headerlink\" title=\"数据备份\"></a>数据备份</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysqldump 逻辑备份</span><br><span class=\"line\">mysqldump -u用户 -p密码 库名 [表名] &gt; xxx.sql</span><br><span class=\"line\">mysql -u用户 -p密码 库名 &lt; xxx.sql</span><br><span class=\"line\"><span class=\"comment\"># MySQL数据库备份</span></span><br><span class=\"line\">[root@figure ~]# <span class=\"built_in\">ls</span></span><br><span class=\"line\">mul_java  mysql_db  nexus.log  nexus.tar  nohup.out</span><br><span class=\"line\">[root@figure ~]# <span class=\"built_in\">cd</span> mysql_db/</span><br><span class=\"line\">[root@figure mysql_db]# mysqldump -uroot -p<span class=\"string\">&#x27;Qingfeng@123&#x27;</span> zj_shops_dev &gt; zj_shops_dev.sql</span><br><span class=\"line\">[root@figure mysql_db]# <span class=\"built_in\">ls</span></span><br><span class=\"line\">dev.sql  mysql.sql  nacos.sql  test.sql  zj_shops_beta.sql  zj_shops_dev.sql  zj_shops_test.sql  zj_shops_uat.sql</span><br><span class=\"line\"></span><br><span class=\"line\">示例：</span><br><span class=\"line\">mysql&gt; show databases;</span><br><span class=\"line\">[root@localhost cha]# mysqldump -uroot -p<span class=\"string\">&#x27;1&#x27;</span> ku &gt; ku.sql</span><br><span class=\"line\">[root@localhost cha]# vim ku.sql</span><br><span class=\"line\">\tcreate database ku;</span><br><span class=\"line\">\tuse ku;\t\t//看是否需要添加以上两行</span><br><span class=\"line\">\tDROP TABLE IF EXISTS `biao`;</span><br><span class=\"line\">mysql&gt; drop database ku;</span><br><span class=\"line\">mysql&gt; show databases;\t//再查看下</span><br><span class=\"line\">[root@localhost cha]# mysql -uroot -p<span class=\"string\">&#x27;1&#x27;</span> &lt; ku.sql\t\t//回复数据</span><br><span class=\"line\">mysql&gt; show databases;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># java服务的jar包备份--2个方案，二选一就可以</span></span><br><span class=\"line\">[root@uat ~]# <span class=\"built_in\">ls</span></span><br><span class=\"line\">jarfile</span><br><span class=\"line\">[root@uat ~]# <span class=\"built_in\">cp</span> jarfile/ jarfile_bak/ -r\t\t<span class=\"comment\"># 拷贝目录</span></span><br><span class=\"line\">[root@uat ~]# tar czvf jarfile.tar.gz ./jarfile\t\t<span class=\"comment\"># 将目录打包成tar.gz的包</span></span><br><span class=\"line\">[root@uat ~]# <span class=\"built_in\">ls</span></span><br><span class=\"line\">jarfile  jarfile_bak  jarfile.tar.gz</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"MySQL数据每日全量备份\"><a href=\"#MySQL数据每日全量备份\" class=\"headerlink\" title=\"MySQL数据每日全量备份\"></a>MySQL数据每日全量备份</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建目录</span></span><br><span class=\"line\">[root@localhost ~]# <span class=\"built_in\">mkdir</span> /opt/mysql_back/backup</span><br><span class=\"line\">[root@localhost ~]# <span class=\"built_in\">mkdir</span> /opt/mysql_back/back_log</span><br><span class=\"line\"><span class=\"comment\"># 创建脚本</span></span><br><span class=\"line\">[root@localhost mysql_back]# <span class=\"built_in\">cat</span> /opt/mysql_back/mysql_db_back.sh </span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># Description: MySQL全量备份，备份所有库</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 用户名、密码</span></span><br><span class=\"line\">user=<span class=\"string\">&quot;root&quot;</span></span><br><span class=\"line\">password=<span class=\"string\">&quot;Qingfeng@123&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 备份开始时间</span></span><br><span class=\"line\">beginTime=$(<span class=\"built_in\">date</span> +<span class=\"string\">&quot;%Y年%m月%d日 %H:%M:%S&quot;</span>)</span><br><span class=\"line\"><span class=\"comment\"># 备份结束时间</span></span><br><span class=\"line\">endTime=$(<span class=\"built_in\">date</span> +<span class=\"string\">&quot;%Y年%m月%d日 %H:%M:%S&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 全量备份目录，提前手动创建这个目录</span></span><br><span class=\"line\">bakDir=<span class=\"string\">&quot;/opt/mysql_back/backup&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 日志文件</span></span><br><span class=\"line\">logFile=<span class=\"string\">&quot;/opt/mysql_back/back_log/fullybak.log&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建备份目录</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$bakDir</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$bakDir</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;全量备份开始: <span class=\"variable\">$beginTime</span>&quot;</span> &gt;&gt; <span class=\"string\">&quot;<span class=\"variable\">$logFile</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 全量备份</span></span><br><span class=\"line\">nowDate=$(<span class=\"built_in\">date</span> +<span class=\"string\">&quot;%Y%m%d_%H%M%S&quot;</span>)</span><br><span class=\"line\">dumpFile=<span class=\"string\">&quot;<span class=\"variable\">$&#123;nowDate&#125;</span>_alldb.sql&quot;</span></span><br><span class=\"line\">gzDumpFile=<span class=\"string\">&quot;<span class=\"variable\">$&#123;nowDate&#125;</span>_alldb.sql.tgz&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 备份所有数据库</span></span><br><span class=\"line\">mysqldump -u<span class=\"string\">&quot;<span class=\"variable\">$user</span>&quot;</span> -p<span class=\"string\">&quot;<span class=\"variable\">$password</span>&quot;</span> -A -E -q --flush-privileges --single-transaction &gt; <span class=\"string\">&quot;<span class=\"variable\">$dumpFile</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 判断备份是否成功</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ $? -eq 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"comment\"># 将备份SQL打包</span></span><br><span class=\"line\">  tar -zvcf <span class=\"string\">&quot;<span class=\"variable\">$gzDumpFile</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$dumpFile</span>&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">rm</span> <span class=\"string\">&quot;<span class=\"variable\">$dumpFile</span>&quot;</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;全量备份结束: <span class=\"variable\">$endTime</span>, 备份文件: <span class=\"variable\">$gzDumpFile</span> ! SUCCESS !&quot;</span> &gt;&gt; <span class=\"string\">&quot;<span class=\"variable\">$logFile</span>&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;全量备份结束: <span class=\"variable\">$endTime</span>, 备份文件: <span class=\"variable\">$gzDumpFile</span> ! ERROR !&quot;</span> &gt;&gt; <span class=\"string\">&quot;<span class=\"variable\">$logFile</span>&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除7天前的备份</span></span><br><span class=\"line\">find <span class=\"string\">&quot;<span class=\"variable\">$bakDir</span>&quot;</span> -name <span class=\"string\">&quot;*.sql.tgz&quot;</span> -<span class=\"built_in\">type</span> f -mtime +7 -<span class=\"built_in\">exec</span> <span class=\"built_in\">rm</span> -rf &#123;&#125; \\; &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\"><span class=\"built_in\">exit</span> 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 授予脚本执行权限</span></span><br><span class=\"line\">[root@localhost mysql_back]# <span class=\"built_in\">chmod</span> +x /opt/mysql_back/mysql_db_back.sh </span><br><span class=\"line\"><span class=\"comment\"># 创建定时计划任务</span></span><br><span class=\"line\">[root@localhost mysql_back]# crontab -e</span><br><span class=\"line\">0 1 * * * /bin/bash -x /opt/mysql_back/mysql_db_back.sh &gt;/dev/null 2&gt;&amp;1\t\t<span class=\"comment\"># 在每天的第1小时（凌晨1点）执行脚本。</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"挖矿程序清理\"><a href=\"#挖矿程序清理\" class=\"headerlink\" title=\"挖矿程序清理\"></a>挖矿程序清理</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 禁止服务开机自启</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">disable</span> c3pool_miner.service</span><br><span class=\"line\"><span class=\"comment\"># 查看状态</span></span><br><span class=\"line\">systemctl status c3pool_miner.service </span><br><span class=\"line\"><span class=\"comment\"># 停止服务</span></span><br><span class=\"line\">systemctl stop c3pool_miner.service </span><br><span class=\"line\">systemctl status c3pool_miner.service </span><br><span class=\"line\"><span class=\"comment\"># 删除服务的system文件</span></span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf /etc/systemd/system/c3pool_miner.service</span><br><span class=\"line\">systemctl list-units --<span class=\"built_in\">type</span>=service</span><br><span class=\"line\">systemctl list-units --<span class=\"built_in\">type</span>=service | grep c3pool</span><br><span class=\"line\">htop</span><br><span class=\"line\">ps -ef</span><br><span class=\"line\">ps -ef |grep xmrig</span><br><span class=\"line\">find / -name xmrig </span><br><span class=\"line\"><span class=\"built_in\">ls</span> -lah</span><br><span class=\"line\"><span class=\"comment\"># 删除挖矿的脚本执行文件</span></span><br><span class=\"line\"><span class=\"built_in\">rm</span> -rf c3pool/</span><br><span class=\"line\">find / -name xmrig</span><br><span class=\"line\"><span class=\"comment\"># 禁止域名访问</span></span><br><span class=\"line\">iptables -A OUTPUT -p tcp -d *.c3pool.org --dport 80 -j DROP</span><br><span class=\"line\">iptables -A OUTPUT -p tcp -d <span class=\"string\">&#x27;*.c3pool.org&#x27;</span> --dport 80 -j DROP</span><br><span class=\"line\">iptables -A OUTPUT -p tcp -d <span class=\"string\">&quot;*.c3pool.org&quot;</span> --dport 80 -j DROP</span><br><span class=\"line\">iptables -A OUTPUT -p tcp -d download.c3pool.org --dport 80 -j DROP</span><br><span class=\"line\">iptables -A OUTPUT -p tcp -d c3pool.org --dport 80 -j DROP</span><br><span class=\"line\">ping c3pool.org</span><br><span class=\"line\"><span class=\"comment\"># 保持记录</span></span><br><span class=\"line\">iptables save</span><br><span class=\"line\">service iptables save</span><br><span class=\"line\"><span class=\"comment\"># 禁止执行脚本文件，并保存</span></span><br><span class=\"line\">iptables -I INPUT -m string --string <span class=\"string\">&quot;setup_c3pool_miner.sh&quot;</span> --algo bm -j DROP</span><br><span class=\"line\">service iptables save</span><br><span class=\"line\"><span class=\"comment\"># 查看保存记录</span></span><br><span class=\"line\">iptables -L</span><br><span class=\"line\">iptables-save &gt; /etc/sysconfig/iptables</span><br><span class=\"line\">vim /etc/rc.d/rc.local</span><br><span class=\"line\">iptables-restore &lt; /etc/sysconfig/iptables\t\t<span class=\"comment\">#添加这内容</span></span><br><span class=\"line\">vim /etc/sysconfig/iptables\t\t<span class=\"comment\"># 可以看到已经添加了一下内容</span></span><br><span class=\"line\">-A INPUT -m string --string <span class=\"string\">&quot;setup_c3pool_miner.sh&quot;</span> --algo bm --to 65535 -j DROP</span><br><span class=\"line\">-A OUTPUT -d 154.201.90.241/32 -p tcp -m tcp --dport 80 -j DROP</span><br><span class=\"line\">-A OUTPUT -d 154.12.21.70/32 -p tcp -m tcp --dport 80 -j DROP</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"阿里云漏洞恢复，禁用api的访问\"><a href=\"#阿里云漏洞恢复，禁用api的访问\" class=\"headerlink\" title=\"阿里云漏洞恢复，禁用api的访问\"></a>阿里云漏洞恢复，禁用api的访问</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 问题：</span></span><br><span class=\"line\">Spring Boot Actuator 未授权访问远程代码执行漏洞【远程扫描】RASP支持实时防护</span><br><span class=\"line\"><span class=\"comment\"># 详情</span></span><br><span class=\"line\">uat</span><br><span class=\"line\">47.116.200.165 公  172.31.141.179 私</span><br><span class=\"line\">漏洞地址：http://47.116.200.165:8090/actuator</span><br><span class=\"line\">返回特征：nv-toMatch<span class=\"string\">&quot;:&#123;&quot;</span>href<span class=\"string\">&quot;:&quot;</span>http://47.116.200.165:8090/actuator/env/&#123;toMatch&#125;<span class=\"string\">&quot;,&quot;</span>templated<span class=\"string\">&quot;:true&#125;,&quot;</span><span class=\"built_in\">env</span><span class=\"string\">&quot;:&#123;&quot;</span>href<span class=\"string\">&quot;:&quot;</span>htt</span><br><span class=\"line\"><span class=\"comment\"># 解决：</span></span><br><span class=\"line\"><span class=\"comment\"># 在代理里添加禁止访问的二级目录</span></span><br><span class=\"line\">[root@prod-network conf.d]# <span class=\"built_in\">cat</span> prd-api.conf </span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen  881;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">                proxy_pass http://172.31.141.180:8090/;</span><br><span class=\"line\">                proxy_set_header Host <span class=\"variable\">$host</span>:<span class=\"variable\">$server_port</span>;</span><br><span class=\"line\">                proxy_set_header X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">                proxy_set_header X-Forwarded-For <span class=\"variable\">$proxy_add_x_forwarded_for</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location /doc.html &#123;\t\t\t\t<span class=\"comment\"># 访问api接口，返回403</span></span><br><span class=\"line\">                <span class=\"built_in\">return</span> 403;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ^~ /actuator/  &#123;\t\t\t<span class=\"comment\"># 补漏洞，添加以下这两个location</span></span><br><span class=\"line\">          deny all;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        location ^~ /actuator  &#123;</span><br><span class=\"line\">          deny all;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 问题</span></span><br><span class=\"line\">fastjson &lt;= 1.2.80 反序列化任意代码执行漏洞\tRASP支持实时防护</span><br><span class=\"line\"><span class=\"comment\"># 详情</span></span><br><span class=\"line\">路径：/root/jarfile/portal/zj-shop-portal.jar(BOOT-INF/lib/fastjson-1.2.7.jar)</span><br><span class=\"line\"><span class=\"comment\"># 解决</span></span><br><span class=\"line\">后端更代码漏洞</span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Toolbox","Script"]},{"title":"查看面板选项工具箱-函数定义","url":"/2025/01/09/%E6%9F%A5%E7%9C%8B%E9%9D%A2%E6%9D%BF%E9%80%89%E9%A1%B9%E5%B7%A5%E5%85%B7%E7%AE%B1-%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89/","content":"<h1 id=\"打印工具箱\"><a href=\"#打印工具箱\" class=\"headerlink\" title=\"打印工具箱\"></a>打印工具箱</h1><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># !/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#定义菜单函数</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">caidan</span></span> ()&#123;</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">-----------系统工具箱----------</span></span><br><span class=\"line\"><span class=\"string\">|       1.查看磁盘信息        |</span></span><br><span class=\"line\"><span class=\"string\">|       2.查看内存信息        |</span></span><br><span class=\"line\"><span class=\"string\">|       3.查看CPU信息         |</span></span><br><span class=\"line\"><span class=\"string\">|       4.查看网络信息        |</span></span><br><span class=\"line\"><span class=\"string\">|       5.查看进程信息        |</span></span><br><span class=\"line\"><span class=\"string\">|       6.退出                |</span></span><br><span class=\"line\"><span class=\"string\">-------------------------------</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># while循环选项操作</span></span><br><span class=\"line\"><span class=\"keyword\">while</span> :</span><br><span class=\"line\"><span class=\"keyword\">do</span></span><br><span class=\"line\">\tcaidan\t</span><br><span class=\"line\"><span class=\"built_in\">read</span> -p <span class=\"string\">&quot;请输出你的选择[1..6]&quot;</span> num</span><br><span class=\"line\"><span class=\"comment\"># case语句循环选项</span></span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"variable\">$num</span> <span class=\"keyword\">in</span></span><br><span class=\"line\">1)</span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====磁盘信息=====&quot;</span></span><br><span class=\"line\">\t<span class=\"built_in\">df</span> -hT</span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====磁盘信息=====&quot;</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">read</span> -p <span class=\"string\">&quot;继续y，退出n&quot;</span> yn</span><br><span class=\"line\">\t\t<span class=\"comment\">#if语句判断是否要继续面板选项</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> [ <span class=\"variable\">$yn</span> = y ];<span class=\"keyword\">then</span></span><br><span class=\"line\">\t\t\tclear</span><br><span class=\"line\">\t\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\t\t<span class=\"built_in\">exit</span> 88</span><br><span class=\"line\">\t\t<span class=\"keyword\">fi</span></span><br><span class=\"line\">;;</span><br><span class=\"line\">2)</span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====内存信息=====&quot;</span></span><br><span class=\"line\">\tfree -m</span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====内存信息=====&quot;</span></span><br><span class=\"line\">               <span class=\"built_in\">read</span> -p <span class=\"string\">&quot;继续y，退出n&quot;</span> yn</span><br><span class=\"line\">                <span class=\"keyword\">if</span> [ <span class=\"variable\">$yn</span> = y ];<span class=\"keyword\">then</span></span><br><span class=\"line\">                        clear</span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                        <span class=\"built_in\">exit</span> 88</span><br><span class=\"line\">                <span class=\"keyword\">fi</span></span><br><span class=\"line\">;;</span><br><span class=\"line\">3)</span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====CPU信息=====&quot;</span></span><br><span class=\"line\">\t<span class=\"built_in\">uptime</span></span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====CPU信息=====&quot;</span></span><br><span class=\"line\">               <span class=\"built_in\">read</span> -p <span class=\"string\">&quot;继续y，退出n&quot;</span> yn</span><br><span class=\"line\">                <span class=\"keyword\">if</span> [ <span class=\"variable\">$yn</span> = y ];<span class=\"keyword\">then</span></span><br><span class=\"line\">                        clear</span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                        <span class=\"built_in\">exit</span> 88</span><br><span class=\"line\">                <span class=\"keyword\">fi</span></span><br><span class=\"line\">;;</span><br><span class=\"line\">4)</span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====网络信息=====&quot;</span></span><br><span class=\"line\">\t<span class=\"built_in\">read</span> -p <span class=\"string\">&quot;请输入你要用的网络接口号&quot;</span> hao</span><br><span class=\"line\">\tnetstat -anpt | grep <span class=\"variable\">$hao</span></span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====网络信息=====&quot;</span></span><br><span class=\"line\">               <span class=\"built_in\">read</span> -p <span class=\"string\">&quot;继续y，退出n&quot;</span> yn</span><br><span class=\"line\">                <span class=\"keyword\">if</span> [ <span class=\"variable\">$yn</span> = y ];<span class=\"keyword\">then</span></span><br><span class=\"line\">                        clear</span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                        <span class=\"built_in\">exit</span> 88</span><br><span class=\"line\">                <span class=\"keyword\">fi</span></span><br><span class=\"line\">;;</span><br><span class=\"line\">5)</span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====进程信息=====&quot;</span></span><br><span class=\"line\">\t<span class=\"built_in\">read</span> -p <span class=\"string\">&quot;请输入你要查询的进程名&quot;</span> pss</span><br><span class=\"line\">\tps aux | grep <span class=\"variable\">$pss</span></span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=====进程信息=====&quot;</span></span><br><span class=\"line\">               <span class=\"built_in\">read</span> -p <span class=\"string\">&quot;继续y，退出n&quot;</span> yn</span><br><span class=\"line\">                <span class=\"keyword\">if</span> [ <span class=\"variable\">$yn</span> = y ];<span class=\"keyword\">then</span></span><br><span class=\"line\">                        clear</span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                        <span class=\"built_in\">exit</span> 88</span><br><span class=\"line\">                <span class=\"keyword\">fi</span></span><br><span class=\"line\">;;</span><br><span class=\"line\">6)</span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=======退出=======&quot;</span></span><br><span class=\"line\">\t<span class=\"built_in\">exit</span> 88</span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;=======退出=======&quot;</span></span><br><span class=\"line\">;;</span><br><span class=\"line\"></span><br><span class=\"line\">*)</span><br><span class=\"line\">\tcaidan</span><br><span class=\"line\">               <span class=\"built_in\">read</span> -p <span class=\"string\">&quot;继续y，退出n&quot;</span> yn</span><br><span class=\"line\">                <span class=\"keyword\">if</span> [ <span class=\"variable\">$yn</span> = y ];<span class=\"keyword\">then</span></span><br><span class=\"line\">                        clear</span><br><span class=\"line\">                <span class=\"keyword\">else</span></span><br><span class=\"line\">                        <span class=\"built_in\">break</span> 88</span><br><span class=\"line\">                <span class=\"keyword\">fi</span></span><br><span class=\"line\">;;</span><br><span class=\"line\"><span class=\"keyword\">esac</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Toolbox"]},{"title":"清风工具箱","url":"/2025/01/06/%E6%B8%85%E9%A3%8E%E5%B7%A5%E5%85%B7%E7%AE%B1/","content":"<p>本文介绍如何使用脚本快速的一键部署服务（工具箱一键脚本、添加swap分区、安装前&#x2F;后端软件包一键脚本）</p>\n<span id=\"more\"></span>\n\n<h2 id=\"工具箱一键脚本\"><a href=\"#工具箱一键脚本\" class=\"headerlink\" title=\"工具箱一键脚本\"></a>工具箱一键脚本</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/toolbox.sh)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/xbd666/kunlun/raw/master/kunlun_tool.sh)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"脚本一键安装MySQL-mariadb-并更改密码\"><a href=\"#脚本一键安装MySQL-mariadb-并更改密码\" class=\"headerlink\" title=\"脚本一键安装MySQL&#x2F;mariadb,并更改密码\"></a>脚本一键安装MySQL&#x2F;mariadb,并更改密码</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/MySQL_install.sh)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"添加swap分区–调用gitee仓库\"><a href=\"#添加swap分区–调用gitee仓库\" class=\"headerlink\" title=\"添加swap分区–调用gitee仓库\"></a>添加swap分区–调用gitee仓库</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/swap.sh)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装前-后端软件包一键脚本\"><a href=\"#安装前-后端软件包一键脚本\" class=\"headerlink\" title=\"安装前&#x2F;后端软件包一键脚本\"></a>安装前&#x2F;后端软件包一键脚本</h2><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">bash &lt;(curl -sSL https://gitee.com/xbd666/qingfeng/raw/master/Software_package.sh)</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"gitee仓库超连接\"><a href=\"#gitee仓库超连接\" class=\"headerlink\" title=\"gitee仓库超连接\"></a>gitee仓库超连接</h2><p><a href=\"https://gitee.com/xbd666/qingfeng\">gitee</a><br><a href=\"https://github.com/KKISO574/shell\">github</a></p>\n","categories":["operations"],"tags":["Linux","Toolbox","Script"]},{"title":"用户登入工具箱，注册","url":"/2025/01/09/%E7%94%A8%E6%88%B7%E7%99%BB%E5%85%A5%E5%B7%A5%E5%85%B7%E7%AE%B1%EF%BC%8C%E6%B3%A8%E5%86%8C/","content":"<h1 id=\"本脚本用于用户登入工具箱，注册\"><a href=\"#本脚本用于用户登入工具箱，注册\" class=\"headerlink\" title=\"本脚本用于用户登入工具箱，注册\"></a>本脚本用于用户登入工具箱，注册</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># !/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">#菜单函数</span><br><span class=\"line\">caidan()&#123;</span><br><span class=\"line\">cat &lt;&lt; EOF</span><br><span class=\"line\">===========菜单===========</span><br><span class=\"line\">||\t  1.登入\t||</span><br><span class=\"line\">||\t  2.注册\t||</span><br><span class=\"line\">||\t  3.退出\t||</span><br><span class=\"line\">==========================</span><br><span class=\"line\">EOF</span><br><span class=\"line\"># 定义选项</span><br><span class=\"line\">read -p &quot;请你输出你要的选项：&quot; num</span><br><span class=\"line\">case $num in</span><br><span class=\"line\">     1)dengru;;</span><br><span class=\"line\">     2)zhuce;;</span><br><span class=\"line\">     3)tuichu;;</span><br><span class=\"line\">esac</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"># 登入工具箱函数</span><br><span class=\"line\">dengru()&#123;</span><br><span class=\"line\">\tread -p &quot;请输入你的用户名：&quot; name</span><br><span class=\"line\">\tid $name &amp;&gt; /dev/null</span><br><span class=\"line\">\tif [ $? -eq 0 ];then</span><br><span class=\"line\">\t\tread -p &quot;请输入你的密码 ：&quot; pass</span><br><span class=\"line\">\t\t\tif [[ $&#123;#pass&#125; -ge 8  &amp;&amp; $pass =~ [a-z] &amp;&amp; $pass =~ [A-Z] &amp;&amp; $pass =~ [0-9] &amp;&amp; $pass =~ [^0-Z] ]];then</span><br><span class=\"line\">    \t\t\t\twhile :</span><br><span class=\"line\">\t\t\t\t\tdo</span><br><span class=\"line\">\t\t\t\t\t\tgongju</span><br><span class=\"line\">    \t\t\t\tread -p &quot;请你输入你需要的工具：&quot; gg</span><br><span class=\"line\">    \t\t\t\tcase $gg in</span><br><span class=\"line\">    \t\t\t\t\t1)</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====磁盘信息=====&quot;</span><br><span class=\"line\">\t\t\t\t\t\t\tdf -hT</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====磁盘信息=====&quot;</span><br><span class=\"line\">\t\t\t\t\t\tread -p &quot;继续y，退出n&quot; yn</span><br><span class=\"line\">\t\t\t\t\t\tif [ $yn = y ];then</span><br><span class=\"line\">\t\t\t\t\t\t\t\tclear</span><br><span class=\"line\">\t\t\t\t\t\telse</span><br><span class=\"line\">\t\t\t\t\t\t\texit 88</span><br><span class=\"line\">\t\t\t\t\t\tfi</span><br><span class=\"line\">\t\t\t\t\t\t;;</span><br><span class=\"line\">\t\t\t\t\t\t2)</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====内存信息=====&quot;</span><br><span class=\"line\">\t\t\t\t\t\t\tfree -m</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====内存信息=====&quot;</span><br><span class=\"line\">               \t\t\tread -p &quot;继续y，退出n&quot; yn</span><br><span class=\"line\">                \t\tif [ $yn = y ];then</span><br><span class=\"line\">                        \t\tclear</span><br><span class=\"line\">                \t\telse</span><br><span class=\"line\">                        \t\texit 88</span><br><span class=\"line\">                \t\tfi</span><br><span class=\"line\">\t\t\t\t\t\t;;</span><br><span class=\"line\">\t\t\t\t\t\t3)</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====CPU信息=====&quot;</span><br><span class=\"line\">\t\t\t\t\t\t\tuptime</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====CPU信息=====&quot;</span><br><span class=\"line\">               \t\t\tread -p &quot;继续y，退出n&quot; yn</span><br><span class=\"line\">                \t\tif [ $yn = y ];then</span><br><span class=\"line\">                        \t\tclear</span><br><span class=\"line\">                \t\telse</span><br><span class=\"line\">                        \t\texit 88</span><br><span class=\"line\">                \t\tfi</span><br><span class=\"line\">\t\t\t\t\t\t;;</span><br><span class=\"line\">\t\t\t\t\t\t4)</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====网络信息=====&quot;</span><br><span class=\"line\">\t\t\t\t\t\tread -p &quot;请输入你要用的网络接口号&quot; hao</span><br><span class=\"line\">\t\t\t\t\t\t\tnetstat -anpt | grep $hao</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====网络信息=====&quot;</span><br><span class=\"line\">               \t\t\tread -p &quot;继续y，退出n&quot; yn</span><br><span class=\"line\">                \t\tif [ $yn = y ];then</span><br><span class=\"line\">                        \t\tclear</span><br><span class=\"line\">                \t\telse</span><br><span class=\"line\">                        \t\texit 88</span><br><span class=\"line\">                \t\tfi</span><br><span class=\"line\">\t\t\t\t\t\t;;</span><br><span class=\"line\">\t\t\t\t\t\t5)</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====进程信息=====&quot;</span><br><span class=\"line\">\t\t\t\t\t\tread -p &quot;请输入你要查询的进程名&quot; pss</span><br><span class=\"line\">\t\t\t\t\t\t\tps aux | grep $pss</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=====进程信息=====&quot;</span><br><span class=\"line\">               \t\t\tread -p &quot;继续y，退出n&quot; yn</span><br><span class=\"line\">                \t\tif [ $yn = y ];then</span><br><span class=\"line\">                        \t\tclear</span><br><span class=\"line\">                \t\telse</span><br><span class=\"line\">                        \t\texit 88</span><br><span class=\"line\">                \t\tfi</span><br><span class=\"line\">\t\t\t\t\t\t;;</span><br><span class=\"line\">\t\t\t\t\t\t6)</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=======退出=======&quot;</span><br><span class=\"line\">\t\t\t\t\t\t\texit 88</span><br><span class=\"line\">\t\t\t\t\t\techo &quot;=======退出=======&quot;</span><br><span class=\"line\">\t\t\t\t\t\t;;</span><br><span class=\"line\">    \t\t\t\tesac</span><br><span class=\"line\">\t\t\t\t\tdone</span><br><span class=\"line\">\t\t\telse</span><br><span class=\"line\"></span><br><span class=\"line\">    \t\t\t\techo &quot;密码不符合规定&quot;</span><br><span class=\"line\">    \t\t\t\techo &quot;密码要求大于等于8位，小写字母，大写字母，特殊字符&quot;</span><br><span class=\"line\">\t\t\tfi</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\techo &quot;用户有误&quot;</span><br><span class=\"line\">\tfi</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"># 定义工具箱菜单</span><br><span class=\"line\">gongju ()&#123;</span><br><span class=\"line\">cat &lt;&lt; EOF</span><br><span class=\"line\">===========系统工具箱===========</span><br><span class=\"line\">||       1.查看磁盘信息        ||</span><br><span class=\"line\">||       2.查看内存信息        ||</span><br><span class=\"line\">||       3.查看CPU信息         ||</span><br><span class=\"line\">||       4.查看网络信息        ||</span><br><span class=\"line\">||       5.查看进程信息        ||</span><br><span class=\"line\">||       6.退出                ||</span><br><span class=\"line\">================================</span><br><span class=\"line\">EOF</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"># 注册函数</span><br><span class=\"line\">zhuce()&#123;</span><br><span class=\"line\">read -p &quot;请输入你需要创建的用户名：&quot; name</span><br><span class=\"line\">id $name &amp;&gt; /dev/null</span><br><span class=\"line\">if [ $? -eq 1 ];then</span><br><span class=\"line\">read -p &quot;请设置$name的密码：&quot; password</span><br><span class=\"line\">\tif [[ $&#123;#password&#125; -ge 8  &amp;&amp; $password =~ [a-z] &amp;&amp; $password =~ [A-Z] &amp;&amp; $password =~ [0-9] &amp;&amp; $password =~ [^0-Z] ]];then</span><br><span class=\"line\">\t\techo &quot;$password&quot; | passwd --stdin $name &amp;&gt; /dev/null</span><br><span class=\"line\">\t\techo &quot;$name用户密码设置成功，密码为$password&quot;</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\techo &quot;你设置的密码有误，请按规定设置&quot;</span><br><span class=\"line\">\t\tcaidan\t\t</span><br><span class=\"line\">\tfi</span><br><span class=\"line\">else</span><br><span class=\"line\">\techo &quot;$name用户创建有误&quot;</span><br><span class=\"line\">\tcaidan</span><br><span class=\"line\">fi\t</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">tuichu()&#123;</span><br><span class=\"line\">    echo &quot;再见&quot;</span><br><span class=\"line\">    break</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">caidan</span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Toolbox","Script"]},{"title":"系统工具箱--脚本","url":"/2025/11/06/%E7%B3%BB%E7%BB%9F%E5%B7%A5%E5%85%B7%E7%AE%B1-%E8%84%9A%E6%9C%AC/","content":"<h1 id=\"bin-bash\"><a href=\"#bin-bash\" class=\"headerlink\" title=\"!&#x2F;bin&#x2F;bash\"></a>!&#x2F;bin&#x2F;bash</h1><h1 id=\"本脚本用于系统工具\"><a href=\"#本脚本用于系统工具\" class=\"headerlink\" title=\"本脚本用于系统工具\"></a>本脚本用于系统工具</h1><h1 id=\"打印当前系统登录用户\"><a href=\"#打印当前系统登录用户\" class=\"headerlink\" title=\"打印当前系统登录用户\"></a>打印当前系统登录用户</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">print_logged_in_users() &#123;</span><br><span class=\"line\">    who | awk &#x27;&#123;print $1&#125;&#x27; | sort | uniq</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"># 根据用户输入判断软件是否已安装并打印软件信息</span><br><span class=\"line\">check_and_print_software_info() &#123;</span><br><span class=\"line\">    read -p &quot;请输入要检查的软件名称： &quot; software_name</span><br><span class=\"line\">    if command -v &quot;$software_name&quot; &amp;&gt; /dev/null; then</span><br><span class=\"line\">        echo &quot;$software_name 已安装&quot;</span><br><span class=\"line\">        # TODO: 打印软件信息命令</span><br><span class=\"line\">    else</span><br><span class=\"line\">        echo &quot;$software_name 未安装&quot;</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"输入时间段和日志路径统计-nginx-访问日志次数最多的-IP\"><a href=\"#输入时间段和日志路径统计-nginx-访问日志次数最多的-IP\" class=\"headerlink\" title=\"输入时间段和日志路径统计 nginx 访问日志次数最多的 IP\"></a>输入时间段和日志路径统计 nginx 访问日志次数最多的 IP</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">analyze_nginx_log() &#123;</span><br><span class=\"line\">    read -p &quot;请输入日志路径： &quot; log_path</span><br><span class=\"line\">    read -p &quot;请输入开始时间（格式：15/Jul/2023:00:00:00）： &quot; start_time</span><br><span class=\"line\">    read -p &quot;请输入结束时间（格式：15/Jul/2023:00:00:00）： &quot; end_time</span><br><span class=\"line\">    </span><br><span class=\"line\">    sed -n &quot;/$start_time/,/$end_time/p&quot; &quot;$log_path&quot; |awk &#x27;&#123;print $1&#125;&#x27; |sort|uniq -c |sort|tail -n 1|awk &#x27;&#123;print $2&#125;&#x27;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装指定软件\"><a href=\"#安装指定软件\" class=\"headerlink\" title=\"安装指定软件\"></a>安装指定软件</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">install_software() &#123;</span><br><span class=\"line\">    read -p &quot;请选择要安装的软件：1.Nginx 2.MySQL 3.Apache 4.Vsftpd：&quot; choice</span><br><span class=\"line\"></span><br><span class=\"line\">    case $choice in</span><br><span class=\"line\">        1)</span><br><span class=\"line\">            # 安装 Nginx</span><br><span class=\"line\">            # TODO: 添加 Nginx 安装命令</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">        2)</span><br><span class=\"line\">            # 安装 MySQL</span><br><span class=\"line\">            # TODO: 添加 MySQL 安装命令</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">        3)</span><br><span class=\"line\">            # 安装 Apache</span><br><span class=\"line\">            # TODO: 添加 Apache 安装命令</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">        4)</span><br><span class=\"line\">            # 安装 Vsftpd</span><br><span class=\"line\">            # TODO: 添加 Vsftpd 安装命令</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">        *)</span><br><span class=\"line\">            echo &quot;无效的选择&quot;</span><br><span class=\"line\">            ;;</span><br><span class=\"line\">    esac</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"获取系统-CPU-排名前-10-的进程\"><a href=\"#获取系统-CPU-排名前-10-的进程\" class=\"headerlink\" title=\"获取系统 CPU 排名前 10 的进程\"></a>获取系统 CPU 排名前 10 的进程</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">get_top_cpu_processes() &#123;</span><br><span class=\"line\">    ps aux --sort=-%cpu | head -n 11</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"获取系统内存排名前-10-的进程\"><a href=\"#获取系统内存排名前-10-的进程\" class=\"headerlink\" title=\"获取系统内存排名前 10 的进程\"></a>获取系统内存排名前 10 的进程</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">get_top_memory_processes() &#123;</span><br><span class=\"line\">    ps aux --sort=-%mem | head -n 11</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">change_IP_address()&#123;</span><br><span class=\"line\">    read -p &quot;是否已经配置网卡服务[y/n]：&quot; yn</span><br><span class=\"line\">    if [ $yn = n ];then</span><br><span class=\"line\">    echo &quot;</span><br><span class=\"line\">    IPADDR=192.168.116.111</span><br><span class=\"line\">    NETMASK=255.255.255.0</span><br><span class=\"line\">    GATEWAY=192.168.116.2</span><br><span class=\"line\">    DNS1=192.168.116.2</span><br><span class=\"line\">    以上为默认格式，仅供参考！&quot;        </span><br><span class=\"line\">        sed -ie &#x27;s/BOOTPROTO=dhcp/BOOTPROTO=static/;s/ONBOOT=no/ONBOOT=yes/&#x27; /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">        read -p &quot;请输入你设置的IP地址：&quot; ip</span><br><span class=\"line\">        sed -i &quot;$ a IPADDR=$ip&quot;  /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">            read -p &quot;请输入掩码：&quot; net</span><br><span class=\"line\">            sed -i &quot;$ a NETMASK=$net&quot; /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">                read -p &quot;请输入网关：&quot; way</span><br><span class=\"line\">                sed -i &quot;$ a GATEWAY=$way&quot; /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">                    read -p &quot;请输入DNS：&quot; dns</span><br><span class=\"line\">                    sed -i &quot;$ a DNS1=$dns&quot; /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">                        echo &quot;网卡配置成功！&quot;</span><br><span class=\"line\">    else</span><br><span class=\"line\">        sed -i &#x27;16,19 s/\\(.*\\)/#\\1/&#x27;  /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">        echo &quot;注意，16-19段已被注释！！！&quot;</span><br><span class=\"line\">        read -p &quot;是否需要配置网卡服务【y/n】：&quot; YN</span><br><span class=\"line\">        if [ $YN = y ];then</span><br><span class=\"line\">            echo &quot;</span><br><span class=\"line\">            IPADDR=192.168.116.111</span><br><span class=\"line\">            NETMASK=255.255.255.0</span><br><span class=\"line\">            GATEWAY=192.168.116.2</span><br><span class=\"line\">            DNS1=192.168.116.2</span><br><span class=\"line\">            以上为默认格式，仅供参考！&quot;        </span><br><span class=\"line\">        sed -ie &#x27;s/BOOTPROTO=dhcp/BOOTPROTO=static/;s/ONBOOT=no/ONBOOT=yes/&#x27; /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">        read -p &quot;请输入你设置的IP地址：&quot; ipp</span><br><span class=\"line\">        sed -i &quot;$ a IPADDR=$ipp&quot;  /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">            read -p &quot;请输入掩码：&quot; nett</span><br><span class=\"line\">            sed -i &quot;$ a NETMASK=$nett&quot; /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">                read -p &quot;请输入网关：&quot; wayy</span><br><span class=\"line\">                sed -i &quot;$ a GATEWAY=$wayy&quot; /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">                    read -p &quot;请输入DNS：&quot; dnss</span><br><span class=\"line\">                    sed -i &quot;$ a DNS1=$dnss&quot;  /etc/sysconfig/network-scripts/ifcfg-ens33  </span><br><span class=\"line\">                        echo &quot;网卡配置成功！&quot;</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"关闭防火墙\"><a href=\"#关闭防火墙\" class=\"headerlink\" title=\"关闭防火墙\"></a>关闭防火墙</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">disable_firewall()&#123;</span><br><span class=\"line\">    systemctl stop firewalld;systemctl disable firewalld;</span><br><span class=\"line\">        echo &quot;防火墙已关闭,关闭开机自启服务！&quot;</span><br><span class=\"line\">    sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class=\"line\">        echo &quot;selinux已关闭，已关闭开机自启服务！&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"关闭DNS\"><a href=\"#关闭DNS\" class=\"headerlink\" title=\"关闭DNS\"></a>关闭DNS</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">on_DNS()&#123;</span><br><span class=\"line\">    sed -i &#x27;115s/#UseDNS yes/UseDNS no/&#x27;    /etc/ssh/sshd_config;systemctl restart sshd</span><br><span class=\"line\">    echo &quot;DNS已关闭！！！&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"备份\"><a href=\"#备份\" class=\"headerlink\" title=\"备份\"></a>备份</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">backup_copy()&#123;</span><br><span class=\"line\">    #每周日进行全量备份，周一到周六进行增量备份</span><br><span class=\"line\">    #关闭防火墙</span><br><span class=\"line\">    systemctl stop firewalld</span><br><span class=\"line\">    setenforce 0</span><br><span class=\"line\">    #备份路径</span><br><span class=\"line\">    back_dir=&quot;/backup&quot;</span><br><span class=\"line\">    log_dir=&quot;/backup_log&quot;</span><br><span class=\"line\">    full_backup_dir=&quot;backup/full&quot;</span><br><span class=\"line\">    inc_backup_dir=&quot;backup/inc&quot;</span><br><span class=\"line\">    #变量时间</span><br><span class=\"line\">    log_date=$(date &quot;+%F-%T&quot;)</span><br><span class=\"line\">    #定义用户，密码</span><br><span class=\"line\">    MY_USER=&quot;root&quot;</span><br><span class=\"line\">    MY_PASS=&quot;1&quot;</span><br><span class=\"line\">    #验证日志目录路径是否存在</span><br><span class=\"line\">    [ -d $back_dir ] || mkdir $back_dir</span><br><span class=\"line\">    [ -d $log_dir ] || mkdir $log_dir</span><br><span class=\"line\">    [ -d $full_backup_dir ] || mkdir $full_backup_dir</span><br><span class=\"line\">    [ -d $inc_backup_dir ] || mkdir $inc_backup_dir</span><br><span class=\"line\">    #全量备份函数</span><br><span class=\"line\">    full_back()&#123;</span><br><span class=\"line\">    #全量备份命令</span><br><span class=\"line\">    innobackupex --user=$MY_USER --password=$MY_PASS $full_backup_dir</span><br><span class=\"line\">    if [$? -eq 0];then</span><br><span class=\"line\">        echo &quot;$&#123;log_date&#125; full OK!!!&quot; &gt;&gt; $log_dir/OK_log</span><br><span class=\"line\">    else    </span><br><span class=\"line\">        echo &quot;$&#123;log_date&#125; NO found full!!!&quot; &gt;&gt; $log_dir/err_log</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    &#125;   </span><br><span class=\"line\">    #获取上周日时间</span><br><span class=\"line\">    sunday=$(date -d &quot;last sunday&quot; +%F)</span><br><span class=\"line\">    #获取前一天的时间</span><br><span class=\"line\">    yesterday=$(date -d &quot;yesterday&quot; +%F)</span><br><span class=\"line\">    #增量备份函数</span><br><span class=\"line\">    inc_back()&#123;</span><br><span class=\"line\">    #判断当前时间是否是周一</span><br><span class=\"line\">    if [ $week_date -eq 1 ];then</span><br><span class=\"line\">        #查找文件</span><br><span class=\"line\">        local full_backup_dir=$(find $backup_dir -name $&#123;sunday&#125;*)</span><br><span class=\"line\">        innobackupex --user=$MY_USER --password=$MY_PASS --incremental $&#123;inc_backup_dir&#125; --incremental-basedir=$&#123;full_backup_dir&#125;</span><br><span class=\"line\">        #判断是否执行成功，写入定义日志文件</span><br><span class=\"line\">        if [$? -eq 0];then</span><br><span class=\"line\">            echo &quot;$&#123;log_date&#125; full OK!!!&quot; &gt;&gt; $log_dir/OK_log</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;$&#123;log_date&#125; NO found full!!!&quot; &gt;&gt; $log_dir/err_log</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    else</span><br><span class=\"line\">        #查找前一天的文件路径</span><br><span class=\"line\">        local yesterday_backup_dir=$(find $backup_dir -name $&#123;yesterday&#125;*)</span><br><span class=\"line\">        innobackupex --user=$MY_USER --password=$MY_PASS --incremental $&#123;inc_backup_dir&#125; --incremental-basedir=$&#123;yesterday_backup_dir&#125;</span><br><span class=\"line\">        # 判断命令是否执行成功,写入日志文件</span><br><span class=\"line\">        if [$? -eq 0];then</span><br><span class=\"line\">            echo &quot;$&#123;log_date&#125; full OK!!!&quot; &gt;&gt; $log_dir/OK_log</span><br><span class=\"line\">        else</span><br><span class=\"line\">            echo &quot;$&#123;log_date&#125; NO found full!!!&quot; &gt;&gt; $log_dir/err_log</span><br><span class=\"line\">        fi</span><br><span class=\"line\">    fi</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    #查看当前时间是周几</span><br><span class=\"line\">    week_date=$(date +%u)</span><br><span class=\"line\">    #判断当前时间是不是周日，如果是进去全量备份，如果不是就进行增量备份</span><br><span class=\"line\">    if [ $week_date -eq 7 ];then</span><br><span class=\"line\">        full_backup</span><br><span class=\"line\">    else</span><br><span class=\"line\">        inc_backup</span><br><span class=\"line\">    fi</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"对时\"><a href=\"#对时\" class=\"headerlink\" title=\"对时\"></a>对时</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">check_the_time()&#123;</span><br><span class=\"line\">    # 关闭防火墙</span><br><span class=\"line\">    systemctl stop firewalld</span><br><span class=\"line\">    setenforce 0</span><br><span class=\"line\">    # 下载软件</span><br><span class=\"line\">    yum -y instal ntpdate</span><br><span class=\"line\">    # 查看当前时区</span><br><span class=\"line\">    timedatectl</span><br><span class=\"line\">    # 列出可用时区</span><br><span class=\"line\">    #timedatectl list-timezones</span><br><span class=\"line\">    # 修改上海时区</span><br><span class=\"line\">    timedatectl set-timezone Asia/Shanghai</span><br><span class=\"line\">    # 验证修改是否生效</span><br><span class=\"line\">    timedatectl</span><br><span class=\"line\">    # 对时</span><br><span class=\"line\">    ntpdate ntp.aliyun.com</span><br><span class=\"line\">    echo &quot;对时成功，当前时间为：&quot; </span><br><span class=\"line\">    date +&#x27;%F %H:%M:%S&#x27;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"配置IP\"><a href=\"#配置IP\" class=\"headerlink\" title=\"配置IP\"></a>配置IP</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">COPY_INSTALL()&#123;</span><br><span class=\"line\">master=ip1</span><br><span class=\"line\">slave=ip2</span><br><span class=\"line\">read -p &quot;请输入master的IP地址：&quot; IP1</span><br><span class=\"line\">read -p &quot;请输入slave的IP地址：&quot; IP2</span><br><span class=\"line\"># 关闭防火墙</span><br><span class=\"line\">systemctl stop firewalld;setenforce 0</span><br><span class=\"line\"># 域名解析</span><br><span class=\"line\">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class=\"line\">$IP1 master</span><br><span class=\"line\">$IP2 slave</span><br><span class=\"line\">EOF</span><br><span class=\"line\"># ping下网络</span><br><span class=\"line\">ping slave &amp;&gt; /dev/null</span><br><span class=\"line\">if [ $? -eq 0 ];then</span><br><span class=\"line\">    echo &quot;网络正常，可以使用&quot;</span><br><span class=\"line\">else</span><br><span class=\"line\">    echo &quot;sorry 网络不通&quot;</span><br><span class=\"line\">fi</span><br><span class=\"line\"># 添加主机配置</span><br><span class=\"line\">cat &gt;&gt; /etc/my.cnf &lt;&lt; EOF</span><br><span class=\"line\">log-bin=/var/lib/mysql/master</span><br><span class=\"line\">server-id=1</span><br><span class=\"line\">gtid_mode=ON</span><br><span class=\"line\">enforce_gtid_consistency=1</span><br><span class=\"line\">EOF</span><br><span class=\"line\"># 主机授权</span><br><span class=\"line\">grant replication slave,super,reload on *.* to slave@&#x27;%&#x27; identified by &#x27;Qianfeng123!&#x27;;</span><br><span class=\"line\"># 刷新权限</span><br><span class=\"line\">flush privileges;</span><br><span class=\"line\"># 此项为互为主从配置</span><br><span class=\"line\">change master to master_host=&#x27;slave&#x27;,master_user=&#x27;slave&#x27;,master_password=&#x27;1&#x27;,master_auto_position=1;</span><br><span class=\"line\"># 启动slave服务</span><br><span class=\"line\">start slave;</span><br><span class=\"line\"># 查看服务状态，是否有error</span><br><span class=\"line\">show slave status\\G</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"退出\"><a href=\"#退出\" class=\"headerlink\" title=\"退出\"></a>退出</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">exit_menu()&#123;</span><br><span class=\"line\">    echo &quot;再见！！！&quot;</span><br><span class=\"line\">    break</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"定义菜单颜色\"><a href=\"#定义菜单颜色\" class=\"headerlink\" title=\"定义菜单颜色\"></a>定义菜单颜色</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">red()&#123;</span><br><span class=\"line\">    echo -e &quot;\\033[31m\\033[01m$1\\033[0m&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">green()&#123;</span><br><span class=\"line\">    echo -e &quot;\\033[32m\\033[01m$1\\033[0m&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">yellow()&#123;</span><br><span class=\"line\">    echo -e &quot;\\033[33m\\033[01m$1\\033[0m&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">blue()&#123;</span><br><span class=\"line\">    echo -e &quot;\\033[34m\\033[01m$1\\033[0m&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"主菜单选择\"><a href=\"#主菜单选择\" class=\"headerlink\" title=\"主菜单选择\"></a>主菜单选择</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">main_menu() &#123;</span><br><span class=\"line\">    while true; do</span><br><span class=\"line\">red      &quot;===============================================&quot;</span><br><span class=\"line\">green   &quot;||  ____    _____  _______  _________  _______||&quot;</span><br><span class=\"line\">yellow  &quot;|| / __ \\  /  _/ |/ / ___/ / __/ __/ |/ / ___/||&quot;</span><br><span class=\"line\">blue    &quot;||/ /_/ / _/ //    / (_ / / _// _//    / (_ / ||&quot;</span><br><span class=\"line\">yellow  &quot;||\\___\\_\\/___/_/|_/\\___/ /_/ /___/_/|_/\\___/  ||&quot;</span><br><span class=\"line\">green   &quot;||                                            ||&quot;</span><br><span class=\"line\">red     &quot;===============================================&quot;</span><br><span class=\"line\">blue    &quot;||            &gt;&gt;&gt;&gt;&gt; 清风徐来 &lt;&lt;&lt;&lt;&lt;            ||&quot;</span><br><span class=\"line\">red     &quot;===============================================&quot;</span><br><span class=\"line\">        echo &quot;1) 打印当前系统登录用户&quot;</span><br><span class=\"line\">        echo &quot;2) 检查软件是否已安装并打印软件信息&quot;</span><br><span class=\"line\">        echo &quot;3) 输入时间段和日志路径统计nginx访问日志次数最多的IP&quot;</span><br><span class=\"line\">        echo &quot;4) 安装指定软件&quot;</span><br><span class=\"line\">        echo &quot;5) 获取系统CPU排名前10的进程&quot;</span><br><span class=\"line\">        echo &quot;6) 获取系统内存排名前10的进程&quot;</span><br><span class=\"line\">        echo &quot;7) 更改IP&quot;</span><br><span class=\"line\">        echo &quot;8) 关闭防火墙&quot;</span><br><span class=\"line\">        echo &quot;9) 开启DNS&quot;</span><br><span class=\"line\">        echo &quot;10) 备份&quot;</span><br><span class=\"line\">        echo &quot;11) 对时&quot;</span><br><span class=\"line\">        echo &quot;12) 主从复制&quot;</span><br><span class=\"line\">        echo &quot;13) 返回上级菜单&quot;</span><br><span class=\"line\">        echo &quot;14) 退出&quot;</span><br><span class=\"line\">        echo &quot;============================================&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">        read -p &quot;请输入选项： &quot; select</span><br><span class=\"line\">        case $select in</span><br><span class=\"line\">            1)</span><br><span class=\"line\">                print_logged_in_users</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            2)</span><br><span class=\"line\">                check_and_print_software_info</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            3)</span><br><span class=\"line\">                analyze_nginx_log</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            4)</span><br><span class=\"line\">                install_software</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            5)</span><br><span class=\"line\">                get_top_cpu_processes</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            6)</span><br><span class=\"line\">                get_top_memory_processes</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            7)</span><br><span class=\"line\">                change_IP_address</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            8)</span><br><span class=\"line\">                disable_firewall</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            9)</span><br><span class=\"line\">                on_DNS</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            10)</span><br><span class=\"line\">                backup_copy</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            </span><br><span class=\"line\">            11)</span><br><span class=\"line\">                check_the_time</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            12)</span><br><span class=\"line\">                COPY_INSTALL</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            13)</span><br><span class=\"line\">                echo &quot;请重新选择你需要的菜单&quot;</span><br><span class=\"line\">                continue 2</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            14)</span><br><span class=\"line\">                exit_menu</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">            *)</span><br><span class=\"line\">                echo &quot;无效的选择，请重新输入&quot;</span><br><span class=\"line\">                ;;</span><br><span class=\"line\">        esac</span><br><span class=\"line\"></span><br><span class=\"line\">        echo &quot;============================&quot;</span><br><span class=\"line\">        read -p &quot;按任意键返回主菜单&quot; any_key</span><br><span class=\"line\">        clear</span><br><span class=\"line\">    done</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h1 id=\"运行主菜单\"><a href=\"#运行主菜单\" class=\"headerlink\" title=\"运行主菜单\"></a>运行主菜单</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">main_menu</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","Toolbox","Script"]},{"title":"自定义下载--php版本","url":"/2025/11/06/%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%8B%E8%BD%BD-php%E7%89%88%E6%9C%AC/","content":"<h1 id=\"下载官网php\"><a href=\"#下载官网php\" class=\"headerlink\" title=\"下载官网php\"></a>下载官网php</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># wget http://rpms.remirepo.net/enterprise/remi-release-7.9.rpm</span><br><span class=\"line\"># -Uvh带有下载更新的作用,会有多个版本</span><br><span class=\"line\">rpm -Uvh http://rpms.remirepo.net/enterprise/remi-release-7.rpm</span><br></pre></td></tr></table></figure>\n<h1 id=\"会在-etc-yum-repos-d目录生成许多remi的仓库，其中包含不同版本的php仓库\"><a href=\"#会在-etc-yum-repos-d目录生成许多remi的仓库，其中包含不同版本的php仓库\" class=\"headerlink\" title=\"会在&#x2F;etc&#x2F;yum.repos.d目录生成许多remi的仓库，其中包含不同版本的php仓库\"></a>会在&#x2F;etc&#x2F;yum.repos.d目录生成许多remi的仓库，其中包含不同版本的php仓库</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@server ~]# cd /etc/yum.repos.d/</span><br><span class=\"line\">[root@server yum.repos.d]# ls</span><br><span class=\"line\">CentOS-Base.repo   remi-modular.repo  remi-php72.repo  remi-php81.repo  remi-safe.repo</span><br><span class=\"line\">epel.repo          remi-php54.repo    remi-php73.repo  remi-php82.repo</span><br><span class=\"line\">epel.repo.rpmnew   remi-php70.repo    remi-php74.repo  remi-php83.repo</span><br><span class=\"line\">epel-testing.repo  remi-php71.repo    remi-php80.repo  remi.repo</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装yum-config-manager仓库管理工具并安装指定版本的php\"><a href=\"#安装yum-config-manager仓库管理工具并安装指定版本的php\" class=\"headerlink\" title=\"安装yum-config-manager仓库管理工具并安装指定版本的php\"></a>安装yum-config-manager仓库管理工具并安装指定版本的php</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install yum-utils</span><br><span class=\"line\">yum-config-manager --enable remi-php72</span><br><span class=\"line\"></span><br><span class=\"line\">#如果想选择其它版本的话，把remi-php72改为remi-php71、remi-php70等，要看/etc/yum.repos.d/里的remi仓库，一一对应上</span><br></pre></td></tr></table></figure>\n<h1 id=\"安装php及对应的模块\"><a href=\"#安装php及对应的模块\" class=\"headerlink\" title=\"安装php及对应的模块\"></a>安装php及对应的模块</h1><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">安装php</span><br><span class=\"line\">]# yum -y install php </span><br><span class=\"line\">#因为直接用yum-config-manager --enable 指定了php7.2版本了，这里安装的php为7.2版本的</span><br><span class=\"line\"> </span><br><span class=\"line\">#安装常用的php模块</span><br><span class=\"line\">]# yum -y install php php72-php-opcache  php72-php-ldap php72-php-odbc php72-php-pear php72-php-xml php72-php-xmlrpc php72-php-soap curl curl-devel  php72-php-mbstring php72-php-mysqlnd  php72-php-fpm  php72-php-gd</span><br><span class=\"line\"> </span><br><span class=\"line\">#安装php-fpm</span><br><span class=\"line\">]# yum -y install php72-php-fpm.x86_64</span><br><span class=\"line\">]# systemctl restart php72-php-fpm       #启动php-fpm服务</span><br><span class=\"line\">]#netstat -tunlp|grep 9000               #查看9000端口是否正常启动了</span><br></pre></td></tr></table></figure>","categories":["operations"],"tags":["Linux","php"]},{"title":"负载高可用实验","url":"/2025/11/06/%E8%B4%9F%E8%BD%BD%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AE%9E%E9%AA%8C/","content":"<p><a href=\"http://xbd666.cn/\">清风</a><br><img src=\"https://xbd666.cn/upload/%E9%AB%98%E5%8F%AF%E7%94%A801.png\" alt=\"高可用01.png\"></p>\n<h1 id=\"关闭防火墙\"><a href=\"#关闭防火墙\" class=\"headerlink\" title=\"关闭防火墙\"></a>关闭防火墙</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\">systemctl disable firewalld</span><br><span class=\"line\">setenforce 0</span><br></pre></td></tr></table></figure>\n<h1 id=\"配置环境\"><a href=\"#配置环境\" class=\"headerlink\" title=\"配置环境\"></a>配置环境</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim /etc/hosts</span><br><span class=\"line\">192.168.116.121\t tomcat  安装tomcat</span><br><span class=\"line\">192.168.116.122\t php     安装php-fpm、nginx</span><br><span class=\"line\">192.168.116.131\t nginx1  安装nginx</span><br><span class=\"line\">192.168.116.132\t nginx2  安装nginx</span><br><span class=\"line\">192.168.116.111\t master  安装lvs、keepalived</span><br><span class=\"line\">192.168.116.156\t backup  安装lvs、keepalived``</span><br></pre></td></tr></table></figure>\n<h1 id=\"1、安装tomcat步骤–192-168-116-121\"><a href=\"#1、安装tomcat步骤–192-168-116-121\" class=\"headerlink\" title=\"1、安装tomcat步骤–192.168.116.121\"></a>1、安装tomcat步骤–192.168.116.121</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">1、安装 JDK（java）</span><br><span class=\"line\">1.上传jdk到服务器中，安装jdk</span><br><span class=\"line\">[root@localhost ~]# mkdir /application   #创建工作目录</span><br><span class=\"line\">[root@localhost ~]# tar xzf jdk-8u60-linux-x64.tar.gz -C /application/</span><br><span class=\"line\">[root@localhost ~]# mv /application/jdk1.8.0_60 /application/jdk</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">设置环境变量</span></span><br><span class=\"line\">[root@localhost ~]# vim /etc/profile</span><br><span class=\"line\">JAVA_HOME=/usr/local/java #指定java安装目录</span><br><span class=\"line\">PATH=$JAVA_HOME/bin:$PATH #用于指定java系统查找命令的路径</span><br><span class=\"line\">export JAVA_HOME PATH #类的路径，在编译运行java程序时，如果有调用到其他类的时候，在classpath中寻找需要的类。</span><br><span class=\"line\">[root@localhost ~]# source /etc/profile  #让环境变量生效</span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">测试jdk是否安装成功</span></span><br><span class=\"line\">[root@localhost ~]# java -version</span><br><span class=\"line\">java version &quot;1.8.0_60&quot;</span><br><span class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_60-b27)</span><br><span class=\"line\">Java HotSpot(TM) 64-Bit Server VM (build 25.60-b23, mixed mode)</span><br><span class=\"line\"></span><br><span class=\"line\">2、安装Tomcat</span><br><span class=\"line\">将tomcat安装包上传到服务器中：</span><br><span class=\"line\">[root@localhost ~]# tar xzf apache-tomcat-8.0.27.tar.gz -C /application/</span><br><span class=\"line\">[root@localhost ~]# mv /application/apache-tomcat-8.0.27 /application/tomcat</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">设置环境变量</span></span><br><span class=\"line\">[root@localhost ~]# echo &#x27;export TOMCAT_HOME=/application/tomcat&#x27;&gt;&gt;/etc/profile</span><br><span class=\"line\">[root@localhost ~]# source /etc/profile</span><br><span class=\"line\">启动tomcat</span><br><span class=\"line\">[root@localhost ~]# /application/tomcat/bin/startup.sh</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">网址输入192.168.116.121：8080，会出来tomcat测试页面192.168.116.121的tomcat的测试页面</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2、安装php-fpm-nginx–步骤–192-168-116-122\"><a href=\"#2、安装php-fpm-nginx–步骤–192-168-116-122\" class=\"headerlink\" title=\"2、安装php-fpm&#x2F;nginx–步骤–192.168.116.122\"></a>2、安装php-fpm&#x2F;nginx–步骤–192.168.116.122</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">下载nginx</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">yum安装nginx</span></span><br><span class=\"line\">[root@localhost ~]#  vim /etc/yum.repo.d/nginx.repo</span><br><span class=\"line\">[nginx-stable]</span><br><span class=\"line\">name=nginx stable repo</span><br><span class=\"line\">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">[root@localhost ~]#  yum install nginx -y</span><br><span class=\"line\">[root@localhost ~]#  systemctl start nginx</span><br><span class=\"line\">[root@localhost ~]#  systemctl enable nginx</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">下载PHP</span></span><br><span class=\"line\">[root@localhost ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/epel-release.rpm</span><br><span class=\"line\">[root@localhost ~]# rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class=\"line\">[root@localhost ~]#  yum install php71w-xsl php71w </span><br><span class=\"line\">[root@localhost ~]#  yum -y install php71w-xsl php71w php71w-ldap php71w-cli php71w-common php71w-devel php71w-gd php71w-pdo php71w-mysql php71w-mbstring php71w-bcmath php71w-mcrypt\t\t//php依赖包</span><br><span class=\"line\">[root@localhost ~]#  yum install -y php71w-fpm\t//php主包</span><br><span class=\"line\">[root@localhost ~]#  systemctl start php-fpm</span><br><span class=\"line\">[root@localhost ~]#  systemctl enable php-fpm</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">验证nginx/php-fpm有没有起来</span></span><br><span class=\"line\">[root@localhost ~]#  systemctl status nginx</span><br><span class=\"line\">[root@localhost ~]#  systemctl status php-fpm</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编辑配置文件</span></span><br><span class=\"line\">vim /etc/nginx/conf.d/php.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen      80;</span><br><span class=\"line\">        server_name     localhost;</span><br><span class=\"line\">      location ~ \\.php$ &#123;</span><br><span class=\"line\">            root       /usr/share/nginx/html;  #指定网站目录</span><br><span class=\"line\">            fastcgi_pass   127.0.0.1:9000;    #开启fastcgi连接php地址</span><br><span class=\"line\">            fastcgi_index  index.php;\t\t#指定默认文件</span><br><span class=\"line\">            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name; #站点根目录，取决于root配置项</span><br><span class=\"line\">            include        fastcgi_params;  #包含fastcgi使用的常量</span><br><span class=\"line\">        \t\t&#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">[root@localhost ~]#  vim /usr/share/nginx/html/test.php</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\"> phpinfo();</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启nginx</span></span><br><span class=\"line\">[root@localhost ~]#  systemctl restart nginx</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"测试-1\"><a href=\"#测试-1\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">输入网址192.168.116.122/test.php\t//会出来php的测试页面</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"3、安装nginx步骤–192-168-116-131\"><a href=\"#3、安装nginx步骤–192-168-116-131\" class=\"headerlink\" title=\"3、安装nginx步骤–192.168.116.131\"></a>3、安装nginx步骤–192.168.116.131</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">yum安装nginx--代理tomcat</span></span><br><span class=\"line\">[root@localhost ~]#  vim /etc/yum.repo.d/nginx.repo</span><br><span class=\"line\">[nginx-stable]</span><br><span class=\"line\">name=nginx stable repo</span><br><span class=\"line\">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">[root@localhost ~]#  yum install nginx -y</span><br><span class=\"line\">[root@localhost ~]#  systemctl start nginx</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置负载均衡</span></span><br><span class=\"line\">[root@localhost ~]#  vim /etc/nginx/conf.d/upstream.conf</span><br><span class=\"line\">upstream tomcat01 &#123;</span><br><span class=\"line\">      server 192.168.116.121:8080;</span><br><span class=\"line\">      server 192.168.116.122;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">配置代理</span></span><br><span class=\"line\">[root@localhost ~]#  vim /etc/nginx/conf.d/tomcat_01.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">        listen       80;</span><br><span class=\"line\">        server_name localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">        #access_log  logs/host.access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">            proxy_pass http://tomcat01;</span><br><span class=\"line\">            proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启nginx</span></span><br><span class=\"line\">systemctl restart nginx</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"测试-2\"><a href=\"#测试-2\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">输入网址192.168.116.131  //会出来192.168.116.(121/122)的页面</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4、安装nginx步骤–192-168-116-132\"><a href=\"#4、安装nginx步骤–192-168-116-132\" class=\"headerlink\" title=\"4、安装nginx步骤–192.168.116.132\"></a>4、安装nginx步骤–192.168.116.132</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">yum安装nginx--代理php</span></span><br><span class=\"line\">[root@localhost ~]#  vim /etc/yum.repo.d/nginx.repo</span><br><span class=\"line\">[nginx-stable]</span><br><span class=\"line\">name=nginx stable repo</span><br><span class=\"line\">baseurl=http://nginx.org/packages/centos/$releasever/$basearch/</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">[root@localhost ~]#  yum install nginx -y</span><br><span class=\"line\">[root@localhost ~]#  systemctl start nginx</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">负载均衡192.168.116.122</span></span><br><span class=\"line\">vim /etc/nginx/conf.d/upstream.conf</span><br><span class=\"line\">upstream php01 &#123;</span><br><span class=\"line\">      server 192.168.116.121:8080;</span><br><span class=\"line\">      server 192.168.116.122;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">代理配置</span></span><br><span class=\"line\">vim /etc/nginx/conf.d/php_01.conf</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">     listen      80;</span><br><span class=\"line\">     server_name     localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">     location / &#123;</span><br><span class=\"line\">            proxy_pass http://php01;</span><br><span class=\"line\">            proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class=\"line\">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">重启nginx</span></span><br><span class=\"line\">systemctl restart nginx</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"测试-3\"><a href=\"#测试-3\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">输入网址192.168.116.132\t//会出来192.168.116.(121/122)的页面</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"5、配置（lvs–keepalived-–192-168-116-111-MASTER\"><a href=\"#5、配置（lvs–keepalived-–192-168-116-111-MASTER\" class=\"headerlink\" title=\"5、配置（lvs–keepalived)–192.168.116.111(MASTER)\"></a>5、配置（lvs–keepalived)–192.168.116.111(MASTER)</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">1. 主/备调度器安装软件</span><br><span class=\"line\">[root@lvs-keepalived-master ~]# yum -y install ipvsadm keepalived </span><br><span class=\"line\"></span><br><span class=\"line\">2、配置keepalived,conf配置文件</span><br><span class=\"line\">lvs-master</span><br><span class=\"line\">[root@ha-proxy-master ~]# vim /etc/keepalived/keepalived.conf</span><br><span class=\"line\">! Configuration File for keepalived</span><br><span class=\"line\"></span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">   router_id lvs-keepalived-master    #辅助改为lvs-backup</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    state MASTER\t（修改的）</span><br><span class=\"line\">    interface ens33\t\t（修改的）                #VIP绑定接口</span><br><span class=\"line\">    virtual_router_id 80         #VRID 同一组集群，主备一致          </span><br><span class=\"line\">    priority 100            #本节点优先级，辅助改为50</span><br><span class=\"line\">    advert_int 1            #检查间隔，默认为1s</span><br><span class=\"line\">    authentication &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass 1111</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">        192.168.246.11/32\t（修改的）</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">virtual_server 192.168.246.11 80 &#123;   \t（修改的） #LVS配置</span><br><span class=\"line\">\tdelay_loop 6   #健康检查rs时间间隔</span><br><span class=\"line\">\tlb_algo rr    \t（修改的）\t #LVS调度算法</span><br><span class=\"line\">\tlb_kind DR     \t（修改的）\t#LVS集群模式（路由模式）</span><br><span class=\"line\">\tprotocol TCP      #健康检查使用的协议</span><br><span class=\"line\">\treal_server 192.168.116.131 80 &#123;\t\t（修改的）</span><br><span class=\"line\">\t\tweight 1</span><br><span class=\"line\">\t\tinhibit_on_failure   #当该节点失败时，把权重设置为0，而不是从IPVS中删除</span><br><span class=\"line\">\t\tTCP_CHECK &#123;          #健康检查</span><br><span class=\"line\">\t\t\tconnect_port 80   #检查的端口</span><br><span class=\"line\">\t\t\tconnect_timeout 3  #连接超时的时间</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\treal_server 192.168.116.132 80 &#123;\t\t（修改的）</span><br><span class=\"line\">\t\tweight 1</span><br><span class=\"line\">\t\tinhibit_on_failure</span><br><span class=\"line\">\t\tTCP_CHECK &#123;</span><br><span class=\"line\">\t\t\tconnect_timeout 3</span><br><span class=\"line\">\t\t\tconnect_port 80</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">3. 启动KeepAlived（主备均启动）</span><br><span class=\"line\">[root@lvs-keepalived-master ~]# systemctl start keepalived</span><br><span class=\"line\">[root@lvs-keepalived-master ~]# systemctl enable keepalived</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看ip</span></span><br><span class=\"line\">[root@lvs-keepalived-master ~]# ipvsadm -Ln</span><br><span class=\"line\">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class=\"line\">Prot LocalAddress:Port Scheduler Flags</span><br><span class=\"line\"><span class=\"meta prompt_\">  -&gt; </span><span class=\"language-bash\">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class=\"line\">TCP  192.168.246.110:80 rr persistent 20</span><br><span class=\"line\"><span class=\"meta prompt_\">  -&gt; </span><span class=\"language-bash\">192.168.246.162:80           Route   1      0          0</span>         </span><br><span class=\"line\"><span class=\"meta prompt_\">  -&gt; </span><span class=\"language-bash\">192.168.246.163:80           Route   0      0          0</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">配置rs后端机器配置</span></span><br><span class=\"line\">4. 所有RS配置(nginx1,nginx2)</span><br><span class=\"line\">配置好网站服务器，测试所有RS</span><br><span class=\"line\">[root@test-nginx1 ~]# ip addr add dev lo 192.168.246.11/32</span><br><span class=\"line\">[root@test-nginx1 ~]# sysctl -p</span><br><span class=\"line\">[root@test-nginx1 ~]# systemctl start nginx</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"测试-4\"><a href=\"#测试-4\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">输入网址192.168.116.11\t//会出来192.168.116.（131/132）的页面</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6、配置（lvs–keepalived-–192-168-116-156（BACKUP）\"><a href=\"#6、配置（lvs–keepalived-–192-168-116-156（BACKUP）\" class=\"headerlink\" title=\"6、配置（lvs–keepalived)–192.168.116.156（BACKUP）\"></a>6、配置（lvs–keepalived)–192.168.116.156（BACKUP）</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">1. 主/备调度器安装软件</span><br><span class=\"line\">[root@lvs-keepalived-master ~]# yum -y install ipvsadm keepalived </span><br><span class=\"line\"></span><br><span class=\"line\">2、配置keepalived,conf配置文件</span><br><span class=\"line\">[root@lvs-keepalived-slave ~]# vim /etc/keepalived/keepalived.conf</span><br><span class=\"line\">! Configuration File for keepalived</span><br><span class=\"line\"></span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">   router_id lvs-keepalived-slave\t\t（修改的）</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    state BACKUP\t\t（修改的）</span><br><span class=\"line\">    interface ens33\t\t（修改的）</span><br><span class=\"line\">    virtual_router_id 80</span><br><span class=\"line\">    priority 50\t\t\t（修改的）</span><br><span class=\"line\">    advert_int 1</span><br><span class=\"line\">    authentication &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass 1111</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">        192.168.116.11/32\t\t（修改的）</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">virtual_server 192.168.246.11 80 &#123;\t（修改的）</span><br><span class=\"line\">\tdelay_loop 6</span><br><span class=\"line\">\tlb_algo rr\t\t（修改的）</span><br><span class=\"line\">\tlb_kind DR\t\t（修改的）</span><br><span class=\"line\">\tprotocol TCP</span><br><span class=\"line\">\treal_server 192.168.116.131 80 &#123;\t\t（修改的）</span><br><span class=\"line\">\t\tweight 1</span><br><span class=\"line\">\t\tinhibit_on_failure</span><br><span class=\"line\">\t\tTCP_CHECK &#123;</span><br><span class=\"line\">\t\t\tconnect_port 80</span><br><span class=\"line\">\t\t\tconnect_timeout 3</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\treal_server 192.168.116.132 80 &#123;\t\t（修改的）</span><br><span class=\"line\">\t\tweight 1</span><br><span class=\"line\">\t\tinhibit_on_failure</span><br><span class=\"line\">\t\tTCP_CHECK &#123;</span><br><span class=\"line\">\t\t\tconnect_timeout 3</span><br><span class=\"line\">\t\t\tconnect_port 80</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">3. 启动KeepAlived（主备均启动）</span><br><span class=\"line\">[root@lvs-keepalived-master ~]# systemctl start keepalived</span><br><span class=\"line\">[root@lvs-keepalived-master ~]# systemctl enable keepalived</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看ip</span></span><br><span class=\"line\">[root@lvs-keepalived-master ~]# ipvsadm -Ln</span><br><span class=\"line\">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class=\"line\">Prot LocalAddress:Port Scheduler Flags</span><br><span class=\"line\"><span class=\"meta prompt_\">  -&gt; </span><span class=\"language-bash\">RemoteAddress:Port           Forward Weight ActiveConn InActConn</span></span><br><span class=\"line\">TCP  192.168.246.110:80 rr persistent 20</span><br><span class=\"line\"><span class=\"meta prompt_\">  -&gt; </span><span class=\"language-bash\">192.168.246.162:80           Route   1      0          0</span>         </span><br><span class=\"line\"><span class=\"meta prompt_\">  -&gt; </span><span class=\"language-bash\">192.168.246.163:80           Route   0      0          0</span></span><br><span class=\"line\"><span class=\"meta prompt_\">  </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">配置rs后端机器配置</span></span><br><span class=\"line\">4. 所有RS配置(nginx1,nginx2)</span><br><span class=\"line\">配置好网站服务器，测试所有RS</span><br><span class=\"line\">[root@test-nginx1 ~]# ip addr add dev lo 192.168.246.11/32</span><br><span class=\"line\">[root@test-nginx1 ~]# sysctl -p</span><br><span class=\"line\">[root@test-nginx1 ~]# systemctl start nginx</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"测试-5\"><a href=\"#测试-5\" class=\"headerlink\" title=\"测试\"></a>测试</h1><figure class=\"highlight ini\"><table><tr><td class=\"code\"><pre><span class=\"line\">输入网址192.168.116.11\t//会出来192.168.116.（131/132）的页面</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","Nginx"]},{"title":"部署prometheus","url":"/2025/11/05/%E9%83%A8%E7%BD%B2prometheus/","content":"<h1 id=\"部署prometheus\"><a href=\"#部署prometheus\" class=\"headerlink\" title=\"部署prometheus\"></a>部署prometheus</h1><h2 id=\"一、准备环境\"><a href=\"#一、准备环境\" class=\"headerlink\" title=\"一、准备环境\"></a>一、准备环境</h2><table>\n<thead>\n<tr>\n<th align=\"center\">主机名</th>\n<th align=\"center\">IP</th>\n<th align=\"center\">配置</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"center\">client</td>\n<td align=\"center\">10.100.40.185</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">agent</td>\n<td align=\"center\">10.100.40.171</td>\n<td align=\"center\"></td>\n</tr>\n<tr>\n<td align=\"center\">agent</td>\n<td align=\"center\"></td>\n<td align=\"center\"></td>\n</tr>\n</tbody></table>\n<h2 id=\"二、部署prometheus\"><a href=\"#二、部署prometheus\" class=\"headerlink\" title=\"二、部署prometheus\"></a>二、部署prometheus</h2><h3 id=\"1、下载地址\"><a href=\"#1、下载地址\" class=\"headerlink\" title=\"1、下载地址\"></a>1、下载地址</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget prometheus-2.47.2.linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">官网地址</span><br><span class=\"line\">https://prometheus.io/download/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、创建目录\"><a href=\"#2、创建目录\" class=\"headerlink\" title=\"2、创建目录\"></a>2、创建目录</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir -pv /data/pormetheus/&#123;data,soft,lag&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3、解压安装包\"><a href=\"#3、解压安装包\" class=\"headerlink\" title=\"3、解压安装包\"></a>3、解压安装包</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">tar xzf prometheus-2.47.2.linux-amd64.tar.gz -C /data/prometheus/soft</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"做个软连接，方便操作\"><a href=\"#做个软连接，方便操作\" class=\"headerlink\" title=\"做个软连接，方便操作\"></a>做个软连接，方便操作</h4><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">cd /data/prometheus/soft</span><br><span class=\"line\">ln -sv prometheus-2.47.2.linux-amd64 prometheus</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"三、启动\"><a href=\"#三、启动\" class=\"headerlink\" title=\"三、启动\"></a>三、启动</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">在/data/prometheus/soft/prometfeus目录下启动</span><br><span class=\"line\">nohup ./prometheus &amp;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"四、检查，并查看\"><a href=\"#四、检查，并查看\" class=\"headerlink\" title=\"四、检查，并查看\"></a>四、检查，并查看</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">netstat -lnpt\t\t#查看9090端口有没有</span><br><span class=\"line\"></span><br><span class=\"line\">浏览器访问</span><br><span class=\"line\">http://IP + 9090</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707100611303.png\" alt=\"image-20240707100611303\"></p>\n<h2 id=\"五、配置systemctl启动文件\"><a href=\"#五、配置systemctl启动文件\" class=\"headerlink\" title=\"五、配置systemctl启动文件\"></a>五、配置systemctl启动文件</h2><h3 id=\"1、编辑启动项\"><a href=\"#1、编辑启动项\" class=\"headerlink\" title=\"1、编辑启动项\"></a>1、编辑启动项</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /etc/systemd/system/prometheus-server.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=xinjizhiwa Prometheus Server</span><br><span class=\"line\">Documentation=https://prometheus.io/docs/introduction/overview/</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">ExecStart=/data/prometheus/soft/prometheus/prometheus \\</span><br><span class=\"line\">    --config.file=/data/prometheus/soft/prometheus/prometheus.yml \\</span><br><span class=\"line\">    --web.enable-lifecycle</span><br><span class=\"line\">ExecReload=/bin/kill -HUP \\$MAINPID</span><br><span class=\"line\">LimitNOFILE=65535</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、重新加载systemctl\"><a href=\"#2、重新加载systemctl\" class=\"headerlink\" title=\"2、重新加载systemctl\"></a>2、重新加载systemctl</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl enable --now prometheus-server.serivce</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3、重新加载prometfeus\"><a href=\"#3、重新加载prometfeus\" class=\"headerlink\" title=\"3、重新加载prometfeus\"></a>3、重新加载prometfeus</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl reload prometheus-server.service</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">如果不管用，则使用下面的命令</span></span><br><span class=\"line\">curl -X POST http://本机IP:9090/-/reload</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"部署被监控节点node-exporter\"><a href=\"#部署被监控节点node-exporter\" class=\"headerlink\" title=\"部署被监控节点node-exporter\"></a>部署被监控节点node-exporter</h1><h2 id=\"一、部署node节点\"><a href=\"#一、部署node节点\" class=\"headerlink\" title=\"一、部署node节点\"></a>一、部署node节点</h2><h3 id=\"1、下载地址-1\"><a href=\"#1、下载地址-1\" class=\"headerlink\" title=\"1、下载地址\"></a>1、下载地址</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget node_exporter-1.8.1.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、创建目录-1\"><a href=\"#2、创建目录-1\" class=\"headerlink\" title=\"2、创建目录\"></a>2、创建目录</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mkdir -pv /data/node_export/&#123;data,soft,logs&#125;</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3、解压\"><a href=\"#3、解压\" class=\"headerlink\" title=\"3、解压\"></a>3、解压</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">tar xzf node_exporter-1.8.1.linux-amd64 -C /data/prometfeus/soft</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4、创建软链接\"><a href=\"#4、创建软链接\" class=\"headerlink\" title=\"4、创建软链接\"></a>4、创建软链接</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">ln -sv /node-export/soft/node_exporter-1.6.1.linux-amd64 /node-export/soft/node-exporter</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"5、配置启动项\"><a href=\"#5、配置启动项\" class=\"headerlink\" title=\"5、配置启动项\"></a>5、配置启动项</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /etc/systemd/system/node-exporter.service</span><br><span class=\"line\"></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=xinjizhiwa node-exporter</span><br><span class=\"line\">Documentation=https://prometheus.io/docs/introduction/overview/</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">ExecStart=/data/node-export/soft/node-exporter/node_exporter</span><br><span class=\"line\">ExecReload=/bin/kill -HUP \\$MAINPID</span><br><span class=\"line\">LimitNOFILE=65535</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6、重新加载systemd启动\"><a href=\"#6、重新加载systemd启动\" class=\"headerlink\" title=\"6、重新加载systemd启动\"></a>6、重新加载systemd启动</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl enable --now node-exporter.service </span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7、检查，并查看\"><a href=\"#7、检查，并查看\" class=\"headerlink\" title=\"7、检查，并查看\"></a>7、检查，并查看</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">netstat -lnpt\t\t#查看端口9100有么有起来</span><br><span class=\"line\"></span><br><span class=\"line\">浏览器</span><br><span class=\"line\">http://IP +9100</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707102747085.png\" alt=\"image-20240707102747085\"></p>\n<h2 id=\"二、配置prometheus收集node-exporter采集数据\"><a href=\"#二、配置prometheus收集node-exporter采集数据\" class=\"headerlink\" title=\"二、配置prometheus收集node-exporter采集数据\"></a>二、配置prometheus收集node-exporter采集数据</h2><h3 id=\"1、在prometheus上操作，配置node节点的信息\"><a href=\"#1、在prometheus上操作，配置node节点的信息\" class=\"headerlink\" title=\"1、在prometheus上操作，配置node节点的信息\"></a>1、在prometheus上操作，配置node节点的信息</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"> vim /data/prometheus/soft/prometheus/prometheus.yml </span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"meta prompt_\">   #</span><span class=\"language-bash\">抓取监控的间隔时间，多长时间获取一次数据（生产环境，建议15-30s）；</span></span><br><span class=\"line\">  scrape_interval: 3s</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">多久读一次规则</span></span><br><span class=\"line\">  evaluation_interval: 15s</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">先不解释，之后会讲</span></span><br><span class=\"line\">alerting:</span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">    - static_configs:</span><br><span class=\"line\">        - targets:</span><br><span class=\"line\">          # - alertmanager:9093</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">先不讲，之后会讲</span></span><br><span class=\"line\">rule_files:</span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">- <span class=\"string\">&quot;first_rules.yml&quot;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">- <span class=\"string\">&quot;second_rules.yml&quot;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">被监控的配置</span></span><br><span class=\"line\">scrape_configs:</span><br><span class=\"line\">  - job_name: &quot;prometheus&quot;</span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      - targets: [&quot;localhost:9090&quot;]</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">另起一个job名称，被监控的主体自定义名称</span></span><br><span class=\"line\">  - job_name: &quot;node-exporter&quot;\t\t#名字可以自定义</span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      #被监控的数据抓取地址；</span><br><span class=\"line\">      - targets: [&quot;10.0.0.41:9100&quot;]\t\t#填被监控节点的IP和端口</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、重新加载prometheus服务\"><a href=\"#2、重新加载prometheus服务\" class=\"headerlink\" title=\"2、重新加载prometheus服务\"></a>2、重新加载prometheus服务</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -X POST http://IP:9090/-/reload</span><br><span class=\"line\"></span><br><span class=\"line\">此时刷新页面，就可以看到node节点的信息了</span><br></pre></td></tr></table></figure>\n\n<p>3、PromeQL语句查询</p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707103527708.png\"></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">up #代表查看所有被监控节点是否存活</span><br><span class=\"line\"></span><br><span class=\"line\">1表示存活；</span><br><span class=\"line\"></span><br><span class=\"line\">0表示存活；</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707103558165.png\" alt=\"image-20240707103558165\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707103635031.png\" alt=\"image-20240707103635031\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707103656865.png\" alt=\"image-20240707103656865\"></p>\n<h1 id=\"部署grafana\"><a href=\"#部署grafana\" class=\"headerlink\" title=\"部署grafana\"></a>部署grafana</h1><h3 id=\"1、下载地址-2\"><a href=\"#1、下载地址-2\" class=\"headerlink\" title=\"1、下载地址\"></a>1、下载地址</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget grafana-enterprise-11.1.0-1.x86_64.rpm</span><br><span class=\"line\"></span><br><span class=\"line\">官网地址</span><br><span class=\"line\">https://grafana.com/grafana/dashboards/</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、移动到prometfeus的soft目录下，好管理\"><a href=\"#2、移动到prometfeus的soft目录下，好管理\" class=\"headerlink\" title=\"2、移动到prometfeus的soft目录下，好管理\"></a>2、移动到prometfeus的soft目录下，好管理</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">mv /root/grafana-enterprise-11.1.0-1.x86_64.rpm /data/prometfeus/soft</span><br></pre></td></tr></table></figure>\n\n<p>3、安装grafana</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y localinstall grafana-enterprise-11.1.0-1.x86_64.rpm</span><br><span class=\"line\"></span><br><span class=\"line\">或</span><br><span class=\"line\">yum install -y fontconfig</span><br><span class=\"line\">rpm -ivh grafana-enterprise-11.1.0-1.x86_64.rpm</span><br></pre></td></tr></table></figure>\n\n<p>4、启动</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl enable --now grafana-server.service</span><br></pre></td></tr></table></figure>\n\n<p>5、检查，并查看</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">netstat -lnpt\t\t#查看3000端口有没有</span><br><span class=\"line\"></span><br><span class=\"line\">浏览器访问</span><br><span class=\"line\">http://IP + 3000</span><br><span class=\"line\">默认账号密码： admin/admin</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104421113.png\" alt=\"image-20240707104421113\"></p>\n<h3 id=\"3、配置数据源\"><a href=\"#3、配置数据源\" class=\"headerlink\" title=\"3、配置数据源\"></a>3、配置数据源</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">【home】-【adminstration】-【data sources】-【add  data-sources】-【prometheus】</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104530460.png\" alt=\"image-20240707104530460\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104552366.png\" alt=\"image-20240707104552366\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104606770.png\" alt=\"image-20240707104606770\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104619454.png\" alt=\"image-20240707104619454\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104639259.png\" alt=\"image-20240707104639259\"></p>\n<h3 id=\"4、新建仪表盘\"><a href=\"#4、新建仪表盘\" class=\"headerlink\" title=\"4、新建仪表盘\"></a>4、新建仪表盘</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">【home】-【dashboards】-【new】-【new  folder】</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104725376.png\" alt=\"image-20240707104725376\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104739176.png\" alt=\"image-20240707104739176\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104752529.png\" alt=\"image-20240707104752529\"></p>\n<h3 id=\"5、创建一个新的folder\"><a href=\"#5、创建一个新的folder\" class=\"headerlink\" title=\"5、创建一个新的folder\"></a>5、创建一个新的folder</h3><p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104821412.png\" alt=\"image-20240707104821412\"></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">进入目录后，创建仪表盘</span><br><span class=\"line\"></span><br><span class=\"line\">【create  dashboard】</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104846803.png\" alt=\"image-20240707104846803\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">选择数据源</span><br><span class=\"line\"></span><br><span class=\"line\">【Add visualization】</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707104955023.png\" alt=\"image-20240707104955023\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">选择刚刚添加的数据源</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707105013229.png\" alt=\"image-20240707105013229\"></p>\n<p>6、测试</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">第一步，测试代码，就是计算一个cpu使用率的PromeQL代码；</span><br><span class=\"line\"></span><br><span class=\"line\">测试没问题，就复制；</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707105107524.png\" alt=\"image-20240707105107524\"></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">写入grafana图形</span><br><span class=\"line\"></span><br><span class=\"line\">(1-sum(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;)/sum(node_cpu_seconds_total))*100</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707105152631.png\" alt=\"image-20240707105152631\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707105209270.png\" alt=\"image-20240707105209270\"></p>\n<h3 id=\"6、下载开源的仪表盘\"><a href=\"#6、下载开源的仪表盘\" class=\"headerlink\" title=\"6、下载开源的仪表盘\"></a>6、下载开源的仪表盘</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">#grafana官网查询dashboard模板id</span><br><span class=\"line\">https://grafana.com/grafana/dashboards</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707105255145.png\" alt=\"image-20240707105255145\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">Copy ID to clipboard\t#复制仪表ID直接使用，需要有网络的情况下使用</span><br><span class=\"line\"></span><br><span class=\"line\">Download JSON\t\t#下载json文件，然后上传到prometfeus，支持离线</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707105309914.png\" alt=\"image-20240707105309914\"></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">上传仪表盘json文件到grafana</span><br><span class=\"line\">【home】-【dashboard】-【new】-【import】</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707105537863.png\" alt=\"image-20240707105537863\"></p>\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707105550579.png\" alt=\"image-20240707105550579\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">回到自己的dashboard列表可以看到成功了</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707105638228.png\" alt=\"image-20240707105638228\"></p>\n<h1 id=\"grafana的变量\"><a href=\"#grafana的变量\" class=\"headerlink\" title=\"grafana的变量\"></a>grafana的变量</h1><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">grafana的下拉列表选项制作-grafana的变量</span><br><span class=\"line\">教程</span><br><span class=\"line\">https://blog.csdn.net/2302_79199605/article/details/136438841?spm=1001.2014.3001.5501</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置prometheus服务的动态发现\"><a href=\"#配置prometheus服务的动态发现\" class=\"headerlink\" title=\"配置prometheus服务的动态发现\"></a>配置prometheus服务的动态发现</h1><h2 id=\"一、基于文档的自动发现\"><a href=\"#一、基于文档的自动发现\" class=\"headerlink\" title=\"一、基于文档的自动发现\"></a>一、基于文档的自动发现</h2><h3 id=\"1、修改prometheus的配置文件\"><a href=\"#1、修改prometheus的配置文件\" class=\"headerlink\" title=\"1、修改prometheus的配置文件\"></a>1、修改prometheus的配置文件</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /prometheus/soft/prometheus/prometheus.yml </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">通用设置</span></span><br><span class=\"line\">global:</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">抓取监控的间隔时间，多长时间获取一次数据（生产环境，建议15-30s）；</span></span><br><span class=\"line\">  scrape_interval: 3s </span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">多久读一次规则</span></span><br><span class=\"line\">  evaluation_interval: 15s </span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">先不解释，之后会讲</span></span><br><span class=\"line\">alerting:</span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">    - static_configs:</span><br><span class=\"line\">        - targets:</span><br><span class=\"line\">          # - alertmanager:9093</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">先不讲，之后会讲</span></span><br><span class=\"line\">rule_files:</span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">- <span class=\"string\">&quot;first_rules.yml&quot;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">- <span class=\"string\">&quot;second_rules.yml&quot;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">被监控的配置</span></span><br><span class=\"line\">scrape_configs:</span><br><span class=\"line\">  - job_name: &quot;prometheus&quot;</span><br><span class=\"line\">    static_configs:</span><br><span class=\"line\">      - targets: [&quot;localhost:9090&quot;]</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">另起一个job名称，被监控的主体自定义名称</span></span><br><span class=\"line\">  - job_name: &quot;node-exporter01&quot;</span><br><span class=\"line\">    #基于文档自动发现</span><br><span class=\"line\">    file_sd_configs:</span><br><span class=\"line\">      #文档的地址路径</span><br><span class=\"line\">      - files:</span><br><span class=\"line\">          #- /prometheus/soft/prometheus/file-sd.json</span><br><span class=\"line\">          - /data/prometheus/soft/prometheus/file-sd.yaml\t\t#自己定义的发现文档路径</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"2、重新加载prometheus服务-1\"><a href=\"#2、重新加载prometheus服务-1\" class=\"headerlink\" title=\"2、重新加载prometheus服务\"></a>2、重新加载prometheus服务</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -X POST http://IP:9090/-/reload</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3、编辑自动发现文档\"><a href=\"#3、编辑自动发现文档\" class=\"headerlink\" title=\"3、编辑自动发现文档\"></a>3、编辑自动发现文档</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /data/prometheus/soft/prometheus/file-sd.yaml</span><br><span class=\"line\">- targets:</span><br><span class=\"line\">    - &#x27;10.0.0.41:9100&#x27;</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    xinjizhiwa: prometheus-learn</span><br><span class=\"line\">    office: www.xinjizhiwa.com</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"4、刷新浏览器查看\"><a href=\"#4、刷新浏览器查看\" class=\"headerlink\" title=\"4、刷新浏览器查看\"></a>4、刷新浏览器查看</h3><p><img src=\"C:\\Users\\徐保东\\AppData\\Roaming\\Typora\\typora-user-images\\image-20240707110535539.png\" alt=\"image-20240707110535539\"></p>\n<h1 id=\"配置prometheus的数据存储\"><a href=\"#配置prometheus的数据存储\" class=\"headerlink\" title=\"配置prometheus的数据存储\"></a>配置prometheus的数据存储</h1><h2 id=\"一、本地存储prometheus收集的监控数据\"><a href=\"#一、本地存储prometheus收集的监控数据\" class=\"headerlink\" title=\"一、本地存储prometheus收集的监控数据\"></a>一、本地存储prometheus收集的监控数据</h2><h3 id=\"1、配置systemctl启动文件\"><a href=\"#1、配置systemctl启动文件\" class=\"headerlink\" title=\"1、配置systemctl启动文件\"></a>1、配置systemctl启动文件</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">vim /etc/systemd/system/prometheus-server.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Prometheus Server</span><br><span class=\"line\">Documentation=https://prometheus.io/docs/introduction/overview/</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">ExecStart=/data/prometheus/softwares/prometheus-2.47.2.linux-amd64/prometheus \\</span><br><span class=\"line\">    --config.file=/data/prometheus/softwares/prometheus-2.47.2.linux-amd64/prometheus.yml \\</span><br><span class=\"line\">    --web.enable-lifecycle \\</span><br><span class=\"line\">    --storage.tsdb.path=/data/prometheus/data/prometheus \\</span><br><span class=\"line\">    --storage.tsdb.retention.time=60d \\</span><br><span class=\"line\">    --web.listen-address=0.0.0.0:9090 \\</span><br><span class=\"line\">    --web.max-connections=4096 \\</span><br><span class=\"line\">    --storage.tsdb.retention.size=512MB \\</span><br><span class=\"line\">    --query.timeout=10s \\</span><br><span class=\"line\">    --query.max-concurrency=20 \\</span><br><span class=\"line\">    --log.level=info \\</span><br><span class=\"line\">    --log.format=json \\</span><br><span class=\"line\">    --web.read-timeout=5m</span><br><span class=\"line\">ExecReload=/bin/kill -HUP $MAINPID</span><br><span class=\"line\">LimitNOFILE=65535</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">参数说明：</span><br><span class=\"line\">--config.file=/prometheus/softwares/prometheus/prometheus.yml </span><br><span class=\"line\">    指定prometheus的配置文件。</span><br><span class=\"line\">--web.enable-lifecycle </span><br><span class=\"line\">    启用web方式热加载。</span><br><span class=\"line\">--storage.tsdb.path=&quot;/prometheus/data/prometheus&quot; </span><br><span class=\"line\">    指定prometheus数据存储路径。如果不指定，则默认其实时的同级目录下。</span><br><span class=\"line\">--storage.tsdb.retention.time=&quot;60d&quot; </span><br><span class=\"line\">    指定prometheus数据存储周期。</span><br><span class=\"line\">--web.listen-address=&quot;0.0.0.0:9090&quot; </span><br><span class=\"line\">    指定prometheus的监听端口。</span><br><span class=\"line\">--web.max-connections=4096 </span><br><span class=\"line\">    指定最大的连接数。</span><br><span class=\"line\">--storage.tsdb.retention.size=&quot;512MB&quot; </span><br><span class=\"line\">    指定prometheus数据块的滚动大小（每到512M缓存，进行一次落盘存储）。</span><br><span class=\"line\">--query.timeout=10s </span><br><span class=\"line\">    查询数据的超时时间。</span><br><span class=\"line\">--query.max-concurrency=20</span><br><span class=\"line\">    最大并发查询数量。</span><br><span class=\"line\">--log.level=info</span><br><span class=\"line\">    指定日志级别。</span><br><span class=\"line\">--log.format=logfmt</span><br><span class=\"line\">    指定日志格式。</span><br><span class=\"line\">--web.read-timeout=5m</span><br><span class=\"line\">    最大的空闲超时时间。</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3、重新加载systemctl\"><a href=\"#3、重新加载systemctl\" class=\"headerlink\" title=\"3、重新加载systemctl\"></a>3、重新加载systemctl</h3><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl daemon-reload</span><br><span class=\"line\">systemctl restart prometheus-server</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"二、prometheus数据远端存储\"><a href=\"#二、prometheus数据远端存储\" class=\"headerlink\" title=\"二、prometheus数据远端存储\"></a>二、prometheus数据远端存储</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">这里就不作介绍了</span><br><span class=\"line\">教程</span><br><span class=\"line\">https://blog.csdn.net/2302_79199605/article/details/136467629?spm=1001.2014.3001.5501</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"监控的告警通知-alertmanager组件工具\"><a href=\"#监控的告警通知-alertmanager组件工具\" class=\"headerlink\" title=\"监控的告警通知-alertmanager组件工具\"></a>监控的告警通知-alertmanager组件工具</h1><h2 id=\"1、定义告警规则\"><a href=\"#1、定义告警规则\" class=\"headerlink\" title=\"1、定义告警规则\"></a>1、定义告警规则</h2><p>修改Prometheus配置文件prometheus.yml,添加以下配置：</p>\n<figure class=\"highlight perl\"><table><tr><td class=\"code\"><pre><span class=\"line\">rule_files:</span><br><span class=\"line\">  - <span class=\"regexp\">/usr/l</span>ocal/prometheus/rules/*.rules\t\t\t<span class=\"comment\">#改成自己的目录，我的是/data目录下</span></span><br><span class=\"line\"></span><br><span class=\"line\">alerting:</span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">    - static_configs:</span><br><span class=\"line\">        - targets:</span><br><span class=\"line\">           - localhost:<span class=\"number\">9093</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>在目录&#x2F;usr&#x2F;local&#x2F;prometheus&#x2F;rules&#x2F;下创建告警文件hoststats-alert.rules内容如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">groups:</span><br><span class=\"line\">- name: hostStatsAlert</span><br><span class=\"line\">  rules:</span><br><span class=\"line\">  - alert: hostCpuUsageAlert</span><br><span class=\"line\">    expr: sum by (instance) (avg without (cpu) (irate(node_cpu_seconds_total&#123;mode!=&quot;idle&quot;&#125;[5m]))) &gt; 0.5</span><br><span class=\"line\">    for: 1m</span><br><span class=\"line\">    labels:</span><br><span class=\"line\">      # 严重性</span><br><span class=\"line\">      severity: warning</span><br><span class=\"line\">    annotations:</span><br><span class=\"line\">      title: cpu飚高告警</span><br><span class=\"line\">      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; CPU usgae high&quot;</span><br><span class=\"line\">      description: &quot;&#123;&#123; $labels.instance &#125;&#125; CPU usage above 50% (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class=\"line\">  - alert: hostMemUsageAlert</span><br><span class=\"line\">    expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes)/node_memory_MemTotal_bytes &gt; 0.85</span><br><span class=\"line\">    for: 1m</span><br><span class=\"line\">    labels:</span><br><span class=\"line\">      severity: warning</span><br><span class=\"line\">    annotations:</span><br><span class=\"line\">      title: 内存使用率飚高告警</span><br><span class=\"line\">      summary: &quot;Instance &#123;&#123; $labels.instance &#125;&#125; MEM usgae high&quot;</span><br><span class=\"line\">      description: &quot;&#123;&#123; $labels.instance &#125;&#125; MEM usage above 85% (current value: &#123;&#123; $value &#125;&#125;)&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>重启Prometheus后访问Prometheus http:&#x2F;&#x2F; IP:9090&#x2F;rules可以查看当前以加载的规则文件</p>\n<h2 id=\"2、安装配置prometheus-webhook-dingtalk\"><a href=\"#2、安装配置prometheus-webhook-dingtalk\" class=\"headerlink\" title=\"2、安装配置prometheus-webhook-dingtalk\"></a>2、安装配置prometheus-webhook-dingtalk</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://github.com/timonwong/prometheus-webhook-dingtalk/releases/download/v2.1.0/prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz</span><br><span class=\"line\">tar -zxvf prometheus-webhook-dingtalk-2.1.0.linux-amd64.tar.gz -C /usr/local</span><br><span class=\"line\">mv /usr/local/prometheus-webhook-dingtalk-2.1.0.linux-amd64 /usr/local/prometheus-webhook-dingtalk</span><br><span class=\"line\">cp /usr/local/prometheus-webhook-dingtalk/config.example.yml  /usr/local/prometheus-webhook-dingtalk/config.yml</span><br><span class=\"line\">vim config.yml      # 将配置文件修改成下面这样</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># Request timeout</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">timeout</span>: 5s</span></span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># Uncomment following line in order to write template from scratch (be careful!)</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">no_builtin_template: <span class=\"literal\">true</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># Customizable templates path</span></span></span><br><span class=\"line\">templates:</span><br><span class=\"line\">  - contrib/templates/mytemplate.tmpl # 这里指向你生成的模板</span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># You can also override default template using `default_message`</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># The following example to use the &#x27;legacy&#x27; template from v0.3.0</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">default_message:</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> title: <span class=\"string\">&#x27;&#123;&#123; template &quot;legacy.title&quot; . &#125;&#125;&#x27;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> text: <span class=\"string\">&#x27;&#123;&#123; template &quot;legacy.content&quot; . &#125;&#125;&#x27;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"> </span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\"><span class=\"comment\"># Targets, previously was known as &quot;profiles&quot;</span></span></span><br><span class=\"line\">targets:</span><br><span class=\"line\">  webhook1:</span><br><span class=\"line\">    # 钉钉机器人的webhook, 是从钉钉机器人中获取的值</span><br><span class=\"line\">    url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class=\"line\">    # secret for signature 加签后得到的值， 机器人的加签</span><br><span class=\"line\">    # secret: xxxxxxxxxxxxxxxxxxxxxxxxxxxxx</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> webhook2:</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">   url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> webhook_legacy:</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">   url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">   <span class=\"comment\"># Customize template content</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">   message:</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">     <span class=\"comment\"># Use legacy template</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">     title: <span class=\"string\">&#x27;&#123;&#123; template &quot;legacy.title&quot; . &#125;&#125;&#x27;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">     text: <span class=\"string\">&#x27;&#123;&#123; template &quot;legacy.content&quot; . &#125;&#125;&#x27;</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> webhook_mention_all:</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">   url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">   mention:</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">     all: <span class=\"literal\">true</span></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"> webhook_mention_users:</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">   url: https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxx</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">   mention:</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">     mobiles: [<span class=\"string\">&#x27;156xxxx8827&#x27;</span>, <span class=\"string\">&#x27;189xxxx8325&#x27;</span>]</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">添加如下模板，模板中需要有prometheus添加的 Annotations中需要title、description；Labels中需要有severity</span></span><br><span class=\"line\">vim /usr/local/prometheus-webhook-dingtalk/contrib/templates/mytemplate.tmpl</span><br><span class=\"line\"></span><br><span class=\"line\">cd /usr/local/prometheus-webhook-dingtalk/</span><br><span class=\"line\"></span><br><span class=\"line\">./prometheus-webhook-dingtalk --config.file=config.yml &gt;dingtalk.log 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;&#123; define &quot;__subject&quot; &#125;&#125;</span><br><span class=\"line\">[&#123;&#123; .Status | toUpper &#125;&#125;&#123;&#123; if eq .Status &quot;firing&quot; &#125;&#125;:&#123;&#123; .Alerts.Firing | len &#125;&#125;&#123;&#123; end &#125;&#125;]</span><br><span class=\"line\">&#123;&#123; end &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">&#123;&#123; define &quot;__alert_list&quot; &#125;&#125;&#123;&#123; range . &#125;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">&#123;&#123; if .Labels.owner &#125;&#125;@&#123;&#123; .Labels.owner &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">**告警名称**: &#123;&#123; index .Annotations &quot;title&quot; &#125;&#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">**告警级别**: &#123;&#123; .Labels.severity &#125;&#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">**告警主机**: &#123;&#123; .Labels.instance &#125;&#125; </span><br><span class=\"line\"> </span><br><span class=\"line\">**告警信息**: &#123;&#123; index .Annotations &quot;description&quot; &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">**告警时间**: &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; &#125;&#125;</span><br><span class=\"line\">&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">&#123;&#123; define &quot;__resolved_list&quot; &#125;&#125;&#123;&#123; range . &#125;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">&#123;&#123; if .Labels.owner &#125;&#125;@&#123;&#123; .Labels.owner &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">**告警名称**: &#123;&#123; index .Annotations &quot;title&quot; &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">**告警级别**: &#123;&#123; .Labels.severity &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">**告警主机**: &#123;&#123; .Labels.instance &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">**告警信息**: &#123;&#123; index .Annotations &quot;description&quot; &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">**告警时间**: &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.StartsAt) &quot;Asia/Shanghai&quot; &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">**恢复时间**: &#123;&#123; dateInZone &quot;2006.01.02 15:04:05&quot; (.EndsAt) &quot;Asia/Shanghai&quot; &#125;&#125;</span><br><span class=\"line\">&#123;&#123; end &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">&#123;&#123; define &quot;default.title&quot; &#125;&#125;</span><br><span class=\"line\">&#123;&#123; template &quot;__subject&quot; . &#125;&#125;</span><br><span class=\"line\">&#123;&#123; end &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">&#123;&#123; define &quot;default.content&quot; &#125;&#125;</span><br><span class=\"line\">&#123;&#123; if gt (len .Alerts.Firing) 0 &#125;&#125;</span><br><span class=\"line\">**====侦测到&#123;&#123; .Alerts.Firing | len  &#125;&#125;个故障====**</span><br><span class=\"line\">&#123;&#123; template &quot;__alert_list&quot; .Alerts.Firing &#125;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">&#123;&#123; end &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">&#123;&#123; if gt (len .Alerts.Resolved) 0 &#125;&#125;</span><br><span class=\"line\">**====恢复&#123;&#123; .Alerts.Resolved | len  &#125;&#125;个故障====**</span><br><span class=\"line\">&#123;&#123; template &quot;__resolved_list&quot; .Alerts.Resolved &#125;&#125;</span><br><span class=\"line\">&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">&#123;&#123; end &#125;&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">&#123;&#123; define &quot;ding.link.title&quot; &#125;&#125;&#123;&#123; template &quot;default.title&quot; . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">&#123;&#123; define &quot;ding.link.content&quot; &#125;&#125;&#123;&#123; template &quot;default.content&quot; . &#125;&#125;&#123;&#123; end &#125;&#125;</span><br><span class=\"line\">&#123;&#123; template &quot;default.title&quot; . &#125;&#125;</span><br><span class=\"line\">&#123;&#123; template &quot;default.content&quot; . &#125;&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3、安装配置prometheus-alertmanager\"><a href=\"#3、安装配置prometheus-alertmanager\" class=\"headerlink\" title=\"3、安装配置prometheus-alertmanager\"></a>3、安装配置prometheus-alertmanager</h2><figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://github.com/prometheus/alertmanager/releases/download/v0.25.0/alertmanager-0.25.0.linux-amd64.tar.gz</span><br><span class=\"line\">tar -zxvf alertmanager-0.25.0.linux-amd64.tar.gz </span><br><span class=\"line\">mv alertmanager-0.25.0.linux-amd64 /usr/local/alertmanager</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">修改告警管理的配置文件如下</span></span><br><span class=\"line\">vim /usr/local/alertmanager/alertmanager.yml</span><br><span class=\"line\">cd /usr/local/alertmanager/</span><br><span class=\"line\">./alertmanager --config.file=alertmanager.yml &gt;alertmanager.log 2&gt;&amp;1 &amp;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">global:</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">每一分钟检查一次是否恢复</span></span><br><span class=\"line\">  resolve_timeout: 5m</span><br><span class=\"line\">route:</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">采用哪个标签来作为分组依据</span></span><br><span class=\"line\">  group_by: [&#x27;alertname&#x27;]</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">组告警等待时间。也就是告警产生后等待10s，如果有同组告警一起发出</span></span><br><span class=\"line\">  group_wait: 10s</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">两组告警的间隔时间</span></span><br><span class=\"line\">  group_interval: 1m</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">重复告警的间隔时间，减少相同告警的发送频率</span></span><br><span class=\"line\">  repeat_interval: 1m</span><br><span class=\"line\"><span class=\"meta prompt_\">  #</span><span class=\"language-bash\">设置默认接收人</span></span><br><span class=\"line\">  receiver: &#x27;web.hook&#x27;</span><br><span class=\"line\">  routes:</span><br><span class=\"line\">  - receiver: &#x27;dingding.webhook1&#x27;</span><br><span class=\"line\">    match_re:</span><br><span class=\"line\">      alertname: &quot;.*&quot;</span><br><span class=\"line\">receivers:</span><br><span class=\"line\">- name: &#x27;web.hook&#x27;</span><br><span class=\"line\">  webhook_configs:</span><br><span class=\"line\">  - url: &#x27;http://127.0.0.1:5001/&#x27;</span><br><span class=\"line\">- name: &#x27;dingding.webhook1&#x27;</span><br><span class=\"line\">  webhook_configs:</span><br><span class=\"line\"><span class=\"meta prompt_\">  # </span><span class=\"language-bash\">这里的webhook1，根据我们在钉钉告警插件配置文件中targets中指定的值做修改</span></span><br><span class=\"line\">  - url: &#x27;http://127.0.0.1:8060/dingtalk/webhook1/send&#x27;</span><br><span class=\"line\">    send_resolved: true</span><br><span class=\"line\">inhibit_rules:</span><br><span class=\"line\">  - source_match:</span><br><span class=\"line\">      severity: &#x27;critical&#x27;</span><br><span class=\"line\">    target_match:</span><br><span class=\"line\">      severity: &#x27;warning&#x27;</span><br><span class=\"line\">    equal: [&#x27;alertname&#x27;, &#x27;dev&#x27;, &#x27;instance&#x27;]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>此时，我们可以手动拉高系统的CPU使用率，验证Prometheus的告警流程，在主机上运行以下命令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">cat /dev/zero&gt;/dev/null</span><br><span class=\"line\">等待告警状态为firing后钉钉群机器人会发出告警信息</span><br><span class=\"line\"></span><br><span class=\"line\">连接地址:https://blog.csdn.net/weixin_44223946/article/details/131411062?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522172032212116800213088728%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=172032212116800213088728&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-131411062-null-null.142^v100^pc_search_result_base3&amp;utm_term=prometheus%E5%91%8A%E8%AD%A6%E5%8F%91%E9%80%81%E9%92%89%E9%92%89&amp;spm=1018.2226.3001.4187</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<p>1、下载工具</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://github.com/prometheus/alertmanager/releases/download/v0.26.0/alertmanager-0.26.0.linux-amd64.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">tar xf alertmanager-0.26.0.linux-amd64.tar.gz -C /prometheus/softwares/</span><br><span class=\"line\"> </span><br><span class=\"line\">ln -svf /prometheus/softwares/alertmanager-0.26.0.linux-amd64/</span><br></pre></td></tr></table></figure>\n\n\n\n<figure class=\"highlight shell\"><table><tr><td class=\"code\"><pre><span class=\"line\">教程</span><br><span class=\"line\">https://blog.csdn.net/2302_79199605/article/details/136494677?spm=1001.2014.3001.5501</span><br></pre></td></tr></table></figure>\n\n","categories":["operations"],"tags":["Linux","prometheus"]},{"title":"项目前期准备","url":"/2025/11/05/%E9%A1%B9%E7%9B%AE%E5%89%8D%E6%9C%9F%E5%87%86%E5%A4%87/","content":"<h2 id=\"前期环境准备\"><a href=\"#前期环境准备\" class=\"headerlink\" title=\"前期环境准备\"></a>前期环境准备</h2><h3 id=\"环境基于ansible剧本\"><a href=\"#环境基于ansible剧本\" class=\"headerlink\" title=\"环境基于ansible剧本\"></a>环境基于ansible剧本</h3><h4 id=\"主要作用\"><a href=\"#主要作用\" class=\"headerlink\" title=\"主要作用\"></a><strong>主要作用</strong></h4><ol>\n<li><strong>配置管理</strong>：<ul>\n<li>Ansible 可以自动化地配置和管理服务器的状态，包括安装软件包、配置文件管理、用户和权限设置等。</li>\n</ul>\n</li>\n<li><strong>应用程序部署</strong>：<ul>\n<li>Ansible 可以自动化地部署应用程序，从代码库的拉取、依赖安装到应用程序的启动和配置，简化了复杂的部署过程。</li>\n</ul>\n</li>\n<li><strong>任务自动化</strong>：<ul>\n<li>Ansible 可以自动化日常运维任务，如备份、日志轮转、监控配置等，减少人为错误，提高工作效率。</li>\n</ul>\n</li>\n<li><strong>多平台支持</strong>：<ul>\n<li>Ansible 支持多种操作系统和云平台，包括 Linux、Windows、macOS，以及 AWS、Azure、GCP 等云服务提供商。</li>\n</ul>\n</li>\n<li><strong>无代理架构</strong>：<ul>\n<li>Ansible 通过 SSH 连接到目标节点，无需在目标节点上安装任何代理软件，简化了管理和维护。</li>\n</ul>\n</li>\n<li><strong>编排</strong>：<ul>\n<li>Ansible 可以编排复杂的 IT 任务，跨多个系统和环境执行一系列步骤，确保任务按顺序执行并保持一致性。</li>\n</ul>\n</li>\n</ol>\n<h4 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">yum -y install epel*</span><br><span class=\"line\">yum -y install ansible</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"免密\"><a href=\"#免密\" class=\"headerlink\" title=\"免密\"></a>免密</h3><h5 id=\"作用\"><a href=\"#作用\" class=\"headerlink\" title=\"作用\"></a>作用</h5><ul>\n<li><strong>日志和审计</strong>：<ul>\n<li>一致的时间戳对于日志记录和审计是至关重要的。不同服务器上的日志条目需要统一的时间基准，方便事件的追踪和问题的排查。</li>\n</ul>\n</li>\n<li><strong>数据一致性</strong>：<ul>\n<li>分布式系统和数据库集群依赖于精确的时间同步来确保数据一致性。例如，事务处理和数据复制需要准确的时间戳。</li>\n</ul>\n</li>\n<li><strong>安全性</strong>：<ul>\n<li>许多安全协议和认证机制依赖于准确的时间。例如，Kerberos 认证协议使用时间戳来防止重放攻击。</li>\n</ul>\n</li>\n<li><strong>调度和自动化任务</strong>：<ul>\n<li>计划任务（如 cron 作业）和自动化脚本依赖于系统时间来按预定时间执行。如果时间不同步，可能导致任务执行失败或错过执行时间。</li>\n</ul>\n</li>\n<li><strong>网络协议</strong>：<ul>\n<li>一些网络协议（如 NTP、TLS）需要准确的时间来确保正确的操作和安全性。</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"部署\"><a href=\"#部署\" class=\"headerlink\" title=\"部署\"></a>部署</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"># 生成免密</span><br><span class=\"line\">ssh-keygen</span><br><span class=\"line\"></span><br><span class=\"line\"># 编写免密脚本</span><br><span class=\"line\">[root@k8s-master ~]# vim ssh_key_send.sh </span><br><span class=\"line\">#!/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\"># 下载连接工具</span><br><span class=\"line\">yum -y install sshpass</span><br><span class=\"line\"></span><br><span class=\"line\"># 远程主机列表，换成你自己的主机 IP 地址--ip可以写多个</span><br><span class=\"line\">HOSTS=&quot;10.100.40.252 10.100.40.253 10.100.40.254&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># 本地公钥文件路径，换成你自己的公钥文件路径</span><br><span class=\"line\">PUBLIC_KEY_FILE=~/.ssh/id_rsa.pub</span><br><span class=\"line\"></span><br><span class=\"line\"># 遍历远程主机</span><br><span class=\"line\">for host in $&#123;HOSTS&#125;; do</span><br><span class=\"line\">    # 将本地公钥文件复制到远程主机的 authorized_keys 文件中--更换自己定义的密码</span><br><span class=\"line\">    echo &quot;Kunyue@123&quot; | sshpass -p &#x27;Kunyue@123&#x27; ssh-copy-id -o StrictHostKeyChecking=no -i $&#123;PUBLIC_KEY_FILE&#125; $&#123;host&#125;</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"时间同步\"><a href=\"#时间同步\" class=\"headerlink\" title=\"时间同步\"></a>时间同步</h3><h5 id=\"作用-1\"><a href=\"#作用-1\" class=\"headerlink\" title=\"作用\"></a>作用</h5><ul>\n<li><strong>日志和审计</strong>：<ul>\n<li>一致的时间戳对于日志记录和审计是至关重要的。不同服务器上的日志条目需要统一的时间基准，方便事件的追踪和问题的排查。</li>\n</ul>\n</li>\n<li><strong>数据一致性</strong>：<ul>\n<li>分布式系统和数据库集群依赖于精确的时间同步来确保数据一致性。例如，事务处理和数据复制需要准确的时间戳。</li>\n</ul>\n</li>\n<li><strong>安全性</strong>：<ul>\n<li>许多安全协议和认证机制依赖于准确的时间。例如，Kerberos 认证协议使用时间戳来防止重放攻击。</li>\n</ul>\n</li>\n<li><strong>调度和自动化任务</strong>：<ul>\n<li>计划任务（如 cron 作业）和自动化脚本依赖于系统时间来按预定时间执行。如果时间不同步，可能导致任务执行失败或错过执行时间。</li>\n</ul>\n</li>\n<li><strong>网络协议</strong>：<ul>\n<li>一些网络协议（如 NTP、TLS）需要准确的时间来确保正确的操作和安全性。</li>\n</ul>\n</li>\n</ul>\n<h5 id=\"部署-1\"><a href=\"#部署-1\" class=\"headerlink\" title=\"部署\"></a>部署</h5><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost ~]# vim check_time.sh</span><br><span class=\"line\">#！/bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">#对时</span><br><span class=\"line\"># 关闭防火墙</span><br><span class=\"line\">#systemctl stop firewalld</span><br><span class=\"line\">#setenforce 0</span><br><span class=\"line\"># 下载软件</span><br><span class=\"line\">yum -y instal ntpdate</span><br><span class=\"line\"># 查看当前时区</span><br><span class=\"line\">timedatectl</span><br><span class=\"line\"># 列出可用时区</span><br><span class=\"line\">#timedatectl list-timezones</span><br><span class=\"line\"># 修改上海时区</span><br><span class=\"line\">timedatectl set-timezone Asia/Shanghai</span><br><span class=\"line\"># 验证修改是否生效</span><br><span class=\"line\">timedatectl</span><br><span class=\"line\"># 对时</span><br><span class=\"line\">ntpdate ntp.aliyun.com</span><br><span class=\"line\">echo &quot;对时成功，当前时间为：&quot; </span><br><span class=\"line\">date +&#x27;%F %H:%M:%S&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 定义主机组</span><br><span class=\"line\">[root@k8s-master ~]# vim time</span><br><span class=\"line\">[all]</span><br><span class=\"line\">10.100.40.252</span><br><span class=\"line\">10.100.40.253</span><br><span class=\"line\">10.100.40.254</span><br><span class=\"line\"></span><br><span class=\"line\"># 配置yaml文件</span><br><span class=\"line\">[root@k8s-master ~]# vim time.yaml</span><br><span class=\"line\">---</span><br><span class=\"line\">- name: 更新 time</span><br><span class=\"line\">  hosts: all</span><br><span class=\"line\">  become: yes</span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: copy time script to remote host</span><br><span class=\"line\">      copy:</span><br><span class=\"line\">        src: /root/check_time.sh</span><br><span class=\"line\">        dest: /root/check_time.sh</span><br><span class=\"line\">        owner: root</span><br><span class=\"line\">        group: root</span><br><span class=\"line\">        mode: 0755</span><br><span class=\"line\"></span><br><span class=\"line\">    - name: execute time script</span><br><span class=\"line\">      shell: bash /root/check_time.sh</span><br><span class=\"line\">      args:</span><br><span class=\"line\">        chdir: /root</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动命令</span><br><span class=\"line\">ansible-playbook -i /root/time time.yaml </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"挂载数据盘\"><a href=\"#挂载数据盘\" class=\"headerlink\" title=\"挂载数据盘\"></a>挂载数据盘</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">#创建目录</span><br><span class=\"line\">mkdir /data</span><br><span class=\"line\">#分区</span><br><span class=\"line\">fdisk /dev/sdb1</span><br><span class=\"line\">#格式化</span><br><span class=\"line\">mkfs.xfs -t ext4 /dev/sdb1</span><br><span class=\"line\">mount /dev/sdb1 /data</span><br><span class=\"line\"># 永久挂载</span><br><span class=\"line\">vim /etc/fstab</span><br><span class=\"line\">/dev/sdb1 /data xfs defaults 0 0    #添加</span><br></pre></td></tr></table></figure>\n","categories":["operations"],"tags":["Linux","Toolbox","Script"]},{"title":"关于_","url":"/about/index.html","content":"<!-- 这里是关于我的介绍。\n\n    ♥ 博主：Mr.xu\n    ♥ 技能：Linux、Docker、K8s、自动化运维\n    ♥ 爱好：编程、健身、动漫\n\n欢迎交流！ -->\n\n<!-- html方式配置 -->\n<p><span style=\"color:#ff3b3b; font-weight:bold;\">♥ 博主：Mr.xu</span><br><br><span style=\"color:#ff9800;\">♥ 技能：Linux、Docker、K8s、自动化运维</span><br><br><span style=\"color:#00c3ff;\">♥ 爱好：编程、健身、动漫</span><br><br><span style=\"font-weight:bold; color:#00ff00;\">欢迎大家前来交流与分享！</span></p>\n"},{"title":"友链_","url":"/links/index.html","content":"<!-- 这里是关于我的友链。\n\n♥ 博主：Mr.xu\n♥ 技能：Linux、Docker、K8s、自动化运维\n♥ 爱好：编程、健身、动漫\n\n欢迎各位添加！博客地址：https://7dong.dpdns.org -->\n\n<!-- html方式配置 -->\n<p><span style=\"color:#ff3b3b; font-weight:bold;\">♥ 博主：Mr.xu</span><br><br><span style=\"color:#ff9800;\">♥ 技能：Linux、Docker、K8s、自动化运维</span><br><br><span style=\"color:#00c3ff;\">♥ 爱好：编程、健身、动漫</span><br><br><span style=\"font-weight:bold; color:#00ff00;\">欢迎各位添加！博客地址：</span><a href=\"https://7dong.dpdns.org\" style=\"color:#ffffff;\">https://7dong.dpdns.org</a></p>\n<!-- butterfly方式配置 -->\n<!-- Butterfly 友链卡片语法\n<div class=\"flink\">\n  <a class=\"flink-item\" href=\"http://localhost:4000/\" target=\"_blank\">\n    <img class=\"flink-avatar\" src=\"/img/dong.png\" alt=\"东的博客\">\n    <span class=\"flink-name\">东的博客</span>\n  </a>\n  <a class=\"flink-item\" href=\"https://butterfly.js.org/\" target=\"_blank\">\n    <img class=\"flink-avatar\" src=\"https://butterfly.js.org/img/avatar.png\" alt=\"Butterfly主题\">\n    <span class=\"flink-name\">Butterfly 主题</span>\n  </a>\n  <a class=\"flink-item\" href=\"https://hexo.io/\" target=\"_blank\">\n    <img class=\"flink-avatar\" src=\"https://hexo.io/logo.svg\" alt=\"Hexo官网\">\n    <span class=\"flink-name\">Hexo 官网</span>\n  </a>\n</div> -->"}]